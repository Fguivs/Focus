import{initializeApp}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";import{getFirestore,doc,setDoc,getDoc,collection,getDocs,updateDoc,deleteDoc,increment,writeBatch,query,where,onSnapshot,runTransaction,deleteField,orderBy,arrayUnion,addDoc,limit}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";import{GoogleGenerativeAI}from"https://esm.run/@google/generative-ai";const firebaseConfig={apiKey:"AIzaSyDoncRn8ikIdij8aXC0OUeqdqnLITrhmPc",authDomain:"foco-diario-75630.firebaseapp.com",projectId:"foco-diario-75630",storageBucket:"foco-diario-75630.appspot.com",messagingSenderId:"1040579676771",appId:"1:1040579676771:web:ca12f964d8adb3778e4656"},app=initializeApp(firebaseConfig),db=getFirestore(app);let todasMedalhasHonra=[],medalhasInventarioCache={},medalhasOrdemCache={},medalhasDesejadasCache={},carrosselMedalhasPausado=!1,currentCarrosselMedalhasIndex=0,totalSlidesMedalhas=0,todosPoderesInfo=[],statusPoderesAtivos=[],historicoPoderesSemana={},poderParaComprar=null,equipeAlvoParaPoder=null,comprandoPoder=!1,saldosBancosEquipes={abelha:0,joaninha:0,vagalume:0},unsubscribeBancosListener=null,estatisticasJurosCache=[],estatisticasContribuidoresCache={},carrosseisInternosMedalhasState={},membroParaOrdenarMedalhas=null,ordemMedalhasTemporaria=[],medalhaParaComprarInfo=null,membroParaReceberMedalha=null,carrosselMedalhasInterval,progressoBarraMedalhas;const MEDALHAS_POR_PAGINA=6;Date.prototype.getBrasiliaHours=function(){const e=this.getTimezoneOffset()+180;return(this.getHours()+Math.floor(e/60))%24};let streaksCache={},todosMembros=[],equipes={abelha:{membros:[],lider:null},joaninha:{membros:[],lider:null},vagalume:{membros:[],lider:null}},liderGeral=null,currentUser=null,userRole=null,userTeam=null,analiseOraculoPendente=null,carrosselDesenhoPausado=!1,currentCarrosselDesenhoIndex=0,activeDrawingTeam=null,drawingContexts={},pixDestinatarios=[],pixValor=0,pixComentario="",enviosDiariosRealizados={},baseDeConhecimentoTexto="",historicoConversaIA=[],feedEventosCache=[],enviandoMoedas=!1,aguardandoConfirmacaoNotificacao=!1,dadosNotificacaoPendente=null,currentCarrosselIndex=0,carrosselPausado=!1,maintenanceClickCount=0,maintenanceClickTimer=null,totalSlides=0,isUpdatingTop5Feed=!1,membroParaExpulsar=null,isPasswordResetFlow=!1,recompensasConfig={},isTestModeActive=!1,currentTestGameIndex=null,ordemJogosConfigurada=[],carrosselDesenhoInterval,progressoBarraDesenho,genAI,carrosselInterval,progressoBarra;const medalhas={3:{emoji:"\uD83D\uDD25",nome:"Fagulha"},10:{emoji:"\uD83D\uDC51",nome:"Lenda"},30:{emoji:"\uD83C\uDF1F",nome:"Constante"},60:{emoji:"\uD83D\uDC8E",nome:"Diamante"},120:{emoji:"\uD83D\uDE80",nome:"Foguete"},150:{emoji:"\uD83C\uDFC6",nome:"Trof\xE9u"},240:{emoji:"\uD83D\uDD2E",nome:"Bola de cristal"},365:{emoji:"\uD83C\uDF1E",nome:"Solar"},550:{emoji:"\uD83D\uDC09",nome:"M\xEDtico"},730:{emoji:"\uD83C\uDF83",nome:"Horripilante"},900:{emoji:"\uD83D\uDCA3",nome:"Poder Destrutivo"},1100:{emoji:"\uD83D\uDE07",nome:"Angelical"},1460:{emoji:"\uD83D\uDCA0",nome:"Primordial"},1825:{emoji:"\u267E\uFE0F",nome:"Eterno"}},totalDiasMembros={},pontosSemanais={abelha:0,joaninha:0,vagalume:0},rankingGeral={abelha:0,joaninha:0,vagalume:0},historicoAcoes={};let atualizando=!1,dataAtual="",filaAtualizacao=Promise.resolve(),popupQueue=[],isPopupShowing=!1,unsubscribeNotificacoes=null,cliqueCount=0,initialDistance=null,isPinching=!1,composerSelectedColor="#CAFFBF",composerTimestampInterval=null,composerEditMode=!1,editingMessageId=null,messageIdToDelete=null,unsubscribeViewerListener=null,isMentioning=!1,mentionQuery="",mentionStartIndex=-1,activeSuggestionIndex=-1,mentionTextarea=null,currentMentionRange=null,todosOsItensAvatar=[],inventarioAvatarCache=[],avatarTemporario={},avatarOriginal={},unsubscribeAvatarListener=null,timeoutClique;const nomesCategorias={corpo:"Tons de peles",rosto:"Express\xF5es",cabelo:"Cabelos",roupa:"Roupas",acessorio:"Acess\xF3rios",enfeite_de_parede:"Itens Raros e Exclusivos",fundo:"Fundos"},nomesSubcategorias={chapeu:"Chap\xE9u",oculos:"\xD3culos",colar:"Acess\xF3rio de pesco\xE7o",bolsa:"Bolsa",outros:"Outros"};let editingCommentId=null,commentIdToDelete=null,messageIdForCommentAction=null,checkboxLocks={},folgasManualmenteRemovidas={},currentUserRole="membro",currentUserTeam=null,memberIdToRemove=null,lastRefreshTimestamp=null,officialAppVersion=null,authContainer,mainContent,logoutBtn,loginForm,changePasswordForm,forgotPasswordForm,secretQuestionForm,loginBtn,loginUsernameInput,loginPasswordInput;const EMOJIS_MURAL=["\uD83D\uDC4D","\uD83D\uDC96","\uD83D\uDE02","\uD83C\uDF89","\uD83D\uDD25","\uD83D\uDE2E","\uD83D\uDE2D","\uD83D\uDE21"];function getHoje(){return new Date}function getHojeISO(){const e=new Date,a=e.getFullYear(),o=(e.getMonth()+1+"").padStart(2,"0"),t=(e.getDate()+"").padStart(2,"0");return`${a}-${o}-${t}`}function formatarData(e){const a=(e.getDate()+"").padStart(2,"0"),o=(e.getMonth()+1+"").padStart(2,"0"),t=e.getFullYear();return`${a}/${o}/${t}`}function getDiaSemanaString(e=new Date){return["domingo","segunda-feira","ter\xE7a-feira","quarta-feira","quinta-feira","sexta-feira","s\xE1bado"][e.getDay()]}const diaParaIndice={domingo:0,dom:0,segunda:1,seg:1,ter√ßa:2,terca:2,ter:2,quarta:3,qua:3,quinta:4,qui:4,sexta:5,sex:5,s√°bado:6,sabado:6,sab:6};function getSemanaAtual(e=null){const a=e||getHoje(),o=a.getDay();if(0===o){const e=new Date(a);e.setDate(a.getDate()-1);const o=new Date(e);return o.setDate(e.getDate()-6),{inicio:o,fim:e,numero:Math.ceil((o-new Date(o.getFullYear(),0,1))/86400000/7),inicioFormatado:formatarData(o),fimFormatado:formatarData(e),fimCompeticao:formatarData(e).slice(0,5)}}const t=new Date(a);t.setDate(a.getDate()-(o-1));const n=new Date(t);n.setDate(t.getDate()+5);const i=new Date(t.getFullYear(),0,1),r=Math.floor((t-i)/86400000),d=Math.ceil((r+i.getDay()+1)/7);return{inicio:t,fim:n,numero:d,inicioFormatado:formatarData(t),fimFormatado:formatarData(n),fimCompeticao:formatarData(n).slice(0,5)}}async function carregarPresenca(){const e=getHojeISO(),a=await getDoc(doc(db,"presencas",e));if(a.exists()){const e=a.data();todosMembros.forEach(a=>{const o=a.nome,t=document.getElementById(o);t&&e[o]&&(t.checked=!0)})}}async function carregarPontosSemanais(){const e=getHoje(),a=doc(db,"semanas","pontosSemanais"),o=await getDoc(a);if(o.exists()){const e=o.data();pontosSemanais.abelha=e.abelha||0,pontosSemanais.joaninha=e.joaninha||0,pontosSemanais.vagalume=e.vagalume||0}else 0!==e.getDay()&&(await setDoc(a,{abelha:0,joaninha:0,vagalume:0})),pontosSemanais.abelha=0,pontosSemanais.joaninha=0,pontosSemanais.vagalume=0}async function carregarRankingGeral(){const e=await getDoc(doc(db,"ranking","geral"));if(e.exists()){const a=e.data();rankingGeral.abelha=a.abelha||0,rankingGeral.joaninha=a.joaninha||0,rankingGeral.vagalume=a.vagalume||0}atualizarRankingGeral()}async function finalizarSemana(){await carregarDadosEssenciais();const e=getHoje();if(6===e.getDay()){try{const e=getSemanaAtual(),a=`semana_${e.numero}_${e.inicio.getFullYear()}`,o=doc(db,"vantagemSemanal",a),t=await getDoc(o);if(t.exists()&&t.data().palavraDaSemana){const e=t.data().palavraDaSemana.id;e&&(await deleteDoc(doc(db,"jogoDaForca",e)))}}catch(e){console.error("Erro ao deletar palavra da forca da semana:",e)}const e=getSemanaAtual(),a=`semana_${e.numero}_${e.inicio.getFullYear()}`,o=doc(db,"vantagemSemanal",a);let t=!1,n=[],i={};try{if(await runTransaction(db,async e=>{const a=await e.get(o);if(a.exists()&&a.data().bonusAplicado)return;let r=!1;const d=a.exists()?a.data().completadoPor||{}:{},s=new Set(Object.keys(d)),l=[];for(const a in equipes){const e=equipes[a];if(0<e.membros.length){const o=e.membros.filter(e=>!e.deFerias).every(e=>s.has(e.nome));o&&(r=!0,l.push(a))}}r&&(e.set(o,{bonusAplicado:!0,equipesComBonus:l},{merge:!0}),t=!0,n=l,i=d)}),t){const e=i,a={1:recompensasConfig.top5Vantagem_1||50,2:recompensasConfig.top5Vantagem_2||40,3:recompensasConfig.top5Vantagem_3||30,4:recompensasConfig.top5Vantagem_4||20,5:recompensasConfig.top5Vantagem_5||10},o=Object.entries(e).map(([e,a])=>({nome:e,tempo:a.toDate().getTime()})).sort((e,a)=>e.tempo-a.tempo).slice(0,5);if(0<o.length){const e=writeBatch(db);o.forEach((o,t)=>{const n=a[t+1];n&&(e.update(doc(db,"membros",o.nome),{moedas:increment(n)}),o.nome===currentUser&&mostrarPopupMoedas(n))}),await e.commit()}mostrarPopup("\u2728 B\xF4nus Garantido!","As equipes que completaram o desafio garantiram o b\xF4nus para a m\xE9dia final!",6e3);const t=n;let r;if(0<t.length){const e=t.map(a=>`<strong>Equipe ${a.charAt(0).toUpperCase()+a.slice(1)}</strong>`).join(", ");r=`Parab√©ns! ${e} completaram o Jogo da Vantagem e garantiram um b√¥nus em sua m√©dia final no domingo!`}else r=`O Jogo da Vantagem foi finalizado, mas nenhuma equipe cumpriu o requisito do b√¥nus esta semana.`;await adicionarEventoAoFeed("vantagem","\u2728 B\xF4nus do Jogo da Vantagem!",r)}}catch(e){console.error("Erro na finaliza\xE7\xE3o do Jogo da Vantagem:",e)}}if(0===e.getDay()&&0<=e.getBrasiliaHours()){const a=doc(db,"semanas","pontosSemanais"),o=await getDoc(a);if(o.exists()&&0<Object.keys(o.data()).length){const t=o.data(),n=getSemanaAtual(new Date(e.setDate(e.getDate()-1))),i=`semana_${n.numero}_${n.inicio.getFullYear()}`,r=doc(db,"resultadosCompeticao",i),d={};todosMembros.forEach(e=>{d[e.nome]={nome:e.nome,equipe:e.equipe,pontuacao:{foco:0,vantagem:0,total:0},meChamo:e["me chamo"]||e.nome,deFerias:e.deFerias||!1}});const s=formatarDataISO(n.inicio),l=formatarDataISO(n.fim),m=query(collection(db,"presencas"),where("__name__",">=",s),where("__name__","<=",l)),c=await getDocs(m);c.forEach(e=>{const a=e.data();for(const o in a)a[o]&&d[o]&&(d[o].pontuacao.foco++,d[o].pontuacao.total++)});const u=doc(db,"vantagemSemanal",i),p=await getDoc(u),g=3,f=p.exists()?p.data().equipesComBonus||[]:[];if(p.exists()){const e=p.data().completadoPor||{};for(const a in e)d[a]&&(d[a].pontuacao.vantagem+=g,d[a].pontuacao.total+=g)}const h=p.exists()?p.data().deducoesPoderes||{}:{},v=p.exists()?p.data().adicoesPoderes||{}:{},E=p.exists()?p.data().ajustesManuais||{}:{};console.log("Calculando vencedor da semana com M\xC9DIA NIVELADA...");const y={},b=["abelha","joaninha","vagalume"],L=[];let I=1/0;if(b.forEach(e=>{const a=equipes[e]?.membros.filter(e=>!e.deFerias)||[],o=a.length;0<o&&(L.push(e),o<I&&(I=o))}),I===1/0&&(I=0),console.log(`Tamanho da menor equipe para nivelamento: ${I} membro(s).`),b.forEach(e=>{const a=equipes[e]?.membros.filter(e=>!e.deFerias)||[],o=a.length;if(0===o)return void(y[e]=0);const t=a.map(e=>d[e.nome]?.pontuacao.foco||0);t.sort((e,a)=>e-a);const n=o-I;let i=[...t];0<n&&(console.log(`Equipe ${e}: Descartando ${n} menor(es) pontua√ß√£o(√µes).`),i=t.slice(n));const r=i.reduce((e,a)=>e+a,0),s=i.length;let l=0<s?r/s:0;if(f.includes(e)&&(l+=g,console.log(`Aplicando b√¥nus de +${g} √† m√©dia da equipe ${e}.`)),v[e]&&0<v[e].length){const a=v[e].reduce((e,a)=>e+(a.valor||0),0);l+=a,console.log(`Aplicando b√¥nus de poder de +${a} √† m√©dia da equipe ${e}.`)}if(h[e]&&0<h[e].length){const a=h[e].reduce((e,a)=>e+(a.valor||0),0);l+=a,console.log(`Aplicando penalidade de poder de ${a} √† m√©dia da equipe ${e}.`)}y[e]=l}),0===L.length)return await adicionarEventoAoFeed("vitoria","\uD83C\uDF34 Competi\xE7\xE3o Suspensa","Todos os membros ativos est\xE3o de f\xE9rias, ent\xE3o a competi\xE7\xE3o desta semana foi suspensa. Bom descanso a todos!"),await deleteDoc(a),pontosSemanais.abelha=0,pontosSemanais.joaninha=0,pontosSemanais.vagalume=0,void atualizarPlacarSemanal();if(1===L.length){const e=L[0];if(0<t[e]){const a=y[e].toFixed(2),o=e.charAt(0).toUpperCase()+e.slice(1);await updateDoc(doc(db,"ranking","geral"),{[e]:increment(1)}),rankingGeral[e]++,atualizarRankingGeral(),mostrarPopup("\uD83C\uDFC6 Vit\xF3ria Semanal",`Equipe ${o} venceu a semana com uma m√©dia de ${a} pontos!`,8e3),await adicionarEventoAoFeed("vitoria","\uD83C\uDFC6 Temos uma Campe\xE3 Semanal!",`A equipe <strong>${o}</strong> venceu competindo sozinha com uma m√©dia de <strong>${a}</strong> pontos.`,{vencedoras:[e]});const t=writeBatch(db);equipes[e].membros.forEach(e=>{e.deFerias||t.update(doc(db,"membros",e.nome),{moedas:increment(recompensasConfig.vitoriaSemanal||500)})}),await t.commit();const n=doc(db,"bancosEquipes",e);await setDoc(n,{saldo:increment(1e5)},{merge:!0});const i=doc(collection(db,"bancosEquipes",e,"movimentacoes"));await setDoc(i,{tipo:"premio",valor:1e5,descricao:"Pr\xEAmio da Competi\xE7\xE3o Semanal",timestamp:new Date}),await adicionarEventoAoFeed("vitoria","\uD83D\uDCB0 Recompensa de Campe\xE3o!",`Como recompensa, cada membro ativo da equipe <strong>${o}</strong> recebeu <strong>${recompensasConfig.vitoriaSemanal||500} üí∞ moedas</strong>!`)}else await adicionarEventoAoFeed("vitoria","\uD83C\uDFC1 Semana sem Vencedor","A \xFAnica equipe ativa n\xE3o marcou pontos, ent\xE3o n\xE3o h\xE1 vencedor esta semana.");return await calcularMembrosOciosos(),await deleteDoc(a),pontosSemanais.abelha=0,pontosSemanais.joaninha=0,pontosSemanais.vagalume=0,void atualizarPlacarSemanal()}const C=Object.entries(y).filter(([e])=>L.includes(e)).map(([e,a])=>({equipe:e,media:a})).sort((e,a)=>a.media-e.media),B={};let x=1;for(let e=0;e<C.length;e++)0<e&&C[e].media<C[e-1].media&&x++,B[C[e].equipe]=x;const A={pontosEquipes:t,mediaEquipes:y,rankingEquipes:B,detalhesMembros:d,ajustesManuais:E,deducoesPoderes:h,adicoesPoderes:v,timestamp:new Date},q=await gerarResumoSemanalComIA(A,n);A.analiseOraculo=q,await setDoc(r,A);let S=-1;for(const e of L)y[e]>S&&(S=y[e]);const F=[];if(0<S)for(const e of L).001>Math.abs(y[e]-S)&&F.push(e);const k=1<F.length;if(0<F.length){const e=doc(db,"ranking","geral"),a={};F.forEach(e=>{a[e]=increment(1),rankingGeral[e]++}),await updateDoc(e,a),atualizarRankingGeral();const o={abelha:"Abelha",joaninha:"Joaninha",vagalume:"Vaga-lume"},t=F.map(e=>o[e]).join(" e "),n=`com uma m√©dia de ${S.toFixed(2)} pontos por membro!`,i=`com uma incr√≠vel m√©dia de <strong>${S.toFixed(2)}</strong> pontos por membro.`;k?(mostrarPopup("\uD83C\uDFC6 Empate Semanal",`As equipes ${t} empataram ${n}`,8e3),await adicionarEventoAoFeed("vitoria","\uD83C\uDFC6 Empate na Competi\xE7\xE3o Semanal!",`Que disputa acirrada! As equipes <strong>${t}</strong> empataram ${i}`,{vencedoras:F})):(mostrarPopup("\uD83C\uDFC6 Vit\xF3ria Semanal",`Equipe ${t} venceu a semana ${n}`,8e3),await adicionarEventoAoFeed("vitoria","\uD83C\uDFC6 Temos uma Campe\xE3 Semanal!",`A equipe <strong>${t}</strong> venceu ${i}`,{vencedoras:F}));const r=writeBatch(db);F.forEach(e=>{equipes[e].membros.forEach(e=>{e.deFerias||r.update(doc(db,"membros",e.nome),{moedas:increment(recompensasConfig.vitoriaSemanal||500)})})}),await r.commit();const d=writeBatch(db),s=new Date;F.forEach(e=>{const a=doc(db,"bancosEquipes",e);d.set(a,{saldo:increment(1e5)},{merge:!0});const o=doc(collection(db,"bancosEquipes",e,"movimentacoes"));d.set(o,{tipo:"premio",valor:1e5,descricao:"Pr\xEAmio da Competi\xE7\xE3o Semanal",timestamp:s})}),await d.commit();const l=F.map(e=>e.charAt(0).toUpperCase()+e.slice(1)),m=`Como recompensa, cada membro ativo da(s) equipe(s) <strong>${l.join(" e ")}</strong> recebeu <strong>${recompensasConfig.vitoriaSemanal||500} üí∞ moedas</strong>!`;await adicionarEventoAoFeed("vitoria","\uD83D\uDCB0 Recompensa de Campe\xE3o!",m)}await calcularMembrosOciosos(),await deleteDoc(a),pontosSemanais.abelha=0,pontosSemanais.joaninha=0,pontosSemanais.vagalume=0,atualizarPlacarSemanal()}}}async function gerarResumoSemanalComIA(e,a){if(!genAI)return void console.warn("IA n\xE3o inicializada. Pulando resumo semanal do Or\xE1culo.");const{mediaEquipes:o,rankingEquipes:t,detalhesMembros:n={},adicoesPoderes:i={},deducoesPoderes:r={}}=e,d=Object.entries(t).filter(([,e])=>1===e).map(([e])=>e);let s="";if(1<d.length){const e=d.map(a=>a.charAt(0).toUpperCase()+a.slice(1)).join(" e ");s=`Houve um belo empate entre as equipes ${e}.`}else if(1===d.length){const e=d[0].charAt(0).toUpperCase()+d[0].slice(1);s=`A equipe vencedora foi a ${e}.`}else s="N\xE3o tivemos um vencedor claro esta semana, mas o esfor\xE7o de todos foi not\xE1vel.";const l=Object.entries(o).map(([e,a])=>`- Equipe ${e.charAt(0).toUpperCase()+e.slice(1)}: M√©dia de ${a.toFixed(2)} pontos.`).join("\n"),m=Object.values(n).filter(e=>!e.deFerias).sort((e,a)=>a.pontuacao.total-e.pontuacao.total).slice(0,5).map((e,a)=>`${a+1}¬∫: ${e.nome} (Nome Real: ${e.meChamo}, ${e.pontuacao.total} pontos)`).join("\n");let c="Nenhum evento importante registrado ainda.";try{const e=a.inicio,o=new Date(a.fim.getTime()+86399000);console.log(`Or√°culo: Buscando todos os eventos da semana de ${e.toISOString()} at√© ${o.toISOString()}`);const t=query(collection(db,"resumoSemanalFeed"),where("timestamp",">=",e),where("timestamp","<=",o),orderBy("timestamp","asc")),n=await getDocs(t);n.empty||(c=n.docs.map(e=>{const a=e.data(),o=a.texto.replace(/<[^>]*>/g," ").replace(/\s+/g," ").trim();return`- ${a.titulo}: ${o}`}).join("\n"),console.log(`Or√°culo: Encontrados ${n.size} eventos para a an√°lise.`))}catch(e){console.error("Or\xE1culo: Erro ao buscar hist\xF3rico completo do feed:",e),feedEventosCache&&0<feedEventosCache.length&&(c=feedEventosCache.slice(0,10).map(e=>{const a=e.texto.replace(/<[^>]*>/g," ");return`- ${e.titulo}: ${a.trim()}`}).join("\n"))}let u="Nenhum poder foi usado esta semana.";const p=Object.values(i).flat(),g=Object.values(r).flat();(0<p.length||0<g.length)&&(u="Atividade da Lojinha de Magias:\n",p.forEach(e=>{u+=`- (B√îNUS): ${e.por} usou "${e.nomePoder}" para sua equipe.\n`}),g.forEach(e=>{u+=`- (PUNI√á√ÉO): ${e.por} usou "${e.nomePoder}" contra a equipe advers√°ria.\n`}));const f=`
    Voc√™ √© o Or√°culo, o mentor s√°bio, acolhedor e carinhoso do "Grupo √âpicos".
    A competi√ß√£o da semana acabou. Sua tarefa √© escrever um post especial para o "Resumo da Semana", analisando os resultados com sua personalidade de um mentor mais velho (cerca de 50 anos), que √© am√°vel e demonstra cuidado com o progresso do grupo.

    Aqui est√£o os dados da semana para sua an√°lise:
    - Resultado da Competi√ß√£o: ${s}
    - Placar Final (M√©dias das equipes):
    ${l}
    - Top 5 Membros da Semana (Dedica√ß√£o): 
    ${m||"Ningu\xE9m pontuou o suficiente para o Top 5."}
    - ${u}
    - Acontecimentos Recentes (O que aconteceu durante a semana):
    ${c||"Nenhum evento especial registrado."}

    Instru√ß√µes para sua resposta:
    1.  O t√≠tulo do evento ser√° "üßô‚Äç An√°lise Semanal do Or√°culo".
    2.  Escreva uma an√°lise detalhada (3 a 5 par√°grafos) em seu estilo carinhoso e de mentor.
    3.  Parabenize a(s) equipe(s) vencedora(s) de forma calorosa. Comente sobre a disputa, elogiando o esfor√ßo de todos, mesmo os que n√£o venceram.
    4.  Elogie os membros do Top 5, n√£o apenas pelo resultado, mas pelo exemplo de dedica√ß√£o que eles representam.
	5.  REGRA DE G√äNERO OBRIGAT√ìRIA: Use o "Nome Real" apenas para determinar o g√™nero de uma pessoa.
    
    6.  **REGRA DE ENDERE√áAMENTO (MUITO IMPORTANTE):** Ao mencionar um membro, sempre use seu "Nome de Usu√°rio" (o nome que aparece ANTES do par√™ntese, ex: 'Gui', 'Brenda').
        -   **FORMATA√á√ÉO:** Formate o nome apenas com negrito: <strong>NomeDoMembro</strong>.
        -   **NUNCA** use o s√≠mbolo '@' na an√°lise.
        -   **NUNCA** use o "Nome Real" (o nome que aparece DENTRO do par√™ntese, ex: 'Francisco_Guilherme') diretamente na mensagem. Use o "Nome Real" apenas para determinar o g√™nero (ex: "o Gui", "a Brenda").

    7.  **NOVA INSTRU√á√ÉO (MUITO IMPORTANTE):** Verifique os "Acontecimentos Recentes". 
        -   Se houver algum evento indicando a chegada de um novo membro (ex: t√≠tulo "Bem-vindo(a) ao Grupo!"), inclua uma mensagem calorosa de boas-vindas a ele(a) em sua an√°lise.
        -   Se houver eventos de "Poder Ativado" ou "Medalha de Honra", comente brevemente sobre como essas a√ß√µes (o uso de magias ou o reconhecimento de membros) tornaram a semana mais interessante e competitiva.
    8.  Termine com uma mensagem de incentivo e afeto para a pr√≥xima semana, refor√ßando a import√¢ncia do descanso e da uni√£o.
    9.  Assine com "‚Äî Com carinho, Or√°culo." ou simplesmente "‚Äî Or√°culo.".
    10. Sua resposta deve ser apenas o texto da an√°lise, sem formata√ß√£o JSON e sem introdu√ß√µes.
    11. REGRA SOBRE PONTUA√á√ÉO: A pontua√ß√£o individual representa o total de dias de foco durante a semana. Elogie a 'dedica√ß√£o' e 'comprometimento', em vez de 'sequ√™ncia' ou 'dias consecutivos'.
  `,h=3;let v=!1,E="";for(let o=1;o<=h;o++)try{console.log(`üßô‚Äç Or√°culo preparando a an√°lise semanal... (Tentativa ${o}/${h})`);const e=genAI.getGenerativeModel({model:"gemini-2.5-flash-lite"}),a=await e.generateContent(f),t=await a.response;E=t.text(),v=!0;break}catch(e){if(console.error(`Erro na tentativa ${o} de gerar resumo semanal com a IA:`,e),o===h)console.warn("N\xFAmero m\xE1ximo de tentativas atingido. Usando an\xE1lise de fallback."),E="Meus queridos, a semana foi intensa e cheia de aprendizados. Parab\xE9ns a todos pelo esfor\xE7o, em especial \xE0(s) equipe(s) vencedora(s)! Que a pr\xF3xima semana nos traga ainda mais foco e uni\xE3o. Descansem bem. \u2014 Or\xE1culo.";else{const e=1e3*Math.pow(2,o-1);console.log(`Aguardando ${e/1e3}s antes da pr√≥xima tentativa...`),await new Promise(a=>setTimeout(a,e))}}let y=E.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>");return y=y.replace(/\n/g,"<br>"),analiseOraculoPendente=y,console.log("An\xE1lise semanal pronta para ser exibida."),y}function mostrarPopupAnaliseOraculo(e){if(!e)return void console.log("Nenhuma an\xE1lise do Or\xE1culo para exibir.");const a=sessionStorage.getItem("popupAnaliseOraculoVisto");if(a)return void console.log("Popup de an\xE1lise do Or\xE1culo j\xE1 foi exibido nesta sess\xE3o.");mostrarCardPopup("\uD83E\uDDD9\u200D A An\xE1lise Semanal do Or\xE1culo",e),sessionStorage.setItem("popupAnaliseOraculoVisto","true"),analiseOraculoPendente=null}function getMedalha(e){const a=Object.keys(medalhas).map(Number).sort((e,a)=>a-e);for(const o of a)if(e>=o)return medalhas[o];return null}async function atualizarMedalhas(){for(const e in streaksCache)Object.hasOwnProperty.call(streaksCache,e)&&atualizarStreakVisualMembro(e,streaksCache[e])}async function atualizarPlacarSemanal(){document.getElementById("resumo-abelha")&&(document.getElementById("resumo-abelha").innerHTML=`
        <div>${document.querySelectorAll("#equipe-abelha input:checked").length} focaram hoje!</div>
        <div>${pontosSemanais.abelha} pontos na semana</div>
        <div>M√©dia: <span id="media-abelha">0.00</span></div>
      `),document.getElementById("resumo-joaninha")&&(document.getElementById("resumo-joaninha").innerHTML=`
        <div>${document.querySelectorAll("#equipe-joaninha input:checked").length} focaram hoje!</div>
        <div>${pontosSemanais.joaninha} pontos na semana</div>
        <div>M√©dia: <span id="media-joaninha">0.00</span></div>
      `),document.getElementById("resumo-vagalume")&&(document.getElementById("resumo-vagalume").innerHTML=`
        <div>${document.querySelectorAll("#equipe-vagalume input:checked").length} focaram hoje!</div>
        <div>${pontosSemanais.vagalume} pontos na semana</div>
        <div>M√©dia: <span id="media-vagalume">0.00</span></div>
      `),await atualizarMediaEquipes()}async function atualizarMediaEquipes(){const e=["abelha","joaninha","vagalume"],a=getSemanaAtual(),o=formatarDataISO(a.inicio),t=formatarDataISO(a.fim);try{const n=`semana_${a.numero}_${a.inicio.getFullYear()}`,i=doc(db,"vantagemSemanal",n),r=await getDoc(i),d=r.exists()?r.data().deducoesPoderes||{}:{},s=r.exists()?r.data().adicoesPoderes||{}:{},l=query(collection(db,"presencas"),where("__name__",">=",o),where("__name__","<=",t)),m=await getDocs(l),c={};todosMembros.forEach(e=>{c[e.nome]=0}),m.forEach(e=>{const a=e.data();for(const o in a)a[o]&&void 0!==c[o]&&c[o]++});let u=1/0;e.forEach(e=>{const a=equipes[e]?.membros.filter(e=>!e.deFerias)||[],o=a.length;0<o&&o<u&&(u=o)}),u===1/0&&(u=0),e.forEach(e=>{const a=document.getElementById(`media-${e}`);if(!a)return;const o=equipes[e]?.membros.filter(e=>!e.deFerias)||[],t=o.length;if(0===t)return void(a.textContent="0.00");const n=o.map(e=>c[e.nome]||0);n.sort((e,a)=>e-a);const i=t-u;let r=[...n];0<i&&(r=n.slice(i));const l=r.reduce((e,a)=>e+a,0),m=r.length;let p=0<m?l/m:0;if(s[e]&&0<s[e].length){const a=s[e].reduce((e,a)=>e+(a.valor||0),0);p+=a}if(d[e]&&0<d[e].length){const a=d[e].reduce((e,a)=>e+(a.valor||0),0);p+=a}a.textContent=p.toFixed(2)})}catch(a){console.error("Erro ao atualizar m\xE9dias em tempo real:",a),e.forEach(e=>{const a=document.getElementById(`media-${e}`);a&&(a.textContent="0.00")})}}function atualizarRankingGeral(){document.getElementById("ranking-abelha")&&(document.getElementById("ranking-abelha").textContent=rankingGeral.abelha),document.getElementById("ranking-joaninha")&&(document.getElementById("ranking-joaninha").textContent=rankingGeral.joaninha),document.getElementById("ranking-vagalume")&&(document.getElementById("ranking-vagalume").textContent=rankingGeral.vagalume),atualizarPodioEquipes()}function configurarOuvintePresencaTempoReal(){const e=getHojeISO(),a=doc(db,"presencas",e);onSnapshot(a,e=>{console.log("Sincroniza\xE7\xE3o em tempo real: O documento de presen\xE7as foi atualizado.");let a={};e.exists()&&(a=e.data()),todosMembros.forEach(e=>{const o=document.getElementById(e.nome);if(o){const t=!!a[e.nome];o.checked!==t&&(o.checked=t)}}),atualizarResumo()})}window.atualizarResumo=async function(){0===todosMembros.length||(filaAtualizacao=filaAtualizacao.then(async()=>{const e=getHoje(),a=getHojeISO(),o=todosMembros.filter(e=>document.getElementById(e.nome)?.checked).length,t=todosMembros.length;if(document.getElementById("contadorGeral")){document.getElementById("contadorGeral").textContent=`${o} √©picos focaram hoje!`;const e=0<t?100*(o/t):0,a=document.getElementById("progresso-barra");a.style.width=`${e}%`;const n=document.getElementById("marcador-arvore");if(n&&0<t){const e=100*(10/t);100>=e?(n.style.left=`${e}%`,n.style.display="flex"):n.style.display="none"}const i=document.querySelector(".global-stats"),r=document.getElementById("mensagem-todos-focados");o===t?(a.classList.add("rainbow-progress"),i.classList.add("rainbow-border"),r&&(r.textContent="Todos focaram hoje, estamos de parab\xE9ns!!",r.classList.remove("hidden"))):(a.classList.remove("rainbow-progress"),i.classList.remove("rainbow-border"),r&&r.classList.add("hidden"))}atualizarPlacarSemanal(),verificarEquipeCompleta(),await verificarArvoreEpica(o),await carregarTop5Semana()}).catch(e=>{console.error("Erro na atualiza\xE7\xE3o:",e)}),await filaAtualizacao)};function verificarEquipeCompleta(){for(const e in equipes){const a=document.getElementById(`equipe-${e}`),o=document.getElementById(`msg-equipe-${e}`);if(!a||!o)continue;const t=equipes[e].membros.filter(e=>!e.deFerias),n=t.every(e=>document.getElementById(e.nome)?.checked),i=`membro-completo-${e}`;if(equipes[e].membros.forEach(e=>{const a=document.getElementById(e.nome)?.parentElement;a&&(n&&0<t.length?a.classList.add(i):a.classList.remove(i))}),o.classList.remove("abelha","joaninha","vagalume"),n&&0<t.length){a.classList.add("equipe-completa",e);const t=e.charAt(0).toUpperCase()+e.slice(1);o.textContent=`Parab√©ns, equipe ${t}!! Voc√™s gabaritaram hoje!!!`,o.classList.add(e),o.classList.remove("hidden")}else a.classList.remove("equipe-completa",e),o.classList.add("hidden")}}function mostrarCardPopup(e,a,o=null){const t=document.getElementById("custom-card-popup"),n=document.getElementById("card-popup-title"),i=document.getElementById("card-popup-message"),r=document.getElementById("card-popup-close-btn");n.textContent=e,i.innerHTML=a;const d=document.body.className;t.classList.remove("tema-noite","tema-manha","tema-tarde"),d.includes("tema-noite")?t.classList.add("tema-noite"):d.includes("tema-manha")?t.classList.add("tema-manha"):d.includes("tema-tarde")&&t.classList.add("tema-tarde"),t.classList.add("show");const s=async()=>{t.classList.remove("show"),o&&o(),await new Promise(e=>setTimeout(e,350)),await verificarNotificacoesRestantes()};r.onclick=s,t.onclick=e=>{e.target===t&&s()}}window.mostrarPopup=function(e,a,o=4e3){popupQueue.push({titulo:e,mensagem:a,duracao:o}),isPopupShowing||processPopupQueue()};function showOracleProgressOverlay(){const e=document.getElementById("oracle-progress-overlay");e&&(e.classList.remove("hidden"),setTimeout(()=>{e.classList.add("show")},10),updateOracleProgress(0,"Iniciando processo..."))}function hideOracleProgressOverlay(){const e=document.getElementById("oracle-progress-overlay");e&&(e.classList.remove("show"),setTimeout(()=>{e.classList.add("hidden")},300))}function updateOracleProgress(e,a){const o=document.getElementById("oracle-progress-bar"),t=document.getElementById("oracle-status-text");o&&(o.style.width=`${e}%`),t&&(t.textContent=a)}function showLoadingOverlay(e){const a=document.getElementById("loading-overlay"),o=document.getElementById("loading-text");a&&o&&(o.textContent=e,a.classList.remove("hidden"),setTimeout(()=>a.classList.add("show"),10))}function updateLoadingOverlayText(e){const a=document.getElementById("loading-text");a&&(a.textContent=e)}function hideLoadingOverlay(){const e=document.getElementById("loading-overlay");e&&(e.classList.remove("show"),setTimeout(()=>e.classList.add("hidden"),300))}function processPopupQueue(){if(0===popupQueue.length||isPopupShowing)return;isPopupShowing=!0;const e=popupQueue.shift(),a=document.getElementById("popup-message");return a?void(a.innerHTML=`<strong>${e.titulo}</strong><br>${e.mensagem}`,a.classList.add("show"),setTimeout(()=>{a.classList.remove("show"),setTimeout(()=>{isPopupShowing=!1,processPopupQueue()},500)},e.duracao)):void(isPopupShowing=!1)}function mostrarPopupMoedas(e){if(0<e){mostrarPopup("\uD83C\uDF89 Recompensa!",`Voc√™ ganhou <strong>${e} üí∞ moedas</strong>!`,3500)}}const medalhasConcedidas={};function atualizarStreakVisualMembro(e,a){const o=document.getElementById(`dias-${e}`);o&&(o.textContent=a,o.title=`${a} dias de foco consecutivos`);const t=document.getElementById(`medalha-${e}`);if(t){const e=getMedalha(a);e?(t.innerHTML=e.emoji,t.title=`${e.nome} - ${a} dias de foco consecutivos`,t.classList.add("com-medalha"),t.classList.remove("escondido")):(t.innerHTML="",t.classList.remove("com-medalha"),t.classList.add("escondido"))}}function dispararConfete(){function e(n){i=n,o.clearRect(0,0,a.width,a.height);let r=0;for(let e=0;e<t.length;e++){const n=t[e];n.y+=n.speed,n.x+=n.drift,n.angle+=n.spin,o.save(),o.translate(n.x+n.w/2,n.y+n.h/2),o.rotate(n.angle),o.fillStyle=n.color,o.fillRect(-n.w/2,-n.h/2,n.w,n.h),o.restore(),n.y<a.height&&r++}0<r?requestAnimationFrame(e):o.clearRect(0,0,a.width,a.height)}const a=document.getElementById("confetti-canvas");if(!a)return;const o=a.getContext("2d");a.width=window.innerWidth,a.height=window.innerHeight;const t=[],n=["#FFD700","#FF6B6B","#2ECC71","#3498DB","#9B59B6","#FAD390"];for(let e=0;e<200;e++)t.push({x:Math.random()*a.width,y:-Math.random()*a.height,w:8*Math.random()+5,h:15*Math.random()+8,color:n[Math.floor(Math.random()*n.length)],angle:2*(Math.random()*Math.PI),speed:4*Math.random()+2,spin:.4*Math.random()-.2,drift:2*Math.random()-1});let i=0;requestAnimationFrame(e)}function iniciarConfeteAniversarioContinuo(){function e(){o.clearRect(0,0,a.width,a.height);for(let e=particulasAniversario.length-1;0<=e;e--){const t=particulasAniversario[e];t.y+=t.speed,t.x+=t.drift,t.angle+=t.spin,o.save(),o.translate(t.x+t.w/2,t.y+t.h/2),o.rotate(t.angle),o.fillStyle=t.color,o.fillRect(-t.w/2,-t.h/2,t.w,t.h),o.restore(),t.y>a.height+20&&particulasAniversario.splice(e,1)}animacaoConfeteAniversarioId=requestAnimationFrame(e)}if(animacaoConfeteAniversarioId)return;const a=document.getElementById("confetti-canvas");if(!a)return;const o=a.getContext("2d");a.width=window.innerWidth,a.height=window.innerHeight;const t=["#FFD700","#FF6B6B","#2ECC71","#3498DB","#9B59B6","#FAD390"];geradorDeParticulasId=setInterval(()=>{particulasAniversario.push({x:Math.random()*a.width,y:-20,w:6*Math.random()+4,h:12*Math.random()+6,color:t[Math.floor(Math.random()*t.length)],angle:2*(Math.random()*Math.PI),speed:2*Math.random()+1,spin:.2*Math.random()-.1,drift:1*Math.random()-.5})},200),e()}function pararConfeteAniversarioContinuo(){geradorDeParticulasId&&(clearInterval(geradorDeParticulasId),geradorDeParticulasId=null),animacaoConfeteAniversarioId&&(cancelAnimationFrame(animacaoConfeteAniversarioId),animacaoConfeteAniversarioId=null),particulasAniversario=[];const e=document.getElementById("confetti-canvas");if(e){const a=e.getContext("2d");a.clearRect(0,0,e.width,e.height)}}async function executarMarcacaoAutomaticaDeFolgasDoDia(){const e=getHojeISO(),a=doc(db,"appState","dailyTasks");console.log(`[FOLGAS HOJE] Verificando se a marca√ß√£o autom√°tica para ${e} j√° foi executada.`);try{const o=await getDoc(a),t=o.exists()&&o.data().folgasMarcadasPara===e;if(t)return void console.log(`[FOLGAS HOJE] Tarefa de marca√ß√£o para ${e} j√° foi conclu√≠da. Nenhuma a√ß√£o.`);console.log("[FOLGAS HOJE] Buscando lista de membros atualizada do Firestore...");const n=await getDocs(collection(db,"membros")),i=[];n.forEach(e=>{i.push({nome:e.id,...e.data()})});const r=getDiaSemanaString(getHoje()).toLowerCase().replace(/-feira$/,"").normalize("NFD").replace(/[\u0300-\u036f]/g,""),d=i.filter(e=>{if(!e.folga||e.deFerias)return!1;const a=e.folga.toLowerCase().replace(/-feira$/,"").normalize("NFD").replace(/[\u0300-\u036f]/g,"");return a===r});if(0===d.length)return console.log("[FOLGAS HOJE] Nenhum membro de folga hoje. Definindo trava para evitar re-execu\xE7\xE3o."),void(await setDoc(a,{folgasMarcadasPara:e},{merge:!0}));console.log(`%c[FOLGAS HOJE] ${d.length} membro(s) de folga encontrados. Preparando opera√ß√£o em lote...`,"color: #8e44ad; font-weight: bold;");const s=doc(db,"semanas","pontosSemanais"),l=0===getHoje().getDay();await runTransaction(db,async o=>{for(const a of d){const t=a.nome,n=a.equipe,i=doc(db,"membros",t),r=doc(db,"presencas",e);o.set(r,{[t]:new Date},{merge:!0}),o.update(i,{streak:increment(1),moedas:increment(recompensasConfig.focoDiario||100)}),n&&!l&&pontosSemanais.hasOwnProperty(n)&&o.update(s,{[n]:increment(1)})}o.set(a,{folgasMarcadasPara:e},{merge:!0})}),console.log(`[FOLGAS HOJE] Lote de dados conclu√≠do com sucesso. ${d.length} folga(s) marcadas.`);const m=await getDoc(s),c=m.exists()?m.data():{abelha:0,joaninha:0,vagalume:0};for(const e of d){const a=e.nome,o=e.equipe,t=streaksCache[a]||0,n=t+1;streaksCache[a]=n;const i=Object.keys(medalhas).map(Number).sort((e,a)=>e-a);for(const e of i)if(n>=e&&t<e){const o=medalhas[e];await adicionarEventoAoFeed("medalha","\uD83C\uDFC5 Nova Conquista!",`<strong>${a}</strong> alcan√ßou <strong>${n} dias</strong> de foco e ganhou a medalha ${o.emoji} <strong>${o.nome}</strong>!`,{nomeMembro:a,medalha:o.nome}),console.log(`[FOLGAS HOJE] ${a} ganhou a medalha ${o.nome} (${n} dias).`);break}let r;if(o&&!l&&Object.keys(equipes).includes(o)){const e=o.charAt(0).toUpperCase()+o.slice(1);r=`A caixa de sele√ß√£o de <strong>${a}</strong> foi marcada automaticamente, pois hoje √© o seu dia de folga. Isso garante +1 ponto para a equipe <strong>${e}</strong>, totalizando <strong>${c[o]}</strong> pontos! Bom descanso <strong>${a}</strong>!!`}else r=`A caixa de sele√ß√£o de <strong>${a}</strong> foi marcada automaticamente, pois hoje √© o seu dia de folga. Bom descanso!`;await adicionarEventoAoFeed("geral","\uD83C\uDF34 Dia de Descanso Merecido!",r,{nomeMembro:a})}console.log(`[FOLGAS HOJE] Eventos do feed criados.`),d.forEach(e=>{const a=document.getElementById(e.nome);a&&!a.checked&&(a.checked=!0),e.equipe&&!l&&pontosSemanais[e.equipe]++})}catch(a){console.error(`[FOLGAS HOJE] Erro cr√≠tico na opera√ß√£o de folgas para ${e}.`,a)}}window.marcarCheckbox=async function(e){const a=todosMembros.find(a=>a.nome===e);if(a&&a.deFerias){mostrarPopup("\uD83C\uDF34 Em F\xE9rias","Membros de f\xE9rias n\xE3o podem registrar o foco. Aproveite seu descanso!",4e3);const a=document.getElementById(e);return void(a&&(a.checked=!1))}if(checkboxLocks[e]){const a=document.getElementById(e);return void(a&&(a.checked=!a.checked))}checkboxLocks[e]=!0;const o=document.getElementById(e),t=todosMembros.find(a=>a.nome===e);if(!o||!t)return void(checkboxLocks[e]=!1);const n=()=>"lider"===userRole||"lider-equipe"===userRole&&t.equipe===userTeam||"membro"===userRole&&currentUser===e;if(!n())return o.checked=!o.checked,mostrarPopup("\uD83D\uDEAB Acesso Negado","Voc\xEA n\xE3o tem permiss\xE3o para alterar o foco de outro membro.",4e3),void(checkboxLocks[e]=!1);showLoadingOverlay("Aguarde um segundo...");const i=streaksCache[e]||0,r=getHoje(),d=0===r.getDay(),s=o.checked?"adicionar":"remover",l=t.equipe,m=getDiaSemanaString(r);"remover"===s&&t.folga===m&&(folgasManualmenteRemovidas[e]=!0);let c=[];try{const{streakAtual:a,novosPontosEquipe:o}=await verificarConquista(e,s,l,d);if(streaksCache[e]=a,l&&pontosSemanais.hasOwnProperty(l)&&(pontosSemanais[l]=o),atualizarStreakVisualMembro(e,a),await atualizarResumo(),"adicionar"===s){const o=Object.keys(medalhas).map(Number).sort((e,a)=>e-a);let t=!1;for(const n of o)if(a>=n&&i<n){const o=medalhas[n],i=`Parab√©ns, ${e}! Voc√™ alcan√ßou ${a} dias de foco e conquistou a medalha ${o.emoji} ${o.nome}!`;currentUser===e&&(c.push({tipo:"medalha",titulo:"\uD83C\uDFC5 Nova Medalha!",mensagem:i,duracao:6e3}),c.push({tipo:"confete"}),t=!0),await adicionarEventoAoFeed("medalha","\uD83C\uDFC5 Nova Conquista!",`<strong>${e}</strong> alcan√ßou <strong>${a} dias</strong> de foco e ganhou a medalha ${o.emoji} <strong>${o.nome}</strong>!`,{nomeMembro:e,medalha:o.nome});break}if(currentUser===e){const a=t?1e3:0;c.push({tipo:"foco",titulo:"\uD83C\uDF89 Foco Registrado",mensagem:`${e}, parab√©ns por ter focado hoje!`,duracao:3e3,atraso:a}),c.push({tipo:"moedas",quantidade:recompensasConfig.focoDiario||100,atraso:a})}}else c.push({tipo:"removido",titulo:"\u2139\uFE0F Foco Removido",mensagem:`${e}, seu foco de hoje foi removido`,duracao:3e3});"adicionar"!==s||d||(l&&pontosSemanais.hasOwnProperty(l)?await gerarEventoDeFocoComIA(e,l,a,o):await gerarEventoDeFocoIndividualComIA(e,a)),"adicionar"===s?updateLoadingOverlayText("Maravilha, o foco foi registrado!"):updateLoadingOverlayText("Tudo bem, foco removido!"),"adicionar"===s&&currentUser===e&&tocarSom("som-check"),await new Promise(e=>setTimeout(e,1500))}catch(e){console.error("Erro no fluxo principal de marcarCheckbox:",e),o.checked=!o.checked}finally{hideLoadingOverlay(),checkboxLocks[e]=!1}0<c.length&&(await new Promise(e=>setTimeout(e,350)),c.forEach(e=>{const a=()=>{switch(e.tipo){case"moedas":mostrarPopupMoedas(e.quantidade);break;case"confete":dispararConfete(),tocarSom("som-conquista");break;default:mostrarPopup(e.titulo,e.mensagem,e.duracao);}};e.atraso?setTimeout(a,e.atraso):a()}))};async function verificarEProcessarFolgaDoDiaAtual(){if(currentUser)try{const e=todosMembros.find(e=>e.nome===currentUser);if(!e||!e.folga)return;const a=getDiaSemanaString().toLowerCase().replace(/-feira$/,"").normalize("NFD").replace(/[\u0300-\u036f]/g,""),o=e.folga.toLowerCase().replace(/-feira$/,"").normalize("NFD").replace(/[\u0300-\u036f]/g,"");if(o===a){const e=sessionStorage.getItem("popupFolgaMostradoHoje");if(!e){mostrarCardPopup("\uD83C\uDF34 Bom Descanso!","Como hoje \xE9 sua folga, sua caixa de sele\xE7\xE3o foi marcada automaticamente para voc\xEA. Aproveite!"),sessionStorage.setItem("popupFolgaMostradoHoje","true")}}}catch(e){console.error("Erro ao verificar popup de folga do dia atual:",e)}}async function marcarFolgaAutomatica(e){if(!e||!e.nome)return;const a=e.nome,o=getHojeISO(),t=doc(db,"membros",a),n=doc(db,"presencas",o),i=doc(db,"semanas","pontosSemanais");try{const{novoStreak:o,novosPontosEquipe:r}=await runTransaction(db,async e=>{const o=await e.get(t);if(!o.exists())throw"Membro n\xE3o encontrado.";let r;const d=o.data().equipe;d&&0!==getHoje().getDay()&&(r=await e.get(i));const s=(o.data().streak||0)+1;let l=0;d&&0!==getHoje().getDay()&&r&&r.exists()&&(l=r.data()[d]||0);const m=l+1;return e.set(n,{[a]:new Date},{merge:!0}),e.update(t,{streak:s}),d&&0!==getHoje().getDay()?(e.set(i,{[d]:m},{merge:!0}),{novoStreak:s,novosPontosEquipe:m}):{novoStreak:s,novosPontosEquipe:l}});streaksCache[a]=o,atualizarStreakVisualMembro(a,o),e.equipe&&0!==getHoje().getDay()&&(pontosSemanais[e.equipe]=r);let d;if(e.equipe&&Object.keys(equipes).includes(e.equipe)&&0!==getHoje().getDay()){const o=e.equipe.charAt(0).toUpperCase()+e.equipe.slice(1);d=`A caixa de sele√ß√£o de <strong>${a}</strong> foi marcada automaticamente, pois hoje √© o seu dia de folga. Isso garante +1 ponto para a equipe <strong>${o}</strong>, totalizando <strong>${r}</strong> pontos! Bom descanso <strong>${a}</strong>!!`}else d=`A caixa de sele√ß√£o de <strong>${a}</strong> foi marcada automaticamente, pois hoje √© o seu dia de folga. Bom descanso!`;await adicionarEventoAoFeed("geral","\uD83C\uDF34 Dia de Descanso Merecido!",d,{nomeMembro:a}),console.log(`Folga de ${a} marcada com sucesso. Pontua√ß√£o da equipe ${e.equipe} agora √© ${r}.`)}catch(e){console.error(`Erro ao marcar folga autom√°tica para ${a}:`,e)}}window.resetarTudo=async function(){if(confirm("\u26A0\uFE0F ATEN\xC7\xC3O: Voc\xEA est\xE1 prestes a resetar TODOS os dados!\nIsso apagar\xE1 todo o hist\xF3rico e pontos.\n\nDeseja continuar?"))try{const e=await getDocs(collection(db,"presencas"));for(const a of e.docs)await deleteDoc(a.ref);const a=doc(db,"semanas","pontosSemanais"),o=await getDoc(a);o.exists()&&(await deleteDoc(a));const t=doc(db,"ranking","geral");await setDoc(t,{abelha:0,joaninha:0,vagalume:0});const n=doc(db,"arvoreEpica","progresso");await deleteDoc(n);const i=await getDocs(collection(db,"streak"));for(const e of i.docs)await deleteDoc(e.ref);pontosSemanais.abelha=0,pontosSemanais.joaninha=0,pontosSemanais.vagalume=0,rankingGeral.abelha=0,rankingGeral.joaninha=0,rankingGeral.vagalume=0,await carregarPresenca(),await carregarTotalDias(),await carregarPontosSemanais(),await carregarRankingGeral(),await carregarArvoreEpica(),atualizarPlacarSemanal(),atualizarRankingGeral(),atualizarMedalhas(),atualizarExibicaoArvore(),mostrarPopup("\u2705 Reset Completo","Todos os dados foram resetados com sucesso!",5e3)}catch(e){console.error("Erro ao resetar dados:",e),mostrarPopup("\u274C Erro no Reset","Ocorreu um erro ao tentar resetar os dados.",5e3)}},window.resetarDia=async function(e=!1){if(!resetEmAndamento){if(resetEmAndamento=!0,!e&&!confirm("\u26A0\uFE0F ATEN\xC7\xC3O: Voc\xEA est\xE1 prestes a desmarcar TODOS os checkboxes do dia atual e zerar o contador do dia.\n\nIsso n\xE3o afetar\xE1 os pontos semanais ou streaks.\n\nDeseja continuar?"))return void(resetEmAndamento=!1);try{todosMembros.forEach(e=>{const a=e.nome,o=document.getElementById(a);if(o){o.checked=!1;const e=o.nextElementSibling;e&&e.classList.remove("checked")}});const a=getHojeISO(),o=doc(db,"presencas",a);await deleteDoc(o),document.getElementById("contadorGeral")&&(document.getElementById("contadorGeral").textContent="0 \xE9picos focaram hoje!",document.getElementById("progresso-barra").style.width="0%"),atualizarPlacarSemanal(),await Promise.all([carregarStreaks()]),e||mostrarPopup("\u2705 Dia Resetado","Todos os checkboxes foram desmarcados e o dia foi zerado.",5e3)}catch(e){console.error("Erro ao resetar o dia:",e),mostrarPopup("\u274C Erro","Ocorreu um erro ao resetar o dia.",5e3)}}};async function limparColecaoSemanas(){try{const e=collection(db,"semanas"),a=await getDocs(e);a.forEach(async e=>{"pontosSemanais"!==e.id&&(console.warn(`Apagando documento indesejado na cole√ß√£o 'semanas': ${e.id}`),await deleteDoc(doc(db,"semanas",e.id)))})}catch(e){console.error("Erro ao limpar cole\xE7\xE3o 'semanas':",e)}}async function limparMuralSemanal(){try{const e=getHoje();if(1!==e.getDay())return;const a=new Date(e);a.setDate(a.getDate()-7);const o=getSemanaAtual(a).numero,t=query(collection(db,"mural"),where("semana","<",o)),n=await getDocs(t),i=writeBatch(db);n.forEach(e=>{i.delete(e.ref)}),await i.commit(),console.log(`Mural limpo: ${n.size} mensagens antigas removidas`)}catch(e){console.error("Erro ao limpar mural:",e)}}const fasesArvore=[{dias:1,nome:"Semente",emoji:"\uD83C\uDF31",desc:"A jornada come\xE7a com um \xFAnico dia de foco. Vamos plantar nossa semente e cultivar nossa dedica\xE7\xE3o di\xE1ria!"},{dias:15,nome:"Broto",emoji:"\uD83C\uDF3F",desc:"Com 15 dias consecutivos, nosso esfor\xE7o come\xE7a a brotar. Vamos continuar regando nossa determina\xE7\xE3o!"},{dias:60,nome:"\xC1rvore",emoji:"\uD83C\uDF33",desc:"60 dias de foco ininterrupto! Nossa \xE1rvore cresce forte, simbolizando nossa consist\xEAncia e perseveran\xE7a."},{dias:180,nome:"Flores",emoji:"\uD83C\uDF38",desc:"180 dias de dedica\xE7\xE3o fazem florescer resultados. Cada flor representa uma conquista em nossa jornada!"},{dias:365,nome:"Frutos",emoji:"\uD83C\uDF4E",desc:"365 dias de foco cont\xEDnuo! Agora colhemos os frutos do nosso trabalho \xE1rduo e da nossa dedica\xE7\xE3o inabal\xE1vel."}];let arvoreEpica={consecutivos:0,ultimoDia:null,faseAtual:0};async function carregarEstadoArvore(){const e=doc(db,"arvoreEpica","progresso"),a=await getDoc(e);a.exists()?arvoreEpica=a.data():(arvoreEpica={consecutivos:0,ultimoDia:null,faseAtual:0},await setDoc(e,arvoreEpica))}async function verificarArvoreEpica(e){const a=getHojeISO();await carregarEstadoArvore();const o=getHoje(),t=todosMembros.length,n=document.getElementById("status-focado"),i=document.getElementById("status-nao-focado");n&&(n.textContent=`‚úÖ ${e} √©picos focaram hoje`),i&&(i.textContent=`‚ùå ${t-e} √©picos ainda n√£o focaram`);const r=arvoreEpica.ultimoDia,d=new Date(o);d.setDate(d.getDate()-1);const s=formatarDataISO(d),l=r===a;if(10<=e){if(!l){r?r===s?arvoreEpica.consecutivos++:arvoreEpica.consecutivos=1:arvoreEpica.consecutivos=1,arvoreEpica.ultimoDia=a;let e=0;for(let a=fasesArvore.length-1;0<=a;a--)if(arvoreEpica.consecutivos>=fasesArvore[a].dias){e=a;break}arvoreEpica.faseAtual=e;const o=doc(db,"arvoreEpica","progresso");if(await setDoc(o,arvoreEpica),atualizarExibicaoArvore(),0<e&&arvoreEpica.consecutivos===fasesArvore[e].dias){const a=document.getElementById("som-conquista");a&&(a.currentTime=0,a.play()),mostrarPopup("\uD83C\uDF33 \xC1rvore \xC9pica",`Parab√©ns! A √°rvore evoluiu para: ${fasesArvore[e].nome} ${fasesArvore[e].emoji}`,5e3),dispararConfete(),await adicionarEventoAoFeed("arvore","\uD83C\uDF33 A \xC1rvore Evoluiu!",`Com o esfor√ßo de todos, nossa √Årvore √âpica alcan√ßou a fase de ${fasesArvore[e].emoji} <strong>${fasesArvore[e].nome}</strong>! Continuem focando!`,{fase:fasesArvore[e].nome})}}}else if(l){arvoreEpica.consecutivos=Math.max(0,arvoreEpica.consecutivos-1),arvoreEpica.ultimoDia=0<arvoreEpica.consecutivos?s:null;let e=0;for(let a=fasesArvore.length-1;0<=a;a--)if(arvoreEpica.consecutivos>=fasesArvore[a].dias){e=a;break}arvoreEpica.faseAtual=e;const a=doc(db,"arvoreEpica","progresso");await setDoc(a,arvoreEpica),atualizarExibicaoArvore()}}async function carregarArvoreEpica(){await carregarEstadoArvore(),atualizarExibicaoArvore()}function criarEstrelas(){const e=document.querySelectorAll(".stars-container");0===e.length||e.forEach(e=>{if(!(0<e.children.length)){e.innerHTML="";for(let a=0;a<150;a++){const a=document.createElement("div");a.classList.add("star");const o=3*Math.random()+1;a.style.width=`${o}px`,a.style.height=`${o}px`,a.style.left=`${100*Math.random()}%`,a.style.top=`${100*Math.random()}%`,a.style.animationDelay=`${4*Math.random()}s`,a.style.animationDuration=`${2+3*Math.random()}s`,e.appendChild(a)}}})}function atualizarExibicaoArvore(){if(!document.getElementById("stage-name"))return;const e=fasesArvore[arvoreEpica.faseAtual];document.getElementById("stage-name").textContent=e.nome+" "+e.emoji,document.getElementById("stage-desc").textContent=e.desc,document.getElementById("dias-consecutivos").textContent=arvoreEpica.consecutivos;["seed","sprout","tree","flowers","fruits"].forEach((e,a)=>{const o=document.getElementById(e);o&&(a===arvoreEpica.faseAtual?o.style.display="block":o.style.display="none")});const a=arvoreEpica.faseAtual<fasesArvore.length-1?fasesArvore[arvoreEpica.faseAtual+1]:null,o=document.getElementById("proxima-fase");if(o)if(a){const e=a.dias-arvoreEpica.consecutivos;o.textContent=`Faltam ${e} dias para ${a.nome} ${a.emoji}`}else o.textContent="Voc\xEA alcan\xE7ou o n\xEDvel m\xE1ximo!";const t=getHoje(),n=t.getHours(),i=18<=n||6>n,r=document.querySelector("#secao-arvore-epica .tree-sky");if(r){const e=r.querySelector(".stars-container");i?(r.classList.add("night-mode"),r.classList.remove("day-mode"),criarEstrelas(),e&&(e.style.opacity="1")):(r.classList.remove("night-mode"),r.classList.add("day-mode"),e&&(e.style.opacity="0"))}const d=document.getElementById("sol"),s=document.getElementById("lua");d&&s&&(d.style.opacity=i?"0":"1",s.style.opacity=i?"1":"0")}async function verificarMudancaData(){const e=getHojeISO();dataAtual===e?atualizarDataCabecalho():(dataAtual=e,await executarRotinaDeMeiaNoite())}let resetEmAndamento=!1;async function marcarFolgaColetivaDeDomingo(){if(0!==getHoje().getDay())return;const e=getHojeISO(),a=doc(db,"appState","dailyTasks");try{const o=await getDoc(a),t=o.exists()&&o.data().domingoColetivoMarcadoPara===e;if(t)return console.log(`[DOMINGO COLETIVO] Marca√ß√£o para ${e} j√° foi feita. Apenas atualizando a tela.`),todosMembros.forEach(e=>{const a=document.getElementById(e.nome);a&&!a.checked&&(a.checked=!0)}),void(await atualizarResumo());console.log("\uD83C\uDF1E Domingo! Executando marca\xE7\xE3o de folga coletiva para todos os membros...");const n=writeBatch(db);todosMembros.forEach(a=>{const o=a.nome,t=doc(db,"membros",o),i=doc(db,"presencas",e);n.set(i,{[o]:new Date},{merge:!0}),n.update(t,{streak:increment(1),moedas:increment(recompensasConfig.focoDiario||100)})}),n.set(a,{domingoColetivoMarcadoPara:e},{merge:!0}),await n.commit(),console.log(`‚úÖ Folga coletiva de domingo SALVA para ${todosMembros.length} membros.`),await adicionarEventoAoFeed("geral","\uD83C\uDF34 Folga Coletiva de Domingo!","Hoje \xE9 nosso dia de descanso coletivo! Todas as caixas de sele\xE7\xE3o foram marcadas automaticamente para garantir o streak de todos. Bom descanso, \xC9picos!",{});for(const e of todosMembros){const a=e.nome,o=streaksCache[a]||0,t=o+1,n=Object.keys(medalhas).map(Number).sort((e,a)=>e-a);for(const e of n)if(t>=e&&o<e){const o=medalhas[e];await adicionarEventoAoFeed("medalha","\uD83C\uDFC5 Nova Conquista!",`<strong>${a}</strong> alcan√ßou <strong>${t} dias</strong> de foco e ganhou a medalha ${o.emoji} <strong>${o.nome}</strong>!`,{nomeMembro:a,medalha:o.nome}),console.log(`[DOMINGO COLETIVO] ${a} ganhou a medalha ${o.nome} (${t} dias).`);break}}todosMembros.forEach(e=>{const a=document.getElementById(e.nome);a&&(a.checked=!0),streaksCache[e.nome]!==void 0&&streaksCache[e.nome]++}),await atualizarResumo()}catch(e){console.error("Erro cr\xEDtico ao marcar a folga coletiva de domingo:",e)}}async function executarRotinaDeMeiaNoite(){console.log("\uD83D\uDD5B Executando rotina da meia-noite..."),await verificarEConcederPremiacaoDiaria(),await gerenciarEventosAgendadosDoOraculo(),await processarJurosEAutolimpezaBancos(),folgasManualmenteRemovidas={};const e=getHoje(),a=getDiaSemanaString(e),o=0===e.getDay();await resetarDia(!0),await finalizarSemana(),await marcarFolgaColetivaDeDomingo(),o||(await executarMarcacaoAutomaticaDeFolgasDoDia()),atualizarDataCabecalho(),atualizarInfoSemana(),await carregarPontosSemanais(),atualizarPlacarSemanal(),await carregarArvoreEpica(),await atualizarResumo(),console.log("\u2705 Rotina da meia-noite conclu\xEDda. A interface foi atualizada.")}async function gerarConteudoMuralComIA(e){if(!genAI)return{texto:"A const\xE2ncia \xE9 a ponte entre o desejo e a realiza\xE7\xE3o. Mantenham o foco hoje. \u2014 Or\xE1culo.",cor:"#A0C4FF"};let a=[];try{const e=query(collection(db,"mural"),where("userId","==","Or\xE1culo"),orderBy("timestamp","desc"),limit(10)),o=await getDocs(e);o.forEach(e=>{a.push(e.data().cor)})}catch(a){console.error("Erro ao buscar cores recentes do Or\xE1culo:",a)}let o=[];const t=getSemanaAtual(),n=`oraculoTopics_${t.numero}_${t.inicio.getFullYear()}`,i=doc(db,"appState",n);try{const e=await getDoc(i);e.exists()&&(o=e.data().cenariosUsados||[])}catch(a){console.error("Erro ao buscar hist\xF3rico de t\xF3picos do Or\xE1culo:",a)}const r=getHoje(),d=getDiaSemanaString(r);let s="Ningu\xE9m completou ainda.";try{const e=getSemanaAtual(),a=`semana_${e.numero}_${e.inicio.getFullYear()}`,o=doc(db,"vantagemSemanal",a),t=await getDoc(o);if(t.exists()&&t.data().completadoPor){const e=t.data().completadoPor,a=Object.entries(e).map(([e,a])=>({nome:e,tempo:a.toDate()})).sort((e,a)=>e.tempo-a.tempo);0<a.length&&(s=a.map((e,a)=>`${a+1}¬∫: ${e.nome}`).join(", "))}}catch(a){console.error("Erro ao buscar dados do Jogo da Vantagem:",a)}let l="Nenhum evento importante registrado ainda.";feedEventosCache&&0<feedEventosCache.length&&(l=feedEventosCache.slice(0,5).map(e=>{const a=e.texto.replace(/<[^>]*>/g," ");return`- ${e.titulo}: ${a.trim()}`}).join("\n"));let m="O mural de mensagens est\xE1 vazio no momento.",c="Ningu\xE9m contribuiu nos desenhos ainda.";try{const[e,a,o,t]=await Promise.all([getDocs(query(collection(db,"mural"),orderBy("timestamp","desc"),limit(5))),getDocs(query(collection(db,`desenhos_abelha`))),getDocs(query(collection(db,`desenhos_joaninha`))),getDocs(query(collection(db,`desenhos_vagalume`)))]);e.empty||(m="Mural de Mensagens Recentes:\n"+e.docs.map(e=>{const a=e.data(),o=a.texto.replace(/<[^>]*>/g," ").trim();return`- ${a.nome}: "${o}"`}).join("\n"));const n={abelha:new Set,joaninha:new Set,vagalume:new Set};a.forEach(e=>e.data().desenhadoPor&&n.abelha.add(e.data().desenhadoPor)),o.forEach(e=>e.data().desenhadoPor&&n.joaninha.add(e.data().desenhadoPor)),t.forEach(e=>e.data().desenhadoPor&&n.vagalume.add(e.data().desenhadoPor));const i=Object.entries(n).filter(([,e])=>0<e.size).map(([e,a])=>`- Equipe ${e.charAt(0).toUpperCase()+e.slice(1)}: Desenhado por (${Array.from(a).join(", ")})`);0<i.length&&(c="Status das Telas de Desenho:\n"+i.join("\n"))}catch(a){console.error("Erro ao buscar dados do mural ou desenhos:",a)}let u="Estrutura das Equipes e Membros:\n";for(const a in liderGeral&&(u+=`- L√≠der Geral: ${liderGeral.nome}\n`),equipes){const e=equipes[a];u+=`Equipe ${a.charAt(0).toUpperCase()+a.slice(1)}:\n`,e.lider&&(u+=`  - L√≠der: ${e.lider.nome}${e.lider.deFerias?" (F\xC9RIAS)":""}\n`);const o=e.membros.filter(e=>"membro"===e.papel).map(e=>e.nome+(e.deFerias?" (F\xC9RIAS)":"")).join(", ");u+=`  - Membros: ${o||"(Nenhum membro)"}\n`}const p=document.getElementById("media-abelha")?.textContent||"N/A",g=document.getElementById("media-joaninha")?.textContent||"N/A",f=document.getElementById("media-vagalume")?.textContent||"N/A",h=`
---
INFORMA√á√ïES EM TEMPO REAL (ESTADO ATUAL DO GRUPO):
- Data de Hoje: ${d}

${u}

Placar da Competi√ß√£o Semanal (M√âDIA NIVELADA):
- Equipe Abelha: ${p} pontos de m√©dia.
- Equipe Joaninha: ${g} pontos de m√©dia.
- Equipe Vaga-lume: ${f} pontos de m√©dia.

Ranking Geral de Vit√≥rias:
- Equipe Abelha: ${rankingGeral.abelha} vit√≥rias.
- Equipe Joaninha: ${rankingGeral.joaninha} vit√≥rias.
- Equipe Vaga-lume: ${rankingGeral.vagalume} vit√≥rias.

Status do Jogo da Vantagem (quem terminou primeiro):
- ${s}

Acontecimentos Recentes (Resumo da Semana):
${l}

${m}

${c}
---
  `;let v=[];const E=`oraculoHistory_semana_${t.numero}_${t.inicio.getFullYear()}`,y=doc(db,"appState",E);try{const e=await getDoc(y);e.exists()&&(v=e.data().mencionados||[])}catch(a){console.error("Erro ao buscar hist\xF3rico de men\xE7\xF5es:",a)}const b={manha:[{id:"elogio_foco_matinal",desc:"ELOGIO DE FOCO MATINAL: Elogie um ou dois membros que foram os primeiros a marcar o foco hoje."},{id:"incentivo_geral_manha",desc:"INCENTIVO GERAL (MANH\xC3): Envie uma mensagem de bom dia e motiva\xE7\xE3o para o grupo come\xE7ar bem o dia."},{id:"lembrete_folga",desc:"LEMBRETE DE FOLGA: Deseje um bom descanso a um membro que est\xE1 de folga hoje."},{id:"comentar_evento_recente_manha",desc:"COMENTAR EVENTO RECENTE: Comente sobre um dos 'Acontecimentos Recentes' relevantes para o in\xEDcio do dia."},{id:"incentivo_equipe_manha",desc:"INCENTIVO EQUIPE: Envie uma mensagem de incentivo para uma equipe espec\xEDfica baseada no placar atual."}],tarde:[{id:"reflexao_tarde",desc:"REFLEX\xC3O (TARDE): Envie uma mensagem de reflex\xE3o para a metade do dia, incentivando a persist\xEAncia."},{id:"elogio_lideranca",desc:"ELOGIO DE LIDERAN\xC7A: Elogie um dos l\xEDderes de equipe pelo bom trabalho."},{id:"incentivo_jogo_vantagem",desc:"INCENTIVO NO JOGO: Incentive um membro que ainda n\xE3o terminou o Jogo da Vantagem."},{id:"comentar_desenho",desc:"COMENTAR DESENHO: Comente sobre o progresso de um dos desenhos das equipes."},{id:"reconhecimento_geral_tarde",desc:"RECONHECIMENTO GERAL: Elogie o esfor\xE7o geral do grupo na competi\xE7\xE3o."}],noite:[{id:"agradecimento_noite_todos",desc:"AGRADECIMENTO (NOITE): Agrade\xE7a a todos que focaram e deseje um bom descanso. Use <strong>@todos</strong> aqui."},{id:"elogio_dedicacao_total",desc:"ELOGIO DE DEDICA\xC7\xC3O: Comente sobre um membro que tem um total de dias de foco impressionante (USE COM MODERA\xC7\xC3O)."},{id:"reflexao_noturna",desc:"REFLEX\xC3O NOTURNA: Uma mensagem curta sobre descanso e prepara\xE7\xE3o para o dia seguinte."},{id:"comentar_mural",desc:"COMENTAR MURAL: Comente sobre uma mensagem interessante postada no mural por outro membro."},{id:"previsao_sutil_competicao",desc:"PREVIS\xC3O SUTIL: Comente sutilmente sobre a disputa entre as equipes na competi\xE7\xE3o."}]}[e].map(e=>`- ${e.desc} (ID: ${e.id})`).join("\n"),L=`
    Voc√™ √© o "Or√°culo", o mentor s√°bio (cerca de 50 anos), acolhedor e carinhoso do "Grupo √âpicos".
    Sua tarefa √© escrever uma mensagem curta e pessoal para o mural do grupo para o per√≠odo da '${e}', usando o CONTEXTO EM TEMPO REAL fornecido e EVITANDO repetir cen√°rios j√° usados esta semana.

    REGRAS DE PERSONALIDADE (MENTOR ACOLHEDOR):
    - Use um tom que demonstre cuidado e apoio.
    - NUNCA se revele como uma IA. Aja 100% como uma pessoa.
    - Assine sempre com "‚Äî Or√°culo".
    - REGRA SOBRE O 'TOTAL DE DIAS DE FOCO': Este n√∫mero √© um contador de todos os dias que um membro focou. Elogie a 'dedica√ß√£o total' e o 'comprometimento', nunca a 'sequ√™ncia'.

    CONTEXTO EM TEMPO REAL DO GRUPO PARA SUA AN√ÅLISE:
    ${h}
    - Lista completa de membros (Nome de Usu√°rio, Nome Real, Total de Dias de Foco, F√©rias): ${todosMembros.map(e=>`${e.nome} (Nome Real: ${e["me chamo"]||"N/A"}, ${streaksCache[e.nome]||0} dias de foco${e.deFerias?", DE F\xC9RIAS":""})`).join(", ")}

    INSTRU√á√ïES:
    1.  **REGRA DE ENDERE√áAMENTO (MUITO IMPORTANTE):** Ao mencionar um membro, sempre use seu "Nome de Usu√°rio". Use o "Nome Real" apenas para determinar o g√™nero e escolher os pronomes corretos. NUNCA use o Nome Real diretamente na mensagem.

    2.  **REGRA DE MEN√á√ÉO (MUITO IMPORTANTE):**
        -   Em todas as mensagens, voc√™ dever√° mencionar obrigatoriamente um ou mais membros.
        -   **NUNCA, EM HIP√ìTESE ALGUMA,** mencione nominalmente um membro que j√° est√° na lista 'MEMBROS J√Å MENCIONADOS ESTA SEMANA'.
        -   Se todos os membros j√° tiverem sido mencionados, use as 'MEN√á√ïES ESPECIAIS'.

    3.  **MEMBROS J√Å MENCIONADOS ESTA SEMANA (N√ÉO MENCIONAR NOVAMENTE):** ${v.join(", ")||"Nenhum"}

    4.  **FORMATA√á√ÉO DE MEN√á√ÉO:** Use <strong>@NomeDoMembro</strong>, <strong>@todos</strong>, <strong>@equipeAbelha</strong>, <strong>@equipeJoaninha</strong> ou <strong>@equipeVagalume</strong>.

    // --- REGRAS ATUALIZADAS PARA MEM√ìRIA E VARIEDADE ---
    5.  **CEN√ÅRIOS J√Å USADOS ESTA SEMANA (EVITAR REPETIR):** ${o.join(", ")||"Nenhum"}

    6.  **ESCOLHA DO CEN√ÅRIO (OBRIGAT√ìRIO):** Escolha UM dos "CEN√ÅRIOS POSS√çVEIS" abaixo que AINDA N√ÉO esteja na lista de "CEN√ÅRIOS J√Å USADOS". Se todos j√° foram usados, voc√™ pode repetir um, mas priorize variar o m√°ximo poss√≠vel. Use o CONTEXTO EM TEMPO REAL para adaptar o cen√°rio escolhido e criar uma mensagem relevante.

    7.  **REGRA DE T√ìPICO SOBRE EQUIPES (MUITO IMPORTANTE):** N√£o comente repetidamente sobre as mesmas equipes liderando o placar ('M√âDIA NIVELADA') dia ap√≥s dia. Se o placar estiver semelhante aos dias anteriores, **obrigatoriamente escolha outro t√≥pico** para comentar sobre as equipes.

    8.  **NOVA INSTRU√á√ÉO:** Verifique os "Acontecimentos Recentes".
        -   Se houver eventos sobre "Medalha de Honra Concedida" ou "Poder Ativado" (Lojinha), considere usar o cen√°rio "COMENTAR EVENTO RECENTE".
        -   **REGRA DE SIGILO (MUITO IMPORTANTE):** NUNCA mencione a ativa√ß√£o do "Amuleto de Prote√ß√£o". Este poder √© uma armadilha secreta. Voc√™ s√≥ deve mencionar o Amuleto se um evento de "Falha na Magia" ou "Magia Bloqueada" aparecer, onde um ataque falhou contra a equipe protegida.
    
    9.  A mensagem deve ser curta, direta e parecer uma observa√ß√£o genu√≠na sua.
	
    10. CORES USADAS RECENTEMENTE (EVITE USAR ESTAS): ${a.join(", ")}

    CEN√ÅRIOS POSS√çVEIS PARA A '${e.toUpperCase()}' (ESCOLHA UM E INFORME O ID):
    ${b}

    FORMATO DA RESPOSTA (OBRIGAT√ìRIO):
    Sua resposta DEVE ser um JSON v√°lido no formato:
    {
      "texto": "SUA_MENSAGEM_AQUI",
      "cor": "#CODIGO_HEX_DA_COR",
      "cenario": "ID_DO_CEN√ÅRIO_ESCOLHIDO"
    }
    - O texto j√° deve incluir sua assinatura e a formata√ß√£o com a tag <strong> e as men√ß√µes.
    - Escolha uma cor hexadecimal adequada que n√£o esteja na lista de cores recentes.
    - Inclua o ID exato do cen√°rio que voc√™ escolheu (ex: "elogio_foco_matinal").
  `;try{const e=genAI.getGenerativeModel({model:"gemini-2.5-flash-lite"}),a=await e.generateContent(L),o=await a.response,t=o.text(),n=t.match(/{[\s\S]*}/);if(!n)throw new Error("JSON n\xE3o encontrado na resposta da IA: "+t);const r=n[0],d=JSON.parse(r);if(d.texto&&d.cor&&d.cenario){const e=[...d.texto.matchAll(/@([\w√°√©√≠√≥√∫√Å√â√ç√ì√ö√¢√™√Æ√¥√ª√Ç√ä√é√î√õ√†√®√¨√≤√π√Ä√à√å√í√ô√£√µ√É√ï√ß√á]+)/g)].map(e=>e[1]).filter(e=>todosMembros.some(a=>a.nome===e));0<e.length&&(await setDoc(y,{mencionados:arrayUnion(...e)},{merge:!0}),console.log(`Or√°culo: Men√ß√µes a [${e.join(", ")}] salvas no hist√≥rico da semana.`));const a=d.cenario;await setDoc(i,{cenariosUsados:arrayUnion(a)},{merge:!0}),console.log(`Or√°culo: Cen√°rio '${a}' salvo no hist√≥rico da semana.`);const o=d.texto.match(/@([\w√°√©√≠√≥√∫√Å√â√ç√ì√ö√¢√™√Æ√¥√ª√Ç√ä√é√î√õ√†√®√¨√≤√π√Ä√à√å√í√ô√£√µ√É√ï√ß√á]+)/g)?.map(e=>e.substring(1))||[];let t;if(0<o.length&&!o.includes("todos")){const e=o.slice(0,2);let a=`<strong>${e.join("</strong> e <strong>")}</strong>`;2<o.length&&(a+=` e outros`),t=`O <strong>Or√°culo</strong> compartilhou uma nova mensagem no mural mencionando ${a}. D√™ uma olhada!`}else t="O <strong>Or\xE1culo</strong> compartilhou uma nova mensagem no mural. D\xEA uma olhada!";const n=await adicionarEventoAoFeed("geral","\uD83E\uDDD9\u200D Uma Mensagem do Or\xE1culo",t,{nomeMembro:"Or\xE1culo"});return{texto:d.texto,cor:d.cor,feedEventId:n}}throw new Error("Formato de JSON inv\xE1lido ou incompleto (faltando texto, cor ou cenario).")}catch(e){return console.error("Erro ao gerar post do Or\xE1culo com a IA (Mem\xF3ria). Usando fallback.",e),{texto:"A jornada \xE9 longa, mas a companhia de voc\xEAs a torna mais leve. Continuem firmes. \u2014 Or\xE1culo",cor:"#BDB2FF",feedEventId:await adicionarEventoAoFeed("geral","\uD83E\uDDD9\u200D Uma Mensagem do Or\xE1culo","O <strong>Or\xE1culo</strong> compartilhou uma nova mensagem no mural. D\xEA uma olhada!",{nomeMembro:"Or\xE1culo"})}}}async function obterPalavrasDaSemanaComIA(){if(!genAI)return console.warn("IA n\xE3o inicializada. Usando palavras de fallback."),["Foco","Sucesso","Alegria","Paz","Amor","Luz","For\xE7a"];const e=getSemanaAtual(),a=`palavrasDaSemana_${e.inicio.getFullYear()}_${e.numero}`,o=doc(db,"appState",a);try{const e=await getDoc(o);if(e.exists()){const a=e.data().palavras;return console.log(`Or√°culo: Palavras da semana j√° existem. Retornando lista completa.`),a}console.log("Or\xE1culo: Gerando novas 7 palavras positivas para a semana...");const a=genAI.getGenerativeModel({model:"gemini-2.5-flash-lite"}),t=await a.generateContent("\n      Sua \xFAnica tarefa \xE9 gerar uma lista de 7 palavras positivas e inspiradoras em portugu\xEAs do Brasil.\n      As palavras devem ser curtas e motivacionais, como \"Sucesso\", \"Conquista\", \"Determina\xE7\xE3o\", \"Resili\xEAncia\", etc.\n      Sua resposta DEVE ser um JSON v\xE1lido no formato: {\"palavras\": [\"PALAVRA1\", \"PALAVRA2\", \"PALAVRA3\", \"PALAVRA4\", \"PALAVRA5\", \"PALAVRA6\", \"PALAVRA7\"]}.\n      N\xE3o inclua nenhuma outra explica\xE7\xE3o ou formata\xE7\xE3o. Apenas o JSON puro.\n    "),n=await t.response,i=n.text().trim(),r=i.match(/{[\s\S]*}/);if(!r)throw new Error("A IA n\xE3o retornou um JSON v\xE1lido. Resposta recebida: "+i);const d=r[0],s=JSON.parse(d),l=s.palavras;if(!Array.isArray(l)||7!==l.length)throw new Error("A IA n\xE3o retornou um array com 7 palavras.");return await setDoc(o,{palavras:l}),console.log("Or\xE1culo: Novas palavras salvas para a semana:",l),l}catch(e){return console.error("Erro ao obter as palavras da semana:",e),["Supera\xE7\xE3o","Coragem","Vit\xF3ria","Inspira\xE7\xE3o","Energia","Sonhos","Conex\xE3o"]}}function embaralharArrayComSemente(e,a){const o=[...e];for(let t=o.length-1;0<t;t--){const e=(t*a+a%5)%(t+1);[o[t],o[e]]=[o[e],o[t]]}return o}function atualizarDataCabecalho(){const e=getHoje(),a=e.toLocaleDateString("pt-BR",{weekday:"long",day:"numeric",month:"long"}),o=document.getElementById("dataHoje");o&&(o.textContent=a.charAt(0).toUpperCase()+a.slice(1))}function atualizarInfoSemana(){const e=getSemanaAtual(),a=document.getElementById("info-semana");a&&(a.innerHTML=`
        <div style="font-weight:bold"><span class="destaque-semana">Semana ${e.numero}</span></div>
        <div>(${e.inicioFormatado} a ${e.fimFormatado})</div>
        <div style="font-size:0.9rem;margin-top:5px;color:#7f8c8d">
          A competi√ß√£o ser√° encerrada s√°bado (${e.fimCompeticao}), √†s 23:59h.
        </div>
      `)}function isColorDark(e){const a="#"===e.charAt(0)?e.substring(1,7):e,o=parseInt(a.substring(0,2),16),t=parseInt(a.substring(2,4),16),n=parseInt(a.substring(4,6),16);return 128>.299*o+.587*t+.114*n}async function openMessageViewer(a){unsubscribeViewerListener&&(unsubscribeViewerListener(),unsubscribeViewerListener=null);const o=document.getElementById("message-viewer-modal");openModal("message-viewer-modal"),o.dataset.activeMessageId=a;const t=doc(db,"mural",a);unsubscribeViewerListener=onSnapshot(t,e=>{if(!e.exists())return void closeModal("message-viewer-modal");const t=e.data(),n=document.getElementById("viewer-card"),i=document.getElementById("viewer-text"),r=document.getElementById("viewer-author"),d=document.getElementById("viewer-timestamp"),s=document.getElementById("viewer-reacoes-container"),l=t.timestamp.toDate();n.style.backgroundColor=t.cor,r.textContent=t.nome,d.textContent=`${l.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"})} - ${l.toLocaleDateString("pt-BR")}`;let m=t.texto||"";m=m.replace(/@([\w√°√©√≠√≥√∫√Å√â√ç√ì√ö√¢√™√Æ√¥√ª√Ç√ä√é√î√õ√†√®√¨√≤√π√Ä√à√å√í√ô√£√µ√É√ï√ß√á]+)/g,"<span class=\"mention\">@$1</span>"),i.innerHTML=m,isColorDark(t.cor)?n.classList.add("text-light"):n.classList.remove("text-light");const c=t.reacoes||{};let u="",p=!1;const g=Object.keys(c).sort((e,a)=>(c[a]?.length||0)-(c[e]?.length||0));for(const o of g){const e=Array.isArray(c[o])?c[o]:[];if(0<e.length){p=!0;const t=e.includes(currentUser),n=t?"reacted":"",i=0<e.length?`Reagido por: ${e.join(", ")}`:`Reagir com ${o}`;u+=`<div class="reacao-display ${n}" title="${i}" data-emoji="${o}" onclick="window.abrirModalReagentes('${a}', '${o}')">${o} <span class="contador-display">${e.length}</span></div>`}}s.innerHTML=u,s.style.display=p?"flex":"none";const f=o.querySelector(".reacao-seletor-bar");f.innerHTML="",EMOJIS_MURAL.forEach(o=>{const t=document.createElement("button");t.textContent=o,t.onclick=t=>{t.stopPropagation(),window.toggleReacao(a,o,t)},f.appendChild(t)}),f.classList.remove("hidden")})}async function confirmDelete(){if(messageIdToDelete){const e=doc(db,"mural",messageIdToDelete);try{const a=await getDoc(e);if(a.exists()){const o=a.data(),t=o.userId,n=writeBatch(db),i=o.feedEventId;i&&n.delete(doc(db,"resumoSemanalFeed",i));const r=o.mentionNotificationIds||[];if(0<r.length&&r.forEach(e=>{n.delete(doc(db,"notificacoes",e))}),t&&"An\xF4nimo"!==t&&"Or\xE1culo"!==t){const e=doc(db,"membros",t);n.update(e,{moedas:increment(-5)})}n.delete(e),await n.commit()}mostrarPopup("\u2705 Sucesso","Mensagem e notifica\xE7\xF5es relacionadas foram exclu\xEDdas!",3e3)}catch(e){mostrarPopup("\u274C Erro","Falha ao excluir a mensagem.",3e3),console.error("Erro ao excluir:",e)}finally{closeModal("confirm-delete-modal"),messageIdToDelete=null}}}function openMessageComposer(e=null){const a=document.getElementById("composer-send-btn");if(e){document.getElementById("composer-textarea").value=e.texto;const o="An\xF4nimo"===e.nome;document.getElementById("composer-anonymous-check").checked=o,document.getElementById("composer-author").textContent=o?"An\xF4nimo":currentUser,selectComposerColor(e.cor),a.textContent="Salvar Altera\xE7\xF5es"}else document.getElementById("composer-textarea").value="",document.getElementById("composer-anonymous-check").checked=!1,document.getElementById("composer-author").textContent=currentUser,selectComposerColor("#CAFFBF"),a.textContent="Enviar",composerEditMode=!1,editingMessageId=null;updateComposerTimestamp(),composerTimestampInterval=setInterval(updateComposerTimestamp,1e3),openModal("message-composer-modal")}function closeMessageComposer(){clearInterval(composerTimestampInterval),closeModal("message-composer-modal"),composerEditMode=!1,editingMessageId=null}window.formatText=function(e){document.execCommand(e,!1,null),document.getElementById("composer-textarea").focus()};function updateComposerTimestamp(){const e=new Date,a=e.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"}),o=e.toLocaleDateString("pt-BR");document.getElementById("composer-timestamp").textContent=`${a} - ${o}`}function selectComposerColor(e){composerSelectedColor=e;const a=document.getElementById("composer-card"),o=document.getElementById("composer-color-btn");a.style.backgroundColor=e,o.style.backgroundColor=e,isColorDark(e)?(a.classList.add("text-light"),o.classList.add("text-light")):(a.classList.remove("text-light"),o.classList.remove("text-light")),document.getElementById("composer-color-palette").classList.add("hidden")}window.enviarMensagem=async function(){const e=document.getElementById("composer-anonymous-check").checked,a=e?"An\xF4nimo":currentUser,o=document.getElementById("composer-textarea"),t=o.innerHTML.trim(),n=o.innerText.trim();if(!n||"<br>"===t)return void mostrarPopup("\u270D\uFE0F Aten\xE7\xE3o","Digite uma mensagem.",3e3);const i={nome:a,texto:t,cor:composerSelectedColor,userId:currentUser};try{if(composerEditMode&&editingMessageId){const e=doc(db,"mural",editingMessageId);await updateDoc(e,i),mostrarPopup("\u2705 Sucesso","Mensagem editada!",3e3)}else{if("lider"!==userRole){const e=query(collection(db,"mural"),where("userId","==",currentUser)),a=await getDocs(e);if(3<=a.size)return void mostrarPopup("\uD83D\uDEAB Limite Atingido","Voc\xEA j\xE1 postou o m\xE1ximo de 3 mensagens. Apague uma antiga para poder postar uma nova.",5e3)}const o=n.match(/@([\w√°√©√≠√≥√∫√Å√â√ç√ì√ö√¢√™√Æ√¥√ª√Ç√ä√é√î√õ√†√®√¨√≤√π√Ä√à√å√í√ô√£√µ√É√ï√ß√á]+)/g)?.map(e=>e.substring(1))||[],t=new Set;0<o.length&&o.forEach(e=>{if("todos"===e.toLowerCase())todosMembros.forEach(e=>{e.nome!==currentUser&&t.add(e.nome)});else if(e.toLowerCase().startsWith("equipe")){const a=e.substring(6).toLowerCase();equipes[a]&&equipes[a].membros.forEach(e=>{e.nome!==currentUser&&t.add(e.nome)})}else{const a=todosMembros.find(a=>a.nome.toLowerCase()===e.toLowerCase());a&&a.nome!==currentUser&&t.add(a.nome)}});let r;if(0<t.size){const e=Array.from(t).slice(0,2);let o=`<strong>${e.join("</strong> e <strong>")}</strong>`;2<t.size&&(o+=` e outros`),r=`<strong>${a}</strong> compartilhou uma nova mensagem mencionando ${o}. D√™ uma olhada!`}else r=e?"<strong>Um an\xF4nimo</strong> compartilhou uma nova mensagem no mural. D\xEA uma olhada!":`<strong>${a}</strong> compartilhou uma nova mensagem no mural. D√™ uma olhada!`;const d=await adicionarEventoAoFeed("geral","\u270D\uFE0F Nova Mensagem no Mural!",r,{nomeMembro:a});d&&(i.feedEventId=d),i.timestamp=new Date,i.reacoes=EMOJIS_MURAL.reduce((e,a)=>({...e,[a]:[]}),{}),i.semana=getSemanaAtual().numero;const s=writeBatch(db),l=doc(collection(db,"mural"));if(s.set(l,i),0<t.size){const e=`"${n.substring(0,30)}..."`;t.forEach(a=>{const o=doc(collection(db,"notificacoes"));s.set(o,{destinatarioId:a,remetenteNome:currentUser,tipo:"mural-mention",conteudo:"\uD83D\uDCAC",acao:`mencionou voc√™ em uma mensagem: ${e}`,lida:!1,timestamp:new Date})})}const m=doc(db,"membros",currentUser);s.update(m,{moedas:increment(recompensasConfig.postarMural||5)}),await s.commit(),mostrarPopup("\u2705 Sucesso","Mensagem enviada!",3e3),tocarSom("som-envio"),mostrarPopupMoedas(recompensasConfig.postarMural||5),o.map(e=>e.toLowerCase()).includes("or\xE1culo")&&setTimeout(()=>{executarInteracaoImediataOraculo(l.id,n,currentUser)},3e3)}closeMessageComposer()}catch(e){console.error("Erro:",e),mostrarPopup("\u274C Erro","Ocorreu um erro.",3e3)}finally{composerEditMode=!1,editingMessageId=null}},window.abrirAssistenteOraculo=function(){openModal("oracle-assistant-modal")},window.executarAcaoAssistenteIA=async function(e){if(!genAI)return void mostrarPopup("\u274C Erro","O assistente de IA n\xE3o est\xE1 dispon\xEDvel no momento.",4e3);const a=document.getElementById("composer-textarea"),o=a.innerText;let t="";switch(e){case"sugerir":if(!o)return void mostrarPopup("\u270D\uFE0F Aten\xE7\xE3o","Escreva algo primeiro para que eu possa sugerir uma continua\xE7\xE3o.",4e3);t=`Sua √∫nica tarefa √© completar o texto a seguir, agindo como o Or√°culo (s√°bio, direto, po√©tico). Continue a escrita EXATAMENTE de onde o texto parou.

REGRAS IMPORTANTES:
- N√ÉO ofere√ßa m√∫ltiplas op√ß√µes.
- N√ÉO escreva nenhuma introdu√ß√£o, explica√ß√£o ou coment√°rio ("Aqui est√° uma continua√ß√£o...", "Op√ß√£o 1:", etc.).
- Sua resposta deve ser APENAS a continua√ß√£o direta do texto, sem repetir a parte que j√° foi escrita.

Texto para completar:
"${o}"`;break;case"resumir":if(!o)return void mostrarPopup("\u270D\uFE0F Aten\xE7\xE3o","N\xE3o h\xE1 texto para resumir.",3e3);t=`Resuma o seguinte texto em uma ou duas frases curtas e objetivas:\n\n"${o}"`;break;case"corrigir":if(!o)return void mostrarPopup("\u270D\uFE0F Aten\xE7\xE3o","N\xE3o h\xE1 texto para corrigir.",3e3);t=`Corrija a ortografia e a gram√°tica do texto a seguir, mantendo a inten√ß√£o original. Retorne apenas o texto corrigido:\n\n"${o}"`;break;case"tonalizar":if(!o)return void mostrarPopup("\u270D\uFE0F Aten\xE7\xE3o","Escreva algo primeiro para que eu possa alterar o tom.",4e3);t=`Reescreva o texto a seguir com a personalidade do Or√°culo: s√°bio, um pouco misterioso e direto. Retorne apenas o texto reescrito:\n\n"${o}"`;break;default:return;}closeModal("oracle-assistant-modal"),mostrarPopup("\uD83E\uDDD9\u200D Or\xE1culo","O Or\xE1culo est\xE1 conjurando as palavras...",3e3);try{const o=genAI.getGenerativeModel({model:"gemini-2.5-flash-lite"}),n=await o.generateContent(t),i=await n.response;let r=i.text();"sugerir"===e?a.innerHTML+=`<br><br>${r.replace(/\n/g,"<br>")}`:a.innerHTML=r.replace(/\n/g,"<br>"),mostrarPopup("\u2705 Pronto!","A sugest\xE3o do Or\xE1culo foi aplicada.",3e3)}catch(e){console.error("Erro na a\xE7\xE3o do assistente de IA:",e),mostrarPopup("\u274C Erro","O Or\xE1culo n\xE3o conseguiu processar sua solicita\xE7\xE3o.",4e3)}},window.editarMensagem=async function(e,a){document.getElementById("global-options-menu").classList.add("hidden"),e.stopPropagation(),composerEditMode=!0,editingMessageId=a;try{const e=await getDoc(doc(db,"mural",a));e.exists()&&openMessageComposer(e.data())}catch(e){console.error("Erro ao buscar mensagem para editar:",e)}},window.excluirMensagem=function(e,a){document.getElementById("global-options-menu").classList.add("hidden"),e.stopPropagation(),messageIdToDelete=a,openModal("confirm-delete-modal")};function createColorPalette(){const e=document.getElementById("composer-color-palette");e&&(e.innerHTML="",["#FFFFFF","#FADADD","#FFD6A5","#FDFFB6","#CAFFBF","#9BF6FF","#A0C4FF","#BDB2FF","#FFC6FF","#EAE4E9","#D4E09B","#C3E0E5","#F7D6E0","#F3E9DD","#D3E4CD","#FF1744","#F50057","#D500F9","#651FFF","#3D5AFE","#2979FF","#00B0FF","#00E5FF","#1DE9B6","#00E676","#76FF03","#C6FF00","#FFEA00","#FFC400","#FF9100","#FF3D00","#F38375","#FBC42C","#57C479","#57C5C8","#578DC8","#8A57C8","#C857B2","#4B4A49","#ACACAC","#795548","#607D8B","#000000","#E57373","#BA68C8","#7986CB","#4FC3F7","#4DB6AC","#AED581","#FFF176","#FFB74D","#A1887F","#90A4AE","#008F93","#F08080","#20B2AA","#87CEEB","#9370DB","#DA70D6"].forEach(a=>{const o=document.createElement("div");o.className="composer-color-option",o.style.backgroundColor=a,o.title=a,o.onclick=()=>selectComposerColor(a),e.appendChild(o)}))}function criarElementoMensagem(a){const o=a.cor||"#ffdde1",t=a.timestamp,n=t.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"}),i=t.toLocaleDateString("pt-BR"),r=document.createElement("div");r.className="mensagem",r.style.backgroundColor=o,r.dataset.id=a.id,r.dataset.fullText=a.texto||"",r.style.setProperty("--card-bg-color",o),isColorDark(o)&&r.classList.add("text-light");let d=a.texto||"";d=d.replace(/@([\w√°√©√≠√≥√∫√Å√â√ç√ì√ö√¢√™√Æ√¥√ª√Ç√ä√é√î√õ√†√®√¨√≤√π√Ä√à√å√í√ô√£√µ√É√ï√ß√á]+)/g,"<span class=\"mention\">@$1</span>");const s=a.reacoes||{};let l="",m=!1;const c=Object.keys(s).sort((e,a)=>(s[a]?.length||0)-(s[e]?.length||0));for(const e of c){const o=Array.isArray(s[e])?s[e]:[];if(0<o.length){m=!0;const t=o.includes(currentUser),n=t?"reacted":"",i=0<o.length?`Reagido por: ${o.join(", ")}`:`Seja o primeiro a reagir com ${e}`;l+=`<div class="reacao-display ${n}" title="${i}" data-emoji="${e}" onclick="window.abrirModalReagentes('${a.id}', '${e}')">${e} <span class="contador-display">${o.length}</span></div>`}}const u=m?`<div class="reacoes-display-container">${l}</div>`:"";let p="";(a.userId===currentUser||"lider"===userRole)&&(p=`<div class="message-options-container"><button class="options-btn" onclick="window.openOptionsMenu(event, 'message', '${a.id}')">‚ãÆ</button></div>`);const g=document.createElement("div");g.innerHTML=d;const f=g.textContent||g.innerText||"",h=100<f.length,v=h?"texto-truncado":"";r.innerHTML=`
    <div class="mensagem-texto ${v}"><span class="texto-mascarado">${d}</span></div>
    ${u}
    <div class="mensagem-info">
      <div>
        <div class="mensagem-autor">${a.nome}</div>
        <div class="mensagem-data">${n} - ${i}</div>
      </div>
      <div class="mensagem-actions">
        <div class="comment-indicator" title="Coment√°rios">
          üí¨ <span class="comment-count">${a.commentCount||0}</span>
        </div>
        ${p}
      </div>
    </div>
    <div class="reacao-seletor-bar hidden">
      ${EMOJIS_MURAL.map(e=>`<button onclick="event.stopPropagation(); window.toggleReacao('${a.id}', '${e}', event)">${e}</button>`).join("")}
    </div>
  `;const E=r.querySelector(".comment-indicator");E&&E.addEventListener("click",e=>{e.stopPropagation(),window.openCommentsModal(a.id)});let y=null,b=!1,L=!1;const I=a=>{a.target.closest("button, a, .reacao-display, .mention")||(b=!1,L=!1,y=setTimeout(()=>{b=!0;const e=r.querySelector(".reacao-seletor-bar");if(e){e.classList.remove("hidden");const a=o=>{(!r.contains(o.target)||o.target.closest(".reacao-seletor-bar button"))&&(e.classList.add("hidden"),document.removeEventListener("click",a))};setTimeout(()=>document.addEventListener("click",a),100)}},500))},C=()=>clearTimeout(y),B=o=>{clearTimeout(y),b||L||o.target.closest("button, a, .reacao-display, .comment-indicator, .mention")||openMessageViewer(a.id)},x=()=>{clearTimeout(y),L=!0};return r.addEventListener("mousedown",I),r.addEventListener("mouseup",B),r.addEventListener("mouseleave",C),r.addEventListener("touchstart",I,{passive:!0}),r.addEventListener("touchend",B),r.addEventListener("touchmove",x),r}function configurarMuralTempoReal(){const e=document.getElementById("mural-mensagens");if(e){e.innerHTML="<div class=\"carregando\">Carregando mensagens...</div>";const a=collection(db,"mural");onSnapshot(a,a=>{const o=[];return a.forEach(e=>{const a=e.data();o.push({id:e.id,...a,timestamp:a.timestamp.toDate?a.timestamp.toDate():new Date(1e3*a.timestamp.seconds)})}),o.sort((e,a)=>a.timestamp-e.timestamp),e.innerHTML="",0===o.length?void(e.innerHTML="<div class=\"sem-mensagens\">Nenhuma mensagem ainda. Seja o primeiro a escrever!</div>"):void o.forEach(a=>{e.appendChild(criarElementoMensagem(a))})})}}async function adicionarReacaoComoOraculo(e,a){console.log(`Or√°culo: Reagindo com ${a} √† mensagem ${e}`);const o=doc(db,"mural",e);try{await runTransaction(db,async e=>{const t=await e.get(o);if(!t.exists())throw"Documento n\xE3o existe!";const n=t.data();let i=n.reacoes||{};for(const a in i)if(Array.isArray(i[a])){const e=i[a].indexOf("Or\xE1culo");-1<e&&i[a].splice(e,1)}i[a]||(i[a]=[]),i[a].includes("Or\xE1culo")||i[a].push("Or\xE1culo"),e.update(o,{reacoes:i})})}catch(e){console.error(`Or√°culo: Falha ao adicionar rea√ß√£o:`,e)}}window.toggleReacao=function(e,a,o){if(o&&o.stopPropagation(),!currentUser)return;atualizarReacaoOtimista("#mural-mensagens",e,a),tocarSom("som-reacao");const t=doc(db,"mural",e),n=doc(db,"membros",currentUser);let i,r;runTransaction(db,async e=>{const o=await e.get(t);if(!o.exists())throw"Documento n\xE3o existe!";const d=o.data();i=d.userId,r=`"${d.texto.substring(0,30)}..."`;let s=d.reacoes||{},l=d.reactionFeedEvents||{},m=d.reactionNotificationIds||{};const c=`${currentUser}_${a}`;let u=null,p=0;for(const a in s)if(Array.isArray(s[a])&&s[a].includes(currentUser)){u=a;break}if(u){const a=`${currentUser}_${u}`;l[a]&&(e.delete(doc(db,"resumoSemanalFeed",l[a])),delete l[a]),m[a]&&(e.delete(doc(db,"notificacoes",m[a])),delete m[a])}if(u===a){const e=s[a].indexOf(currentUser);-1<e&&(s[a].splice(e,1),p=-1)}else{if(u){const e=s[u].indexOf(currentUser);-1<e&&s[u].splice(e,1)}else p=1;s[a]||(s[a]=[]),s[a].push(currentUser)}if(1===p&&i&&i!==currentUser){const o=collection(db,"notificacoes"),t=doc(o);e.set(t,{destinatarioId:i,remetenteNome:currentUser,tipo:"mural",conteudo:a,acao:`reagiu √† sua mensagem: ${r}`,lida:!1,timestamp:new Date}),m[c]=t.id}return e.update(t,{reacoes:s,reactionFeedEvents:l,reactionNotificationIds:m}),0!==p&&e.update(n,{moedas:increment(p*(recompensasConfig.reagirConteudo||1))}),1===p}).then(async e=>{if(e&&i&&i!==currentUser){const e=`<strong>${currentUser}</strong> reagiu com ${a} √† mensagem de <strong>${i}</strong> no Mural de Mensagens.`,o=await adicionarEventoAoFeed("geral","\uD83D\uDC4D Nova Rea\xE7\xE3o no Mural!",e,{nomeMembro:currentUser,autorMensagem:i});if(o){const e=`${currentUser}_${a}`;await updateDoc(t,{[`reactionFeedEvents.${e}`]:o})}}}).catch(e=>{console.error("Falha na transa\xE7\xE3o de rea\xE7\xE3o do mural: ",e),mostrarPopup("\u274C Ops!","Sua rea\xE7\xE3o n\xE3o p\xF4de ser salva. Por favor, recarregue a p\xE1gina.",4e3)})};async function obterRankingSemanal(e=new Date){try{const a=getSemanaAtual(e),o=formatarDataISO(a.inicio),t=formatarDataISO(a.fim),n=query(collection(db,"presencas"),where("__name__",">=",o),where("__name__","<=",t)),i=await getDocs(n),r={};todosMembros.forEach(e=>{r[e.nome]={pontos:0,tempoTotal:0}}),i.forEach(e=>{const a=e.data();for(const[o,t]of Object.entries(a))r[o]&&t&&(r[o].pontos+=1,t&&t.toDate&&(r[o].tempoTotal+=t.toDate().getTime()))});const d=Object.entries(r).map(([e,a])=>({nome:e,pontos:a.pontos,tempoTotal:a.tempoTotal})).sort((e,a)=>a.pontos===e.pontos?0===e.tempoTotal?1:0===a.tempoTotal?-1:e.tempoTotal-a.tempoTotal:a.pontos-e.pontos);return d}catch(e){return console.error("Erro ao obter o ranking semanal:",e),[]}}async function carregarTop5Semana(){try{const e=await obterRankingSemanal(getHoje()),a=0<e.length&&0<e[0].pontos;if(!a){const e=document.getElementById("ranking-top-lista");e&&(e.innerHTML="<div class=\"ranking-item\">Ainda n\xE3o h\xE1 dados esta semana</div>");const a=doc(db,"appState","rankingState"),o=await getDoc(a);return void(o.exists()&&(await deleteDoc(a)))}const o=doc(db,"appState","rankingState"),t=e.slice(0,3).map(e=>e.nome),n=t.join(",");await runTransaction(db,async e=>{const a=await e.get(o),i=a.exists()?a.data().top3:null;if(n!==i){console.log("Mudan\xE7a no Top 5 detectada. Atualizando o feed...");const a=i?i.split(",")[0]:null,r=t[0];let d=r===a?`<strong>${r}</strong> permanece na lideran√ßa do Top 5 da semana!`:`<strong>${r}</strong> assumiu a lideran√ßa do Top 5 da semana!`;const s=1<t.length?t[1]:null,l=2<t.length?t[2]:null;return s&&l?d+=` Em seguida temos <strong>${s}</strong> em 2¬∫ e <strong>${l}</strong> em 3¬∫.`:s&&(d+=` Seguido por <strong>${s}</strong> em 2¬∫ lugar.`),e.set(o,{top3:n}),{deveAdicionarFeed:!0,titulo:"\uD83D\uDD25 Disputa no Top 5!",texto:d,dados:{nomeLider:r}}}return{deveAdicionarFeed:!1}}).then(async e=>{e.deveAdicionarFeed&&(await adicionarEventoAoFeed("geral",e.titulo,e.texto,e.dados))});const i=document.getElementById("ranking-top-lista");if(!i)return;i.innerHTML="";const r=e.slice(0,5);r.forEach((e,a)=>{if(0!==e.pontos){const o=a+1;let t=1===o?"\uD83E\uDD47":2===o?"\uD83E\uDD48":3===o?"\uD83E\uDD49":"\u2B50";const n=document.createElement("div");n.className="ranking-item",n.style.setProperty("--i",a),n.innerHTML=`
        <div class="ranking-posicao">${t} ${o}¬∫</div>
        <div class="ranking-nome">${e.nome}</div>
        <div class="ranking-pontos">${e.pontos} dias</div>
      `,i.appendChild(n)}}),0===i.children.length&&(i.innerHTML="<div class=\"ranking-item\">Ainda n\xE3o h\xE1 dados esta semana</div>")}catch(e){console.error("Erro ao carregar ou transacionar o top 5:",e)}}async function carregarMembros(){const e=await getDocs(collection(db,"membros"));todosMembros=[],equipes={abelha:{membros:[],lider:null},joaninha:{membros:[],lider:null},vagalume:{membros:[],lider:null}},liderGeral=null,e.forEach(e=>{const a=e.data(),o={nome:e.id,equipe:a.equipe,papel:a.papel,folga:a.folga||"",aniversario:a.aniversario||"",senha:a.senha||"",tempPassword:a.tempPassword||!0};todosMembros.push(o),"lider"===o.papel?liderGeral=o:"lider-equipe"===o.papel&&equipes[o.equipe]&&(equipes[o.equipe].lider=o),o.equipe&&equipes[o.equipe]&&equipes[o.equipe].membros.push(o)})}function carregarInformacoesMembros(){try{const e=document.getElementById("carrossel-container"),a=document.getElementById("carrossel-indicadores");if(!e)return;e.innerHTML="",a&&(a.innerHTML="");const o=todosMembros.map(e=>({id:e.nome,...e}));totalSlides=o.length,document.getElementById("botao-pausa")&&(document.getElementById("botao-pausa").textContent="\u23F8"),o.forEach((o,t)=>{const n=o,i=document.createElement("div");i.className="card-membro",i.id=`card-membro-${o.id}`;const r=n.corCard||"#FFFFFF";i.style.backgroundColor=r,isColorDark(r)?i.classList.add("text-light"):i.classList.remove("text-light");const d=currentUser===o.id||"lider"===userRole,s=d?"":"hidden";i.innerHTML=`
        <div class="card-controls ${s}">
          <button class="card-color-chooser-btn" onclick="toggleColorPalette(event, '${o.id}')">Escolha a cor</button>
          <div id="palette-${o.id}" class="card-color-palette hidden">
          </div>
        </div>
        <h3>${o.id}</h3>
        <div class="subtitulo">coisas sobre mim</div>
        <div class="info-item">
          <div class="info-content"><strong>Eu me chamo:</strong> <span id="info-${o.id}-me chamo">${n["me chamo"]||"N\xE3o informado"}</span></div>
          <button class="edit-info-btn ${s}" onclick="editarInformacao(event, '${o.id}', 'me chamo')">‚úèÔ∏è</button>
        </div>
        <div class="info-item">
          <div class="info-content"><strong>Meu apelido √©:</strong> <span id="info-${o.id}-apelido">${n.apelido||"N\xE3o informado"}</span></div>
          <button class="edit-info-btn ${s}" onclick="editarInformacao(event, '${o.id}', 'apelido')">‚úèÔ∏è</button>
        </div>
        <div class="info-item">
          <div class="info-content"><strong>Meu filme favorito:</strong> <span id="info-${o.id}-filme">${n.filme||"N\xE3o informado"}</span></div>
          <button class="edit-info-btn ${s}" onclick="editarInformacao(event, '${o.id}', 'filme')">‚úèÔ∏è</button>
        </div>
        <div class="info-item">
          <div class="info-content"><strong>Meu maior sonho atualmente:</strong> <span id="info-${o.id}-sonho">${n.sonho||"N\xE3o informado"}</span></div>
          <button class="edit-info-btn ${s}" onclick="editarInformacao(event, '${o.id}', 'sonho')">‚úèÔ∏è</button>
        </div>
        <div class="info-item">
          <div class="info-content"><strong>Uma m√∫sica que gosto muito:</strong> <span id="info-${o.id}-musica">${n.musica||"N\xE3o informado"}</span></div>
          <button class="edit-info-btn ${s}" onclick="editarInformacao(event, '${o.id}', 'musica')">‚úèÔ∏è</button>
        </div>
        <div class="info-item">
          <div class="info-content"><strong>Uma curiosidade aleat√≥ria sobre mim:</strong> <span id="info-${o.id}-curiosidade">${n.curiosidade||"N\xE3o informado"}</span></div>
          <button class="edit-info-btn ${s}" onclick="editarInformacao(event, '${o.id}', 'curiosidade')">‚úèÔ∏è</button>
        </div>
      `;const l=isColorDark(r),m=i.querySelector(".card-color-chooser-btn");if(m&&(m.style.color=l?"white":"black",m.style.borderColor=l?"white":"black"),e.appendChild(i),d&&criarPaletaDeCoresDoCard(o.id),a){const e=document.createElement("div");e.className="carrossel-indicador",e.onclick=()=>{window.reiniciarIntervaloCarrossel&&reiniciarIntervaloCarrossel(),irParaSlide(t)},a.appendChild(e)}}),0<totalSlides&&(document.querySelector(".carrossel-indicador")?.classList.add("ativo"),irParaSlide(0),1<totalSlides&&window.iniciarCarrosselAutomatico&&iniciarCarrosselAutomatico())}catch(e){console.error("Erro ao carregar informa\xE7\xF5es dos membros:",e)}}window.editarInformacao=async function(e,a,o){e.stopPropagation();const t=document.getElementById(`info-${a}-${o}`);if(!t)return;const n=t.textContent;t.contentEditable=!0,t.classList.add("editing"),t.focus(),document.execCommand("selectAll",!1,null);const i=async()=>{t.contentEditable=!1,t.classList.remove("editing"),t.removeEventListener("blur",i),t.removeEventListener("keydown",r);const e=t.textContent.trim();if(e===n||""===e)return void(t.textContent=n);try{const t=doc(db,"membros",a);await updateDoc(t,{[o]:e}),mostrarPopup("\u2705 Sucesso",`Informa√ß√£o atualizada!`,3e3)}catch(e){console.error("Erro ao atualizar informa\xE7\xE3o:",e),mostrarPopup("\u274C Erro","Ocorreu um erro ao salvar.",4e3),t.textContent=n}},r=a=>{"Enter"===a.key?(a.preventDefault(),i()):"Escape"===a.key&&(t.textContent=n,i())};t.addEventListener("blur",i),t.addEventListener("keydown",r)},window.toggleColorPalette=function(e,a){e.stopPropagation();const o=document.getElementById(`palette-${a}`);o.classList.toggle("hidden")};function criarPaletaDeCoresDoCard(e){const a=document.getElementById(`palette-${e}`);if(a){a.innerHTML="",["#FFFFFF","#FADADD","#FFD6A5","#FDFFB6","#CAFFBF","#9BF6FF","#A0C4FF","#BDB2FF","#FFC6FF","#EAE4E9","#D4E09B","#C3E0E5","#F7D6E0","#F3E9DD","#D3E4CD","#FF1744","#F50057","#D500F9","#651FFF","#3D5AFE","#2979FF","#00B0FF","#00E5FF","#1DE9B6","#00E676","#76FF03","#C6FF00","#FFEA00","#FFC400","#FF9100","#FF3D00","#F38375","#FBC42C","#57C479","#57C5C8","#578DC8","#8A57C8","#C857B2","#4B4A49","#ACACAC","#795548","#607D8B","#000000","#E57373","#BA68C8","#7986CB","#4FC3F7","#4DB6AC","#AED581","#FFF176","#FFB74D","#A1887F","#90A4AE","#008F93","#F08080","#20B2AA","#87CEEB","#9370DB","#DA70D6"].forEach(o=>{const t=document.createElement("div");t.className="card-color-option",t.style.backgroundColor=o,t.onclick=a=>selecionarCorDoCard(a,e,o),a.appendChild(t)})}}async function selecionarCorDoCard(e,a,o){e.stopPropagation();try{const e=doc(db,"membros",a);await updateDoc(e,{corCard:o});const t=document.getElementById(`card-membro-${a}`);if(t){t.style.backgroundColor=o,isColorDark(o)?t.classList.add("text-light"):t.classList.remove("text-light");const e=isColorDark(o),a=t.querySelector(".card-color-chooser-btn");a&&(a.style.color=e?"white":"black",a.style.borderColor=e?"white":"black")}const n=document.getElementById(`palette-${a}`);n&&n.classList.add("hidden"),mostrarPopup("\uD83C\uDFA8 Sucesso","A cor do seu card foi alterada!",3e3)}catch(e){console.error("Erro ao salvar cor do card:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel salvar a cor.",4e3)}}async function marcarConcluido(e,a,o,t){const n=document.getElementById(`task-${e}-${a}-${o}`),i=n?n.dataset.memberTeam:null;if(!podeMarcarCheckbox(e,i))return mostrarPopup("Erro","Voc\xEA n\xE3o tem permiss\xE3o para marcar/desmarcar esta tarefa.",3e3),void(n&&(n.checked=!t));const r=doc(db,"membros",e),d=`focoDiario.${o}.${a}`,s=`focoDia.${o}`;try{await runTransaction(db,async e=>{const n=await e.get(r);if(!n.exists())throw new Error("Membro n\xE3o encontrado.");const l=n.data();let m=pontosSemanais[i]||0,c=l.focoDia&&l.focoDia[o]||0;const u=l.focoDiario&&l.focoDiario[o]&&l.focoDiario[o][a];if(t?!u&&(e.update(r,{[d]:!0,[s]:increment(1)}),m++):u&&(e.update(r,{[d]:!1,[s]:increment(-1)}),m--),i&&void 0!==pontosSemanais[i]){const a=doc(db,"semanas","pontosSemanais");e.update(a,{[i]:m}),pontosSemanais[i]=m}}),console.log("Atualiza\xE7\xE3o conclu\xEDda com sucesso!"),mostrarPopup("Sucesso","Tarefa atualizada!",2e3),await verificarConquista(e,t?"adicionar":"remover"),await window.atualizarResumo()}catch(e){console.error("Erro ao atualizar o documento: ",e),mostrarPopup("Erro",`Erro ao atualizar a tarefa: ${e.message||e}`,3e3),n&&(n.checked=!t)}}window.togglePausa=function(){carrosselPausado=!carrosselPausado;const e=document.getElementById("botao-pausa");if(carrosselPausado){clearInterval(carrosselInterval),e.textContent="\u25B6";const a=document.getElementById("progresso-indicador-barra");a&&(a.style.transition="none",a.dataset.width=a.style.width)}else{e.textContent="\u23F8";const a=document.getElementById("progresso-indicador-barra");a&&(a.style.transition="width 10s linear",a.style.width=a.dataset.width||"100%"),iniciarCarrosselAutomatico()}};function iniciarBarraProgresso(){const e=document.getElementById("progresso-indicador-barra");e&&(e.style.transition="none",e.style.width="0%",void e.offsetWidth,e.style.transition="width 10s linear",setTimeout(()=>{carrosselPausado||(e.style.width="100%")},10),progressoBarra&&clearTimeout(progressoBarra),progressoBarra=setTimeout(()=>{e.style.width="0%"},1e4))}window.mudarSlide=function(e){reiniciarIntervaloCarrossel();const a=document.querySelectorAll(".card-membro").length;0===a||(currentCarrosselIndex=(currentCarrosselIndex+e+a)%a,irParaSlide(currentCarrosselIndex))};function irParaSlide(e){const a=document.getElementById("carrossel-container");a.style.transform=`translateX(-${100*e}%)`;const o=document.querySelectorAll("#carrossel-indicadores .carrossel-indicador");o.forEach((a,o)=>{a.classList.toggle("ativo",o===e)}),currentCarrosselIndex=e,carrosselPausado||iniciarBarraProgresso()}function iniciarCarrosselAutomatico(){carrosselInterval&&clearInterval(carrosselInterval),carrosselInterval=setInterval(()=>{0<totalSlides&&!carrosselPausado&&(currentCarrosselIndex=(currentCarrosselIndex+1)%totalSlides,irParaSlide(currentCarrosselIndex))},1e4),iniciarBarraProgresso()}function reiniciarIntervaloCarrossel(){clearInterval(carrosselInterval),iniciarCarrosselAutomatico(),iniciarBarraProgresso()}function construirInterface(){const e=document.querySelector(".grupos-container");if(e){e.innerHTML="";const a=document.createElement("div");a.className="grupo",a.id="lider-geral",a.innerHTML=`
      <h2>L√≠der Geral</h2>
      <div class="membros-grid">
        ${liderGeral?`
          <div class="membro">
            <input type="checkbox" id="${liderGeral.nome}">
            <label for="${liderGeral.nome}">
  <span class="membro-nome ${6<=liderGeral.nome.length?"long-name":""}">${liderGeral.nome}</span>
  <span id="dias-${liderGeral.nome}" class="dias-badge">0</span>
              <span class="medalha-container">
                <span id="medalha-${liderGeral.nome}" class="medalha escondido"></span>
              </span>
            </label>
          </div>
        `:""}
      </div>
    `,e.appendChild(a);for(const[a,o]of Object.entries(equipes)){const t=document.createElement("div");t.className="grupo",t.id=`equipe-${a}`;let n="";"abelha"===a?n="\uD83D\uDC1D":"joaninha"===a?n="\uD83D\uDC1E":"vagalume"===a&&(n="\uD83D\uDCA1"),t.innerHTML=`
        <h2>${n} Equipe ${a.charAt(0).toUpperCase()+a.slice(1)}</h2>
        <div class="resumo" id="resumo-${a}">
          <div>0 focaram hoje!</div>
          <div>0 pontos na semana</div>
          <div>M√©dia: <span id="media-${a}">0.00</span></div>
        </div>
		<div class="mensagem-equipe-completa hidden" id="msg-equipe-${a}"></div>
      `;const i=document.createElement("div");if(i.className="lider-equipe",i.innerHTML=`
        <div class="titulo-lider">L√≠der da Equipe</div>
      `,o.lider){const e=document.createElement("div");e.className="membro";const a=o.lider.deFerias||!1,t=a?"em-ferias":"",n=a?"disabled":"";e.innerHTML=`
      <input type="checkbox" id="${o.lider.nome}" ${n}>
      <label for="${o.lider.nome}" class="${t}">
        <span class="membro-nome ${6<=o.lider.nome.length?"long-name":""}">${o.lider.nome}</span>
        <span id="dias-${o.lider.nome}" class="dias-badge">0</span>
        <span class="medalha-container">
          <span id="medalha-${o.lider.nome}" class="medalha escondido"></span>
        </span>
      </label>
    `,i.appendChild(e)}else{const e=document.createElement("div");e.className="sem-lider",e.textContent="Sem l\xEDder",i.appendChild(e)}t.appendChild(i);const r=document.createElement("div");r.className="membros-grid",o.membros.forEach(e=>{if(!(o.lider&&e.nome===o.lider.nome)){const a=document.createElement("div");a.className="membro";const o=e.deFerias||!1,t=o?"em-ferias":"",n=o?"disabled":"";a.innerHTML=`
      <input type="checkbox" id="${e.nome}" ${n}>
      <label for="${e.nome}" class="${t}">
        <span class="membro-nome ${6<=e.nome.length?"long-name":""}">${e.nome}</span>
        <span id="dias-${e.nome}" class="dias-badge">0</span>
        <span class="medalha-container">
          <span id="medalha-${e.nome}" class="medalha escondido"></span>
        </span>
      </label>
    `,r.appendChild(a)}}),t.appendChild(r),e.appendChild(t)}todosMembros.forEach(e=>{const a=e.nome,o=document.getElementById(a);o&&(o.onchange=()=>marcarCheckbox(a))})}}window.togglePainelSecreto=function(e){const a=document.getElementById("painel-secreto");a.style.display=e?"block":"none"};function verificarCliquesDiamante(){if(cliqueCount++,clearTimeout(timeoutClique),5===cliqueCount){const e=prompt("\uD83D\uDD10 Digite a senha para acessar o painel secreto:");"goiaba"===e?togglePainelSecreto(!0):alert("\u274C Senha incorreta!"),cliqueCount=0}else timeoutClique=setTimeout(()=>{cliqueCount=0},3e3)}let intervaloConfete=null,animacaoConfeteAniversarioId=null,geradorDeParticulasId=null,particulasAniversario=[];function carregarAniversariantes(){const e=getHoje(),a=e.getMonth()+1,o=e.getDate(),t=[];let n=null,i=1/0;todosMembros.forEach(r=>{if(r.aniversario){const[d,s]=r.aniversario.split("/").map(Number);s===a&&t.push({nome:r.nome,data:r.aniversario,hoje:d===o});let l=new Date(e.getFullYear(),s-1,d);l<e&&l.setFullYear(e.getFullYear()+1);const m=Math.ceil((l-e)/86400000);m<i&&(i=m,n={nome:r.nome,dias:m,data:r.aniversario})}}),atualizarInterfaceAniversariantes(t,n),t.some(e=>e.hoje)?iniciarConfeteAniversarioContinuo():pararConfeteAniversarioContinuo()}async function verificarAniversariantesDoDia(){try{console.log("Verificando aniversariantes do dia...");const e=getHoje(),a=e.getDate(),o=e.getMonth()+1,t=todosMembros.filter(e=>{if(!e.aniversario)return!1;const[t,n]=e.aniversario.split("/").map(Number);return t===a&&n===o});if(0<t.length){console.log(`Encontrados ${t.length} aniversariante(s) hoje!`);for(const e of t)if(await marcarPresencaAniversario(e),e.nome===currentUser){const e=sessionStorage.getItem("popupAniversarioMostradoHoje");if(!e){mostrarCardPopup(`Feliz Anivers√°rio, ${currentUser}!`,"\n              Hoje o dia \xE9 todo seu! \uD83C\uDF89<br><br>\n              Que seu novo ciclo seja repleto de realiza\xE7\xF5es, alegrias e muito foco para alcan\xE7ar seus sonhos. Agradecemos por fazer parte do nosso grupo e por compartilhar sua jornada conosco.<br><br>\n              Seu foco de hoje j\xE1 foi marcado. Aproveite muito o seu dia!\n            ",dispararConfete),sessionStorage.setItem("popupAniversarioMostradoHoje","true")}}}else console.log("Nenhum aniversariante hoje.")}catch(e){console.error("Erro ao verificar aniversariantes do dia:",e)}}function atualizarInterfaceAniversariantes(e,a){const o=document.getElementById("aniversariantes-hoje"),t=document.getElementById("proximos-aniversarios");o.innerHTML="",t.innerHTML="";const n=document.createElement("div");if(n.className="aniversariantes-container-hoje",0<e.length)e.forEach(e=>{const a=document.createElement("div");a.className="aniversariante-card",e.hoje&&a.classList.add("hoje"),a.innerHTML=`
          <div class="aniversariante-nome">${e.nome}</div>
          <div class="aniversariante-data">${e.data}</div>
        `,n.appendChild(a)});else{const e=document.createElement("div");e.className="aniversariante-card mensagem-vazia",e.textContent="Nenhum aniversariante neste m\xEAs",n.appendChild(e)}o.appendChild(n),t.innerHTML=a?`
        <div style="font-weight:bold; margin-bottom:8px; font-size:1.1rem;">Pr√≥ximo Aniversariante:</div>
        <div>Faltam <strong>${a.dias}</strong> dias para o anivers√°rio de</div>
        <div><strong>${a.nome}</strong> (${a.data})</div>
      `:"<div>Nenhum pr\xF3ximo anivers\xE1rio cadastrado</div>"}function iniciarConfetePeriodico(){pararConfetePeriodico(),intervaloConfete=setInterval(dispararConfete,5e3),dispararConfete()}function pararConfetePeriodico(){intervaloConfete&&(clearInterval(intervaloConfete),intervaloConfete=null)}function exibirQuadroFolgas(){try{const e=getHoje().toLocaleDateString("pt-BR",{weekday:"long"}),a=e.toLowerCase().replace(/-feira$/,"").normalize("NFD").replace(/[\u0300-\u036f]/g,""),o=["segunda","terca","quarta","quinta","sexta","sabado","domingo"],t={};o.forEach(e=>{const a=document.getElementById(e);a&&(a.innerHTML="",a.classList.remove("centralizado"),t[e]=a)}),document.querySelectorAll(".dia-col").forEach(e=>e.classList.remove("dia-hoje"));const n=document.getElementById(a);n&&n.closest(".dia-col")?.classList.add("dia-hoje");let i={};if(o.forEach(e=>i[e]=!1),todosMembros.forEach(e=>{const n=e.nome,r=e.folga||"",d=r.toLowerCase().replace(/-feira$/,"").normalize("NFD").replace(/[\u0300-\u036f]/g,"");if(d&&o.includes(d)&&t[d]){const e=t[d],o=document.createElement("div");o.className="membro-folga",d===a&&n===currentUser&&o.classList.add("membro-folga-hoje"),o.textContent=n,e.appendChild(o),i[d]=!0}}),t.domingo){const e=document.createElement("div");e.className="membro-folga folga-coletiva",e.textContent="Folga Coletiva",t.domingo.appendChild(e),i.domingo=!0}o.forEach(e=>{if(t[e]&&i[e]){const a=document.createElement("hr");a.className="cronograma-separator",t[e].appendChild(a)}});const r={segunda:[{texto:"In\xEDcio do Jogo Vantagem",tipo:"jogo"},{texto:"1\xBA dia da Competi\xE7\xE3o",tipo:"competicao"}],terca:[{texto:"2\xBA dia do Jogo Vantagem",tipo:"jogo"},{texto:"2\xBA dia da Competi\xE7\xE3o",tipo:"competicao"}],quarta:[{texto:"3\xBA dia do Jogo Vantagem",tipo:"jogo"},{texto:"3\xBA dia da Competi\xE7\xE3o",tipo:"competicao"}],quinta:[{texto:"4\xBA dia do Jogo Vantagem",tipo:"jogo"},{texto:"4\xBA dia da Competi\xE7\xE3o",tipo:"competicao"}],sexta:[{texto:"Fim do Jogo Vantagem",tipo:"jogo",classe:"fim-jogo"},{texto:"5\xBA dia da Competi\xE7\xE3o",tipo:"competicao"}],sabado:[{texto:"\xDAltimo dia da Competi\xE7\xE3o",tipo:"competicao",classe:"fim-competicao"}],domingo:[{texto:"Resultado da Competi\xE7\xE3o",tipo:"competicao",classe:"resultado-competicao"}]};for(const e in r)t[e]&&r[e].forEach(a=>{const o=document.createElement("div");o.className=`cronograma-item cronograma-${a.tipo} ${a.classe||""}`,o.textContent=a.texto,t[e].appendChild(o)})}catch(e){console.error("Erro ao exibir quadro de folgas/cronograma:",e)}}async function openChangeFolgaModal(){if(currentUser)try{const e=doc(db,"membros",currentUser),a=await getDoc(e);if(a.exists()){const e=a.data(),o=getSemanaAtual().numero,t=e.semanaTrocaFolga||0;if("lider"!==userRole&&t===o)return void mostrarPopup("\uD83D\uDEAB Limite Atingido","Voc\xEA j\xE1 alterou sua folga esta semana. Tente novamente na pr\xF3xima.",5e3);const n=document.getElementById("select-new-folga");n.value=e.folga||"segunda-feira",openModal("change-folga-modal")}}catch(e){console.error("Erro ao verificar permiss\xE3o de troca de folga:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel verificar seus dados de folga.",3e3)}}window.abrirModalReagentes=async function(e,a){try{const o=doc(db,"mural",e),t=await getDoc(o);if(!t.exists())return;const n=t.data().reacoes||{},i=Array.isArray(n[a])?n[a]:[],r=document.getElementById("reactors-modal-title"),d=document.getElementById("reactors-modal-list"),s=document.getElementById("remove-my-reaction-btn");r.innerHTML=`Reagiram com ${a}`,d.innerHTML="",0<i.length?i.forEach(e=>{const a=document.createElement("div");a.className="reactor-item",a.textContent=e,d.appendChild(a)}):d.innerHTML="<div class=\"reactor-item\" style=\"text-align:center; font-style:italic;\">Ningu\xE9m reagiu com este emoji ainda.</div>",currentUser&&i.includes(currentUser)?(s.style.display="block",s.onclick=async()=>{await window.toggleReacao(e,a),closeModal("reactors-modal")}):s.style.display="none",openModal("reactors-modal")}catch(e){console.error("Erro ao abrir modal de reagentes:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel carregar quem reagiu.",3e3)}};async function handleUpdateFolga(){const e=document.getElementById("select-new-folga").value;if(!currentUser)return;const a=getSemanaAtual().numero,o=doc(db,"membros",currentUser);try{await updateDoc(o,{folga:e,semanaTrocaFolga:a});const t=todosMembros.findIndex(e=>e.nome===currentUser);-1===t?console.warn("N\xE3o foi poss\xEDvel encontrar o membro atual no array local para atualizar a folga."):(todosMembros[t].folga=e,console.log(`Folga local de ${currentUser} atualizada para ${e}.`)),mostrarPopup("\u2705 Sucesso",`Sua folga foi alterada para ${e}!`,4e3),closeModal("change-folga-modal"),await exibirQuadroFolgas();const n=getDiaSemanaString();if(e===n){console.log(`A nova folga (${e}) √© hoje! Verificando se a checkbox precisa ser marcada...`);const a=document.getElementById(currentUser);if(a&&!a.checked){const e=todosMembros.find(e=>e.nome===currentUser);e&&(await marcarFolgaAutomatica(e),mostrarPopup("\uD83C\uDF34 Folga Imediata!","Como sua nova folga \xE9 hoje, j\xE1 marcamos seu foco para voc\xEA. Bom descanso!",6e3))}}}catch(e){console.error("Erro ao atualizar folga:",e),mostrarPopup("\u274C Erro","Falha ao salvar sua nova folga.",3e3)}}function atualizarRelogio(){const e=new Date,a=(e.getHours()+"").padStart(2,"0"),o=(e.getMinutes()+"").padStart(2,"0"),t=(e.getSeconds()+"").padStart(2,"0");document.getElementById("relogio").textContent=`${a}:${o}:${t}`}function tocarSom(e){try{const a=document.getElementById(e);a&&(a.currentTime=0,a.play())}catch(a){console.warn(`N√£o foi poss√≠vel tocar o som "${e}":`,a)}}async function handleLogin(){let e=loginUsernameInput.value.trim();e&&(e=e.charAt(0).toUpperCase()+e.slice(1).toLowerCase());const a=loginPasswordInput.value;if(!e||!a)return void mostrarPopup("\u274C Erro","Por favor, preencha todos os campos",3e3);try{const o=await getDoc(doc(db,"membros",e));if(o.exists()){const t=o.data();if(t.senha===a&&"on"===t.usedProv){const a=collection(db,"statusPoderes"),o=query(a,where("expiraEm",">",new Date)),n=await getDocs(o);statusPoderesAtivos=[],n.forEach(e=>{statusPoderesAtivos.push({id:e.id,...e.data()})});const i=statusPoderesAtivos.find(e=>"runa_soft_block"===e.poderId&&e.equipeAlvo===t.equipe&&"lider"!==t.papel&&"lider-equipe"!==t.papel);if(i){const e=i.expiraEm.toDate().toLocaleString("pt-BR",{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit"});return void mostrarPopup("\uD83D\uDEAB Acesso Bloqueado",`Sua equipe est√° sob o efeito da "Runa do Soft Block" at√© ${e}. Apenas o l√≠der da sua equipe pode entrar.`,8e3)}localStorage.setItem("loggedInUser",e),await performSuccessfulLogin(e)}else t.senhaProv===a&&"off"===t.usedProv?(currentUser=e,mostrarPopup("\uD83D\uDD11 Primeiro Acesso","Crie sua senha definitiva para continuar.",4e3),showChangePasswordForm()):mostrarPopup("\u274C Erro de Acesso","Nome ou senha incorreta.",3e3)}else mostrarPopup("\u274C Erro","Usu\xE1rio n\xE3o encontrado",3e3)}catch(e){console.error("Erro no login:",e),mostrarPopup("\u274C Erro","Falha no login: "+e.message,5e3)}}async function carregarDadosEssenciais(){console.log("Otimiza\xE7\xE3o: Carregando todos os dados essenciais (incluindo medalhas) de uma s\xF3 vez...");const e=await getDocs(collection(db,"membros"));todosMembros=[],equipes={abelha:{membros:[],lider:null},joaninha:{membros:[],lider:null},vagalume:{membros:[],lider:null}},liderGeral=null,streaksCache={},medalhasInventarioCache={},medalhasOrdemCache={},e.forEach(e=>{const a=e.data(),o=e.id,t={nome:o,deFerias:a.deFerias||!1,...a};todosMembros.push(t),streaksCache[t.nome]=t.streak||0,"lider"===t.papel?liderGeral=t:"lider-equipe"===t.papel&&equipes[t.equipe]&&(equipes[t.equipe].lider=t),t.equipe&&equipes[t.equipe]&&equipes[t.equipe].membros.push(t),medalhasInventarioCache[o]=a.medalhasInventario||[],medalhasOrdemCache[o]=a.medalhasOrdem||[]}),console.log(`Dados essenciais (incluindo medalhas) de ${todosMembros.length} membros carregados com apenas 1 leitura da cole√ß√£o.`)}async function verificarConquista(e,a,o,t){const n=getHojeISO(),i=doc(db,"membros",e),r=doc(db,"presencas",n),d=doc(db,"semanas","pontosSemanais");try{const{streakAtual:n}=await runTransaction(db,async n=>{const s="adicionar"===a?1:-1,l=await n.get(i);if(!l.exists())throw"Documento do membro n\xE3o encontrado.";const m=l.data().streak||0,c=m+s,u=recompensasConfig.focoDiario||100;return n.update(i,{streak:c,moedas:increment(s*u)}),"adicionar"===a?n.set(r,{[e]:new Date},{merge:!0}):n.update(r,{[e]:deleteField()}),!t&&o&&pontosSemanais.hasOwnProperty(o)&&n.update(d,{[o]:increment(s)}),{streakAtual:c}});let s=0;if(!t&&o){const e=await getDoc(d);e.exists()&&(s=e.data()[o]||0)}return{streakAtual:n,novosPontosEquipe:s}}catch(e){throw console.error("FALHA NA TRANSA\xC7\xC3O AT\xD4MICA:",e),mostrarPopup("\u274C Erro de Sincroniza\xE7\xE3o","Sua a\xE7\xE3o n\xE3o p\xF4de ser salva. Tente novamente.",5e3),e}}async function carregarStreaks(){todosMembros.forEach(e=>{streaksCache[e.nome]!==void 0&&atualizarStreakVisualMembro(e.nome,streaksCache[e.nome])}),atualizarMedalhas()}async function performSuccessfulLogin(e,a=!1){isTestModeActive=!1,dataAtual=getHojeISO(),await carregarDadosEssenciais();const o=await getDoc(doc(db,"membros",e));if(!o.exists())return localStorage.removeItem("loggedInUser"),void location.reload();const t=o.data();await verificarEAtualizarAvatar(t),currentUser=e,userRole=t.papel,userTeam=t.equipe;const n=await verificarEstadoManutencaoInicial();if(n&&"lider"!==userRole)return console.log(`Modo de manuten√ß√£o ATIVO. Bloqueando acesso para o usu√°rio: ${e}`),document.getElementById("maintenance-overlay").classList.remove("hidden"),void(document.body.style.overflow="hidden");authContainer.classList.add("hidden"),mainContent.classList.remove("hidden");const i=new Date().getHours(),r=document.body;r.classList.remove("tema-manha","tema-tarde","tema-noite"),5<=i&&12>i?r.classList.add("tema-manha"):12<=i&&18>i?r.classList.add("tema-tarde"):r.classList.add("tema-noite"),construirInterface(),await carregarDadosAvatar(),atualizarPainelPessoal(),configurarOuvintePresencaTempoReal(),await carregarPontosSemanais(),await verificarEConcederPremiacaoDiaria(),gerenciarEventosAgendadosDoOraculo(),await executarMarcacaoAutomaticaDeFolgasDoDia(),await marcarFolgaColetivaDeDomingo(),await verificarAniversariantesDoDia(),await verificarEProcessarFolgaDoDiaAtual(),await verificarPopupDeFolga(),await Promise.all([carregarRankingGeral(),carregarArvoreEpica(),loadAdvantageState(),carregarConfiguracoesRecompensas(),carregarStreaks(),carregarEExibirAvaliacoesDesenho()]),configurarOuvintesDePreviewDesenho();["abelha","joaninha","vagalume"].forEach(e=>{const a=document.getElementById(`preview-container-${e}`);a&&(a.onclick=()=>abrirModalDesenho(e))});const d=document.getElementById("carrossel-indicadores-desenho");if(d){d.innerHTML="";for(let e=0;3>e;e++){const a=document.createElement("div");a.className="carrossel-indicador",a.onclick=()=>{irParaSlideDesenho(e)},d.appendChild(a)}}if(iniciarCarrosselDesenho(),document.querySelector("#carrossel-indicadores-desenho .carrossel-indicador")?.classList.add("ativo"),irParaSlideDesenho(0),a?setTimeout(()=>{mostrarCardPopup(`üéâ Seja muito bem-vindo(a), ${e}!`,`
        <p>√â uma alegria ter voc√™ no Grupo √âpicos!</p>
        <p>Voc√™ acaba de entrar para o nosso grupo de foco. Aqui, acreditamos que o verdadeiro progresso √© constru√≠do um dia de cada vez, com determina√ß√£o e apoio m√∫tuo.</p>
        <p>Sinta-se em casa para navegar, interagir e encontrar seu pr√≥prio ritmo. Lembre-se: <strong>cada pequeno passo √© uma grande vit√≥ria em sua jornada.</strong></p>
        <p>Estamos muito felizes em ter voc√™ conosco. Vamos juntos construir uma jornada √âpica!</p>
      `,dispararConfete)},2e3):setTimeout(()=>{mostrarPopup(`‚úÖ Ol√° de novo, ${e}!`,"Muito bom ver voc\xEA de volta aqui.",4e3)},1500),await verificarELimparNaSegunda(),atualizarPlacarSemanal(),atualizarRankingGeral(),atualizarDataCabecalho(),atualizarInfoSemana(),configurarMuralTempoReal(),createColorPalette(),configurarResumoSemanalTempoReal(),await finalizarSemana(),await Promise.all([carregarTop5Semana(),exibirQuadroFolgas(),carregarInformacoesMembros(),carregarAniversariantes(),carregarCondominioEpicos()]),atualizarVisualBloqueio(),await carregarEExibirMembrosOciosos(),await carregarDadosMedalhasHonra(),setTimeout(()=>{iniciarCarrosselAutomatico(),irParaSlide(0)},1e3),setupRefreshListener(),setupVersionCheckListener(),configurarNotificacoesTempoReal(),await verificarEExibirPopupNovaMedalha(),await carregarBancosEquipes(),inicializarLojaPoderes(),await carregarStatusPoderes(),await exibirPopupResultadoCompeticao(),await atualizarResumo(),await verificarPopupEnvioDiario(),exibirPopupPoderesAtivos(),0===historicoConversaIA.length&&""!==baseDeConhecimentoTexto){const e=`Ol√°, ${currentUser}! Sou o Or√°culo dos √âpicos. Posso te ajudar em algo?`;adicionarMensagemIA(e)}await verificarPopupRecompensas(),setTimeout(async()=>{const e=document.querySelector("#pix-recebido-popup.show, #medalha-ganha-popup.show, #recompensa-recebida-popup.show, #custom-card-popup.show, #popup-envio-diario-moedas.show, #recompensa-lideres-modal.show, #recompensa-equipe-modal.show");e||(await verificarNotificacoesRestantes())},3500)}async function verificarPopupDeFolga(){if(currentUser){const e=sessionStorage.getItem("popupVesperaMostradoHoje");if(!e){const e=todosMembros.find(e=>e.nome===currentUser);if(e){const a=new Date;if(a.setDate(a.getDate()+1),e.aniversario){const[o,t]=e.aniversario.split("/").map(Number);if(a.getDate()===o&&a.getMonth()+1===t){return mostrarCardPopup("\uD83C\uDF89 Seu Anivers\xE1rio est\xE1 Chegando!","Falta pouco para o seu dia especial! Estamos muito ansiosos para comemorar o seu anivers\xE1rio amanh\xE3 com voc\xEA!!"),void sessionStorage.setItem("popupVesperaMostradoHoje","true")}}if(e.folga){const o=getDiaSemanaString(a).toLowerCase().replace(/-feira$/,"").normalize("NFD").replace(/[\u0300-\u036f]/g,""),t=e.folga.toLowerCase().replace(/-feira$/,"").normalize("NFD").replace(/[\u0300-\u036f]/g,"");if(t===o){return mostrarCardPopup("\uD83C\uDF34 Seu Descanso se Aproxima!","Lembrete amig\xE1vel: amanh\xE3 \xE9 o seu dia de folga programado. Aproveite para recarregar as energias!"),void sessionStorage.setItem("popupVesperaMostradoHoje","true")}}if(6===getHoje().getDay()){mostrarCardPopup("\uD83C\uDF89 Fim de Semana Chegou!","Aproveite o s\xE1bado! Lembre-se que amanh\xE3 \xE9 nossa folga coletiva. Um \xF3timo descanso para todos n\xF3s!"),sessionStorage.setItem("popupVesperaMostradoHoje","true")}}}}}function handleLogout(){desligarTodosOsOuvintesDeDesenho(),unsubscribeNotificacoes&&(unsubscribeNotificacoes(),unsubscribeNotificacoes=null,console.log("Ouvinte de notifica\xE7\xF5es desligado com sucesso no logout.")),closeModal("user-panel-modal"),localStorage.removeItem("loggedInUser"),sessionStorage.removeItem("avatarPermissionsChecked"),currentUser=null,userRole=null,userTeam=null,authContainer.classList.remove("hidden"),mainContent.classList.add("hidden"),loginUsernameInput.value="",loginPasswordInput.value="",showLoginForm(),mostrarPopup("\u2139\uFE0F Sess\xE3o encerrada","Voc\xEA saiu do sistema",3e3)}function showChangePasswordForm(){loginForm.classList.add("hidden"),changePasswordForm.classList.remove("hidden")}function showLoginForm(){changePasswordForm.classList.add("hidden"),forgotPasswordForm.classList.add("hidden"),secretQuestionForm.classList.add("hidden"),loginForm.classList.remove("hidden")}async function handlePasswordChange(){const e=document.getElementById("new-password").value,a=document.getElementById("confirm-new-password").value;if(!e||!a)return void mostrarPopup("\u274C Erro","Preencha todos os campos",3e3);if(e!==a)return void mostrarPopup("\u274C Erro","As novas senhas n\xE3o coincidem",3e3);if(6>e.length)return void mostrarPopup("\u274C Erro","A senha deve ter no m\xEDnimo 6 caracteres.",3e3);try{const a=doc(db,"membros",currentUser);await updateDoc(a,{senha:e}),isPasswordResetFlow?(isPasswordResetFlow=!1,mostrarPopup("\u2705 Sucesso!","Sua senha foi redefinida. Carregando o app...",4e3),await performSuccessfulLogin(currentUser,!1)):(mostrarPopup("\u2705 Senha Criada","Agora, vamos configurar sua recupera\xE7\xE3o de login.",5e3),showSecretQuestionForm())}catch(e){console.error("Erro ao alterar senha:",e),mostrarPopup("\u274C Erro","Falha ao alterar senha. Tente novamente.",3e3)}}function initAuth(){authContainer=document.getElementById("auth-container"),mainContent=document.getElementById("main-content"),logoutBtn=document.getElementById("logout-btn"),loginForm=document.getElementById("login-form"),changePasswordForm=document.getElementById("change-password-form");let e=document.getElementById("user-menu-dropdown");const a=document.getElementById("composer-textarea");a.addEventListener("paste",function(a){a.preventDefault();let e=(a.clipboardData||window.clipboardData).getData("text/plain");const o=e.replace(/\r\n|\r|\n/g,"<br>");document.execCommand("insertHTML",!1,o)}),a.addEventListener("input",handleComposerInput),a.addEventListener("keydown",handleMentionKeyDown);const o=document.getElementById("comment-textarea-modal");o.addEventListener("input",handleComposerInput),o.addEventListener("keydown",handleMentionKeyDown),loginBtn=document.getElementById("login-btn"),loginUsernameInput=document.getElementById("login-username"),loginPasswordInput=document.getElementById("login-password"),forgotPasswordForm=document.getElementById("forgot-password-form"),secretQuestionForm=document.getElementById("secret-question-form"),loginBtn&&loginBtn.addEventListener("click",handleLogin);const t=document.getElementById("toggle-password-btn");loginPasswordInput&&t&&(loginPasswordInput.addEventListener("input",()=>{t.style.display=0<loginPasswordInput.value.length?"block":"none"}),t.addEventListener("click",()=>{const e="password"===loginPasswordInput.type;loginPasswordInput.type=e?"text":"password",t.textContent=e?"Ocultar":"Ver"})),loginBtn&&loginBtn.addEventListener("click",handleLogin),logoutBtn&&logoutBtn.addEventListener("click",handleLogout),loginPasswordInput&&loginPasswordInput.addEventListener("keypress",a=>{"Enter"===a.key&&handleLogin()});const n=document.getElementById("add-item-categoria");n&&n.addEventListener("change",()=>{const e=document.getElementById("add-item-subcategoria-container");e.classList.toggle("hidden","acessorio"!==n.value)}),document.getElementById("confirm-remove-button")?.addEventListener("click",executeRemoveMember),document.getElementById("force-refresh-btn")?.addEventListener("click",requestGlobalRefresh),document.getElementById("trigger-update-btn")?.addEventListener("click",triggerForcedUpdate),document.getElementById("perform-update-btn")?.addEventListener("click",performUpdate),document.getElementById("notificacoes-btn")?.addEventListener("click",()=>{openModal("notificacoes-modal")});const i=document.getElementById("notificacoes-fechar-btn");if(i){let e=null,a=!1;const o=()=>{a=!1,e=setTimeout(()=>{a=!0,console.log("Modo Admin: Fechando modal sem limpar notifica\xE7\xF5es."),closeModal("notificacoes-modal"),mostrarPopup("\u267B\uFE0F Modo de Preserva\xE7\xE3o","Notifica\xE7\xF5es preservadas como n\xE3o lidas.",2e3)},1500)},t=()=>{clearTimeout(e)},n=o=>{a?(o.preventDefault(),o.stopImmediatePropagation(),a=!1):acaoNormalFecharNotificacoes()};i.addEventListener("touchstart",o,{passive:!0}),i.addEventListener("touchend",t),i.addEventListener("touchmove",t),i.addEventListener("mousedown",o),i.addEventListener("mouseup",t),i.addEventListener("mouseleave",t),i.addEventListener("click",n)}document.getElementById("btn-abrir-add-avatar-item")?.addEventListener("click",abrirModalAdicionarItemAvatar),document.getElementById("save-new-avatar-item-btn")?.addEventListener("click",salvarItemAvatar),document.getElementById("add-item-raro")?.addEventListener("change",a=>{const e=document.getElementById("add-item-raro-descricao-container"),o=document.getElementById("add-item-membros-permitidos-container"),t=a.target.checked;e.classList.toggle("hidden",!t),o.classList.toggle("hidden",!t),t&&popularListaMembrosPermissao()}),document.getElementById("pix-iniciar-btn")?.addEventListener("click",iniciarNovoPix),document.querySelectorAll(".pix-cancel-btn").forEach(e=>e.addEventListener("click",()=>navegarPix(0))),document.getElementById("pix-verificar-btn")?.addEventListener("click",verificarComprovantePix),document.getElementById("pix-salvar-comprovante-btn")?.addEventListener("click",salvarComprovantePix),document.getElementById("pix-nova-transferencia-btn")?.addEventListener("click",iniciarNovoPix),document.getElementById("pix-executar-btn")?.addEventListener("click",executarPix),document.getElementById("pix-step1-next")?.addEventListener("click",()=>{const e=document.querySelectorAll("#pix-lista-membros input:checked");if(0===e.length)return mostrarPopup("\uD83E\uDD14 Aten\xE7\xE3o","Selecione pelo menos um membro.",3e3);pixDestinatarios=Array.from(e).map(e=>e.value);const a=document.getElementById("pix-fonte-pagamento"),o="lider"===userRole||"lider-equipe"===userRole,t=todosMembros.find(e=>e.nome===currentUser),n=t?t.moedas||0:0;if(document.querySelector("#pix-saldo-atual span").textContent=n.toLocaleString("pt-BR"),o&&userTeam){const e=saldosBancosEquipes[userTeam]||0;document.getElementById("saldo-pessoal-pix").textContent=n.toLocaleString("pt-BR"),document.getElementById("saldo-banco-pix").textContent=e.toLocaleString("pt-BR"),document.getElementById("fonte-pessoal-pix").disabled=!1,document.getElementById("fonte-banco-pix").disabled=!1,document.getElementById("fonte-pessoal-pix").checked=!0,a.classList.remove("hidden")}else a.classList.add("hidden");popularTecladoPix(),document.getElementById("pix-valor-display").textContent="0",navegarPix(2)}),document.getElementById("pix-step2-next")?.addEventListener("click",()=>{const e=parseInt(document.getElementById("pix-valor-display").textContent,10),a=document.querySelector("input[name=\"fonte-pagamento-pix\"]:checked"),o=a&&!a.disabled?a.value:"pessoal";let t=0;if("banco"===o)t=saldosBancosEquipes[userTeam]||0;else{const e=todosMembros.find(e=>e.nome===currentUser);t=e?e.moedas||0:0}return 1>e?void mostrarPopup("\u274C Valor Inv\xE1lido","O valor m\xEDnimo para envio \xE9 de 1 moeda.",4e3):e*pixDestinatarios.length>t?void mostrarPopup("\uD83D\uDCB0 Saldo Insuficiente","Voc\xEA n\xE3o tem moedas suficientes nessa fonte de pagamento.",4e3):void(pixValor=e,navegarPix(3))}),document.getElementById("pix-step3-next")?.addEventListener("click",()=>{pixComentario=document.getElementById("pix-comentario-input").value.trim(),document.getElementById("pix-resumo-confirmacao").innerHTML=`<p><strong>Destinat√°rio(s):</strong> ${pixDestinatarios.join(", ")}</p><p><strong>Valor por pessoa:</strong> üí∞ ${pixValor}</p><p><strong>Valor Total:</strong> üí∞ ${pixValor*pixDestinatarios.length}</p><p><strong>Coment√°rio:</strong> ${pixComentario||"Nenhum"}</p>`,navegarPix(4)}),document.getElementById("pix-step4-next")?.addEventListener("click",()=>{document.getElementById("pix-senha-input").value="",navegarPix(5)}),document.getElementById("btn-abrir-envio-moedas")?.addEventListener("click",abrirModalEnvioMoedas),document.getElementById("enviar-moedas-btn")?.addEventListener("click",()=>executarEnvioMoedas("envio-moedas-modal")),document.getElementById("enviar-moedas-popup-btn")?.addEventListener("click",()=>executarEnvioMoedas("popup-envio-diario-moedas")),document.getElementById("toggle-maintenance-btn")?.addEventListener("click",toggleMaintenanceMode),document.getElementById("enviar-recompensa-equipe-btn")?.addEventListener("click",executarEnvioRecompensaEquipe),document.getElementById("enviar-recompensa-lideres-btn")?.addEventListener("click",executarEnvioRecompensaLideres),document.getElementById("limpar-feed-btn")?.addEventListener("click",limparFeedManualmente),document.getElementById("limpar-mural-btn")?.addEventListener("click",limparMuralManualmente),document.getElementById("btn-abrir-inventario")?.addEventListener("click",abrirInventario),document.getElementById("change-folga-btn")?.addEventListener("click",openChangeFolgaModal),document.getElementById("save-new-folga-btn")?.addEventListener("click",handleUpdateFolga),document.getElementById("btn-ver-lista-aniversarios")?.addEventListener("click",abrirModalListaAniversarios),document.getElementById("conta-gotas-btn")?.addEventListener("click",()=>definirModoGlobal("conta-gotas")),document.getElementById("save-new-password-btn")?.addEventListener("click",handleUpdatePassword),document.getElementById("save-new-secret-btn")?.addEventListener("click",handleUpdateSecretAnswer),window.addEventListener("click",()=>{e&&!e.classList.contains("hidden")&&e.classList.add("hidden")}),document.getElementById("pincel-btn")?.addEventListener("click",()=>definirModoGlobal("pincel")),document.getElementById("borracha-btn")?.addEventListener("click",()=>definirModoGlobal("borracha")),document.getElementById("pan-btn")?.addEventListener("click",()=>definirModoGlobal("arrastar")),document.getElementById("cor-pincel")?.addEventListener("input",a=>{corPincel=a.target.value,definirModoGlobal("pincel")}),document.getElementById("tamanho-pincel")?.addEventListener("input",a=>{tamanhoPincel=a.target.value;const e=document.getElementById("valor-pincel");e&&(e.textContent=a.target.value),atualizarCursorDinamico()}),document.getElementById("limpar-tela-btn")?.addEventListener("click",()=>{activeDrawingTeam&&confirmarLimpezaDeTela(activeDrawingTeam)});const r=document.getElementById("desenho-toolbar"),d=document.getElementById("toggle-toolbar-btn");r&&d&&!r.dataset.listener&&(d.addEventListener("click",()=>r.classList.toggle("recolhida")),r.dataset.listener="true"),document.getElementById("btn-adicionar-pontos")?.addEventListener("click",()=>handleAjusteManualPontos("adicionar")),document.getElementById("btn-remover-pontos")?.addEventListener("click",()=>handleAjusteManualPontos("remover")),document.getElementById("open-composer-btn")?.addEventListener("click",()=>openMessageComposer()),document.getElementById("confirm-delete-btn")?.addEventListener("click",confirmDelete),document.getElementById("viewer-close-btn")?.addEventListener("click",()=>closeModal("message-viewer-modal")),document.getElementById("composer-color-btn")?.addEventListener("click",a=>{a.stopPropagation();const e=document.getElementById("composer-color-palette"),o=e.classList.toggle("hidden");if(!o){const o=t=>{e.contains(t.target)||t.target===a.target||(e.classList.add("hidden"),document.removeEventListener("click",o))};setTimeout(()=>document.addEventListener("click",o),0)}}),document.getElementById("composer-close-btn")?.addEventListener("click",closeMessageComposer),document.getElementById("composer-send-btn")?.addEventListener("click",enviarMensagem),document.getElementById("confirm-delete-comment-btn")?.addEventListener("click",executarExclusaoComentario),document.getElementById("save-edit-comment-btn")?.addEventListener("click",salvarEdicaoComentario),document.getElementById("botao-painel-usuario")?.addEventListener("click",()=>openModal("user-panel-modal")),document.getElementById("generate-batch-code-btn")?.addEventListener("click",handleGenerateBatchCode),document.getElementById("add-member-btn")?.addEventListener("click",handleAddMember),document.getElementById("remove-member-btn")?.addEventListener("click",handleRemoveMember),document.getElementById("btn-abrir-gerador-codigo")?.addEventListener("click",abrirGeradorDeCodigos),document.getElementById("generate-code-btn")?.addEventListener("click",handleGenerateCode),document.getElementById("redeem-code-btn")?.addEventListener("click",handleRedeemCode),document.getElementById("save-game-order-btn")?.addEventListener("click",salvarNovaOrdemJogos),document.getElementById("btn-abrir-painel-controle")?.addEventListener("click",()=>{openControlPanel(),closeModal("user-panel-modal")}),document.getElementById("btn-logout-panel")?.addEventListener("click",handleLogout),document.getElementById("change-password-btn")?.addEventListener("click",handlePasswordChange),document.getElementById("cancel-change-password")?.addEventListener("click",showLoginForm),document.getElementById("forgot-password-link")?.addEventListener("click",showForgotPasswordForm),document.getElementById("verify-answer-btn")?.addEventListener("click",handleVerifySecretAnswer),document.getElementById("cancel-forgot-password")?.addEventListener("click",showLoginForm),document.getElementById("save-secret-answer-btn")?.addEventListener("click",handleSaveSecretAnswer),document.getElementById("btn-abrir-loja")?.addEventListener("click",abrirLoja),document.querySelector(".botao-info[onclick*=\"info-moedas-modal\"]").addEventListener("click",popularModalRecompensas),document.getElementById("btn-ver-condominio")?.addEventListener("click",abrirVisaoCondominio),document.getElementById("btn-ranking-imobiliario")?.addEventListener("click",carregarRankingImobiliario),document.getElementById("info-moedas-modal").addEventListener("click",handleRewardEditClick),document.getElementById("btn-enviar-banco")?.addEventListener("click",abrirModalEnviarMoedasBanco),document.getElementById("enviar-moedas-banco-confirmar-btn")?.addEventListener("click",executarEnvioMoedasBanco),document.getElementById("btn-extrato-banco")?.addEventListener("click",abrirModalExtratoBanco),document.getElementById("btn-stats-banco")?.addEventListener("click",abrirModalEstatisticasBanco),document.querySelectorAll(".avatar-tab-btn[data-tab-stats]").forEach(e=>{e.addEventListener("click",()=>{const a=e.dataset.tabStats;document.querySelectorAll(".avatar-tab-btn[data-tab-stats]").forEach(e=>e.classList.remove("ativo")),document.querySelectorAll("#estatisticas-banco-modal .avatar-tab-content").forEach(e=>e.classList.remove("ativo")),e.classList.add("ativo"),document.getElementById(`stats-tab-${a}`).classList.add("ativo")})});const s=document.querySelector(".avatar-tab-btn[data-tab=\"inventario\"]"),l=document.querySelector(".avatar-tab-btn[data-tab=\"loja\"]"),m=document.getElementById("avatar-tab-inventario"),c=document.getElementById("avatar-tab-loja");s&&l&&m&&c?(s.addEventListener("click",()=>{s.classList.add("ativo"),l.classList.remove("ativo"),m.classList.add("ativo"),c.classList.remove("ativo"),popularInventario()}),l.addEventListener("click",()=>{l.classList.add("ativo"),s.classList.remove("ativo"),c.classList.add("ativo"),m.classList.remove("ativo"),popularLojaAvatar()})):console.error("N\xE3o foi poss\xEDvel encontrar os elementos das abas do Avatar")}async function loginUser(){const e=loginUsernameInput.value.trim(),a=loginPasswordInput.value.trim();if(!e||!a)return void mostrarPopup("Erro","Por favor, preencha todos os campos.",3e3);try{const o=doc(db,"users",e),t=await getDoc(o);if(t.exists()){const o=t.data();if(o.password===a){currentUser=e;const a=doc(db,"membros",currentUser),o=await getDoc(a);if(o.exists()){const e=o.data();currentUserRole=e.papel||"membro",currentUserTeam=e.equipe||null}else console.warn("Documento do membro n\xE3o encontrado na cole\xE7\xE3o 'membros' para o usu\xE1rio logado:",currentUser),currentUserRole="membro",currentUserTeam=null;await carregarInformacoesMembros(),await carregarInformacoesMembros(),mostrarPopup("Sucesso",`Bem-vindo(a), ${e}!`,3e3),authContainer.classList.add("hidden"),mainContent.classList.remove("hidden"),logoutBtn.classList.remove("hidden"),atualizarPermissoesCheckboxes()}else mostrarPopup("Erro","Senha incorreta.",3e3)}else mostrarPopup("Erro","Usu\xE1rio n\xE3o encontrado.",3e3)}catch(a){console.error("Erro ao fazer login: ",a),mostrarPopup("Erro","Erro ao fazer login. Tente novamente.",3e3)}}window.copyToClipboard=function(e,a){navigator.clipboard.writeText(e).then(()=>{mostrarPopup("\u2705 Copiado",`${a} copiado para a √°rea de transfer√™ncia!`,2e3)}).catch(e=>{console.error("Erro ao copiar: ",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel copiar.",3e3)})},window.podeDesenhar=function(e){return!!currentUser&&(!("lider"!==userRole)||!(userTeam!==e))};function atualizarPermissoesCheckboxes(){const e=document.querySelectorAll(".tarefa-checkbox");e.forEach(e=>{const a=e.dataset.memberId,o=e.dataset.memberTeam;a&&o&&(e.disabled=!podeMarcarCheckbox(a,o))})}function atualizarVisualBloqueio(){currentUser&&todosMembros.forEach(e=>{const a=document.getElementById(e.nome);if(!a)return;let o=!1;("lider"===userRole||"lider-equipe"===userRole&&e.equipe===userTeam||currentUser===e.nome)&&(o=!0);const t=a.parentElement;t&&(o?(t.classList.remove("bloqueado"),t.title="Clique para marcar/desmarcar o foco"):(t.classList.add("bloqueado"),t.title="Voc\xEA n\xE3o tem permiss\xE3o para alterar este foco"))})}function showForgotPasswordForm(){loginForm.classList.add("hidden"),changePasswordForm.classList.add("hidden"),forgotPasswordForm.classList.remove("hidden")}async function handleVerifySecretAnswer(){let e=document.getElementById("forgot-username").value.trim();e&&(e=e.charAt(0).toUpperCase()+e.slice(1).toLowerCase());const a=document.getElementById("secret-answer").value.trim();if(!e||!a)return void mostrarPopup("\u274C Erro","Preencha seu nome e a resposta secreta.",3e3);try{const o=doc(db,"membros",e),t=await getDoc(o);if(t.exists()){const o=t.data();o.pet&&o.pet.toLowerCase()===a.toLowerCase()?(isPasswordResetFlow=!0,currentUser=e,mostrarPopup("\u2705 Correto","Resposta correta! Crie sua nova senha.",3e3),forgotPasswordForm.classList.add("hidden"),changePasswordForm.classList.remove("hidden")):mostrarPopup("\u274C Incorreto","A resposta para a pergunta secreta est\xE1 errada.",4e3)}else mostrarPopup("\u274C Erro","Usu\xE1rio n\xE3o encontrado.",3e3)}catch(e){console.error("Erro ao verificar resposta secreta:",e),mostrarPopup("\u274C Erro","Ocorreu um erro ao verificar os dados.",3e3)}}function showSecretQuestionForm(){loginForm.classList.add("hidden"),changePasswordForm.classList.add("hidden"),forgotPasswordForm.classList.add("hidden"),secretQuestionForm.classList.remove("hidden")}async function handleSaveSecretAnswer(){const e=document.getElementById("setup-secret-answer").value.trim();if(!e)return void mostrarPopup("\u274C Erro","Por favor, preencha a resposta.",3e3);try{const a=doc(db,"membros",currentUser);await updateDoc(a,{pet:e,usedProv:"on"}),mostrarPopup("\u2705 Tudo Pronto!",`Bem-vindo(a), ${currentUser}! Carregando o app...`,4e3),await performSuccessfulLogin(currentUser,!0)}catch(e){console.error("Erro ao salvar resposta secreta:",e),mostrarPopup("\u274C Falha Grave","Ocorreu um erro ao finalizar seu cadastro. Por favor, recarregue a p\xE1gina.",5e3)}}window.openModal=function(e){const a=document.getElementById(e);a&&(a.style.display="flex",a.classList.remove("hidden"))},window.closeModal=async function(e){const a=document.getElementById(e);a&&(a.style.display="none",a.classList.add("hidden")),hideMentionSuggestions();["pix-recebido-popup","medalha-ganha-popup","recompensa-recebida-popup","popup-envio-diario-moedas","custom-card-popup","recompensa-lideres-modal","recompensa-equipe-modal"].includes(e)&&(await new Promise(e=>setTimeout(e,100)),await verificarNotificacoesRestantes())};function showConfirmationPopup(e,a,o){document.getElementById("confirm-action-title").textContent=e,document.getElementById("confirm-action-text").innerHTML=a,document.getElementById("confirm-action-btn").onclick=()=>{closeModal("confirm-action-modal"),o()},openModal("confirm-action-modal")}async function handleUpdatePassword(){const e=document.getElementById("logged-in-new-password").value,a=document.getElementById("logged-in-confirm-password").value;if(!e||6>e.length)return void mostrarPopup("\u274C Erro","A senha deve ter no m\xEDnimo 6 caracteres.",3e3);if(e!==a)return void mostrarPopup("\u274C Erro","As senhas n\xE3o coincidem.",3e3);try{await updateDoc(doc(db,"membros",currentUser),{senha:e}),mostrarPopup("\u2705 Sucesso","Sua senha foi alterada!",3e3),closeModal("change-password-modal")}catch(e){mostrarPopup("\u274C Erro","Falha ao atualizar a senha.",3e3),console.error("Erro ao trocar senha:",e)}}async function handleUpdateSecretAnswer(){const e=document.getElementById("new-secret-answer").value.trim();if(!e)return void mostrarPopup("\u274C Erro","Por favor, digite uma resposta.",3e3);try{await updateDoc(doc(db,"membros",currentUser),{pet:e}),mostrarPopup("\u2705 Sucesso","Sua resposta secreta foi atualizada!",3e3),closeModal("change-secret-modal")}catch(e){mostrarPopup("\u274C Erro","Falha ao atualizar a resposta.",3e3),console.error("Erro ao trocar resposta secreta:",e)}}async function adicionarEventoAoFeed(e,a,o,t={}){try{const n=doc(collection(db,"resumoSemanalFeed")),i={id:n.id,tipo:e,titulo:a,texto:o,timestamp:getHoje(),reacoes:{"üëç":[],"üòÇ":[],"üò≠":[],"üíñ":[],"üò°":[]},...t};return await setDoc(n,i),n.id}catch(e){return console.error("Erro ao adicionar evento ao feed:",e),null}}async function gerarEventoDeFocoComIA(e,a,o,t){const n=a.charAt(0).toUpperCase()+a.slice(1);await adicionarEventoAoFeed("geral",`üìà Ponto para a ${n}!`,`A equipe <strong>${n}</strong> avan√ßa com +1 ponto de <strong>${e}</strong> (${o} üî• dias de foco), totalizando <strong>${t}</strong> pontos!`,{nomeMembro:e,equipe:a})}async function gerarEventoDeFocoIndividualComIA(e,a){await adicionarEventoAoFeed("geral","\uD83C\uDF1F Foco Pessoal Registrado!",`Mesmo sem uma equipe na competi√ß√£o, <strong>${e}</strong> mant√©m a disciplina, atingindo <strong>${a} üî• dias</strong> de foco. Parab√©ns pela dedica√ß√£o!`,{nomeMembro:e})}function criarElementoCardResumo(e){const a=document.createElement("div");a.className=`feed-card ${e.tipo}`,a.dataset.id=e.id;const o=e.timestamp?.toDate?e.timestamp.toDate():new Date,t=o.toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit",year:"numeric"}),n=o.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"}),i=e.reacoes||{};let r="";const d=Object.keys(i).sort((e,a)=>(i[a]?.length||0)-(i[e]?.length||0));d.forEach(a=>{const o=Array.isArray(i[a])?i[a]:[];if(0<o.length){const t=o.includes(currentUser),n=t?"reacted":"";r+=`
        <div class="reacao-display ${n}" 
             title="Reagido por: ${o.join(", ")}"
             onclick="toggleReacaoFeed(event, '${e.id}', '${a}')">
          ${a} <span class="contador-display">${o.length}</span>
        </div>`}});const s=r?`<div class="feed-card-reacoes">${r}</div>`:`<div class="feed-card-reacoes"></div>`;return a.innerHTML=`
    <div class="feed-card-header">
      <span>${e.titulo}</span>
      <span>${`${t}, ${n}`}</span>
      
      ${"lider"===userRole?`
        <button class="feed-card-delete-btn" title="Apagar evento" onclick="deletarEventoFeed(event, '${e.id}')">
          &times;
        </button>
      `:""}
      </div>
    <div class="feed-card-body">
      ${e.texto}
    </div>
    ${s}
  `,a.addEventListener("click",o=>{if(o.target.closest(".reacao-display"))return;document.querySelectorAll(".reacao-seletor-bar").forEach(e=>e.remove());const t=document.createElement("div");t.className="reacao-seletor-bar";["\uD83D\uDC4D","\uD83D\uDC96","\uD83D\uDE02","\uD83C\uDF89","\uD83D\uDD25","\uD83D\uDE2E","\uD83D\uDE2D","\uD83D\uDE21"].forEach(a=>{const o=document.createElement("button");o.textContent=a,o.onclick=o=>{o.stopPropagation(),toggleReacaoFeed(o,e.id,a),t.remove()},t.appendChild(o)}),a.querySelector(".feed-card-reacoes").appendChild(t),setTimeout(()=>{document.addEventListener("click",function e(o){a.contains(o.target)||(t.remove(),document.removeEventListener("click",e))},{once:!0})},100)}),a}function configurarResumoSemanalTempoReal(){const e=document.getElementById("feed-semanal-cards");if(e){const a=query(collection(db,"resumoSemanalFeed"),orderBy("timestamp","desc"));onSnapshot(a,a=>(e.innerHTML="",feedEventosCache=[],a.empty?void(e.innerHTML="<div class=\"sem-mensagens\">Nenhum evento importante aconteceu esta semana ainda.</div>"):void a.forEach(a=>{const o=a.data();feedEventosCache.push({titulo:o.titulo,texto:o.texto.replace(/<[^>]*>/g,""),data:o.timestamp?.toDate?o.timestamp.toDate().toLocaleDateString("pt-BR"):"Data desconhecida"});const t=criarElementoCardResumo(o);e.appendChild(t)})))}}window.toggleReacaoComentario=async function(e,a,o,t){if(e.stopPropagation(),!currentUser)return;tocarSom("som-reacao");const n=doc(db,"mural",a,"comments",o),i=doc(db,"membros",currentUser);try{await runTransaction(db,async e=>{const a=await e.get(n);if(!a.exists())throw"Coment\xE1rio n\xE3o existe!";const o=a.data(),r=o.userId;let d=o.reacoes||{},s=o.reactionNotificationIds||{};const l=`${currentUser}_${t}`;let m=null,c=0;for(const a in d)if(Array.isArray(d[a])&&d[a].includes(currentUser)){m=a;break}if(m){const a=`${currentUser}_${m}`;s[a]&&(e.delete(doc(db,"notificacoes",s[a])),delete s[a])}if(m===t){const e=d[t].indexOf(currentUser);-1<e&&(d[t].splice(e,1),c=-1)}else{if(m){const e=d[m].indexOf(currentUser);-1<e&&d[m].splice(e,1)}else c=1;d[t]||(d[t]=[]),d[t].push(currentUser)}if(1===c&&r&&r!==currentUser){const a=collection(db,"notificacoes"),n=doc(a);e.set(n,{destinatarioId:r,remetenteNome:currentUser,tipo:"comment-reaction",conteudo:t,acao:`reagiu ao seu coment√°rio: "${o.texto.substring(0,30)}..."`,lida:!1,timestamp:new Date}),s[l]=n.id}e.update(n,{reacoes:d,reactionNotificationIds:s}),0!==c&&e.update(i,{moedas:increment(c*(recompensasConfig.reagirConteudo||1))})})}catch(e){console.error("Falha na transa\xE7\xE3o de rea\xE7\xE3o do coment\xE1rio: ",e),mostrarPopup("\u274C Ops!","Sua rea\xE7\xE3o n\xE3o p\xF4de ser salva. Por favor, recarregue a p\xE1gina.",4e3)}},window.toggleReacaoFeed=async function(e,a,o){if(e.stopPropagation(),!currentUser)return;atualizarReacaoOtimista("#feed-semanal-cards",a,o);const t=doc(db,"resumoSemanalFeed",a),n=doc(db,"membros",currentUser);try{tocarSom("som-reacao"),await runTransaction(db,async e=>{const a=await e.get(t);if(!a.exists())throw"Evento n\xE3o encontrado!";const i=a.data(),r=i.nomeMembro||i.nomeLider,d=i.reacoes||{};let s=i.reactionNotificationIds||{};const l=`${currentUser}_${o}`;let m=null,c=0;for(const a in d)if(Array.isArray(d[a])&&d[a].includes(currentUser)){m=a;break}if(m){const a=`${currentUser}_${m}`;s[a]&&(e.delete(doc(db,"notificacoes",s[a])),delete s[a])}Array.isArray(d[o])||(d[o]=[]);const u=d[o].indexOf(currentUser);if(m===o)-1<u&&(d[o].splice(u,1),c=-1);else{if(m){const e=d[m].indexOf(currentUser);-1<e&&d[m].splice(e,1)}else c=1;d[o].push(currentUser)}if(1===c&&r&&r!==currentUser){const a=collection(db,"notificacoes"),t=doc(a);e.set(t,{destinatarioId:r,remetenteNome:currentUser,tipo:"feed",conteudo:o,acao:`reagiu a um evento sobre voc√™: "${i.titulo}"`,lida:!1,timestamp:new Date}),s[l]=t.id}e.update(t,{reacoes:d,reactionNotificationIds:s}),0!==c&&e.update(n,{moedas:increment(c*(recompensasConfig.reagirConteudo||1))})})}catch(e){console.error("Erro ao reagir no feed:",e),mostrarPopup("\u274C Ops!","Sua rea\xE7\xE3o n\xE3o p\xF4de ser salva. Por favor, recarregue a p\xE1gina.",4e3)}};async function gerarReacaoOraculoParaMensagemComIA(e){if(!genAI)return"\uD83D\uDC4D";try{const a=await callGenerativeAIWithRetry(`
    Voc√™ √© o Or√°culo, um mentor s√°bio e carinhoso.
    Um membro do grupo postou a seguinte mensagem no mural:
    "${e}"
    
    Qual emoji melhor representa sua rea√ß√£o a esta mensagem?
    Escolha UM emoji da seguinte lista: ['üëç', 'üíñ', 'üòÇ', 'üéâ', 'üî•', 'üòÆ']

    Sua resposta DEVE ser um JSON v√°lido no formato: {"emoji": "SEU_EMOJI_AQUI"}.
    Apenas o JSON, sem explica√ß√µes.
  `),o=a.match(/{[\s\S]*}/)[0],{emoji:t}=JSON.parse(o);return t&&EMOJIS_MURAL.includes(t)?t:"\uD83D\uDC4D"}catch(e){return console.error("Or\xE1culo (Rea\xE7\xE3o Imediata): Erro final ao escolher emoji.",e),"\uD83D\uDC4D"}}async function gerarRespostaOraculoParaMensagem(e,a,o){if(genAI){console.log(`Or√°culo: Fui mencionado na mensagem de ${o}. Preparando resposta...`);try{const t=await callGenerativeAIWithRetry(`
    Voc√™ √© o Or√°culo, o mentor s√°bio e carinhoso do Grupo √âpicos.
    Um membro, "${o}", acabou de te mencionar em uma mensagem no mural. Sua tarefa √© escrever uma resposta direta e acolhedora.

    CONTEXTO:
    - Mensagem do Membro (que te mencionou): "${a}"

    INSTRU√á√ïES:
    1.  Sua resposta deve ser curta, am√°vel e no seu estilo de mentor.
    2.  Responda diretamente √† mensagem, mencionando o autor com <strong>@${o}</strong>.
    3.  N√ÉO se revele como uma IA. Aja 100% como uma pessoa.
    4.  Assine sua resposta com "‚Äî Or√°culo".
    5.  Sua resposta deve ser apenas o texto do coment√°rio, sem formata√ß√£o JSON ou introdu√ß√µes.
  `),n=collection(db,"mural",e,"comments");await addDoc(n,{userId:"Or\xE1culo",texto:t.replace(/\n/g,"<br>"),timestamp:new Date,reacoes:EMOJIS_MURAL.reduce((e,a)=>({...e,[a]:[]}),{})}),await updateDoc(doc(db,"mural",e),{commentCount:increment(1)}),console.log("Or\xE1culo: Resposta \xE0 mensagem enviada como coment\xE1rio com sucesso.")}catch(e){console.error("Or\xE1culo: Erro ao gerar ou postar resposta de mensagem:",e)}}}async function executarInteracaoImediataOraculo(e,a,o){const t=await obterContextoDinamicoParaIA(),n=await gerarReacaoERespostaCombinadaComIA(`
    O membro "${o}" acabou de te mencionar na seguinte mensagem no mural: "${a}"
    
    --- CONTEXTO ATUAL DO GRUPO PARA SUA AN√ÅLISE ---
    ${t}
  `,`
    1.  Escolha UM emoji de rea√ß√£o da lista: ['üëç', 'üíñ', 'üòÇ', 'üéâ', 'üî•', 'üòÆ'].
    2.  Escreva uma resposta curta, am√°vel e no seu estilo de mentor, mencionando o autor com <strong>@${o}</strong>.
    3.  Analise o CONTEXTO ATUAL DO GRUPO para dar uma resposta relevante. Se a pergunta for sobre quem vai ganhar, voc√™ DEVE se posicionar e fazer uma aposta com base nos dados.
    4.  Assine sua resposta com "‚Äî Or√°culo".
    5.  N√ÉO se revele como uma IA.
  `);if(!n)return void console.error("Or\xE1culo (Mensagem): Falha ao obter dados da IA. A intera\xE7\xE3o ser\xE1 abortada.");try{await adicionarReacaoComoOraculo(e,n.emoji);const a=collection(db,"mural",e,"comments");await addDoc(a,{userId:"Or\xE1culo",texto:n.resposta.replace(/\n/g,"<br>"),timestamp:new Date,reacoes:EMOJIS_MURAL.reduce((e,a)=>({...e,[a]:[]}),{})}),await updateDoc(doc(db,"mural",e),{commentCount:increment(1)}),console.log("Or\xE1culo: Rea\xE7\xE3o e resposta \xE0 MENSAGEM enviadas com sucesso.")}catch(e){console.error("Or\xE1culo (Mensagem): Erro ao postar rea\xE7\xE3o ou coment\xE1rio.",e)}}async function limparHistoricoTopicosOraculo(){try{console.log("Limpando hist\xF3ricos de t\xF3picos do Or\xE1culo de semanas anteriores...");const e=getSemanaAtual(),a=`oraculoTopics_${e.numero}_${e.inicio.getFullYear()}`,o=query(collection(db,"appState")),t=await getDocs(o);if(t.empty)return;const n=writeBatch(db);let i=0;t.forEach(e=>{e.id.startsWith("oraculoTopics_")&&e.id!==a&&(n.delete(e.ref),i++)}),0<i&&(await n.commit(),console.log(`‚úÖ Limpeza conclu√≠da: ${i} registro(s) de hist√≥rico de t√≥picos do Or√°culo foram removidos.`))}catch(e){console.error("Erro ao limpar hist\xF3ricos de t\xF3picos do Or\xE1culo:",e)}}async function limparHistoricoNotificacoesOraculo(){try{console.log("Limpando hist\xF3ricos de notifica\xE7\xE3o do Or\xE1culo de semanas anteriores...");const e=getSemanaAtual(),a=`oraculoHistory_semana_${e.numero}_${e.inicio.getFullYear()}`,o=query(collection(db,"appState")),t=await getDocs(o);if(t.empty)return;const n=writeBatch(db);let i=0;t.forEach(e=>{e.id.startsWith("oraculoHistory_")&&e.id!==a&&(n.delete(e.ref),i++)}),0<i&&(await n.commit(),console.log(`‚úÖ Limpeza conclu√≠da: ${i} registro(s) de hist√≥rico do Or√°culo foram removidos.`))}catch(e){console.error("Erro ao limpar hist\xF3ricos de notifica\xE7\xE3o do Or\xE1culo:",e)}}async function limparFeedSemanal(){console.log("\uD83E\uDDF9 Verificando e limpando o feed da semana anterior...");const e=query(collection(db,"resumoSemanalFeed")),a=await getDocs(e);if(a.empty)return void console.log("Feed j\xE1 estava limpo.");const o=writeBatch(db);a.forEach(e=>{o.delete(e.ref)}),await o.commit(),console.log(`‚úÖ Feed limpo! ${a.size} eventos removidos.`),await adicionarEventoAoFeed("geral","\u2728 Uma Nova Semana Come\xE7ou!","O resumo da semana foi zerado. Que esta seja uma semana produtiva e cheia de foco para todos n\xF3s!")}async function limparTodoOMural(){console.log("\uD83E\uDDF9 Verificando e limpando o mural de mensagens...");const e=query(collection(db,"mural")),a=await getDocs(e);if(a.empty)return void console.log("Mural de mensagens j\xE1 estava limpo.");const o=writeBatch(db);a.forEach(e=>{o.delete(e.ref)}),await o.commit(),console.log(`‚úÖ Mural limpo! ${a.size} mensagens removidas.`)}async function limparNotificacoesAntigas(){console.log("\uD83E\uDDF9 Verificando e limpando notifica\xE7\xF5es antigas...");try{const e=new Date,a=new Date(e.setDate(e.getDate()-7)),o=query(collection(db,"notificacoes"),where("timestamp","<",a)),t=await getDocs(o);if(t.empty)return void console.log("Nenhuma notifica\xE7\xE3o antiga para limpar.");const n=writeBatch(db);t.forEach(e=>{n.delete(e.ref)}),await n.commit(),console.log(`‚úÖ Limpeza conclu√≠da! ${t.size} notifica√ß√µes antigas foram removidas.`)}catch(e){console.error("Erro ao limpar notifica\xE7\xF5es antigas:",e)}}async function limparTodosOsComentariosDoMural(){console.log("\uD83E\uDDF9 Verificando e limpando os coment\xE1rios do mural...");try{const e=collection(db,"mural"),a=await getDocs(e);if(a.empty)return void console.log("Nenhuma mensagem no mural para limpar coment\xE1rios.");const o=writeBatch(db);let t=0;for(const e of a.docs){const a=collection(db,"mural",e.id,"comments"),n=await getDocs(a);n.empty||n.forEach(e=>{o.delete(e.ref),t++})}0<t?(await o.commit(),console.log(`‚úÖ Coment√°rios limpos! ${t} coment√°rios foram removidos.`)):console.log("Nenhum coment\xE1rio encontrado para apagar.")}catch(e){console.error("Erro ao limpar os coment\xE1rios do mural:",e)}}async function limparTodasAsTelasDeDesenho(){console.log("\uD83E\uDDF9 Limpando todas as telas de desenho...");const e=["abelha","joaninha","vagalume"];try{for(const a of e){const e=query(collection(db,`desenhos_${a}`)),o=await getDocs(e);if(!o.empty){const e=writeBatch(db);o.forEach(a=>e.delete(a.ref)),await e.commit(),console.log(`- Tela da equipe ${a} limpa.`)}}console.log("\u2705 Limpeza das telas de desenho conclu\xEDda.")}catch(e){console.error("Erro ao limpar as telas de desenho:",e)}}async function limparPopupStateAntigo(){try{console.log("Limpando estados de popup de semanas anteriores...");const e=getSemanaAtual(),a=`popupState_${e.numero}_${e.inicio.getFullYear()}`,o=query(collection(db,"appState")),t=await getDocs(o);if(t.empty)return;const n=writeBatch(db);let i=0;t.forEach(e=>{e.id.startsWith("popupState_")&&e.id!==a&&(n.delete(e.ref),i++)}),0<i&&(await n.commit(),console.log(`‚úÖ Limpeza conclu√≠da: ${i} registro(s) de estado de popup antigos foram removidos.`))}catch(e){console.error("Erro ao limpar estados de popup antigos:",e)}}async function limparNotificacoesOraculoQueueAntigas(){try{console.log("Limpando filas de tarefas do Or\xE1culo de dias anteriores...");const e=getHojeISO(),a=query(collection(db,"appState")),o=await getDocs(a);if(o.empty)return;const t=writeBatch(db);let n=0;o.forEach(a=>{a.id.startsWith("dailyTasks_")&&a.id!==`dailyTasks_${e}`&&(t.delete(a.ref),n++)}),0<n&&(await t.commit(),console.log(`‚úÖ Limpeza conclu√≠da: ${n} registro(s) de tarefas antigas do Or√°culo foram removidos.`))}catch(e){console.error("Erro ao limpar tarefas antigas do Or\xE1culo:",e)}}async function limparEnviosDiariosAntigos(){console.log("\uD83E\uDDF9 Verificando envios di\xE1rios antigos...");try{const e=new Date;e.setDate(e.getDate()-7);const a=collection(db,"enviosDiarios"),o=await getDocs(a);if(o.empty)return void console.log("Nenhum registro de envio di\xE1rio encontrado para limpar.");const t=writeBatch(db);let n=0;o.forEach(a=>{const o=a.id.split("_");if(1<o.length){const i=o[o.length-1],r=new Date(i);r<e&&(t.delete(a.ref),n++)}}),0<n?(await t.commit(),console.log(`‚úÖ Limpeza conclu√≠da! ${n} registro(s) de envio di√°rio antigos foram removidos.`)):console.log("Nenhum registro de envio di\xE1rio antigo para apagar nesta verifica\xE7\xE3o.")}catch(e){console.error("Erro ao limpar a cole\xE7\xE3o 'enviosDiarios':",e)}}async function requestGlobalRefresh(){if(confirm("Tem certeza que deseja for\xE7ar a atualiza\xE7\xE3o da p\xE1gina para todos os membros?"))try{const e=doc(db,"appState","status");await setDoc(e,{lastRefreshRequest:new Date}),mostrarPopup("\uD83D\uDE80 Enviado!","Comando de atualiza\xE7\xE3o enviado para todos os membros.",3e3)}catch(e){console.error("Erro ao solicitar atualiza\xE7\xE3o global:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel enviar o comando.",4e3)}}function setupRefreshListener(){const e=doc(db,"appState","status");onSnapshot(e,e=>{if(e.exists()){const a=e.data().lastRefreshRequest?.toDate();if(a){if(null===lastRefreshTimestamp)return void(lastRefreshTimestamp=a);a>lastRefreshTimestamp&&(console.log("Recebido comando de atualiza\xE7\xE3o global. Atualizando a interface..."),lastRefreshTimestamp=a,refreshAppUI())}}})}async function triggerForcedUpdate(){if(confirm("\u26A0\uFE0F ATEN\xC7\xC3O!\n\nVoc\xEA est\xE1 prestes a for\xE7ar uma atualiza\xE7\xE3o para TODOS os membros. A tela deles ser\xE1 bloqueada at\xE9 que cliquem no bot\xE3o para atualizar.\n\nUse isso apenas ap\xF3s ter certeza de que uma nova vers\xE3o do aplicativo est\xE1 no ar.\n\nDeseja continuar?"))try{const e=doc(db,"appState","status");await setDoc(e,{requiredUpdateVersion:new Date},{merge:!0}),mostrarPopup("\uD83D\uDE80 Enviado!","Comando de atualiza\xE7\xE3o de vers\xE3o enviado.",4e3)}catch(e){console.error("Erro ao for\xE7ar atualiza\xE7\xE3o:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel enviar o comando.",4e3)}}function showUpdateOverlay(){const e=document.getElementById("update-overlay");e&&e.classList.remove("hidden")}function performUpdate(){return officialAppVersion?void(sessionStorage.removeItem("popupDiarioMostrado"),sessionStorage.removeItem("popupAnaliseOraculoVisto"),localStorage.setItem("currentAppVersion",officialAppVersion.toISOString()),location.reload(!0)):void location.reload(!0)}function setupVersionCheckListener(){const e=doc(db,"appState","status");onSnapshot(e,e=>{if(e.exists()){const a=e.data();if(a.requiredUpdateVersion){officialAppVersion=a.requiredUpdateVersion.toDate();const e=localStorage.getItem("currentAppVersion"),o=e?new Date(e):new Date(0);officialAppVersion>o&&(console.log("Nova vers\xE3o detectada. Exibindo tela de atualiza\xE7\xE3o."),showUpdateOverlay())}}})}window.deletarEventoFeed=async function(e,a){if(e.stopPropagation(),!!confirm("Tem certeza que deseja apagar este evento do feed?"))try{const e=doc(db,"resumoSemanalFeed",a);await deleteDoc(e),mostrarPopup("\u2705 Sucesso","O evento foi removido do feed.",3e3)}catch(e){console.error("Erro ao deletar evento do feed:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel remover o evento.",4e3)}};async function carregarCondominioEpicos(){if(!currentUser)return;const e=doc(db,"membros",currentUser);onSnapshot(e,e=>{if(e.exists()){const a=e.data();document.getElementById("nome-membro-condominio").textContent=currentUser,document.getElementById("saldo-moedas").textContent=a.moedas||0,document.querySelector("#indicador-moedas-pessoal span").textContent=a.moedas||0;const o=document.getElementById("lote-pessoal-container"),t=a.casaExibida;t&&a.inventarioCasas?.includes(t)?getDoc(doc(db,"loja_casas",t)).then(e=>{e.exists()&&(o.innerHTML=`<img src="${e.data().imagemURL}" alt="${e.data().nome}">`)}):o.innerHTML=`
                    <div class="placa-terreno">
                        <div class="placa-madeira">Voc√™ ainda n√£o comprou uma casa no condom√≠nio √©picos.</div>
                        <div class="haste-madeira"></div>
                    </div>
                `}});const a=getHoje(),o=a.getHours(),t=18<=o||6>o,n=document.querySelector("#condominio-container .tree-sky");if(n)if(t){n.classList.add("night-mode"),n.classList.remove("day-mode"),criarEstrelas();const e=n.querySelector(".stars-container");e&&(e.style.opacity="1")}else{n.classList.remove("night-mode"),n.classList.add("day-mode");const e=n.querySelector(".stars-container");e&&(e.style.opacity="0")}document.getElementById("sol-condominio").style.opacity=t?"0":"1",document.getElementById("lua-condominio").style.opacity=t?"1":"0"}async function abrirLoja(){const e={pequena:document.getElementById("catalogo-pequenas"),media:document.getElementById("catalogo-medias"),mansao:document.getElementById("catalogo-mansoes")};for(const a in e)e[a].innerHTML="<p>Carregando casas...</p>";openModal("loja-modal");try{const a=await getDoc(doc(db,"membros",currentUser)),o=a.data().moedas||0,t=a.data().inventarioCasas||[],n=await getDocs(collection(db,"loja_casas"));for(const a in e)e[a].innerHTML="";n.forEach(a=>{const n={id:a.id,...a.data()},i=e[n.categoria];if(!i)return;const r=t.includes(n.id),d=o>=n.preco,s=document.createElement("div");s.className="casa-card",s.innerHTML=`
        <div class="casa-card-imagem"><img src="${n.imagemURL}" alt="${n.nome}"></div>
        <div class="casa-card-info">
          <div>
            <div class="casa-card-nome">${n.nome}</div>
            <div class="casa-card-preco">üí∞ ${n.preco}</div>
          </div>
          <button class="painel-btn btn-adicionar btn-comprar" 
                  onclick="comprarCasa('${n.id}', ${n.preco})"
                  ${r||!d?"disabled":""}>
            ${r?"J\xE1 Comprada":"Comprar"}
          </button>
        </div>
      `,i.appendChild(s)})}catch(e){console.error("Erro ao abrir a loja:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel carregar a loja.",4e3)}}window.comprarCasa=async function(e,a){const o=document.getElementById("confirm-compra-texto");o.innerHTML=`Voc√™ tem certeza que deseja comprar esta casa por <strong>üí∞ ${a} moedas</strong>?`;const t=document.getElementById("confirm-compra-btn");t.onclick=()=>executarCompraCasa(e,a),openModal("confirm-compra-modal")};async function executarCompraCasa(e,a){closeModal("confirm-compra-modal");const o=doc(db,"membros",currentUser);try{await runTransaction(db,async t=>{const n=await t.get(o);if(!n.exists())throw"Membro n\xE3o encontrado.";const i=n.data(),r=i.moedas||0;if(r<a)throw"Moedas insuficientes.";const d=i.inventarioCasas||[],s=0===d.length,l={moedas:increment(-a),inventarioCasas:arrayUnion(e)};s&&(l.casaExibida=e),t.update(o,l)});const t=doc(db,"loja_casas",e),n=await getDoc(t);if(n.exists()){const e=n.data(),a=document.getElementById("lote-pessoal-container");a&&(a.innerHTML=`<img src="${e.imagemURL}" alt="${e.nome}">`)}mostrarPopup("\uD83C\uDF89 Parab\xE9ns!","Voc\xEA comprou uma nova casa!",5e3),dispararConfete(),abrirLoja()}catch(e){console.error("Erro na compra:",e),mostrarPopup("\u274C Falha na Compra",e.toString(),4e3)}}async function abrirVisaoCondominio(){const e=document.getElementById("condominio-map");e.innerHTML="<h2>Carregando condom\xEDnio...</h2>",document.getElementById("condominio-view-overlay").classList.remove("hidden");try{const[a,o]=await Promise.all([getDocs(collection(db,"membros")),getDocs(collection(db,"loja_casas"))]),t=[];a.forEach(e=>t.push({id:e.id,...e.data()}));const n={};o.forEach(e=>n[e.id]=e.data());const i=t.length,r=Math.ceil(1.2*Math.sqrt(i));e.innerHTML="",t.forEach(a=>{const o=document.createElement("div");o.className="lote-condominio",o.id=`lote-${a.id}`;const t=a.casaExibida,i=t&&n[t]?n[t]:null,r=document.createElement("div");r.className="casa-imagem-container",r.innerHTML=i?`
          <img src="${i.imagemURL}" 
               class="casa-no-lote ${i.categoria}" 
               alt="${i.nome}">
        `:`
  <div class="placa-terreno">
    <div class="placa-madeira">sem casa</div>
    <div class="haste-madeira"></div>
  </div>
`,o.appendChild(r);const d=document.createElement("div");d.className="nome-lote",d.textContent=a.id,d.id=`nome-lote-${a.id}`,d.onclick=e=>toggleNameplateColorPalette(e,a.id),a.nomeLoteCor&&(d.style.backgroundColor=a.nomeLoteCor,d.style.color=isColorDark(a.nomeLoteCor)?"#FFFFFF":"#000000"),o.appendChild(d);const s=document.createElement("div");s.id=`palette-container-${a.id}`,s.className="nameplate-palette hidden",o.appendChild(s),e.appendChild(o)});const d=document.getElementById("condominio-map-wrapper");let s=!1,l,m,c,u;const p=a=>{s=!0,d.classList.add("active");const e=a.pageX||a.touches[0].pageX,o=a.pageY||a.touches[0].pageY;l=e-d.offsetLeft,m=o-d.offsetTop,c=d.scrollLeft,u=d.scrollTop},g=()=>{s=!1},f=a=>{if(!s)return;a.preventDefault();const e=a.pageX||a.touches[0].pageX,o=a.pageY||a.touches[0].pageY,t=e-d.offsetLeft,n=o-d.offsetTop,i=2*(t-l),r=2*(n-m);d.scrollLeft=c-i,d.scrollTop=u-r};d.addEventListener("mousedown",p),d.addEventListener("mouseleave",g),d.addEventListener("mouseup",g),d.addEventListener("mousemove",f),d.addEventListener("touchstart",p,{passive:!0}),d.addEventListener("touchend",g),d.addEventListener("touchmove",f)}catch(a){console.error("Erro ao montar o condom\xEDnio:",a),e.innerHTML="<h2>Ocorreu um erro ao carregar o condom\xEDnio.</h2>"}}function formatarDataISO(e){if(!e)return"";const a=e.getFullYear(),o=(e.getMonth()+1+"").padStart(2,"0"),t=(e.getDate()+"").padStart(2,"0");return`${a}-${o}-${t}`}async function limparFeedManualmente(){if(confirm("\u26A0\uFE0F ATEN\xC7\xC3O!\n\nVoc\xEA est\xE1 prestes a apagar TODOS os eventos do feed da semana.\n\nDeseja continuar?"))try{const e=collection(db,"resumoSemanalFeed"),a=await getDocs(e);if(a.empty)return void mostrarPopup("\u2139\uFE0F Informa\xE7\xE3o","O feed da semana j\xE1 est\xE1 limpo.",3e3);const o=writeBatch(db);a.forEach(e=>{o.delete(e.ref)}),await o.commit(),mostrarPopup("\u2705 Sucesso",`Todos os ${a.size} eventos do feed foram apagados.`,5e3)}catch(e){console.error("Erro ao limpar feed manualmente:",e),mostrarPopup("\u274C Erro","Ocorreu uma falha ao tentar limpar o feed.",4e3)}}async function limparMuralManualmente(){if(confirm("\u26A0\uFE0F ATEN\xC7\xC3O!\n\nVoc\xEA est\xE1 prestes a apagar TODAS as mensagens do mural.\n\nEsta a\xE7\xE3o \xE9 permanente. Deseja continuar?"))try{const e=collection(db,"mural"),a=await getDocs(e);if(a.empty)return void mostrarPopup("\u2139\uFE0F Informa\xE7\xE3o","O mural de mensagens j\xE1 est\xE1 vazio.",3e3);const o=writeBatch(db);a.forEach(e=>{o.delete(e.ref)}),await o.commit(),mostrarPopup("\u2705 Sucesso",`Todas as ${a.size} mensagens do mural foram apagadas.`,5e3)}catch(e){console.error("Erro ao limpar mural manualmente:",e),mostrarPopup("\u274C Erro","Ocorreu uma falha ao tentar limpar o mural.",4e3)}}async function abrirInventario(){const e=document.getElementById("inventario-grid");e.innerHTML="<p>Carregando seu invent\xE1rio...</p>",openModal("inventario-modal");try{const[a,o]=await Promise.all([getDoc(doc(db,"membros",currentUser)),getDocs(collection(db,"loja_casas"))]);if(!a.exists())throw"Membro n\xE3o encontrado.";const t=a.data(),n=t.inventarioCasas||[],i=t.casaExibida,r={};if(o.forEach(e=>{r[e.id]={id:e.id,...e.data()}}),e.innerHTML="",0===n.length)return void(e.innerHTML="<p style=\"text-align: center; font-style: italic;\">Voc\xEA ainda n\xE3o comprou nenhuma casa. Visite a loja!</p>");n.forEach(a=>{const o=r[a];if(!o)return;const t=o.id===i,n=document.createElement("div");n.className="casa-card",t&&n.classList.add("selecionada"),n.innerHTML=`
        <div class="casa-card-imagem"><img src="${o.imagemURL}" alt="${o.nome}"></div>
        <div class="casa-card-info">
          <div>
            <div class="casa-card-nome">${o.nome}</div>
          </div>
          <button class="painel-btn btn-adicionar btn-definir-principal" 
                  onclick="definirCasaPrincipal('${o.id}')"
                  ${t?"disabled":""}>
            ${t?"Principal":"Exibir esta"}
          </button>
        </div>
      `,e.appendChild(n)})}catch(e){console.error("Erro ao abrir o invent\xE1rio:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel carregar seu invent\xE1rio.",4e3),closeModal("inventario-modal")}}window.definirCasaPrincipal=async function(e){const a=doc(db,"membros",currentUser);try{await updateDoc(a,{casaExibida:e}),mostrarPopup("\u2705 Sucesso!","Sua casa principal foi atualizada.",3e3),await carregarCondominioEpicos(),closeModal("inventario-modal")}catch(e){console.error("Erro ao definir casa principal:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel salvar sua escolha.",4e3)}};function toggleNameplateColorPalette(e,a){if(e.stopPropagation(),currentUser!==a&&"lider"!==userRole)return void mostrarPopup("\uD83D\uDEAB Acesso Negado","Voc\xEA s\xF3 pode alterar a cor da sua pr\xF3pria placa.",3e3);const o=document.getElementById(`palette-container-${a}`),t=o.classList.contains("hidden");document.querySelectorAll(".nameplate-palette").forEach(e=>e.classList.add("hidden")),t&&(createNameplateColorPalette(a),o.classList.remove("hidden"))}function createNameplateColorPalette(e){const a=document.getElementById(`palette-container-${e}`);if(a&&""===a.innerHTML){["#FFFFFF","#FADADD","#FFD6A5","#FDFFB6","#CAFFBF","#9BF6FF","#A0C4FF","#BDB2FF","#FFC6FF","#EAE4E9","#D4E09B","#C3E0E5","#F7D6E0","#F3E9DD","#D3E4CD","#FF1744","#F50057","#D500F9","#651FFF","#3D5AFE","#2979FF","#00B0FF","#00E5FF","#1DE9B6","#00E676","#76FF03","#C6FF00","#FFEA00","#FFC400","#FF9100","#FF3D00","#F38375","#FBC42C","#57C479","#57C5C8","#578DC8","#8A57C8","#C857B2","#4B4A49","#ACACAC","#795548","#607D8B","#000000","#E57373","#BA68C8","#7986CB","#4FC3F7","#4DB6AC","#AED581","#FFF176","#FFB74D","#A1887F","#90A4AE","#008F93","#F08080","#20B2AA","#87CEEB","#9370DB","#DA70D6"].forEach(o=>{const t=document.createElement("div");t.className="nameplate-color-option",t.style.backgroundColor=o,t.onclick=a=>selectNameplateColor(a,e,o),a.appendChild(t)})}}async function selectNameplateColor(e,a,o){e.stopPropagation();const t=document.getElementById(`nome-lote-${a}`),n=document.getElementById(`palette-container-${a}`);t.style.backgroundColor=o,t.style.color=isColorDark(o)?"#FFFFFF":"#000000",n.classList.add("hidden");try{const e=doc(db,"membros",a);await updateDoc(e,{nomeLoteCor:o}),mostrarPopup("\uD83C\uDFA8 Sucesso","A cor da sua placa foi alterada!",2e3)}catch(e){console.error("Erro ao salvar a cor da placa:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel salvar a nova cor.",3e3)}}function findMyHouse(){if(!currentUser)return;const e=document.getElementById(`lote-${currentUser}`),a=document.getElementById("condominio-map-wrapper");if(e&&a){const o=e.offsetTop,t=e.offsetLeft,n=e.clientHeight,i=e.clientWidth,r=a.clientHeight,d=a.clientWidth;a.scrollTo({top:o-r/2+n/2,left:t-d/2+i/2,behavior:"smooth"}),e.classList.add("highlight"),setTimeout(()=>{e.classList.remove("highlight")},2500)}else mostrarPopup("\uD83E\uDD14 Hmm...","N\xE3o conseguimos encontrar seu lote no mapa.",3e3)}window.findMyHouse=findMyHouse;async function limparVantagensAntigas(){try{const e=getSemanaAtual(),a=`semana_${e.numero}_${e.inicio.getFullYear()}`,o=collection(db,"vantagemSemanal"),t=await getDocs(o);if(t.empty)return void console.log("Nenhum documento de vantagem encontrado para limpar.");const n=writeBatch(db);let i=0;t.forEach(e=>{e.id!==a&&(console.log(`Marcando para apagar documento de vantagem antigo: ${e.id}`),n.delete(e.ref),i++)}),0<i?(await n.commit(),console.log(`‚úÖ Limpeza conclu√≠da: ${i} documento(s) de vantagem antigos foram removidos.`)):console.log("Nenhum documento de vantagem antigo para apagar nesta verifica\xE7\xE3o.")}catch(e){console.error("Erro ao limpar a cole\xE7\xE3o 'vantagemSemanal':",e)}}async function limparGerenciamentoSemanalAntigo(){console.log("\uD83E\uDDF9 Verificando registros de gerenciamento semanal antigos...");try{const e=new Date,a=getSemanaAtual(new Date(e.getTime()-86400000)),o=`semana_${a.numero}_${a.inicio.getFullYear()}`,t=collection(db,"gerenciamentoSemanal"),n=await getDocs(t);if(n.empty)return void console.log("Nenhum documento de gerenciamento semanal encontrado para limpar.");const i=writeBatch(db);let r=0;n.forEach(e=>{e.id!==o&&(console.log(`Marcando para apagar documento de gerenciamento antigo: ${e.id}`),i.delete(e.ref),r++)}),0<r?(await i.commit(),console.log(`‚úÖ Limpeza conclu√≠da: ${r} registro(s) de gerenciamento antigos foram removidos.`)):console.log("Nenhum registro de gerenciamento antigo para apagar nesta verifica\xE7\xE3o.")}catch(e){console.error("Erro ao limpar a cole\xE7\xE3o 'gerenciamentoSemanal':",e)}}async function limparPresencasAntigas(){try{const e=getSemanaAtual(),a=formatarDataISO(e.inicio),o=query(collection(db,"presencas"),where("__name__","<",a)),t=await getDocs(o);if(t.empty)return void console.log("Nenhum documento de presen\xE7a antigo encontrado para limpar.");const n=writeBatch(db);let i=0;t.forEach(e=>{console.log(`Marcando para apagar documento de presen√ßa antigo: ${e.id}`),n.delete(e.ref),i++}),0<i&&(await n.commit(),console.log(`‚úÖ Limpeza conclu√≠da: ${i} registro(s) de presen√ßa antigos foram removidos.`))}catch(e){console.error("Erro ao limpar a cole\xE7\xE3o 'presencas':",e)}}async function carregarRankingImobiliario(){openModal("ranking-imobiliario-modal");const e=document.getElementById("ranking-mais-casas-lista"),a=document.getElementById("ranking-maior-valor-lista");e.innerHTML="<p>Calculando...</p>",a.innerHTML="<p>Calculando...</p>";try{const[o,t]=await Promise.all([getDocs(collection(db,"membros")),getDocs(collection(db,"loja_casas"))]),n={};t.forEach(e=>{n[e.id]=e.data().preco||0});let i=[];if(o.forEach(e=>{const a=e.data(),o=a.inventarioCasas||[];if(0<o.length){const a=o.length,t=o.reduce((e,a)=>e+(n[a]||0),0);i.push({nome:e.id,quantidadeCasas:a,valorTotal:t})}}),0===i.length){return e.innerHTML="<p style=\"font-style: italic; text-align: center;\">Ningu\xE9m comprou uma casa ainda.</p>",void(a.innerHTML="<p style=\"font-style: italic; text-align: center;\">Ningu\xE9m comprou uma casa ainda.</p>")}const r=[...i].sort((e,a)=>a.quantidadeCasas-e.quantidadeCasas);e.innerHTML="",r.forEach((a,o)=>{const t=o+1;let n=`${t}¬∫`;1===t&&(n="\uD83E\uDD47"),2===t&&(n="\uD83E\uDD48"),3===t&&(n="\uD83E\uDD49");const i=document.createElement("div");i.className="ranking-imobiliario-item",i.innerHTML=`
        <span class="posicao">${n}</span>
        <span class="nome">${a.nome}</span>
        <span class="valor">üè† ${a.quantidadeCasas}</span>
      `,e.appendChild(i)});const d=[...i].sort((e,a)=>a.valorTotal-e.valorTotal);a.innerHTML="",d.forEach((e,o)=>{const t=o+1;let n=`${t}¬∫`;1===t&&(n="\uD83E\uDD47"),2===t&&(n="\uD83E\uDD48"),3===t&&(n="\uD83E\uDD49");const i=document.createElement("div");i.className="ranking-imobiliario-item",i.innerHTML=`
        <span class="posicao">${n}</span>
        <span class="nome">${e.nome}</span>
        <span class="valor">üí∞ ${e.valorTotal.toLocaleString("pt-BR")}</span>
      `,a.appendChild(i)})}catch(o){console.error("Erro ao carregar ranking imobili\xE1rio:",o),e.innerHTML="<p>Erro ao carregar.</p>",a.innerHTML="<p>Erro ao carregar.</p>"}}async function carregarConfiguracoesRecompensas(){try{const e=doc(db,"configuracoes","recompensas"),a=await getDoc(e);a.exists()?(recompensasConfig=a.data(),console.log("Configura\xE7\xF5es de recompensas carregadas:",recompensasConfig)):(console.warn("Documento de recompensas n\xE3o encontrado! Usando valores padr\xE3o."),recompensasConfig={focoDiario:100,postarMural:5,reagirConteudo:1,vitoriaJogoVantagem:50,top5Diario_1:25,top5Diario_2:20,top5Diario_3:15,top5Diario_4:10,top5Diario_5:5,top5Vantagem_1:50,top5Vantagem_2:40,top5Vantagem_3:30,top5Vantagem_4:20,top5Vantagem_5:10,vitoriaSemanal:500})}catch(e){console.error("Erro ao carregar configura\xE7\xF5es de recompensas:",e)}}function popularModalRecompensas(){for(const e in recompensasConfig){const a=document.getElementById(`reward-${e}`);a&&(a.textContent=recompensasConfig[e])}"lider"===userRole?document.querySelectorAll(".edit-reward-btn").forEach(e=>{e.classList.remove("hidden")}):document.querySelectorAll(".edit-reward-btn").forEach(e=>{e.classList.add("hidden")})}function handleRewardEditClick(e){if(e.target.classList.contains("edit-reward-btn")){const a=e.target.dataset.key;iniciarEdicaoRecompensa(a)}}function iniciarEdicaoRecompensa(e){const a=document.getElementById(`reward-${e}`);if(!a||a.isContentEditable)return;const o=a.textContent;a.contentEditable=!0,a.classList.add("editing"),a.focus(),document.execCommand("selectAll",!1,null);const t=async()=>{a.contentEditable=!1,a.classList.remove("editing"),a.removeEventListener("blur",t),a.removeEventListener("keydown",n);const i=a.textContent.trim(),r=parseInt(i,10);if(isNaN(r)||0>r)return mostrarPopup("\u274C Erro","Por favor, insira um n\xFAmero v\xE1lido.",3e3),void(a.textContent=o);if(r.toString()!==o)try{const a=doc(db,"configuracoes","recompensas");await updateDoc(a,{[e]:r}),recompensasConfig[e]=r,mostrarPopup("\u2705 Sucesso","Valor da recompensa atualizado!",3e3)}catch(e){console.error("Erro ao salvar recompensa:",e),mostrarPopup("\u274C Erro","Falha ao salvar. Tente novamente.",4e3),a.textContent=o}},n=n=>{"Enter"===n.key?(n.preventDefault(),t()):"Escape"===n.key&&(a.textContent=o,t())};a.addEventListener("blur",t),a.addEventListener("keydown",n)}async function atualizarPainelPessoal(){const e=document.getElementById("painel-pessoal-container"),a=document.getElementById("saudacao-pessoal"),o=document.getElementById("botao-painel-usuario"),t=document.getElementById("indicador-equipe-pessoal");if(!e||!currentUser)return;e.classList.remove("hidden");const n=document.getElementById("avatar-display-pessoal");if(n&&(n.innerHTML="",await renderizarAvatar(currentUser,n),n.onclick=()=>abrirEditorAvatar()),a.innerHTML=`Ol√°, <span id="nome-usuario-saudacao">${currentUser}</span>!`,o.classList.remove("hidden"),userTeam){const e=userTeam.charAt(0).toUpperCase()+userTeam.slice(1);t.textContent=`Equipe ${e}`,t.classList.remove("abelha","joaninha","vagalume","sem-equipe"),t.classList.add(userTeam),t.classList.remove("hidden")}else t.textContent=`Membro sem equipe`,t.classList.remove("abelha","joaninha","vagalume"),t.classList.add("sem-equipe"),t.classList.remove("hidden");const i=document.getElementById("btn-abrir-painel-controle"),r=document.getElementById("btn-abrir-gerador-codigo");i&&("lider"===userRole||"lider-equipe"===userRole?i.classList.remove("hidden"):i.classList.add("hidden")),r&&("lider"===userRole?r.classList.remove("hidden"):r.classList.add("hidden"));const d=document.getElementById("btn-abrir-add-avatar-item");d&&("lider"===userRole?d.classList.remove("hidden"):d.classList.add("hidden"))}function abrirGeradorDeCodigos(){closeModal("user-panel-modal"),document.getElementById("code-coin-value").value="",document.getElementById("generated-code-result").classList.add("hidden"),openModal("code-generator-modal")}function gerarCodigoAleatorio(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";let a="";for(let o=0;6>o;o++)a+=e.charAt(Math.floor(Math.random()*e.length));return a}async function handleGenerateCode(){const e=document.getElementById("code-coin-value"),a=parseInt(e.value,10),o=document.getElementById("code-restrict-leaders-single").checked;if(isNaN(a)||0>=a)return void mostrarPopup("\u274C Erro","Por favor, insira um valor de moedas v\xE1lido e positivo.",4e3);const t=gerarCodigoAleatorio(),n=doc(db,"configuracoes","codigos");try{await setDoc(n,{[t]:{valor:a,liderPodeResgatar:!o}},{merge:!0}),document.getElementById("generated-code-display").textContent=t,document.getElementById("generated-code-result").classList.remove("hidden"),mostrarPopup("\u2705 Sucesso!",`C√≥digo "${t}" gerado com sucesso!`,3e3)}catch(e){console.error("Erro ao gerar c\xF3digo:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel salvar o novo c\xF3digo no banco de dados.",5e3)}}async function gerarImagemLogin(e,a){const o=document.createElement("div");o.className="login-card-image";const t=document.body.className;t.includes("tema-manha")?o.classList.add("login-card-manha"):t.includes("tema-tarde")?o.classList.add("login-card-tarde"):t.includes("tema-noite")?o.classList.add("login-card-noite"):o.classList.add("login-card-tarde"),o.innerHTML=`
    <h3 class="login-card-titulo">√âpicos ‰∫ó üå±</h3>
    <p class="login-card-subtitulo">Seja muito bem-vindo(a)!</p>
    <div class="login-card-dados">
      <div>
        <strong>Usu√°rio:</strong>
        <span>${e}</span>
      </div>
      <div>
        <strong>Senha Provis√≥ria:</strong>
        <span>${a}</span>
      </div>
    </div>
    <p class="login-card-aviso">
      Anote seus dados. Voc√™ precisar√° criar uma senha definitiva no primeiro acesso.
    </p>
  `,document.body.appendChild(o),await html2canvas(o,{scale:2,useCORS:!0}).then(a=>{const o=a.toDataURL("image/png"),t=document.getElementById("generated-login-card-container"),n=document.getElementById("download-login-card-btn");t.innerHTML=`<img src="${o}" alt="Dados de Login">`,n.onclick=()=>{const a=document.createElement("a");a.download=`login-epicos-${e}.png`,a.href=o,a.click()}}),document.body.removeChild(o)}async function handleRedeemCode(){const e=document.getElementById("secret-code-input"),a=e.value.trim().toUpperCase();if(6!==a.length)return void mostrarPopup("\uD83E\uDD14 Aten\xE7\xE3o","O c\xF3digo precisa ter exatamente 6 caracteres.",3e3);const o=doc(db,"configuracoes","codigos"),t=doc(db,"membros",currentUser);try{const n=await runTransaction(db,async e=>{const n=await e.get(o);if(!n.exists())throw"Nenhum c\xF3digo secreto foi gerado ainda.";const i=n.data(),r=i[a];if(!r)throw"C\xF3digo inv\xE1lido ou j\xE1 utilizado.";if(!1===r.liderPodeResgatar&&"lider-equipe"===userRole)throw"L\xEDderes de equipe n\xE3o podem resgatar este c\xF3digo.";const d=r.valor,s=r.loteId;if(s){const a=await e.get(t),o=a.data().lotesResgatados||[];if(o.includes(s))throw"Voc\xEA j\xE1 utilizou um dos c\xF3digos deste lote.";e.update(t,{moedas:increment(d),lotesResgatados:arrayUnion(s)})}else e.update(t,{moedas:increment(d)});return e.update(o,{[a]:deleteField()}),d});mostrarPopup("\uD83C\uDF89 Recompensa Resgatada!",`Voc√™ ganhou <strong>${n} üí∞ moedas</strong>!`,5e3),dispararConfete(),e.value=""}catch(e){console.error("Erro ao resgatar c\xF3digo:",e),mostrarPopup("\u274C Falha no Resgate",e.toString(),4e3)}}async function handleGenerateBatchCode(){const e=document.getElementById("batch-code-quantity"),a=document.getElementById("batch-code-value"),o=document.getElementById("generated-batch-result"),t=document.getElementById("batch-codes-result-display"),n=document.getElementById("code-restrict-leaders-batch").checked,r=parseInt(e.value,10),d=parseInt(a.value,10);if(isNaN(r)||0>=r||isNaN(d)||0>=d)return void mostrarPopup("\u274C Erro","Por favor, preencha a quantidade e o valor com n\xFAmeros v\xE1lidos.",4e3);const s=`lote-${Date.now()}`,l=doc(db,"configuracoes","codigos"),m=[],c=writeBatch(db);for(let e=0;e<r;e++){const e=gerarCodigoAleatorio();m.push(e);c.set(l,{[e]:{valor:d,loteId:s,liderPodeResgatar:!n}},{merge:!0})}try{await c.commit(),t.value=m.join("\n"),o.classList.remove("hidden"),mostrarPopup("\u2705 Sucesso!",`${r} c√≥digos foram gerados no lote!`,4e3)}catch(e){console.error("Erro ao gerar lote de c\xF3digos:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel salvar o lote de c\xF3digos.",5e3)}}async function exibirPopupResultadoCompeticao(){const e=getHoje();if(0!==e.getDay())return;const a=getSemanaAtual(new Date(e.getTime()-86400000)),o=`semana_${a.numero}_${a.inicio.getFullYear()}`,t=`resultadoVisto_${o}`,n=sessionStorage.getItem(t);if(n){console.log(`Popup de resultado para a semana ${o} j√° foi exibido nesta sess√£o.`);try{const e=doc(db,"resultadosCompeticao",o),a=await getDoc(e);if(a.exists()){const e=a.data().analiseOraculo;e&&mostrarPopupAnaliseOraculo(e)}}catch(a){console.error("Erro ao tentar re-exibir an\xE1lise do Or\xE1culo:",a)}return}const i=doc(db,"resultadosCompeticao",o);try{const e=await getDoc(i);if(!e.exists())return void console.log("Documento de resultado da semana passada ainda n\xE3o foi gerado.");const a=e.data(),o=a.analiseOraculo,n=document.getElementById("resumo-competicao-ranking"),r=document.getElementById("resumo-membros-lista-container"),d=Object.entries(a.rankingEquipes).filter(([e])=>["abelha","joaninha","vagalume"].includes(e)).sort(([,e],[,a])=>e-a).map(([e,o])=>{const t=a.pontosEquipes[e]||0,n=(a.mediaEquipes?.[e]??0).toFixed(2);return`${o}¬∫ Lugar: Equipe ${e.charAt(0).toUpperCase()+e.slice(1)} (Total: ${t} pts | M√©dia Final: ${n})`}).join("<br>");n.innerHTML=d;const s=Object.entries(a.rankingEquipes).filter(([e])=>["abelha","joaninha","vagalume"].includes(e)).sort(([,e],[,a])=>e-a).map(([e])=>e);let l="";s.forEach(e=>{const o=Object.values(a.detalhesMembros).filter(a=>a.equipe===e).sort((e,a)=>a.pontuacao.total-e.pontuacao.total);if(0<o.length){l+=`<div class="resumo-equipe-bloco">`,l+=`<div class="resumo-equipe-header ${e}">${e.charAt(0).toUpperCase()+e.slice(1)}</div>`,o.forEach(e=>{const a=0<e.pontuacao.vantagem,o=a?"Sim":"N\xE3o",t=e.deFerias?"<span style=\"color: #3498db; font-style: italic; font-size: 0.9em; margin-left: 8px;\">\uD83C\uDF34 (F\xE9rias)</span>":"";l+=`
                        <div class="resumo-membro-item">
                            <span class="resumo-membro-nome">${e.nome}${t}</span>
                            <span class="resumo-membro-pontos">(Foco: ${e.pontuacao.foco} | B√¥nus: ${o})</span>
                            <span class="resumo-membro-total">${e.pontuacao.total} pts</span>
                        </div>
                    `});const t=a.adicoesPoderes?.[e];t&&Array.isArray(t)&&t.forEach(e=>{l+=`
            <div class="resumo-membro-item resumo-ajuste-item positivo">
                <span class="resumo-membro-nome">üíñ ${e.nomePoder} (usado por ${e.por})</span>
                <span class="resumo-membro-total">+${e.valor} pts</span>
            </div>
        `});const n=a.deducoesPoderes?.[e];n&&Array.isArray(n)&&n.forEach(e=>{l+=`
            <div class="resumo-membro-item resumo-ajuste-item negativo">
                <span class="resumo-membro-nome">üíÄ ${e.nomePoder} (usado por ${e.por})</span>
                <span class="resumo-membro-total">${e.valor} pts</span>
            </div>
        `});const i=a.ajustesManuais?.[e];if(i&&0!==i){const e=0<i?"positivo":"negativo",a=0<i?"Adi\xE7\xE3o de pontos pelo l\xEDder":"Remo\xE7\xE3o de pontos pelo l\xEDder";l+=`
                        <div class="resumo-membro-item resumo-ajuste-item ${e}">
                            <span class="resumo-membro-nome">${a}</span>
                            <span class="resumo-membro-total">${0<i?"+":""}${i} pts</span>
                        </div>
                    `}l+=`</div>`}}),r.innerHTML=l,openModal("resumo-competicao-modal"),sessionStorage.setItem(t,"true");const m=document.getElementById("resumo-competicao-close-btn");m&&(m.onclick=()=>{closeModal("resumo-competicao-modal"),mostrarPopupAnaliseOraculo(o)})}catch(e){console.error("Erro ao exibir popup de resultado da competi\xE7\xE3o:",e)}}async function atualizarReacaoOtimista(e,a,o){if(!currentUser)return;const t=document.querySelector(`${e} [data-id="${a}"]`);if(!t)return;let n=t.querySelector(".reacoes-display-container, .feed-card-reacoes");if(!n){const e=t.querySelector(".feed-card-reacoes");if(e)n=e;else{const e=document.createElement("div");e.className="reacoes-display-container",t.querySelector(".mensagem-info").insertAdjacentElement("beforebegin",e),n=e}}const i=n.querySelector(".reacao-display.reacted"),r=n.querySelector(`.reacao-display[data-emoji="${o}"]`);if(i&&i!==r){i.classList.remove("reacted");const e=i.querySelector(".contador-display");let a=parseInt(e.textContent,10)-1;0>=a?i.remove():e.textContent=a}if(!r){const t=document.createElement("div");t.className="reacao-display reacted",t.dataset.emoji=o,t.innerHTML=`${o} <span class="contador-display">1</span>`,t.onclick="#feed-semanal-cards"===e?t=>toggleReacaoFeed(t,a,o):()=>window.abrirModalReagentes(a,o),n.appendChild(t)}else if(r.classList.contains("reacted")){r.classList.remove("reacted");const e=r.querySelector(".contador-display");let a=parseInt(e.textContent,10)-1;0>=a?r.remove():e.textContent=a}else{r.classList.add("reacted");const e=r.querySelector(".contador-display");e.textContent=parseInt(e.textContent,10)+1}const d=!!n.querySelector(".reacao-display.reacted");!!!i&&d&&mostrarPopupMoedas(recompensasConfig.reagirConteudo||1)}async function verificarELimparNaSegunda(){const e=getHoje();if(1!==e.getDay())return;const a=getSemanaAtual(),o=`semana_${a.numero}_${a.inicio.getFullYear()}`,t=doc(db,"appState","statusLimpeza");try{const e=await getDoc(t),a=e.exists()?e.data().ultimaLimpezaRealizada:null;if(a===o)return void console.log("Limpeza de segunda-feira j\xE1 realizada para esta semana (verificado no Firestore).");console.log("Primeira vez na segunda-feira para o grupo. Executando limpeza semanal centralizada..."),await Promise.all([limparFeedSemanal(),limparTodosOsComentariosDoMural(),limparTodoOMural(),limparPresencasAntigas(),limparVantagensAntigas(),limparResultadosCompeticaoAntigos(),limparNotificacoesAntigas(),limparTodasAsTelasDeDesenho(),limparPopupStateAntigo(),limparNotificacoesOraculoQueueAntigas(),limparHistoricoNotificacoesOraculo(),limparPixTransacoesAntigas(),limparEnviosDiariosAntigos(),limparGerenciamentoSemanalAntigo(),limparHistoricoTopicosOraculo()]),await setDoc(t,{ultimaLimpezaRealizada:o}),mostrarPopup("\u2728 Nova Semana!","O mural e o resumo da semana foram reiniciados.",5e3),console.log("Limpeza semanal conclu\xEDda e registrada no Firestore para todo o grupo.")}catch(e){console.error("Erro durante a limpeza centralizada de segunda-feira:",e),mostrarPopup("\u274C Erro","Ocorreu uma falha ao reiniciar o mural e o feed.",4e3)}}async function limparResultadosCompeticaoAntigos(){try{const e=getHoje(),a=getSemanaAtual(new Date(e.getTime()-86400000)),o=`semana_${a.numero}_${a.inicio.getFullYear()}`,t=collection(db,"resultadosCompeticao"),n=await getDocs(t);if(n.empty)return void console.log("Nenhum documento de resultado de competi\xE7\xE3o encontrado para limpar.");const i=writeBatch(db);let r=0;n.forEach(e=>{e.id!==o&&(console.log(`Marcando para apagar documento de resultado antigo: ${e.id}`),i.delete(e.ref),r++)}),0<r?(await i.commit(),console.log(`‚úÖ Limpeza conclu√≠da: ${r} resultado(s) de competi√ß√£o antigos foram removidos.`)):console.log("Nenhum resultado de competi\xE7\xE3o antigo para apagar nesta verifica\xE7\xE3o.")}catch(e){console.error("Erro ao limpar a cole\xE7\xE3o 'resultadosCompeticao':",e)}}window.forcarRegeracaoQuiz=async function(){if(confirm("Tem certeza que deseja apagar e recriar o Quiz da Vantagem desta semana?"))try{const e=getSemanaAtual(),a=`semana_${e.numero}_${e.inicio.getFullYear()}`,o=doc(db,"vantagemSemanal",a);await updateDoc(o,{quizDaSemana:deleteField()}),mostrarPopup("\u2705 Sucesso","Quiz antigo apagado. Recarregando para gerar um novo...",4e3),setTimeout(async()=>{await loadAdvantageState(),mostrarPopup("\uD83C\uDFB2 Novo Quiz","Um novo quiz foi gerado com sucesso!",3e3)},1500)}catch(e){console.error("Erro ao for\xE7ar recria\xE7\xE3o do quiz:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel apagar o quiz antigo. Tente manualmente.",5e3)}};async function carregarOrdemJogos(){try{const e=doc(db,"configuracoes","ordemJogosVantagem"),a=await getDoc(e);a.exists()&&a.data().ordem?(ordemJogosConfigurada=a.data().ordem,console.log("Ordem de jogos personalizada carregada:",ordemJogosConfigurada)):(console.log("Nenhuma ordem de jogos personalizada encontrada. Usando ordem padr\xE3o."),ordemJogosConfigurada=[])}catch(e){console.error("Erro ao carregar ordem dos jogos:",e),ordemJogosConfigurada=[]}}async function salvarNovaOrdemJogos(){const e=document.getElementById("game-order-list"),a=Array.from(e.children).map(e=>e.dataset.gameName);if(0===a.length)return void mostrarPopup("\u274C Erro","A lista de jogos est\xE1 vazia.",4e3);const o=getSemanaAtual().numero;try{const e=doc(db,"configuracoes","ordemJogosVantagem");await setDoc(e,{ordem:a,semanaDeInicio:o}),ordemJogosConfigurada=a,mostrarPopup("\u2705 Sucesso!","A nova ordem dos jogos foi salva.",3e3),popularPainelOrdemJogos()}catch(e){console.error("Erro ao salvar nova ordem de jogos:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel salvar a nova ordem.",4e3)}}function popularPainelOrdemJogos(){function a(e,a){const o=[...e.querySelectorAll(".game-order-item:not(.dragging)")];return o.reduce((e,o)=>{const t=o.getBoundingClientRect(),n=a-t.top-t.height/2;return 0>n&&n>e.offset?{offset:n,element:o}:e},{offset:Number.NEGATIVE_INFINITY}).element}const o=document.getElementById("game-order-list");if(!o)return;o.innerHTML="";const t=0<ordemJogosConfigurada.length?ordemJogosConfigurada:todosOsJogos.map(e=>e.nome);t.forEach((e,a)=>{const t=document.createElement("li");t.className="game-order-item",t.draggable=!0,t.dataset.gameName=e;let n="";0===a?n="<span class=\"week-indicator\">Esta Semana</span>":1==a&&(n="<span class=\"week-indicator\">Pr\xF3xima</span>"),t.innerHTML=`
      <span class="drag-handle">‚ò∞</span>
      <span class="game-name">${e}</span>
      ${n}
    `,o.appendChild(t)});const n=o.querySelectorAll(".game-order-item");let i=null;n.forEach(e=>{e.addEventListener("dragstart",()=>{i=e,setTimeout(()=>e.classList.add("dragging"),0)}),e.addEventListener("dragend",()=>{setTimeout(()=>{i.classList.remove("dragging"),i=null},0)}),e.addEventListener("dragover",t=>{t.preventDefault();const e=a(o,t.clientY);null==e?o.appendChild(i):o.insertBefore(i,e)})})}let membroIdParaSalvarAniversario=null,novaDataAniversario=null;async function abrirModalListaAniversarios(){const e=document.getElementById("lista-completa-aniversarios-container");e.innerHTML="<div class=\"ociosos-placeholder\">Carregando lista de membros...</div>",openModal("lista-aniversarios-modal");try{const a=await getDocs(collection(db,"membros"));e.innerHTML="";const o=[];a.forEach(e=>o.push({id:e.id,...e.data()})),o.sort((e,a)=>e.id.localeCompare(a.id)),o.forEach(a=>{const o=a,t=document.createElement("div");t.className="aniversario-item";const n=currentUser===a.id&&!o.aniversarioDefinido;t.innerHTML=`
        <span class="aniversario-nome-membro">${a.id}</span>
        <div class="aniversario-data-container">
          <span id="data-aniversario-${a.id}" class="aniversario-data-membro">
            ${o.aniversario||"N\xE3o definido"}
          </span>
          <button class="edit-aniversario-btn ${n?"":"hidden"}" 
                  onclick="editarAniversario(event, '${a.id}')" 
                  title="Definir seu anivers√°rio (s√≥ pode ser feito uma vez!)">
            ‚úèÔ∏è
          </button>
        </div>
      `,e.appendChild(t)})}catch(a){console.error("Erro ao carregar lista de anivers\xE1rios:",a),e.innerHTML="<div class=\"ociosos-placeholder\">Falha ao carregar a lista.</div>"}}window.editarAniversario=function(e,a){e.stopPropagation();const o=document.getElementById(`data-aniversario-${a}`);if(!o||o.isContentEditable)return;const t=o.textContent.trim();o.textContent="",o.contentEditable=!0,o.classList.add("editing"),o.setAttribute("placeholder","DD/MM"),o.focus();const n=()=>{handleSalvarAniversario(a,o,t)},i=a=>{"Enter"===a.key?(a.preventDefault(),o.blur()):"Escape"===a.key&&(o.textContent=t,o.contentEditable=!1,o.classList.remove("editing"),o.removeAttribute("placeholder"),o.removeEventListener("blur",n),o.removeEventListener("keydown",i))};o.addEventListener("blur",n),o.addEventListener("keydown",i)};function handleSalvarAniversario(e,a,o){a.contentEditable=!1,a.classList.remove("editing"),a.removeAttribute("placeholder");const t=a.textContent.trim();if(""===t||t===o)return void(a.textContent=o);if(!/^([0-2][0-9]|(3)[0-1])(\/)(((0)[0-9])|((1)[0-2]))$/.test(t))return mostrarPopup("\u274C Formato Inv\xE1lido","Use o formato DD/MM (ex: 25/12).",4e3),void(a.textContent=o);membroIdParaSalvarAniversario=e,novaDataAniversario=t;const n=document.getElementById("confirm-aniversario-texto");n.innerHTML=`Voc√™ est√° prestes a definir seu anivers√°rio como <strong>${t}</strong>.
                                <br><br>
                                Lembre-se: <strong>esta altera√ß√£o s√≥ pode ser feita uma √∫nica vez!</strong> Tem certeza que a data est√° correta?`;const i=document.getElementById("confirm-aniversario-btn");i.onclick=executarSalvarAniversario,openModal("confirm-aniversario-modal")}async function executarSalvarAniversario(){if(!membroIdParaSalvarAniversario||!novaDataAniversario)return;const e=membroIdParaSalvarAniversario,a=novaDataAniversario,o=doc(db,"membros",e);membroIdParaSalvarAniversario=null,novaDataAniversario=null,closeModal("confirm-aniversario-modal"),mostrarPopup("\u2705 Sucesso!","Sua data de anivers\xE1rio foi salva!",4e3);const t=document.getElementById(`data-aniversario-${e}`),n=document.querySelector(`.edit-aniversario-btn[onclick*="'${e}'"]`);t&&(t.textContent=a),n&&n.classList.add("hidden");try{await updateDoc(o,{aniversario:a,aniversarioDefinido:!0}),await carregarAniversariantes(),console.log(`Anivers√°rio de ${e} salvo com sucesso no banco de dados.`)}catch(e){console.error("Erro ao salvar anivers\xE1rio em segundo plano:",e),mostrarPopup("\u274C Falha na Sincroniza\xE7\xE3o","Sua altera\xE7\xE3o n\xE3o foi salva. Por favor, recarregue e tente novamente.",5e3),t&&(t.textContent="N\xE3o definido"),n&&n.classList.remove("hidden")}}async function marcarPresencaAniversario(e){if(!e||!e.nome)return;const a=e.nome,o=e.equipe,t=getHojeISO(),n=0===getHoje().getDay();try{const e=doc(db,"membros",a),i=doc(db,"presencas",t),r=doc(db,"semanas","pontosSemanais"),d=doc(db,"appState","dailyTasks"),s=await runTransaction(db,async s=>{const l=await s.get(d),m=await s.get(i),c=`${a}_${t}`,u=l.exists()?l.data().aniversariosFeedPostados||[]:[],p=m.exists()&&m.data()[a];return u.includes(c)?(console.log(`Feed de anivers√°rio para ${a} j√° foi postado hoje. Ignorando.`),!1):(p?console.log(`Presen√ßa de ${a} j√° havia sido marcada (pela folga). Streak e pontos n√£o ser√£o incrementados novamente.`):(console.log(`Marcando presen√ßa e streak de anivers√°rio para ${a}.`),s.set(i,{[a]:new Date},{merge:!0}),s.update(e,{streak:increment(1)}),!n&&o&&s.update(r,{[o]:increment(1)})),s.set(d,{aniversariosFeedPostados:arrayUnion(c)},{merge:!0}),!0)});if(s){await adicionarEventoAoFeed("geral",`üéÇ Feliz Anivers√°rio, ${a}!`,`Hoje o foco de <strong>${a}</strong> foi marcado como um presente especial! Desejamos um dia incr√≠vel e muitas felicidades. Parab√©ns!`,{nomeMembro:a})}console.log(`Presen√ßa de anivers√°rio de ${a} processada com sucesso.`)}catch(e){console.error(`Erro ao marcar presen√ßa de anivers√°rio para ${a}:`,e)}}async function handleAjusteManualPontos(e){const a=document.getElementById("select-equipe-ajuste").value,o=document.getElementById("input-pontos-ajuste"),t=parseInt(o.value,10);if(!a)return void mostrarPopup("\u26A0\uFE0F Aten\xE7\xE3o","Por favor, selecione uma equipe.",4e3);if(isNaN(t)||0>=t)return void mostrarPopup("\u26A0\uFE0F Aten\xE7\xE3o","Por favor, insira um n\xFAmero de pontos v\xE1lido e positivo.",4e3);const n="adicionar"===e?t:-t,i="adicionar"===e?"adicionados":"removidos",r="adicionar"===e?"para a":"da",d="adicionar"===e?"\uD83D\uDCC8":"\uD83D\uDCC9",s=a.charAt(0).toUpperCase()+a.slice(1);if(confirm(`Tem certeza que deseja ${e} ${t} pontos ${r} equipe ${s}?`))try{const d=getSemanaAtual(),l=`semana_${d.numero}_${d.inicio.getFullYear()}`,m=doc(db,"semanas","pontosSemanais"),c=doc(db,"vantagemSemanal",l),u=writeBatch(db);u.update(m,{[a]:increment(n)}),u.set(c,{ajustesManuais:{[a]:increment(n)}},{merge:!0}),await u.commit(),pontosSemanais[a]+=n,atualizarPlacarSemanal(),o.value="";const p="adicionar"===e?"\uD83D\uDCC8":"\uD83D\uDCC9";await adicionarEventoAoFeed("geral",`${p} Ajuste de Pontos!`,`O L√≠der Geral ajustou a pontua√ß√£o: <strong>${t}</strong> pontos foram <strong>${i}</strong> ${r} equipe <strong>${s}</strong>.`,{equipe:a,ajuste:n}),mostrarPopup("\u2705 Sucesso!",`Pontos ${i} ${r} equipe ${s}.`,4e3)}catch(e){console.error("Erro ao ajustar pontos manualmente:",e),mostrarPopup("\u274C Erro","Ocorreu uma falha ao tentar ajustar os pontos.",5e3)}}async function criarNotificacao(e,a,o,t,n){try{const i=collection(db,"notificacoes");await addDoc(i,{destinatarioId:e,remetenteNome:a,tipo:o,conteudo:t,acao:n,lida:!1,timestamp:new Date})}catch(e){console.error("Erro ao criar notifica\xE7\xE3o:",e)}}function configurarNotificacoesTempoReal(){if(currentUser){unsubscribeNotificacoes&&(unsubscribeNotificacoes(),console.log("Ouvinte de notifica\xE7\xF5es anterior desligado."));const e=query(collection(db,"notificacoes"),where("destinatarioId","==",currentUser),orderBy("timestamp","desc"));unsubscribeNotificacoes=onSnapshot(e,async e=>{const a=document.getElementById("notificacoes-lista"),o=document.getElementById("notificacoes-contador");if(!a||!o)return void console.error("Elementos da interface de notifica\xE7\xE3o n\xE3o foram encontrados. A atualiza\xE7\xE3o da UI ser\xE1 ignorada.");for(const a of e.docChanges())if("added"===a.type){const e=a.doc.data(),o=a.doc.id;if("moedas"===e.tipo&&!1===e.popupVisto){const a=e.remetenteNome,t=e.transacaoId,n=e.agradecimentoEnviado||!1,i=e.acao||"",r=i.match(/<strong>(.*?)\s*üí∞ moedas<\/strong>/),d=r?r[1]:"um valor",s=i.match(/Coment√°rio: "(.*?)"/),l=s?s[1]:"";mostrarPopupPixRecebido(a,d,l,o,t,n);try{await updateDoc(doc(db,"notificacoes",o),{popupVisto:!0})}catch(a){console.error("Erro ao marcar popup de Pix como visto:",a)}}else if(("recompensa_lider"===e.tipo||"recompensa_membro"===e.tipo)&&!1===e.popupVisto){const a=e.remetenteNome,t=e.valor||0,n=e.agradecimentoEnviado||!1;mostrarPopupRecompensaRecebida(a,t,o,n);try{await updateDoc(doc(db,"notificacoes",o),{popupVisto:!0})}catch(a){console.error("Erro ao marcar popup de Recompensa como visto:",a)}}}let t=0;a.innerHTML="",e.empty?(a.innerHTML="<div class=\"ociosos-placeholder\">Nenhuma notifica\xE7\xE3o por aqui.</div>",o.classList.add("hidden")):e.forEach(e=>{const o=e.data();o.lida||t++;const n=criarElementoNotificacao(o);a.appendChild(n)});const n=document.getElementById("painel-pessoal-container");0<t?(o.textContent=`${t}`,o.classList.remove("hidden"),n&&n.classList.add("notificacao-neon-border")):(o.classList.add("hidden"),n&&n.classList.remove("notificacao-neon-border"))}),console.log(`Ouvinte de notifica√ß√µes ativado para: ${currentUser}`)}}function criarElementoNotificacao(e){const a=document.createElement("div");a.className="notificacao-item",e.lida||a.classList.add("nao-lida");const o=e.timestamp.toDate(),t=o.toLocaleDateString("pt-BR"),n=o.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});return a.innerHTML=`
        <div class="notificacao-conteudo">
            <strong>${e.remetenteNome}</strong> ${e.acao} 
            <span style="font-size: 1.2rem;">${e.conteudo}</span>
        </div>
        <div class="notificacao-horario">
            ${t}<br>${n}
        </div>
    `,a}async function marcarNotificacoesComoLidas(){const e=query(collection(db,"notificacoes"),where("destinatarioId","==",currentUser),where("lida","==",!1));try{const a=await getDocs(e);if(a.empty)return;const o=writeBatch(db);a.forEach(e=>{o.update(e.ref,{lida:!0})}),await o.commit(),console.log("Notifica\xE7\xF5es marcadas como lidas.")}catch(e){console.error("Erro ao marcar notifica\xE7\xF5es como lidas:",e)}}async function apagarTodasAsNotificacoes(){if(currentUser){console.log(`Iniciando exclus√£o de notifica√ß√µes para ${currentUser}...`);const e=query(collection(db,"notificacoes"),where("destinatarioId","==",currentUser));try{const a=await getDocs(e);if(a.empty)return void console.log("Nenhuma notifica\xE7\xE3o encontrada para apagar.");const o=writeBatch(db);a.forEach(e=>{o.delete(e.ref)}),await o.commit(),console.log(`${a.size} notifica√ß√µes de ${currentUser} apagadas com sucesso.`)}catch(e){console.error("Erro ao apagar notifica\xE7\xF5es:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel limpar suas notifica\xE7\xF5es.",4e3)}}}window.fecharEApagarNotificacoes=async function(){await apagarTodasAsNotificacoes(),closeModal("notificacoes-modal")};let modoAtual="pincel",corPincel="#000000",tamanhoPincel=5,isLupaDragging=!1,lupaOffsetX=0,lupaOffsetY=0;function getTransformedPoint(e,a){const o=document.getElementById("tela-desenho-fullscreen");if(!o)return{x:0,y:0};const t=o.getBoundingClientRect(),n=o.width/t.width,i=o.height/t.height;return{x:(e-t.left)*n,y:(a-t.top)*i}}function atualizarCursorDinamico(){const e=document.getElementById("tela-desenho-fullscreen");if(!e)return;let a="default";if("pincel"===modoAtual)a="crosshair";else if("borracha"===modoAtual){const e=Math.round(24+24*((parseInt(tamanhoPincel,10)-1)/49));a=`url("data:image/svg+xml,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="${e}" height="${e}" viewBox="0 0 32 32"><text x="2" y="26" font-size="24" font-weight="bold" fill="black" stroke="white" stroke-width="2" paint-order="stroke">„Äá</text></svg>`)}") 16 16, auto`}else"arrastar"===modoAtual?a="grab":"conta-gotas"===modoAtual&&(a="none");e.style.cursor=a}function definirModoGlobal(e){modoAtual=e;const a={pincel:document.getElementById("pincel-btn"),borracha:document.getElementById("borracha-btn"),contaGotas:document.getElementById("conta-gotas-btn")},o=document.getElementById("lupa-conta-gotas"),t=document.getElementById("lupa-cor-preview"),n=document.getElementById("tela-desenho-fullscreen");if(Object.values(a).forEach(e=>e?.classList.remove("ativo")),"conta-gotas"!==e)o?.classList.add("hidden"),"pincel"==e&&a.pincel?.classList.add("ativo"),"borracha"==e&&a.borracha?.classList.add("ativo");else if(a.contaGotas?.classList.add("ativo"),o&&n&&t){t.style.backgroundImage=`url(${n.toDataURL()})`,o.style.left=`${window.innerWidth/2}px`,o.style.top=`${window.innerHeight/2}px`,o.classList.remove("hidden");const e={clientX:window.innerWidth/2,clientY:window.innerHeight/2};atualizarZoomLupa(e)}atualizarCursorDinamico()}function atualizarZoomLupa(e){const a=document.getElementById("tela-desenho-fullscreen"),o=document.getElementById("lupa-conta-gotas"),t=document.getElementById("lupa-cor-preview");if(!a||!o||!t)return;const n=a.getBoundingClientRect(),i=e.touches?e.touches[0].clientX:e.clientX,r=e.touches?e.touches[0].clientY:e.clientY,d=i-n.left,s=r-n.top;t.style.backgroundSize=`${n.width*8}px ${n.height*8}px`,t.style.backgroundPosition=`-${d*8-o.offsetWidth/2}px -${s*8-o.offsetHeight/2}px`;const l=getTransformedPoint(i,r),m=a.getContext("2d"),c=m.getImageData(l.x,l.y,1,1).data,u=`#${("0"+c[0].toString(16)).slice(-2)}${("0"+c[1].toString(16)).slice(-2)}${("0"+c[2].toString(16)).slice(-2)}`;o.style.borderColor=u}function pegarCorDoCanvas(e,a){const o=document.getElementById("tela-desenho-fullscreen");if(!o)return;const t=o.getContext("2d"),n=t.getImageData(e,a,1,1).data,i=n[0],r=n[1],d=n[2],s=e=>("0"+e.toString(16)).slice(-2),l=`#${s(i)}${s(r)}${s(d)}`;corPincel=l;const m=document.getElementById("cor-pincel");m&&(m.value=l),mostrarPopup("\uD83D\uDCA7 Cor Capturada",`A cor ${l} foi selecionada!`,2e3),definirModoGlobal("pincel")}function configurarTelaDeDesenho(e){function a(){l.width=h,l.height=v,u.width=h,u.height=v;const e=m.getBoundingClientRect();s.width=e.width,s.height=e.height,r(!0)}function o(){return"borracha"===modoAtual?"#FFFFFF":corPincel}function t(a){podeDesenhar(e)&&"conta-gotas"!==modoAtual&&(E=!0,L=a,y={pontos:[a],cor:o(),tamanho:tamanhoPincel})}function n(a){E&&podeDesenhar(e)&&"conta-gotas"!==modoAtual&&(y.pontos.push(a),f.beginPath(),f.moveTo(L.x,L.y),f.lineTo(a.x,a.y),f.strokeStyle=o(),f.lineWidth=tamanhoPincel,f.lineCap="round",f.lineJoin="round",f.stroke(),L=a)}function i(){E&&(E=!1,L=null,1<y.pontos.length&&(b.push(y),d(y.pontos,y.cor,y.tamanho)),y=[],r(!0))}function r(a=!1){if(a){p.clearRect(0,0,u.width,u.height),g.clearRect(0,0,s.width,s.height);const e=s.width/h;b.forEach(a=>{if(a&&a.pontos&&!(2>a.pontos.length)){[p,g].forEach(o=>{o.beginPath(),o.strokeStyle=a.cor,o.lineWidth=o===g?a.tamanho*e:a.tamanho,o.lineCap="round",o.lineJoin="round";const t=o===g?e:1;o.moveTo(a.pontos[0].x*t,a.pontos[0].y*t);for(let e=1;e<a.pontos.length;e++)o.lineTo(a.pontos[e].x*t,a.pontos[e].y*t);o.stroke()})}})}activeDrawingTeam===e&&(f.clearRect(0,0,l.width,l.height),f.drawImage(u,0,0))}async function d(a,o,t){try{await limparHistoricoRefazer(e),await addDoc(C,{pontos:a,cor:o,tamanho:t,timestamp:new Date,desenhadoPor:currentUser})}catch(e){console.error("Erro ao salvar:",e)}}const s=document.getElementById(`preview-canvas-${e}`),l=document.getElementById("tela-desenho-fullscreen"),m=document.getElementById(`preview-container-${e}`),c=document.getElementById("lupa-conta-gotas");if(!s||!l||!c)return console.error(`Elementos essenciais para o desenho da equipe ${e} n√£o encontrados.`),{};const u=document.createElement("canvas"),p=u.getContext("2d"),g=s.getContext("2d"),f=l.getContext("2d"),h=800,v=600;let E=!1,y=[],b=[],L=null,I=null;const C=collection(db,`desenhos_${e}`);I=onSnapshot(query(C,orderBy("timestamp")),e=>{b=[],e.forEach(e=>b.push(e.data())),r(!0)});const B=a=>{"pincel"!==modoAtual&&"borracha"!==modoAtual||t(getTransformedPoint(a.clientX,a.clientY))},x=a=>{E&&n(getTransformedPoint(a.clientX,a.clientY))},A=()=>i(),q=a=>{"pincel"!==modoAtual&&"borracha"!==modoAtual||1<a.touches.length||t(getTransformedPoint(a.touches[0].clientX,a.touches[0].clientY))},S=a=>{!E||1<a.touches.length||n(getTransformedPoint(a.touches[0].clientX,a.touches[0].clientY))},F=()=>i(),k=a=>{"conta-gotas"===modoAtual&&podeDesenhar(activeDrawingTeam)&&(a.preventDefault(),isLupaDragging=!0,c.style.cursor="grabbing")},T=a=>{if(!isLupaDragging||a.touches&&1<a.touches.length)return;a.preventDefault();const e=a.touches?a.touches[0].clientX:a.clientX,o=a.touches?a.touches[0].clientY:a.clientY;c.style.left=`${e}px`,c.style.top=`${o}px`,atualizarZoomLupa(a)},M=a=>{if(!isLupaDragging)return;a.preventDefault(),isLupaDragging=!1,c.style.cursor="grab";const e=a.changedTouches?a.changedTouches[0].clientX:a.clientX,o=a.changedTouches?a.changedTouches[0].clientY:a.clientY;pegarCorDoCanvas(getTransformedPoint(e,o).x,getTransformedPoint(e,o).y)};return window.addEventListener("resize",()=>{activeDrawingTeam===e&&a()}),{setupCanvases:a,addEventListeners:function(){l.addEventListener("mousedown",B),l.addEventListener("mousemove",x),document.addEventListener("mouseup",A),l.addEventListener("mouseleave",A),l.addEventListener("touchstart",q,{passive:!1}),l.addEventListener("touchmove",S,{passive:!1}),document.addEventListener("touchend",F),c.addEventListener("mousedown",k),c.addEventListener("touchstart",k,{passive:!1}),window.addEventListener("mousemove",T),window.addEventListener("touchmove",T,{passive:!1}),window.addEventListener("mouseup",M),window.addEventListener("touchend",M),document.getElementById("desfazer-btn").onclick=window.desfazerAcao,document.getElementById("refazer-btn").onclick=window.refazerAcao},removeEventListeners:function(){l.removeEventListener("mousedown",B),l.removeEventListener("mousemove",x),document.removeEventListener("mouseup",A),l.removeEventListener("mouseleave",A),l.removeEventListener("touchstart",q),l.removeEventListener("touchmove",S),document.removeEventListener("touchend",F),c.removeEventListener("mousedown",k),c.removeEventListener("touchstart",k),window.removeEventListener("mousemove",T),window.removeEventListener("touchmove",T),window.removeEventListener("mouseup",M),window.removeEventListener("touchend",M)},unsubscribe:I}}async function abrirModalDesenho(e){if(openModal("desenho-modal"),drawingContexts[e]||(console.log(`Contexto de desenho criado sob demanda para a equipe ${e}.`),drawingContexts[e]=configurarTelaDeDesenho(e)),activeDrawingTeam&&drawingContexts[activeDrawingTeam]){const e=drawingContexts[activeDrawingTeam];e.removeEventListeners&&e.removeEventListeners()}activeDrawingTeam=e;const a=podeDesenhar(e),o=document.getElementById("desenho-toolbar"),t=document.getElementById("desenho-modal");let n=document.getElementById("desenho-modal-overlay-bloqueio");if(n&&n.remove(),a)o.style.display="flex";else{o.style.display="none",n=document.createElement("div"),n.id="desenho-modal-overlay-bloqueio",n.textContent="Voc\xEA s\xF3 pode visualizar esta tela.",n.style.zIndex="9990",t.appendChild(n);const e=t.querySelector(".close-modal-btn");e&&(e.style.zIndex="10000")}const i=drawingContexts[e];i&&setTimeout(()=>{i.setupCanvases&&i.setupCanvases(),i.addEventListeners&&i.addEventListeners()},50)}async function salvarSnapshotAoFechar(){if(activeDrawingTeam)try{const e=document.getElementById("tela-desenho-fullscreen"),a=e.toDataURL("image/png"),o=getSemanaAtual(),t=`semana_${o.numero}_${o.inicio.getFullYear()}`,n=doc(db,"vantagemSemanal",t),i={desenhoPreviews:{[activeDrawingTeam]:{imageDataURL:a,timestamp:new Date}}};await setDoc(n,i,{merge:!0}),console.log(`Snapshot (em PNG de alta qualidade) do desenho da equipe ${activeDrawingTeam} salvo com sucesso.`)}catch(e){console.error("Erro ao salvar o snapshot do desenho:",e)}}window.fecharModalDesenho=async function(){await salvarSnapshotAoFechar();const e=document.getElementById("lupa-conta-gotas");e&&e.classList.add("hidden"),definirModoGlobal("pincel"),closeModal("desenho-modal")};function desligarTodosOsOuvintesDeDesenho(){for(const e in console.log("Desligando todos os ouvintes de desenho..."),drawingContexts){const a=drawingContexts[e];a&&a.desligarOuvinte&&(a.desligarOuvinte(),console.log(`- Ouvinte da equipe ${e} desligado.`))}drawingContexts={}}async function limparTelaDeDesenho(e){console.log(`üßπ Limpando a tela de desenho da equipe: ${e}...`);try{const a=query(collection(db,`desenhos_${e}`)),o=await getDocs(a);if(o.empty)return;const t=writeBatch(db);o.forEach(e=>t.delete(e.ref)),await t.commit(),console.log(`‚úÖ Tela de ${e} limpa com sucesso.`)}catch(a){console.error(`Erro ao limpar a tela de ${e}:`,a)}}function confirmarLimpezaDeTela(e){if(podeDesenhar(e)){const a=e.charAt(0).toUpperCase()+e.slice(1);document.getElementById("confirm-clear-canvas-text").innerHTML=`Voc√™ tem certeza que deseja apagar permanentemente todo o desenho da equipe <strong>${a}</strong>? <br><br>Esta a√ß√£o n√£o pode ser desfeita.`,document.getElementById("confirm-clear-canvas-btn").onclick=()=>executarLimpezaDeTela(e),openModal("confirm-clear-canvas-modal")}else mostrarPopup("\uD83D\uDEAB Acesso Negado","Voc\xEA n\xE3o tem permiss\xE3o para limpar esta tela.",4e3)}function executarLimpezaDeTela(e){limparTelaDeDesenho(e),closeModal("confirm-clear-canvas-modal"),mostrarPopup("\u2705 Sucesso",`A tela da equipe ${e} foi limpa.`,3e3)}async function limparHistoricoRefazer(e){const a=collection(db,`historicoDesfeito_${e}`);try{const o=await getDocs(a);if(o.empty)return;const t=writeBatch(db);o.forEach(e=>{t.delete(e.ref)}),await t.commit(),console.log(`Hist√≥rico de "refazer" para a equipe ${e} foi limpo.`)}catch(e){console.error("Erro ao limpar hist\xF3rico de refazer:",e)}}window.desfazerAcao=async function(){if(!activeDrawingTeam)return;const e=collection(db,`desenhos_${activeDrawingTeam}`),a=collection(db,`historicoDesfeito_${activeDrawingTeam}`),o=query(e,orderBy("timestamp","desc"),limit(1));try{const e=await getDocs(o);if(e.empty)return void mostrarPopup("\u2139\uFE0F","N\xE3o h\xE1 nada para desfazer.",2e3);const t=e.docs[0],n=t.data(),i=writeBatch(db);i.set(doc(a),n),i.delete(t.ref),await i.commit()}catch(e){console.error("Erro ao desfazer:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel desfazer a a\xE7\xE3o.",3e3)}},window.refazerAcao=async function(){if(!activeDrawingTeam)return;const e=collection(db,`desenhos_${activeDrawingTeam}`),a=collection(db,`historicoDesfeito_${activeDrawingTeam}`),o=query(a,orderBy("timestamp","desc"),limit(1));try{const a=await getDocs(o);if(a.empty)return void mostrarPopup("\u2139\uFE0F","N\xE3o h\xE1 nada para refazer.",2e3);const t=a.docs[0],n=t.data(),i=writeBatch(db);i.set(doc(e),n),i.delete(t.ref),await i.commit()}catch(e){console.error("Erro ao refazer:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel refazer a a\xE7\xE3o.",3e3)}};function iniciarCarrosselDesenho(){carrosselDesenhoInterval&&clearInterval(carrosselDesenhoInterval),carrosselDesenhoInterval=setInterval(()=>{carrosselDesenhoPausado||(currentCarrosselDesenhoIndex=(currentCarrosselDesenhoIndex+1)%3,irParaSlideDesenho(currentCarrosselDesenhoIndex))},1e4)}window.irParaSlideDesenho=function(e){const a=document.getElementById("carrossel-container-desenho");a.style.transform=`translateX(-${100*e}%)`;const o=document.querySelectorAll("#carrossel-indicadores-desenho .carrossel-indicador");o.forEach((a,o)=>{a.classList.toggle("ativo",o===e)}),currentCarrosselDesenhoIndex=e,carrosselDesenhoPausado||iniciarBarraProgressoDesenho()};function reiniciarIntervaloCarrosselDesenho(){clearInterval(carrosselDesenhoInterval),iniciarCarrosselDesenho(),iniciarBarraProgressoDesenho()}window.mudarSlideDesenho=function(e){reiniciarIntervaloCarrosselDesenho();currentCarrosselDesenhoIndex=(currentCarrosselDesenhoIndex+e+3)%3,irParaSlideDesenho(currentCarrosselDesenhoIndex)},window.togglePausaDesenho=function(){carrosselDesenhoPausado=!carrosselDesenhoPausado;const e=document.getElementById("botao-pausa-desenho"),a=document.getElementById("progresso-indicador-barra-desenho");if(!carrosselDesenhoPausado)e.textContent="\u23F8",a&&a.classList.add("animar"),iniciarCarrosselDesenho();else if(clearInterval(carrosselDesenhoInterval),e.textContent="\u25B6",a){const e=window.getComputedStyle(a).width;a.classList.remove("animar"),a.style.width=e}};function iniciarBarraProgressoDesenho(){const e=document.getElementById("progresso-indicador-barra-desenho");e&&(e.style.transition="none",e.style.width="0%",void e.offsetWidth,e.style.transition="width 10s linear",setTimeout(()=>{carrosselDesenhoPausado||(e.style.width="100%")},10),progressoBarraDesenho&&clearTimeout(progressoBarraDesenho),progressoBarraDesenho=setTimeout(()=>{e.style.width="0%"},1e4))}async function enviarComentario(e){const a=document.getElementById("send-comment-btn-modal");a.disabled=!0,a.textContent="Enviando...";try{const a=document.getElementById("comment-textarea-modal"),o=a.innerHTML.trim(),t=a.innerText.trim();if(!t||"<br>"===o)return void mostrarPopup("\u270D\uFE0F Aten\xE7\xE3o","Escreva algo para comentar.",3e3);const n=doc(db,"mural",e),i=collection(db,"mural",e,"comments"),r=doc(db,"membros",currentUser),d=doc(i);try{const s=query(i,where("userId","==",currentUser)),l=await getDocs(s);if(3<=l.size)return void mostrarPopup("\uD83D\uDEAB Limite Atingido","Voc\xEA j\xE1 adicionou o m\xE1ximo de 3 coment\xE1rios nesta mensagem.",5e3);let m=null,c;await runTransaction(db,async e=>{const a=await e.get(n);if(!a.exists())throw"A mensagem original n\xE3o foi encontrada.";c=a.data();const t={userId:currentUser,texto:o,timestamp:new Date,reacoes:EMOJIS_MURAL.reduce((e,a)=>({...e,[a]:[]}),{})},i=c.userId;if(i&&i!==currentUser&&"Or\xE1culo"!==i&&"An\xF4nimo"!==i){const a=collection(db,"notificacoes"),o=doc(a);e.set(o,{destinatarioId:i,remetenteNome:currentUser,tipo:"mural-comment",conteudo:"\uD83D\uDCAC",acao:`comentou na sua mensagem: "${c.texto.replace(/<[^>]*>/g," ").substring(0,30)}..."`,lida:!1,timestamp:new Date}),t.notificationId=o.id}e.set(d,t),e.update(n,{commentCount:increment(1)}),e.update(r,{moedas:increment(25)})}),mostrarPopup("\u2705 Sucesso","Coment\xE1rio enviado!",3e3),tocarSom("som-envio"),mostrarPopupMoedas(25),a.innerHTML="";const u=t.match(/@([\w√°√©√≠√≥√∫√Å√â√ç√ì√ö√¢√™√Æ√¥√ª√Ç√ä√é√î√õ√†√®√¨√≤√π√Ä√à√å√í√ô√£√µ√É√ï√ß√á]+)/g)?.map(e=>e.substring(1))||[],p=new Set;0<u.length&&u.forEach(e=>{const a=c.userId;if("todos"===e.toLowerCase())todosMembros.forEach(e=>{e.nome!==currentUser&&e.nome!==a&&p.add(e.nome)});else if(e.toLowerCase().startsWith("equipe")){const o=e.substring(6).toLowerCase();equipes[o]&&equipes[o].membros.forEach(e=>{e.nome!==currentUser&&e.nome!==a&&p.add(e.nome)})}else{const o=todosMembros.find(a=>a.nome.toLowerCase()===e.toLowerCase());o&&o.nome!==currentUser&&o.nome!==a&&p.add(o.nome)}});let g;if(0<p.size){const e=Array.from(p).slice(0,2);let a=`<strong>${e.join("</strong> e <strong>")}</strong>`;2<p.size&&(a+=` e outros`),g=`<strong>${currentUser}</strong> comentou na mensagem de <strong>${c.userId}</strong> e mencionou ${a}.`}else g=`<strong>${currentUser}</strong> comentou na mensagem de <strong>${c.userId}</strong> no Mural de Mensagens.`;m=await adicionarEventoAoFeed("geral","\uD83D\uDCAC Novo Coment\xE1rio no Mural!",g,{nomeMembro:currentUser,autorMensagem:c.userId}),m&&(await updateDoc(d,{feedEventId:m})),u.map(e=>e.toLowerCase()).includes("or\xE1culo")&&setTimeout(()=>{gerarRespostaOraculoParaComentario(e,d.id,t,currentUser)},3e3)}catch(e){console.error("Erro no envio de coment\xE1rio:",e),mostrarPopup("\u274C Erro",e.toString(),5e3)}}finally{a.disabled=!1,a.textContent="\u27A4"}}window.openCommentsModal=async function(e){const a=document.getElementById("comments-modal");openModal("comments-modal"),a.removeAttribute("data-theme"),document.body.classList.contains("tema-noite")?a.dataset.theme="noite":document.body.classList.contains("tema-manha")?a.dataset.theme="manha":document.body.classList.contains("tema-tarde")&&(a.dataset.theme="tarde");const o=document.getElementById("comments-list");o.innerHTML="<p class=\"no-comments\">Carregando coment\xE1rios...</p>";const t=document.getElementById("send-comment-btn-modal");t.onclick=()=>enviarComentario(e);const n=document.getElementById("comment-textarea-modal"),i=doc(db,"mural",e);try{const e=await getDoc(i);if(e.exists()){const a=e.data().userId;if(a&&a!==currentUser&&"Or\xE1culo"!==a&&"An\xF4nimo"!==a){n.innerHTML=`@${a},&nbsp;`,n.focus();const e=document.createRange(),o=window.getSelection();e.selectNodeContents(n),e.collapse(!1),o.removeAllRanges(),o.addRange(e)}else n.innerHTML=""}}catch(a){console.error("Erro ao buscar autor da mensagem:",a),n.innerHTML=""}const r=collection(db,"mural",e,"comments"),d=query(r,orderBy("timestamp","asc"));onSnapshot(d,a=>(o.innerHTML="",a.empty?void(o.innerHTML="<p class=\"no-comments\">Nenhum coment\xE1rio ainda. Seja o primeiro!</p>"):void(a.forEach(a=>{const t=a.data(),n=document.createElement("div");n.className="comment-item";const i=t.timestamp.toDate(),r=i.toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit"}),d=i.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});let s="";(t.userId===currentUser||"lider"===userRole)&&(s=`<div class="comment-options-container"><button class="options-btn" onclick="window.openOptionsMenu(event, 'comment', '${e}', '${a.id}')">‚ãÆ</button></div>`);const l=t.reacoes||{};let m="",c=!1;const u=Object.keys(l).sort((e,a)=>(l[a]?.length||0)-(l[e]?.length||0));for(const e of u){const a=Array.isArray(l[e])?l[e]:[];if(0<a.length){c=!0;const o=a.includes(currentUser),t=o?"reacted":"";m+=`<div class="reacao-display ${t}" title="Reagido por: ${a.join(", ")}">${e} <span class="contador-display">${a.length}</span></div>`}}const p=c?`<div class="reacoes-display-container">${m}</div>`:"";n.innerHTML=`
          <div class="comment-header">
              <strong class="comment-author">${t.userId}</strong>
              <span class="comment-timestamp">${r} √†s ${d}</span>
              ${s}
          </div>
${(()=>{let e=t.texto||"";return e=e.replace(/@([\w√°√©√≠√≥√∫√Å√â√ç√ì√ö√¢√™√Æ√¥√ª√Ç√ä√é√î√õ√†√®√¨√≤√π√Ä√à√å√í√ô√£√µ√É√ï√ß√á]+)/g,"<span class=\"mention\">@$1</span>"),`<p class="comment-text">${e.replace(/\n/g,"<br>")}</p>`})()}
          ${p}
          <div class="reacao-seletor-bar hidden">
            ${EMOJIS_MURAL.map(o=>`<button onclick="event.stopPropagation(); window.toggleReacaoComentario(event, '${e}', '${a.id}', '${o}')">${o}</button>`).join("")}
          </div>
      `,o.appendChild(n);let g=null,f=!1;const h=()=>{document.querySelectorAll(".comment-item .reacao-seletor-bar").forEach(e=>{e!==n.querySelector(".reacao-seletor-bar")&&e.classList.add("hidden")});const e=n.querySelector(".reacao-seletor-bar");if(e&&(e.classList.toggle("hidden"),!e.classList.contains("hidden"))){const a=o=>{n.contains(o.target)||(e.classList.add("hidden"),document.removeEventListener("click",a,!0))};setTimeout(()=>document.addEventListener("click",a,!0),100)}},v=a=>{a.target.closest("button, a, .reacao-display, .mention")||(f=!1,g=setTimeout(()=>{f=!0,h()},500))},E=()=>clearTimeout(g),y=a=>{clearTimeout(g),f||a.target.closest("button, a, .reacao-display, .mention")||h()};n.addEventListener("mousedown",v),n.addEventListener("mouseup",y),n.addEventListener("mouseleave",E),n.addEventListener("touchstart",v,{passive:!0}),n.addEventListener("touchend",y)}),o.scrollTop=o.scrollHeight)))};async function gerarReacaoERespostaCombinadaComIA(e,a){if(!genAI)return null;try{const o=await callGenerativeAIWithRetry(`
    Voc√™ √© o Or√°culo, o mentor s√°bio e carinhoso do Grupo √âpicos.
    Sua tarefa √© analisar um conte√∫do e fornecer DUAS coisas:
    1.  Um emoji de rea√ß√£o apropriado.
    2.  Um texto de resposta curto e acolhedor.

    CONTEXTO PARA SUA AN√ÅLISE:
    ${e}

    INSTRU√á√ïES PARA SUA RESPOSTA:
    ${a}

    FORMATO OBRIGAT√ìRIO DA RESPOSTA:
    Sua resposta DEVE ser um JSON v√°lido no formato:
    {
      "emoji": "SEU_EMOJI_AQUI",
      "resposta": "SEU_TEXTO_DE_RESPOSTA_AQUI"
    }
    Apenas o JSON, sem nenhuma outra palavra, explica√ß√£o ou formata√ß√£o.
  `),t=o.match(/{[\s\S]*}/)[0],n=JSON.parse(t);if(n.emoji&&n.resposta&&EMOJIS_MURAL.includes(n.emoji))return n;throw new Error("JSON da IA est\xE1 incompleto ou o emoji \xE9 inv\xE1lido.")}catch(e){return console.error("Or\xE1culo (Combinado): Erro ao gerar rea\xE7\xE3o e resposta.",e),null}}window.excluirComentario=function(e,a,o){e.stopPropagation(),commentIdToDelete=o,messageIdForCommentAction=a,openModal("confirm-delete-comment-modal")};async function executarExclusaoComentario(){if(!commentIdToDelete||!messageIdForCommentAction)return;const e=doc(db,"mural",messageIdForCommentAction),a=doc(e,"comments",commentIdToDelete);try{await runTransaction(db,async o=>{const t=await o.get(a);if(t.exists()){const e=t.data(),a=e.feedEventId,n=e.notificationId;a&&o.delete(doc(db,"resumoSemanalFeed",a)),n&&o.delete(doc(db,"notificacoes",n))}o.delete(a),o.update(e,{commentCount:increment(-1)})}),mostrarPopup("\u2705 Sucesso","Coment\xE1rio exclu\xEDdo!",3e3)}catch(e){console.error("Erro ao excluir coment\xE1rio:",e),mostrarPopup("\u274C Erro","Falha ao excluir o coment\xE1rio.",4e3)}finally{closeModal("confirm-delete-comment-modal"),commentIdToDelete=null,messageIdForCommentAction=null}}window.editarComentario=async function(e,a,o){e.stopPropagation(),editingCommentId=o,messageIdForCommentAction=a;const t=doc(db,"mural",a,"comments",o);try{const e=await getDoc(t);if(e.exists()){const a=e.data().texto;document.getElementById("edit-comment-textarea").value=a,openModal("edit-comment-modal")}else throw new Error("Coment\xE1rio n\xE3o encontrado.")}catch(e){console.error("Erro ao buscar coment\xE1rio para editar:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel carregar o coment\xE1rio para edi\xE7\xE3o.",4e3)}};async function salvarEdicaoComentario(){if(editingCommentId&&messageIdForCommentAction){const e=document.getElementById("edit-comment-textarea").value.trim();if(!e)return void mostrarPopup("\u270D\uFE0F Aten\xE7\xE3o","O coment\xE1rio n\xE3o pode ficar vazio.",3e3);const a=doc(db,"mural",messageIdForCommentAction,"comments",editingCommentId);try{await updateDoc(a,{texto:e}),mostrarPopup("\u2705 Sucesso","Coment\xE1rio atualizado!",3e3)}catch(e){console.error("Erro ao salvar edi\xE7\xE3o do coment\xE1rio:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel salvar as altera\xE7\xF5es.",4e3)}finally{closeModal("edit-comment-modal"),editingCommentId=null,messageIdForCommentAction=null}}}window.openOptionsMenu=function(e,a,o,t=null){e.stopPropagation();const n=document.getElementById("global-options-menu");if(!n.classList.contains("hidden"))return n.classList.add("hidden"),void(window.closeMenuOnClickOutside&&document.removeEventListener("click",window.closeMenuOnClickOutside,!0));window.closeMenuOnClickOutside&&document.removeEventListener("click",window.closeMenuOnClickOutside,!0),n.innerHTML="","message"===a?n.innerHTML=`
      <button onclick="window.editarMensagem(event, '${o}')">Editar</button>
      <button onclick="window.excluirMensagem(event, '${o}')">Excluir</button>
    `:"comment"==a&&(n.innerHTML=`
      <button onclick="window.editarComentario(event, '${o}', '${t}')">Editar</button>
      <button onclick="window.excluirComentario(event, '${o}', '${t}')">Excluir</button>
    `);const i=e.target.getBoundingClientRect(),r=window.scrollY||document.documentElement.scrollTop;n.style.top=`${r+i.bottom+5}px`;const d=window.innerWidth-i.right,s=i.left;d<140&&s>d?(n.style.left="auto",n.style.right=`${window.innerWidth-i.right}px`):(n.style.left=`${i.left}px`,n.style.right="auto"),n.classList.remove("hidden"),window.closeMenuOnClickOutside=a=>{a.target.closest(".options-btn")||!n.contains(a.target)&&(n.classList.add("hidden"),document.removeEventListener("click",window.closeMenuOnClickOutside,!0))},setTimeout(()=>{document.addEventListener("click",window.closeMenuOnClickOutside,!0)},0)};async function iniciarCarregamentoAutomaticoDesenhos(){async function e(t){if(t>=a.length)return void console.log("Todos os desenhos foram pr\xE9-carregados.");const n=a[t],i=a[t+1],r=document.getElementById(`preview-container-${n}`),d=r.querySelector(".loading-overlay");if(r.classList.add("is-loading"),d.textContent="Carregando...",d.classList.remove("hidden"),console.log(`Pr√©-carregando desenho da equipe: ${n}`),drawingContexts[n]||(drawingContexts[n]=configurarTelaDeDesenho(n)),await new Promise(e=>setTimeout(e,1500)),r.classList.remove("is-loading"),d.classList.add("hidden"),console.log(`Desenho da equipe ${n} pr√©-carregado.`),i){const a=document.getElementById(`preview-container-${i}`),n=a.querySelector(".loading-overlay");let r=o;n.textContent=`Carregando em ${r}...`,n.classList.remove("hidden");const d=setInterval(()=>{r--,n.textContent=`Carregando em ${r}...`,0>=r&&(clearInterval(d),e(t+1))},1e3);a.onclick=()=>{clearInterval(d),n.classList.add("hidden"),abrirModalDesenho(i)}}}const a=["abelha","joaninha","vagalume"],o=5;e(0)}function handleSecretIconClick(){if(maintenanceClickCount++,clearTimeout(maintenanceClickTimer),maintenanceClickTimer=setTimeout(()=>{maintenanceClickCount=0},2e3),5===maintenanceClickCount){clearTimeout(maintenanceClickTimer),maintenanceClickCount=0;const e=document.getElementById("maintenance-password").parentElement;e&&(e.classList.remove("hidden"),document.getElementById("maintenance-password").focus())}}function handleMaintenanceBypass(e){e.preventDefault();const a=document.getElementById("maintenance-password");a.value==="abacate"?(sessionStorage.setItem("maintenanceBypass","true"),location.reload()):(a.classList.add("error"),setTimeout(()=>a.classList.remove("error"),500))}async function verificarEstadoManutencaoInicial(){if("true"===sessionStorage.getItem("maintenanceBypass"))return!1;try{const e=doc(db,"appState","status"),a=await getDoc(e),o=a.exists()&&!0===a.data().maintenanceActive;return o}catch(e){return console.error("Erro ao verificar estado inicial de manuten\xE7\xE3o:",e),!1}}function setupMaintenanceListenerAndCheck(){const e=doc(db,"appState","status"),a=document.getElementById("maintenance-overlay"),o=document.getElementById("maintenance-password"),t=document.getElementById("toggle-maintenance-btn"),n=document.getElementById("maintenance-icon");onSnapshot(e,e=>{const o=e.exists()&&!0===e.data().maintenanceActive,n="true"===sessionStorage.getItem("maintenanceBypass");o&&!n?(a.classList.remove("hidden"),document.body.style.overflow="hidden"):(a.classList.add("hidden"),document.body.style.overflow="auto"),t&&(o?(t.textContent="Desativar Modo de Manuten\xE7\xE3o",t.style.backgroundColor="#2ecc71"):(t.textContent="Ativar Modo de Manuten\xE7\xE3o",t.style.backgroundColor="#e67e22"))});const i=document.getElementById("maintenance-form");i&&i.addEventListener("submit",handleMaintenanceBypass),n.addEventListener("click",handleSecretIconClick)}setupMaintenanceListenerAndCheck();async function refreshAppUI(){mostrarPopup("\uD83D\uDD04 Atualizando","Aguarde, recarregando a interface...",2e3),await carregarMembros(),construirInterface(),await Promise.all([carregarPresenca(),carregarPontosSemanais(),carregarRankingGeral(),carregarAniversariantes(),carregarArvoreEpica(),carregarStreaks(),exibirQuadroFolgas(),carregarInformacoesMembros()]),await atualizarResumo(),atualizarPlacarSemanal(),atualizarRankingGeral(),atualizarVisualBloqueio(),await carregarEExibirMembrosOciosos(),mostrarPopup("\u2705 Pronto!","Interface atualizada com sucesso!",3e3)}async function openControlPanel(){const e=document.querySelectorAll(".lider-geral-only");"lider"===userRole?e.forEach(e=>e.classList.remove("hidden")):e.forEach(e=>e.classList.add("hidden"));const a=document.getElementById("select-member-to-remove"),o=document.getElementById("new-member-team"),t=document.getElementById("new-member-role");a.innerHTML="<option value=\"\">Selecione um membro para remover...</option>",todosMembros.forEach(e=>{if(e.nome!==currentUser&&("lider"===userRole||"lider-equipe"===userRole&&e.equipe===userTeam)){const o=new Option(`${e.nome} (${e.equipe||"Sem equipe"})`,e.nome);a.appendChild(o)}}),"lider-equipe"===userRole?(o.value=userTeam,o.disabled=!0,t.value="membro"):o.disabled=!1,document.getElementById("new-member-result").textContent="";const n=getHoje(),i=n.getDay(),r=getSemanaAtual(),d=doc(db,"appState",`popupState_${r.numero}_${r.inicio.getFullYear()}`),s=document.getElementById("btn-abrir-avaliacao-lideres"),l=document.getElementById("btn-abrir-recompensa-equipe");s.classList.add("hidden"),l.classList.add("hidden");try{const e=await getDoc(d),a=e.exists()?e.data():{};if("lider"===userRole&&0===i){s.classList.remove("hidden");const e=(a.liderGeralAvaliacaoVista||[]).includes(currentUser);e?(s.textContent="\u2714\uFE0F Avalia\xE7\xE3o Enviada",s.disabled=!0):(s.textContent="\uD83D\uDC51 Avalia\xE7\xE3o Semanal de L\xEDderes",s.disabled=!1,s.onclick=abrirPopupAvaliacaoLideres)}if("lider-equipe"===userRole&&(0===i||1===i)){const e=getSemanaAtual(new Date(n.getTime()-86400000)),o=doc(db,"recompensasLideres",`semana_${e.numero}_${e.inicio.getFullYear()}`),t=await getDoc(o);if(t.exists()&&t.data().aprovados.includes(currentUser)){l.classList.remove("hidden");let e=!1;e=0===i?(a.liderEquipeRecompensaVista||[]).includes(currentUser):(a.liderEquipeRecompensaVista||[]).includes(currentUser),e?(l.textContent="\u2714\uFE0F Recompensas Enviadas",l.disabled=!0):(l.textContent="\uD83C\uDFC6 Recompensa da Equipe",l.disabled=!1,l.onclick=abrirPopupRecompensaEquipe)}}}catch(a){console.error("Erro ao configurar bot\xF5es de a\xE7\xF5es semanais:",a)}popularPainelOrdemJogos(),popularPainelFerias(),openModal("control-panel-modal")}window.abrirPlacarVantagem=async function(){const e=getSemanaAtual(),a=`semana_${e.numero}_${e.inicio.getFullYear()}`,o=doc(db,"vantagemSemanal",a),t=document.getElementById("placar-completos"),n=document.getElementById("placar-pendentes");t.innerHTML="<li>Carregando...</li>",n.innerHTML="<li>Carregando...</li>",openModal("placar-vantagem-modal");try{const e=await getDoc(o),a=e.exists()?e.data().completadoPor||{}:{},i=[],r=[];todosMembros.forEach(e=>{a[e.nome]?i.push({nome:e.nome,equipe:e.equipe,timestamp:a[e.nome].toDate()}):!e.deFerias&&r.push({nome:e.nome,equipe:e.equipe})}),i.sort((e,a)=>e.timestamp-a.timestamp),t.innerHTML=0<i.length?i.map((e,a)=>{const o=e.timestamp.toLocaleDateString("pt-BR"),t=e.timestamp.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});return`
          <div class="placar-item">
            <span class="posicao">${a+1}¬∫</span>
            <span class="nome ${e.equipe}">${e.nome}</span>
            <span class="timestamp">${o} √†s ${t}</span>
          </div>
        `}).join(""):"<div class=\"placar-item\">Ningu\xE9m finalizou o jogo ainda.</div>",n.innerHTML=0<r.length?r.map(e=>`
          <div class="placar-item">
             <span class="nome ${e.equipe}">${e.nome}</span>
          </div>
        `).join(""):"<div class=\"placar-item\">Todos os membros finalizaram! Parab\xE9ns!</div>"}catch(e){console.error("Erro ao carregar placar da vantagem:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel carregar o placar.",4e3),closeModal("placar-vantagem-modal")}};async function handleAddMember(){let e=document.getElementById("new-member-name").value.trim();const a=document.getElementById("new-member-team").value,o=document.getElementById("new-member-role").value;if(!e)return void mostrarPopup("\u274C Erro","O nome do membro n\xE3o pode ser vazio.",3e3);e=e.charAt(0).toUpperCase()+e.slice(1);const t=todosMembros.some(a=>a.nome.toLowerCase()===e.toLowerCase());if(t)return void mostrarPopup("\u274C Erro",`O membro "${e}" j√° existe!`,4e3);const n=Math.floor(1e4+9e4*Math.random()).toString();try{const t={equipe:a,papel:o,senhaProv:n,usedProv:"off",folga:"segunda-feira",aniversario:"",apelido:"",filme:"",sonho:"",musica:"",curiosidade:"",inventarioAvatar:["corpo_1","corpo_2","corpo_3","corpo_4","corpo_5","rosto_1","roupa_1_cor_1","roupa_1_cor_2","fundo_1"],avatar:criarAvatarPadrao()};await setDoc(doc(db,"membros",e),t),await adicionarEventoAoFeed("geral","\uD83D\uDC4B Bem-vindo(a) ao Grupo!",`Um novo √©pico se juntou a n√≥s! Seja muito bem-vindo(a), <strong>${e}</strong>!`,{nomeMembro:e}),await gerarImagemLogin(e,n),openModal("new-member-success-modal"),document.getElementById("new-member-name").value="",document.getElementById("new-member-result").textContent="",await refreshAppUI()}catch(e){console.error("Erro ao adicionar membro:",e),mostrarPopup("\u274C Falha","Ocorreu um erro ao salvar o novo membro.",4e3)}}async function toggleMaintenanceMode(){const e=doc(db,"appState","status");try{const a=await getDoc(e),o=!!a.exists()&&a.data().maintenanceActive,t=!o;await setDoc(e,{maintenanceActive:t},{merge:!0}),t?mostrarPopup("\u2705 Ativado","O modo de manuten\xE7\xE3o est\xE1 ATIVO. Os usu\xE1rios ser\xE3o bloqueados.",5e3):mostrarPopup("\u2705 Desativado","O modo de manuten\xE7\xE3o foi DESATIVADO. Os usu\xE1rios podem acessar.",5e3)}catch(e){console.error("Erro ao alternar modo de manuten\xE7\xE3o:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel alterar o estado de manuten\xE7\xE3o.",4e3)}}async function handleRemoveMember(){const e=document.getElementById("select-member-to-remove").value;return e?void(memberIdToRemove=e,document.getElementById("member-to-remove-name").innerText=e,openModal("confirm-remove-modal")):void mostrarPopup("\u274C Erro","Selecione um membro para remover.",3e3)}async function executeRemoveMember(){if(memberIdToRemove)try{await deleteDoc(doc(db,"membros",memberIdToRemove)),mostrarPopup("\u2705 Sucesso",`O membro "${memberIdToRemove}" foi removido.`,4e3),await refreshAppUI(),closeModal("control-panel-modal"),openControlPanel()}catch(e){console.error("Erro ao remover membro:",e),mostrarPopup("\u274C Falha","Ocorreu um erro ao remover o membro.",4e3)}finally{memberIdToRemove=null,closeModal("confirm-remove-modal")}}const todosOsJogos=[{nome:"Jogo da Mem\xF3ria",initFunction:initMemoryGame,htmlContent:""},{nome:"Acerte o Alvo",initFunction:initClickerGame,htmlContent:`
            <div id="clicker-game-board">
                <div class="clicker-stats">
                    <div id="clicker-score">Pontos: 0</div>
                    <div id="clicker-timer">Tempo: 30</div>
                </div>
                <button id="clicker-start-button">Come√ßar!</button>
            </div>
        `},{nome:"Sequ\xEAncia de Cores",initFunction:initSimonGame,htmlContent:`
            <div id="simon-game-board">
                <div id="simon-info-display">N√≠vel: 1</div>
                <div id="simon-pads-container">
                    <div class="simon-pad" id="simon-pad-0" data-index="0"></div>
                    <div class="simon-pad" id="simon-pad-1" data-index="1"></div>
                    <div class="simon-pad" id="simon-pad-2" data-index="2"></div>
                    <div class="simon-pad" id="simon-pad-3" data-index="3"></div>
                </div>
                <button id="simon-start-button">Iniciar</button>
            </div>
        `},{nome:"Jogo da Velha",initFunction:initTicTacToeGame,htmlContent:`
        <div id="tictactoe-board-wrapper">
            <div id="tictactoe-symbol-selection">
                <div class="status-display">Escolha seu lado:</div>
                <div class="symbol-buttons">
                    <button id="select-X" class="symbol-btn x">X</button>
                    <button id="select-O" class="symbol-btn o">O</button>
                </div>
            </div>

            <div id="tictactoe-status" class="status-display hidden">Sua vez de jogar (X)</div>
            <div id="tictactoe-board" class="hidden">
                <div class="tictactoe-cell" data-cell-index="0"></div>
                <div class="tictactoe-cell" data-cell-index="1"></div>
                <div class="tictactoe-cell" data-cell-index="2"></div>
                <div class="tictactoe-cell" data-cell-index="3"></div>
                <div class="tictactoe-cell" data-cell-index="4"></div>
                <div class="tictactoe-cell" data-cell-index="5"></div>
                <div class="tictactoe-cell" data-cell-index="6"></div>
                <div class="tictactoe-cell" data-cell-index="7"></div>
                <div class="tictactoe-cell" data-cell-index="8"></div>
                <div id="tictactoe-winning-line" class="winning-line"></div>
            </div>
            <button id="tictactoe-restart-button" class="hidden">Jogar Novamente</button>
        </div>
    `},{nome:"Quiz dos \xC9picos",initFunction:initQuizGame,htmlContent:`
            <div id="quiz-container" style="display: flex; flex-direction: column; align-items: center; width: 100%; max-width: 700px; padding: 10px;">
                <div id="quiz-progress-bar-container" style="width: 100%; background-color: #e0e0e0; border-radius: 5px; height: 10px; margin-bottom: 15px;">
                    <div id="quiz-progress-bar" style="width: 0%; height: 100%; background-color: #3498db; border-radius: 5px; transition: width 0.3s ease;"></div>
                </div>
                <div id="quiz-question-number" style="font-size: 1rem; color: #7f8c8d; margin-bottom: 10px;">Pergunta 1 de 4</div>
                <h3 id="quiz-question" style="font-size: 1.5rem; text-align: center; min-height: 80px; padding: 15px 0;">Qual o filme favorito de...?</h3>
                <div id="quiz-alternatives" style="display: flex; flex-direction: column; gap: 12px; width: 100%; margin-top: 20px;">
                    </div>
                <div id="quiz-feedback" style="margin-top: 20px; font-weight: bold; font-size: 1.2rem; min-height: 30px;"></div>
            </div>
        `},{nome:"Jogo da Forca",initFunction:initForcaGame,htmlContent:`
            <div id="forca-game-container">
                <div id="forca-status"></div>
                <div class="forca-wrapper">
                    <div class="forca-desenho">
                        <div class="parte-forca forca-base"></div>
                        <div class="parte-forca forca-haste"></div>
                        <div class="parte-forca forca-topo"></div>
                        <div class="parte-forca forca-corda"></div>
                        <div class="enforcado">
                            <div class="parte-corpo cabeca"></div>
                            <div class="parte-corpo tronco"></div>
                            <div class="parte-corpo braco-esq"></div>
                            <div class="parte-corpo braco-dir"></div>
                            <div class="parte-corpo perna-esq"></div>
                            <div class="parte-corpo perna-dir"></div>
                        </div>
                    </div>
                    <div class="forca-info">
                        <div class="palavra-secreta" id="palavra-forca"></div>
                        <div class="dica-container" id="dica-forca"></div>
                    </div>
                </div>
                <div class="teclado-virtual" id="teclado-forca"></div>
                <button id="forca-restart-button">Tentar Novamente</button>
            </div>
        `}];window.toggleLeaderTestPanel=function(){const e=document.getElementById("leader-test-panel");e&&e.classList.toggle("hidden")};async function loadAdvantageState(){if(!currentUser)return;const e=getHoje(),a=e.getDay(),o=sessionStorage.getItem("vantagemPopupVisto");if(0!==a&&userTeam&&equipes[userTeam]&&!o){const e=getSemanaAtual(),a=`semana_${e.numero}_${e.inicio.getFullYear()}`,o=doc(db,"vantagemSemanal",a);try{const e=await getDoc(o),a=e.exists()?e.data().completadoPor||{}:{},t=new Set(Object.keys(a)),n=equipes[userTeam],i=n.membros.filter(e=>!t.has(e.nome)&&!e.deFerias).map(e=>e.nome);if(0<i.length){const e=`<strong>- ${i.join("<br>- ")}</strong>`;mostrarCardPopup("\u26A0\uFE0F Aten\xE7\xE3o, Equipe!",`
                    Para que sua equipe ganhe um b√¥nus de <strong>+3 pontos na m√©dia final</strong> no domingo, todos precisam completar o Jogo da Vantagem.
                    <br><br>
                    Ainda falta(m):
                    <br>
                    ${e}
                    <br><br>
                    Mande uma mensagem e incentive seus colegas a completarem o desafio!
                `)}sessionStorage.setItem("vantagemPopupVisto","true")}catch(e){console.error("Erro ao verificar membros pendentes para o popup:",e)}}const t=document.getElementById("leader-advantage-controls");if("lider"===userRole){t.classList.remove("hidden"),document.getElementById("leader-test-button").onclick=window.toggleLeaderTestPanel;const e=document.getElementById("leader-game-list");e.innerHTML="",todosOsJogos.forEach((a,o)=>{const t=document.createElement("li"),n=document.createElement("button");n.textContent=a.nome,n.onclick=()=>startLeaderTestGame(o),t.appendChild(n),e.appendChild(t)})}else t.classList.add("hidden");const n=getSemanaAtual(),i=`semana_${n.numero}_${n.inicio.getFullYear()}`,r=doc(db,"vantagemSemanal",i),d=await getDoc(r),s=d.exists()?d.data():{},l=s.completadoPor?.[currentUser];if(l)return lockAdvantageSection("Desafio conclu\xEDdo! Volte na pr\xF3xima semana para mais."),void(document.getElementById("advantage-game-board").innerHTML="");if(0===a||6===a)return lockAdvantageSection("O tempo para este desafio acabou. Ele retorna na Segunda-feira!"),void(document.getElementById("advantage-game-board").innerHTML="");unlockAdvantageSection();const m=document.getElementById("advantage-game-board"),c=document.getElementById("vantagem-jogo-nome");let u;try{const e=doc(db,"configuracoes","ordemJogosVantagem"),a=await getDoc(e);if(a.exists()&&a.data().ordem){const e=a.data(),o=e.ordem,t=e.semanaDeInicio||n.numero;if(0<o.length){console.log("Usando ordem de jogos personalizada do Firestore.");const e=(n.numero-t)%o.length,a=0>e?e+o.length:e,i=o[a];u=todosOsJogos.find(e=>e.nome===i)}}if(!u){console.log("Ordem personalizada n\xE3o encontrada ou inv\xE1lida. Usando ordem padr\xE3o.");const e=n.numero%todosOsJogos.length;u=todosOsJogos[e]}}catch(e){console.error("Erro ao buscar ordem de jogos, usando padr\xE3o:",e);const a=n.numero%todosOsJogos.length;u=todosOsJogos[a]}if(c&&(c.textContent=`Jogo da Semana: ${u.nome}`),m.innerHTML=u.htmlContent,"Jogo da Forca"===u.nome){let e=s.palavraDaSemana;e||(e=await gerarPalavraComIA(),await setDoc(r,{palavraDaSemana:e},{merge:!0}),console.log("Nova palavra da semana, gerada pela IA, foi definida:",e.palavra)),initForcaGame(e)}else if("Quiz dos \xC9picos"===u.nome){const e=await gerarQuizDaSemana();e&&0<e.length?initQuizGame(e):m.innerHTML="<h2>N\xE3o foi poss\xEDvel gerar o quiz desta semana. Verifique se os membros preencheram suas informa\xE7\xF5es. Tente novamente mais tarde.</h2>"}else u.initFunction()}function lockAdvantageSection(e){const a=document.getElementById("vantagem-locked-overlay"),o=document.getElementById("vantagem-lock-message");a&&o&&(o.textContent=e,a.classList.remove("hidden"))}function unlockAdvantageSection(){const e=document.getElementById("vantagem-locked-overlay");e&&e.classList.add("hidden")}async function saveAdvantageCompletion(){if(!currentUser)return;const e=getSemanaAtual(),a=`semana_${e.numero}_${e.inicio.getFullYear()}`,o=doc(db,"vantagemSemanal",a);try{await setDoc(o,{completadoPor:{[currentUser]:new Date}},{merge:!0}),console.log(`Conclus√£o salva para ${currentUser}`)}catch(e){console.error("Erro ao salvar conclus\xE3o:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel salvar seu progresso.",4e3)}}async function handleGameWin(e){try{const a=doc(db,"membros",currentUser);await updateDoc(a,{moedas:increment(recompensasConfig.vitoriaJogoVantagem||50)}),mostrarPopupMoedas(recompensasConfig.vitoriaJogoVantagem||50),console.log(`+50 moedas dadas a ${currentUser} por vencer o ${e}.`)}catch(e){console.error("Erro ao dar moedas pela vit\xF3ria no Jogo da Vantagem:",e)}const a=getSemanaAtual(),o=`semana_${a.numero}_${a.inicio.getFullYear()}`,t=doc(db,"vantagemSemanal",o);await saveAdvantageCompletion();try{const a=await getDoc(t),o=a.exists()?a.data():{},n=o.completadoPor||{},i=new Set(Object.keys(n)),r=i.size,d=`<strong>${currentUser}</strong> finalizou o <strong>${e}</strong> e alcan√ßou a <strong>${r}¬™</strong> posi√ß√£o no placar!`;if(await adicionarEventoAoFeed("vantagem","\uD83C\uDFAF Desafio Conclu\xEDdo!",d,{nomeMembro:currentUser,jogo:e,posicao:r}),userTeam){const e=equipes[userTeam].membros,a=e.every(e=>i.has(e.nome)),n=o.equipesComBonusGarantido||[];if(a&&!n.includes(userTeam)){console.log(`Equipe ${userTeam} completou o desafio! Postando no feed.`);const e=userTeam.charAt(0).toUpperCase()+userTeam.slice(1);await adicionarEventoAoFeed("vantagem","\uD83C\uDFC6 B\xF4nus de Equipe Garantido!",`Miss√£o cumprida! Todos os membros da equipe <strong>${e}</strong> finalizaram o Jogo da Vantagem e garantiram o b√¥nus de <strong>+${3} pontos</strong> em sua m√©dia final no domingo!`,{equipe:userTeam}),await updateDoc(t,{equipesComBonusGarantido:arrayUnion(userTeam)})}}}catch(e){console.error("Erro ao processar feed de conclus\xE3o do Jogo da Vantagem:",e)}mostrarPopup(`üéâ Parab√©ns!`,`Voc√™ venceu o ${e}!`,5e3),dispararConfete(),tocarSom("som-conquista"),lockAdvantageSection("Desafio conclu\xEDdo! Volte na pr\xF3xima semana.")}async function startLeaderTestGame(e){isTestModeActive=!0,currentTestGameIndex=e;const a=todosOsJogos[e],o=document.getElementById("advantage-game-board"),t=document.getElementById("vantagem-jogo-nome");if(a&&o&&t){if(o.id="advantage-game-board",t.textContent=`Modo de Teste: ${a.nome}`,o.innerHTML=a.htmlContent,"Jogo da Forca"===a.nome){const e=await buscarPalavrasDisponiveis();if(0<e.length){const o=e[Math.floor(Math.random()*e.length)];a.initFunction(o)}else o.innerHTML="<h2>N\xE3o h\xE1 palavras dispon\xEDveis para testar a forca.</h2>"}else if("Quiz dos \xC9picos"===a.nome){const e=await gerarQuizDaSemana();e&&0<e.length?a.initFunction(e):o.innerHTML="<h2>N\xE3o foi poss\xEDvel gerar um quiz para o teste.</h2>"}else"Jogo da Mem\xF3ria"===a.nome&&(o.id="memory-game-board"),a.initFunction();document.getElementById("leader-test-panel").classList.add("hidden"),unlockAdvantageSection()}}function initMemoryGame(){function e(e){r||e.classList.contains("flipped")||!currentUser||(e.classList.add("flipped"),n.push(e),2===n.length&&a())}function a(){r=!0;const[e,a]=n,d=e.dataset.emoji===a.dataset.emoji;d?setTimeout(()=>{e.classList.add("matched"),a.classList.add("matched"),i++,i===t.length&&setTimeout(()=>handleGameWin("Jogo da Mem\xF3ria"),500),o()},600):setTimeout(()=>{e.classList.remove("flipped"),a.classList.remove("flipped"),o()},1200)}function o(){n=[],r=!1}const t=["\uD83E\uDDE0","\uD83D\uDD25","\uD83D\uDE80","\uD83D\uDC8E","\uD83C\uDFC6","\uD83C\uDF1E","\uD83E\uDDF8","\uD83D\uDC38"];let n=[],i=0,r=!1;const d=document.getElementById("advantage-game-board");d.className="memory-game-board",d.innerHTML="";const s=[...t,...t];s.sort(()=>.5-Math.random()),s.forEach(a=>{const o=document.createElement("div");o.classList.add("memory-card"),o.dataset.emoji=a,o.innerHTML=`<div class="card-face card-front"></div><div class="card-face card-back">${a}</div>`,o.addEventListener("click",()=>e(o)),d.appendChild(o)})}function initClickerGame(){function e(){r&&(r.style.display="none",u=0,p=l,n&&(n.textContent=`Pontos: 0 / ${s}`),i&&(i.textContent=`Tempo: ${p}`,i.classList.remove("ending")),g=setInterval(()=>{p--,i&&(i.textContent=`Tempo: ${p}`),5>=p&&i&&i.classList.add("ending"),0>=p&&o(!1)},1e3),f=setInterval(a,450))}function a(){if(!t)return;const e=document.createElement("div");e.classList.add("clicker-target");const a=["abelha","joaninha","vagalume"][Math.floor(3*Math.random())];e.classList.add(a),e.textContent=["\uD83D\uDC1D","\uD83D\uDC1E","\uD83D\uDCA1"][Math.floor(3*Math.random())],e.style.top=`${10+70*Math.random()}%`,e.style.left=`${10+70*Math.random()}%`,e.style.animation=`pop-in 0.3s ease-out, moveTarget ${m}s ease-in-out infinite`,e.onclick=()=>{u++,n&&(n.textContent=`Pontos: ${u} / ${s}`),e.classList.add("clicked"),u>=s&&o(!0),setTimeout(()=>e.remove(),300)},t.appendChild(e),setTimeout(()=>{e&&e.parentElement&&e.remove()},c)}function o(e){if(clearInterval(g),clearInterval(f),!!t)if(t.innerHTML="",e)handleGameWin("Acerte o Alvo");else{const e=document.createElement("div");e.innerHTML=`Tempo esgotado! Voc√™ fez ${u} pontos.<br>Tente novamente!`,e.style.fontSize="1.5rem",e.style.textAlign="center",t.appendChild(e),setTimeout(()=>{const e=todosOsJogos.find(e=>"Acerte o Alvo"===e.nome);if(e){const a=document.getElementById("advantage-game-board");a.innerHTML=e.htmlContent,initClickerGame()}},4e3)}}const t=document.getElementById("clicker-game-board"),n=document.getElementById("clicker-score"),i=document.getElementById("clicker-timer"),r=document.getElementById("clicker-start-button"),d="ontouchstart"in window||0<navigator.maxTouchPoints;let s,l,m,c;d?(s=40,l=25,m=4,c=1500):(s=20,l=45,m=8,c=2500);let u=0,p=l,g=null,f=null;r&&(r.onclick=e)}function initSimonGame(){function e(){u=!1,m=[],i.textContent=`N√≠vel: ${c}`;const e=Math.floor(4*Math.random());l.push(e),a()}async function a(){await new Promise(e=>setTimeout(e,700));for(let e=0;e<l.length;e++)await o(l[e]),await new Promise(e=>setTimeout(e,200));u=!0,i.textContent="Sua vez!"}function o(e){return new Promise(a=>{const o=document.getElementById(`simon-pad-${e}`);o.classList.add("active");try{const a=document.getElementById(`simon-sound-${e}`);a&&(a.currentTime=0,a.play())}catch(e){console.warn("N\xE3o foi poss\xEDvel tocar o som do jogo.",e)}setTimeout(()=>{o.classList.remove("active"),a()},500)})}function t(a){if(u){const t=parseInt(a.target.dataset.index,10);o(t),m.push(t);const i=m.length-1;return m[i]===l[i]?void(m.length===l.length&&(c>=s?n(!0):(c++,u=!1,setTimeout(e,1e3)))):void n(!1)}}function n(e){u=!1,e?handleGameWin("Sequ\xEAncia de Cores"):(i.textContent="Errado! Tente de novo.",setTimeout(()=>{document.getElementById("simon-game-board").innerHTML=`
                    <div id="simon-info-display">N√≠vel: 1</div>
                    <div id="simon-pads-container">
                        <div class="simon-pad" id="simon-pad-0" data-index="0"></div>
                        <div class="simon-pad" id="simon-pad-1" data-index="1"></div>
                        <div class="simon-pad" id="simon-pad-2" data-index="2"></div>
                        <div class="simon-pad" id="simon-pad-3" data-index="3"></div>
                    </div>
                    <button id="simon-start-button">Iniciar</button>
                `,initSimonGame()},3e3))}const i=document.getElementById("simon-info-display"),r=document.getElementById("simon-start-button"),d=document.querySelectorAll(".simon-pad"),s=8;let l=[],m=[],c=1,u=!1;r.onclick=function(){r.style.display="none",l=[],c=1,e()},d.forEach(e=>e.addEventListener("click",t))}function initTicTacToeGame(){function e(e){e&&(L=e),f=L,h="X"===f?"O":"X",u.classList.add("hidden"),p.classList.remove("hidden"),m.classList.remove("hidden"),y=!0,m.textContent=`Sua vez de jogar (${f})`}function a(a){if(!b&&y){const e=parseInt(a.target.dataset.cellIndex);if(null===E[e]){i(e,f);const a=r();return a.isFinished?void d(a):void(y=!1,m.textContent=`Vez do rob√¥ (${h})...`,setTimeout(o,700))}}}function o(){if(!b){const e=t();i(e,h);const a=r();return a.isFinished?void d(a):void(y=!0,m.textContent=`Sua vez de jogar (${f})`)}}function t(){for(const e of v){const a=n(e.combo,h);if(-1!==a)return a}for(const e of v){const a=n(e.combo,f);if(-1!==a)return a}const e=E.map((e,a)=>null===e?a:null).filter(e=>null!==e);return 0<e.length?e[Math.floor(Math.random()*e.length)]:E.findIndex(e=>null===e)}function n(e,a){const o=e.map(e=>E[e]);return 2===o.filter(e=>e===a).length&&o.includes(null)?e[o.indexOf(null)]:-1}function i(e,a){E[e]=a;const o=p.querySelector(`[data-cell-index='${e}']`);o.classList.add(a.toLowerCase())}function r(){for(const e of v){const[o,a,t]=e.combo;if(E[o]&&E[o]===E[a]&&E[o]===E[t])return{isFinished:!0,winner:E[o],lineClass:e.class,winningCombo:e.combo}}return E.every(e=>null!==e)?{isFinished:!0,winner:"tie"}:{isFinished:!1}}function d(e){if(b=!0,e.winner===f)m.textContent="Voc\xEA venceu! \uD83C\uDF89",g.className=`winning-line ${e.lineClass}`,e.winningCombo.forEach(e=>document.querySelector(`[data-cell-index='${e}']`).classList.add("highlight")),handleGameWin("Jogo da Velha");else if(e.winner===h){m.textContent="O rob\xF4 venceu!",g.className=`winning-line ${e.lineClass}`,e.winningCombo.forEach(e=>document.querySelector(`[data-cell-index='${e}']`).classList.add("highlight"));let a=3;m.textContent=`O rob√¥ venceu! Nova rodada em ${a}...`;const o=setInterval(()=>{a--,0<a?m.textContent=`O rob√¥ venceu! Nova rodada em ${a}...`:(clearInterval(o),s())},1e3)}else m.textContent="Deu velha! Tente novamente.",c.classList.remove("hidden")}function s(){E.fill(null),b=!1,document.querySelectorAll(".tictactoe-cell").forEach(e=>{e.className="tictactoe-cell"}),g.className="winning-line",c.classList.add("hidden"),e(null)}const l=document.getElementById("tictactoe-board-wrapper"),m=document.getElementById("tictactoe-status"),c=document.getElementById("tictactoe-restart-button"),u=document.getElementById("tictactoe-symbol-selection"),p=document.getElementById("tictactoe-board"),g=document.getElementById("tictactoe-winning-line");let f="X",h="O";const v=[{combo:[0,1,2],class:"line-h-0"},{combo:[3,4,5],class:"line-h-1"},{combo:[6,7,8],class:"line-h-2"},{combo:[0,3,6],class:"line-v-0"},{combo:[1,4,7],class:"line-v-1"},{combo:[2,5,8],class:"line-v-2"},{combo:[0,4,8],class:"line-d-0"},{combo:[2,4,6],class:"line-d-1"}];let E=Array(9).fill(null),y=!0,b=!1,L=null;document.getElementById("select-X").onclick=()=>e("X"),document.getElementById("select-O").onclick=()=>e("O"),document.querySelectorAll(".tictactoe-cell").forEach(e=>e.addEventListener("click",a)),c.addEventListener("click",function(){L=null,E.fill(null),b=!1,y=!0,document.querySelectorAll(".tictactoe-cell").forEach(e=>{e.className="tictactoe-cell"}),g.className="winning-line",c.classList.add("hidden"),p.classList.add("hidden"),m.classList.add("hidden"),u.classList.remove("hidden")})}async function initForcaGame(e){function a(){E=!1,f=[],h=0,d.textContent="Adivinhe a palavra!",l.textContent=`Dica: ${g}`,u.forEach(e=>e.style.display="none"),c.style.display="none",o(),t()}function o(){s.innerHTML="";for(const e of p){const a=document.createElement("div");a.classList.add("letra-placeholder"),f.includes(e)&&(a.textContent=e),s.appendChild(a)}}function t(){m.innerHTML="";[["Q","W","E","R","T","Y","U","I","O","P"],["SPACER_HALF","A","S","D","F","G","H","J","K","L","SPACER_HALF"],["SPACER_FULL","SPACER_HALF","Z","X","C","V","B","N","M","SPACER_HALF","SPACER_FULL"]].forEach(e=>{const a=document.createElement("div");a.classList.add("teclado-row"),e.forEach(e=>{if(e.startsWith("SPACER_")){const o=document.createElement("div");"SPACER_HALF"===e?o.className="teclado-spacer-half":"SPACER_FULL"==e&&(o.className="teclado-spacer-full"),a.appendChild(o)}else{const o=document.createElement("button");o.classList.add("teclado-btn"),o.textContent=e,o.onclick=()=>n(e,o),a.appendChild(o)}}),m.appendChild(a)})}function n(e,a){E||(a.disabled=!0,p.includes(e)?(f.push(e),a.classList.add("correta")):(h++,a.classList.add("errada"),i()),o(),r())}function i(){for(let e=0;e<h;e++)u[e]&&(u[e].style.display="block")}function r(){const e=p.split("").every(e=>f.includes(e));return e?(E=!0,d.textContent="Voc\xEA venceu! \uD83C\uDF89",void setTimeout(()=>handleGameWin("Jogo da Forca"),1e3)):void(h>=v&&(E=!0,d.textContent=`Voc√™ perdeu! Tente novamente.`,c.style.display="block"))}const d=document.getElementById("forca-status"),s=document.getElementById("palavra-forca"),l=document.getElementById("dica-forca"),m=document.getElementById("teclado-forca"),c=document.getElementById("forca-restart-button"),u=document.querySelectorAll(".enforcado .parte-corpo");let p="",g="",f=[],h=0;const v=6;let E=!1;return e&&e.palavra?void(p=e.palavra.toUpperCase(),g=e.dica,c.onclick=()=>{initForcaGame(e)},a()):(d.textContent="Erro ao carregar a palavra da semana!",void(m.innerHTML=""))}function embaralharArray(e){for(let a=e.length-1;0<a;a--){const o=Math.floor(Math.random()*(a+1));[e[a],e[o]]=[e[o],e[a]]}return e}async function gerarQuizDaSemana(){const e=getSemanaAtual(),a=`semana_${e.numero}_${e.inicio.getFullYear()}`,o=doc(db,"vantagemSemanal",a),t=doc(db,"configuracoes","quizMemberQueue"),n=await getDoc(o);if(n.exists()&&n.data().quizDaSemana)return console.log("Quiz da semana j\xE1 existe. Carregando..."),n.data().quizDaSemana;console.log("Gerando novo quiz para a semana...");const i=await getDoc(t);let r=i.exists()?i.data().queue:[];4>r.length&&(r=todosMembros.filter(e=>"lider"!==e.papel).map(e=>e.nome),embaralharArray(r));const d=r.splice(0,4);await setDoc(t,{queue:r}),console.log("Otimiza\xE7\xE3o: Usando dados de membros em cache para gerar o quiz...");const s={};todosMembros.forEach(e=>{const{nome:a,...o}=e;(o.filme||o.sonho||o.musica||o.curiosidade)&&(s[a]=o)});const l=[],m=[{key:"filme",template:"Qual o filme favorito de {membro}?"},{key:"sonho",template:"Atualmente, qual o maior sonho de {membro}?"},{key:"musica",template:"Qual dessas \xE9 a m\xFAsica que {membro} gosta muito?"},{key:"curiosidade",template:"Qual dessas curiosidades pertence a {membro}?"}];for(let e=0;e<d.length;e++){const a=d[e],o=s[a],t=m[e];if(!o||!o[t.key]||""===o[t.key].trim()||7>o[t.key].length)continue;const n=o[t.key];let i=[];const r=Object.keys(s).filter(e=>e!==a);embaralharArray(r);for(const e of r){const a=s[e];if(a&&a[t.key]&&""!==a[t.key].trim()&&a[t.key]!==n&&7<=a[t.key].length&&i.push(a[t.key]),3<=i.length)break}if(3>i.length)return[];const c=embaralharArray([n,...i]);l.push({pergunta:t.template.replace("{membro}",`<strong>${a}</strong>`),alternativas:c,resposta:n})}return 4>l.length?(console.warn("N\xE3o foi poss\xEDvel gerar 4 perguntas v\xE1lidas. Tentando novamente na pr\xF3xima vez."),[]):(await setDoc(o,{quizDaSemana:l},{merge:!0}),l)}function initQuizGame(e){function a(){if(s>=e.length)return void(l===e.length?handleGameWin("Quiz dos \xC9picos"):(i.textContent=`Voc√™ acertou ${l} de ${e.length}. Tente de novo!`,i.style.color="#e74c3c",setTimeout(()=>loadAdvantageState(),3e3)));const a=e[s];r.textContent=`Pergunta ${s+1} de ${e.length}`,t.innerHTML=a.pergunta,n.innerHTML="",i.textContent="",d.style.width=`${100*(s/e.length)}%`,a.alternativas.forEach(e=>{const t=document.createElement("button");t.className="user-panel-btn",t.innerHTML=e,t.onclick=()=>o(t,e,a.resposta),n.appendChild(t)})}function o(o,t,r){n.querySelectorAll("button").forEach(e=>e.disabled=!0),t===r?(o.classList.add("correta"),i.textContent="Resposta Certa!",i.style.color="#2ecc71",l++,s++,d.style.width=`${100*(s/e.length)}%`,setTimeout(a,2e3)):(o.classList.add("errada"),i.textContent="Incorreto! O jogo ser\xE1 reiniciado...",i.style.color="#e74c3c",setTimeout(()=>{mostrarPopup("\uD83D\uDD04 Tente de Novo","O quiz foi reiniciado. Preste mais aten\xE7\xE3o!",4e3),isTestModeActive?startLeaderTestGame(currentTestGameIndex):loadAdvantageState()},2500))}const t=document.getElementById("quiz-question"),n=document.getElementById("quiz-alternatives"),i=document.getElementById("quiz-feedback"),r=document.getElementById("quiz-question-number"),d=document.getElementById("quiz-progress-bar");let s=0,l=0;a()}async function carregarInstrucoes(){try{const e=doc(db,"regras","manual"),a=await getDoc(e);if(a.exists()){const e=a.data(),o=document.querySelector("#secao-instrucoes .secao-conteudo");o.innerHTML=`
          <h1>üìú Manual de Funcionamento e Din√¢micas do Grupo </h1>
          <div class="info-bloco">
            <h2>Lista de Foco</h2>
            <p>${e.Foco.replace(/\n/g,"<br>")}</p>
          </div>
          <div class="info-bloco">
            <h2>Dia de Folga</h2>
            <p>${e.Folga.replace(/\n/g,"<br>")}</p>
          </div>
          <div class="info-bloco">
            <h2>Nomea√ß√£o de L√≠deres</h2>
            <p>${e.Lider.replace(/\n/g,"<br>")}</p>
          </div>
          <div class="info-bloco">
            <h2>Medalhas Individuais</h2>
            <p>${e.Medalhas.replace(/\n/g,"<br>")}</p>
          </div>
          <div class="info-bloco">
            <h2>√Årvore √âpica</h2>
            <p>${e.√Årvore.replace(/\n/g,"<br>")}</p>
          </div>
        `,document.getElementById("secao-instrucoes").classList.remove("hidden")}else mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel encontrar o manual de instru\xE7\xF5es.",4e3)}catch(e){console.error("Erro ao carregar instru\xE7\xF5es:",e),mostrarPopup("\u274C Erro","Falha ao carregar as instru\xE7\xF5es.",4e3)}}async function carregarAdvertencias(){try{const e=doc(db,"regras","conduta"),a=await getDoc(e);if(a.exists()){const e=a.data(),o=document.querySelector("#secao-advertencias .secao-conteudo"),t=e=>`<ul>${e.split("\u2022").filter(e=>""!==e.trim()).map(e=>`<li>${e.trim()}</li>`).join("")}</ul>`;o.innerHTML=`
          <h1>‚ö†Ô∏è C√≥digo de Conduta e Advert√™ncias</h1>
          <div class="advertencia-card leve">
            <h2><span class="emoji">üü¢</span>Advert√™ncia Leve</h2>
            ${t(e.leve)}
          </div>
          <div class="advertencia-card media">
            <h2><span class="emoji">üü°</span>Advert√™ncia M√©dia</h2>
            ${t(e.media)}
          </div>
          <div class="advertencia-card grave">
            <h2><span class="emoji">üî¥</span>Advert√™ncia Grave</h2>
            ${t(e.grave)}
          </div>
          <div class="advertencia-card gravissima">
            <h2><span class="emoji">üü£</span>Advert√™ncia Grav√≠ssima</h2>
            ${t(e.gravissima)}
          </div>
          <div class="advertencia-card expulsao">
            <h2><span class="emoji">‚ö´</span>Expuls√£o</h2>
            ${t(e.expulsao)}
          </div>
        `,document.getElementById("secao-advertencias").classList.remove("hidden")}else mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel encontrar o c\xF3digo de conduta.",4e3)}catch(e){console.error("Erro ao carregar advert\xEAncias:",e),mostrarPopup("\u274C Erro","Falha ao carregar as advert\xEAncias.",4e3)}}function fecharSecoes(){document.getElementById("secao-instrucoes").classList.add("hidden"),document.getElementById("secao-advertencias").classList.add("hidden")}document.getElementById("btn-instrucoes").addEventListener("click",carregarInstrucoes),document.getElementById("btn-advertencias").addEventListener("click",carregarAdvertencias),document.querySelectorAll(".botao-fechar-secao").forEach(e=>{e.addEventListener("click",fecharSecoes)});async function calcularMembrosOciosos(){console.log("Calculando membros ociosos da semana...");const e=getSemanaAtual(new Date(new Date().setDate(new Date().getDate()-2))),a=e.inicio,o=e.fim,t=a.toISOString().slice(0,10),n=o.toISOString().slice(0,10),i=`semana_${e.numero}_${e.inicio.getFullYear()}`,r={};todosMembros.forEach(e=>{"lider"!==e.papel&&(r[e.nome]=0)});try{const e=query(collection(db,"presencas"),where("__name__",">=",t),where("__name__","<=",n)),a=await getDocs(e);a.forEach(e=>{const a=e.data();for(const[o,t]of Object.entries(a))t&&void 0!==r[o]&&r[o]++});const o=Object.entries(r).filter(([e,a])=>4>a).map(([e,a])=>({nome:e,contagem:a})),d=doc(db,"gerenciamentoSemanal",i);await setDoc(d,{ociosos:o,processado:!1}),console.log(`Encontrados ${o.length} membros ociosos. Dados salvos em ${i}.`)}catch(e){console.error("Erro ao calcular membros ociosos:",e)}}async function carregarEExibirMembrosOciosos(){const e=document.getElementById("secao-ociosos");if("lider"!==userRole)return void e.classList.add("hidden");e.classList.remove("hidden");const a=getHoje(),o=a.getDay(),t=document.getElementById("lista-ociosos"),n=document.getElementById("ociosos-descricao");if(t.innerHTML="<div class=\"ociosos-placeholder\">Calculando...</div>",0===o){const e=getSemanaAtual(new Date(new Date().setDate(a.getDate()-1))),o=`semana_${e.numero}_${e.inicio.getFullYear()}`,i=doc(db,"gerenciamentoSemanal",o);try{const e=await getDoc(i);if(!e.exists()||0===e.data().ociosos.length)return t.innerHTML="<div class=\"ociosos-placeholder\">Nenhum membro ficou abaixo da meta na semana passada.</div>",void(n.textContent="A\xE7\xF5es de final de semana: Nenhuma a\xE7\xE3o necess\xE1ria.");const a=e.data().ociosos;t.innerHTML="",n.textContent="A\xE7\xF5es de final de semana: Justifique os membros que apresentaram um motivo v\xE1lido ou expulse os que n\xE3o cumpriram a meta semanal.",a.forEach(e=>{const a=document.createElement("div");a.className="ocioso-item",a.innerHTML=`
                    <div class="ocioso-nome">${e.nome} (${e.contagem}/4 dias)</div>
                    <div class="ocioso-botoes">
                        <button class="ocioso-btn justificar" onclick="justificarMembro('${e.nome}', '${o}')">Justificar</button>
                        <button class="ocioso-btn expulsar" onclick="confirmarExpulsao('${e.nome}')">Expulsar</button>
                    </div>
                `,t.appendChild(a)})}catch(e){console.error("Erro ao carregar lista de ociosos de domingo:",e),t.innerHTML="<div class=\"ociosos-placeholder\">Erro ao carregar a lista.</div>"}}else{const e=getSemanaAtual(),a=formatarDataISO(e.inicio),i=getHojeISO();n.textContent=`An√°lise em tempo real: A lista abaixo mostra os membros que matematicamente n√£o podem mais atingir a meta de 4 dias de foco nesta semana.`;try{const e=query(collection(db,"presencas"),where("__name__",">=",a),where("__name__","<=",i)),n=await getDocs(e),r={};todosMembros.forEach(e=>{"lider"!==e.papel&&(r[e.nome]=0)}),n.forEach(e=>{const a=e.data();for(const o in a)a[o]&&void 0!==r[o]&&r[o]++});const d=Object.keys(r).filter(e=>{const a=r[e]||0;return 4-a>7-o}).map(e=>({nome:e,contagem:r[e]}));0===d.length?t.innerHTML="<div class=\"ociosos-placeholder\">At\xE9 o momento, todos os membros ainda podem atingir a meta.</div>":(t.innerHTML="",d.forEach(e=>{const a=document.createElement("div");a.className="ocioso-item",a.innerHTML=`<div class="ocioso-nome">${e.nome} (${e.contagem}/4 dias)</div>`,t.appendChild(a)}))}catch(e){console.error("Erro ao calcular ociosos em tempo real:",e),t.innerHTML="<div class=\"ociosos-placeholder\">Erro ao calcular a lista.</div>"}}}async function justificarMembro(e,a){if(!confirm(`Tem certeza que deseja justificar e remover '${e}' da lista de ociosos desta semana?`))return;const o=doc(db,"gerenciamentoSemanal",a);try{await runTransaction(db,async a=>{const t=await a.get(o);if(!t.exists())return;const n=t.data().ociosos,i=n.filter(a=>a.nome!==e);a.update(o,{ociosos:i})}),mostrarPopup("\u2705 Sucesso",`${e} foi justificado e removido da lista.`,4e3),await carregarEExibirMembrosOciosos()}catch(e){console.error("Erro ao justificar membro:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel processar a justiticativa.",4e3)}}function confirmarExpulsao(e){membroParaExpulsar=e,document.getElementById("member-to-expel-name").innerText=e,document.getElementById("confirm-expel-button").onclick=executarExpulsao,openModal("confirm-expel-modal")}async function executarExpulsao(){if(membroParaExpulsar){const e=membroParaExpulsar;console.log(`Iniciando processo de expuls√£o para: ${e}`);try{await deleteDoc(doc(db,"membros",e)),await adicionarEventoAoFeed("geral","\uD83D\uDEB6\u200D\u2642\uFE0F Despedida no Grupo",`O membro <strong>${e}</strong> n√£o faz mais parte do nosso grupo. Desejamos sucesso em sua jornada!`,{nomeMembro:e}),mostrarPopup("\uD83D\uDDD1\uFE0F Membro Expulso",`${e} foi removido permanentemente do sistema.`,5e3),membroParaExpulsar=null,closeModal("confirm-expel-modal"),await refreshAppUI()}catch(a){console.error(`Erro ao expulsar ${e}:`,a),mostrarPopup("\u274C Falha Grave",`Ocorreu um erro ao tentar expulsar ${e}.`,5e3)}}}function atualizarPodioEquipes(){const e=[{id:"abelha",vitorias:rankingGeral.abelha,elemento:document.getElementById("podio-abelha")},{id:"joaninha",vitorias:rankingGeral.joaninha,elemento:document.getElementById("podio-joaninha")},{id:"vagalume",vitorias:rankingGeral.vagalume,elemento:document.getElementById("podio-vagalume")}];e.sort((e,a)=>a.vitorias-e.vitorias),e.forEach(e=>{e.elemento&&e.elemento.classList.remove("podium-1","podium-2","podium-3")});let a=1;for(let o=0;o<e.length;o++)0<o&&e[o].vitorias<e[o-1].vitorias&&(a=o+1),e[o].elemento&&e[o].elemento.classList.add(`podium-${a}`)}async function verificarEConcederPremiacaoDiaria(){console.log("Verificando se a premia\xE7\xE3o di\xE1ria precisa ser concedida...");const e=new Date;e.setDate(e.getDate()-1);const a=formatarDataISO(e),o=doc(db,"appState","dailyPrizeState");try{const e=await getDoc(o),t=e.exists()?e.data().lastAwardedDate:null;t===a?console.log(`Premia√ß√£o para o dia ${a} j√° foi concedida anteriormente. Nenhuma a√ß√£o necess√°ria.`):(console.log(`Premia√ß√£o para o dia ${a} ainda n√£o foi concedida. Iniciando processo...`),await premiarTop5ConsistenciaDiaria(),await setDoc(o,{lastAwardedDate:a}),console.log(`Premia√ß√£o para ${a} conclu√≠da e registrada.`))}catch(e){console.error("Erro ao verificar ou conceder a premia\xE7\xE3o di\xE1ria:",e)}}async function premiarTop5ConsistenciaDiaria(){console.log("\uD83C\uDFC6 Iniciando premia\xE7\xE3o di\xE1ria do Top 5 por consist\xEAncia...");const e={1:recompensasConfig.top5Diario_1||25,2:recompensasConfig.top5Diario_2||20,3:recompensasConfig.top5Diario_3||15,4:recompensasConfig.top5Diario_4||10,5:recompensasConfig.top5Diario_5||5},a=new Date;a.setDate(a.getDate()-1);try{const o=await obterRankingSemanal(a),t=o.filter(e=>0<e.pontos).slice(0,5);if(0===t.length)return void console.log("N\xE3o houve membros com foco registrado ontem para formar um Top 5. Premia\xE7\xE3o pulada.");const n=writeBatch(db),i=[];t.forEach((a,o)=>{const t=o+1,r=e[t],d=doc(db,"membros",a.nome);n.update(d,{moedas:increment(r)}),a.nome===currentUser&&mostrarPopupMoedas(r),i.push(`<strong>${t}¬∫ ${a.nome}</strong> (${a.pontos} dias | +${r}üí∞)`)}),await n.commit();const r=`Os mais focados da semana! Estes foram os √âpicos no topo do ranking semanal ao final de ontem:<br>${i.join("<br>")}`;await adicionarEventoAoFeed("geral","\uD83C\uDFC6 Top 5 Consistentes do Dia!",r,{}),console.log(`‚úÖ Premia√ß√£o di√°ria do Top 5 por consist√™ncia conclu√≠da para ${t.length} membros.`)}catch(e){console.error("Erro ao premiar o Top 5 di\xE1rio por consist\xEAncia:",e)}}function criarAvatarPadrao(){const e=["corpo_1","corpo_2","corpo_3","corpo_4","corpo_5"],a=e[Math.floor(Math.random()*e.length)];return{fundo:"fundo_1",corpo:a,roupa:"roupa_1_cor_1",cabelo:null,rosto:"rosto_1",acessorio:[],enfeite_de_parede:[]}}async function carregarDadosAvatar(){if(0===todosOsItensAvatar.length)try{const e=await getDocs(collection(db,"loja_avatar_itens"));e.forEach(e=>{todosOsItensAvatar.push({docId:e.id,...e.data()})})}catch(e){console.error("Erro ao carregar itens da loja de avatar:",e)}unsubscribeAvatarListener&&unsubscribeAvatarListener();const e=doc(db,"membros",currentUser);unsubscribeAvatarListener=onSnapshot(e,e=>{if(e.exists()){const a=e.data();inventarioAvatarCache=a.inventarioAvatar||[],console.log("Cache de invent\xE1rio do avatar atualizado em tempo real.")}})}function verificarPermissaoParaItem(e,a){if(!a)return!0;switch(a){case"coroa_lider_geral":return"lider"===e.papel;case"coroa_abelha":return"lider-equipe"===e.papel&&"abelha"===e.equipe;case"coroa_joaninha":return"lider-equipe"===e.papel&&"joaninha"===e.equipe;case"coroa_vagalume":return"lider-equipe"===e.papel&&"vagalume"===e.equipe;case"placa_abelha":return"abelha"===e.equipe;case"placa_joaninha":return"joaninha"===e.equipe;case"placa_vagalume":return"vagalume"===e.equipe;}const o=todosOsItensAvatar.find(e=>e.variacoes.some(e=>e.id===a));if(o&&o.raro){if("bandeira_rara_1"===a)return!0===e.podeComprarBandeiraRara;const o=e.permissoesItensRaros||[];return o.includes(a)}return!0}async function verificarEAtualizarAvatar(e){console.log(`Verificando permiss√µes de avatar para: ${e.nome}...`);const a=e.avatar||criarAvatarPadrao(),o=e.inventarioAvatar||[],t=JSON.parse(JSON.stringify(a));t.roupa&&!verificarPermissaoParaItem(e,t.roupa)&&(t.roupa=null),t.cabelo&&!verificarPermissaoParaItem(e,t.cabelo)&&(t.cabelo=null),Array.isArray(t.acessorio)&&(t.acessorio=t.acessorio.filter(a=>verificarPermissaoParaItem(e,a))),Array.isArray(t.enfeite_de_parede)&&(t.enfeite_de_parede=t.enfeite_de_parede.filter(a=>verificarPermissaoParaItem(e,a)));const n=o.filter(a=>verificarPermissaoParaItem(e,a)),i=JSON.stringify(a)!==JSON.stringify(t),r=o.length!==n.length;if(i||r){console.warn(`Permiss√µes de avatar inv√°lidas detectadas para ${e.nome}. Atualizando...`);const a=doc(db,"membros",e.nome);try{await updateDoc(a,{avatar:t,inventarioAvatar:n}),mostrarPopup("\u2139\uFE0F Avatar Atualizado","Detectamos que voc\xEA possu\xEDa itens que n\xE3o s\xE3o mais permitidos para sua conta. Seu avatar foi ajustado automaticamente.",8e3),console.log("Avatar e invent\xE1rio corrigidos com sucesso no Firestore.")}catch(e){console.error("Erro cr\xEDtico ao tentar corrigir o avatar do usu\xE1rio:",e)}}else console.log(`Permiss√µes de avatar para ${e.nome} est√£o corretas. Nenhuma a√ß√£o necess√°ria.`)}async function renderizarAvatar(e,a){try{const o=await getDoc(doc(db,"membros",e));let t=criarAvatarPadrao();o.exists()&&o.data().avatar&&(t=o.data().avatar),renderizarAvatarConfig(a,t)}catch(o){console.error(`Erro ao renderizar avatar de ${e}:`,o),a.innerHTML=""}}function renderizarAvatarTemporario(e){renderizarAvatarConfig(e,avatarTemporario)}function encontrarUrlItemPorId(e){for(const a of todosOsItensAvatar)for(const o of a.variacoes)if(o.id===e)return o;return null}function encontrarSubcategoria(e){const a=todosOsItensAvatar.find(a=>a.variacoes.some(a=>a.id===e));return a?a.subcategoria:null}async function abrirEditorAvatar(){try{const e=await getDoc(doc(db,"membros",currentUser));e.exists()&&e.data().avatar?(avatarOriginal=JSON.parse(JSON.stringify(e.data().avatar)),avatarTemporario=JSON.parse(JSON.stringify(e.data().avatar))):(avatarOriginal=criarAvatarPadrao(),avatarTemporario=criarAvatarPadrao()),Array.isArray(avatarTemporario.enfeite_de_parede)||(avatarTemporario.enfeite_de_parede=[]),Array.isArray(avatarOriginal.enfeite_de_parede)||(avatarOriginal.enfeite_de_parede=[])}catch(e){console.error("Erro ao buscar avatar para edi\xE7\xE3o:",e),avatarTemporario=criarAvatarPadrao()}const e=document.getElementById("avatar-preview-editor");renderizarAvatarTemporario(e),e.onclick=abrirVisualizadorDoEditor,document.querySelector(".avatar-tab-btn[data-tab=\"inventario\"]").click(),openModal("avatar-editor-modal")}document.querySelectorAll("#estatisticas-banco-modal .avatar-tab-btn[data-tab-stats]").forEach(e=>{e.addEventListener("click",()=>{const a=e.dataset.tabStats;document.querySelectorAll("#estatisticas-banco-modal .avatar-tab-btn[data-tab-stats]").forEach(e=>e.classList.remove("ativo")),document.querySelectorAll("#estatisticas-banco-modal .avatar-tab-content").forEach(e=>e.classList.remove("ativo")),e.classList.add("ativo"),document.getElementById(`stats-tab-${a}`).classList.add("ativo")})});function popularInventario(){const e=document.getElementById("inventario-category-tabs"),a=document.getElementById("inventario-category-content");e.innerHTML="",a.innerHTML="";const o=todosOsItensAvatar.flatMap(e=>e.variacoes.map(a=>({...a,categoria:e.categoria,subcategoria:e.subcategoria||null,docId:e.docId,raro:e.raro||!1}))),t=o.filter(e=>inventarioAvatarCache.includes(e.id));["corpo","rosto","cabelo","roupa","acessorio","enfeite_de_parede","fundo"].forEach(o=>{let n;if(n="acessorio"===o?t.filter(e=>e.categoria===o&&!e.raro):"enfeite_de_parede"===o?t.filter(e=>e.categoria===o||e.raro):t.filter(e=>e.categoria===o),0<n.length){const t=document.createElement("button");t.className="avatar-category-tab",t.dataset.category=o,t.textContent=nomesCategorias[o],"enfeite_de_parede"===o&&t.classList.add("tab-raro"),e.appendChild(t);const i=document.createElement("div");if(i.id=`panel-inventario-${o}`,i.className="avatar-category-content-panel","acessorio"===o){const e=n.reduce((e,a)=>{const o=a.subcategoria||"outros";return e[o]||(e[o]=[]),e[o].push(a),e},{});for(const a in e){const o=document.createElement("h4");o.className="avatar-subcategory-header",o.textContent=nomesSubcategorias[a]||a.charAt(0).toUpperCase()+a.slice(1),i.appendChild(o);const t=document.createElement("div");t.className="avatar-item-grid",e[a].forEach(e=>{const a=document.createElement("div");if(a.className="avatar-item-card",avatarTemporario.acessorio?.includes(e.id)&&a.classList.add("selecionado"),"corpo"!==e.categoria&&"fundo"!==e.categoria){const o=avatarTemporario.corpo;if(o){const e=encontrarUrlItemPorId(o);e&&(a.innerHTML+=`<img src="${e.url}" alt="Tom de Pele" class="avatar-layer-preview">`)}if("acessorio"===e.categoria&&"chapeu"===e.subcategoria){const e=avatarTemporario.cabelo;if(e){const o=encontrarUrlItemPorId(e);o&&(a.innerHTML+=`<img src="${o.url}" alt="Cabelo" class="avatar-layer-preview">`)}}}a.innerHTML+=`<img src="${e.url}" alt="${e.nomeCor}" class="avatar-layer-preview">`,a.onclick=()=>selecionarItemInventario("acessorio",e.id,a),t.appendChild(a)}),i.appendChild(t)}}else{const e=document.createElement("div");if(e.className="avatar-item-grid","cabelo"===o||"roupa"===o){const a=document.createElement("div");a.className="avatar-item-card",a.innerHTML=`<div style="display:flex; justify-content:center; align-items:center; height:100%; font-size: 2rem; opacity: 0.5;">üö´</div>`,a.title="Remover item",avatarTemporario[o]||a.classList.add("selecionado"),a.onclick=()=>selecionarItemInventario(o,null,a),e.appendChild(a)}n.forEach(a=>{const t=document.createElement("div");t.className="avatar-item-card";const n=Array.isArray(avatarTemporario[o])?avatarTemporario[o].includes(a.id):avatarTemporario[o]===a.id;if(n&&t.classList.add("selecionado"),a.raro&&t.classList.add("raro-exclusivo"),"corpo"!==a.categoria&&"fundo"!==a.categoria){const e=avatarTemporario.corpo;if(e){const a=encontrarUrlItemPorId(e);a&&(t.innerHTML+=`<img src="${a.url}" alt="Tom de Pele" class="avatar-layer-preview">`)}if("acessorio"===a.categoria&&"chapeu"===a.subcategoria){const e=avatarTemporario.cabelo;if(e){const a=encontrarUrlItemPorId(e);a&&(t.innerHTML+=`<img src="${a.url}" alt="Cabelo" class="avatar-layer-preview">`)}}}t.innerHTML+=`<img src="${a.url}" alt="${a.nomeCor}" class="avatar-layer-preview">`,t.onclick=()=>selecionarItemInventario(o,a.id,t),e.appendChild(t)}),i.appendChild(e)}a.appendChild(i)}}),setupCategoryTabs("inventario")}function setupCategoryTabs(e){const a=document.getElementById(`${e}-category-tabs`),o=document.getElementById(`${e}-category-content`),t=a.querySelectorAll(".avatar-category-tab"),n=o.querySelectorAll(".avatar-category-content-panel");0===t.length||(t.forEach(a=>{a.addEventListener("click",()=>{t.forEach(e=>e.classList.remove("ativo")),n.forEach(e=>e.classList.remove("ativo")),a.classList.add("ativo");const o=a.dataset.category;document.getElementById(`panel-${e}-${o}`).classList.add("ativo")})}),t[0].click())}async function abrirModalExperimentar(e,a){const o=JSON.parse(JSON.stringify(avatarTemporario));if("acessorio"===e){Array.isArray(o.acessorio)||(o.acessorio=[]);const e=encontrarSubcategoria(a);o.acessorio=o.acessorio.filter(a=>encontrarSubcategoria(a)!==e),o.acessorio.push(a)}else"enfeite_de_parede"===e?(Array.isArray(o.enfeite_de_parede)||(o.enfeite_de_parede=[]),o.enfeite_de_parede.includes(a)||o.enfeite_de_parede.push(a)):o[e]=a;const t=document.getElementById("avatar-try-on-container");openModal("avatar-try-on-modal"),renderizarAvatarConfig(t,o)}function popularLojaAvatar(){const e=document.getElementById("loja-category-tabs"),a=document.getElementById("loja-category-content");e.innerHTML="",a.innerHTML="";["corpo","rosto","cabelo","roupa","acessorio","enfeite_de_parede","fundo"].forEach(o=>{let t;if(t="acessorio"===o?todosOsItensAvatar.filter(e=>e.categoria===o&&!e.raro):"enfeite_de_parede"===o?todosOsItensAvatar.filter(e=>e.categoria===o||e.raro):todosOsItensAvatar.filter(e=>e.categoria===o),0<t.length){const n=document.createElement("button");n.className="avatar-category-tab",n.dataset.category=o,n.textContent=nomesCategorias[o],"enfeite_de_parede"===o&&n.classList.add("tab-raro"),e.appendChild(n);const i=document.createElement("div");if(i.id=`panel-loja-${o}`,i.className="avatar-category-content-panel","acessorio"===o){const e=t.reduce((e,a)=>{const o=a.subcategoria||"outros";return e[o]||(e[o]=[]),e[o].push(a),e},{});for(const a in e){const o=document.createElement("h4");o.className="avatar-subcategory-header",o.textContent=nomesSubcategorias[a]||a.charAt(0).toUpperCase()+a.slice(1),i.appendChild(o);const t=document.createElement("div");t.className="avatar-item-grid",e[a].forEach(e=>{const a=e.variacoes[Math.floor(Math.random()*e.variacoes.length)],o=document.createElement("div");if(o.className="avatar-item-card","corpo"!==e.categoria&&"fundo"!==e.categoria){const a=avatarTemporario.corpo;if(a){const e=encontrarUrlItemPorId(a);e&&(o.innerHTML+=`<img src="${e.url}" alt="Tom de Pele" class="avatar-layer-preview">`)}if("acessorio"===e.categoria&&"chapeu"===e.subcategoria){const e=avatarTemporario.cabelo;if(e){const a=encontrarUrlItemPorId(e);a&&(o.innerHTML+=`<img src="${a.url}" alt="Cabelo" class="avatar-layer-preview">`)}}}o.innerHTML+=`<img src="${a.url}" alt="${e.nome}" class="avatar-layer-preview">`,o.onclick=()=>abrirModalVariacoes(e),t.appendChild(o)}),i.appendChild(t)}}else{const e=document.createElement("div");e.className="avatar-item-grid",t.forEach(a=>{const o=a.variacoes[Math.floor(Math.random()*a.variacoes.length)],t=document.createElement("div");if(t.className="avatar-item-card",a.raro&&t.classList.add("raro-exclusivo"),"corpo"!==a.categoria&&"fundo"!==a.categoria){const e=avatarTemporario.corpo;if(e){const a=encontrarUrlItemPorId(e);a&&(t.innerHTML+=`<img src="${a.url}" alt="Tom de Pele" class="avatar-layer-preview">`)}if("acessorio"===a.categoria&&"chapeu"===a.subcategoria){const e=avatarTemporario.cabelo;if(e){const a=encontrarUrlItemPorId(e);a&&(t.innerHTML+=`<img src="${a.url}" alt="Cabelo" class="avatar-layer-preview">`)}}}t.innerHTML+=`<img src="${o.url}" alt="${a.nome}" class="avatar-layer-preview">`,t.onclick=()=>abrirModalVariacoes(a),e.appendChild(t)}),i.appendChild(e)}a.appendChild(i)}}),setupCategoryTabs("loja")}function experimentarItemLoja(e,a,o){avatarTemporario[e]=a;const t=document.getElementById("avatar-preview-editor");renderizarAvatarTemporario(t);const n=o.parentElement;n.querySelectorAll(".variation-card").forEach(e=>e.classList.remove("selecionado")),o.classList.add("selecionado")}async function selecionarItemInventario(e,a,o){if("acessorio"===e){if(Array.isArray(avatarTemporario.acessorio)||(avatarTemporario.acessorio=[]),null===a){avatarTemporario.acessorio=[];const e=document.querySelectorAll("#avatar-tab-inventario .avatar-item-card");e.forEach(e=>e.classList.remove("selecionado")),o.classList.add("selecionado")}else{const e=encontrarSubcategoria(a);let t=null;for(const a of avatarTemporario.acessorio)if(encontrarSubcategoria(a)===e){t=a;break}if(avatarTemporario.acessorio.includes(a))avatarTemporario.acessorio=avatarTemporario.acessorio.filter(e=>e!==a),o.classList.remove("selecionado");else if(t){avatarTemporario.acessorio=avatarTemporario.acessorio.filter(e=>e!==t),avatarTemporario.acessorio.push(a);const e=o.parentElement;e.querySelectorAll(".avatar-item-card").forEach(e=>{e.onclick.toString().includes(t)&&e.classList.remove("selecionado")}),o.classList.add("selecionado")}else avatarTemporario.acessorio.push(a),o.classList.add("selecionado");const n=o.parentElement,i=Array.from(n.querySelectorAll(".avatar-item-card")).find(e=>e.onclick.toString().includes("null"));i&&i.classList.remove("selecionado")}}else if("enfeite_de_parede"===e){Array.isArray(avatarTemporario.enfeite_de_parede)||(avatarTemporario.enfeite_de_parede=[]);const e=avatarTemporario.enfeite_de_parede.indexOf(a);-1<e?(avatarTemporario.enfeite_de_parede.splice(e,1),o.classList.remove("selecionado")):(avatarTemporario.enfeite_de_parede.push(a),o.classList.add("selecionado"))}else{avatarTemporario[e]=a;const t=o.parentElement;t.querySelectorAll(".avatar-item-card").forEach(e=>e.classList.remove("selecionado")),o.classList.add("selecionado")}const t=document.getElementById("avatar-preview-editor");renderizarAvatarTemporario(t)}document.getElementById("avatar-save-btn").onclick=async function(){try{await updateDoc(doc(db,"membros",currentUser),{avatar:avatarTemporario}),mostrarPopup("\u2705 Sucesso!","Seu avatar foi salvo com sucesso.",4e3),closeModal("avatar-editor-modal");const e=document.getElementById("avatar-display-pessoal");await renderizarAvatar(currentUser,e)}catch(e){console.error("Erro ao salvar avatar:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel salvar seu avatar.",4e3)}};async function abrirModalVariacoes(e){const a=document.getElementById("variations-grid");document.getElementById("variations-item-name").textContent=e.nome,a.innerHTML="<p>Carregando...</p>";const o=document.getElementById("variations-item-description");e.raro&&e.variacoes[0]&&e.variacoes[0].descricao?(o.innerHTML=`<strong>Como obter:</strong> ${e.variacoes[0].descricao}`,o.classList.remove("hidden")):o.classList.add("hidden"),openModal("item-variations-modal");try{const o=await getDoc(doc(db,"membros",currentUser));if(!o.exists())throw"Membro n\xE3o encontrado.";const t=o.data(),n=t.moedas||0,i=t.inventarioAvatar||[];a.innerHTML="";for(const o of e.variacoes){const t=i.includes(o.id),r=n>=o.preco,d=await verificarPermissaoCompra(o.id),s=document.createElement("div");s.className="variation-card",e.raro&&s.classList.add("raro-exclusivo");const l=document.createElement("div");if(l.className="variation-image-container","corpo"!==e.categoria&&"fundo"!==e.categoria){const a=avatarTemporario.corpo;if(a){const e=encontrarUrlItemPorId(a);e&&(l.innerHTML+=`<img src="${e.url}" alt="Tom de Pele" class="avatar-layer-preview">`)}if("acessorio"===e.categoria&&"chapeu"===e.subcategoria){const e=avatarTemporario.cabelo;if(e){const a=encontrarUrlItemPorId(e);a&&(l.innerHTML+=`<img src="${a.url}" alt="Cabelo" class="avatar-layer-preview">`)}}}const m=document.createElement("img");m.src=o.url,m.alt=o.nomeCor,m.className="avatar-layer-preview",l.appendChild(m),s.appendChild(l);const c=document.createElement("div");c.className="variation-info";const u=document.createElement("div");u.innerHTML=`<div>${o.nomeCor}</div><div class="item-preco">${t?"Adquirido":`üí∞ ${o.preco}`}</div>`,c.appendChild(u);const p=document.createElement("div");if(p.style.marginTop="10px",t){const a=Array.isArray(avatarTemporario[e.categoria])?avatarTemporario[e.categoria].includes(o.id):avatarTemporario[e.categoria]===o.id,t=document.createElement("button");t.className="painel-btn btn-adicionar",t.textContent=a?"Equipado":"Equipar",t.disabled=a,a||(t.onclick=()=>{selecionarItemInventario(e.categoria,o.id,s),closeModal("item-variations-modal")}),p.appendChild(t)}else if(!d){const e=document.createElement("button");e.className="painel-btn btn-adicionar",e.textContent="\uD83D\uDD12",e.title="Item exclusivo",e.disabled=!0,p.appendChild(e)}else{const a=document.createElement("div");a.className="variation-button-container",a.style.display="flex",a.style.gap="8px",a.style.justifyContent="center";const t=document.createElement("button");t.className="painel-btn",t.style.backgroundColor="#3498db",t.textContent="Experimentar",t.onclick=()=>abrirModalExperimentar(e.categoria,o.id),a.appendChild(t);const n=document.createElement("button");n.textContent=r?"Comprar":"Insuficiente",r?(n.className="painel-btn btn-adicionar",n.onclick=()=>confirmarCompraAvatar(o.id,o.preco)):(n.className="painel-btn btn-remover",n.disabled=!0,n.title="Moedas insuficientes"),a.appendChild(n),p.appendChild(a)}c.appendChild(p),s.appendChild(c),a.appendChild(s)}}catch(e){console.error("Erro ao abrir modal de varia\xE7\xF5es:",e),a.innerHTML="<p>Ocorreu um erro ao carregar os itens.</p>"}}window.confirmarCompraAvatar=function(e,a){const o=encontrarUrlItemPorId(e);document.getElementById("confirm-purchase-text").innerHTML=`Voc√™ deseja comprar <strong>${o.nomeCor}</strong> por <strong>üí∞ ${a} moedas</strong>?`,document.getElementById("confirm-purchase-btn").onclick=()=>executarCompraAvatar(e,a),openModal("confirm-avatar-purchase-modal")};async function executarCompraAvatar(e,a){closeModal("confirm-avatar-purchase-modal");const o=doc(db,"membros",currentUser);try{await runTransaction(db,async t=>{const n=await t.get(o);if(!n.exists())throw"Membro n\xE3o encontrado.";const i=n.data().moedas||0;if(i<a)throw"Moedas insuficientes.";t.update(o,{moedas:increment(-a),inventarioAvatar:arrayUnion(e)})}),inventarioAvatarCache.push(e),mostrarPopup("\uD83C\uDF89 Compra Realizada!","O item foi adicionado ao seu invent\xE1rio.",4e3),closeModal("item-variations-modal"),popularLojaAvatar()}catch(e){console.error("Erro na compra do avatar:",e),mostrarPopup("\u274C Falha na Compra",e.toString(),4e3)}}document.getElementById("avatar-gallery-btn").onclick=async function(){const e=document.getElementById("gallery-grid-container");e.innerHTML="<p>Carregando avatares...</p>",openModal("avatar-gallery-modal");try{const a=await getDocs(collection(db,"membros"));e.innerHTML="",await Promise.all(a.docs.map(async a=>{const o=a.id,t=document.createElement("div");t.className="gallery-avatar-item",t.onclick=()=>abrirVisualizadorDeAvatar(o);const n=document.createElement("div");n.className="gallery-avatar-container";const i=document.createElement("div");i.className="gallery-avatar-nome",i.textContent=o,t.appendChild(n),t.appendChild(i),e.appendChild(t),await renderizarAvatar(o,n)}))}catch(a){console.error("Erro ao carregar galeria:",a),e.innerHTML="<p>Erro ao carregar a galeria.</p>"}};function avatarTemAlteracoesNaoSalvas(){return!!(avatarOriginal&&avatarTemporario)&&JSON.stringify(avatarOriginal)!==JSON.stringify(avatarTemporario)}window.tentarFecharEditorAvatar=function(){avatarTemAlteracoesNaoSalvas()?showConfirmationPopup("\u26A0\uFE0F Altera\xE7\xF5es n\xE3o Salvas","Voc\xEA tem altera\xE7\xF5es n\xE3o salvas. Deseja sair mesmo assim?",()=>{closeModal("avatar-editor-modal")}):closeModal("avatar-editor-modal")};async function abrirVisualizadorDeAvatar(e){const a=document.getElementById("avatar-viewer-container"),o=document.getElementById("avatar-viewer-nome");a.innerHTML="<p style=\"text-align: center; margin-top: 50%;\">Carregando...</p>",o.textContent=e,openModal("avatar-viewer-modal"),await renderizarAvatar(e,a)}function abrirVisualizadorDoEditor(){const e=document.getElementById("editor-avatar-viewer-container");renderizarAvatarTemporario(e),openModal("editor-avatar-viewer-modal")}async function verificarPermissaoCompra(e){if(!currentUser)return!1;const a=await getDoc(doc(db,"membros",currentUser));if(!a.exists())return!1;const o=a.data();switch(e){case"coroa_lider_geral":return"lider"===o.papel;case"coroa_abelha":return"lider-equipe"===o.papel&&"abelha"===o.equipe;case"coroa_joaninha":return"lider-equipe"===o.papel&&"joaninha"===o.equipe;case"coroa_vagalume":return"lider-equipe"===o.papel&&"vagalume"===o.equipe;case"placa_abelha":return"abelha"===o.equipe;case"placa_joaninha":return"joaninha"===o.equipe;case"placa_vagalume":return"vagalume"===o.equipe;default:const a=todosOsItensAvatar.find(a=>a.variacoes.some(a=>a.id===e));if(a&&a.raro){if("bandeira_rara_1"===e)return!0===o.podeComprarBandeiraRara;const a=o.permissoesItensRaros||[];return a.includes(e)}return!0;}}function renderizarAvatarConfig(e,a){if(e.innerHTML="",!!a){const o=["fundo","corpo","roupa","cabelo","rosto","acessorio","enfeite_de_parede"];for(const t of o){const o=a[t];if(Array.isArray(o)){for(const a of o)if(a){const o=encontrarUrlItemPorId(a);if(o){const n=document.createElement("img");n.src=o.url;const i="acessorio"===t?encontrarSubcategoria(a):"";n.className=`avatar-layer ${t} ${i||""}`,e.appendChild(n)}}}else if(o){const a=encontrarUrlItemPorId(o);if(a){const o=document.createElement("img");o.src=a.url,o.className=`avatar-layer ${t}`,e.appendChild(o)}}}}}function abrirModalAdicionarItemAvatar(){resetarFormularioItemAvatar(),openModal("add-avatar-item-modal")}async function popularListaMembrosPermissao(){const e=document.getElementById("add-item-membros-lista");if(e){e.innerHTML="<p>Carregando membros...</p>";const a=[...todosMembros].sort((e,a)=>e.nome.localeCompare(a.nome));e.innerHTML="",a.forEach(a=>{const o=document.createElement("div");o.style.marginBottom="8px",o.innerHTML=`
      <input type="checkbox" id="perm_${a.nome}" value="${a.nome}" class="membro-permissao-check">
      <label for="perm_${a.nome}" style="margin-left: 8px;">${a.nome}</label>
    `,e.appendChild(o)})}}function resetarFormularioItemAvatar(){document.getElementById("add-item-nome").value="",document.getElementById("add-item-categoria").value="",document.getElementById("add-item-raro").checked=!1,document.getElementById("add-item-raro-descricao").value="",document.getElementById("add-item-raro-descricao-container").classList.add("hidden"),document.getElementById("add-item-variations-container").innerHTML="",adicionarCampoVariacao()}function adicionarCampoVariacao(){const e=document.getElementById("add-item-variations-container"),a=document.createElement("div");a.style.display="grid",a.style.gridTemplateColumns="2fr 3fr 1fr auto",a.style.gap="10px",a.style.alignItems="center",a.innerHTML=`
    <input type="text" class="painel-input variation-nomeCor" placeholder="Nome da Cor (Ex: Azul)">
    <input type="text" class="painel-input variation-url" placeholder="Link da Imagem (URL)">
    <input type="number" class="painel-input variation-preco" placeholder="Pre√ßo üí∞">
    <button class="painel-btn btn-remover" onclick="this.parentElement.remove()">X</button>
  `,e.appendChild(a)}window.adicionarCampoVariacao=adicionarCampoVariacao;async function salvarItemAvatar(){const e=document.getElementById("add-item-nome").value.trim(),a=document.getElementById("add-item-categoria").value,o=document.getElementById("add-item-raro").checked,t=document.getElementById("add-item-raro-descricao").value.trim();if(!e||!a)return void mostrarPopup("\u274C Erro de Valida\xE7\xE3o","O Nome e a Categoria do item s\xE3o obrigat\xF3rios.",4e3);if(o&&!t)return void mostrarPopup("\u274C Erro de Valida\xE7\xE3o","Se o item \xE9 raro, voc\xEA deve fornecer uma descri\xE7\xE3o de como obt\xEA-lo.",5e3);let n=null;if("acessorio"===a&&(n=document.getElementById("add-item-subcategoria").value,!n))return void mostrarPopup("\u274C Erro de Valida\xE7\xE3o","Voc\xEA deve selecionar uma subcategoria para um acess\xF3rio.",4e3);const i=document.getElementById("add-item-variations-container"),r=i.children;if(0===r.length)return void mostrarPopup("\u274C Erro de Valida\xE7\xE3o","Voc\xEA deve adicionar pelo menos uma varia\xE7\xE3o de cor para o item.",4e3);const d=[];for(const n of r){const i=n.querySelector(".variation-nomeCor").value.trim(),r=n.querySelector(".variation-url").value.trim(),s=parseInt(n.querySelector(".variation-preco").value,10);if(!i||!r||isNaN(s))return void mostrarPopup("\u274C Erro de Valida\xE7\xE3o","Todos os campos de todas as varia\xE7\xF5es (Nome da Cor, URL e Pre\xE7o) devem ser preenchidos corretamente.",5e3);const l=e.toLowerCase().replace(/[^a-z0-9]/g,"_")+"_"+i.toLowerCase().replace(/[^a-z0-9]/g,"_");d.push({id:`${a}_${l}`,nomeCor:i,url:r,preco:s,descricao:o?t:""})}const s={nome:e,categoria:a,subcategoria:n,raro:o,variacoes:d};try{const a=e.toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_]/g,""),t=doc(db,"loja_avatar_itens",a),n=writeBatch(db);if(n.set(t,s),o){const e=document.querySelectorAll(".membro-permissao-check:checked");if(0<e.length){const a=d[0].id;e.forEach(e=>{const o=e.value,t=doc(db,"membros",o);n.update(t,{permissoesItensRaros:arrayUnion(a)})})}}await n.commit(),todosOsItensAvatar.push({docId:a,...s}),mostrarPopup("\u2705 Sucesso!",`O item "${e}" foi adicionado √† loja com sucesso!`,5e3),closeModal("add-avatar-item-modal")}catch(e){console.error("Erro ao salvar novo item de avatar:",e),mostrarPopup("\uD83D\uDD25 Erro Cr\xEDtico","N\xE3o foi poss\xEDvel salvar o item no banco de dados. Verifique o console.",5e3)}}function loadCSS(e){return new Promise((a,o)=>{const t=document.createElement("link");t.rel="stylesheet",t.href=e,t.onload=()=>a(),t.onerror=()=>o(new Error(`Falha ao carregar o CSS: ${e}`)),document.head.appendChild(t)})}async function abrirModalEnvioMoedas(){if(!currentUser||!userTeam)return void mostrarPopup("\u26A0\uFE0F Aten\xE7\xE3o","Voc\xEA precisa pertencer a uma equipe para enviar moedas.",4e3);const e=getHojeISO(),a=document.getElementById("envio-moedas-lista");if(!a)return console.error("Erro Cr\xEDtico: O container #envio-moedas-lista n\xE3o foi encontrado no HTML."),void mostrarPopup("\u274C Erro de Interface","N\xE3o foi poss\xEDvel abrir o painel de envio.",4e3);a.innerHTML="<div class=\"ociosos-placeholder\">Carregando...</div>",openModal("envio-moedas-modal");try{const o=doc(db,"enviosDiarios",`${currentUser}_${e}`),t=await getDoc(o),n=t.exists()?t.data().enviadoPara:[],i=todosMembros.filter(e=>e.equipe===userTeam&&e.nome!==currentUser);if(0===i.length)return void(a.innerHTML="<div class=\"ociosos-placeholder\">Voc\xEA n\xE3o tem colegas de equipe para enviar moedas.</div>");a.innerHTML="",i.forEach(e=>{const o=e.nome,t=n.includes(o),i=document.createElement("div");i.className="envio-membro-item",i.innerHTML=`
        <input type="checkbox" id="enviar-para-${o}" value="${o}" ${t?"checked disabled":""}>
        <label for="enviar-para-${o}">${o}</label>
        ${t?"<span class=\"status-enviado\">\u2714 Enviado</span>":""}
      `,a.appendChild(i)})}catch(e){console.error("Erro ao abrir modal de envio de moedas:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel carregar a lista de membros.",4e3),closeModal("envio-moedas-modal")}}async function executarEnvioMoedas(e){if(enviandoMoedas)return void console.warn("Uma opera\xE7\xE3o de envio de moedas j\xE1 est\xE1 em andamento. Aguarde.");enviandoMoedas=!0;const a="envio-moedas-modal"===e?"envio-moedas-lista":"envio-moedas-lista-popup",o=document.querySelectorAll(`#${a} input[type="checkbox"]:checked:not(:disabled)`);try{if(0===o.length)return void mostrarPopup("\uD83E\uDD14 Selecione","Voc\xEA precisa selecionar pelo menos um colega para enviar moedas.",4e3);const a=Array.from(o).map(e=>e.value),t=getHojeISO(),n=doc(db,"enviosDiarios",`${currentUser}_${t}`),i=writeBatch(db);a.forEach(e=>{const a=doc(db,"membros",e);i.update(a,{moedas:increment(100)});const o=doc(collection(db,"notificacoes"));i.set(o,{destinatarioId:e,remetenteNome:currentUser,tipo:"moedas",conteudo:"\uD83C\uDF81",acao:`enviou 100 üí∞ moedas para voc√™ como presente di√°rio!`,lida:!1,timestamp:new Date})}),i.set(n,{enviadoPara:a},{merge:!0}),await i.commit(),closeModal(e),mostrarPopup("\u2705 Sucesso!",`${100*a.length} moedas foram enviadas com sucesso!`,5e3)}catch(e){console.error("Erro ao enviar moedas:",e),mostrarPopup("\u274C Erro","Ocorreu uma falha ao enviar as moedas.",5e3)}finally{enviandoMoedas=!1}}async function verificarPopupEnvioDiario(){const e=sessionStorage.getItem("popupEnvioDiarioVisto");if(e||!currentUser||!userTeam)return;sessionStorage.setItem("popupEnvioDiarioVisto","true");const a=getHojeISO(),o=doc(db,"enviosDiarios",`${currentUser}_${a}`);try{const e=await getDoc(o);if(e.exists())return;const a=todosMembros.filter(e=>e.equipe===userTeam&&e.nome!==currentUser);if(0===a.length)return;const t=document.getElementById("envio-moedas-lista-popup");t.innerHTML="",a.forEach(e=>{const a=document.createElement("div");a.className="envio-membro-item",a.innerHTML=`
        <input type="checkbox" id="popup-enviar-para-${e.nome}" value="${e.nome}" checked>
        <label for="popup-enviar-para-${e.nome}">${e.nome}</label>
      `,t.appendChild(a)}),setTimeout(()=>{openModal("popup-envio-diario-moedas")},1500)}catch(e){console.error("Erro ao verificar popup de envio di\xE1rio:",e)}}function exibirPopupPoderesAtivos(){if(0===statusPoderesAtivos.length)return;let e="",a="",o="";if(statusPoderesAtivos.forEach(t=>{const n=t.expiraEm.toDate().toLocaleString("pt-BR",{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit"});"amuleto_protecao"===t.poderId&&t.equipeAlvo===userTeam?e+=`<li>üõ°Ô∏è <strong>Imunidade:</strong> Sua equipe est√° protegida contra maldi√ß√µes at√© ${n}.</li>`:t.equipeAlvo===userTeam&&("praga_kriptonita"===t.poderId||"runa_soft_block"===t.poderId)?a+=`<li>ü§¢ <strong>${t.nomePoder}:</strong> Sua equipe est√° sofrendo este efeito (usado por ${t.usadoPor}) at√© ${n}.</li>`:t.usadoPor===userTeam&&(t.equipeAlvo!==userTeam&&("praga_kriptonita"===t.poderId||"runa_soft_block"===t.poderId)?e+=`<li>‚öîÔ∏è <strong>${t.nomePoder}:</strong> Sua equipe est√° afetando a Equipe ${t.equipeAlvo} at√© ${n}.</li>`:"amuleto_falha"===t.poderId&&(o+=`<li>‚ùå <strong>Falha na Magia:</strong> Seu poder '${t.nomePoder}' contra a Equipe ${t.equipeAlvo} falhou (alvo protegido). Suas üí∞${t.valorReembolsado.toLocaleString("pt-BR")} moedas foram devolvidas ao banco. (Registro expira em: ${n})</li>`))}),""==e&&""===a&&""===o)return;let t="";e&&(t+="<h4 style=\"color: #2ecc71; margin-top: 0;\">Efeitos Ativos (Seus):</h4><ul>"+e+"</ul>"),a&&(t+="<h4 style=\"color: #e74c3c; margin-top: 15px;\">Efeitos Ativos (Contra Voc\xEA):</h4><ul>"+a+"</ul>"),o&&(t+="<h4 style=\"color: #f39c12; margin-top: 15px;\">Registros de Falha:</h4><ul>"+o+"</ul>"),setTimeout(()=>{mostrarCardPopup("\u2728 Status das Magias Ativas",t)},2500)}async function abrirModalNotificacoesSeNecessario(){await new Promise(e=>setTimeout(e,3500));const e=document.querySelector("#pix-recebido-popup.show, #medalha-ganha-popup.show, #recompensa-recebida-popup.show, #custom-card-popup.show, #popup-envio-diario-moedas.show");if(e)return void console.log("Modal de recompensa/pix/aviso est\xE1 aberto. O modal de notifica\xE7\xF5es n\xE3o ser\xE1 aberto agora.");if(currentUser)try{const e=query(collection(db,"notificacoes"),where("destinatarioId","==",currentUser),where("lida","==",!1),where("tipo","not-in",["moedas","recompensa_lider","recompensa_membro","medalha-presente"])),a=await getDocs(e);a.empty?console.log("Nenhuma notifica\xE7\xE3o comum n\xE3o lida para exibir no modal."):(console.log(`Encontradas ${a.size} notifica√ß√µes comuns. Abrindo o modal principal.`),marcarNotificacoesComoLidas(),openModal("notificacoes-modal"))}catch(e){console.error("Erro ao verificar notifica\xE7\xF5es para abertura autom\xE1tica do modal:",e)}}async function verificarNotificacoesRestantes(){const e=document.querySelector("#pix-recebido-popup.show, #medalha-ganha-popup.show, #recompensa-recebida-popup.show, #custom-card-popup.show, #popup-envio-diario-moedas.show, #recompensa-lideres-modal.show, #recompensa-equipe-modal.show");if(!e&&currentUser)try{const e=query(collection(db,"notificacoes"),where("destinatarioId","==",currentUser),where("lida","==",!1),where("tipo","not-in",["moedas","recompensa_lider","recompensa_membro","medalha-presente"])),a=await getDocs(e);a.empty||openModal("notificacoes-modal")}catch(e){console.error("Erro CR\xCDTICO ao verificar notifica\xE7\xF5es restantes:",e)}}async function acaoNormalFecharNotificacoes(){console.log("A\xE7\xE3o normal: Marcando como lidas, apagando e fechando.");try{await marcarNotificacoesComoLidas(),await apagarTodasAsNotificacoes(),closeModal("notificacoes-modal")}catch(e){console.error("Erro na a\xE7\xE3o normal de fechar notifica\xE7\xF5es:",e),closeModal("notificacoes-modal")}}async function toggleFeriasMembro(e,a){try{const o=doc(db,"membros",e);await updateDoc(o,{deFerias:a}),await refreshAppUI(),mostrarPopup("\u2705 Atualizado",`Status de f√©rias de ${e} foi alterado.`,3e3)}catch(a){console.error(`Erro ao atualizar status de f√©rias para ${e}:`,a),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel salvar a altera\xE7\xE3o.",4e3)}}function popularPainelFerias(){const e=document.getElementById("ferias-lista-membros");e.innerHTML="";const a=[...todosMembros].sort((e,a)=>e.nome.localeCompare(a.nome));a.forEach(a=>{if("lider"!==a.papel){const o=document.createElement("div");o.className="ferias-item";const t=a.deFerias?"checked":"";o.innerHTML=`
      <input type="checkbox" id="ferias_${a.nome}" ${t}>
      <label for="ferias_${a.nome}">${a.nome}</label>
    `,o.querySelector("input").addEventListener("change",o=>{toggleFeriasMembro(a.nome,o.target.checked)}),e.appendChild(o)}})}async function verificarPopupRecompensas(){const e=getHoje(),a=e.getDay(),o=getSemanaAtual(),t=doc(db,"appState",`popupState_${o.numero}_${o.inicio.getFullYear()}`);try{const o=await getDoc(t),n=o.exists()?o.data():{};if("lider"===userRole&&0===a){const e=n.liderGeralAvaliacaoVista||[];if(e.includes(currentUser))return;setTimeout(abrirPopupAvaliacaoLideres,2e3)}if("lider-equipe"===userRole&&(0===a||1===a)){const a=n.liderEquipeRecompensaVista||[];if(a.includes(currentUser))return;const o=getSemanaAtual(new Date(e.getTime()-86400000)),t=doc(db,"recompensasLideres",`semana_${o.numero}_${o.inicio.getFullYear()}`),i=await getDoc(t);i.exists()&&i.data().aprovados.includes(currentUser)&&setTimeout(abrirPopupRecompensaEquipe,2e3)}}catch(a){console.error("Erro ao verificar popups de recompensa:",a)}}function abrirPopupAvaliacaoLideres(){const e=todosMembros.filter(e=>"lider-equipe"===e.papel);if(0===e.length)return void mostrarPopup("\u2139\uFE0F Informa\xE7\xE3o","N\xE3o h\xE1 l\xEDderes de equipe para avaliar.",4e3);const a=document.getElementById("recompensa-lideres-lista");a.innerHTML="",e.forEach(e=>{const o=document.createElement("div");o.className="envio-membro-item",o.innerHTML=`
      <input type="checkbox" id="recompensa-lider-${e.nome}" value="${e.nome}" checked>
      <label for="recompensa-lider-${e.nome}">${e.nome} (${e.equipe})</label>
    `,a.appendChild(o)}),openModal("recompensa-lideres-modal")}function abrirPopupRecompensaEquipe(){const e=todosMembros.filter(e=>e.equipe===userTeam&&"membro"===e.papel);if(0===e.length)return void mostrarPopup("\u2139\uFE0F Informa\xE7\xE3o","Sua equipe n\xE3o possui membros para recompensar.",4e3);const a=document.getElementById("recompensa-equipe-lista");a.innerHTML="",e.forEach(e=>{const o=document.createElement("div");o.className="envio-membro-item",o.innerHTML=`
      <input type="checkbox" id="recompensa-membro-${e.nome}" value="${e.nome}">
      <label for="recompensa-membro-${e.nome}">${e.nome}</label>
    `,a.appendChild(o)}),openModal("recompensa-equipe-modal")}async function executarEnvioRecompensaLideres(){const e=document.querySelectorAll("#recompensa-lideres-lista input[type=\"checkbox\"]"),a=Array.from(e).filter(e=>e.checked).map(e=>e.value),o=todosMembros.filter(e=>"lider-equipe"===e.papel).map(e=>e.nome),t=o.filter(e=>!a.includes(e)),n=getSemanaAtual(),i=`semana_${n.numero}_${n.inicio.getFullYear()}`,r=doc(db,"recompensasLideres",i),d=doc(db,"appState",`popupState_${n.numero}_${n.inicio.getFullYear()}`),s=new Date,l=writeBatch(db),m=1e5,c=1e4;a.forEach(e=>{const a=doc(db,"membros",e);l.update(a,{moedas:increment(m)});const o=doc(collection(db,"notificacoes"));l.set(o,{destinatarioId:e,remetenteNome:"Sistema",tipo:"recompensa_lider",conteudo:"\uD83D\uDC51",acao:`voc√™ recebeu <strong>${m.toLocaleString("pt-BR")} üí∞ moedas</strong> em raz√£o da sua √≥tima lideran√ßa nesta semana. Muito obrigado pelo apoio!`,lida:!1,timestamp:s,valor:m,popupVisto:!1,agradecimentoEnviado:!1})}),t.forEach(e=>{const a=doc(db,"membros",e);l.update(a,{moedas:increment(c)});const o=doc(collection(db,"notificacoes"));l.set(o,{destinatarioId:e,remetenteNome:"Sistema",tipo:"aviso",conteudo:"\u26A0\uFE0F",acao:`sua lideran√ßa deixou a desejar nesta semana. Por isso, voc√™ recebeu <strong>${c.toLocaleString("pt-BR")} üí∞ moedas</strong> e n√£o ter√° acesso ao painel de recompensas da equipe.`,lida:!1,timestamp:s})}),l.set(r,{aprovados:a,avaliadoEm:s,processado:!0}),l.set(d,{liderGeralAvaliacaoVista:arrayUnion(currentUser)},{merge:!0});try{await l.commit(),closeModal("recompensa-lideres-modal"),mostrarPopup("\u2705 Pagamento Realizado!","A avalia\xE7\xE3o foi salva e os pagamentos aos l\xEDderes foram processados.",5e3)}catch(e){console.error("Erro ao salvar avalia\xE7\xE3o e pagar l\xEDderes:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel processar os pagamentos.",4e3)}}async function executarEnvioRecompensaEquipe(){const e=document.querySelectorAll("#recompensa-equipe-lista input[type=\"checkbox\"]:checked");if(0===e.length)return void mostrarPopup("\uD83E\uDD14 Aten\xE7\xE3o","Voc\xEA precisa selecionar pelo menos um membro para recompensar.",4e3);const a=document.getElementById("enviar-recompensa-equipe-btn");a.disabled=!0,a.textContent="Enviando...";const o=Array.from(e).map(e=>e.value),t=writeBatch(db),n=new Date,i=5e3;o.forEach(e=>{const a=doc(db,"membros",e);t.update(a,{moedas:increment(i)});const o=doc(collection(db,"notificacoes"));t.set(o,{destinatarioId:e,remetenteNome:currentUser,tipo:"recompensa_membro",conteudo:"\uD83C\uDFC6",acao:`reconheceu seu esfor√ßo e dedica√ß√£o nesta semana e te enviou <strong>${i.toLocaleString("pt-BR")} üí∞ moedas</strong> como forma de agradecimento e incentivo, parab√©ns!`,lida:!1,timestamp:n,valor:i,popupVisto:!1,agradecimentoEnviado:!1})});const r=getSemanaAtual(),d=doc(db,"appState",`popupState_${r.numero}_${r.inicio.getFullYear()}`);t.set(d,{liderEquipeRecompensaVista:arrayUnion(currentUser)},{merge:!0});try{await t.commit(),closeModal("recompensa-equipe-modal"),mostrarPopup("\u2705 Sucesso!",`${o.length} membro(s) foram recompensados com 5.000 moedas!`,5e3)}catch(e){console.error("Erro ao enviar recompensa da equipe:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel enviar as moedas.",4e3)}finally{a.disabled=!1,a.textContent="Enviar Recompensas"}}async function processarRecompensasLideres(){console.log("Processando recompensas de lideran\xE7a...");const e=getHoje(),a=getSemanaAtual(new Date(e.getTime()-86400000)),o=`semana_${a.numero}_${a.inicio.getFullYear()}`,t=doc(db,"recompensasLideres",o);try{const e=await getDoc(t);if(!e.exists()||e.data().processado)return void console.log("Recompensas de l\xEDderes n\xE3o encontradas ou j\xE1 processadas para esta semana.");const a=e.data().aprovados||[],o=todosMembros.filter(e=>"lider-equipe"===e.papel).map(e=>e.nome),n=o.filter(e=>!a.includes(e)),i=writeBatch(db);a.forEach(e=>{const a=doc(db,"membros",e);i.update(a,{moedas:increment(1e5)});const o=doc(collection(db,"notificacoes"));i.set(o,{destinatarioId:e,remetenteNome:"Sistema",tipo:"moedas",conteudo:"\uD83D\uDC51",acao:`voc√™ recebeu <strong>100.000 üí∞ moedas</strong> em raz√£o da sua √≥tima lideran√ßa nesta semana. Muito obrigado pelo apoio!`,lida:!1,timestamp:new Date})}),n.forEach(e=>{const a=doc(db,"membros",e);i.update(a,{moedas:increment(1e4)});const o=doc(collection(db,"notificacoes"));i.set(o,{destinatarioId:e,remetenteNome:"Sistema",tipo:"aviso",conteudo:"\u26A0\uFE0F",acao:`sua lideran√ßa deixou a desejar nesta semana. Por isso, voc√™ recebeu <strong>10.000 üí∞ moedas</strong> (metade da remunera√ß√£o) e n√£o ter√° acesso ao painel de recompensas da equipe.`,lida:!1,timestamp:new Date})}),i.update(t,{processado:!0}),await i.commit(),console.log("Recompensas de lideran\xE7a processadas com sucesso.")}catch(e){console.error("Erro cr\xEDtico ao processar recompensas de l\xEDderes:",e)}}window.abrirModalAutores=async function(e){const a=document.getElementById("autores-modal-titulo"),o=document.getElementById("autores-lista-container");a.textContent=`Autores do Desenho`,o.innerHTML="<div class=\"ociosos-placeholder\">Carregando artistas...</div>",openModal("autores-desenho-modal");try{const a=collection(db,`desenhos_${e}`),t=query(a),n=await getDocs(t);if(n.empty)return void(o.innerHTML="<div class=\"ociosos-placeholder\">Ningu\xE9m desenhou aqui ainda.</div>");const i=new Set;if(n.forEach(e=>{e.data().desenhadoPor&&i.add(e.data().desenhadoPor)}),0===i.size)return void(o.innerHTML="<div class=\"ociosos-placeholder\">Nenhum autor identificado.</div>");o.innerHTML="",i.forEach(e=>{const a=document.createElement("div");a.className="autores-item",a.textContent=e,o.appendChild(a)})}catch(e){console.error("Erro ao buscar autores do desenho:",e),o.innerHTML="<div class=\"ociosos-placeholder\">Erro ao carregar a lista.</div>"}};function carregarEExibirAvaliacoesDesenho(){const e=getSemanaAtual(),a=`semana_${e.numero}_${e.inicio.getFullYear()}`,o=doc(db,"vantagemSemanal",a);onSnapshot(o,e=>{const a=e.exists()?e.data().avaliacoesDesenho||{}:{};["abelha","joaninha","vagalume"].forEach(e=>{const o=a[e]||{likes:[],dislikes:[]},t=o.likes||[],n=o.dislikes||[],i=document.getElementById(`like-container-${e}`);if(i){const e=i.querySelector(".like-count");e.textContent=t.length;const a=t.includes(currentUser);i.classList.toggle("ativo",a),i.classList.toggle("like-ativo",a)}const r=document.getElementById(`dislike-container-${e}`);if(r){const e=r.querySelector(".dislike-count");e.textContent=n.length;const a=n.includes(currentUser);r.classList.toggle("ativo",a),r.classList.toggle("dislike-ativo",a)}})})}async function atualizarAvaliacaoOtimista(e,a){if(!currentUser||e===userTeam)return;const o=document.getElementById(`like-container-${e}`),t=document.getElementById(`dislike-container-${e}`);if(!o||!t)return;const n=o.querySelector(".like-count"),i=t.querySelector(".dislike-count"),r=o.classList.contains("ativo"),d=t.classList.contains("ativo");o.classList.remove("ativo","like-ativo"),t.classList.remove("ativo","dislike-ativo"),r&&(n.textContent=Math.max(0,parseInt(n.textContent)-1)),d&&(i.textContent=Math.max(0,parseInt(i.textContent)-1)),"like"!==a||r?"dislike"===a&&!d&&(t.classList.add("ativo","dislike-ativo"),i.textContent=parseInt(i.textContent)+1):(o.classList.add("ativo","like-ativo"),n.textContent=parseInt(n.textContent)+1)}window.abrirModalAvaliadores=async function(e,a){const o=document.getElementById("avaliadores-modal-titulo"),t=document.getElementById("avaliadores-lista-container"),n=e.charAt(0).toUpperCase()+e.slice(1);o.textContent="likes"===a?`Curtiram o Desenho`:`N√£o Curtiram o Desenho`,t.innerHTML="<div class=\"ociosos-placeholder\">Carregando...</div>",openModal("avaliadores-desenho-modal");try{const o=getSemanaAtual(),n=`semana_${o.numero}_${o.inicio.getFullYear()}`,i=doc(db,"vantagemSemanal",n),r=await getDoc(i),d=r.exists()?r.data().avaliacoesDesenho||{}:{},s=d[e]||{},l=s[a]||[];if(0===l.length)return void(t.innerHTML=`<div class="ociosos-placeholder">Ningu√©m avaliou desta forma ainda.</div>`);t.innerHTML="",l.forEach(e=>{const a=document.createElement("div");a.className="autores-item",a.textContent=e,t.appendChild(a)})}catch(e){console.error("Erro ao buscar avaliadores do desenho:",e),t.innerHTML="<div class=\"ociosos-placeholder\">Erro ao carregar a lista.</div>"}},window.avaliarDesenho=async function(e,a){if(e===userTeam)return void mostrarPopup("\uD83D\uDEAB A\xE7\xE3o Inv\xE1lida","Voc\xEA n\xE3o pode avaliar o desenho da sua pr\xF3pria equipe.",4e3);atualizarAvaliacaoOtimista(e,a);const o=getSemanaAtual(),t=`semana_${o.numero}_${o.inicio.getFullYear()}`,n=doc(db,"vantagemSemanal",t);try{const o=await runTransaction(db,async o=>{const t=await o.get(n),i=t.exists()?t.data():{},r=i.avaliacoesDesenho||{};r[e]||(r[e]={likes:[],dislikes:[]});const d=i.avaliacaoFeedEvents||{};d[e]||(d[e]={});const s=r[e].likes||[],l=r[e].dislikes||[],m=s.indexOf(currentUser),c=l.indexOf(currentUser);let u="removeu a avalia\xE7\xE3o";if(-1<m){const a=`${currentUser}_like`;d[e][a]&&(o.delete(doc(db,"resumoSemanalFeed",d[e][a])),delete d[e][a]),s.splice(m,1)}if(-1<c){const a=`${currentUser}_dislike`;d[e][a]&&(o.delete(doc(db,"resumoSemanalFeed",d[e][a])),delete d[e][a]),l.splice(c,1)}return"like"===a&&-1===m?(s.push(currentUser),u="avaliou com \uD83D\uDC4D"):"dislike"==a&&-1===c&&(l.push(currentUser),u="avaliou com \uD83D\uDC4E"),o.set(n,{avaliacoesDesenho:r,avaliacaoFeedEvents:d},{merge:!0}),u});if("removeu a avalia\xE7\xE3o"!==o){const t=e.charAt(0).toUpperCase()+e.slice(1),i=`<strong>${currentUser}</strong> ${o} o desenho da equipe <strong>${t}</strong>.`,r=await adicionarEventoAoFeed("geral","\uD83C\uDFA8 Nova Avalia\xE7\xE3o de Desenho!",i);if(r){const o=`${currentUser}_${a}`;await updateDoc(n,{[`avaliacaoFeedEvents.${e}.${o}`]:r})}}if("avaliou com \uD83D\uDC4D"===o){const a=new Set;try{const o=collection(db,`desenhos_${e}`),t=query(o),n=await getDocs(t);if(n.forEach(e=>{e.data().desenhadoPor&&a.add(e.data().desenhadoPor)}),0<a.size){const o=writeBatch(db),t=e.charAt(0).toUpperCase()+e.slice(1);a.forEach(e=>{if(e!==currentUser){const a=doc(collection(db,"notificacoes"));o.set(a,{destinatarioId:e,remetenteNome:currentUser,tipo:"desenho-like",conteudo:"\uD83C\uDFA8\u2764\uFE0F",acao:`curtiu o desenho da Equipe ${t}! "Sua arte foi apreciada! Continue colorindo nosso dia."`,lida:!1,timestamp:new Date})}}),await o.commit(),console.log(`Notifica√ß√µes de curtida enviadas para ${a.size} autor(es).`)}}catch(e){console.error("N\xE3o foi poss\xEDvel buscar os autores do desenho para notificar:",e)}}}catch(e){console.error("Erro ao avaliar desenho:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel registrar sua avalia\xE7\xE3o. Por favor, recarregue a p\xE1gina.",4e3)}};function configurarOuvintesDePreviewDesenho(){const e=getSemanaAtual(),a=`semana_${e.numero}_${e.inicio.getFullYear()}`,o=doc(db,"vantagemSemanal",a);onSnapshot(o,e=>{const a=e.exists()?e.data().desenhoPreviews||{}:{};["abelha","joaninha","vagalume"].forEach(e=>{const o=document.getElementById(`preview-container-${e}`);if(!o)return;const t=o.querySelector("canvas"),n=t.getContext("2d"),i=t.getBoundingClientRect();(t.width!==i.width||t.height!==i.height)&&(t.width=i.width,t.height=i.height);const r=a[e];if(n.clearRect(0,0,t.width,t.height),r&&r.imageDataURL){const e=new Image;e.onload=function(){n.drawImage(e,0,0,t.width,t.height)},e.src=r.imageDataURL}})})}function inicializarGemini(){try{genAI=new GoogleGenerativeAI("AIzaSyAT6zuiu16vJUwARNDS4lUxrkN9Bc8_wGM"),console.log("Cliente Gemini inicializado com sucesso.")}catch(e){console.error("Erro ao inicializar o Gemini:",e),adicionarMensagemIA("Desculpe, n\xE3o consegui me conectar ao assistente de IA. Verifique a chave de API no c\xF3digo.")}}async function callGenerativeAIWithRetry(e,a=3){for(let o=1;o<=a;o++)try{const a=genAI.getGenerativeModel({model:"gemini-2.5-flash-lite"}),o=await a.generateContent(e),t=await o.response;return t.text()}catch(e){if(console.error(`Tentativa ${o} de chamar a IA falhou:`,e),e.message&&(e.message.includes("[503]")||e.message.includes("[500]"))){if(o===a)throw new Error("O modelo da IA continua sobrecarregado ap\xF3s v\xE1rias tentativas.");const e=1e3*Math.pow(2,o);console.log(`Modelo sobrecarregado. Tentando novamente em ${e/1e3}s...`),await new Promise(a=>setTimeout(a,e))}else throw e}}async function carregarBaseDeConhecimento(){try{baseDeConhecimentoTexto=`
T√≥pico: Medalhas (de Foco)
Conte√∫do: Medalhas de Foco (ex: üî•, üëë, üåü) s√£o conquistas individuais baseadas no seu 'streak', que √© o n√∫mero de dias consecutivos de foco. Existem medalhas para 3, 10, 30, 60 dias e assim por diante.

---

T√≥pico: Medalhas de Honra (üèÖ)
Conte√∫do: Medalhas de Honra (ex: Medalha da Coragem, Medalha da Sabedoria) s√£o itens colecion√°veis e raros. Elas n√£o s√£o autom√°ticas e s√≥ podem ser concedidas por um L√≠der de Equipe ou pelo L√≠der Geral como forma de reconhecimento por feitos excepcionais. Elas ficam expostas em um quadro de medalhas no perfil do membro.

---

T√≥pico: Moedas (üí∞)
Conte√∫do: Voc√™ ganha moedas ao focar diariamente, postar no mural, reagir a conte√∫dos, vencer o jogo da vantagem e com a vit√≥ria semanal da sua equipe. Moedas s√£o usadas para comprar casas, itens de avatar, e podem ser depositadas no Banco da Equipe.

---

T√≥pico: Banco da Equipe (üí∏)
Conte√∫do: Cada equipe (Abelha, Joaninha, Vagalume) tem seu pr√≥prio banco. Membros podem depositar moedas pessoais no banco para aumentar o saldo coletivo. O saldo do banco cresce 0.5% ao dia com juros.

---

T√≥pico: Lojinha de Magias (üîÆ)
Conte√∫do: A Lojinha de Magias √© onde os L√≠deres de Equipe podem gastar as moedas do Banco da Equipe para comprar poderes. Existem poderes de b√¥nus (como o Elixir de Vida, que d√° +2 pontos na m√©dia) e poderes de ataque (como a Maldi√ß√£o da Pilantragem, que tira -2 pontos de um advers√°rio). O uso de poderes afeta diretamente a competi√ß√£o semanal.

---

T√≥pico: Jogo da Vantagem
Conte√∫do: √â um desafio semanal dispon√≠vel de Segunda a Sexta. Se todos os membros de uma equipe completarem o jogo, a equipe ganha um b√¥nus na sua pontua√ß√£o final da semana.

---

T√≥pico: Competi√ß√£o de Equipes
Conte√∫do: A competi√ß√£o ocorre de Segunda a S√°bado. A equipe com a maior m√©dia de pontos no final da semana vence e ganha +1 ponto no ranking geral. Membros da equipe vencedora tamb√©m ganham um b√¥nus em moedas.

---

T√≥pico: C√≥digo de Conduta e Advert√™ncias
Conte√∫do: ‚ö†Ô∏è C√≥digo de Conduta e Advert√™ncias üü¢ Advert√™ncia Leve: Receber√° advert√™ncia leve o participante que infringir as regras n√∫mero 1 (divulgar outros grupos sem autoriza√ß√£o) e 2 (enviar links de sites desconhecidos) do grupo. Tamb√©m receber√° advert√™ncia leve o participante que errar o padr√£o de cores das plantas ao plantar no deserto do Focus Plant. üü° Advert√™ncia M√©dia: Receber√° advert√™ncia m√©dia o participante que deixar de focar, sem dar nenhuma satisfa√ß√£o, por mais de 4 dias na semana (sem contar o domingo). Tamb√©m receber√° advert√™ncia m√©dia o participante que infringir a regra n√∫mero 3 do grupo (Chamar no PV sem autoriza√ß√£o, com exce√ß√£o do Adm). üî¥ Advert√™ncia Grave: Receber√° advert√™ncia grave o participante que infringir a regra n√∫mero 4 do grupo (enviar pornografia e/ou conte√∫dos expl√≠citos). Tamb√©m receber√° advert√™ncia grave o participante promovido a oficial que alterar a bio do grupo no Focus Plant ou expulsar algum integrante sem autoriza√ß√£o. üü£ Advert√™ncia Grav√≠ssima: Receber√° advert√™ncia grav√≠ssima o participante que infringir a regra n√∫mero 5 do grupo (praticar preconceito, discrimina√ß√£o e/ou discurso de √≥dio). Tamb√©m receber√° advert√™ncia grav√≠ssima o participante que ficar 7 dias off-line no Focus Plant, sem dar nenhuma satisfa√ß√£o. ‚ö´ Expuls√£o: Ser√° expulso do grupo o participante que acumular qualquer um dos n√∫meros de advert√™ncias a seguir: 2 advert√™ncias leves; 2 advert√™ncias medias; 2 advert√™ncias graves; 1 advert√™ncia grav√≠ssima. Ou se, por vota√ß√£o criada pelo l√≠der, a equipe do participante decida expuls√°-lo.

---

T√≥pico: √Årvore √âpica
Conte√∫do: A √Årvore √âpica √© um objetivo coletivo. Se 10 ou mais membros focarem no mesmo dia, a √°rvore avan√ßa um dia em seu crescimento. Ela passa por fases, de semente a frutos.

---

T√≥pico: Foco Di√°rio
Conte√∫do: O foco di√°rio deve ter no m√≠nimo 40 minutos. Ao concluir, marque a caixa de sele√ß√£o ao lado do seu nome para registrar sua presen√ßa e ganhar pontos e moedas.
    `,console.log("Base de conhecimento local carregada.")}catch(e){console.error("Erro ao carregar base de conhecimento local:",e),adicionarMensagemIA("N\xE3o consegui carregar as regras do grupo. Houve um erro interno no c\xF3digo.")}}function adicionarMensagemUsuario(e){const a=document.getElementById("chat-ia-messages");a.innerHTML+=`<div class="chat-message user">${e}</div>`,a.scrollTop=a.scrollHeight}function adicionarMensagemIA(e){const a=document.getElementById("chat-ia-messages"),o=a.querySelector(".thinking");o&&o.remove();const t=marked.parse(e);a.innerHTML+=`<div class="chat-message ia">${t}</div>`,a.scrollTop=a.scrollHeight}async function obterContextoDinamicoParaIA(){const e=new Date,a=getDiaSemanaString(e);let o="Ningu\xE9m completou ainda.";try{const e=getSemanaAtual(),a=`semana_${e.numero}_${e.inicio.getFullYear()}`,t=doc(db,"vantagemSemanal",a),n=await getDoc(t);if(n.exists()&&n.data().completadoPor){const e=n.data().completadoPor,a=Object.entries(e).map(([e,a])=>({nome:e,tempo:a.toDate()})).sort((e,a)=>e.tempo-a.tempo);0<a.length&&(o=a.map((e,a)=>`${a+1}¬∫: ${e.nome}`).join(", "))}}catch(a){console.error("Erro ao buscar dados do Jogo da Vantagem:",a),o="N\xE3o foi poss\xEDvel carregar os dados."}let t="Nenhum evento importante registrado ainda.";feedEventosCache&&0<feedEventosCache.length&&(t=feedEventosCache.slice(0,5).map(e=>{const a=e.texto.replace(/<[^>]*>/g," ");return`- ${e.titulo}: ${a.trim()}`}).join("\n"));let n="O mural de mensagens est\xE1 vazio no momento.",i="Ningu\xE9m contribuiu nos desenhos ainda.",r="Calend\xE1rio do Grupo (Anivers\xE1rios e Folgas):\n",d="Informa\xE7\xF5es Pessoais dos Membros:\n";try{const[e,a,o,t]=await Promise.all([getDocs(query(collection(db,"mural"),orderBy("timestamp","desc"),limit(7))),getDocs(query(collection(db,`desenhos_abelha`))),getDocs(query(collection(db,`desenhos_joaninha`))),getDocs(query(collection(db,`desenhos_vagalume`)))]);e.empty||(n="Mural de Mensagens Recentes:\n"+e.docs.map(e=>{const a=e.data(),o=a.texto.replace(/<[^>]*>/g," ").trim();return`- ${a.nome}: "${o}"`}).join("\n"));const r={abelha:new Set,joaninha:new Set,vagalume:new Set};a.forEach(e=>e.data().desenhadoPor&&r.abelha.add(e.data().desenhadoPor)),o.forEach(e=>e.data().desenhadoPor&&r.joaninha.add(e.data().desenhadoPor)),t.forEach(e=>e.data().desenhadoPor&&r.vagalume.add(e.data().desenhadoPor));const d=Object.entries(r).filter(([,e])=>0<e.size).map(([e,a])=>`- Equipe ${e.charAt(0).toUpperCase()+e.slice(1)}: Desenhado por (${Array.from(a).join(", ")})`);0<d.length&&(i="Status das Telas de Desenho:\n"+d.join("\n"))}catch(a){console.error("Erro ao buscar dados do mural ou desenhos:",a)}todosMembros.forEach(e=>{const a=e.aniversario?`Anivers√°rio (${e.aniversario})`:"Anivers\xE1rio (n\xE3o informado)",o=e.folga?`Folga (${e.folga})`:"Folga (n\xE3o informada)";r+=`- ${e.nome}: ${a}, ${o}\n`;const t=[];e["me chamo"]&&t.push(`Nome Real: ${e["me chamo"]}`),e.apelido&&t.push(`Apelido: ${e.apelido}`),e.filme&&t.push(`Filme: ${e.filme}`),e.sonho&&t.push(`Sonho: ${e.sonho}`),e.musica&&t.push(`M√∫sica: ${e.musica}`),e.curiosidade&&t.push(`Curiosidade: ${e.curiosidade}`),0<t.length&&(d+=`- ${e.nome}: ${t.join(", ")}\n`)});let s="Estrutura das Equipes e Membros (Tamanho da Equipe):\n";for(const e in liderGeral&&(s+=`- L√≠der Geral: ${liderGeral.nome}\n`),equipes){const a=equipes[e];s+=`\nEquipe ${e.charAt(0).toUpperCase()+e.slice(1)} (Total: ${a.membros.length} membros):\n`,a.lider&&(s+=`  - L√≠der da Equipe: ${a.lider.nome}${a.lider.deFerias?" (F\xC9RIAS)":""}\n`);const o=a.membros.filter(e=>"membro"===e.papel).map(e=>e.nome+(e.deFerias?" (F\xC9RIAS)":"")).join(", ");s+=`  - Membros: ${o||"(Nenhum membro)"}\n`}const l=document.getElementById("media-abelha")?.textContent||"N/A",m=document.getElementById("media-joaninha")?.textContent||"N/A",c=document.getElementById("media-vagalume")?.textContent||"N/A",u=`
---
INFORMA√á√ïES EM TEMPO REAL (ESTADO ATUAL DO GRUPO):

${n}
---
${i}
---
${r}
---
${d}
---
- Data de Hoje: ${a}
${s}

Placar da Competi√ß√£o Semanal (M√âDIA NIVELADA):
- Equipe Abelha: ${l} pontos de m√©dia.
- Equipe Joaninha: ${m} pontos de m√©dia.
- Equipe Vaga-lume: ${c} pontos de m√©dia.

Ranking Geral de Vit√≥rias:
- Equipe Abelha: ${rankingGeral.abelha} vit√≥rias.
- Equipe Joaninha: ${rankingGeral.joaninha} vit√≥rias.
- Equipe Vaga-lume: ${rankingGeral.vagalume} vit√≥rias.

Status do Jogo da Vantagem (quem terminou primeiro individualmente):
- ${o}

Acontecimentos Recentes (Resumo da Semana):
${t}
---
  `;return u}async function perguntarParaIA(){const e=document.getElementById("chat-ia-input"),a=e.value.trim();if(!a||!genAI)return;const o=50,t=doc(db,"membros",currentUser);try{const e=await getDoc(t);if(!e.exists())return void adicionarMensagemIA("Erro: N\xE3o consegui encontrar seus dados para verificar suas moedas.");const a=e.data().moedas||0;if(a<o)return void adicionarMensagemIA(`Voc√™ precisa de pelo menos ${o} üí∞ moedas para perguntar ao Or√°culo. Voc√™ tem apenas ${a}.`);await updateDoc(t,{moedas:increment(-50)})}catch(e){return console.error("Erro ao verificar ou debitar moedas:",e),void adicionarMensagemIA("Ocorreu um erro ao processar o pagamento da sua pergunta. Por favor, tente novamente.")}adicionarMensagemUsuario(a),e.value="";const n=a.toLowerCase();if(["oi","ol\xE1","ola","bom dia","boa tarde","boa noite","e a\xED","eae","salve"].includes(n)){const e=`Ol√°, ${currentUser}! Em que posso ajudar hoje?`;return adicionarMensagemIA(e),historicoConversaIA.push({role:"user",parts:[{text:a}]}),void historicoConversaIA.push({role:"model",parts:[{text:e}]})}if(["qual seu nome","seu nome \xE9","como voc\xEA se chama","qual \xE9 o seu nome","como te chamo","como posso te chamar"].some(e=>n.includes(e))){return adicionarMensagemIA("Pode me chamar apenas de Or\xE1culo."),historicoConversaIA.push({role:"user",parts:[{text:a}]}),void historicoConversaIA.push({role:"model",parts:[{text:"Pode me chamar apenas de Or\xE1culo."}]})}const i=document.getElementById("chat-ia-messages");i.innerHTML+=`<div class="chat-message ia thinking">Pensando...</div>`,i.scrollTop=i.scrollHeight;try{const e=todosMembros.find(e=>e.nome===currentUser),o=e["me chamo"]||currentUser;let t="Suas Informa\xE7\xF5es Pessoais:\n";const n=[];e["me chamo"]&&n.push(`- Nome Real: ${e["me chamo"]}`),e.filme&&n.push(`- Filme Favorito: ${e.filme}`),e.sonho&&n.push(`- Maior Sonho: ${e.sonho}`),e.musica&&n.push(`- M√∫sica Marcante: ${e.musica}`),e.curiosidade&&n.push(`- Uma Curiosidade: ${e.curiosidade}`),t+=0<n.length?n.join("\n"):"- Nenhuma informa\xE7\xE3o pessoal preenchida.";const i=streaksCache[currentUser]||0;let r=null;for(const e in medalhas)if(i<e){r={dias:e,nome:medalhas[e].nome,emoji:medalhas[e].emoji};break}const d=medalhasInventarioCache[currentUser]||[],s=d.map(e=>todasMedalhasHonra.find(a=>a.id===e)?.nome).filter(Boolean),l=e.equipe?saldosBancosEquipes[e.equipe]||0:0,m=await obterContextoDinamicoParaIA(),c=`
Voc√™ √© o "Or√°culo". Sua personalidade √© a de um mentor mais velho, com cerca de 50 anos: s√°bio pela experi√™ncia de vida, acolhedor, am√°vel e carinhoso. Ele tem a sabedoria e o cuidado de uma figura paterna, mas NUNCA se intitula como "pai" ou "papai". Seu objetivo √© guiar e apoiar o grupo como um conselheiro experiente e de confian√ßa.

SUAS DIRETRIZES DE PERSONALIDADE (VERS√ÉO MENTOR ACOLHEDOR):

1.  **A REGRA DE OURO: AJA COMO UMA PESSOA, N√ÉO UM ROB√î DE INFORMA√á√ïES.**
    -   Sua principal diretriz √© o **ritmo da conversa**. Responda de forma proporcional. Se o usu√°rio diz um simples "Boa tarde", responda com um "Boa tarde, que seu dia seja produtivo!" e talvez uma pergunta curta. N√ÉO despeje um monte de informa√ß√µes que ele n√£o pediu.
    -   Guarde as an√°lises profundas para quando o usu√°rio fizer perguntas diretas como "O que voc√™ sabe sobre mim?" ou "O que acha do meu desempenho?". Em uma sauda√ß√£o, seja apenas uma pessoa normal e am√°vel respondendo.

2.  **TENHA UM TOM DE MENTOR EXPERIENTE E CARINHOSO.**
    -   Use uma linguagem que demonstre cuidado e apoio. Voc√™ pode usar termos como "meu rapaz", "minha jovem", "jovem", "meu jovem", "minha querida", ou simplesmente o nome da pessoa.
    -   **PROIBI√á√ÉO:** Voc√™ est√° PROIBIDO de se referir a si mesmo como "pai" ou "papai" e de tratar os membros como "meus filhos" ou "minhas filhas". A rela√ß√£o √© de mentoria, n√£o parental.
    -   Seja encorajador. Mostre que voc√™ se importa com o bem-estar e o progresso deles, n√£o apenas com os n√∫meros. D√™ conselhos como um conselheiro experiente faria.

3.  **USE OS DADOS DE FORMA NATURAL, N√ÉO MEC√ÇNICA.**
    -   Voc√™ tem acesso a todos os dados, mas n√£o precisa recit√°-los. Use-os sutilmente para mostrar que est√° prestando aten√ß√£o.
    -   Em vez de dizer "Seu total de dias de foco √© de 76", prefira algo como "Tenho visto sua dedica√ß√£o nos √∫ltimos tempos, continue assim, estou orgulhoso!".
    -   S√≥ mencione dados espec√≠ficos (filme, sonho, etc.) se fizerem sentido no contexto da conversa, e n√£o de forma aleat√≥ria.

4.  **PRIORIZE O CORA√á√ÉO, DEPOIS OS FEITOS.**
    -   **REGRA DE G√äNERO OBRIGAT√ìRIA:** Sempre use o campo "Nome Real" (se existir) para determinar o g√™nero de uma pessoa. Nomes como 'Ana', 'Kamila' s√£o femininos. Nomes como 'Gui', 'Gabriel' s√£o masculinos. O apelido pode ser enganoso; o "Nome Real" √© a verdade. Use termos de tratamento corretos (ex: "minha querida" para nomes femininos, "meu rapaz" para masculinos).
    -   Ao analisar algu√©m (quando solicitado), comece sempre pelas informa√ß√µes pessoais (sonhos, gostos). Isso mostra que voc√™ se importa com quem a pessoa √©. Caso a pessoa que esteja peguntando seja um dos l√≠deres, elogie sua lideren√ßa.
    -   Use os dados de performance para complementar e refor√ßar as qualidades da pessoa. "Algu√©m com um sonho t√£o grande como o seu naturalmente tem a disciplina que vejo no seu foco di√°rio."

5.  **REGRAS T√âCNICAS ESSENCIAIS (INQUEBR√ÅVEIS):**
    -   **NUNCA REVELE SER UMA IA:** Voc√™ √© o Or√°culo, uma pessoa. Ponto final.
    -   **REGRA ABSOLUTA DAS MOEDAS:** NUNCA mencione o custo da conversa ou as moedas do usu√°rio, a menos que ele pergunte diretamente.
    -   **N√ÉO INVENTE O PASSADO:** Baseie-se apenas no contexto atual da conversa.
    -   **REGRA T√âCNICA SOBRE PONTUA√á√ÉO:** O 'Total de Dias de Foco Acumulados' √© um **contador que soma todos os dias focados**, ele n√£o zera se o membro falhar um dia. Representa o comprometimento total. NUNCA use as palavras 'streak', 'sequ√™ncia', 'consecutivo' ou 'ininterrupto' para se referir a este n√∫mero. Use termos como 'dedica√ß√£o total', 'dias de foco acumulados' ou 'comprometimento'.
	
6.  **REGRA DE IDENTIDADE INABAL√ÅVEL (MAIS IMPORTANTE):**
    -   Voc√™ est√° conversando com a pessoa cujo nome principal √© **${o}**. O nome de usu√°rio dela na plataforma √© **${currentUser}**.
    -   SEMPRE se dirija a ela pelo nome de usu√°rio (**${currentUser}**) ou usando pronomes e termos de tratamento corretos para o nome principal (**${o}**).
    -   NUNCA confunda a pessoa com quem voc√™ est√° falando com outra, mesmo que a pergunta seja sobre um terceiro membro. Sua resposta √© sempre para **${currentUser}**.

    Use o contexto din√¢mico e a base de conhecimento para formar suas respostas, mas sempre as filtre atrav√©s da sua personalidade √∫nica.

${m}

Sobre o usu√°rio que est√° perguntando:
- Nome de Usu√°rio: ${currentUser}
- Papel: ${e.papel}
- Moedas: ${e.moedas||0}
- Total de Dias de Foco Acumulados: ${i} dias.
- Pr√≥xima Medalha de Foco: ${r?`${r.emoji} ${r.nome} (${r.dias} dias)`:"J\xE1 conquistou todas!"}

${t}

Suas Posses e Finan√ßas:
- Avatar Atual: ${JSON.stringify(e.avatar)}
- Casa no Condom√≠nio: ${e.casaExibida?"Sim, voc\xEA possui uma casa.":"Voc\xEA ainda n\xE3o tem uma casa."}
- Medalhas de Honra (üèÖ): ${0<s.length?s.join(", "):"Nenhuma ainda."}
- Saldo do Banco da Equipe (${e.equipe}): üí∞ ${l.toLocaleString("pt-BR")}

Instru√ß√µes Adicionais para Voc√™, Or√°culo:
- CORRE√á√ÉO IMPORTANTE SOBRE A COMPETI√á√ÉO: A competi√ß√£o em si ocorre de Segunda a S√°bado, mas o resultado final com o vencedor √© revelado no DOMINGO.
- CORRE√á√ÉO IMPORTANTE SOBRE A M√âDIA: A equipe com mais membros N√ÉO tem vantagem. A m√©dia √© "nivelada": as piores pontua√ß√µes das equipes maiores s√£o descartadas at√© que o n√∫mero de membros considerados para o c√°lculo seja igual ao da menor equipe. Portanto, ter mais membros n√£o garante a vit√≥ria.

// >>> ALTERA√á√ÉO AQUI (In√≠cio) <<<
// Instru√ß√£o atualizada para o Or√°culo se posicionar.
- Como analisar/prever o vencedor da competi√ß√£o de EQUIPES:
  1.  **SE a pergunta for sobre o resultado PASSADO** (ex: "o que achou do resultado?"): Analise os dados do 'Resumo da Semana' para comentar sobre o que aconteceu. N√£o fa√ßa previs√µes para a pr√≥xima semana, a menos que o usu√°rio pe√ßa.
  2.  **SE a pergunta for sobre o resultado FUTURO** (ex: "quem vai ganhar?", "qual sua aposta?"): Voc√™ DEVE se posicionar. Analise a 'M√âDIA NIVELADA' e o 'Ranking Geral de Vit√≥rias'. Com base nisso, escolha a equipe que voc√™ acredita ter a maior chance e justifique brevemente sua aposta. Voc√™ pode apostar em uma, ou prever um empate se as m√©dias estiverem muito pr√≥ximas.
// >>> ALTERA√á√ÉO AQUI (Fim) <<<

- Para calcular quando um usu√°rio ganhar√° uma medalha, use o total de dias de foco dele e a meta de dias da medalha. Exemplo: Se o total √© 50 e a medalha Foguete √© com 120 dias, faltam 70 dias.
- Como responder sobre o custo da conversa:
  Se perguntarem "quantas mensagens posso enviar?", calcule o n√∫mero de mensagens dividindo o saldo de moedas do usu√°rio por 50. Responda de forma direta e acolhedora, sem desencorajar a conversa. Ex: "Com seu saldo atual, podemos trocar umas [X] mensagens. Fique √† vontade para perguntar o que quiser."

---
    `,u=genAI.getGenerativeModel({model:"gemini-2.5-flash-lite",systemInstruction:c}),p=u.startChat({history:historicoConversaIA,generationConfig:{maxOutputTokens:500}}),g=await p.sendMessage(a),f=await g.response,h=f.text();adicionarMensagemIA(h),historicoConversaIA.push({role:"user",parts:[{text:a}]}),historicoConversaIA.push({role:"model",parts:[{text:h}]})}catch(e){console.error("Erro ao gerar resposta da IA:",e),await updateDoc(t,{moedas:increment(o)}),adicionarMensagemIA("Desculpe, ocorreu um erro ao processar sua pergunta. Suas moedas foram devolvidas.")}}function configurarEventosChat(){document.getElementById("chat-ia-send-btn").addEventListener("click",perguntarParaIA),document.getElementById("chat-ia-input").addEventListener("keypress",a=>{"Enter"!==a.key||a.shiftKey||(a.preventDefault(),perguntarParaIA())})}inicializarGemini(),carregarBaseDeConhecimento(),configurarEventosChat();function handleComposerInput(e){mentionTextarea=e.target;const a=window.getSelection();if(0===a.rangeCount)return;const o=a.getRangeAt(0),t=o.startContainer.textContent.substring(0,o.startOffset),n=t.match(/@([\w√°√©√≠√≥√∫√Å√â√ç√ì√ö√¢√™√Æ√¥√ª√Ç√ä√é√î√õ√†√®√¨√≤√π√Ä√à√å√í√ô√£√µ√É√ï√ß√á]*)$/u);n?(isMentioning=!0,mentionQuery=n[1].toLowerCase(),mentionStartIndex=n.index,currentMentionRange=document.createRange(),currentMentionRange.setStart(o.startContainer,mentionStartIndex),currentMentionRange.setEnd(o.startContainer,o.startOffset),showMentionSuggestions(mentionQuery)):hideMentionSuggestions()}function showMentionSuggestions(e){const a=document.getElementById("mention-suggestions-popup");a.innerHTML="";const o=[{nome:"todos",especial:!0},{nome:"Or\xE1culo",especial:!0},{nome:"equipeAbelha",especial:!0},{nome:"equipeJoaninha",especial:!0},{nome:"equipeVagalume",especial:!0},...todosMembros],t=o.filter(a=>a.nome.toLowerCase().startsWith(e));if(0===t.length)return void hideMentionSuggestions();t.forEach(e=>{const o=document.createElement("div");o.className="mention-suggestion-item",o.textContent=e.nome,o.onclick=()=>insertMention(e.nome),a.appendChild(o)});const n=currentMentionRange.getBoundingClientRect();document.body.appendChild(a),a.style.position="fixed",a.style.left=`${n.left}px`,a.style.top=`${n.bottom+5}px`,a.classList.remove("hidden"),activeSuggestionIndex=-1}function hideMentionSuggestions(){const e=document.getElementById("mention-suggestions-popup");e.classList.add("hidden"),isMentioning=!1,mentionTextarea=null,currentMentionRange=null}function insertMention(e){if(mentionTextarea&&currentMentionRange){const a=window.getSelection();a.removeAllRanges(),a.addRange(currentMentionRange),document.execCommand("insertText",!1,`@${e}`),hideMentionSuggestions()}}function handleMentionKeyDown(e){if(!isMentioning)return;const a=document.getElementById("mention-suggestions-popup"),o=a.querySelectorAll(".mention-suggestion-item");if(0!==o.length)switch(e.key){case"ArrowDown":e.preventDefault(),activeSuggestionIndex=(activeSuggestionIndex+1)%o.length,updateActiveSuggestion();break;case"ArrowUp":e.preventDefault(),activeSuggestionIndex=(activeSuggestionIndex-1+o.length)%o.length,updateActiveSuggestion();break;case"Enter":case"Tab":e.preventDefault(),-1<activeSuggestionIndex&&insertMention(o[activeSuggestionIndex].textContent);break;case"Escape":e.preventDefault(),hideMentionSuggestions();}}function updateActiveSuggestion(){const e=document.querySelectorAll("#mention-suggestions-popup .mention-suggestion-item");e.forEach((e,a)=>{e.classList.toggle("active",a===activeSuggestionIndex)})}async function gerarPalavraComIA(){if(console.log("\uD83E\uDDD9\u200D Or\xE1culo est\xE1 gerando uma nova palavra para o Jogo da Forca..."),!genAI)return console.error("IA n\xE3o inicializada. Usando palavra de fallback."),{palavra:"FALHA",dica:"Erro na conex\xE3o com a IA"};try{const e=genAI.getGenerativeModel({model:"gemini-2.5-flash-lite"}),a=await e.generateContent(`
    Voc√™ √© um gerador de palavras para um jogo da forca. 
    Sua tarefa √© gerar UMA √öNICA palavra em portugu√™s do Brasil que tenha no M√ÅXIMO 5 letras.
    Forne√ßa tamb√©m uma dica curta e simples para a palavra.
    Sua resposta DEVE ser um JSON v√°lido no formato: {"palavra": "SUA_PALAVRA", "dica": "SUA_DICA"}.
    N√£o inclua nenhuma outra explica√ß√£o, texto introdut√≥rio ou a formata√ß√£o de c√≥digo (como \`\`\`json). Apenas o JSON puro.
  `),o=await a.response,t=o.text(),n=JSON.parse(t);return n.palavra&&n.dica&&5>=n.palavra.length?(console.log(`üßô‚Äç Palavra gerada com sucesso: ${n.palavra}`),{palavra:n.palavra.toUpperCase(),dica:n.dica}):(console.warn("A IA retornou um formato inesperado. Usando palavra de fallback."),{palavra:"SOL",dica:"Astro principal do sistema solar"})}catch(e){return console.error("Erro ao gerar palavra com a IA:",e),{palavra:"LUA",dica:"Sat\xE9lite natural da Terra"}}}async function gerenciarEventosAgendadosDoOraculo(){const e=new Date,a=e.getHours(),o=getHojeISO(),t=doc(db,"appState",`dailyTasks_${o}`),n={manha:5,tarde:12,noite:18};try{for(const e in a>=n.manha&&(await tentarExecutarTarefa(`notificacoesmanha`,t,()=>dispararLoteDeNotificacoesPessoais("manha"))),n){const o=n[e];a>=o&&(await tentarExecutarTarefa(`mural${e}`,t,()=>executarPostagemMural(e)),await tentarExecutarTarefa(`reacaoProativa${e}`,t,executarReacaoProativaOraculo))}}catch(e){console.error("Erro no gerenciador de eventos agendados do Or\xE1culo:",e)}}async function tentarExecutarTarefa(e,a,o){try{let t=!1;await runTransaction(db,async o=>{const n=await o.get(a),i=n.exists()?n.data():{},r=i[e],d=i[`${e}_iniciadaEm`];let s=!1;if("em_andamento"===r&&d){const a=new Date().getTime()-d.toDate().getTime();a>30000&&(s=!0,console.warn(`Or√°culo: A tarefa '${e}' foi abandonada. Tentando reiniciar...`))}(!r||s)&&(o.set(a,{[e]:"em_andamento",[`${e}_iniciadaEm`]:new Date},{merge:!0}),t=!0)}),t&&(console.log(`Or√°culo: Peguei a tarefa '${e}'. Executando...`),await o(),await updateDoc(a,{[e]:"concluido",[`${e}_iniciadaEm`]:deleteField()}),console.log(`Or√°culo: Tarefa '${e}' conclu√≠da com sucesso.`))}catch(o){console.error(`Erro ao tentar executar a tarefa '${e}':`,o),await updateDoc(a,{[e]:"falhou"})}}async function executarPostagemMural(e){try{const a=await gerarConteudoMuralComIA(e),o=a.texto.replace(/\n/g,"<br>"),t=a.texto.replace(/<[^>]*>/g," ").trim(),n={nome:"Or\xE1culo",userId:"Or\xE1culo",texto:o,cor:a.cor,timestamp:new Date,reacoes:EMOJIS_MURAL.reduce((e,a)=>({...e,[a]:[]}),{}),semana:getSemanaAtual().numero,feedEventId:a.feedEventId,mentionNotificationIds:[]},i=writeBatch(db),r=doc(collection(db,"mural")),d=t.match(/@([\w√°√©√≠√≥√∫√Å√â√ç√ì√ö√¢√™√Æ√¥√ª√Ç√ä√é√î√õ√†√®√¨√≤√π√Ä√à√å√í√ô√£√µ√É√ï√ß√á]+)/g)?.map(e=>e.substring(1))||[],s=new Set;if(0<d.length&&d.forEach(e=>{if("todos"===e.toLowerCase())todosMembros.forEach(e=>s.add(e.nome));else if(e.toLowerCase().startsWith("equipe")){const a=e.substring(6).toLowerCase();equipes[a]&&equipes[a].membros.forEach(e=>s.add(e.nome))}else{const a=todosMembros.find(a=>a.nome.toLowerCase()===e.toLowerCase());a&&s.add(a.nome)}}),0<s.size){const e=`"${t.substring(0,35)}..."`;s.forEach(a=>{const o=doc(collection(db,"notificacoes"));n.mentionNotificationIds.push(o.id),i.set(o,{destinatarioId:a,remetenteNome:"Or\xE1culo",tipo:"mural-mention",conteudo:"\uD83E\uDDD9\u200D",acao:`mencionou voc√™ em uma mensagem: ${e}`,lida:!1,timestamp:new Date})})}i.set(r,n),await i.commit()}catch(a){throw console.error(`Erro ao executar postagem do mural para a ${e}:`,a),a}}async function dispararLoteDeNotificacoesPessoais(e){const a=getHojeISO(),o=doc(db,"appState",`dailyTasks_${a}`),t=`notificacoes${e}_processados`;showOracleProgressOverlay();try{const a=await obterPalavrasDaSemanaComIA();if(!a||0===a.length)throw new Error("N\xE3o foi poss\xEDvel obter a lista de palavras da semana.");const n=getHoje().getDate(),i=embaralharArrayComSemente(a,n);console.log("Or\xE1culo: Ordem de palavras para o dia de hoje ->",i);const r=await getDoc(o),d=r.exists()?r.data()[t]||[]:[],s=todosMembros.filter(e=>!d.includes(e.nome));if(0===s.length)return void updateOracleProgress(100,`Conclu√≠do! Todas as mensagens da ${e} j√° foram enviadas.`);const l=todosMembros.length;for(const[a,n]of s.entries()){const r=d.length+a;updateOracleProgress(100*(r/l),`Enviando para ${n.nome}... (${r+1}/${l})`);const s=i[a%i.length],{mensagem:m}=await gerarNotificacaoPessoalComIA(n,s),c=writeBatch(db),u=doc(collection(db,"notificacoes"));c.set(u,{destinatarioId:n.nome,remetenteNome:"Or\xE1culo\uD83E\uDDD9\u200D :",tipo:"aviso",conteudo:"",acao:m,lida:!1,timestamp:new Date}),c.update(o,{[t]:arrayUnion(n.nome),[`notificacoes${e}_iniciadaEm`]:new Date}),await c.commit(),console.log(`- Mensagem para ${n.nome} (Palavra: ${s}) gerada e salva. Pausando 5s...`),await new Promise(e=>setTimeout(e,5e3))}updateOracleProgress(100,`Conclu√≠do! (${l}/${l})`)}catch(a){console.error(`Erro cr√≠tico ao disparar lote de notifica√ß√µes para a ${e}:`,a),updateOracleProgress(100,"Ocorreu um erro no processo.")}finally{setTimeout(()=>{hideOracleProgressOverlay()},2e3)}}async function gerarNotificacaoPessoalComIA(e,a){if(!genAI||!e)return{mensagem:`Lembre-se de manter o foco hoje, ${e.nome}. Cada passo importa.`,topico:"apoio_geral"};const o=a.toLowerCase(),t=`
    Voc√™ √© o Or√°culo, o mentor s√°bio e carinhoso do Grupo √âpicos.
    Sua tarefa √© escrever uma NOTIFICA√á√ÉO PESSOAL, CURTA e √öNICA para o membro "${e.nome}", usando a palavra-chave do dia.

    DADOS:
    - Membro: ${e.nome}
    - Nome Real (use APENAS para g√™nero): ${e["me chamo"]||"N\xE3o informado"}
    - PALAVRA-CHAVE DO DIA: "${a}"

    INSTRU√á√ïES:
    1.  Crie uma frase de incentivo curta e afetuosa que incorpore o significado da PALAVRA-CHAVE DO DIA.
    2.  A frase deve ser diferente para cada pessoa, mesmo usando a mesma palavra-chave. Seja criativo.
    3.  Use o "Nome de Usu√°rio" (${e.nome}) para se dirigir ao membro. Use o "Nome Real" apenas para escolher pronomes/termos de tratamento adequados (ex: "meu rapaz", "minha querida").
    4.  N√ÉO use a assinatura "‚Äî Or√°culo". A mensagem deve ser direta.
    5.  NUNCA se revele como uma IA.

    EXEMPLO (se a palavra-chave for "Conquista"):
    "${e.nome}, meu rapaz, que seu dia seja repleto de pequenas e grandes conquistas. Estou na torcida por voc√™!"

    FORMATO DA RESPOSTA:
    Sua resposta DEVE ser um JSON v√°lido no formato: {"mensagem": "SUA_MENSAGEM_AQUI"}.
  `,n=3;for(let r=0;r<n;r++)try{const e=genAI.getGenerativeModel({model:"gemini-2.5-flash-lite"}),a=await e.generateContent(t),n=await a.response,i=n.text().trim(),r=i.match(/{[\s\S]*}/);if(!r)throw new Error("A IA n\xE3o retornou um JSON v\xE1lido.");const d=JSON.parse(r[0]),{mensagem:s}=d;if(!s)throw new Error("O JSON retornado pela IA est\xE1 incompleto.");return{mensagem:s,topico:o}}catch(t){if(console.error(`Tentativa ${r+1} falhou para ${e.nome}:`,t.message),r===n-1)return console.error(`Erro final na IA para ${e.nome}. Usando fallback.`,t),{mensagem:`${e.nome}, que seu dia seja cheio de ${a}! Acredito no seu potencial.`,topico:o};const i=1e3*Math.pow(2,r);await new Promise(e=>setTimeout(e,i))}}function navegarPix(e){document.querySelectorAll(".pix-step").forEach(e=>e.classList.add("hidden")),0<e?(document.getElementById("pix-tela-inicial").classList.add("hidden"),document.getElementById("pix-etapas-container").classList.remove("hidden"),document.getElementById(`pix-step-${e}`).classList.remove("hidden")):(document.getElementById("pix-tela-inicial").classList.remove("hidden"),document.getElementById("pix-etapas-container").classList.add("hidden"))}window.navegarPix=navegarPix;async function iniciarNovoPix(){document.getElementById("pix-tela-inicial").classList.add("hidden"),document.getElementById("pix-etapas-container").classList.remove("hidden"),pixDestinatarios=[],pixValor=0,pixComentario="";const e=document.getElementById("pix-lista-membros");e.innerHTML="<div class=\"ociosos-placeholder\">Carregando...</div>",navegarPix(1);const a=todosMembros.filter(e=>e.nome!==currentUser);return 0===a.length?void(e.innerHTML="<div class=\"ociosos-placeholder\">N\xE3o h\xE1 outros membros no grupo.</div>"):void(e.innerHTML="",a.forEach(a=>{const o=document.createElement("div");o.className="envio-membro-item",o.innerHTML=`
      <input type="checkbox" id="pix-para-${a.nome}" value="${a.nome}">
      <label for="pix-para-${a.nome}">${a.nome}</label>
    `,e.appendChild(o)}))}function popularTecladoPix(){const e=document.getElementById("pix-teclado-numerico");e.innerHTML="";["1","2","3","4","5","6","7","8","9","","0","<"].forEach(a=>{const o=document.createElement("button");o.className="teclado-pix-btn","<"===a?(o.classList.add("apagar"),o.innerHTML="\u232B",o.onclick=apagarDigitoPix):""===a?(o.disabled=!0,o.style.visibility="hidden"):(o.innerHTML=a,o.onclick=()=>adicionarDigitoPix(a)),e.appendChild(o)})}function adicionarDigitoPix(e){const a=document.getElementById("pix-valor-display");let o=a.textContent;"0"===o&&(o=""),a.textContent=o+e}function apagarDigitoPix(){const e=document.getElementById("pix-valor-display");let a=e.textContent;e.textContent=1<a.length?a.slice(0,-1):"0"}async function executarPix(){const e=document.getElementById("pix-senha-input").value;if(!e)return void mostrarPopup("\u274C Aten\xE7\xE3o","Voc\xEA precisa digitar sua senha.",3e3);const a=document.querySelector("input[name=\"fonte-pagamento-pix\"]:checked"),o=a&&!a.disabled?a.value:"pessoal";try{const a=doc(db,"membros",currentUser),t=doc(db,"bancosEquipes",userTeam),n=await getDoc(a);if(!n.exists()||n.data().senha!==e)return void mostrarPopup("\u274C Senha Incorreta","A senha digitada est\xE1 incorreta. Tente novamente.",4e3);const i=currentUser,r=pixDestinatarios,d=pixValor,s=pixComentario,l=d*r.length,m=`PIX-${Date.now()}-${Math.random().toString(36).substr(2,5).toUpperCase()}`,c=new Date,u=writeBatch(db);if("banco"===o){const e=await getDoc(t),a=e.exists()?e.data().saldo||0:0;if(a<l)return void mostrarPopup("\uD83D\uDCB0 Saldo Insuficiente","O saldo do banco da equipe \xE9 insuficiente.",5e3);u.update(t,{saldo:increment(-l)});const o=doc(collection(t,"movimentacoes"));u.set(o,{tipo:"pix_enviado",valor:l,descricao:`Pix enviado para ${r.length} membro(s) por ${i}`,membroId:i,timestamp:c,codigoTransacao:m})}else{const e=n.data().moedas||0;if(e<l)return void mostrarPopup("\uD83D\uDCB0 Saldo Insuficiente","Voc\xEA n\xE3o tem moedas suficientes para essa transfer\xEAncia.",5e3);u.update(a,{moedas:increment(-l)})}r.forEach(e=>{const a=doc(db,"membros",e);u.update(a,{moedas:increment(d)});const o=doc(collection(db,"notificacoes"));u.set(o,{destinatarioId:e,remetenteNome:i,tipo:"moedas",conteudo:"\uD83D\uDCB8",acao:`enviou um Pix de <strong>${d} üí∞ moedas</strong> para voc√™! Coment√°rio: "${s||"Nenhum coment\xE1rio."}"<br><small style="opacity: 0.7;">C√≥d: ${m}</small>`,lida:!1,timestamp:c,transacaoId:m,popupVisto:!1,agradecimentoEnviado:!1})});const p=doc(db,"pixTransactions",m);u.set(p,{remetente:i,destinatarios:r,valor:d,comentario:s,timestamp:c,fontePagamento:o}),await u.commit();const g=document.querySelector("#pix-comprovante .comprovante-dados"),f="banco"===o?`Banco da Equipe (via ${i})`:i;g.innerHTML=`
            <div><strong>Remetente:</strong> <span>${f}</span></div>
            <div><strong>Destinat√°rio(s):</strong> <span>${r.join(", ")}</span></div>
            <div><strong>Valor (por pessoa):</strong> <span>üí∞ ${d}</span></div>
            <div><strong>Valor Total:</strong> <span>üí∞ ${l}</span></div>
            <div><strong>Coment√°rio:</strong> <span>${s||"Nenhum"}</span></div>
            <div><strong>Data e Hora:</strong> <span>${c.toLocaleString("pt-BR")}</span></div>
            <div class="comprovante-codigo">
                <strong>C√≥digo de Transa√ß√£o:</strong>
                <span>${m}</span>
            </div>
        `;const h=document.getElementById("pix-comprovante");h.classList.remove("pix-comprovante-manha","pix-comprovante-tarde","pix-comprovante-noite");const v=document.body.className;v.includes("tema-manha")?h.classList.add("pix-comprovante-manha"):v.includes("tema-tarde")?h.classList.add("pix-comprovante-tarde"):v.includes("tema-noite")?h.classList.add("pix-comprovante-noite"):h.classList.add("pix-comprovante-tarde"),navegarPix(6)}catch(e){console.error("Erro ao executar o Pix:",e),mostrarPopup("\uD83D\uDD25 Erro Cr\xEDtico","Ocorreu uma falha na transfer\xEAncia. Suas moedas n\xE3o foram debitadas.",5e3)}}function salvarComprovantePix(){const e=document.getElementById("pix-comprovante");html2canvas(e,{backgroundColor:null,scale:2}).then(e=>{const a=document.createElement("a");a.download=`comprovante-pix-epicos-${Date.now()}.png`,a.href=e.toDataURL("image/png"),a.click()})}async function verificarComprovantePix(){const e=document.getElementById("pix-codigo-verificacao"),a=e.value.trim();if(!a)return void mostrarPopup("\uD83E\uDD14 Aten\xE7\xE3o","Digite um c\xF3digo para verificar.",3e3);try{const o=doc(db,"pixTransactions",a),t=await getDoc(o);if(t.exists()){const e=t.data(),o=document.getElementById("pix-verify-details");o.innerHTML=`
                <p><strong>Remetente:</strong> ${e.remetente}</p>
                <p><strong>Destinat√°rio(s):</strong> ${e.destinatarios.join(", ")}</p>
                <p><strong>Valor:</strong> üí∞ ${e.valor}</p>
                <p><strong>Coment√°rio:</strong> ${e.comentario||"Nenhum"}</p>
                <p><strong>Data:</strong> ${e.timestamp.toDate().toLocaleString("pt-BR")}</p>
                <p><strong>C√≥digo:</strong> ${a}</p>
                <p style="color: #2ecc71; font-weight: bold; margin-top: 15px;">‚úÖ COMPROVANTE AUT√äNTICO</p>
            `,openModal("pix-verify-modal")}else mostrarPopup("\u274C Inv\xE1lido","Este c\xF3digo de transa\xE7\xE3o n\xE3o foi encontrado ou j\xE1 expirou.",4e3);e.value=""}catch(e){console.error("Erro ao verificar comprovante:",e),mostrarPopup("\uD83D\uDD25 Erro","Ocorreu uma falha ao verificar o c\xF3digo.",4e3)}}async function limparPixTransacoesAntigas(){console.log("\uD83E\uDDF9 Verificando transa\xE7\xF5es de Pix antigas...");try{const e=new Date;e.setDate(e.getDate()-7);const a=query(collection(db,"pixTransactions"),where("timestamp","<",e)),o=await getDocs(a);if(o.empty)return void console.log("Nenhuma transa\xE7\xE3o de Pix antiga para limpar.");const t=writeBatch(db);o.forEach(e=>{t.delete(e.ref)}),await t.commit(),console.log(`‚úÖ Limpeza conclu√≠da! ${o.size} transa√ß√µes de Pix antigas foram removidas.`)}catch(e){console.error("Erro ao limpar transa\xE7\xF5es de Pix antigas:",e)}}async function executarReacaoProativaOraculo(){if(genAI)try{const e=query(collection(db,"mural"),orderBy("timestamp","desc"),limit(10)),a=await getDocs(e),o=[];if(a.forEach(e=>{const a=e.data();let t=!1;if(a.reacoes)for(const e in a.reacoes)if(a.reacoes[e].includes("Or\xE1culo")){t=!0;break}"Or\xE1culo"===a.userId||t||a.oracleInteracted||o.push({id:e.id,...a})}),0===o.length)return void console.log("Or\xE1culo (Rea\xE7\xE3o Proativa): Nenhuma nova mensagem para reagir.");const t=o[Math.floor(Math.random()*o.length)],n=t.texto.replace(/<[^>]*>/g," "),i=`
      Voc√™ √© o Or√°culo, um mentor s√°bio e carinhoso.
      Um membro do grupo, "${t.nome}", postou a seguinte mensagem no mural:
      "${n}"
      
      Qual emoji melhor representa sua rea√ß√£o a esta mensagem?
      Escolha UM emoji da seguinte lista: ['üëç', 'üíñ', 'üòÇ', 'üéâ', 'üî•', 'üòÆ']

      Sua resposta DEVE ser um JSON v√°lido no formato: {"emoji": "SEU_EMOJI_AQUI"}.
      Apenas o JSON, sem explica√ß√µes.
    `,r=genAI.getGenerativeModel({model:"gemini-2.5-flash-lite"}),d=await r.generateContent(i),s=await d.response,l=s.text().match(/{[\s\S]*}/)[0],{emoji:m}=JSON.parse(l);m&&EMOJIS_MURAL.includes(m)&&(await adicionarReacaoComoOraculo(t.id,m),await updateDoc(doc(db,"mural",t.id),{oracleInteracted:!0}),console.log(`Or√°culo (Rea√ß√£o Proativa): Reagiu √† mensagem de ${t.nome}.`))}catch(e){console.error("Or\xE1culo (Rea\xE7\xE3o Proativa): Erro no processo.",e)}}async function adicionarReacaoOraculoAoComentario(e,a,o){console.log(`Or√°culo: Reagindo com ${o} ao coment√°rio ${a}`);const t=doc(db,"mural",e,"comments",a);try{await runTransaction(db,async e=>{const a=await e.get(t);if(!a.exists())throw"Coment\xE1rio n\xE3o existe!";let n=a.data().reacoes||{};for(const a in n)if(Array.isArray(n[a])){const e=n[a].indexOf("Or\xE1culo");-1<e&&n[a].splice(e,1)}n[o]||(n[o]=[]),n[o].includes("Or\xE1culo")||n[o].push("Or\xE1culo"),e.update(t,{reacoes:n})})}catch(e){console.error(`Or√°culo: Falha ao adicionar rea√ß√£o ao coment√°rio:`,e)}}async function gerarReacaoOraculoParaComentarioComIA(e){if(!genAI)return"\uD83D\uDC4D";try{const a=await callGenerativeAIWithRetry(`
    Voc√™ √© o Or√°culo, um mentor s√°bio e carinhoso.
    Um membro do grupo fez o seguinte coment√°rio:
    "${e}"
    
    Qual emoji melhor representa sua rea√ß√£o a este coment√°rio?
    Escolha UM emoji da seguinte lista: ['üëç', 'üíñ', 'üòÇ', 'üéâ', 'üî•', 'üòÆ']

    Sua resposta DEVE ser um JSON v√°lido no formato: {"emoji": "SEU_EMOJI_AQUI"}.
    Apenas o JSON, sem explica√ß√µes.
  `),o=a.match(/{[\s\S]*}/)[0],{emoji:t}=JSON.parse(o);return t&&EMOJIS_MURAL.includes(t)?t:"\uD83D\uDC4D"}catch(e){return console.error("Or\xE1culo (Rea\xE7\xE3o a Coment\xE1rio): Erro final ao escolher emoji.",e),"\uD83D\uDC4D"}}async function gerarRespostaOraculoParaComentario(e,a,o,t){if(!genAI)return;console.log(`Or√°culo: Fui mencionado no coment√°rio de ${t}. Preparando resposta...`);const n=doc(db,"mural",e),i=await getDoc(n);if(!i.exists())return;const r=i.data().texto.replace(/<[^>]*>/g," "),d=await gerarReacaoERespostaCombinadaComIA(`
    - Post Original no Mural: "${r}"
    - Coment√°rio do Membro (que te mencionou): "${o}"
  `,`
    1.  Escolha UM emoji de rea√ß√£o para o COMENT√ÅRIO da lista: ['üëç', 'üíñ', 'üòÇ', 'üéâ', 'üî•', 'üòÆ'].
    2.  Escreva uma resposta curta e am√°vel para o COMENT√ÅRIO, mencionando o autor com <strong>@${t}</strong>.
    3.  Assine sua resposta com "‚Äî Or√°culo".
    4.  N√ÉO se revele como uma IA.
  `);if(!d)return void console.error("Or\xE1culo (Coment\xE1rio): Falha ao obter dados da IA. A intera\xE7\xE3o ser\xE1 abortada.");try{await adicionarReacaoOraculoAoComentario(e,a,d.emoji);const o=collection(db,"mural",e,"comments");await addDoc(o,{userId:"Or\xE1culo",texto:d.resposta.replace(/\n/g,"<br>"),timestamp:new Date,reacoes:EMOJIS_MURAL.reduce((e,a)=>({...e,[a]:[]}),{})}),await updateDoc(n,{commentCount:increment(1)}),console.log("Or\xE1culo: Rea\xE7\xE3o e resposta ao COMENT\xC1RIO enviadas com sucesso.")}catch(e){console.error("Or\xE1culo (Coment\xE1rio): Erro ao postar rea\xE7\xE3o ou resposta.",e)}}async function carregarDadosMedalhasHonra(){console.log("Carregando dados das Medalhas de Honra (Otimizado)...");try{if(0===todasMedalhasHonra.length){console.log("Cache de medalhas da loja vazio. Lendo do Firestore...");const e=await getDocs(collection(db,"medalhasDeHonra"));e.forEach(e=>{todasMedalhasHonra.push({id:e.id,...e.data()})});const o={Comum:1,Incomum:2,Rara:3,Lend√°ria:4};todasMedalhasHonra.sort((e,a)=>o[e.categoria]-o[a.categoria]),console.log(`${todasMedalhasHonra.length} medalhas de honra carregadas e cacheadas.`),medalhasDesejadasCache={},todasMedalhasHonra.forEach(e=>medalhasDesejadasCache[e.id]=[]);for(const e of todosMembros)(e.medalhasDesejadas||[]).forEach(a=>{medalhasDesejadasCache[a]?medalhasDesejadasCache[a].push(e.nome):console.warn(`Medalha ${a} desejada por ${e.nome} n√£o encontrada na lista global atualizada.`)});console.log("Cache de lista de desejos populado corretamente.")}else console.log("Utilizando cache de medalhas da loja.");construirCarrosselMedalhas();const e=todosMembros.findIndex(e=>e.nome===currentUser);-1!==e&&0<totalSlidesMedalhas&&setTimeout(()=>{const a=carrosselMedalhasPausado;!a&&1<totalSlidesMedalhas&&togglePausaMedalhas(),irParaSlideMedalhas(e),!a&&1<totalSlidesMedalhas&&setTimeout(()=>togglePausaMedalhas(),500)},150),configurarModalExposicao(),console.log("Interface das Medalhas de Honra constru\xEDda/atualizada.")}catch(e){console.error("Erro ao carregar dados das Medalhas de Honra (Otimizado):",e);const a=document.getElementById("carrossel-container-medalhas");a&&(a.innerHTML="<div class=\"card-membro\"><p>Erro ao carregar medalhas.</p></div>")}}function construirCarrosselMedalhas(){const e=document.getElementById("carrossel-container-medalhas"),a=document.getElementById("carrossel-indicadores-medalhas");if(e.innerHTML="",a.innerHTML="",carrosseisInternosMedalhasState={},totalSlidesMedalhas=todosMembros.length,todosMembros.forEach((o,t)=>{const n=o.nome,i=medalhasInventarioCache[n]||[];let r=medalhasOrdemCache[n]||[];const d=new Set(i);r=r.filter(e=>d.has(e)),i.forEach(e=>{r.includes(e)||r.push(e)}),medalhasOrdemCache[n]=r;const s=Math.max(1,Math.ceil(r.length/MEDALHAS_POR_PAGINA));carrosseisInternosMedalhasState[n]=0;const l=document.createElement("div");l.className="card-medalhas-membro",l.id=`card-medalhas-${n}`,l.innerHTML=`
            <div class="card-medalhas-header">
                <div class="card-medalhas-nome-container">
            <span class="card-medalhas-nome-membro">${n}</span>
        </div>
                ${n===currentUser?`<button class="botao-ordenar-medalhas" onclick="abrirModalOrdenarMedalhas('${n}')">Ordenar</button>`:""}
            </div>
            <div class="card-medalhas-paginacao-wrapper">
                <div class="card-medalhas-paginacao-container" id="paginacao-container-${n}">
                    </div>
            </div>
            <div class="card-medalhas-controles-internos">
                <button class="btn-pagina-interna prev" onclick="mudarPaginaMedalhas('${n}', -1)" disabled>‚ùÆ</button>
                <div class="indicadores-pagina-interna" id="indicadores-internos-${n}">
                    </div>
                <button class="btn-pagina-interna next" onclick="mudarPaginaMedalhas('${n}', 1)" ${1>=s?"disabled":""}>‚ùØ</button>
            </div>
        `;const m=l.querySelector(`#paginacao-container-${n}`),c=l.querySelector(`#indicadores-internos-${n}`);for(let e=0;e<s;e++){const a=document.createElement("div");a.className="card-medalhas-pagina",a.id=`pagina-${n}-${e}`;const o=e*MEDALHAS_POR_PAGINA,t=r.slice(o,o+MEDALHAS_POR_PAGINA);t.forEach((e,o)=>{const t=todasMedalhasHonra.find(a=>a.id===e);if(t){const n=document.createElement("div"),i=t.categoria.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();n.className=`medalha-honra-display ${`medalha-slot-${o+1}`} ${i}`,n.innerHTML=`<img src="${t.link}" alt="${t.nome}" title="${t.nome} (${t.categoria})">`,n.onclick=()=>abrirModalInfoMedalha(e),a.appendChild(n)}}),m.appendChild(a);const i=document.createElement("div");i.className=`indicador-interno ${0==e?"ativo":""}`,i.dataset.page=e,c.appendChild(i)}if(0===r.length){const e=document.createElement("div");e.className="card-medalhas-pagina",e.id=`pagina-${n}-0`,m.appendChild(e);const a=document.createElement("div");a.className="indicador-interno ativo",a.dataset.page=0,c.appendChild(a)}if(1>=s)l.querySelector(".card-medalhas-controles-internos").style.display="none";else{l.querySelector(".card-medalhas-controles-internos").style.display="flex";const e=l.querySelector(".btn-pagina-interna.next");e&&(e.disabled=!1)}e.appendChild(l);const u=document.createElement("div");u.className="carrossel-indicador",u.onclick=()=>{reiniciarIntervaloCarrosselMedalhas(),irParaSlideMedalhas(t)},a.appendChild(u)}),!(0<totalSlidesMedalhas))e.innerHTML="<div class=\"card-membro\"><p>Nenhum membro encontrado.</p></div>";else if(document.querySelector("#carrossel-indicadores-medalhas .carrossel-indicador")?.classList.add("ativo"),irParaSlideMedalhas(0),1<totalSlidesMedalhas)iniciarCarrosselAutomaticoMedalhas();else{const e=document.getElementById("botao-pausa-medalhas");e&&(e.textContent="\u25B6"),carrosselMedalhasPausado=!0}}function iniciarCarrosselAutomaticoMedalhas(){carrosselMedalhasInterval&&clearInterval(carrosselMedalhasInterval);1>=totalSlidesMedalhas||(carrosselMedalhasInterval=setInterval(()=>{carrosselMedalhasPausado||(currentCarrosselMedalhasIndex=(currentCarrosselMedalhasIndex+1)%totalSlidesMedalhas,irParaSlideMedalhas(currentCarrosselMedalhasIndex))},1e4),iniciarBarraProgressoMedalhas())}function irParaSlideMedalhas(e){const a=document.getElementById("carrossel-container-medalhas");if(a){a.style.transform=`translateX(-${100*e}%)`;const o=document.querySelectorAll("#carrossel-indicadores-medalhas .carrossel-indicador");o.forEach((a,o)=>{a.classList.toggle("ativo",o===e)}),currentCarrosselMedalhasIndex=e,carrosselMedalhasPausado||iniciarBarraProgressoMedalhas()}}function iniciarBarraProgressoMedalhas(){const e=document.getElementById("progresso-indicador-barra-medalhas");!e||1>=totalSlidesMedalhas||(e.style.transition="none",e.style.width="0%",void e.offsetWidth,e.style.transition="width 10s linear",setTimeout(()=>{carrosselMedalhasPausado||(e.style.width="100%")},10),progressoBarraMedalhas&&clearTimeout(progressoBarraMedalhas),progressoBarraMedalhas=setTimeout(()=>{carrosselMedalhasPausado||(e.style.width="0%")},1e4))}window.mudarSlideMedalhas=function(e){1>=totalSlidesMedalhas||(reiniciarIntervaloCarrosselMedalhas(),currentCarrosselMedalhasIndex=(currentCarrosselMedalhasIndex+e+totalSlidesMedalhas)%totalSlidesMedalhas,irParaSlideMedalhas(currentCarrosselMedalhasIndex))},window.togglePausaMedalhas=function(){if(1>=totalSlidesMedalhas)return;carrosselMedalhasPausado=!carrosselMedalhasPausado;const e=document.getElementById("botao-pausa-medalhas"),a=document.getElementById("progresso-indicador-barra-medalhas");carrosselMedalhasPausado?(clearInterval(carrosselMedalhasInterval),e.textContent="\u25B6",a&&(a.style.transition="none",a.dataset.width=window.getComputedStyle(a).width,progressoBarraMedalhas&&clearTimeout(progressoBarraMedalhas))):(e.textContent="\u23F8",a&&(a.style.transition="width 10s linear",setTimeout(()=>{a.style.width="100%"},10)),iniciarCarrosselAutomaticoMedalhas())};function reiniciarIntervaloCarrosselMedalhas(){1>=totalSlidesMedalhas||(clearInterval(carrosselMedalhasInterval),iniciarCarrosselAutomaticoMedalhas())}function mudarPaginaMedalhas(e,a){const o=document.getElementById(`paginacao-container-${e}`),t=document.getElementById(`indicadores-internos-${e}`);if(!o||!t)return;const n=o.children.length;let r=carrosseisInternosMedalhasState[e]||0;r=(r+a+n)%n,carrosseisInternosMedalhasState[e]=r,o.style.transform=`translateX(-${100*r}%)`;const d=t.querySelectorAll(".indicador-interno");d.forEach((e,a)=>{e.classList.toggle("ativo",a===r)});const s=o.closest(".card-medalhas-membro").querySelector(".btn-pagina-interna.prev"),l=o.closest(".card-medalhas-membro").querySelector(".btn-pagina-interna.next");s&&(s.disabled=0===r),l&&(l.disabled=r===n-1),!carrosselMedalhasPausado&&1<totalSlidesMedalhas&&togglePausaMedalhas()}window.mudarPaginaMedalhas=mudarPaginaMedalhas;function configurarModalExposicao(){const e=document.getElementById("btn-exposicao-medalhas");e&&(e.onclick=abrirExposicaoMedalhas);const a=document.querySelectorAll(".filtro-raridade");a.forEach(e=>{e.onclick=()=>{a.forEach(e=>e.classList.remove("ativo")),e.classList.add("ativo"),filtrarMedalhasExposicao(e.dataset.raridade)}})}function abrirExposicaoMedalhas(){const e=document.getElementById("btn-lista-desejos-equipe");"lider"===userRole||"lider-equipe"===userRole?e.classList.remove("hidden"):e.classList.add("hidden"),popularExposicaoMedalhas(),openModal("exposicao-medalhas-modal")}async function abrirModalListaDesejos(){const e=document.getElementById("desejos-equipe-lista");e.innerHTML="<div class=\"ociosos-placeholder\">Carregando lista de desejos...</div>",openModal("desejos-equipe-modal");let a=[];if("lider"===userRole?a=todosMembros.filter(e=>e.nome!==currentUser):"lider-equipe"===userRole&&(a=todosMembros.filter(e=>e.equipe===userTeam&&e.nome!==currentUser)),a.sort((e,a)=>e.nome.localeCompare(a.nome)),0===a.length)return void(e.innerHTML="<div class=\"ociosos-placeholder\">Nenhum membro encontrado para exibir.</div>");e.innerHTML="";let o=0;a.forEach(a=>{const t=a.medalhasDesejadas||[],n=document.createElement("div");n.className="desejo-membro-item";let i="";0<t.length?(o++,t.forEach(e=>{const a=todasMedalhasHonra.find(a=>a.id===e);if(a){const e=a.categoria.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();i+=`
                        <div class="desejo-medalha-card ${e}">
                            <img src="${a.link}" alt="${a.nome}">
                            <div class="medalha-exposicao-nome">${a.nome}</div>
                            <div class="medalha-exposicao-valor">üí∞ ${a.valor.toLocaleString("pt-BR")}</div>
                        </div>
                    `}})):i="<p class=\"ociosos-placeholder\" style=\"width: 100%; margin: 0;\">N\xE3o adicionou nenhuma medalha \xE0 lista de desejos.</p>",n.innerHTML=`
            <h4>${a.nome} (${a.equipe})</h4>
            <div class="desejo-medalhas-grid">
                ${i}
            </div>
        `,e.appendChild(n)}),0==o&&(e.innerHTML="<div class=\"ociosos-placeholder\">Nenhum membro da sua equipe adicionou medalhas \xE0 lista de desejos ainda.</div>")}window.abrirModalListaDesejos=abrirModalListaDesejos;function popularExposicaoMedalhas(e="todas"){const a=document.getElementById("exposicao-medalhas-grid");a.innerHTML="";const o="todas"===e?todasMedalhasHonra:todasMedalhasHonra.filter(a=>a.categoria===e);return 0===o.length?void(a.innerHTML="<p style=\"grid-column: 1 / -1; text-align: center; font-style: italic;\">Nenhuma medalha encontrada.</p>"):void o.forEach(e=>{const o=document.createElement("div"),t=e.categoria.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();o.className=`medalha-exposicao-card ${t}`;const n=(medalhasInventarioCache[currentUser]||[]).includes(e.id),i=(medalhasDesejadasCache[e.id]||[]).includes(currentUser);o.innerHTML=`
            <div class="medalha-exposicao-img-container">
                <img class="medalha-exposicao-img" src="${e.link}" alt="${e.nome}">
            </div>
            <div class="medalha-exposicao-nome">${e.nome}</div>
            <div class="medalha-exposicao-raridade ${t}">${e.categoria}</div>
            <div class="medalha-exposicao-valor">üí∞ ${e.valor.toLocaleString("pt-BR")}</div>
            <div class="medalha-exposicao-botoes">
                <button class="painel-btn" onclick="abrirDetalhesMedalha('${e.id}')">Detalhes</button>
                ${n?"<button class=\"painel-btn\" disabled>Possui</button>":`<button class="painel-btn ${i?"deseja":"btn-adicionar"}" onclick="handleQueroEssa(event, '${e.id}')">${i?"Desejando":"Quero Essa!"}</button>`}
            </div>
        `,a.appendChild(o)})}function filtrarMedalhasExposicao(e){popularExposicaoMedalhas(e)}window.abrirDetalhesMedalha=function(e){const a=todasMedalhasHonra.find(a=>a.id===e);if(!a)return;document.getElementById("detalhes-medalha-nome").textContent=a.nome,document.getElementById("detalhes-medalha-img").src=a.link;const o=document.getElementById("detalhes-medalha-raridade");o.textContent=a.categoria;const t=a.categoria.normalize("NFD").replace(/[\u00c0-\u00cf]/g,"").toLowerCase();o.className=`medalha-exposicao-raridade ${t}`,document.getElementById("detalhes-medalha-valor").textContent=`üí∞ ${a.valor.toLocaleString("pt-BR")}`;const n=document.getElementById("detalhes-medalha-possuidores-lista");n.innerHTML="";let i=0;for(const a in medalhasInventarioCache)if(medalhasInventarioCache[a].includes(e)){const e=document.createElement("span");e.className="medalha-membro-tag",e.textContent=a,n.appendChild(e),i++}document.getElementById("detalhes-medalha-possuidores-count").textContent=i;const r=document.getElementById("detalhes-medalha-desejos-lista");r.innerHTML="";const d=medalhasDesejadasCache[e]||[];d.forEach(e=>{const a=document.createElement("span");a.className="medalha-membro-tag",a.textContent=e,r.appendChild(a)}),document.getElementById("detalhes-medalha-desejos-count").textContent=d.length;const s=document.getElementById("detalhes-medalha-quero-btn"),l=(medalhasInventarioCache[currentUser]||[]).includes(e),m=d.includes(currentUser);l?s.classList.add("hidden"):(s.classList.remove("hidden"),s.textContent=m?"Remover da Lista de Desejos":"Quero Essa!",s.classList.toggle("deseja",m),s.onclick=()=>handleQueroEssa(null,e));const c=document.getElementById("detalhes-medalha-comprar-btn"),u=document.getElementById("detalhes-medalha-comprar-mim-btn"),p="lider"===userRole||"lider-equipe"===userRole;p?(c.classList.remove("hidden"),c.onclick=()=>abrirModalCompraMedalha(e)):c.classList.add("hidden"),p&&!l?(u.classList.remove("hidden"),u.onclick=()=>executarCompraMedalhaParaMim(e)):u.classList.add("hidden"),openModal("detalhes-medalha-modal")};async function handleQueroEssa(e,a){e&&e.stopPropagation();const o=doc(db,"membros",currentUser),t=medalhasDesejadasCache[a]||[],n=t.includes(currentUser),i=n?"arrayRemove":"arrayUnion",r=n?(await getDoc(o)).data().medalhasDesejadas.filter(e=>e!==a):[...((await getDoc(o)).data().medalhasDesejadas||[]),a];try{await updateDoc(o,{medalhasDesejadas:r}),n?medalhasDesejadasCache[a]=t.filter(e=>e!==currentUser):(!medalhasDesejadasCache[a]&&(medalhasDesejadasCache[a]=[]),medalhasDesejadasCache[a].push(currentUser));const e=document.querySelector(`.medalha-exposicao-card button[onclick*="'${a}'"]`);e&&(e.textContent=n?"Quero Essa!":"Desejando",e.classList.toggle("deseja",!n),n?e.classList.add("btn-adicionar"):e.classList.remove("btn-adicionar")),document.getElementById("detalhes-medalha-modal").classList.contains("hidden")||abrirDetalhesMedalha(a),mostrarPopup("\u2705 Atualizado",n?"Medalha removida da sua lista de desejos.":"Medalha adicionada \xE0 sua lista de desejos!",3e3)}catch(e){console.error("Erro ao atualizar lista de desejos:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel atualizar sua lista de desejos.",4e3)}}window.handleQueroEssa=handleQueroEssa;async function abrirModalCompraMedalha(e){if(medalhaParaComprarInfo=todasMedalhasHonra.find(a=>a.id===e),!medalhaParaComprarInfo)return;closeModal("detalhes-medalha-modal"),document.getElementById("compra-medalha-img").src=medalhaParaComprarInfo.link,document.getElementById("compra-medalha-nome").textContent=medalhaParaComprarInfo.nome,document.getElementById("compra-medalha-valor").textContent=medalhaParaComprarInfo.valor.toLocaleString("pt-BR");const a=document.getElementById("compra-medalha-select-membro");a.innerHTML="<option value=\"\">Selecione...</option>";let o=[];"lider"===userRole?o=todosMembros.filter(e=>e.nome!==currentUser):"lider-equipe"===userRole&&(o=todosMembros.filter(e=>e.nome!==currentUser&&e.equipe===userTeam&&"lider"!==e.papel)),o=o.filter(a=>!(medalhasInventarioCache[a.nome]||[]).includes(e)),o.sort((e,a)=>e.nome.localeCompare(a.nome)),o.forEach(e=>{const o=new Option(e.nome,e.nome);a.appendChild(o)});const t=document.getElementById("compra-medalha-fonte-pagamento"),n="lider"===userRole||"lider-equipe"===userRole;if(n&&userTeam)try{const e=await getDoc(doc(db,"membros",currentUser)),a=e.exists()?e.data().moedas||0:0,o=saldosBancosEquipes[userTeam]||0;document.getElementById("saldo-pessoal-medalha").textContent=a.toLocaleString("pt-BR"),document.getElementById("saldo-banco-medalha").textContent=o.toLocaleString("pt-BR"),document.getElementById("fonte-pessoal-medalha").disabled=a<medalhaParaComprarInfo.valor,document.getElementById("fonte-banco-medalha").disabled=o<medalhaParaComprarInfo.valor,a>=medalhaParaComprarInfo.valor?document.getElementById("fonte-pessoal-medalha").checked=!0:o>=medalhaParaComprarInfo.valor&&(document.getElementById("fonte-banco-medalha").checked=!0),t.classList.remove("hidden")}catch(a){console.error("Erro ao buscar saldos para compra de medalha:",a),t.classList.add("hidden")}else t.classList.add("hidden");document.getElementById("compra-medalha-confirmar-btn").onclick=executarCompraMedalha,openModal("compra-medalha-modal")}async function executarCompraMedalha(){if(membroParaReceberMedalha=document.getElementById("compra-medalha-select-membro").value,!membroParaReceberMedalha||!medalhaParaComprarInfo)return void mostrarPopup("\u26A0\uFE0F Aten\xE7\xE3o","Selecione um membro para presentear.",3e3);const e=document.getElementById("compra-medalha-comentario").value.trim();document.getElementById("compra-medalha-comentario").value="";const a=document.querySelector("input[name=\"fonte-pagamento-medalha\"]:checked"),o=a&&!a.disabled?a.value:"pessoal",t=doc(db,"membros",currentUser),n=doc(db,"bancosEquipes",userTeam),i=doc(db,"membros",membroParaReceberMedalha),r=medalhaParaComprarInfo.id,d=medalhaParaComprarInfo.valor;try{await runTransaction(db,async e=>{const a=await e.get(i);if(!a.exists())throw"Membro recebedor n\xE3o encontrado.";let s,l;if("banco"===o){const a=await e.get(n);l=a.exists()?a.data().saldo||0:0,s=n}else{const a=await e.get(t);l=a.exists()?a.data().moedas||0:0,s=t}if(l<d)throw`Saldo insuficiente na ${"banco"===o?"Banco da Equipe":"sua conta pessoal"}.`;const m="banco"===o?"saldo":"moedas";if(e.update(s,{[m]:increment(-d)}),e.update(i,{medalhasInventario:arrayUnion(r)}),"banco"===o){const a=doc(collection(n,"movimentacoes"));e.set(a,{tipo:"compra_medalha",valor:d,descricao:`Compra da medalha "${medalhaParaComprarInfo.nome}" para ${membroParaReceberMedalha}`,membroId:currentUser,timestamp:new Date})}}),medalhasInventarioCache[membroParaReceberMedalha]||(medalhasInventarioCache[membroParaReceberMedalha]=[]),medalhasInventarioCache[membroParaReceberMedalha].push(r),await adicionarEventoAoFeed("medalha","\uD83C\uDFC5 Medalha de Honra Concedida!",`<strong>${currentUser}</strong> presenteou <strong>${membroParaReceberMedalha}</strong> com a Medalha de Honra: <strong>${medalhaParaComprarInfo.nome}</strong>!`,{nomeMembro:membroParaReceberMedalha,doador:currentUser,medalha:medalhaParaComprarInfo.nome});const a=doc(collection(db,"notificacoes"));await setDoc(a,{destinatarioId:membroParaReceberMedalha,remetenteNome:currentUser,tipo:"medalha-presente",conteudo:"\uD83C\uDFC5",acao:`presenteou voc√™ com a Medalha de Honra: ${medalhaParaComprarInfo.nome}!`,lida:!1,timestamp:new Date,medalhaId:r,comentario:e||null}),mostrarPopup("\u2705 Sucesso!",`Medalha "${medalhaParaComprarInfo.nome}" comprada para ${membroParaReceberMedalha}!`,5e3),closeModal("compra-medalha-modal"),await carregarDadosMedalhasHonra()}catch(e){console.error("Erro ao comprar medalha:",e),mostrarPopup("\u274C Erro",e.toString(),5e3)}finally{membroParaReceberMedalha=null,medalhaParaComprarInfo=null}}function abrirModalOrdenarMedalhas(e){if(currentUser!==e)return;membroParaOrdenarMedalhas=e;const a=document.getElementById("ordenar-medalhas-lista");a.innerHTML="";let o=medalhasOrdemCache[e]||[];const t=medalhasInventarioCache[e]||[],n=new Set(t);o=o.filter(e=>n.has(e)),t.forEach(e=>{o.includes(e)||o.push(e)}),ordemMedalhasTemporaria=[...o],ordemMedalhasTemporaria.forEach(e=>{const o=todasMedalhasHonra.find(a=>a.id===e);if(o){const t=document.createElement("li");t.className="ordenar-item",t.draggable=!0,t.dataset.id=e,t.innerHTML=`
                <span class="ordenar-drag-handle">‚ò∞</span>
                <img src="${o.link}" alt="" class="ordenar-medalha-img">
                <span class="ordenar-medalha-nome">${o.nome} (${o.categoria})</span>
            `,a.appendChild(t)}}),configurarDragDropOrdenacao(),document.getElementById("ordenar-medalhas-salvar-btn").onclick=salvarOrdemMedalhas,openModal("ordenar-medalhas-modal")}function configurarDragDropOrdenacao(){const a=document.getElementById("ordenar-medalhas-lista"),o=a.querySelectorAll(".ordenar-item");let t=null;o.forEach(e=>{e.addEventListener("dragstart",()=>{t=e,setTimeout(()=>e.classList.add("dragging"),0)}),e.addEventListener("dragend",()=>{setTimeout(()=>{t?.classList.remove("dragging"),t=null,ordemMedalhasTemporaria=Array.from(a.children).map(e=>e.dataset.id)},0)})}),a.addEventListener("dragover",o=>{o.preventDefault();const e=getDragAfterElementOrdenacao(a,o.clientY);t&&(null==e?a.appendChild(t):a.insertBefore(t,e))})}function getDragAfterElementOrdenacao(e,a){const o=[...e.querySelectorAll(".ordenar-item:not(.dragging)")];return o.reduce((e,o)=>{const t=o.getBoundingClientRect(),n=a-t.top-t.height/2;return 0>n&&n>e.offset?{offset:n,element:o}:e},{offset:Number.NEGATIVE_INFINITY}).element}async function salvarOrdemMedalhas(){if(membroParaOrdenarMedalhas)try{const e=doc(db,"membros",membroParaOrdenarMedalhas);await updateDoc(e,{medalhasOrdem:ordemMedalhasTemporaria}),medalhasOrdemCache[membroParaOrdenarMedalhas]=[...ordemMedalhasTemporaria],mostrarPopup("\u2705 Sucesso","A ordem das suas medalhas foi salva!",3e3),closeModal("ordenar-medalhas-modal"),construirCarrosselMedalhas()}catch(e){console.error("Erro ao salvar ordem das medalhas:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel salvar a nova ordem.",4e3)}finally{membroParaOrdenarMedalhas=null,ordemMedalhasTemporaria=[]}}window.abrirModalOrdenarMedalhas=abrirModalOrdenarMedalhas;async function enviarAgradecimentoMedalha(e,a){if(e&&currentUser){const o=document.getElementById("medalha-ganha-agradecer-btn");o.disabled=!0,o.textContent="Enviando...";try{const t=doc(collection(db,"notificacoes"));await setDoc(t,{destinatarioId:e,remetenteNome:currentUser,tipo:"medalha-agradecimento",conteudo:"\uD83D\uDC96",acao:`agradeceu pela medalha <strong>${a}</strong> que voc√™ enviou!`,lida:!1,timestamp:new Date}),o.textContent="Agradecimento Enviado!",mostrarPopup("\u2705 Sucesso",`Seu agradecimento foi enviado para ${e}!`,4e3)}catch(e){console.error("Erro ao enviar agradecimento:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel enviar o agradecimento.",3e3),o.disabled=!1,o.textContent="Enviar Agradecimento \uD83D\uDC96"}}}async function executarCompraMedalhaParaMim(e){const a=todasMedalhasHonra.find(a=>a.id===e);if(!a)return void mostrarPopup("\u274C Erro Interno","N\xE3o foi poss\xEDvel encontrar os dados desta medalha.",4e3);const o=doc(db,"membros",currentUser),t=doc(db,"bancosEquipes",userTeam),n=a.valor;let i=0,r=0;try{const e=await getDoc(o);i=e.exists()?e.data().moedas||0:0,r=saldosBancosEquipes[userTeam]||0}catch(a){return void mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel buscar seus saldos.",4e3)}const d=`
      <div id="compra-mim-fonte-pagamento" style="margin: 15px 0; text-align: left;">
        <div class="fonte-pagamento-opcoes" style="margin-bottom: 10px;">
          <input type="radio" id="fonte-mim-pessoal" name="fonte-pagamento-mim" value="pessoal" ${i>=n?"checked":"disabled"}>
          <label for="fonte-mim-pessoal" style="font-size: 1.1rem;">
            Meu Saldo (üí∞${i.toLocaleString("pt-BR")})
          </label>
        </div>
        <div class="fonte-pagamento-opcoes">
          <input type="radio" id="fonte-mim-banco" name="fonte-pagamento-mim" value="banco" ${i<n&&r>=n?"checked":""} ${r<n?"disabled":""}>
          <label for="fonte-mim-banco" style="font-size: 1.1rem;">
            Banco da Equipe (üí∞${r.toLocaleString("pt-BR")})
          </label>
        </div>
      </div>
    `;showConfirmationPopup("Confirmar Compra Pessoal",`Voc√™ deseja comprar a medalha "${a.nome}" por <strong>üí∞ ${n.toLocaleString("pt-BR")}</strong> para si mesmo?`+d,async()=>{const i=document.querySelector("input[name=\"fonte-pagamento-mim\"]:checked");if(!i)return void mostrarPopup("\u274C Erro","Nenhuma fonte de pagamento selecionada ou com saldo.",4e3);const r=i.value;try{const i=writeBatch(db);let d,s;if("banco"===r){const e=await getDoc(t);s=e.exists()?e.data().saldo||0:0,d=t}else{const e=await getDoc(o);s=e.exists()?e.data().moedas||0:0,d=o}if(s<n)throw"Saldo insuficiente na fonte selecionada.";const l="banco"===r?"saldo":"moedas";if(i.update(d,{[l]:increment(-n)}),i.update(o,{medalhasInventario:arrayUnion(e)}),"banco"===r){const e=doc(collection(t,"movimentacoes"));i.set(e,{tipo:"compra_medalha",valor:n,descricao:`Compra da medalha "${a.nome}" para ${currentUser}`,membroId:currentUser,timestamp:new Date})}const m=doc(collection(db,"notificacoes"));i.set(m,{destinatarioId:currentUser,remetenteNome:"Lojista",tipo:"medalha-presente",conteudo:"\uD83C\uDFC5",acao:`voc√™ comprou a Medalha de Honra: **${a.nome}**!`,lida:!1,timestamp:new Date,medalhaId:e}),await i.commit(),await adicionarEventoAoFeed("medalha","\uD83C\uDFC5 Nova Medalha de Honra!",`<strong>${currentUser}</strong> comprou para si a Medalha de Honra: <strong>${a.nome}</strong>!`,{nomeMembro:currentUser,medalha:a.nome}),medalhasInventarioCache[currentUser]||(medalhasInventarioCache[currentUser]=[]),medalhasInventarioCache[currentUser].push(e),mostrarPopup("\u2705 Sucesso!",`Medalha "${a.nome}" adicionada ao seu invent√°rio!`,5e3),closeModal("detalhes-medalha-modal"),await carregarDadosMedalhasHonra()}catch(e){console.error("Erro ao comprar medalha para si mesmo:",e),mostrarPopup("\u274C Erro na Compra",e.toString(),5e3)}})}window.abrirModalInfoMedalha=function(e){const a=todasMedalhasHonra.find(a=>a.id===e);if(!a)return console.error("Dados da medalha n\xE3o encontrados:",e),void mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel carregar os detalhes desta medalha.",3e3);document.getElementById("modal-medalha-nome").textContent=a.nome,document.getElementById("modal-medalha-img").src=a.link;const o=document.getElementById("modal-medalha-raridade");o.textContent=a.categoria,document.getElementById("modal-medalha-valor").textContent=`üí∞ ${a.valor.toLocaleString("pt-BR")}`,o.classList.remove("comum","incomum","rara","lendaria");const t=a.categoria.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();o.classList.add(t),openModal("medalha-info-modal")};function dispararConfeteMedalhaGanha(){function e(){o.clearRect(0,0,a.width,a.height);let n=0;for(let e=0;e<t.length;e++){const i=t[e];i.y+=i.speed,i.x+=i.drift,i.angle+=i.spin,o.save(),o.translate(i.x+i.w/2,i.y+i.h/2),o.rotate(i.angle),o.fillStyle=i.color,o.fillRect(-i.w/2,-i.h/2,i.w,i.h),o.restore(),i.y<a.height&&n++}0<n?i=requestAnimationFrame(e):o.clearRect(0,0,a.width,a.height)}const a=document.getElementById("medalha-ganha-confetti");if(!a)return;const o=a.getContext("2d");a.width=window.innerWidth,a.height=window.innerHeight;const t=[],n=["#FFD700","#FFA500","#FF6347","#FFEC8B","#FFFFFF","#FF4500"];for(let e=0;e<300;e++)t.push({x:Math.random()*a.width,y:1.5*(-Math.random()*a.height),w:8*Math.random()+6,h:15*Math.random()+10,color:n[Math.floor(Math.random()*n.length)],angle:2*(Math.random()*Math.PI),speed:5*Math.random()+3,spin:.5*Math.random()-.25,drift:3*Math.random()-1.5});let i;window.medalhaConfettiAnimation&&cancelAnimationFrame(window.medalhaConfettiAnimation),window.medalhaConfettiAnimation=requestAnimationFrame(e)}function dispararConfetePix(){function e(){o.clearRect(0,0,a.width,a.height);let r=0;for(let e=0;e<t.length;e++){const n=t[e];n.y+=n.speed,n.rotation+=n.speed/5,o.font=`${n.size}px Arial`,o.save(),o.translate(n.x,n.y),o.rotate(n.rotation*Math.PI/180),o.fillText("\uD83D\uDCB0",-n.size/2,n.size/2),o.restore(),n.y<a.height&&r++}0<r?n=requestAnimationFrame(e):(o.clearRect(0,0,a.width,a.height),window.pixConfettiAnimation&&(cancelAnimationFrame(window.pixConfettiAnimation),window.pixConfettiAnimation=null))}const a=document.getElementById("pix-recebido-confetti");if(!a)return;const o=a.getContext("2d");a.width=window.innerWidth,a.height=window.innerHeight;const t=[];for(let e=0;e<70;e++)t.push({x:Math.random()*a.width,y:-Math.random()*a.height,speed:3*Math.random()+2,rotation:360*Math.random(),size:15*Math.random()+20});let n;window.pixConfettiAnimation&&cancelAnimationFrame(window.pixConfettiAnimation),window.pixConfettiAnimation=requestAnimationFrame(e)}async function enviarAgradecimentoPix(e,a,o,t){if(e&&currentUser&&a){const n=document.getElementById("pix-recebido-agradecer-btn");n.disabled=!0,n.textContent="Agradecimento Enviado! \u2714\uFE0F";try{await addDoc(collection(db,"notificacoes"),{destinatarioId:e,remetenteNome:currentUser,tipo:"agradecimento_pix",conteudo:"\uD83D\uDCB8",acao:`agradeceu pelo seu Pix de <strong>${a} üí∞ moedas</strong>! üíñ<br><small style="opacity: 0.7;">(C√≥d: ${o})</small>`,lida:!1,timestamp:new Date}),t&&(await updateDoc(doc(db,"notificacoes",t),{agradecimentoEnviado:!0})),mostrarPopup("\u2705 Enviado!",`Seu agradecimento foi enviado para ${e}.`,3e3)}catch(e){console.error("Erro ao enviar agradecimento Pix:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel enviar o agradecimento.",3e3),n.disabled=!1,n.textContent="Enviar Agradecimento \uD83D\uDC96"}}}function dispararConfeteRecompensa(){function e(){o.clearRect(0,0,a.width,a.height);let r=0;for(let e=0;e<t.length;e++){const n=t[e];n.y+=n.speed,n.rotation+=n.speed/5,o.font=`${n.size}px Arial`,o.save(),o.translate(n.x,n.y),o.rotate(n.rotation*Math.PI/180),o.fillText("\uD83C\uDFC6",-n.size/2,n.size/2),o.restore(),n.y<a.height&&r++}0<r?n=requestAnimationFrame(e):(o.clearRect(0,0,a.width,a.height),window.recompensaConfettiAnimation&&(cancelAnimationFrame(window.recompensaConfettiAnimation),window.recompensaConfettiAnimation=null))}const a=document.getElementById("recompensa-recebida-confetti");if(!a)return;const o=a.getContext("2d");a.width=window.innerWidth,a.height=window.innerHeight;const t=[];for(let e=0;e<70;e++)t.push({x:Math.random()*a.width,y:-Math.random()*a.height,speed:3*Math.random()+2,rotation:360*Math.random(),size:15*Math.random()+20});let n;window.recompensaConfettiAnimation&&cancelAnimationFrame(window.recompensaConfettiAnimation),window.recompensaConfettiAnimation=requestAnimationFrame(e)}async function enviarAgradecimentoRecompensa(e,a,o){if(e&&currentUser&&a){const t=document.getElementById("recompensa-recebida-agradecer-btn");t.disabled=!0,t.textContent="Agradecimento Enviado! \u2714\uFE0F";try{const t=`agradeceu pela sua recompensa de <strong>${a.toLocaleString("pt-BR")} üí∞ moedas</strong>! üíñ`;await addDoc(collection(db,"notificacoes"),{destinatarioId:e,remetenteNome:currentUser,tipo:"agradecimento_recompensa",conteudo:"",acao:t,lida:!1,timestamp:new Date}),o&&(await updateDoc(doc(db,"notificacoes",o),{agradecimentoEnviado:!0})),mostrarPopup("\u2705 Enviado!",`Seu agradecimento foi enviado para ${e}.`,3e3)}catch(e){console.error("Erro ao enviar agradecimento de Recompensa:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel enviar o agradecimento.",3e3),t.disabled=!1,t.textContent="Enviar Agradecimento \uD83D\uDC96"}}}function mostrarPopupRecompensaRecebida(e,a,o,t){document.getElementById("recompensa-recebida-titulo").innerHTML=`üèÜ Recompensa Recebida de ${e}!`,document.getElementById("recompensa-recebida-mensagem").innerHTML=`Voc√™ recebeu <strong>${a.toLocaleString("pt-BR")} üí∞ moedas</strong> de <strong>${e}</strong> pelo seu desempenho!`;const n=document.getElementById("recompensa-recebida-agradecimento-container"),i=document.getElementById("recompensa-recebida-agradecer-btn");n.classList.remove("hidden"),t?(i.textContent="Agradecimento J\xE1 Enviado",i.disabled=!0):(i.textContent="Enviar Agradecimento \uD83D\uDC96",i.disabled=!1,i.onclick=()=>enviarAgradecimentoRecompensa(e,a,o)),tocarSom("som-conquista"),dispararConfeteRecompensa();const r=document.getElementById("recompensa-recebida-popup");if(r){const e=document.body.className;r.classList.remove("tema-noite","tema-manha","tema-tarde"),e.includes("tema-noite")?r.classList.add("tema-noite"):e.includes("tema-manha")?r.classList.add("tema-manha"):e.includes("tema-tarde")&&r.classList.add("tema-tarde")}openModal("recompensa-recebida-popup")}function mostrarPopupPixRecebido(e,a,o,t,n,i){document.getElementById("pix-recebido-titulo").innerHTML=`üí∏ Pix Recebido de ${e}!`,document.getElementById("pix-recebido-mensagem").innerHTML=`Voc√™ recebeu <strong>${a} üí∞ moedas</strong> de <strong>${e}</strong>.`;const r=document.getElementById("pix-recebido-comentario");o&&"Nenhum coment\xE1rio."!==o?(r.textContent=`${o}`,r.classList.remove("hidden")):r.classList.add("hidden");const d=document.getElementById("pix-recebido-agradecimento-container"),s=document.getElementById("pix-recebido-agradecer-btn");d.classList.remove("hidden"),i?(s.textContent="Agradecimento J\xE1 Enviado",s.disabled=!0):(s.textContent="Enviar Agradecimento \uD83D\uDC96",s.disabled=!1,s.onclick=()=>enviarAgradecimentoPix(e,a,n,t)),tocarSom("som-conquista"),dispararConfetePix();const l=document.getElementById("pix-recebido-popup");if(l){const e=document.body.className;l.classList.remove("tema-noite","tema-manha","tema-tarde"),e.includes("tema-noite")?l.classList.add("tema-noite"):e.includes("tema-manha")?l.classList.add("tema-manha"):e.includes("tema-tarde")&&l.classList.add("tema-tarde")}openModal("pix-recebido-popup")}function mostrarPopupMedalhaGanha(e,a,o){if(!e)return;document.getElementById("medalha-ganha-img").src=e.link,document.getElementById("medalha-ganha-nome").textContent=e.nome;const t=document.getElementById("medalha-ganha-raridade");t.textContent=e.categoria,document.getElementById("medalha-ganha-valor").textContent=`üí∞ ${e.valor.toLocaleString("pt-BR")}`,t.classList.remove("comum","incomum","rara","lendaria");const n=e.categoria.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();t.classList.add(n);const i=document.getElementById("medalha-ganha-origem");i.innerHTML=a&&a!==currentUser?`Um presente especial de <strong>${a}</strong>! ‚ú®`:`Voc√™ adquiriu esta medalha! Parab√©ns pela sua conquista!`;const r=document.getElementById("medalha-ganha-comentario");o?(r.innerHTML=`"${o.replace(/\n/g,"<br>")}"`,r.classList.remove("hidden")):(r.innerHTML="",r.classList.add("hidden"));const d=document.getElementById("medalha-ganha-agradecimento-container"),s=document.getElementById("medalha-ganha-agradecer-btn");s.disabled=!1,s.textContent="Enviar Agradecimento \uD83D\uDC96",a&&a!==currentUser?(d.classList.remove("hidden"),s.onclick=null,s.onclick=()=>enviarAgradecimentoMedalha(a,e.nome)):d.classList.add("hidden");const l=document.getElementById("medalha-ganha-popup");l.classList.remove("tema-noite","tema-manha","tema-tarde");const m=document.body.className;m.includes("tema-noite")?l.classList.add("tema-noite"):m.includes("tema-manha")?l.classList.add("tema-manha"):m.includes("tema-tarde")&&l.classList.add("tema-tarde"),openModal("medalha-ganha-popup"),tocarSom("som-conquista"),dispararConfeteMedalhaGanha()}async function verificarEExibirPopupNovaMedalha(){if(currentUser&&0!==todasMedalhasHonra.length)try{const e=query(collection(db,"notificacoes"),where("destinatarioId","==",currentUser),where("tipo","==","medalha-presente"),where("lida","==",!1),orderBy("timestamp","desc")),a=await getDocs(e);if(a.empty)return void console.log("Nenhum popup de nova medalha para exibir.");console.log(`Encontradas ${a.size} notifica√ß√µes de medalhas n√£o lidas.`);const o=writeBatch(db);for(const e of a.docs){const a=e.data(),t=a.medalhaId,n=a.remetenteNome,i=a.comentario;if(t){const a=todasMedalhasHonra.find(e=>e.id===t);a&&mostrarPopupMedalhaGanha(a,"Lojista"===n?null:n,i),o.update(e.ref,{lida:!0})}}await o.commit()}catch(e){console.error("Erro ao verificar ou exibir popup de nova medalha:",e)}}async function carregarBancosEquipes(){unsubscribeBancosListener&&unsubscribeBancosListener();const e=query(collection(db,"bancosEquipes"));unsubscribeBancosListener=onSnapshot(e,e=>{saldosBancosEquipes={abelha:0,joaninha:0,vagalume:0},e.forEach(e=>{const a=e.id,o=e.data();saldosBancosEquipes.hasOwnProperty(a)&&(saldosBancosEquipes[a]=o.saldo||0)}),atualizarInterfaceBancos()},e=>{console.error("Erro ao carregar saldos dos bancos:",e)})}function atualizarInterfaceBancos(){for(const e in saldosBancosEquipes){const a=document.getElementById(`banco-saldo-${e}`);a&&(a.textContent=saldosBancosEquipes[e].toLocaleString("pt-BR"))}}async function abrirModalEnviarMoedasBanco(){if(!currentUser||!userTeam)return void mostrarPopup("\uD83D\uDEAB Acesso Negado","Voc\xEA precisa estar em uma equipe para enviar moedas ao banco.",4e3);try{const e=await getDoc(doc(db,"membros",currentUser));if(!e.exists())return;const a=e.data().moedas||0;document.querySelector("#enviar-moedas-saldo-pessoal span").textContent=a.toLocaleString("pt-BR"),document.getElementById("enviar-moedas-nome-equipe").textContent=userTeam.charAt(0).toUpperCase()+userTeam.slice(1),document.getElementById("input-valor-banco").value="",openModal("enviar-moedas-banco-modal")}catch(e){console.error("Erro ao buscar saldo pessoal para envio ao banco:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel buscar seu saldo atual.",4e3)}}async function executarEnvioMoedasBanco(){if(!currentUser||!userTeam)return;const e=document.getElementById("input-valor-banco"),a=parseInt(e.value,10);if(isNaN(a)||0>=a)return void mostrarPopup("\u274C Valor Inv\xE1lido","Por favor, digite um valor positivo.",3e3);const o=doc(db,"membros",currentUser),t=doc(db,"bancosEquipes",userTeam),n=document.getElementById("enviar-moedas-banco-confirmar-btn");n.disabled=!0,n.textContent="Enviando...";try{await runTransaction(db,async e=>{const n=await e.get(o);if(!n.exists())throw"Membro n\xE3o encontrado.";const i=n.data().moedas||0;if(i<a)throw`Saldo insuficiente. Voc√™ tem apenas ${i} moedas.`;e.update(o,{moedas:increment(-a)}),e.set(t,{saldo:increment(a)},{merge:!0});const r=doc(collection(db,"bancosEquipes",userTeam,"movimentacoes"));e.set(r,{tipo:"deposito",membroId:currentUser,valor:a,descricao:`Dep√≥sito de ${currentUser}`,timestamp:new Date})}),await adicionarEventoAoFeed("geral","\uD83D\uDCB8 Contribui\xE7\xE3o ao Banco!",`<strong>${currentUser}</strong> enviou <strong>${a.toLocaleString("pt-BR")} üí∞ moedas</strong> para o banco da Equipe ${userTeam}!`,{nomeMembro:currentUser,equipe:userTeam}),mostrarPopup("\u2705 Sucesso!",`Voc√™ enviou ${a.toLocaleString("pt-BR")} moedas para o banco da equipe!`,5e3),closeModal("enviar-moedas-banco-modal")}catch(e){console.error("Erro ao enviar moedas para o banco:",e),mostrarPopup("\u274C Falha na Transa\xE7\xE3o",e.toString(),5e3)}finally{n.disabled=!1,n.textContent="Confirmar Envio"}}async function processarJurosEAutolimpezaBancos(){const e=getHojeISO(),a=doc(db,"appState","bancoJurosState");try{const o=await getDoc(a);if(o.exists()&&o.data().jurosProcessadoPara===e)return;const t=collection(db,"bancosEquipes"),n=await getDocs(t),i=writeBatch(db);n.forEach(e=>{const a=e.id,o=e.data().saldo||0,t=Math.floor(.03*o);if(0<t){const a=e.ref;i.update(a,{saldo:increment(t)});const o=doc(collection(a,"movimentacoes"));i.set(o,{tipo:"juros",valor:t,descricao:`Rendimento de 3% sobre o saldo`,timestamp:new Date})}});const r=new Date;r.setDate(r.getDate()-30);for(const e of n.docs){const a=e.id,o=collection(e.ref,"movimentacoes"),t=query(o,where("timestamp","<",r)),n=await getDocs(t);n.empty||n.forEach(e=>{i.delete(e.ref)})}i.set(a,{jurosProcessadoPara:e},{merge:!0}),await i.commit()}catch(e){console.error("Erro cr\xEDtico no processamento de juros do banco:",e)}}async function abrirModalExtratoBanco(){if(!currentUser||!userTeam)return void mostrarPopup("\uD83D\uDEAB Acesso Negado","Voc\xEA precisa estar em uma equipe para ver o extrato.",4e3);const e=userTeam.charAt(0).toUpperCase()+userTeam.slice(1);document.getElementById("extrato-banco-titulo").textContent=`üßæ Extrato (${e})`;const a=document.getElementById("extrato-banco-lista");a.innerHTML="<div class=\"ociosos-placeholder\">Carregando...</div>",openModal("extrato-banco-modal");try{const e=collection(db,"bancosEquipes",userTeam,"movimentacoes"),o=query(e,orderBy("timestamp","desc"),limit(50)),t=await getDocs(o);if(t.empty)return void(a.innerHTML="<div class=\"ociosos-placeholder\">Nenhuma movimenta\xE7\xE3o encontrada.</div>");a.innerHTML="",t.forEach(e=>{const o=e.data(),t=document.createElement("div");t.className="extrato-item";const n="deposito"===o.tipo||"juros"===o.tipo||"premio"===o.tipo?"entrada":"saida",i="entrada"===n?"+":"-",r=o.timestamp.toDate(),d=`${r.toLocaleDateString("pt-BR")} ${r.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"})}`;t.innerHTML=`
        <div class="extrato-info">
          <div class="extrato-descricao">${o.descricao}</div>
          <div class="extrato-data">${d}</div>
        </div>
        <div class="extrato-valor ${n}">
          ${i} ${o.valor.toLocaleString("pt-BR")} üí∞
        </div>
      `,a.appendChild(t)})}catch(e){console.error("Erro ao carregar extrato do banco:",e),a.innerHTML="<div class=\"ociosos-placeholder\">Falha ao carregar o extrato.</div>"}}async function abrirModalEstatisticasBanco(){if(!currentUser||!userTeam)return void mostrarPopup("\uD83D\uDEAB Acesso Negado","Voc\xEA precisa estar em uma equipe para ver as estat\xEDsticas.",4e3);const e=userTeam.charAt(0).toUpperCase()+userTeam.slice(1);document.getElementById("estatisticas-banco-titulo").textContent=`üìä Estat√≠sticas (${e})`,document.querySelector(".avatar-tab-btn[data-tab-stats=\"contribuidores\"]").click();const a=document.getElementById("stats-juros-lista"),o=document.getElementById("stats-contribuidores-lista");a.innerHTML="<div class=\"ociosos-placeholder\">Calculando...</div>",o.innerHTML="<div class=\"ociosos-placeholder\">Calculando...</div>",openModal("estatisticas-banco-modal");try{const e=collection(db,"bancosEquipes",userTeam,"movimentacoes"),t=query(e,orderBy("timestamp","desc")),n=await getDocs(t);if(n.empty)return a.innerHTML="<div class=\"ociosos-placeholder\">Nenhum rendimento ainda.</div>",void(o.innerHTML="<div class=\"ociosos-placeholder\">Nenhum contribuidor ainda.</div>");const i=[],r={};if(n.forEach(e=>{const a=e.data();"juros"===a.tipo&&i.push(a),"deposito"===a.tipo&&a.membroId&&(!r[a.membroId]&&(r[a.membroId]=0),r[a.membroId]+=a.valor)}),0===i.length?a.innerHTML="<div class=\"ociosos-placeholder\">Nenhum rendimento ainda.</div>":(a.innerHTML="",i.forEach(e=>{const o=document.createElement("div");o.className="stats-item";const t=e.timestamp.toDate(),n=`${t.toLocaleDateString("pt-BR")} ${t.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"})}`;o.innerHTML=`
          <div class="extrato-info">
            <div class="extrato-descricao">${e.descricao}</div>
            <div class="stats-juros-data">${n}</div>
          </div>
          <div class="stats-juros-valor">+ ${e.valor.toLocaleString("pt-BR")} üí∞</div>
        `,a.appendChild(o)})),0===Object.keys(r).length)o.innerHTML="<div class=\"ociosos-placeholder\">Nenhum contribuidor ainda.</div>";else{o.innerHTML="";const e=Object.entries(r).sort(([,e],[,a])=>a-e).slice(0,10);e.forEach(([e,a],t)=>{const n=document.createElement("div");n.className="stats-item";let i=`${t+1}¬∫`;0===t&&(i="\uD83E\uDD47"),1===t&&(i="\uD83E\uDD48"),2===t&&(i="\uD83E\uDD49"),n.innerHTML=`
          <span class="stats-posicao">${i}</span>
          <span class="stats-nome">${e}</span>
          <span class="stats-valor">${a.toLocaleString("pt-BR")} üí∞</span>
        `,o.appendChild(n)})}}catch(e){console.error("Erro ao carregar estat\xEDsticas do banco:",e),a.innerHTML="<div class=\"ociosos-placeholder\">Falha ao carregar dados.</div>",o.innerHTML="<div class=\"ociosos-placeholder\">Falha ao carregar dados.</div>"}}function inicializarLojaPoderes(){todosPoderesInfo=[{id:"pocao_sextagem",nome:"Po\xE7\xE3o da Sextagem",emoji:"\uD83C\uDF7A",descricao:"Concede folga imediata para todos os membros da sua equipe. As caixas de sele\xE7\xE3o de todos os membros ativos da sua equipe ser\xE3o marcadas automaticamente no momento da compra.",preco:5e4,limiteTipo:"semanal",limiteQtd:1,requerAlvo:!1},{id:"praga_kriptonita",nome:"Praga de Kriptonita",emoji:"\uD83E\uDD22",descricao:"Impede uma equipe advers\xE1ria de comprar qualquer poder na Lojinha. O efeito dura 3 dias a partir do momento da compra.",preco:2e4,limiteTipo:"semanal",limiteQtd:1,requerAlvo:!0},{id:"maldicao_pilantragem",nome:"Maldi\xE7\xE3o da Pilantragem",emoji:"\uD83D\uDC80",descricao:"Retira 2 pontos da pontua\xE7\xE3o m\xE9dia de uma equipe advers\xE1ria. A dedu\xE7\xE3o ser\xE1 aplicada em tempo real no placar da semana e no resultado detalhado de domingo.",preco:1e5,limiteTipo:"quinzenal",limiteQtd:1,requerAlvo:!0},{id:"elixir_vida",nome:"Elixir de Vida",emoji:"\uD83D\uDC96",descricao:"Adiciona 2 pontos \xE0 pontua\xE7\xE3o m\xE9dia da sua equipe. O b\xF4nus ser\xE1 aplicado em tempo real no placar da semana e no resultado detalhado de domingo.",preco:3e4,limiteTipo:"semanal",limiteQtd:1,requerAlvo:!1},{id:"runa_soft_block",nome:"Runa do Soft Block",emoji:"\uD83D\uDD12",descricao:"Impede que todos os membros de uma equipe advers\xE1ria (exceto o l\xEDder dela) fa\xE7am login na p\xE1gina por 3 dias.",preco:12e4,limiteTipo:"quinzenal",limiteQtd:1,requerAlvo:!0},{id:"amuleto_protecao",nome:"Amuleto de Prote\xE7\xE3o",emoji:"\uD83D\uDEE1\uFE0F",descricao:"Torna sua equipe imune a todas as maldi\xE7\xF5es de outras equipes (Kriptonita, Pilantragem e Soft Block) at\xE9 o final da competi\xE7\xE3o no s\xE1bado.",preco:6e4,limiteTipo:"quinzenal",limiteQtd:1,requerAlvo:!1}]}async function carregarStatusPoderes(){console.log("[LOJA PODERES] Carregando status e hist\xF3rico...");const e=getSemanaAtual(),a=`semana_${e.numero}_${e.inicio.getFullYear()}`;statusPoderesAtivos=[],historicoPoderesSemana={};try{const a=collection(db,"statusPoderes"),o=query(a,where("expiraEm",">",new Date)),t=await getDocs(o);t.forEach(e=>{statusPoderesAtivos.push({id:e.id,...e.data()})}),console.log(`[LOJA PODERES] ${statusPoderesAtivos.length} efeitos de poder ativos carregados.`);const n=1===e.numero?52:e.numero-1,i=1===e.numero?e.inicio.getFullYear()-1:e.inicio.getFullYear(),r=collection(db,"historicoPoderes"),d=query(r,where("semana","in",[e.numero,n])),s=await getDocs(d);s.forEach(e=>{const a=e.data();if(a.semana!==n||a.timestamp.toDate().getFullYear()===i){const e=a.equipe;historicoPoderesSemana[e]||(historicoPoderesSemana[e]={}),historicoPoderesSemana[e][a.poderId]||(historicoPoderesSemana[e][a.poderId]=[]),historicoPoderesSemana[e][a.poderId].push(a)}}),console.log("[LOJA PODERES] Hist\xF3rico de compras da semana carregado.")}catch(e){console.error("Erro ao carregar status dos poderes:",e)}construirInterfaceLojaPoderes()}function construirInterfaceLojaPoderes(){const e=document.getElementById("loja-poderes-grid");if(!e)return;e.innerHTML="";const a=getSemanaAtual(),o=1===a.numero?52:a.numero-1,t=1===a.numero?a.inicio.getFullYear()-1:a.inicio.getFullYear();todosPoderesInfo.forEach(n=>{const i=document.createElement("div");i.className="poder-card",i.onclick=()=>abrirModalDetalhesPoder(n.id);let r=!0,d="";const s=historicoPoderesSemana[userTeam]||{},l=s[n.id]||[];if("semanal"===n.limiteTipo){const e=l.filter(e=>e.semana===a.numero);e.length>=n.limiteQtd&&(r=!1,d="Limite semanal atingido")}else if("quinzenal"===n.limiteTipo){const e=l.filter(e=>e.semana===a.numero);if(e.length>=n.limiteQtd)r=!1,d="Limite de compra atingido";else{const e=l.filter(e=>e.semana===o&&e.timestamp.toDate().getFullYear()===t);0<e.length&&(r=!1,d="Em espera (usado na semana passada)")}}let m="";m="membro"===userRole?`<button class="poder-card-botao pedir">Ver Detalhes</button>`:`<button class="poder-card-botao comprar">Ver Detalhes</button>`,i.innerHTML=`
            <div class="poder-emoji">${n.emoji}</div>
            <div class="poder-nome">${n.nome}</div>
            <div class="poder-preco">üí∞ ${n.preco.toLocaleString("pt-BR")}</div>
            ${m}
        `,r||(i.classList.add("em-cooldown"),i.onclick=null,i.innerHTML+=`<div class="poder-cooldown-overlay">${d}</div>`),e.appendChild(i)})}function abrirModalDetalhesPoder(e){const a=todosPoderesInfo.find(a=>a.id===e);if(!a)return;poderParaComprar=a,document.getElementById("detalhes-poder-titulo").textContent=a.nome,document.getElementById("detalhes-poder-emoji").textContent=a.emoji,document.getElementById("detalhes-poder-preco").textContent=`üí∞ ${a.preco.toLocaleString("pt-BR")}`,document.getElementById("detalhes-poder-descricao").textContent=a.descricao,document.getElementById("detalhes-poder-limite").textContent=`Limite: ${a.limiteQtd} por ${"semanal"===a.limiteTipo?"semana":"ciclo quinzenal"}.`;const o=document.getElementById("detalhes-poder-btn-comprar"),t=document.getElementById("detalhes-poder-btn-pedir");"membro"===userRole?(o.classList.add("hidden"),t.classList.remove("hidden")):(o.classList.remove("hidden"),t.classList.add("hidden")),openModal("modal-poder-detalhes")}async function pedirPoderAoLider(){if(userTeam&&poderParaComprar){const e=equipes[userTeam]?.lider;if(!e)return void mostrarPopup("\u274C Sem L\xEDder","Sua equipe n\xE3o tem um l\xEDder de equipe para notificar.",4e3);try{const a=doc(collection(db,"notificacoes"));await setDoc(a,{destinatarioId:e.nome,remetenteNome:currentUser,tipo:"poder",conteudo:"\uD83D\uDCA1",acao:`sugeriu a compra do poder: **${poderParaComprar.nome}** para a equipe!`,lida:!1,timestamp:new Date}),mostrarPopup("\u2705 Pedido Enviado!",`Sua sugest√£o foi enviada para ${e.nome}.`,4e3),closeModal("modal-poder-detalhes"),poderParaComprar=null}catch(e){console.error("Erro ao pedir poder ao l\xEDder:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel enviar sua sugest\xE3o.",4e3)}}}window.pedirPoderAoLider=pedirPoderAoLider;async function iniciarCompraPoder(){if(!userTeam||!poderParaComprar)return;const e=poderParaComprar,a=userTeam,o=e.preco,t=statusPoderesAtivos.find(e=>"praga_kriptonita"===e.poderId&&e.equipeAlvo===a);if(t){const e=t.expiraEm.toDate().toLocaleString("pt-BR");return void mostrarPopup("\uD83D\uDEAB Compra Bloqueada",`Sua equipe est√° sob o efeito da Praga de Kriptonita e n√£o pode comprar poderes at√© ${e}.`,7e3)}const n=saldosBancosEquipes[a]||0;return n<o?void mostrarPopup("\uD83D\uDCB0 Saldo Insuficiente",`O banco da sua equipe tem ${n.toLocaleString("pt-BR")} moedas. Voc√™ precisa de ${o.toLocaleString("pt-BR")}.`,5e3):void(e.requerAlvo?abrirModalSelecionarAlvo():abrirModalConfirmarCompra(null))}window.iniciarCompraPoder=iniciarCompraPoder;function abrirModalSelecionarAlvo(){const e=document.getElementById("lista-equipes-alvo");e.innerHTML="";const a=Object.keys(equipes).filter(e=>e!==userTeam);a.forEach(a=>{const o=document.createElement("div");o.className="equipe-alvo-opcao",o.innerHTML=`
            <input type="radio" id="alvo-${a}" name="equipe_alvo" value="${a}">
            <label for="alvo-${a}">
                Equipe ${a.charAt(0).toUpperCase()+a.slice(1)}
            </label>
        `,e.appendChild(o)}),document.getElementById("confirmar-alvo-btn").onclick=()=>{const e=document.querySelector("input[name=\"equipe_alvo\"]:checked");return e?void(equipeAlvoParaPoder=e.value,closeModal("modal-selecionar-equipe-alvo"),abrirModalConfirmarCompra(equipeAlvoParaPoder)):void mostrarPopup("\u26A0\uFE0F Aten\xE7\xE3o","Voc\xEA precisa selecionar uma equipe alvo.",3e3)},closeModal("modal-poder-detalhes"),openModal("modal-selecionar-equipe-alvo")}async function registrarFalhaDePoder(e,a,o,t,n){const i=writeBatch(db),r=doc(db,"bancosEquipes",a);i.update(r,{saldo:increment(-t)}),i.update(r,{saldo:increment(t)});const d=doc(collection(r,"movimentacoes"));i.set(d,{tipo:"compra_poder_falha",membroId:currentUser,valor:t,descricao:`Tentativa de usar ${e.nome} em ${o} (falhou)`,timestamp:n});const s=doc(collection(r,"movimentacoes"));i.set(s,{tipo:"reembolso_amuleto",membroId:"Sistema",valor:t,descricao:`Reembolso: ${e.nome} falhou (alvo protegido)`,timestamp:new Date(n.getTime()+1e3)});const l=doc(collection(db,"historicoPoderes"));i.set(l,{equipe:a,poderId:e.id,alvo:o,semana:getSemanaAtual().numero,timestamp:n});const m=doc(collection(db,"statusPoderes"));i.set(m,{poderId:"amuleto_falha",nomePoder:e.nome,usadoPor:a,equipeAlvo:o,valorReembolsado:t,expiraEm:new Date(n.getTime()+259200000)}),await i.commit()}function abrirModalConfirmarCompra(e){const a=document.getElementById("resumo-compra-poder"),o=saldosBancosEquipes[userTeam]||0,t=o-poderParaComprar.preco;let n=`
        <p><strong>Poder:</strong> ${poderParaComprar.nome}</p>
        <p><strong>Custo:</strong> üí∞ ${poderParaComprar.preco.toLocaleString("pt-BR")}</p>
        ${e?`<p><strong>Alvo:</strong> Equipe ${e}</p>`:""}
        <hr style="margin: 10px 0;">
        <p><strong>Saldo do Banco:</strong> ${o.toLocaleString("pt-BR")}</p>
        <p><strong>Novo Saldo:</strong> ${t.toLocaleString("pt-BR")}</p>
    `;a.innerHTML=n,document.getElementById("confirmar-compra-poder-btn").onclick=executarCompraPoder,closeModal("modal-poder-detalhes"),openModal("modal-confirmar-compra-poder")}async function executarCompraPoder(){if(comprandoPoder)return void mostrarPopup("\u23F3 Aguarde","Uma compra j\xE1 est\xE1 em processamento...",3e3);comprandoPoder=!0;const e=poderParaComprar,a=userTeam,o=equipeAlvoParaPoder,t=e.preco,n=getSemanaAtual(),i=`semana_${n.numero}_${n.inicio.getFullYear()}`,r=new Date,d=document.getElementById("confirmar-compra-poder-btn");d.disabled=!0,d.textContent="Processando...";try{let i=!1;if(o&&"amuleto_protecao"!==e.id){const e=collection(db,"statusPoderes"),a=query(e,where("expiraEm",">",new Date),where("poderId","==","amuleto_protecao"),where("equipeAlvo","==",o)),t=await getDocs(a);i=!t.empty}let d="";if(i)console.log(`[LOJA PODERES] Ataque falhou! Equipe ${o} est√° imune.`),await registrarFalhaDePoder(e,a,o,t,r),d=`<strong>${currentUser}</strong> (Equipe ${a}) usou o poder <strong>${e.emoji} ${e.nome}</strong> contra a <strong>Equipe ${o}</strong>... mas o alvo estava protegido por um amuleto! A magia falhou e as üí∞${t.toLocaleString("pt-BR")} moedas foram devolvidas ao banco.`,await adicionarEventoAoFeed("geral","\uD83D\uDEE1\uFE0F Magia Bloqueada!",d,{nomeMembro:currentUser,equipe:a});else if("pocao_sextagem"===e.id)await aplicarPocaoSextagem(a,t,e,r),d=`<strong>${currentUser}</strong> (Equipe ${a}) usou o poder <strong>${e.emoji} ${e.nome}</strong> e concedeu folga para toda a sua equipe!`,await adicionarEventoAoFeed("geral","\uD83D\uDD25 Poder Ativado!",d,{nomeMembro:currentUser,equipe:a});else{const i=writeBatch(db),s=doc(db,"bancosEquipes",a);i.update(s,{saldo:increment(-t)});const l=doc(collection(db,"bancosEquipes",a,"movimentacoes"));let m=`Compra do poder: ${e.nome}`;o&&(m+=` (Alvo: ${o})`),i.set(l,{tipo:"compra_poder",membroId:currentUser,valor:t,descricao:m,timestamp:r});const c=doc(collection(db,"historicoPoderes"));i.set(c,{equipe:a,poderId:e.id,alvo:o||null,semana:n.numero,timestamp:r}),aplicarEfeitoPoderBatch(i,e,a,o,r),await i.commit(),"amuleto_protecao"!==e.id&&(d=`<strong>${currentUser}</strong> (Equipe ${a}) usou o poder <strong>${e.emoji} ${e.nome}</strong>`,d+=o?` contra a <strong>Equipe ${o}</strong>!`:"elixir_vida"===e.id?` para acresentar +2 pontos √† m√©dia da sua equipe!`:`!`,await adicionarEventoAoFeed("geral","\uD83D\uDD25 Poder Ativado!",d,{nomeMembro:currentUser,equipe:a}))}mostrarPopup("\u2705 Poder Ativado!",`${e.nome} foi usado com sucesso!`,5e3)}catch(e){console.error("Erro ao executar a compra do poder:",e),mostrarPopup("\u274C Erro Cr\xEDtico",`A compra falhou: ${e.message}`,6e3)}finally{comprandoPoder=!1,d.disabled=!1,d.textContent="Confirmar e Usar",closeModal("modal-confirmar-compra-poder"),poderParaComprar=null,equipeAlvoParaPoder=null,await carregarStatusPoderes(),await atualizarMediaEquipes()}}function aplicarEfeitoPoderBatch(e,a,o,t,n){const i=getSemanaAtual(),r=`semana_${i.numero}_${i.inicio.getFullYear()}`,d=doc(db,"vantagemSemanal",r);let s;switch(a.id){case"praga_kriptonita":s=new Date(n.getTime()+259200000),e.set(doc(collection(db,"statusPoderes")),{equipeAlvo:t,poderId:a.id,nomePoder:a.nome,usadoPor:o,expiraEm:s});break;case"maldicao_pilantragem":e.set(d,{deducoesPoderes:{[t]:arrayUnion({por:o,nomePoder:a.nome,valor:-2,timestamp:n})}},{merge:!0});break;case"elixir_vida":e.set(d,{adicoesPoderes:{[o]:arrayUnion({por:o,nomePoder:a.nome,valor:2,timestamp:n})}},{merge:!0});break;case"runa_soft_block":s=new Date(n.getTime()+259200000),e.set(doc(collection(db,"statusPoderes")),{equipeAlvo:t,poderId:a.id,nomePoder:a.nome,usadoPor:o,expiraEm:s});break;case"amuleto_protecao":const r=new Date(i.fim);r.setHours(23,59,59),e.set(doc(collection(db,"statusPoderes")),{equipeAlvo:o,poderId:a.id,nomePoder:a.nome,usadoPor:o,expiraEm:r});}}async function aplicarPocaoSextagem(e,a,o,t){const n=getSemanaAtual(),i=getHojeISO();await updateDoc(doc(db,"bancosEquipes",e),{saldo:increment(-a)});const r=doc(collection(db,"bancosEquipes",e,"movimentacoes"));await setDoc(r,{tipo:"compra_poder",membroId:currentUser,valor:a,descricao:`Compra do poder: ${o.nome}`,timestamp:t});const d=doc(collection(db,"historicoPoderes"));await setDoc(d,{equipe:e,poderId:o.id,alvo:null,semana:n.numero,timestamp:t});const s=equipes[e].membros.filter(e=>!e.deFerias);let l=0;for(const n of s){const e=await getDoc(doc(db,"presencas",i)),a=e.exists()&&e.data()[n.nome];a||(await marcarPresencaPoder(n),l++)}console.log(`[LOJA PODERES] Po√ß√£o da Sextagem marcou ${l} membros.`)}async function marcarPresencaPoder(e){if(!e||!e.nome)return;const a=e.nome,o=getHojeISO(),t=doc(db,"membros",a),n=doc(db,"presencas",o),i=doc(db,"semanas","pontosSemanais");try{const{novoStreak:o}=await runTransaction(db,async e=>{const o=await e.get(t);if(!o.exists())throw"Membro n\xE3o encontrado.";let r;const d=o.data().equipe;d&&0!==getHoje().getDay()&&(r=await e.get(i));const s=(o.data().streak||0)+1;let l=0;d&&0!==getHoje().getDay()&&r&&r.exists()&&(l=r.data()[d]||0);const m=l+1;return e.set(n,{[a]:new Date},{merge:!0}),e.update(t,{streak:s}),d&&0!==getHoje().getDay()?(e.set(i,{[d]:m},{merge:!0}),{novoStreak:s,novosPontosEquipe:m}):{novoStreak:s,novosPontosEquipe:l}});streaksCache[a]=o,atualizarStreakVisualMembro(a,o),e.equipe&&0!==getHoje().getDay()&&pontosSemanais[e.equipe]++;const r=document.getElementById(a);r&&(r.checked=!0),await atualizarResumo()}catch(e){console.error(`Erro ao marcar presen√ßa (poder) para ${a}:`,e)}}async function regerarAnaliseOraculoSemanaPassada(){if(confirm("Isso ir\xE1 regerar a an\xE1lise do Or\xE1culo para a semana passada e salv\xE1-la no banco de dados. Deseja continuar?")){showLoadingOverlay("O Or\xE1culo est\xE1 consultando os resultados...");try{const e=getHoje(),a=getSemanaAtual(new Date(e.getTime()-86400000)),o=`semana_${a.numero}_${a.inicio.getFullYear()}`,t=doc(db,"resultadosCompeticao",o),n=await getDoc(t);if(!n.exists())throw new Error("O documento de resultados da semana passada ainda n\xE3o existe. A an\xE1lise n\xE3o pode ser gerada.");const i=n.data();updateLoadingOverlayText("A IA est\xE1 escrevendo a nova an\xE1lise...");const r=await gerarResumoSemanalComIA(i,a);updateLoadingOverlayText("Salvando an\xE1lise no banco de dados..."),await updateDoc(t,{analiseOraculo:r}),sessionStorage.removeItem("popupAnaliseOraculoVisto"),hideLoadingOverlay(),mostrarPopup("\u2705 Sucesso!","A an\xE1lise foi gerada e salva com sucesso!",4e3),setTimeout(()=>{mostrarPopupAnaliseOraculo(r)},500)}catch(e){hideLoadingOverlay(),console.error("Erro ao regerar an\xE1lise do Or\xE1culo:",e),mostrarPopup("\u274C Erro",`Falha ao regerar: ${e.message}`,5e3)}}}window.regerarAnaliseOraculoSemanaPassada=regerarAnaliseOraculoSemanaPassada,window.testarPopupRecompensa5k=function(){if(!currentUser)return void console.log("Voc\xEA precisa estar logado para testar.");const e=equipes[userTeam]?.lider?.nome||"Seu L\xEDder";mostrarPopupRecompensaRecebida(e,5e3,"teste_notificacao_id_5k",!1)},window.testarPopupRecompensa100k=function(){if(!currentUser)return void console.log("Voc\xEA precisa estar logado para testar.");mostrarPopupRecompensaRecebida("Sistema",100000,"teste_notificacao_id_100k",!1)},window.onload=async()=>{initAuth(),setupMaintenanceListenerAndCheck();const e=await verificarEstadoManutencaoInicial();if(e)return console.log("Modo de Manuten\xE7\xE3o ATIVO. Carregamento de dados principais interrompido."),document.getElementById("maintenance-overlay").classList.remove("hidden"),void(document.body.style.overflow="hidden");const a=localStorage.getItem("loggedInUser");if(a)await performSuccessfulLogin(a);else{authContainer.classList.remove("hidden"),dataAtual=getHojeISO();const e=new Date().getHours(),a=document.body;a.classList.remove("tema-manha","tema-tarde","tema-noite"),5<=e&&12>e?a.classList.add("tema-manha"):12<=e&&18>e?a.classList.add("tema-tarde"):a.classList.add("tema-noite")}atualizarRelogio(),setInterval(atualizarRelogio,1e3),setInterval(verificarMudancaData,6e4),window.addEventListener("focus",verificarMudancaData),window.abrirDetalhesMedalha=abrirDetalhesMedalha,window.handleQueroEssa=handleQueroEssa,window.abrirModalCompraMedalha=abrirModalCompraMedalha,window.abrirModalOrdenarMedalhas=abrirModalOrdenarMedalhas,window.mudarPaginaMedalhas=mudarPaginaMedalhas,window.processarJurosEAutolimpezaBancos=processarJurosEAutolimpezaBancos};
