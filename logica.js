import{initializeApp}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";import{getFirestore,doc,setDoc,getDoc,collection,getDocs,updateDoc,deleteDoc,increment,writeBatch,query,where,onSnapshot,runTransaction}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";const firebaseConfig={apiKey:"AIzaSyDoncRn8ikIdij8aXC0OUeqdqnLITrhmPc",authDomain:"foco-diario-75630.firebaseapp.com",projectId:"foco-diario-75630",storageBucket:"foco-diario-75630.appspot.com",messagingSenderId:"1040579676771",appId:"1:1040579676771:web:ca12f964d8adb3778e4656"},app=initializeApp(firebaseConfig),db=getFirestore(app);Date.prototype.getBrasiliaHours=function(){const e=this.getTimezoneOffset()+180;return(this.getHours()+Math.floor(e/60))%24};let carrosselInterval,progressoBarra,streaksCache={},todosMembros=[],equipes={abelha:{membros:[],lider:null},joaninha:{membros:[],lider:null},vagalume:{membros:[],lider:null}},liderGeral=null,currentUser=null,userRole=null,userTeam=null,currentCarrosselIndex=0,carrosselPausado=!1,totalSlides=0,membroParaExpulsar=null;const medalhas={3:{emoji:"\uD83D\uDD25",nome:"Fagulha"},10:{emoji:"\uD83D\uDC51",nome:"Lenda"},30:{emoji:"\uD83C\uDF1F",nome:"Constante"},60:{emoji:"\uD83D\uDC8E",nome:"Diamante"},120:{emoji:"\uD83D\uDE80",nome:"Foguete"},150:{emoji:"\uD83C\uDFC6",nome:"Trof\xE9u"},240:{emoji:"\uD83D\uDD2E",nome:"Bola de cristal"},365:{emoji:"\uD83C\uDF1E",nome:"Solar"}},totalDiasMembros={},pontosSemanais={abelha:0,joaninha:0,vagalume:0},rankingGeral={abelha:0,joaninha:0,vagalume:0},historicoAcoes={};let timeoutClique,authContainer,mainContent,logoutBtn,loginForm,changePasswordForm,forgotPasswordForm,secretQuestionForm,loginBtn,loginUsernameInput,loginPasswordInput,atualizando=!1,dataAtual="",filaAtualizacao=Promise.resolve(),cliqueCount=0,composerSelectedColor="#CAFFBF",composerTimestampInterval=null,composerEditMode=!1,editingMessageId=null,messageIdToDelete=null,unsubscribeViewerListener=null,checkboxLocks={},currentUserRole="membro",currentUserTeam=null,memberIdToRemove=null;function getHoje(){return new Date}function getHojeISO(){const e=new Date,a=e.getFullYear(),t=(e.getMonth()+1+"").padStart(2,"0"),n=(e.getDate()+"").padStart(2,"0");return`${a}-${t}-${n}`}function formatarData(e){const a=(e.getDate()+"").padStart(2,"0"),t=(e.getMonth()+1+"").padStart(2,"0"),n=e.getFullYear();return`${a}/${t}/${n}`}function getSemanaAtual(e=null){const a=e||getHoje(),t=a.getDay();if(0===t){const e=new Date(a);e.setDate(a.getDate()-1);const t=new Date(e);return t.setDate(e.getDate()-6),{inicio:t,fim:e,numero:Math.ceil((t-new Date(t.getFullYear(),0,1))/86400000/7),inicioFormatado:formatarData(t),fimFormatado:formatarData(e),fimCompeticao:formatarData(e).slice(0,5)}}const n=new Date(a);n.setDate(a.getDate()-(t-1));const o=new Date(n);o.setDate(n.getDate()+5);const r=new Date(n.getFullYear(),0,1),i=Math.floor((n-r)/86400000),d=Math.ceil((i+r.getDay()+1)/7);return{inicio:n,fim:o,numero:d,inicioFormatado:formatarData(n),fimFormatado:formatarData(o),fimCompeticao:formatarData(o).slice(0,5)}}async function salvarPresenca(){const e=getHoje(),a=getHojeISO(),t={};todosMembros.forEach(e=>{const a=e.nome,n=document.getElementById(a);n&&(t[a]=n.checked)}),await setDoc(doc(db,"presencas",a),t)}async function carregarPresenca(){const e=getHojeISO(),a=await getDoc(doc(db,"presencas",e));if(a.exists()){const e=a.data();todosMembros.forEach(a=>{const t=a.nome,n=document.getElementById(t);n&&e[t]&&(n.checked=e[t])})}}async function carregarTotalDias(){const e=await getDocs(collection(db,"presencas"));todosMembros.forEach(e=>{totalDiasMembros[e.nome]=0}),e.forEach(e=>{const a=e.data();Object.keys(a).forEach(e=>{a[e]&&todosMembros.some(a=>a.nome===e)&&(totalDiasMembros[e]=(totalDiasMembros[e]||0)+1)})}),atualizarMedalhas()}async function carregarPontosSemanais(){const e=getHoje(),a=doc(db,"semanas","pontosSemanais"),t=await getDoc(a);if(t.exists()){const e=t.data();pontosSemanais.abelha=e.abelha||0,pontosSemanais.joaninha=e.joaninha||0,pontosSemanais.vagalume=e.vagalume||0}else 0!==e.getDay()&&(await setDoc(a,{abelha:0,joaninha:0,vagalume:0})),pontosSemanais.abelha=0,pontosSemanais.joaninha=0,pontosSemanais.vagalume=0}async function carregarRankingGeral(){const e=await getDoc(doc(db,"ranking","geral"));if(e.exists()){const a=e.data();rankingGeral.abelha=a.abelha||0,rankingGeral.joaninha=a.joaninha||0,rankingGeral.vagalume=a.vagalume||0}atualizarRankingGeral()}async function finalizarSemana(){const e=getHoje();if(6===e.getDay()){const e=getSemanaAtual(),a=`semana_${e.numero}_${e.inicio.getFullYear()}`,t=doc(db,"vantagemSemanal",a),n=doc(db,"semanas","pontosSemanais");try{await runTransaction(db,async e=>{const a=await e.get(t);if(a.exists()&&a.data().bonusAplicado)return void console.log("B\xF4nus da vantagem j\xE1 foi aplicado esta semana.");const o={abelha:0,joaninha:0,vagalume:0};let r=!1;if(a.exists()){const e=a.data().completadoPor||{};for(const a in e){const e=todosMembros.find(e=>e.nome===a);e&&e.equipe&&(o[e.equipe]+=3,r=!0)}}if(r){for(const a in e.update(n,{abelha:increment(o.abelha),joaninha:increment(o.joaninha),vagalume:increment(o.vagalume)}),completadoPor){const t=todosMembros.find(e=>e.nome===a);if(t&&t.equipe){const n=doc(collection(db,"logEventos"));e.set(n,{tipo:"vantagem_concluida",nomeMembro:a,detalhe:t.equipe,data:getHojeISO()})}}e.set(t,{bonusAplicado:!0},{merge:!0}),pontosSemanais.abelha+=o.abelha,pontosSemanais.joaninha+=o.joaninha,pontosSemanais.vagalume+=o.vagalume,mostrarPopup("\u2728 B\xF4nus Aplicado!","Pontos do Jogo da Vantagem foram adicionados!",6e3)}})}catch(e){console.error("Erro na transa\xE7\xE3o de b\xF4nus da vantagem:",e)}}if(0===e.getDay()&&0<=e.getBrasiliaHours()){const a=doc(db,"semanas","pontosSemanais"),t=await getDoc(a);if(t.exists()){const n=t.data();let o=-1;const r=[];n.abelha>o&&(o=n.abelha),n.joaninha>o&&(o=n.joaninha),n.vagalume>o&&(o=n.vagalume),n.abelha===o&&r.push("abelha"),n.joaninha===o&&r.push("joaninha"),n.vagalume===o&&r.push("vagalume");const i=1<r.length,d=r.filter(e=>n[e]===o);if(0<d.length&&0<o){const a=doc(db,"ranking","geral"),t={};d.forEach(e=>{t[e]=increment(1),rankingGeral[e]++}),await updateDoc(a,t),atualizarRankingGeral();const n={abelha:"Abelha",joaninha:"Joaninha",vagalume:"Vaga-lume"},r=d.map(e=>n[e]).join(" e ");i?mostrarPopup("\uD83C\uDFC6 Empate Semanal",`As equipes ${r} empataram com ${o} pontos! Todas ganham um ponto no ranking.`,8e3):mostrarPopup("\uD83C\uDFC6 Vit\xF3ria Semanal",`Equipe ${r} venceu a semana com ${o} pontos!`,8e3);const s=getSemanaAtual(new Date(e.setDate(e.getDate()-1))),l=`resultado_${s.numero}_${s.inicio.getFullYear()}`;await setDoc(doc(db,"resultadosSemanais",l),{vencedoras:d,pontuacao:o,empate:i})}await calcularMembrosOciosos(),await deleteDoc(a),pontosSemanais.abelha=0,pontosSemanais.joaninha=0,pontosSemanais.vagalume=0,atualizarPlacarSemanal()}}}function getMedalha(e){const a=Object.keys(medalhas).map(Number).sort((e,a)=>a-e);for(const t of a)if(e>=t)return medalhas[t];return null}async function atualizarMedalhas(){for(const e in streaksCache)Object.hasOwnProperty.call(streaksCache,e)&&atualizarStreakVisualMembro(e,streaksCache[e])}function atualizarPlacarSemanal(){document.getElementById("resumo-abelha")&&(document.getElementById("resumo-abelha").innerHTML=`
        <div>${document.querySelectorAll("#equipe-abelha input:checked").length} focaram hoje!</div>
        <div>${pontosSemanais.abelha} pontos na semana</div>
      `),document.getElementById("resumo-joaninha")&&(document.getElementById("resumo-joaninha").innerHTML=`
        <div>${document.querySelectorAll("#equipe-joaninha input:checked").length} focaram hoje!</div>
        <div>${pontosSemanais.joaninha} pontos na semana</div>
      `),document.getElementById("resumo-vagalume")&&(document.getElementById("resumo-vagalume").innerHTML=`
        <div>${document.querySelectorAll("#equipe-vagalume input:checked").length} focaram hoje!</div>
        <div>${pontosSemanais.vagalume} pontos na semana</div>
      `)}function atualizarRankingGeral(){document.getElementById("ranking-abelha")&&(document.getElementById("ranking-abelha").textContent=rankingGeral.abelha),document.getElementById("ranking-joaninha")&&(document.getElementById("ranking-joaninha").textContent=rankingGeral.joaninha),document.getElementById("ranking-vagalume")&&(document.getElementById("ranking-vagalume").textContent=rankingGeral.vagalume)}window.atualizarResumo=async function(){0===todosMembros.length||(filaAtualizacao=filaAtualizacao.then(async()=>{const e=getHoje(),a=getHojeISO();await salvarPresenca();const t=todosMembros.filter(e=>document.getElementById(e.nome)?.checked).length;if(document.getElementById("contadorGeral")){document.getElementById("contadorGeral").textContent=`${t} √©picos focaram hoje!`;const e=100*(t/todosMembros.length),a=document.getElementById("progresso-barra");a.style.width=`${e}%`;const n=t===todosMembros.length,o=document.querySelector(".global-stats"),r=document.getElementById("mensagem-todos-focados");n?(a.classList.add("rainbow-progress"),o.classList.add("rainbow-border"),r&&(r.textContent="Todos focaram hoje, estamos de parab\xE9ns!!",r.classList.remove("hidden"))):(a.classList.remove("rainbow-progress"),o.classList.remove("rainbow-border"),r&&r.classList.add("hidden")),n?(a.classList.add("rainbow-progress"),o.classList.add("rainbow-border")):(a.classList.remove("rainbow-progress"),o.classList.remove("rainbow-border"))}atualizarPlacarSemanal(),verificarEquipeCompleta(),await verificarArvoreEpica(t),await carregarTop5Semana()}).catch(e=>{console.error("Erro na atualiza\xE7\xE3o:",e)}),await filaAtualizacao,await carregarStreaks())};function verificarEquipeCompleta(){for(const e in equipes){const a=document.getElementById(`equipe-${e}`),t=document.getElementById(`msg-equipe-${e}`);if(!a||!t)continue;const n=equipes[e].membros.every(e=>document.getElementById(e.nome)?.checked);if(t.classList.remove("abelha","joaninha","vagalume"),n&&0<equipes[e].membros.length){a.classList.add("equipe-completa",e);const n=e.charAt(0).toUpperCase()+e.slice(1);t.textContent=`Parab√©ns, equipe ${n}!! Voc√™s gabaritaram hoje!!!`,t.classList.add(e),t.classList.remove("hidden")}else a.classList.remove("equipe-completa",e),t.classList.add("hidden")}}window.mostrarPopup=function(e,a,t=8e3){const n=document.getElementById("popup-message");n&&(n.innerHTML=`<strong>${e}</strong><br>${a}`,n.classList.add("show"),clearTimeout(window.popupTimeout),window.popupTimeout=setTimeout(()=>{n.classList.remove("show")},t))};const conquistas={5:"\uD83C\uDFC6 5 dias consecutivos!",10:"\uD83D\uDD25 Fogo Sagrado! 10 dias!",15:"\uD83D\uDE80 N\xEDvel \xC9pico! 15 dias!"},medalhasConcedidas={};async function verificarConquista(e,a){const t=getHoje(),n=getHojeISO();let o=!1,r=0;return await(filaAtualizacao=filaAtualizacao.then(async()=>{const i=doc(db,"streak",e);try{let d=0;const s=await getDoc(i);s.exists()&&(d=s.data().streak||0),await runTransaction(db,async e=>{const o=await e.get(i);let r=o.exists()?o.data().streak:0,d=o.exists()?o.data().ultimoDia:null;const s=new Date(t);s.setDate(s.getDate()-1);const l=s.toISOString().slice(0,10);"adicionar"===a?(d!==n&&(r+=1),d=n):"remover"==a&&d===n&&(r=Math.max(0,r-1),d=0<r?l:null),e.set(i,{streak:r,ultimoDia:d})});const l=await getDoc(i);r=l.exists()?l.data().streak:0;const m=getMedalha(r),c=getMedalha(d);if("adicionar"===a&&m&&(!c||m.nome!==c.nome)){const a=document.getElementById("som-conquista");a&&(a.currentTime=0,a.play()),mostrarPopup("\uD83C\uDFC5 Nova Medalha",`${e} conquistou:<br>${m.emoji} ${m.nome}!`,8e3),dispararConfete(),o=!0;const t=doc(collection(db,"logEventos"));setDoc(t,{tipo:"nova_medalha",nomeMembro:e,detalhe:`${m.emoji} ${m.nome}`,data:getHojeISO()})}if(conquistas[r]&&"adicionar"===aco&&r>d){const a=document.getElementById("som-conquista");a&&(a.currentTime=0,a.play()),mostrarPopup("\uD83C\uDF1F Conquista",`${e} conquistou:<br>${conquistas[r]}`,8e3),dispararConfete(),o=!0}}catch(e){console.error("Falha na transa\xE7\xE3o:",e)}})),{conquistaOcorrida:o,streakAtual:r}}function atualizarStreakVisualMembro(e,a){const t=document.getElementById(`dias-${e}`);t&&(t.textContent=a,t.title=`${a} dias de foco consecutivos`);const n=document.getElementById(`medalha-${e}`);if(n){const e=getMedalha(a);e?(n.innerHTML=e.emoji,n.title=`${e.nome} - ${a} dias de foco consecutivos`,n.classList.add("com-medalha"),n.classList.remove("escondido")):(n.innerHTML="",n.classList.remove("com-medalha"),n.classList.add("escondido"))}}function dispararConfete(){function e(o){r=o,t.clearRect(0,0,a.width,a.height);let d=0;for(let e=0;e<n.length;e++){const o=n[e];o.y+=o.speed,o.x+=o.drift,o.angle+=o.spin,t.save(),t.translate(o.x+o.w/2,o.y+o.h/2),t.rotate(o.angle),t.fillStyle=o.color,t.fillRect(-o.w/2,-o.h/2,o.w,o.h),t.restore(),o.y<a.height&&d++}0<d?requestAnimationFrame(e):t.clearRect(0,0,a.width,a.height)}const a=document.getElementById("confetti-canvas");if(!a)return;const t=a.getContext("2d");a.width=window.innerWidth,a.height=window.innerHeight;const n=[],o=["#FFD700","#FF6B6B","#2ECC71","#3498DB","#9B59B6","#FAD390"];for(let e=0;e<200;e++)n.push({x:Math.random()*a.width,y:-Math.random()*a.height,w:8*Math.random()+5,h:15*Math.random()+8,color:o[Math.floor(Math.random()*o.length)],angle:2*(Math.random()*Math.PI),speed:4*Math.random()+2,spin:.4*Math.random()-.2,drift:2*Math.random()-1});let r=0;requestAnimationFrame(e)}function iniciarConfeteAniversarioContinuo(){function e(){t.clearRect(0,0,a.width,a.height);for(let e=particulasAniversario.length-1;0<=e;e--){const n=particulasAniversario[e];n.y+=n.speed,n.x+=n.drift,n.angle+=n.spin,t.save(),t.translate(n.x+n.w/2,n.y+n.h/2),t.rotate(n.angle),t.fillStyle=n.color,t.fillRect(-n.w/2,-n.h/2,n.w,n.h),t.restore(),n.y>a.height+20&&particulasAniversario.splice(e,1)}animacaoConfeteAniversarioId=requestAnimationFrame(e)}if(animacaoConfeteAniversarioId)return;const a=document.getElementById("confetti-canvas");if(!a)return;const t=a.getContext("2d");a.width=window.innerWidth,a.height=window.innerHeight;const n=["#FFD700","#FF6B6B","#2ECC71","#3498DB","#9B59B6","#FAD390"];geradorDeParticulasId=setInterval(()=>{particulasAniversario.push({x:Math.random()*a.width,y:-20,w:6*Math.random()+4,h:12*Math.random()+6,color:n[Math.floor(Math.random()*n.length)],angle:2*(Math.random()*Math.PI),speed:2*Math.random()+1,spin:.2*Math.random()-.1,drift:1*Math.random()-.5})},200),e()}function pararConfeteAniversarioContinuo(){geradorDeParticulasId&&(clearInterval(geradorDeParticulasId),geradorDeParticulasId=null),animacaoConfeteAniversarioId&&(cancelAnimationFrame(animacaoConfeteAniversarioId),animacaoConfeteAniversarioId=null),particulasAniversario=[];const e=document.getElementById("confetti-canvas");if(e){const a=e.getContext("2d");a.clearRect(0,0,e.width,e.height)}}window.marcarCheckbox=async function(e){if(checkboxLocks[e]){console.warn(`A√ß√£o para '${e}' j√° est√° em andamento. Clique ignorado.`);const a=document.getElementById(e);return void(a&&(a.checked=!a.checked))}checkboxLocks[e]=!0;const a=document.getElementById(e);if(!a)return void(checkboxLocks[e]=!1);const t=todosMembros.find(a=>a.nome===e);if(!t)return void(checkboxLocks[e]=!1);const n=()=>"lider"===userRole||"lider-equipe"===userRole&&t.equipe===userTeam||"membro"===userRole&&currentUser===e;if(!n())return a.checked=!a.checked,mostrarPopup("\uD83D\uDEAB Acesso Negado","Voc\xEA n\xE3o tem permiss\xE3o para alterar o foco de outro membro.",4e3),void(checkboxLocks[e]=!1);const o=getHoje(),r=0===o.getDay(),i=a.checked?"adicionar":"remover";"adicionar"===i?(mostrarPopup("\uD83C\uDF89 Foco Registrado",`${e}, parab√©ns por ter focado hoje!`,3e3),r&&setTimeout(()=>{mostrarPopup("\u26A0\uFE0F Aviso","Pontos semanais n\xE3o s\xE3o contabilizados aos domingos",5e3)},3e3)):mostrarPopup("\u2139\uFE0F Foco Removido",`${e}, seu foco de hoje foi removido`,3e3);let d=t.equipe;if(!r&&d){const e=a.checked?1:-1;pontosSemanais[d]+=e}if(await atualizarResumo(),(async()=>{if(!r&&d){const e=doc(db,"semanas","pontosSemanais"),t=a.checked?1:-1;try{await updateDoc(e,{[d]:increment(t)})}catch(a){console.error("Erro ao atualizar pontos semanais:",a),"not-found"===a.code&&(await setDoc(e,{abelha:0,joaninha:0,vagalume:0,[d]:t}))}}const{streakAtual:t}=await verificarConquista(e,i);streaksCache[e]=t,atualizarStreakVisualMembro(e,t)})().finally(()=>{console.log(`A√ß√£o para '${e}' conclu√≠da. Trava liberada.`),checkboxLocks[e]=!1}),liderGeral?.nome!==e&&!r){let e=t.equipe;if(e){const a=document.getElementById(`resumo-${e}`);a&&(a.classList.add("destaque"),setTimeout(()=>a.classList.remove("destaque"),500))}}},window.resetarTudo=async function(){if(confirm("\u26A0\uFE0F ATEN\xC7\xC3O: Voc\xEA est\xE1 prestes a resetar TODOS os dados!\nIsso apagar\xE1 todo o hist\xF3rico e pontos.\n\nDeseja continuar?"))try{const e=await getDocs(collection(db,"presencas"));for(const a of e.docs)await deleteDoc(a.ref);const a=doc(db,"semanas","pontosSemanais"),t=await getDoc(a);t.exists()&&(await deleteDoc(a));const n=doc(db,"ranking","geral");await setDoc(n,{abelha:0,joaninha:0,vagalume:0});const o=doc(db,"arvoreEpica","progresso");await deleteDoc(o);const r=await getDocs(collection(db,"streak"));for(const e of r.docs)await deleteDoc(e.ref);pontosSemanais.abelha=0,pontosSemanais.joaninha=0,pontosSemanais.vagalume=0,rankingGeral.abelha=0,rankingGeral.joaninha=0,rankingGeral.vagalume=0,await carregarPresenca(),await carregarTotalDias(),await carregarPontosSemanais(),await carregarRankingGeral(),await carregarArvoreEpica(),atualizarPlacarSemanal(),atualizarRankingGeral(),atualizarMedalhas(),atualizarExibicaoArvore(),mostrarPopup("\u2705 Reset Completo","Todos os dados foram resetados com sucesso!",5e3)}catch(e){console.error("Erro ao resetar dados:",e),mostrarPopup("\u274C Erro no Reset","Ocorreu um erro ao tentar resetar os dados.",5e3)}},window.resetarDia=async function(e=!1){if(!resetEmAndamento){if(resetEmAndamento=!0,!e&&!confirm("\u26A0\uFE0F ATEN\xC7\xC3O: Voc\xEA est\xE1 prestes a desmarcar TODOS os checkboxes do dia atual e zerar o contador do dia.\n\nIsso n\xE3o afetar\xE1 os pontos semanais ou streaks.\n\nDeseja continuar?"))return void(resetEmAndamento=!1);try{todosMembros.forEach(e=>{const a=e.nome,t=document.getElementById(a);if(t){t.checked=!1;const e=t.nextElementSibling;e&&e.classList.remove("checked")}});const a=getHojeISO(),t=doc(db,"presencas",a);await deleteDoc(t),document.getElementById("contadorGeral")&&(document.getElementById("contadorGeral").textContent="0 \xE9picos focaram hoje!",document.getElementById("progresso-barra").style.width="0%"),atualizarPlacarSemanal(),await Promise.all([carregarStreaks(),carregarTotalDias()]),e||mostrarPopup("\u2705 Dia Resetado","Todos os checkboxes foram desmarcados e o dia foi zerado.",5e3)}catch(e){console.error("Erro ao resetar o dia:",e),mostrarPopup("\u274C Erro","Ocorreu um erro ao resetar o dia.",5e3)}}};async function carregarStreaks(){const e=todosMembros.map(async e=>{try{const a=doc(db,"streak",e.nome),t=await getDoc(a);streaksCache[e.nome]=t.exists()?t.data().streak:0}catch(a){console.error(`Erro ao carregar streak para ${e.nome}:`,a),streaksCache[e.nome]=0}});await Promise.all(e),atualizarMedalhas()}async function limparColecaoSemanas(){try{const e=collection(db,"semanas"),a=await getDocs(e);a.forEach(async e=>{"pontosSemanais"!==e.id&&(console.warn(`Apagando documento indesejado na cole√ß√£o 'semanas': ${e.id}`),await deleteDoc(doc(db,"semanas",e.id)))})}catch(e){console.error("Erro ao limpar cole\xE7\xE3o 'semanas':",e)}}async function limparMuralSemanal(){try{const e=getHoje();if(1!==e.getDay())return;const a=new Date(e);a.setDate(a.getDate()-7);const t=getSemanaAtual(a).numero,n=query(collection(db,"mural"),where("semana","<",t)),o=await getDocs(n),r=writeBatch(db);o.forEach(e=>{r.delete(e.ref)}),await r.commit(),console.log(`Mural limpo: ${o.size} mensagens antigas removidas`)}catch(e){console.error("Erro ao limpar mural:",e)}}const fasesArvore=[{dias:1,nome:"Semente",emoji:"\uD83C\uDF31",desc:"A jornada come\xE7a com um \xFAnico dia de foco. Vamos plantar nossa semente e cultivar nossa dedica\xE7\xE3o di\xE1ria!"},{dias:15,nome:"Broto",emoji:"\uD83C\uDF3F",desc:"Com 15 dias consecutivos, nosso esfor\xE7o come\xE7a a brotar. Vamos continuar regando nossa determina\xE7\xE3o!"},{dias:60,nome:"\xC1rvore",emoji:"\uD83C\uDF33",desc:"60 dias de foco ininterrupto! Nossa \xE1rvore cresce forte, simbolizando nossa consist\xEAncia e perseveran\xE7a."},{dias:180,nome:"Flores",emoji:"\uD83C\uDF38",desc:"180 dias de dedica\xE7\xE3o fazem florescer resultados. Cada flor representa uma conquista em nossa jornada!"},{dias:365,nome:"Frutos",emoji:"\uD83C\uDF4E",desc:"365 dias de foco cont\xEDnuo! Agora colhemos os frutos do nosso trabalho \xE1rduo e da nossa dedica\xE7\xE3o inabal\xE1vel."}];let arvoreEpica={consecutivos:0,ultimoDia:null,faseAtual:0};async function carregarEstadoArvore(){const e=doc(db,"arvoreEpica","progresso"),a=await getDoc(e);a.exists()?arvoreEpica=a.data():(arvoreEpica={consecutivos:0,ultimoDia:null,faseAtual:0},await setDoc(e,arvoreEpica))}async function verificarArvoreEpica(e){const a=getHojeISO();await carregarEstadoArvore();const t=getHoje(),n=todosMembros.length,o=document.getElementById("status-focado"),r=document.getElementById("status-nao-focado");o&&(o.textContent=`‚úÖ ${e} √©picos focaram hoje`),r&&(r.textContent=`‚ùå ${n-e} √©picos ainda n√£o focaram`);const i=arvoreEpica.ultimoDia,d=new Date(t);d.setDate(d.getDate()-1);const s=d.toISOString().slice(0,10),l=i===a;if(10<=e){if(!l){i?i===s?arvoreEpica.consecutivos++:arvoreEpica.consecutivos=1:arvoreEpica.consecutivos=1,arvoreEpica.ultimoDia=a;let e=0;for(let a=fasesArvore.length-1;0<=a;a--)if(arvoreEpica.consecutivos>=fasesArvore[a].dias){e=a;break}arvoreEpica.faseAtual=e;const t=doc(db,"arvoreEpica","progresso");if(await setDoc(t,arvoreEpica),atualizarExibicaoArvore(),0<e&&arvoreEpica.consecutivos===fasesArvore[e].dias){const a=document.getElementById("som-conquista");a&&(a.currentTime=0,a.play()),mostrarPopup("\uD83C\uDF33 \xC1rvore \xC9pica",`Parab√©ns! A √°rvore evoluiu para: ${fasesArvore[e].nome} ${fasesArvore[e].emoji}`,5e3),dispararConfete()}}}else if(l){arvoreEpica.consecutivos=Math.max(0,arvoreEpica.consecutivos-1),arvoreEpica.ultimoDia=0<arvoreEpica.consecutivos?s:null;let e=0;for(let a=fasesArvore.length-1;0<=a;a--)if(arvoreEpica.consecutivos>=fasesArvore[a].dias){e=a;break}arvoreEpica.faseAtual=e;const a=doc(db,"arvoreEpica","progresso");await setDoc(a,arvoreEpica),atualizarExibicaoArvore()}}async function carregarArvoreEpica(){await carregarEstadoArvore(),atualizarExibicaoArvore()}function criarEstrelas(){const e=document.querySelector(".stars-container");if(e){e.innerHTML="";for(let a=0;a<150;a++){const a=document.createElement("div");a.classList.add("star");const t=3*Math.random()+1;a.style.width=`${t}px`,a.style.height=`${t}px`,a.style.left=`${100*Math.random()}%`,a.style.top=`${100*Math.random()}%`,a.style.animationDelay=`${4*Math.random()}s`,a.style.animationDuration=`${2+3*Math.random()}s`,e.appendChild(a)}}}function atualizarExibicaoArvore(){if(!document.getElementById("stage-name"))return;const e=fasesArvore[arvoreEpica.faseAtual];document.getElementById("stage-name").textContent=e.nome+" "+e.emoji,document.getElementById("stage-desc").textContent=e.desc,document.getElementById("dias-consecutivos").textContent=arvoreEpica.consecutivos;["seed","sprout","tree","flowers","fruits"].forEach((e,a)=>{const t=document.getElementById(e);t&&(a===arvoreEpica.faseAtual?t.style.display="block":t.style.display="none")});const a=arvoreEpica.faseAtual<fasesArvore.length-1?fasesArvore[arvoreEpica.faseAtual+1]:null,t=document.getElementById("proxima-fase");if(t)if(a){const e=a.dias-arvoreEpica.consecutivos;t.textContent=`Faltam ${e} dias para ${a.nome} ${a.emoji}`}else t.textContent="Voc\xEA alcan\xE7ou o n\xEDvel m\xE1ximo!";const n=getHoje(),o=n.getHours(),r=18<=o||6>o,i=document.querySelector(".tree-sky");i&&(r?(i.classList.add("night-mode"),i.classList.remove("day-mode"),0===document.querySelector(".stars-container")?.children.length&&criarEstrelas(),document.querySelector(".stars-container").style.opacity="1"):(i.classList.remove("night-mode"),i.classList.add("day-mode"),document.querySelector(".stars-container")&&(document.querySelector(".stars-container").style.opacity="0")));const d=document.getElementById("sol"),s=document.getElementById("lua");d&&s&&(d.style.opacity=r?"0":"1",s.style.opacity=r?"1":"0")}async function verificarMudancaData(){const e=getHojeISO();dataAtual===e?atualizarDataCabecalho():(dataAtual=e,await executarRotinaDeMeiaNoite())}let resetEmAndamento=!1;async function executarRotinaDeMeiaNoite(){console.log("\uD83D\uDD5B Executando rotina da meia-noite..."),await resetarDia(!0),await finalizarSemana(),atualizarDataCabecalho(),atualizarInfoSemana(),await carregarPontosSemanais(),atualizarPlacarSemanal(),await carregarArvoreEpica(),await atualizarResumo(),console.log("\u2705 Rotina da meia-noite conclu\xEDda. A interface foi atualizada.")}function atualizarDataCabecalho(){const e=getHoje(),a=e.toLocaleDateString("pt-BR",{weekday:"long",day:"numeric",month:"long"}),t=document.getElementById("dataHoje");t&&(t.textContent=a.charAt(0).toUpperCase()+a.slice(1))}function atualizarInfoSemana(){const e=getSemanaAtual(),a=document.getElementById("info-semana");a&&(a.innerHTML=`
        <div style="font-weight:bold"><span class="destaque-semana">Semana ${e.numero}</span></div>
        <div>(${e.inicioFormatado} a ${e.fimFormatado})</div>
        <div style="font-size:0.9rem;margin-top:5px;color:#7f8c8d">
          A competi√ß√£o ser√° encerrada s√°bado (${e.fimCompeticao}), √†s 23:59h.
        </div>
      `)}function isColorDark(e){const a="#"===e.charAt(0)?e.substring(1,7):e,t=parseInt(a.substring(0,2),16),n=parseInt(a.substring(2,4),16),o=parseInt(a.substring(4,6),16);return 128>.299*t+.587*n+.114*o}async function openMessageViewer(a){unsubscribeViewerListener&&(unsubscribeViewerListener(),unsubscribeViewerListener=null);const t=document.getElementById("message-viewer-modal");openModal("message-viewer-modal"),t.dataset.activeMessageId=a;const n=doc(db,"mural",a);unsubscribeViewerListener=onSnapshot(n,e=>{if(!e.exists())return void closeModal("message-viewer-modal");const n=e.data(),o=document.getElementById("viewer-card"),r=document.getElementById("viewer-text"),i=document.getElementById("viewer-author"),d=document.getElementById("viewer-timestamp"),s=document.getElementById("viewer-reacoes-container"),l=n.timestamp?.toDate?n.timestamp.toDate():new Date;o.style.backgroundColor=n.cor,i.textContent=n.nome,d.textContent=`${l.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"})} - ${l.toLocaleDateString("pt-BR")}`,r.innerHTML=(n.texto||"").replace(/\n/g,"<br>"),isColorDark(n.cor)?o.classList.add("text-light"):o.classList.remove("text-light");const m=n.reacoes||{};let c="",u=!1;const g=Object.keys(m).sort((e,a)=>{const t=Array.isArray(m[e])?m[e].length:0,n=Array.isArray(m[a])?m[a].length:0;return n-t});for(const t of g){const e=Array.isArray(m[t])?m[t]:[],n=e.length;if(0<n){u=!0;const o=e.includes(currentUser),r=o?"reacted":"",i=0<e.length?`Reagido por: ${e.join(", ")}`:`Reagir com ${t}`;c+=`
  <div 
    class="reacao-display ${r}" 
    title="${i}"
    data-emoji="${t}" onclick="window.abrirModalReagentes('${a}', '${t}')">
    ${t} <span class="contador-display">${n}</span>
  </div>
`}}s.innerHTML=c,s.style.display=u?"flex":"none";const p=t.querySelector(".reacao-seletor-bar");p.innerHTML="";["\uD83D\uDC4D","\uD83D\uDE02","\uD83D\uDE2D","\uD83D\uDC96","\uD83D\uDE21"].forEach(t=>{const n=document.createElement("button");n.textContent=t,n.onclick=n=>{n.stopPropagation(),window.toggleReacao(a,t,n)},p.appendChild(n)}),p.style.display="flex"})}async function confirmDelete(){if(messageIdToDelete)try{await deleteDoc(doc(db,"mural",messageIdToDelete)),mostrarPopup("\u2705 Sucesso","Mensagem exclu\xEDda!",3e3)}catch(e){mostrarPopup("\u274C Erro","Falha ao excluir a mensagem.",3e3),console.error("Erro ao excluir:",e)}finally{closeModal("confirm-delete-modal"),messageIdToDelete=null}}function openMessageComposer(e=null){const a=document.getElementById("composer-send-btn");if(e){document.getElementById("composer-textarea").value=e.texto;const t="An\xF4nimo"===e.nome;document.getElementById("composer-anonymous-check").checked=t,document.getElementById("composer-author").textContent=t?"An\xF4nimo":currentUser,selectComposerColor(e.cor),a.textContent="Salvar Altera\xE7\xF5es"}else document.getElementById("composer-textarea").value="",document.getElementById("composer-anonymous-check").checked=!1,document.getElementById("composer-author").textContent=currentUser,selectComposerColor("#CAFFBF"),a.textContent="Enviar",composerEditMode=!1,editingMessageId=null;updateComposerTimestamp(),composerTimestampInterval=setInterval(updateComposerTimestamp,1e3),openModal("message-composer-modal")}function closeMessageComposer(){clearInterval(composerTimestampInterval),closeModal("message-composer-modal"),composerEditMode=!1,editingMessageId=null}function updateComposerTimestamp(){const e=new Date,a=e.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"}),t=e.toLocaleDateString("pt-BR");document.getElementById("composer-timestamp").textContent=`${a} - ${t}`}function selectComposerColor(e){composerSelectedColor=e;const a=document.getElementById("composer-card"),t=document.getElementById("composer-color-btn");a.style.backgroundColor=e,t.style.backgroundColor=e,isColorDark(e)?(a.classList.add("text-light"),t.classList.add("text-light")):(a.classList.remove("text-light"),t.classList.remove("text-light")),document.getElementById("composer-color-palette").classList.add("hidden")}window.enviarMensagem=async function(){const e=document.getElementById("composer-anonymous-check").checked,a=e?"An\xF4nimo":currentUser,t=document.getElementById("composer-textarea").value.trim();if(!t)return void mostrarPopup("\u270D\uFE0F Aten\xE7\xE3o","Digite uma mensagem.",3e3);const n={nome:a,texto:t,cor:composerSelectedColor,userId:currentUser};try{if(composerEditMode&&editingMessageId){const e=doc(db,"mural",editingMessageId);await updateDoc(e,n),mostrarPopup("\u2705 Sucesso","Mensagem editada!",3e3)}else{n.timestamp=new Date,n.reacoes={"üëç":[],"üòÇ":[],"üò≠":[],"üíñ":[],"üò°":[]},n.semana=getSemanaAtual().numero;const e=doc(collection(db,"mural"));await setDoc(e,n),mostrarPopup("\u2705 Sucesso","Mensagem enviada!",3e3)}closeMessageComposer()}catch(e){console.error("Erro:",e),mostrarPopup("\u274C Erro","Ocorreu um erro.",3e3)}finally{composerEditMode=!1,editingMessageId=null}},window.editarMensagem=async function(e,a){e.stopPropagation(),composerEditMode=!0,editingMessageId=a;try{const e=await getDoc(doc(db,"mural",a));e.exists()&&openMessageComposer(e.data())}catch(e){console.error("Erro ao buscar mensagem para editar:",e)}},window.excluirMensagem=function(e,a){e.stopPropagation(),messageIdToDelete=a,openModal("confirm-delete-modal")};function createColorPalette(){const e=document.getElementById("composer-color-palette");e&&(e.innerHTML="",["#FFADAD","#FFD6A5","#FDFFB6","#CAFFBF","#9BF6FF","#A0C4FF","#BDB2FF","#FFC6FF","#FFFFFC","#EAE4E9","#F38375","#F9A384","#FBC42C","#57C479","#57C5C8","#578DC8","#8A57C8","#C857B2","#4B4A49","#ACACAC"].forEach(a=>{const t=document.createElement("div");t.className="composer-color-option",t.style.backgroundColor=a,t.title=a,t.onclick=()=>selectComposerColor(a),e.appendChild(t)}))}function criarElementoMensagem(a){const t=a.cor||"#ffdde1",n=a.timestamp?.toDate?a.timestamp.toDate():new Date,o=n.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"}),r=n.toLocaleDateString("pt-BR"),i=document.createElement("div");i.className="mensagem",i.style.backgroundColor=t,i.dataset.id=a.id,i.dataset.fullText=a.texto||"",isColorDark(t)&&i.classList.add("text-light");const d=a.reacoes||{};let s="",l=!1;const m=Object.keys(d).sort((e,a)=>{const t=Array.isArray(d[e])?d[e].length:0,n=Array.isArray(d[a])?d[a].length:0;return n-t});for(const e of m){const t=Array.isArray(d[e])?d[e]:[],n=t.length;if(0<n){l=!0;const o=t.includes(currentUser),r=o?"reacted":"",i=0<t.length?`Reagido por: ${t.join(", ")}`:`Seja o primeiro a reagir com ${e}`;s+=`
  <div 
    class="reacao-display ${r}" 
    title="${i}"
    data-emoji="${e}"  onclick="window.abrirModalReagentes('${a.id}', '${e}')">
    ${e} <span class="contador-display">${n}</span>
  </div>
`}}const c=l?`<div class="reacoes-display-container">${s}</div>`:"";let u="";(a.userId===currentUser||"lider"===userRole)&&(u=`
      <div class="message-options-container">
        <button class="options-btn">‚ãÆ</button>
        <div class="options-dropdown hidden">
          <button onclick="editarMensagem(event, '${a.id}')">Editar</button>
          <button onclick="excluirMensagem(event, '${a.id}')">Excluir</button>
        </div>
      </div>
    `);const g=(a.texto||"").replace(/\n/g,"<br>");i.innerHTML=`
    <div class="mensagem-texto">${g}</div>
    ${c}
    <div class="mensagem-info">
      <div>
        <div class="mensagem-autor">${a.nome}</div>
        <div class="mensagem-data">${o} - ${r}</div>
      </div>
      ${u}
    </div>
    <div class="reacao-seletor-bar hidden">
      <button onclick="event.stopPropagation(); window.toggleReacao('${a.id}', 'üëç', event)">üëç</button>
      <button onclick="event.stopPropagation(); window.toggleReacao('${a.id}', 'üòÇ', event)">üòÇ</button>
      <button onclick="event.stopPropagation(); window.toggleReacao('${a.id}', 'üò≠', event)">üò≠</button>
      <button onclick="event.stopPropagation(); window.toggleReacao('${a.id}', 'üíñ', event)">üíñ</button>
      <button onclick="event.stopPropagation(); window.toggleReacao('${a.id}', 'üò°', event)">üò°</button>
    </div>
  `;let p=null,h=!1,f=!1;const E=a=>{a.target.closest("button, a, .reacao-display")||(h=!1,f=!1,p=setTimeout(()=>{h=!0;const e=i.querySelector(".reacao-seletor-bar");if(e){e.classList.remove("hidden");const a=t=>{(!i.contains(t.target)||t.target.closest(".reacao-seletor-bar button"))&&(e.classList.add("hidden"),document.removeEventListener("click",a))};setTimeout(()=>{document.addEventListener("click",a)},100)}},500))},v=()=>clearTimeout(p),y=t=>{clearTimeout(p),h||f||t.target.closest("button, a, .reacao-display")||openMessageViewer(a.id)},b=()=>{clearTimeout(p),f=!0};i.addEventListener("mousedown",E),i.addEventListener("mouseup",y),i.addEventListener("mouseleave",v),i.addEventListener("touchstart",E,{passive:!0}),i.addEventListener("touchend",y),i.addEventListener("touchmove",b);const B=i.querySelector(".options-btn");return B&&B.addEventListener("click",a=>{a.stopPropagation();const e=a.target.nextElementSibling,t=e.classList.contains("hidden");if(document.querySelectorAll(".options-dropdown").forEach(e=>{e.classList.add("hidden")}),t){e.classList.remove("hidden");const a=t=>{e.contains(t.target)||B.contains(t.target)||(e.classList.add("hidden"),document.removeEventListener("click",a))};document.addEventListener("click",a)}}),i}function configurarMuralTempoReal(){const e=document.getElementById("mural-mensagens");if(e){e.innerHTML="<div class=\"carregando\">Carregando mensagens...</div>";const a=collection(db,"mural");onSnapshot(a,a=>{const t=[];return a.forEach(e=>{const a=e.data();t.push({id:e.id,...a,timestamp:a.timestamp.toDate?a.timestamp.toDate():new Date(1e3*a.timestamp.seconds)})}),t.sort((e,a)=>a.timestamp-e.timestamp),e.innerHTML="",0===t.length?void(e.innerHTML="<div class=\"sem-mensagens\">Nenhuma mensagem ainda. Seja o primeiro a escrever!</div>"):void t.forEach(a=>{e.appendChild(criarElementoMensagem(a))})})}}function atualizarReacaoOtimista(e,a){if(!currentUser)return;const t=document.querySelector(`.mensagem[data-id="${e}"]`);if(!t)return;const n=t.querySelector(".reacoes-display-container");if(!n)return;let o=n.querySelector(".reacao-display.reacted"),r=n.querySelector(`.reacao-display[data-emoji="${a}"]`);if(o&&o!==r){o.classList.remove("reacted");const e=o.querySelector(".contador-display");let a=parseInt(e.textContent);1<a?e.textContent=a-1:o.remove()}if(!r){const t=document.createElement("div");t.className="reacao-display reacted",t.dataset.emoji=a,t.innerHTML=`${a} <span class="contador-display">1</span>`,t.onclick=()=>window.abrirModalReagentes(e,a),n.appendChild(t)}else if(r.classList.contains("reacted")){r.classList.remove("reacted");const e=r.querySelector(".contador-display");let a=parseInt(e.textContent);1<a?e.textContent=a-1:r.remove()}else{r.classList.add("reacted");const e=r.querySelector(".contador-display");e.textContent=parseInt(e.textContent)+1}}window.toggleReacao=function(e,a,t){if(t&&t.stopPropagation(),!currentUser)return void mostrarPopup("\uD83D\uDEAB Erro","Voc\xEA precisa estar logado para reagir.",3e3);const n=doc(db,"mural",e);runTransaction(db,async e=>{const t=await e.get(n);if(!t.exists())throw"Documento n\xE3o existe!";const o=t.data();let r=o.reacoes||{};const i=currentUser;let d=null;for(const a in r)if(Array.isArray(r[a])){const e=r[a].indexOf(i);if(-1<e){d=a;break}}if(d===a){const e=r[a].indexOf(i);-1<e&&r[a].splice(e,1)}else{if(d){const e=r[d].indexOf(i);-1<e&&r[d].splice(e,1)}r[a]||(r[a]=[]),r[a].push(i)}e.update(n,{reacoes:r})}).catch(e=>{console.error("Falha na transa\xE7\xE3o de rea\xE7\xE3o em segundo plano: ",e),mostrarPopup("\u274C Ops!","Sua rea\xE7\xE3o n\xE3o p\xF4de ser salva. Tente novamente.",3e3)})};async function carregarTop5Semana(){try{const e=getSemanaAtual(),a=e.inicio.toISOString().slice(0,10),t=e.fim.toISOString().slice(0,10),n=query(collection(db,"presencas"),where("__name__",">=",a),where("__name__","<=",t)),o=await getDocs(n),r={};o.forEach(e=>{const a=e.data();for(const[t,n]of Object.entries(a))n&&todosMembros.some(e=>e.nome===t)&&(r[t]=(r[t]||0)+1)});const i=Object.entries(r).map(([e,a])=>({nome:e,pontos:a})).sort((e,a)=>a.pontos-e.pontos).slice(0,5),d=document.getElementById("ranking-top-lista");if(!d)return;d.innerHTML="",i.forEach((e,a)=>{const t=a+1;let n="";n=1===t?"\uD83E\uDD47":2===t?"\uD83E\uDD48":3===t?"\uD83E\uDD49":"\u2B50";const o=document.createElement("div");o.className="ranking-item",o.style.setProperty("--i",a),o.innerHTML=`
          <div class="ranking-posicao">${n} ${t}¬∫</div>
          <div class="ranking-nome">${e.nome}</div>
          <div class="ranking-pontos">${e.pontos} dias</div>
        `,d.appendChild(o)}),0===i.length&&(d.innerHTML="<div class=\"ranking-item\">Ainda n\xE3o h\xE1 dados esta semana</div>"),setTimeout(()=>{d.scrollLeft=0},100)}catch(e){console.error("Erro ao carregar top 5:",e)}}async function carregarMembros(){const e=await getDocs(collection(db,"membros"));todosMembros=[],equipes={abelha:{membros:[],lider:null},joaninha:{membros:[],lider:null},vagalume:{membros:[],lider:null}},liderGeral=null,e.forEach(e=>{const a=e.data(),t={nome:e.id,equipe:a.equipe,papel:a.papel,folga:a.folga||"",aniversario:a.aniversario||"",senha:a.senha||"",tempPassword:a.tempPassword||!0};todosMembros.push(t),"lider"===t.papel?liderGeral=t:"lider-equipe"===t.papel&&equipes[t.equipe]&&(equipes[t.equipe].lider=t),t.equipe&&equipes[t.equipe]&&equipes[t.equipe].membros.push(t)})}async function carregarInformacoesMembros(){try{const e=await getDocs(collection(db,"membros")),a=document.getElementById("carrossel-container"),t=document.getElementById("carrossel-indicadores");if(!a)return;a.innerHTML="",t&&(t.innerHTML="");const n=[];e.forEach(e=>n.push({id:e.id,...e.data()})),totalSlides=n.length,document.getElementById("botao-pausa")&&(document.getElementById("botao-pausa").textContent="\u23F8"),n.forEach((e,n)=>{const o=e,r=document.createElement("div");r.className="card-membro",r.id=`card-membro-${e.id}`;const i=o.corCard||"#FFFFFF";r.style.backgroundColor=i,isColorDark(i)?r.classList.add("text-light"):r.classList.remove("text-light");const d=currentUser===e.id||"lider"===userRole,s=d?"":"hidden";r.innerHTML=`
        <div class="card-controls ${s}">
          <button class="card-color-chooser-btn" onclick="toggleColorPalette(event, '${e.id}')">Escolha a cor</button>
          <div id="palette-${e.id}" class="card-color-palette hidden">
          </div>
        </div>
        <h3>${e.id}</h3>
        <div class="subtitulo">coisas sobre mim</div>
        <div class="info-item">
          <div class="info-content"><strong>Eu me chamo:</strong> <span id="info-${e.id}-me chamo">${o["me chamo"]||"N\xE3o informado"}</span></div>
          <button class="edit-info-btn ${s}" onclick="editarInformacao(event, '${e.id}', 'me chamo')">‚úèÔ∏è</button>
        </div>
        <div class="info-item">
          <div class="info-content"><strong>Meu apelido √©:</strong> <span id="info-${e.id}-apelido">${o.apelido||"N\xE3o informado"}</span></div>
          <button class="edit-info-btn ${s}" onclick="editarInformacao(event, '${e.id}', 'apelido')">‚úèÔ∏è</button>
        </div>
        <div class="info-item">
          <div class="info-content"><strong>Meu filme favorito:</strong> <span id="info-${e.id}-filme">${o.filme||"N\xE3o informado"}</span></div>
          <button class="edit-info-btn ${s}" onclick="editarInformacao(event, '${e.id}', 'filme')">‚úèÔ∏è</button>
        </div>
        <div class="info-item">
          <div class="info-content"><strong>Meu maior sonho atualmente:</strong> <span id="info-${e.id}-sonho">${o.sonho||"N\xE3o informado"}</span></div>
          <button class="edit-info-btn ${s}" onclick="editarInformacao(event, '${e.id}', 'sonho')">‚úèÔ∏è</button>
        </div>
        <div class="info-item">
          <div class="info-content"><strong>Uma m√∫sica que gosto muito:</strong> <span id="info-${e.id}-musica">${o.musica||"N\xE3o informado"}</span></div>
          <button class="edit-info-btn ${s}" onclick="editarInformacao(event, '${e.id}', 'musica')">‚úèÔ∏è</button>
        </div>
        <div class="info-item">
          <div class="info-content"><strong>Uma curiosidade aleat√≥ria sobre mim:</strong> <span id="info-${e.id}-curiosidade">${o.curiosidade||"N\xE3o informado"}</span></div>
          <button class="edit-info-btn ${s}" onclick="editarInformacao(event, '${e.id}', 'curiosidade')">‚úèÔ∏è</button>
        </div>
      `;const l=isColorDark(i),m=r.querySelector(".card-color-chooser-btn");if(m&&(m.style.color=l?"white":"black",m.style.borderColor=l?"white":"black"),a.appendChild(r),d&&criarPaletaDeCoresDoCard(e.id),t){const e=document.createElement("div");e.className="carrossel-indicador",e.onclick=()=>{window.reiniciarIntervaloCarrossel&&reiniciarIntervaloCarrossel(),irParaSlide(n)},t.appendChild(e)}}),0<totalSlides&&(document.querySelector(".carrossel-indicador")?.classList.add("ativo"),irParaSlide(0),1<totalSlides&&window.iniciarCarrosselAutomatico&&iniciarCarrosselAutomatico())}catch(e){console.error("Erro ao carregar informa\xE7\xF5es dos membros:",e)}}window.editarInformacao=async function(e,a,t){e.stopPropagation();const n=document.getElementById(`info-${a}-${t}`);if(!n)return;const o=n.textContent;n.contentEditable=!0,n.classList.add("editing"),n.focus(),document.execCommand("selectAll",!1,null);const r=async()=>{n.contentEditable=!1,n.classList.remove("editing"),n.removeEventListener("blur",r),n.removeEventListener("keydown",i);const e=n.textContent.trim();if(e===o||""===e)return void(n.textContent=o);try{const n=doc(db,"membros",a);await updateDoc(n,{[t]:e}),mostrarPopup("\u2705 Sucesso",`Informa√ß√£o atualizada!`,3e3)}catch(e){console.error("Erro ao atualizar informa\xE7\xE3o:",e),mostrarPopup("\u274C Erro","Ocorreu um erro ao salvar.",4e3),n.textContent=o}},i=a=>{"Enter"===a.key?(a.preventDefault(),r()):"Escape"===a.key&&(n.textContent=o,r())};n.addEventListener("blur",r),n.addEventListener("keydown",i)},window.toggleColorPalette=function(e,a){e.stopPropagation();const t=document.getElementById(`palette-${a}`);t.classList.toggle("hidden")};function criarPaletaDeCoresDoCard(e){const a=document.getElementById(`palette-${e}`);if(a){a.innerHTML="",["#FFFFFF","#FFADAD","#FFD6A5","#FDFFB6","#CAFFBF","#9BF6FF","#A0C4FF","#BDB2FF","#FFC6FF","#EAE4E9","#F38375","#F9A384","#FBC42C","#57C479","#57C5C8","#578DC8","#8A57C8","#C857B2","#4B4A49","#ACACAC","#FF6B6B","#FF9F43","#1DD1A1","#48DBFB","#2E86DE","#9B59B6","#FAD390","#FEA47F","#55E6C1","#00B894"].forEach(t=>{const n=document.createElement("div");n.className="card-color-option",n.style.backgroundColor=t,n.onclick=a=>selecionarCorDoCard(a,e,t),a.appendChild(n)})}}async function selecionarCorDoCard(e,a,t){e.stopPropagation();try{const e=doc(db,"membros",a);await updateDoc(e,{corCard:t});const n=document.getElementById(`card-membro-${a}`);if(n){n.style.backgroundColor=t,isColorDark(t)?n.classList.add("text-light"):n.classList.remove("text-light");const e=isColorDark(t),a=n.querySelector(".card-color-chooser-btn");a&&(a.style.color=e?"white":"black",a.style.borderColor=e?"white":"black")}const o=document.getElementById(`palette-${a}`);o&&o.classList.add("hidden"),mostrarPopup("\uD83C\uDFA8 Sucesso","A cor do seu card foi alterada!",3e3)}catch(e){console.error("Erro ao salvar cor do card:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel salvar a cor.",4e3)}}async function marcarConcluido(e,a,t,n){const o=document.getElementById(`task-${e}-${a}-${t}`),r=o?o.dataset.memberTeam:null;if(!podeMarcarCheckbox(e,r))return mostrarPopup("Erro","Voc\xEA n\xE3o tem permiss\xE3o para marcar/desmarcar esta tarefa.",3e3),void(o&&(o.checked=!n));const i=doc(db,"membros",e),d=`focoDiario.${t}.${a}`,s=`focoDia.${t}`;try{await runTransaction(db,async e=>{const o=await e.get(i);if(!o.exists())throw new Error("Membro n\xE3o encontrado.");const l=o.data();let m=pontosSemanais[r]||0,c=l.focoDia&&l.focoDia[t]||0;const u=l.focoDiario&&l.focoDiario[t]&&l.focoDiario[t][a];if(n?!u&&(e.update(i,{[d]:!0,[s]:increment(1)}),m++):u&&(e.update(i,{[d]:!1,[s]:increment(-1)}),m--),r&&void 0!==pontosSemanais[r]){const a=doc(db,"semanas","pontosSemanais");e.update(a,{[r]:m}),pontosSemanais[r]=m}}),console.log("Atualiza\xE7\xE3o conclu\xEDda com sucesso!"),mostrarPopup("Sucesso","Tarefa atualizada!",2e3),await verificarConquista(e,n?"adicionar":"remover"),await window.atualizarResumo()}catch(e){console.error("Erro ao atualizar o documento: ",e),mostrarPopup("Erro",`Erro ao atualizar a tarefa: ${e.message||e}`,3e3),o&&(o.checked=!n)}}window.togglePausa=function(){carrosselPausado=!carrosselPausado;const e=document.getElementById("botao-pausa");if(carrosselPausado){clearInterval(carrosselInterval),e.textContent="\u25B6";const a=document.getElementById("progresso-indicador-barra");a&&(a.style.transition="none",a.dataset.width=a.style.width)}else{e.textContent="\u23F8";const a=document.getElementById("progresso-indicador-barra");a&&(a.style.transition="width 10s linear",a.style.width=a.dataset.width||"100%"),iniciarCarrosselAutomatico()}};function iniciarBarraProgresso(){const e=document.getElementById("progresso-indicador-barra");e&&(e.style.transition="none",e.style.width="0%",void e.offsetWidth,e.style.transition="width 10s linear",setTimeout(()=>{carrosselPausado||(e.style.width="100%")},10),progressoBarra&&clearTimeout(progressoBarra),progressoBarra=setTimeout(()=>{e.style.width="0%"},1e4))}window.mudarSlide=function(e){reiniciarIntervaloCarrossel();const a=document.querySelectorAll(".card-membro").length;0===a||(currentCarrosselIndex=(currentCarrosselIndex+e+a)%a,irParaSlide(currentCarrosselIndex))};function irParaSlide(e){const a=document.getElementById("carrossel-container");a.style.transform=`translateX(-${100*e}%)`;const t=document.querySelectorAll(".carrossel-indicador");t.forEach((a,t)=>{a.classList.toggle("ativo",t===e)}),currentCarrosselIndex=e,carrosselPausado||iniciarBarraProgresso()}function iniciarCarrosselAutomatico(){carrosselInterval&&clearInterval(carrosselInterval),carrosselInterval=setInterval(()=>{0<totalSlides&&!carrosselPausado&&(currentCarrosselIndex=(currentCarrosselIndex+1)%totalSlides,irParaSlide(currentCarrosselIndex))},1e4),iniciarBarraProgresso()}function reiniciarIntervaloCarrossel(){clearInterval(carrosselInterval),iniciarCarrosselAutomatico(),iniciarBarraProgresso()}function construirInterface(){const e=document.querySelector(".grupos-container");if(e){e.innerHTML="";const a=document.createElement("div");a.className="grupo",a.id="lider-geral",a.innerHTML=`
      <h2>L√≠der Geral</h2>
      <div class="membros-grid">
        ${liderGeral?`
          <div class="membro">
            <input type="checkbox" id="${liderGeral.nome}">
            <label for="${liderGeral.nome}">
              ${liderGeral.nome}
              <span id="dias-${liderGeral.nome}" class="dias-badge">0</span>
              <span class="medalha-container">
                <span id="medalha-${liderGeral.nome}" class="medalha escondido"></span>
              </span>
            </label>
          </div>
        `:""}
      </div>
    `,e.appendChild(a);for(const[a,t]of Object.entries(equipes)){const n=document.createElement("div");n.className="grupo",n.id=`equipe-${a}`;let o="";"abelha"===a?o="\uD83D\uDC1D":"joaninha"===a?o="\uD83D\uDC1E":"vagalume"===a&&(o="\uD83D\uDCA1"),n.innerHTML=`
        <h2>${o} Equipe ${a.charAt(0).toUpperCase()+a.slice(1)}</h2>
        <div class="resumo" id="resumo-${a}">
          <div>0 focaram hoje!</div>
          <div>0 pontos na semana</div>
        </div>
		<div class="mensagem-equipe-completa hidden" id="msg-equipe-${a}"></div>
      `;const r=document.createElement("div");if(r.className="lider-equipe",r.innerHTML=`
        <div class="titulo-lider">L√≠der da Equipe</div>
      `,t.lider){const e=document.createElement("div");e.className="membro",e.innerHTML=`
          <input type="checkbox" id="${t.lider.nome}">
          <label for="${t.lider.nome}">
            ${t.lider.nome}
            <span id="dias-${t.lider.nome}" class="dias-badge">0</span>
            <span class="medalha-container">
              <span id="medalha-${t.lider.nome}" class="medalha escondido"></span>
            </span>
          </label>
        `,r.appendChild(e)}else{const e=document.createElement("div");e.className="sem-lider",e.textContent="Sem l\xEDder",r.appendChild(e)}n.appendChild(r);const i=document.createElement("div");i.className="membros-grid",t.membros.forEach(e=>{if(!(t.lider&&e.nome===t.lider.nome)){const a=document.createElement("div");a.className="membro",a.innerHTML=`
          <input type="checkbox" id="${e.nome}">
          <label for="${e.nome}">
            ${e.nome}
            <span id="dias-${e.nome}" class="dias-badge">0</span>
            <span class="medalha-container">
              <span id="medalha-${e.nome}" class="medalha escondido"></span>
            </span>
          </label>
        `,i.appendChild(a)}}),n.appendChild(i),e.appendChild(n)}todosMembros.forEach(e=>{const a=e.nome,t=document.getElementById(a);t&&(t.onchange=()=>marcarCheckbox(a))})}}window.togglePainelSecreto=function(e){const a=document.getElementById("painel-secreto");a.style.display=e?"block":"none"};function verificarCliquesDiamante(){if(cliqueCount++,clearTimeout(timeoutClique),5===cliqueCount){const e=prompt("\uD83D\uDD10 Digite a senha para acessar o painel secreto:");"goiaba"===e?togglePainelSecreto(!0):alert("\u274C Senha incorreta!"),cliqueCount=0}else timeoutClique=setTimeout(()=>{cliqueCount=0},3e3)}let intervaloConfete=null,animacaoConfeteAniversarioId=null,geradorDeParticulasId=null,particulasAniversario=[];async function carregarAniversariantes(){const e=getHoje(),a=e.getMonth()+1,t=e.getDate(),n=await getDocs(collection(db,"membros")),o=[];let r=null,i=1/0;n.forEach(n=>{const d=n.data();if(d.aniversario){const[s,l]=d.aniversario.split("/").map(Number);l===a&&o.push({nome:n.id,data:d.aniversario,hoje:s===t});let m=new Date(e.getFullYear(),l-1,s);m<e&&m.setFullYear(e.getFullYear()+1);const c=Math.ceil((m-e)/86400000);c<i&&(i=c,r={nome:n.id,dias:c,data:d.aniversario})}}),atualizarInterfaceAniversariantes(o,r),o.some(e=>e.hoje)?iniciarConfeteAniversarioContinuo():pararConfeteAniversarioContinuo()}function atualizarInterfaceAniversariantes(e,a){const t=document.getElementById("aniversariantes-hoje"),n=document.getElementById("proximos-aniversarios");t.innerHTML="",n.innerHTML="";const o=document.createElement("div");if(o.className="aniversariantes-container-hoje",0<e.length)e.forEach(e=>{const a=document.createElement("div");a.className="aniversariante-card",e.hoje&&a.classList.add("hoje"),a.innerHTML=`
          <div class="aniversariante-nome">${e.nome}</div>
          <div class="aniversariante-data">${e.data}</div>
        `,o.appendChild(a)});else{const e=document.createElement("div");e.className="aniversariante-card mensagem-vazia",e.textContent="Nenhum aniversariante neste m\xEAs",o.appendChild(e)}t.appendChild(o),n.innerHTML=a?`
        <div style="font-weight:bold; margin-bottom:8px; font-size:1.1rem;">Pr√≥ximo Aniversariante:</div>
        <div>Faltam <strong>${a.dias}</strong> dias para o anivers√°rio de</div>
        <div><strong>${a.nome}</strong> (${a.data})</div>
      `:"<div>Nenhum pr\xF3ximo anivers\xE1rio cadastrado</div>"}function iniciarConfetePeriodico(){pararConfetePeriodico(),intervaloConfete=setInterval(dispararConfete,5e3),dispararConfete()}function pararConfetePeriodico(){intervaloConfete&&(clearInterval(intervaloConfete),intervaloConfete=null)}async function exibirQuadroFolgas(){try{const e=await getDocs(collection(db,"membros")),a=getHoje().toLocaleDateString("pt-BR",{weekday:"long"}),t=a.toLowerCase().replace(/-feira$/,"").normalize("NFD").replace(/[\u0300-\u036f]/g,""),n=["segunda","terca","quarta","quinta","sexta","sabado","domingo"];n.forEach(e=>{const a=document.getElementById(e);a&&(a.innerHTML="",a.classList.remove("centralizado"))}),document.querySelectorAll(".dia-col").forEach(e=>e.classList.remove("dia-hoje"));const o=document.getElementById(t);o&&o.closest(".dia-col")?.classList.add("dia-hoje");const r={segunda:0,terca:0,quarta:0,quinta:0,sexta:0,sabado:0,domingo:0};e.forEach(e=>{const a=e.id,o=e.data().folga||"",i=o.toLowerCase().replace(/-feira$/,"").normalize("NFD").replace(/[\u0300-\u036f]/g,"");if(i&&n.includes(i)){const e=document.getElementById(i);if(e){const n=document.createElement("div");n.className="membro-folga",i===t?(n.classList.add("membro-folga-hoje"),n.innerHTML=`<div>${a}</div>`):n.textContent=a,e.appendChild(n),r[i]++}}}),n.forEach(e=>{const a=document.getElementById(e);if(a&&2>=r[e]&&a.classList.add("centralizado"),a&&0===a.children.length){const t="domingo"===e?"Folga Coletiva":"Ningu\xE9m";a.innerHTML=`<div class="membro-folga">${t}</div>`,a.classList.add("centralizado")}})}catch(e){console.error("Erro ao carregar folgas:",e)}}async function openChangeFolgaModal(){if(currentUser)try{const e=doc(db,"membros",currentUser),a=await getDoc(e);if(a.exists()){const e=a.data(),t=getSemanaAtual().numero,n=e.semanaTrocaFolga||0;if("lider"!==userRole&&n===t)return void mostrarPopup("\uD83D\uDEAB Limite Atingido","Voc\xEA j\xE1 alterou sua folga esta semana. Tente novamente na pr\xF3xima.",5e3);const o=document.getElementById("select-new-folga");o.value=e.folga||"segunda-feira",openModal("change-folga-modal")}}catch(e){console.error("Erro ao verificar permiss\xE3o de troca de folga:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel verificar seus dados de folga.",3e3)}}window.abrirModalReagentes=async function(e,a){try{const t=doc(db,"mural",e),n=await getDoc(t);if(!n.exists())return;const o=n.data().reacoes||{},r=Array.isArray(o[a])?o[a]:[],i=document.getElementById("reactors-modal-title"),d=document.getElementById("reactors-modal-list"),s=document.getElementById("remove-my-reaction-btn");i.innerHTML=`Reagiram com ${a}`,d.innerHTML="",0<r.length?r.forEach(e=>{const a=document.createElement("div");a.className="reactor-item",a.textContent=e,d.appendChild(a)}):d.innerHTML="<div class=\"reactor-item\" style=\"text-align:center; font-style:italic;\">Ningu\xE9m reagiu com este emoji ainda.</div>",currentUser&&r.includes(currentUser)?(s.style.display="block",s.onclick=async()=>{await window.toggleReacao(e,a),closeModal("reactors-modal")}):s.style.display="none",openModal("reactors-modal")}catch(e){console.error("Erro ao abrir modal de reagentes:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel carregar quem reagiu.",3e3)}};async function handleUpdateFolga(){const e=document.getElementById("select-new-folga").value,a=getSemanaAtual().numero,t=doc(db,"membros",currentUser);try{await updateDoc(t,{folga:e,semanaTrocaFolga:a}),mostrarPopup("\u2705 Sucesso",`Sua folga foi alterada para ${e}!`,4e3),closeModal("change-folga-modal"),await exibirQuadroFolgas()}catch(e){console.error("Erro ao atualizar folga:",e),mostrarPopup("\u274C Erro","Falha ao salvar sua nova folga.",3e3)}}function atualizarRelogio(){const e=new Date,a=(e.getHours()+"").padStart(2,"0"),t=(e.getMinutes()+"").padStart(2,"0"),n=(e.getSeconds()+"").padStart(2,"0");document.getElementById("relogio").textContent=`${a}:${t}:${n}`}async function handleLogin(){let e=loginUsernameInput.value.trim();e&&(e=e.charAt(0).toUpperCase()+e.slice(1).toLowerCase());const a=loginPasswordInput.value;if(!e||!a)return void mostrarPopup("\u274C Erro","Por favor, preencha todos os campos",3e3);try{const t=await getDoc(doc(db,"membros",e));if(t.exists()){const n=t.data();n.senha===a&&"on"===n.usedProv?(localStorage.setItem("loggedInUser",e),mostrarPopup("\u2705 Sucesso",`Bem-vindo(a) de volta, ${e}!`,3e3),await performSuccessfulLogin(e),currentUser=e,userRole=n.papel,userTeam=n.equipe,authContainer.classList.add("hidden"),mainContent.classList.remove("hidden"),document.getElementById("user-menu-container").classList.remove("hidden"),await carregarMembros(),construirInterface(),await Promise.all([carregarPresenca(),carregarPontosSemanais()]),await atualizarResumo(),await Promise.all([carregarTop5Semana(),exibirQuadroFolgas(),carregarInformacoesMembros(),carregarTotalDias(),carregarStreaks()]),atualizarVisualBloqueio()):n.senhaProv===a&&"off"===n.usedProv?(currentUser=e,mostrarPopup("\uD83D\uDD11 Primeiro Acesso","Crie sua senha definitiva para continuar.",4e3),showChangePasswordForm()):mostrarPopup("\u274C Erro de Acesso","Nome ou senha incorreta.",3e3)}else mostrarPopup("\u274C Erro","Usu\xE1rio n\xE3o encontrado",3e3)}catch(e){console.error("Erro no login:",e),mostrarPopup("\u274C Erro","Falha no login: "+e.message,5e3)}}async function performSuccessfulLogin(e){dataAtual=getHojeISO();const a=await getDoc(doc(db,"membros",e));if(!a.exists())return localStorage.removeItem("loggedInUser"),void location.reload();const t=a.data();currentUser=e,userRole=t.papel,userTeam=t.equipe,document.getElementById("user-greeting").textContent=`Ol√°, ${currentUser}!`;const n=document.getElementById("menu-option-control-panel");"lider"===userRole||"lider-equipe"===userRole?n.classList.remove("hidden"):n.classList.add("hidden"),authContainer.classList.add("hidden"),mainContent.classList.remove("hidden"),document.getElementById("user-menu-container").classList.remove("hidden"),await carregarMembros(),construirInterface(),await Promise.all([carregarPresenca(),carregarPontosSemanais(),carregarAniversariantes(),carregarRankingGeral(),carregarArvoreEpica(),loadAdvantageState()]),atualizarPlacarSemanal(),atualizarRankingGeral(),await atualizarResumo();const o=new Date().getHours(),r=document.body;r.classList.remove("tema-manha","tema-tarde","tema-noite"),5<=o&&12>o?r.classList.add("tema-manha"):12<=o&&18>o?r.classList.add("tema-tarde"):r.classList.add("tema-noite"),atualizarDataCabecalho(),atualizarInfoSemana(),configurarMuralTempoReal(),createColorPalette(),await finalizarSemana(),await Promise.all([carregarTop5Semana(),exibirQuadroFolgas(),carregarInformacoesMembros(),carregarTotalDias(),carregarStreaks()]),atualizarVisualBloqueio(),await carregarEExibirMembrosOciosos(),setTimeout(()=>{iniciarCarrosselAutomatico(),irParaSlide(0)},1e3),await verificarEExibirResumoDeOntem()}function handleLogout(){localStorage.removeItem("loggedInUser"),currentUser=null,userRole=null,userTeam=null,authContainer.classList.remove("hidden"),mainContent.classList.add("hidden"),document.getElementById("user-menu-container").classList.add("hidden"),loginUsernameInput.value="",loginPasswordInput.value="",showLoginForm(),mostrarPopup("\u2139\uFE0F Sess\xE3o encerrada","Voc\xEA saiu do sistema",3e3)}function showChangePasswordForm(){loginForm.classList.add("hidden"),changePasswordForm.classList.remove("hidden")}function showLoginForm(){changePasswordForm.classList.add("hidden"),forgotPasswordForm.classList.add("hidden"),secretQuestionForm.classList.add("hidden"),loginForm.classList.remove("hidden")}async function handlePasswordChange(){const e=document.getElementById("new-password").value,a=document.getElementById("confirm-new-password").value;if(!e||!a)return void mostrarPopup("\u274C Erro","Preencha todos os campos",3e3);if(e!==a)return void mostrarPopup("\u274C Erro","As novas senhas n\xE3o coincidem",3e3);if(6>e.length)return void mostrarPopup("\u274C Erro","A senha deve ter no m\xEDnimo 6 caracteres.",3e3);try{const a=doc(db,"membros",currentUser);await updateDoc(a,{senha:e}),mostrarPopup("\u2705 Senha Criada","Agora, vamos configurar sua recupera\xE7\xE3o de login.",5e3),document.getElementById("new-password").value="",document.getElementById("confirm-new-password").value="",showSecretQuestionForm()}catch(e){console.error("Erro ao alterar senha:",e),mostrarPopup("\u274C Erro","Falha ao alterar senha. Tente novamente.",3e3)}}function initAuth(){authContainer=document.getElementById("auth-container"),mainContent=document.getElementById("main-content"),logoutBtn=document.getElementById("logout-btn"),loginForm=document.getElementById("login-form"),changePasswordForm=document.getElementById("change-password-form"),loginBtn=document.getElementById("login-btn"),loginUsernameInput=document.getElementById("login-username"),loginPasswordInput=document.getElementById("login-password"),forgotPasswordForm=document.getElementById("forgot-password-form"),secretQuestionForm=document.getElementById("secret-question-form");const e=document.getElementById("toggle-password-btn");loginPasswordInput&&e&&(loginPasswordInput.addEventListener("input",()=>{e.style.display=0<loginPasswordInput.value.length?"block":"none"}),e.addEventListener("click",()=>{const a="password"===loginPasswordInput.type;a?(loginPasswordInput.type="text",e.textContent="Ocultar"):(loginPasswordInput.type="password",e.textContent="Ver")})),loginBtn&&loginBtn.addEventListener("click",handleLogin),logoutBtn&&logoutBtn.addEventListener("click",handleLogout),loginPasswordInput&&loginPasswordInput.addEventListener("keypress",a=>{"Enter"===a.key&&handleLogin()});const a=document.getElementById("user-menu-btn"),t=document.getElementById("user-menu-dropdown");a&&a.addEventListener("click",a=>{a.stopPropagation(),t.classList.toggle("hidden")}),document.getElementById("menu-option-logout")?.addEventListener("click",handleLogout),document.getElementById("menu-option-change-password")?.addEventListener("click",()=>openModal("change-password-modal")),document.getElementById("menu-option-change-secret")?.addEventListener("click",()=>openModal("change-secret-modal")),document.getElementById("confirm-remove-button")?.addEventListener("click",executeRemoveMember),document.getElementById("change-folga-btn")?.addEventListener("click",openChangeFolgaModal),document.getElementById("save-new-folga-btn")?.addEventListener("click",handleUpdateFolga),document.getElementById("save-new-password-btn")?.addEventListener("click",handleUpdatePassword),document.getElementById("save-new-secret-btn")?.addEventListener("click",handleUpdateSecretAnswer),window.addEventListener("click",()=>{t&&!t.classList.contains("hidden")&&t.classList.add("hidden")}),document.getElementById("open-composer-btn")?.addEventListener("click",()=>openMessageComposer()),document.getElementById("confirm-delete-btn")?.addEventListener("click",confirmDelete),document.getElementById("viewer-close-btn")?.addEventListener("click",()=>closeModal("message-viewer-modal")),document.getElementById("composer-color-btn")?.addEventListener("click",a=>{a.stopPropagation(),document.getElementById("composer-color-palette").classList.toggle("hidden")}),document.getElementById("composer-close-btn")?.addEventListener("click",closeMessageComposer),document.getElementById("composer-send-btn")?.addEventListener("click",enviarMensagem),document.getElementById("menu-option-control-panel")?.addEventListener("click",openControlPanel),document.getElementById("add-member-btn")?.addEventListener("click",handleAddMember),document.getElementById("remove-member-btn")?.addEventListener("click",handleRemoveMember),document.getElementById("change-password-btn")?.addEventListener("click",handlePasswordChange),document.getElementById("cancel-change-password")?.addEventListener("click",showLoginForm),document.getElementById("forgot-password-link")?.addEventListener("click",showForgotPasswordForm),document.getElementById("verify-answer-btn")?.addEventListener("click",handleVerifySecretAnswer),document.getElementById("cancel-forgot-password")?.addEventListener("click",showLoginForm),document.getElementById("save-secret-answer-btn")?.addEventListener("click",handleSaveSecretAnswer)}async function loginUser(){const e=loginUsernameInput.value.trim(),a=loginPasswordInput.value.trim();if(!e||!a)return void mostrarPopup("Erro","Por favor, preencha todos os campos.",3e3);try{const t=doc(db,"users",e),n=await getDoc(t);if(n.exists()){const t=n.data();if(t.password===a){currentUser=e;const a=doc(db,"membros",currentUser),t=await getDoc(a);if(t.exists()){const e=t.data();currentUserRole=e.papel||"membro",currentUserTeam=e.equipe||null}else console.warn("Documento do membro n\xE3o encontrado na cole\xE7\xE3o 'membros' para o usu\xE1rio logado:",currentUser),currentUserRole="membro",currentUserTeam=null;await carregarInformacoesMembros(),await carregarInformacoesMembros(),mostrarPopup("Sucesso",`Bem-vindo(a), ${e}!`,3e3),authContainer.classList.add("hidden"),mainContent.classList.remove("hidden"),logoutBtn.classList.remove("hidden"),atualizarPermissoesCheckboxes()}else mostrarPopup("Erro","Senha incorreta.",3e3)}else mostrarPopup("Erro","Usu\xE1rio n\xE3o encontrado.",3e3)}catch(a){console.error("Erro ao fazer login: ",a),mostrarPopup("Erro","Erro ao fazer login. Tente novamente.",3e3)}}window.copyToClipboard=function(e,a){navigator.clipboard.writeText(e).then(()=>{mostrarPopup("\u2705 Copiado",`${a} copiado para a √°rea de transfer√™ncia!`,2e3)}).catch(e=>{console.error("Erro ao copiar: ",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel copiar.",3e3)})};function podeMarcarCheckbox(e,a){return!!currentUser&&(!("lider"!==currentUserRole)||!("lider-equipe"!==currentUserRole||currentUserTeam!==a)||!("membro"!==currentUserRole||currentUser!==e))}function atualizarPermissoesCheckboxes(){const e=document.querySelectorAll(".tarefa-checkbox");e.forEach(e=>{const a=e.dataset.memberId,t=e.dataset.memberTeam;a&&t&&(e.disabled=!podeMarcarCheckbox(a,t))})}function atualizarVisualBloqueio(){currentUser&&todosMembros.forEach(e=>{const a=document.getElementById(e.nome);if(!a)return;let t=!1;("lider"===userRole||"lider-equipe"===userRole&&e.equipe===userTeam||currentUser===e.nome)&&(t=!0);const n=a.parentElement;n&&(t?(n.classList.remove("bloqueado"),n.title="Clique para marcar/desmarcar o foco"):(n.classList.add("bloqueado"),n.title="Voc\xEA n\xE3o tem permiss\xE3o para alterar este foco"))})}function showForgotPasswordForm(){loginForm.classList.add("hidden"),changePasswordForm.classList.add("hidden"),forgotPasswordForm.classList.remove("hidden")}async function handleVerifySecretAnswer(){let e=document.getElementById("forgot-username").value.trim();e&&(e=e.charAt(0).toUpperCase()+e.slice(1).toLowerCase());const a=document.getElementById("secret-answer").value.trim();if(!e||!a)return void mostrarPopup("\u274C Erro","Preencha seu nome e a resposta secreta.",3e3);try{const t=doc(db,"membros",e),n=await getDoc(t);if(n.exists()){const t=n.data();t.pet&&t.pet.toLowerCase()===a.toLowerCase()?(currentUser=e,mostrarPopup("\u2705 Correto","Resposta correta! Crie sua nova senha.",3e3),forgotPasswordForm.classList.add("hidden"),changePasswordForm.classList.remove("hidden")):mostrarPopup("\u274C Incorreto","A resposta para a pergunta secreta est\xE1 errada.",4e3)}else mostrarPopup("\u274C Erro","Usu\xE1rio n\xE3o encontrado.",3e3)}catch(e){console.error("Erro ao verificar resposta secreta:",e),mostrarPopup("\u274C Erro","Ocorreu um erro ao verificar os dados.",3e3)}}function showSecretQuestionForm(){loginForm.classList.add("hidden"),changePasswordForm.classList.add("hidden"),forgotPasswordForm.classList.add("hidden"),secretQuestionForm.classList.remove("hidden")}async function handleSaveSecretAnswer(){const e=document.getElementById("setup-secret-answer").value.trim();if(!e)return void mostrarPopup("\u274C Erro","Por favor, preencha a resposta.",3e3);try{const a=doc(db,"membros",currentUser);await updateDoc(a,{pet:e,usedProv:"on"}),mostrarPopup("\u2705 Tudo Pronto!",`Bem-vindo(a), ${currentUser}! Carregando o app...`,4e3),await performSuccessfulLogin(currentUser)}catch(e){console.error("Erro ao salvar resposta secreta:",e),mostrarPopup("\u274C Falha Grave","Ocorreu um erro ao finalizar seu cadastro. Por favor, recarregue a p\xE1gina.",5e3)}}window.openModal=function(e){document.getElementById(e).style.display="flex"},window.closeModal=function(e){document.getElementById(e).style.display="none"};async function handleUpdatePassword(){const e=document.getElementById("logged-in-new-password").value,a=document.getElementById("logged-in-confirm-password").value;if(!e||6>e.length)return void mostrarPopup("\u274C Erro","A senha deve ter no m\xEDnimo 6 caracteres.",3e3);if(e!==a)return void mostrarPopup("\u274C Erro","As senhas n\xE3o coincidem.",3e3);"message-viewer-modal"===modalId&&unsubscribeViewerListener&&(unsubscribeViewerListener(),unsubscribeViewerListener=null);try{await updateDoc(doc(db,"membros",currentUser),{senha:e}),mostrarPopup("\u2705 Sucesso","Sua senha foi alterada!",3e3),closeModal("change-password-modal")}catch(e){mostrarPopup("\u274C Erro","Falha ao atualizar a senha.",3e3),console.error("Erro ao trocar senha:",e)}}async function handleUpdateSecretAnswer(){const e=document.getElementById("new-secret-answer").value.trim();if(!e)return void mostrarPopup("\u274C Erro","Por favor, digite uma resposta.",3e3);try{await updateDoc(doc(db,"membros",currentUser),{pet:e}),mostrarPopup("\u2705 Sucesso","Sua resposta secreta foi atualizada!",3e3),closeModal("change-secret-modal")}catch(e){mostrarPopup("\u274C Erro","Falha ao atualizar a resposta.",3e3),console.error("Erro ao trocar resposta secreta:",e)}}async function coletarDadosDeOntem(e){const a=getHoje(),t=0===a.getDay(),n={},o=await getDoc(doc(db,"presencas",e));if(o.exists()){const e=o.data();n.membrosFocados=Object.keys(e).filter(a=>e[a])}else n.membrosFocados=[];const r=query(collection(db,"logEventos"),where("data","==",e)),i=await getDocs(r);if(n.eventos=i.docs.map(e=>e.data()),!t){const a=getSemanaAtual(),t=`semana_${a.numero}_${a.inicio.getFullYear()}`,o=await getDoc(doc(db,"vantagemSemanal",t));if(o.exists()){const a=o.data().completadoPor||{};n.completaramVantagem=Object.keys(a).filter(t=>{const n=a[t].toDate();return n.toISOString().slice(0,10)===e})}else n.completaramVantagem=[]}const d=new Date(e);d.setHours(0,0,0,0);const s=new Date(e);s.setHours(23,59,59,999);const l=query(collection(db,"mural"),where("timestamp",">=",d),where("timestamp","<=",s)),m=await getDocs(l);if(n.mensagensNoMural=0<m.size,t){const e=getSemanaAtual(new Date(new Date().setDate(new Date().getDate()-1))),a=`resultado_${e.numero}_${e.inicio.getFullYear()}`,t=await getDoc(doc(db,"resultadosSemanais",a));t.exists()&&(n.resultadoSemanal=t.data())}return n}function construirHTMLDoResumo(e){const a={abelha:"Abelha",joaninha:"Joaninha",vagalume:"Vaga-lume"};let t=`<h2>üåü Resumo de Ontem üåü</h2>`;if(e.resultadoSemanal){const{vencedoras:n,pontuacao:o,empate:r}=e.resultadoSemanal,i=n.map(e=>a[e]).join(" e ");t+=`
      <div class="resumo-secao resumo-vitoria-semanal">
        <h3>üèÜ Vit√≥ria Semanal! üèÜ</h3>
        ${r?`<p>As equipes <strong>${i}</strong> empataram com <strong>${o}</strong> pontos, parab√©ns a todos!</p>`:`<p>A equipe <strong>${i}</strong> venceu a semana com <strong>${o}</strong> pontos, parab√©ns!</p>`}
      </div>`}t+=`
    <div class="resumo-secao">
      <h3>üéØ Foco Di√°rio</h3>
      <p>Ontem, <strong>${e.membrosFocados.length}</strong> √©picos focaram!</p>`,0<e.membrosFocados.length&&(t+=`<ul>${e.membrosFocados.map(e=>`<li>${e}</li>`).join("")}</ul>`),t+=`</div>`;const n=e.eventos.filter(a=>"nova_medalha"===a.tipo);0<n.length&&(t+=`
      <div class="resumo-secao">
        <h3>üèÖ Novas Medalhas</h3>
        <ul>${n.map(a=>`<li><strong>${a.nomeMembro}</strong> ganhou: ${a.detalhe}</li>`).join("")}</ul>
      </div>`);const o=e.eventos.filter(a=>"vantagem_concluida"===a.tipo);if(0<o.length){const e={abelha:0,joaninha:0,vagalume:0},n={abelha:[],joaninha:[],vagalume:[]};o.forEach(a=>{const t=a.detalhe;t&&e.hasOwnProperty(t)&&(e[t]+=3,n[t].push(a.nomeMembro))}),t+=`
      <div class="resumo-secao">
        <h3>üéÆ Resultado do Jogo da Vantagem</h3>
        <p>Pontos de b√¥nus adicionados no s√°bado:</p>
        <ul>
          ${Object.keys(e).map(t=>0<e[t]?`<li><strong>Equipe ${a[t]}:</strong> +${e[t]} pontos (Conclu√≠do por: ${n[t].join(", ")})</li>`:"").join("")}
        </ul>
      </div>`}e.completaramVantagem&&(t+=`
      <div class="resumo-secao">
        <h3>üéÆ Jogo da Vantagem</h3>`,t+=0<e.completaramVantagem.length?`<p><strong>${e.completaramVantagem.length}</strong> membro(s) completaram o desafio ontem:</p>
               <ul>${e.completaramVantagem.map(e=>`<li>${e}</li>`).join("")}</ul>`:`<p class="sem-dados">Ningu√©m completou o Jogo da Vantagem ontem.</p>`,t+=`</div>`),t+=`
    <div class="resumo-secao">
        <h3>‚úçÔ∏è Mural de Mensagens</h3>
        ${e.mensagensNoMural?`<p>O mural esteve movimentado ontem com novas mensagens!</p>`:`<p class="sem-dados">Nenhuma mensagem foi postada no mural ontem.</p>`}
    </div>`;const r=e.eventos.filter(a=>"membro_adicionado"===a.tipo),i=e.eventos.filter(a=>"membro_removido"===a.tipo);return(0<r.length||0<i.length)&&(t+=`<div class="resumo-secao"><h3>üîÑ Gerenciamento do Grupo</h3>`,0<r.length&&(t+=`<p>Novos membros se juntaram a n√≥s: <strong>${r.map(a=>a.nomeMembro).join(", ")}</strong>. Bem-vindos!</p>`),0<i.length&&(t+=`<p>Nos despedimos de: <strong>${i.map(a=>a.nomeMembro).join(", ")}</strong>.</p>`),t+=`</div>`),t}async function verificarEExibirResumoDeOntem(){if(!currentUser)return;const e=getHoje(),a=getHojeISO(),t=`resumoVisto_${a}_${currentUser}`;if(localStorage.getItem(t))return;const n=new Date(e);n.setDate(e.getDate()-1);const o=n.toISOString().slice(0,10),r=document.getElementById("resumo-ontem-modal");openModal("resumo-ontem-modal");try{const e=await coletarDadosDeOntem(o),a=construirHTMLDoResumo(e);document.getElementById("resumo-ontem-body").innerHTML=a,document.getElementById("fechar-resumo-btn").onclick=()=>{closeModal("resumo-ontem-modal"),localStorage.setItem(t,"true")}}catch(e){console.error("Erro ao gerar o resumo de ontem:",e),document.getElementById("resumo-ontem-body").innerHTML="<h2>Ocorreu um erro</h2><p>N\xE3o foi poss\xEDvel carregar o resumo de ontem. Por favor, tente recarregar a p\xE1gina.</p>"}}window.onload=async()=>{initAuth(),"serviceWorker"in navigator&&navigator.serviceWorker.register("/sw.js").then(e=>{console.log("Service Worker registrado com sucesso:",e)}).catch(e=>{console.log("Falha ao registrar Service Worker:",e)});const e=localStorage.getItem("loggedInUser");if(e){await performSuccessfulLogin(e);const a=document.getElementById("medalha-diamante");a&&a.addEventListener("click",verificarCliquesDiamante)}else{dataAtual=getHojeISO(),await carregarMembros(),construirInterface(),setTimeout(()=>{iniciarCarrosselAutomatico(),irParaSlide(0)},1e3),await Promise.all([carregarPresenca(),carregarPontosSemanais(),carregarRankingGeral(),carregarAniversariantes(),carregarArvoreEpica(),carregarStreaks(),carregarTotalDias()]),0===getHoje().getDay()&&(pontosSemanais.abelha=0,pontosSemanais.joaninha=0,pontosSemanais.vagalume=0);const e=getSemanaAtual(),a=doc(db,"semanas",e.inicio.toISOString().slice(0,10)),t=await getDoc(a);t.exists()||(await setDoc(a,{abelha:0,joaninha:0,vagalume:0,finalizada:!1}));const n=doc(db,"ranking","geral"),o=await getDoc(n);o.exists()||(await setDoc(n,rankingGeral)),atualizarPlacarSemanal(),atualizarRankingGeral(),await finalizarSemana();const r=new Date().getHours(),i=document.body;i.classList.remove("tema-manha","tema-tarde","tema-noite"),5<=r&&12>r?i.classList.add("tema-manha"):12<=r&&18>r?i.classList.add("tema-tarde"):i.classList.add("tema-noite"),atualizarDataCabecalho(),atualizarInfoSemana();const d=document.getElementById("medalha-diamante");d&&d.addEventListener("click",verificarCliquesDiamante),await atualizarResumo(),verificarEquipeCompleta(),configurarMuralTempoReal(),configurarInputMensagem(),await exibirQuadroFolgas(),carregarTop5Semana(),window.addEventListener("beforeunload",()=>{pararConfeteAniversarioContinuo()})}atualizarRelogio(),setInterval(atualizarRelogio,1e3),setInterval(verificarMudancaData,6e4),window.addEventListener("focus",verificarMudancaData)};async function refreshAppUI(){mostrarPopup("\uD83D\uDD04 Atualizando","Aguarde, recarregando a interface...",2e3),await carregarMembros(),construirInterface(),await Promise.all([carregarPresenca(),carregarPontosSemanais(),carregarRankingGeral(),carregarAniversariantes(),carregarArvoreEpica(),carregarStreaks(),carregarTotalDias(),exibirQuadroFolgas(),carregarInformacoesMembros()]),await atualizarResumo(),atualizarPlacarSemanal(),atualizarRankingGeral(),atualizarVisualBloqueio(),await carregarEExibirMembrosOciosos(),mostrarPopup("\u2705 Pronto!","Interface atualizada com sucesso!",3e3)}async function openControlPanel(){const e=document.getElementById("select-member-to-remove"),a=document.getElementById("new-member-team"),t=document.getElementById("new-member-role");e.innerHTML="<option value=\"\">Selecione um membro para remover...</option>",todosMembros.forEach(a=>{if(a.nome!==currentUser)if("lider"===userRole){const t=new Option(`${a.nome} (${a.equipe})`,a.nome);e.appendChild(t)}else if("lider-equipe"===userRole&&a.equipe===userTeam){const t=new Option(a.nome,a.nome);e.appendChild(t)}}),"lider-equipe"===userRole?(a.value=userTeam,a.disabled=!0,t.value="membro"):a.disabled=!1,document.getElementById("new-member-result").textContent="",openModal("control-panel-modal")}window.abrirPlacarVantagem=async function(){const e=getSemanaAtual(),a=`semana_${e.numero}_${e.inicio.getFullYear()}`,t=doc(db,"vantagemSemanal",a),n=document.getElementById("placar-completos"),o=document.getElementById("placar-pendentes");n.innerHTML="<li>Carregando...</li>",o.innerHTML="<li>Carregando...</li>",openModal("placar-vantagem-modal");try{const e=await getDoc(t),a=e.exists()?e.data().completadoPor||{}:{},r=[],i=[];todosMembros.forEach(e=>{a[e.nome]?r.push({nome:e.nome,equipe:e.equipe,timestamp:a[e.nome].toDate()}):i.push({nome:e.nome,equipe:e.equipe})}),r.sort((e,a)=>e.timestamp-a.timestamp),n.innerHTML=0<r.length?r.map((e,a)=>{const t=e.timestamp.toLocaleDateString("pt-BR"),n=e.timestamp.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});return`
          <div class="placar-item">
            <span class="posicao">${a+1}¬∫</span>
            <span class="nome ${e.equipe}">${e.nome}</span>
            <span class="timestamp">${t} √†s ${n}</span>
          </div>
        `}).join(""):"<div class=\"placar-item\">Ningu\xE9m finalizou o jogo ainda.</div>",o.innerHTML=0<i.length?i.map(e=>`
          <div class="placar-item">
             <span class="nome ${e.equipe}">${e.nome}</span>
          </div>
        `).join(""):"<div class=\"placar-item\">Todos os membros finalizaram! Parab\xE9ns!</div>"}catch(e){console.error("Erro ao carregar placar da vantagem:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel carregar o placar.",4e3),closeModal("placar-vantagem-modal")}};async function handleAddMember(){let e=document.getElementById("new-member-name").value.trim();const a=document.getElementById("new-member-team").value,t=document.getElementById("new-member-role").value;if(!e)return void mostrarPopup("\u274C Erro","O nome do membro n\xE3o pode ser vazio.",3e3);e=e.charAt(0).toUpperCase()+e.slice(1);const n=todosMembros.some(a=>a.nome.toLowerCase()===e.toLowerCase());if(n)return void mostrarPopup("\u274C Erro",`O membro "${e}" j√° existe!`,4e3);const o=Math.floor(1e4+9e4*Math.random()).toString();try{await setDoc(doc(db,"membros",e),{equipe:a,papel:t,senhaProv:o,usedProv:"off",folga:"segunda-feira",aniversario:"",apelido:"",filme:"",sonho:"",musica:"",curiosidade:""});const n=doc(collection(db,"logEventos"));await setDoc(n,{tipo:"membro_adicionado",nomeMembro:e,data:getHojeISO()}),document.getElementById("success-username").innerText=e,document.getElementById("success-password").innerText=o,openModal("new-member-success-modal"),document.getElementById("new-member-name").value="",document.getElementById("new-member-result").textContent="",await refreshAppUI()}catch(e){console.error("Erro ao adicionar membro:",e),mostrarPopup("\u274C Falha","Ocorreu um erro ao salvar o novo membro.",4e3)}}async function handleRemoveMember(){const e=document.getElementById("select-member-to-remove").value;return e?void(memberIdToRemove=e,document.getElementById("member-to-remove-name").innerText=e,openModal("confirm-remove-modal")):void mostrarPopup("\u274C Erro","Selecione um membro para remover.",3e3)}async function executeRemoveMember(){if(memberIdToRemove)try{await deleteDoc(doc(db,"membros",memberIdToRemove)),mostrarPopup("\u2705 Sucesso",`O membro "${memberIdToRemove}" foi removido.`,4e3),await refreshAppUI(),closeModal("control-panel-modal"),openControlPanel()}catch(e){console.error("Erro ao remover membro:",e),mostrarPopup("\u274C Falha","Ocorreu um erro ao remover o membro.",4e3)}finally{memberIdToRemove=null,closeModal("confirm-remove-modal")}}const todosOsJogos=[{nome:"Jogo da Mem\xF3ria",initFunction:initMemoryGame,htmlContent:""},{nome:"Acerte o Alvo",initFunction:initClickerGame,htmlContent:`
            <div id="clicker-game-board">
                <div class="clicker-stats">
                    <div id="clicker-score">Pontos: 0</div>
                    <div id="clicker-timer">Tempo: 30</div>
                </div>
                <button id="clicker-start-button">Come√ßar!</button>
            </div>
        `},{nome:"Sequ\xEAncia de Cores",initFunction:initSimonGame,htmlContent:`
            <div id="simon-game-board">
                <div id="simon-info-display">N√≠vel: 1</div>
                <div id="simon-pads-container">
                    <div class="simon-pad" id="simon-pad-0" data-index="0"></div>
                    <div class="simon-pad" id="simon-pad-1" data-index="1"></div>
                    <div class="simon-pad" id="simon-pad-2" data-index="2"></div>
                    <div class="simon-pad" id="simon-pad-3" data-index="3"></div>
                </div>
                <button id="simon-start-button">Iniciar</button>
            </div>
        `},{nome:"Jogo da Velha",initFunction:initTicTacToeGame,htmlContent:`
        <div id="tictactoe-board-wrapper">
            <div id="tictactoe-symbol-selection">
                <div class="status-display">Escolha seu lado:</div>
                <div class="symbol-buttons">
                    <button id="select-X" class="symbol-btn x">X</button>
                    <button id="select-O" class="symbol-btn o">O</button>
                </div>
            </div>

            <div id="tictactoe-status" class="status-display hidden">Sua vez de jogar (X)</div>
            <div id="tictactoe-board" class="hidden">
                <div class="tictactoe-cell" data-cell-index="0"></div>
                <div class="tictactoe-cell" data-cell-index="1"></div>
                <div class="tictactoe-cell" data-cell-index="2"></div>
                <div class="tictactoe-cell" data-cell-index="3"></div>
                <div class="tictactoe-cell" data-cell-index="4"></div>
                <div class="tictactoe-cell" data-cell-index="5"></div>
                <div class="tictactoe-cell" data-cell-index="6"></div>
                <div class="tictactoe-cell" data-cell-index="7"></div>
                <div class="tictactoe-cell" data-cell-index="8"></div>
                <div id="tictactoe-winning-line" class="winning-line"></div>
            </div>
            <button id="tictactoe-restart-button" class="hidden">Jogar Novamente</button>
        </div>
    `}];async function loadAdvantageState(){if(!currentUser)return;const e=document.getElementById("leader-advantage-controls");"lider"===userRole?(e.classList.remove("hidden"),document.getElementById("leader-test-button").onclick=window.toggleLeaderTestPanel,populateLeaderTestPanel()):e.classList.add("hidden");const a=getHoje(),t=a.getDay(),n=getSemanaAtual(),o=`semana_${n.numero}_${n.inicio.getFullYear()}`,r=doc(db,"vantagemSemanal",o),i=await getDoc(r),d=i.exists()&&i.data().completadoPor?.[currentUser];if(d){if(lockAdvantageSection("Desafio conclu\xEDdo! Volte na pr\xF3xima semana para mais."),document.getElementById("advantage-game-board").innerHTML="","lider"!==userRole)return;}else if((0===t||6===t)&&(lockAdvantageSection("O tempo para este desafio acabou. Ele retorna na Segunda-feira!"),document.getElementById("advantage-game-board").innerHTML="","lider"!==userRole))return;unlockAdvantageSection();const s=document.getElementById("advantage-game-board"),l=document.getElementById("vantagem-jogo-nome"),m=n.numero%todosOsJogos.length,c=todosOsJogos[m];l&&(l.textContent=`Jogo da Semana: ${c.nome}`),s.innerHTML=c.htmlContent,c.initFunction()}function lockAdvantageSection(e){const a=document.getElementById("vantagem-locked-overlay"),t=document.getElementById("vantagem-lock-message");a&&t&&(t.textContent=e,a.classList.remove("hidden"))}function unlockAdvantageSection(){const e=document.getElementById("vantagem-locked-overlay");e&&e.classList.add("hidden")}async function saveAdvantageCompletion(){if(!currentUser)return;const e=getSemanaAtual(),a=`semana_${e.numero}_${e.inicio.getFullYear()}`,t=doc(db,"vantagemSemanal",a);try{await setDoc(t,{completadoPor:{[currentUser]:new Date}},{merge:!0}),console.log(`Conclus√£o salva para ${currentUser}`)}catch(e){console.error("Erro ao salvar conclus\xE3o:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel salvar seu progresso.",4e3)}}async function handleGameWin(e){mostrarPopup(`üéâ Parab√©ns!`,`Voc√™ venceu o ${e}!`,5e3),dispararConfete(),await saveAdvantageCompletion(),lockAdvantageSection("Desafio conclu\xEDdo! Volte na pr\xF3xima semana.")}window.toggleLeaderTestPanel=function(){const e=document.getElementById("leader-test-panel");e.classList.toggle("hidden")};function populateLeaderTestPanel(){const e=document.getElementById("leader-game-list");e&&(e.innerHTML="",todosOsJogos.forEach((a,t)=>{const n=document.createElement("li"),o=document.createElement("button");o.textContent=a.nome,o.onclick=()=>startLeaderTestGame(t),n.appendChild(o),e.appendChild(n)}))}function startLeaderTestGame(e){const a=todosOsJogos[e],t=document.getElementById("advantage-game-board")||document.getElementById("memory-game-board"),n=document.getElementById("vantagem-jogo-nome");a&&t&&n&&(t.id="advantage-game-board",n.textContent=`Modo de Teste: ${a.nome}`,t.innerHTML=a.htmlContent,a.initFunction(),document.getElementById("leader-test-panel").classList.add("hidden"),unlockAdvantageSection())}function initMemoryGame(){function e(e){i||e.classList.contains("flipped")||!currentUser||(e.classList.add("flipped"),o.push(e),2===o.length&&a())}function a(){i=!0;const[e,a]=o,d=e.dataset.emoji===a.dataset.emoji;d?setTimeout(()=>{e.classList.add("matched"),a.classList.add("matched"),r++,r===n.length&&setTimeout(()=>handleGameWin("Jogo da Mem\xF3ria"),500),t()},600):setTimeout(()=>{e.classList.remove("flipped"),a.classList.remove("flipped"),t()},1200)}function t(){o=[],i=!1}const n=["\uD83E\uDDE0","\uD83D\uDD25","\uD83D\uDE80","\uD83D\uDC8E","\uD83C\uDFC6","\uD83C\uDF1E","\uD83E\uDDF8","\uD83D\uDC38"];let o=[],r=0,i=!1;const d=document.getElementById("advantage-game-board");d.id="memory-game-board",d.innerHTML="";const s=[...n,...n];s.sort(()=>.5-Math.random()),s.forEach(a=>{const t=document.createElement("div");t.classList.add("memory-card"),t.dataset.emoji=a,t.innerHTML=`<div class="card-face card-front"></div><div class="card-face card-back">${a}</div>`,t.addEventListener("click",()=>e(t)),d.appendChild(t)})}function initClickerGame(){function e(){i&&(i.style.display="none",s=0,l=25,o&&(o.textContent=`Pontos: 0 / ${d}`),r&&(r.textContent=`Tempo: ${l}`,r.classList.remove("ending")),m=setInterval(()=>{l--,r&&(r.textContent=`Tempo: ${l}`),5>=l&&r&&r.classList.add("ending"),0>=l&&t(!1)},1e3),c=setInterval(a,450))}function a(){if(!n)return;const e=document.createElement("div");e.classList.add("clicker-target");const a=["abelha","joaninha","vagalume"][Math.floor(3*Math.random())];e.classList.add(a),e.textContent=["\uD83D\uDC1D","\uD83D\uDC1E","\uD83D\uDCA1"][Math.floor(3*Math.random())],e.style.top=`${10+70*Math.random()}%`,e.style.left=`${10+70*Math.random()}%`,e.onclick=()=>{s++,o&&(o.textContent=`Pontos: ${s} / ${d}`),e.classList.add("clicked"),s>=d&&t(!0),setTimeout(()=>e.remove(),300)},n.appendChild(e),setTimeout(()=>{e&&e.parentElement&&e.remove()},1500)}function t(e){if(clearInterval(m),clearInterval(c),!!n)if(n.innerHTML="",e)handleGameWin("Acerte o Alvo");else{const e=document.createElement("div");e.innerHTML=`Tempo esgotado! Voc√™ fez ${s} pontos.<br>Tente novamente!`,e.style.fontSize="1.5rem",e.style.textAlign="center",n.appendChild(e),setTimeout(()=>{const e=todosOsJogos.find(e=>"Acerte o Alvo"===e.nome);if(e){const a=document.getElementById("advantage-game-board");a.innerHTML=e.htmlContent,initClickerGame()}},4e3)}}const n=document.getElementById("clicker-game-board"),o=document.getElementById("clicker-score"),r=document.getElementById("clicker-timer"),i=document.getElementById("clicker-start-button"),d=40;let s=0,l=25,m=null,c=null;i&&(i.onclick=e)}function initSimonGame(){function e(){u=!1,m=[],r.textContent=`N√≠vel: ${c}`;const e=Math.floor(4*Math.random());l.push(e),a()}async function a(){await new Promise(e=>setTimeout(e,700));for(let e=0;e<l.length;e++)await t(l[e]),await new Promise(e=>setTimeout(e,200));u=!0,r.textContent="Sua vez!"}function t(e){return new Promise(a=>{const t=document.getElementById(`simon-pad-${e}`);t.classList.add("active"),setTimeout(()=>{t.classList.remove("active"),a()},500)})}function n(a){if(u){const n=parseInt(a.target.dataset.index,10);t(n),m.push(n);const r=m.length-1;return m[r]===l[r]?void(m.length===l.length&&(c>=s?o(!0):(c++,u=!1,setTimeout(e,1e3)))):void o(!1)}}function o(e){u=!1,e?handleGameWin("Sequ\xEAncia de Cores"):(r.textContent="Errado! Tente de novo.",setTimeout(()=>{document.getElementById("simon-game-board").innerHTML=`
                    <div id="simon-info-display">N√≠vel: 1</div>
                    <div id="simon-pads-container">
                        <div class="simon-pad" id="simon-pad-0" data-index="0"></div>
                        <div class="simon-pad" id="simon-pad-1" data-index="1"></div>
                        <div class="simon-pad" id="simon-pad-2" data-index="2"></div>
                        <div class="simon-pad" id="simon-pad-3" data-index="3"></div>
                    </div>
                    <button id="simon-start-button">Iniciar</button>
                `,initSimonGame()},3e3))}const r=document.getElementById("simon-info-display"),i=document.getElementById("simon-start-button"),d=document.querySelectorAll(".simon-pad"),s=8;let l=[],m=[],c=1,u=!1;i.onclick=function(){i.style.display="none",l=[],c=1,e()},d.forEach(e=>e.addEventListener("click",n))}function initTicTacToeGame(){function e(e){e&&(B=e),h=B,f="X"===h?"O":"X",u.classList.add("hidden"),g.classList.remove("hidden"),m.classList.remove("hidden"),y=.5>Math.random(),y?m.textContent=`Sua vez de jogar (${h})`:(m.textContent=`O computador (${f}) come√ßa...`,setTimeout(t,1200))}function a(a){if(!b&&y){const e=parseInt(a.target.dataset.cellIndex);if(null===v[e]){r(e,h);const a=i();return a.isFinished?void d(a):void(y=!1,m.textContent=`Vez do computador (${f})...`,setTimeout(t,700))}}}function t(){if(!b){const e=n();r(e,f);const a=i();return a.isFinished?void d(a):void(y=!0,m.textContent=`Sua vez de jogar (${h})`)}}function n(){for(const e of E){const a=o(e.combo,f);if(-1!==a)return a}for(const e of E){const a=o(e.combo,h);if(-1!==a)return a}if(null===v[4])return 4;const e=[0,2,6,8].filter(e=>null===v[e]);if(0<e.length)return e[Math.floor(Math.random()*e.length)];const a=[1,3,5,7].filter(e=>null===v[e]);return 0<a.length?a[Math.floor(Math.random()*a.length)]:v.findIndex(e=>null===e)}function o(e,a){const t=e.map(e=>v[e]);return 2===t.filter(e=>e===a).length&&t.includes(null)?e[t.indexOf(null)]:-1}function r(e,a){v[e]=a;const t=g.querySelector(`[data-cell-index='${e}']`);t.classList.add(a.toLowerCase())}function i(){for(const e of E){const[t,a,n]=e.combo;if(v[t]&&v[t]===v[a]&&v[t]===v[n])return{isFinished:!0,winner:v[t],lineClass:e.class,winningCombo:e.combo}}return v.every(e=>null!==e)?{isFinished:!0,winner:"tie"}:{isFinished:!1}}function d(e){if(b=!0,e.winner===h)m.textContent="Voc\xEA venceu! \uD83C\uDF89",p.className=`winning-line ${e.lineClass}`,e.winningCombo.forEach(e=>document.querySelector(`[data-cell-index='${e}']`).classList.add("highlight")),handleGameWin("Jogo da Velha");else if(e.winner===f){m.textContent="O computador venceu!",p.className=`winning-line ${e.lineClass}`,e.winningCombo.forEach(e=>document.querySelector(`[data-cell-index='${e}']`).classList.add("highlight"));let a=3;m.textContent=`O computador venceu! Nova rodada em ${a}...`;const t=setInterval(()=>{a--,0<a?m.textContent=`O computador venceu! Nova rodada em ${a}...`:(clearInterval(t),s())},1e3)}else m.textContent="Deu velha! Tente novamente.",c.classList.remove("hidden")}function s(){v.fill(null),b=!1,document.querySelectorAll(".tictactoe-cell").forEach(e=>{e.className="tictactoe-cell"}),p.className="winning-line",c.classList.add("hidden"),e(null)}const l=document.getElementById("tictactoe-board-wrapper"),m=document.getElementById("tictactoe-status"),c=document.getElementById("tictactoe-restart-button"),u=document.getElementById("tictactoe-symbol-selection"),g=document.getElementById("tictactoe-board"),p=document.getElementById("tictactoe-winning-line");let h="X",f="O";const E=[{combo:[0,1,2],class:"line-h-0"},{combo:[3,4,5],class:"line-h-1"},{combo:[6,7,8],class:"line-h-2"},{combo:[0,3,6],class:"line-v-0"},{combo:[1,4,7],class:"line-v-1"},{combo:[2,5,8],class:"line-v-2"},{combo:[0,4,8],class:"line-d-0"},{combo:[2,4,6],class:"line-d-1"}];let v=Array(9).fill(null),y=!0,b=!1,B=null;document.getElementById("select-X").onclick=()=>e("X"),document.getElementById("select-O").onclick=()=>e("O"),document.querySelectorAll(".tictactoe-cell").forEach(e=>e.addEventListener("click",a)),c.addEventListener("click",function(){B=null,v.fill(null),b=!1,y=!0,document.querySelectorAll(".tictactoe-cell").forEach(e=>{e.className="tictactoe-cell"}),p.className="winning-line",c.classList.add("hidden"),g.classList.add("hidden"),m.classList.add("hidden"),u.classList.remove("hidden")})}async function carregarInstrucoes(){try{const e=doc(db,"regras","manual"),a=await getDoc(e);if(a.exists()){const e=a.data(),t=document.querySelector("#secao-instrucoes .secao-conteudo");t.innerHTML=`
          <h1>üìú Manual de Funcionamento e Din√¢micas do Grupo </h1>
          <div class="info-bloco">
            <h2>Lista de Foco</h2>
            <p>${e.Foco.replace(/\n/g,"<br>")}</p>
          </div>
          <div class="info-bloco">
            <h2>Dia de Folga</h2>
            <p>${e.Folga.replace(/\n/g,"<br>")}</p>
          </div>
          <div class="info-bloco">
            <h2>Nomea√ß√£o de L√≠deres</h2>
            <p>${e.Lider.replace(/\n/g,"<br>")}</p>
          </div>
          <div class="info-bloco">
            <h2>Medalhas Individuais</h2>
            <p>${e.Medalhas.replace(/\n/g,"<br>")}</p>
          </div>
          <div class="info-bloco">
            <h2>√Årvore √âpica</h2>
            <p>${e.√Årvore.replace(/\n/g,"<br>")}</p>
          </div>
        `,document.getElementById("secao-instrucoes").classList.remove("hidden")}else mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel encontrar o manual de instru\xE7\xF5es.",4e3)}catch(e){console.error("Erro ao carregar instru\xE7\xF5es:",e),mostrarPopup("\u274C Erro","Falha ao carregar as instru\xE7\xF5es.",4e3)}}async function carregarAdvertencias(){try{const e=doc(db,"regras","conduta"),a=await getDoc(e);if(a.exists()){const e=a.data(),t=document.querySelector("#secao-advertencias .secao-conteudo"),n=e=>`<ul>${e.split("\u2022").filter(e=>""!==e.trim()).map(e=>`<li>${e.trim()}</li>`).join("")}</ul>`;t.innerHTML=`
          <h1>‚ö†Ô∏è C√≥digo de Conduta e Advert√™ncias</h1>
          <div class="advertencia-card leve">
            <h2><span class="emoji">üü¢</span>Advert√™ncia Leve</h2>
            ${n(e.leve)}
          </div>
          <div class="advertencia-card media">
            <h2><span class="emoji">üü°</span>Advert√™ncia M√©dia</h2>
            ${n(e.media)}
          </div>
          <div class="advertencia-card grave">
            <h2><span class="emoji">üî¥</span>Advert√™ncia Grave</h2>
            ${n(e.grave)}
          </div>
          <div class="advertencia-card gravissima">
            <h2><span class="emoji">üü£</span>Advert√™ncia Grav√≠ssima</h2>
            ${n(e.gravissima)}
          </div>
          <div class="advertencia-card expulsao">
            <h2><span class="emoji">‚ö´</span>Expuls√£o</h2>
            ${n(e.expulsao)}
          </div>
        `,document.getElementById("secao-advertencias").classList.remove("hidden")}else mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel encontrar o c\xF3digo de conduta.",4e3)}catch(e){console.error("Erro ao carregar advert\xEAncias:",e),mostrarPopup("\u274C Erro","Falha ao carregar as advert\xEAncias.",4e3)}}function fecharSecoes(){document.getElementById("secao-instrucoes").classList.add("hidden"),document.getElementById("secao-advertencias").classList.add("hidden")}document.getElementById("btn-instrucoes").addEventListener("click",carregarInstrucoes),document.getElementById("btn-advertencias").addEventListener("click",carregarAdvertencias),document.querySelectorAll(".botao-fechar-secao").forEach(e=>{e.addEventListener("click",fecharSecoes)});async function calcularMembrosOciosos(){console.log("Calculando membros ociosos da semana...");const e=getSemanaAtual(new Date(new Date().setDate(new Date().getDate()-2))),a=e.inicio,t=e.fim,n=a.toISOString().slice(0,10),o=t.toISOString().slice(0,10),r=`semana_${e.numero}_${e.inicio.getFullYear()}`,i={};todosMembros.forEach(e=>{"lider"!==e.papel&&(i[e.nome]=0)});try{const e=query(collection(db,"presencas"),where("__name__",">=",n),where("__name__","<=",o)),a=await getDocs(e);a.forEach(e=>{const a=e.data();for(const[t,n]of Object.entries(a))n&&void 0!==i[t]&&i[t]++});const t=Object.entries(i).filter(([e,a])=>4>a).map(([e,a])=>({nome:e,contagem:a})),d=doc(db,"gerenciamentoSemanal",r);await setDoc(d,{ociosos:t,processado:!1}),console.log(`Encontrados ${t.length} membros ociosos. Dados salvos em ${r}.`)}catch(e){console.error("Erro ao calcular membros ociosos:",e)}}async function carregarEExibirMembrosOciosos(){const e=document.getElementById("secao-ociosos");if("lider"!==userRole)return void e.classList.add("hidden");e.classList.remove("hidden");const a=getHoje(),t=0===a.getDay(),n=t?getSemanaAtual(new Date(a.setDate(a.getDate()-1))):getSemanaAtual(),o=`semana_${n.numero}_${n.inicio.getFullYear()}`,r=doc(db,"gerenciamentoSemanal",o),i=document.getElementById("lista-ociosos"),d=document.getElementById("ociosos-descricao");try{const e=await getDoc(r);if(!e.exists()||0===e.data().ociosos.length)return void(i.innerHTML="<div class=\"ociosos-placeholder\">Nenhum membro ocioso encontrado para este per\xEDodo.</div>");const a=e.data().ociosos;i.innerHTML="",t?(d.textContent="A\xE7\xF5es de final de semana: Justifique os membros que apresentaram um motivo v\xE1lido ou expulse os que n\xE3o cumpriram a meta semanal.",a.forEach(e=>{const a=document.createElement("div");a.className="ocioso-item",a.innerHTML=`
                    <div class="ocioso-nome">${e.nome} (${e.contagem}/4 dias)</div>
                    <div class="ocioso-botoes">
                        <button class="ocioso-btn justificar" onclick="justificarMembro('${e.nome}', '${o}')">Justificar</button>
                        <button class="ocioso-btn expulsar" onclick="confirmarExpulsao('${e.nome}')">Expulsar</button>
                    </div>
                `,i.appendChild(a)})):(d.textContent="A lista abaixo mostra os membros que focaram menos de 4 vezes nesta semana (de Segunda a S\xE1bado).",a.forEach(e=>{const a=document.createElement("div");a.className="ocioso-item",a.innerHTML=`<div class="ocioso-nome">${e.nome} (${e.contagem}/4 dias)</div>`,i.appendChild(a)}))}catch(e){console.error("Erro ao carregar lista de ociosos:",e),i.innerHTML="<div class=\"ociosos-placeholder\">Erro ao carregar a lista.</div>"}}async function justificarMembro(e,a){if(!confirm(`Tem certeza que deseja justificar e remover '${e}' da lista de ociosos desta semana?`))return;const t=doc(db,"gerenciamentoSemanal",a);try{await runTransaction(db,async a=>{const n=await a.get(t);if(!n.exists())return;const o=n.data().ociosos,r=o.filter(a=>a.nome!==e);a.update(t,{ociosos:r})}),mostrarPopup("\u2705 Sucesso",`${e} foi justificado e removido da lista.`,4e3),await carregarEExibirMembrosOciosos()}catch(e){console.error("Erro ao justificar membro:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel processar a justiticativa.",4e3)}}function confirmarExpulsao(e){membroParaExpulsar=e,document.getElementById("member-to-expel-name").innerText=e,document.getElementById("confirm-expel-button").onclick=executarExpulsao,openModal("confirm-expel-modal")}async function executarExpulsao(){if(membroParaExpulsar){const e=membroParaExpulsar;console.log(`Iniciando processo de expuls√£o para: ${e}`);try{await deleteDoc(doc(db,"membros",e));const a=doc(collection(db,"logEventos"));await setDoc(a,{tipo:"membro_removido",nomeMembro:e,data:getHojeISO()}),mostrarPopup("\uD83D\uDDD1\uFE0F Membro Expulso",`${e} foi removido permanentemente do sistema.`,5e3),membroParaExpulsar=null,closeModal("confirm-expel-modal"),await refreshAppUI()}catch(a){console.error(`Erro ao expulsar ${e}:`,a),mostrarPopup("\u274C Falha Grave",`Ocorreu um erro ao tentar expulsar ${e}.`,5e3)}}}
