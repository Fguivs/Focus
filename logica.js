import{initializeApp}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";import{getFirestore,doc,setDoc,getDoc,collection,getDocs,updateDoc,deleteDoc,increment,writeBatch,query,where,onSnapshot,runTransaction,deleteField,orderBy,arrayUnion,addDoc,limit,serverTimestamp}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";import{GoogleGenerativeAI}from"https://esm.run/@google/generative-ai";const firebaseConfig={apiKey:"AIzaSyDoncRn8ikIdij8aXC0OUeqdqnLITrhmPc",authDomain:"foco-diario-75630.firebaseapp.com",projectId:"foco-diario-75630",storageBucket:"foco-diario-75630.appspot.com",messagingSenderId:"1040579676771",appId:"1:1040579676771:web:ca12f964d8adb3778e4656"},firebaseConfigDesenho={apiKey:"AIzaSyBJtGxAHVeTJXLU_mwNaAUZ69ZsjCwge9I",authDomain:"focus-2-449a5.firebaseapp.com",projectId:"focus-2-449a5",storageBucket:"focus-2-449a5.firebasestorage.app",messagingSenderId:"739829913615",appId:"1:739829913615:web:562c3e94f641dd474d2b7a",measurementId:"G-YTNY4RCKSS"},app=initializeApp(firebaseConfig),db=getFirestore(app),appDesenho=initializeApp(firebaseConfigDesenho,"appDesenho"),dbDesenho=getFirestore(appDesenho),firebaseConfigEssencial={apiKey:"AIzaSyAHJLdecP8RvroI4_lUhwdXfMqCyiTTCX4",authDomain:"focusessecial.firebaseapp.com",projectId:"focusessecial",storageBucket:"focusessecial.firebasestorage.app",messagingSenderId:"399366454653",appId:"1:399366454653:web:df98e66ad7ba7b07012014",measurementId:"G-60J4C2HR9F"},appEssencial=initializeApp(firebaseConfigEssencial,"appEssencial"),dbEssencial=getFirestore(appEssencial);window.listenersAtivos={};let modoEconomiaAtivo=!1,todasMedalhasHonra=[],medalhasInventarioCache={},medalhasOrdemCache={},medalhasDesejadasCache={},fluxoNotificacaoFoco=!1,numerosSelecionadosAposta=[],dadosLoteria={premioAcumulado:0,edicao:0,ano:2025,totalApostas:0,historico:[]},minhasApostasEdicao=0,dadosApostasUsuarioCarregados=!1;const CUSTO_APOSTA=100,LIMITE_APOSTAS_POR_EDICAO=6;let mapaEpicos=null,marcadoresMapa=[],timeOffset=null,carrosselMedalhasPausado=!1,currentCarrosselMedalhasIndex=0,totalSlidesMedalhas=0,todosPoderesInfo=[],statusPoderesAtivos=[],historicoPoderesSemana={},poderParaComprar=null,equipeAlvoParaPoder=null,comprandoPoder=!1,temasManuaisCache=[],carrosselMedalhasInterval,progressoBarraMedalhas;window.tempoEsperaRecompensa=30;let timerRecompensaInterval=null;function iniciarTimerRecompensa(){return timerRecompensaInterval&&clearInterval(timerRecompensaInterval),void(window.tempoEsperaRecompensa=0)}const NIVEIS_RECOMPENSA=[{min:0,max:9,valor:50,cor:"#3498db",textoCor:"#fff"},{min:10,max:19,valor:100,cor:"#2ecc71",textoCor:"#fff"},{min:20,max:29,valor:200,cor:"#f1c40f",textoCor:"#333"},{min:30,max:39,valor:300,cor:"#e67e22",textoCor:"#fff"},{min:40,max:49,valor:400,cor:"#e74c3c",textoCor:"#fff"},{min:50,max:59,valor:500,cor:"#9b59b6",textoCor:"#fff"},{min:60,max:69,valor:600,cor:"#ff7979",textoCor:"#fff"},{min:70,max:79,valor:700,cor:"#00cec9",textoCor:"#fff"},{min:80,max:89,valor:800,cor:"#006400",textoCor:"#fff"},{min:90,max:99,valor:900,cor:"#000000",textoCor:"#fff"},{min:100,max:99999,valor:1e3,cor:"#ff007f",textoCor:"#fff"}];function getNivelRecompensa(e){const a=NIVEIS_RECOMPENSA.find(a=>e>=a.min&&e<=a.max);return a||NIVEIS_RECOMPENSA[0]}let dailyStreakGlobal=0,dailyClaimedToday=!1,hallDaFamaCache=[],carrosselHallDaFamaPausado=!1,currentCarrosselHallDaFamaIndex=0,totalSlidesHallDaFama=0,carrosselHallDaFamaInterval,progressoBarraHallDaFama;const ANO_ATUAL=new Date().getFullYear();let saldosBancosEquipes={abelha:0,joaninha:0,vagalume:0},unsubscribeBancosListener=null,estatisticasJurosCache=[],estatisticasContribuidoresCache={},carrosseisInternosMedalhasState={},membroParaOrdenarMedalhas=null,ordemMedalhasTemporaria=[],medalhaParaComprarInfo=null,membroParaReceberMedalha=null;const MEDALHAS_POR_PAGINA=6;Date.prototype.getBrasiliaHours=function(){const e=this.toLocaleString("en-US",{timeZone:"America/Sao_Paulo"}),a=new Date(e);return a.getHours()};let streaksCache={},todosMembros=[],equipes={abelha:{membros:[],lider:null},joaninha:{membros:[],lider:null},vagalume:{membros:[],lider:null}},liderGeral=null;const nomesEquipesCapitalizados={abelha:"Abelha",joaninha:"Joaninha",vagalume:"Vaga-lume"};let currentUser=null,userRole=null,userTeam=null,analiseOraculoPendente=null,carrosselDesenhoPausado=!1,currentCarrosselDesenhoIndex=0,activeDrawingTeam=null,desenhoModificado=!1,renderizacaoCompleta=!1,drawingContexts={},pixDestinatarios=[],pixValor=0,pixComentario="",enviosDiariosRealizados={},baseDeConhecimentoTexto="",historicoConversaIA=[],feedEventosCache=[],listaChavesGlobal=[],indiceChaveAtual=0,enviandoMoedas=!1,aguardandoConfirmacaoNotificacao=!1,dadosNotificacaoPendente=null,currentCarrosselIndex=0,carrosselPausado=!1,maintenanceClickCount=0,maintenanceClickTimer=null,totalSlides=0,isUpdatingTop5Feed=!1,membroParaExpulsar=null,isPasswordResetFlow=!1,recompensasConfig={},isTestModeActive=!1,currentTestGameIndex=null,ordemJogosConfigurada=[],carrosselDesenhoInterval,progressoBarraDesenho,genAI,carrosselInterval,progressoBarra;const medalhas={3:{emoji:"\uD83D\uDD25",nome:"Fagulha"},10:{emoji:"\uD83D\uDC51",nome:"Lenda"},30:{emoji:"\uD83C\uDF1F",nome:"Constante"},60:{emoji:"\uD83D\uDC8E",nome:"Diamante"},120:{emoji:"\uD83D\uDE80",nome:"Foguete"},150:{emoji:"\uD83C\uDFC6",nome:"Trof\xE9u"},240:{emoji:"\uD83D\uDD2E",nome:"Bola de cristal"},365:{emoji:"\uD83C\uDF1E",nome:"Solar"},550:{emoji:"\uD83D\uDC09",nome:"M\xEDtico"},730:{emoji:"\uD83C\uDF83",nome:"Horripilante"},900:{emoji:"\uD83D\uDCA3",nome:"Poder Destrutivo"},1100:{emoji:"\uD83D\uDE07",nome:"Angelical"},1460:{emoji:"\uD83D\uDCA0",nome:"Primordial"},1825:{emoji:"\u267E\uFE0F",nome:"Eterno"}},totalDiasMembros={},pontosSemanais={abelha:0,joaninha:0,vagalume:0},rankingGeral={abelha:0,joaninha:0,vagalume:0},historicoAcoes={};let atualizando=!1,dataAtual="",filaAtualizacao=Promise.resolve(),popupQueue=[],isPopupShowing=!1,unsubscribeNotificacoes=null,unsubscribeDadosPessoais=null,cardPopupQueue=[],isCardPopupShowing=!1,cliqueCount=0,initialDistance=null,isPinching=!1,composerSelectedColor="#CAFFBF",composerTimestampInterval=null,composerEditMode=!1,editingMessageId=null,messageIdToDelete=null,unsubscribeViewerListener=null,isMentioning=!1,mentionQuery="",mentionStartIndex=-1,activeSuggestionIndex=-1,mentionTextarea=null,currentMentionRange=null,todosOsItensAvatar=[],inventarioAvatarCache=[],avatarTemporario={},avatarOriginal={},unsubscribeAvatarListener=null,timeoutClique;const nomesCategorias={corpo:"Tons de peles",rosto:"Express\xF5es",cabelo:"Cabelos",roupa:"Roupas",acessorio:"Acess\xF3rios",enfeite_de_parede:"Itens Raros e Exclusivos",fundo:"Fundos"},nomesSubcategorias={chapeu:"Chap\xE9u",oculos:"\xD3culos",colar:"Acess\xF3rio de pesco\xE7o",bolsa:"Bolsa",outros:"Outros"};let editingCommentId=null,commentIdToDelete=null,messageIdForCommentAction=null,checkboxLocks={},folgasManualmenteRemovidas={},currentUserRole="membro",currentUserTeam=null,memberIdToRemove=null,lastRefreshTimestamp=null,officialAppVersion=null,authContainer,mainContent,logoutBtn,loginForm,changePasswordForm,forgotPasswordForm,secretQuestionForm,loginBtn,loginUsernameInput,loginPasswordInput;const EMOJIS_MURAL=["\uD83D\uDC4D","\uD83D\uDC96","\uD83D\uDE02","\uD83C\uDF89","\uD83D\uDD25","\uD83D\uDE2E","\uD83D\uDE2D","\uD83D\uDE21"];function getHoje(){if(null===timeOffset)return new Date;const e=Date.now(),a=e+timeOffset;return new Date(a)}async function sincronizarHorarioBrasilia(){console.log("\u23F3 Sincronizando rel\xF3gio via Servidor Google (Firestore)...");try{const e=doc(db,"temp_sync",currentUser||"anonimo_sync");await setDoc(e,{timestamp:serverTimestamp()});const a=await getDoc(e);if(a.exists()&&a.data().timestamp){const o=a.data().timestamp.toDate().getTime(),t=Date.now();timeOffset=o-t,console.log(`‚úÖ Rel√≥gio Sincronizado! Server: ${new Date(o).toLocaleTimeString()} | Offset: ${timeOffset}ms`),deleteDoc(e).catch(()=>{})}else throw new Error("Timestamp vazio.")}catch(e){throw console.error("\u274C FALHA CR\xCDTICA DE SINCRONIZA\xC7\xC3O:",e),timeOffset=null,alert("\u26A0\uFE0F Erro de Sincroniza\xE7\xE3o de Hora!\n\nO sistema n\xE3o conseguiu confirmar o hor\xE1rio oficial com o servidor.\n\nPor favor, verifique sua internet e recarregue a p\xE1gina."),location.reload(),"SyncFailed"}}function getHojeISO(){const e=getHoje(),a=e.getFullYear(),o=(e.getMonth()+1+"").padStart(2,"0"),t=(e.getDate()+"").padStart(2,"0");return`${a}-${o}-${t}`}function formatarData(e){const a=(e.getDate()+"").padStart(2,"0"),o=(e.getMonth()+1+"").padStart(2,"0"),t=e.getFullYear();return`${a}/${o}/${t}`}function getDiaSemanaString(e=new Date){return["domingo","segunda-feira","ter\xE7a-feira","quarta-feira","quinta-feira","sexta-feira","s\xE1bado"][e.getDay()]}const diaParaIndice={domingo:0,dom:0,segunda:1,seg:1,ter√ßa:2,terca:2,ter:2,quarta:3,qua:3,quinta:4,qui:4,sexta:5,sex:5,s√°bado:6,sabado:6,sab:6};function getSemanaAtual(e=null){let a=e||getHoje();a=new Date(a.valueOf()),a.setHours(0,0,0,0);const o=(a.getDay()+6)%7,t=new Date(a);t.setDate(a.getDate()-o+3);const n=t.getFullYear(),i=new Date(n,0,1),r=(i.getDay()+6)%7,d=new Date(i);d.setDate(i.getDate()-r+3);const s=Math.round((t-d)/864e5/7)+1,l=new Date(a),m=l.getDay();let c=m-1;0===m&&(c=6);const u=new Date(l);u.setDate(l.getDate()-c);const p=new Date(u);return p.setDate(u.getDate()+5),{inicio:u,fim:p,numero:s,inicioFormatado:formatarData(u),fimFormatado:formatarData(p),fimCompeticao:formatarData(p).slice(0,5)}}function getFimDaSemanaAtual(){const e=getSemanaAtual(),a=new Date(e.fim);return a.setHours(23,59,59,999),a}function getFimDaProximaSemana(){const e=getFimDaSemanaAtual(),a=new Date(e.getTime());return a.setDate(a.getDate()+7),a}function formatarTempoRestante(e){if(0>=e)return"Liberado!";const a=Math.floor(e/1e3%60),o=Math.floor(e/1e3/60%60),t=Math.floor(e/3600000%24),n=Math.floor(e/86400000);let i="Libera em: ";return 0<n&&(i+=`${n}d `),0<t&&(i+=`${t}h `),0<o&&(i+=`${o}m `),0===n&&0===t&&0===o&&(i+=`${a}s`),i.trim()}let intervaloGlobalLoja=null;function iniciarGerenciadorDeTimers(){intervaloGlobalLoja&&clearInterval(intervaloGlobalLoja),intervaloGlobalLoja=setInterval(()=>{const e=document.querySelectorAll(".timer-ativo");if(0===e.length)return;const a=new Date().getTime();e.forEach(e=>{const o=parseInt(e.dataset.deadline,10);if(o){const t=o-a;0>=t?(e.textContent="Liberado!",e.classList.remove("timer-ativo")):e.textContent=formatarTempoRestante(t)}})},1e3)}async function carregarPresenca(){const e=getHojeISO(),a=await getDoc(doc(dbEssencial,"presencas",e));if(a.exists()){const e=a.data();todosMembros.forEach(a=>{const o=a.nome,t=document.getElementById(o);t&&e[o]&&(t.checked=!0)})}}async function carregarPontosSemanais(){const e=getHoje(),a=doc(dbEssencial,"semanas","pontosSemanais"),o=await getDoc(a);if(o.exists()){const e=o.data();pontosSemanais.abelha=e.abelha||0,pontosSemanais.joaninha=e.joaninha||0,pontosSemanais.vagalume=e.vagalume||0}else 0!==e.getDay()&&(await setDoc(a,{abelha:0,joaninha:0,vagalume:0})),pontosSemanais.abelha=0,pontosSemanais.joaninha=0,pontosSemanais.vagalume=0}async function carregarRankingGeral(){const e=await getDoc(doc(db,"ranking","geral"));if(e.exists()){const a=e.data();rankingGeral.abelha=a.abelha||0,rankingGeral.joaninha=a.joaninha||0,rankingGeral.vagalume=a.vagalume||0}atualizarRankingGeral()}function usuarioAceitaPopups(){if(!currentUser)return!0;const e=todosMembros.find(e=>e.nome===currentUser);return!(e&&e.preferencias&&void 0!==e.preferencias.popups)||e.preferencias.popups}async function salvarPreferenciaPopups(e){if(!currentUser)return;const a="ativado"===e,o=doc(db,"membros",currentUser);try{await updateDoc(o,{"preferencias.popups":a});const e=todosMembros.findIndex(e=>e.nome===currentUser);-1!==e&&(!todosMembros[e].preferencias&&(todosMembros[e].preferencias={}),todosMembros[e].preferencias.popups=a,localStorage.setItem("epicos_cache_membros",JSON.stringify(todosMembros)));const t=document.getElementById("user-pref-popups");t&&(t.style.borderColor="#2ecc71",setTimeout(()=>t.style.borderColor="#ddd",1e3)),console.log(`Prefer√™ncia de popups salva: ${a}`)}catch(e){console.error("Erro ao salvar prefer\xEAncia:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel salvar sua prefer\xEAncia.",3e3)}}window.salvarPreferenciaPopups=salvarPreferenciaPopups,window.usuarioAceitaPopups=usuarioAceitaPopups;async function finalizarSemana(){await carregarDadosEssenciais();const e=getHoje();if(6===e.getDay()){try{const e=getSemanaAtual(),a=`semana_${e.numero}_${e.inicio.getFullYear()}`,o=doc(db,"vantagemSemanal",a),t=await getDoc(o);if(t.exists()&&t.data().palavraDaSemana){const e=t.data().palavraDaSemana.id;e&&(await deleteDoc(doc(db,"jogoDaForca",e)))}}catch(e){console.error("Erro ao deletar palavra da forca da semana:",e)}const e=getSemanaAtual(),a=`semana_${e.numero}_${e.inicio.getFullYear()}`,o=doc(db,"vantagemSemanal",a);let t=!1,n=[],i={};try{if(await runTransaction(db,async e=>{const a=await e.get(o);if(a.exists()&&a.data().bonusAplicado)return;let r=!1;const d=a.exists()?a.data().completadoPor||{}:{},s=new Set(Object.keys(d)),l=[];for(const a in equipes){const e=equipes[a];if(0<e.membros.length){const o=e.membros.filter(e=>!e.deFerias).every(e=>s.has(e.nome));o&&(r=!0,l.push(a))}}r&&(e.set(o,{bonusAplicado:!0,equipesComBonus:l},{merge:!0}),t=!0,n=l,i=d)}),t){const e=i,a={1:recompensasConfig.top5Vantagem_1||50,2:recompensasConfig.top5Vantagem_2||40,3:recompensasConfig.top5Vantagem_3||30,4:recompensasConfig.top5Vantagem_4||20,5:recompensasConfig.top5Vantagem_5||10},o=Object.entries(e).map(([e,a])=>({nome:e,tempo:a.toDate().getTime()})).sort((e,a)=>e.tempo-a.tempo).slice(0,5);if(0<o.length){const e=writeBatch(dbEssencial);o.forEach((o,t)=>{const n=a[t+1];n&&(e.update(doc(dbEssencial,"membros_essencial",o.nome),{moedas:increment(n)}),o.nome===currentUser&&mostrarPopupMoedas(n))}),await e.commit()}mostrarPopup("\u2728 B\xF4nus Garantido!","As equipes que completaram o desafio garantiram o b\xF4nus para a m\xE9dia final!",6e3);const t=n;let r;if(0<t.length){const e=t.map(a=>`<strong>Equipe ${a.charAt(0).toUpperCase()+a.slice(1)}</strong>`).join(", "),a=1<t.length?"completaram":"completou",o=1<t.length?"garantiram":"garantiu";r=`Parab√©ns! ${e} ${a} o Jogo da Vantagem e ${o} um b√¥nus em sua m√©dia final no domingo!`}else r=`O Jogo da Vantagem foi finalizado, mas nenhuma equipe cumpriu o requisito do b√¥nus esta semana.`;await adicionarEventoAoFeed("vantagem","\u2728 B\xF4nus do Jogo da Vantagem!",r)}}catch(e){console.error("Erro na finaliza\xE7\xE3o do Jogo da Vantagem:",e)}}if(0===e.getDay()&&0<=e.getBrasiliaHours()){const a=await getDoc(doc(db,"appState","globalLock")),o=a.exists()&&a.data().isLocked;o||(await setGlobalLock(!0,"\uD83C\uDFC6 Finalizando Competi\xE7\xE3o: Calculando vencedores..."));try{const a=new Date(e),o=getSemanaAtual(new Date(a.setDate(a.getDate()-1))),t=`semana_${o.numero}_${o.inicio.getFullYear()}`,n=doc(db,"resultadosCompeticao",t);let i=!1;try{await runTransaction(db,async e=>{const a=await e.get(n);if(a.exists())throw"ALREADY_PROCESSED";e.set(n,{status:"processando",iniciadoEm:serverTimestamp()})}),i=!0}catch(a){"ALREADY_PROCESSED"!==a&&console.error("Erro ao tentar travar semana:",a)}if(!i){console.log(`‚úÖ Finaliza√ß√£o da semana ${t} j√° foi iniciada por outra inst√¢ncia. Saindo.`);doc(dbEssencial,"semanas","pontosSemanais");return pontosSemanais.abelha=0,pontosSemanais.joaninha=0,pontosSemanais.vagalume=0,void atualizarPlacarSemanal()}const r=doc(dbEssencial,"semanas","pontosSemanais"),d=await getDoc(r);if(d.exists()&&0<Object.keys(d.data()).length){const e=d.data(),a={};todosMembros.forEach(e=>{a[e.nome]={nome:e.nome,equipe:e.equipe,pontuacao:{foco:0,vantagem:0,total:0},meChamo:e["me chamo"]||e.nome,deFerias:e.deFerias||!1,motivoAusencia:e.motivoAusencia||null,tempoTotal:0}});const i=formatarDataISO(o.inicio),s=formatarDataISO(o.fim),l=query(collection(dbEssencial,"presencas"),where("__name__",">=",i),where("__name__","<=",s)),m=await getDocs(l);m.forEach(e=>{const o=e.data();for(const t in o)o[t]&&a[t]&&(a[t].pontuacao.foco++,a[t].pontuacao.total++,o[t].toDate&&(a[t].tempoTotal+=o[t].toDate().getTime()))});const c=doc(db,"vantagemSemanal",t),u=await getDoc(c),p=3,g=u.exists()?u.data().equipesComBonus||[]:[];if(u.exists()){const e=u.data().completadoPor||{};for(const o in e)a[o]&&(a[o].pontuacao.vantagem+=p,a[o].pontuacao.total+=p)}const f=u.exists()?u.data().deducoesPoderes||{}:{},h=u.exists()?u.data().adicoesPoderes||{}:{},v=u.exists()?u.data().ajustesManuais||{}:{};console.log("Calculando vencedor da semana com M\xC9DIA NIVELADA...");const E={},y=["abelha","joaninha","vagalume"],b=[];let I=1/0;if(y.forEach(e=>{const a=equipes[e]?.membros.filter(e=>!e.deFerias)||[],o=a.length;0<o&&(b.push(e),o<I&&(I=o))}),I===1/0&&(I=0),y.forEach(e=>{const o=equipes[e]?.membros.filter(e=>!e.deFerias)||[],t=o.length;if(0===t)return void(E[e]=0);const n=o.map(e=>a[e.nome]?.pontuacao.foco||0);n.sort((e,a)=>e-a);const i=t-I;let r=[...n];0<i&&(r=n.slice(i));const d=r.reduce((e,a)=>e+a,0),s=r.length;let l=0<s?d/s:0;if(g.includes(e)&&(l+=p),h[e]&&0<h[e].length){const a=h[e].reduce((e,a)=>e+(a.valor||0),0);l+=a}if(f[e]&&0<f[e].length){const a=f[e].reduce((e,a)=>e+(a.valor||0),0);l+=a}E[e]=l}),0===b.length)return await adicionarEventoAoFeed("vitoria","\uD83C\uDF34 Competi\xE7\xE3o Suspensa","Todos os membros ativos est\xE3o de f\xE9rias."),await deleteDoc(r),pontosSemanais.abelha=0,pontosSemanais.joaninha=0,pontosSemanais.vagalume=0,void atualizarPlacarSemanal();if(1===b.length){const a=b[0];if(0<e[a]){const e=E[a].toFixed(2),o=a.charAt(0).toUpperCase()+a.slice(1);await updateDoc(doc(db,"ranking","geral"),{[a]:increment(1)}),rankingGeral[a]++,atualizarRankingGeral(),mostrarPopup("\uD83C\uDFC6 Vit\xF3ria Semanal",`Equipe ${o} venceu a semana com uma m√©dia de ${e} pontos!`,8e3),await adicionarEventoAoFeed("vitoria","\uD83C\uDFC6 Temos uma Campe\xE3 Semanal!",`A equipe <strong>${o}</strong> venceu competindo sozinha com uma m√©dia de <strong>${e}</strong> pontos.`,{vencedoras:[a]});const t=writeBatch(dbEssencial);equipes[a].membros.forEach(e=>{e.deFerias||t.update(doc(dbEssencial,"membros_essencial",e.nome),{moedas:increment(recompensasConfig.vitoriaSemanal||500)})}),await t.commit();const n=doc(db,"bancosEquipes",a);await setDoc(n,{saldo:increment(1e5)},{merge:!0});const i=doc(collection(db,"bancosEquipes",a,"movimentacoes"));await setDoc(i,{tipo:"premio",valor:1e5,descricao:"Pr\xEAmio da Competi\xE7\xE3o Semanal",timestamp:new Date}),await adicionarEventoAoFeed("vitoria","\uD83D\uDCB0 Recompensa de Campe\xE3o!",`Como recompensa, cada membro ativo da equipe <strong>${o}</strong> recebeu <strong>${recompensasConfig.vitoriaSemanal||500} üí∞ moedas</strong>!`)}else await adicionarEventoAoFeed("vitoria","\uD83C\uDFC1 Semana sem Vencedor","A \xFAnica equipe ativa n\xE3o marcou pontos.");return await calcularMembrosOciosos(),await deleteDoc(r),pontosSemanais.abelha=0,pontosSemanais.joaninha=0,pontosSemanais.vagalume=0,void atualizarPlacarSemanal()}const C=Object.entries(E).filter(([e])=>b.includes(e)).map(([e,a])=>({equipe:e,media:a})).sort((e,a)=>a.media-e.media),x={};let B=1;for(let e=0;e<C.length;e++)0<e&&C[e].media<C[e-1].media&&B++,x[C[e].equipe]=B;const A=collection(db,"historicoPoderes"),q=query(A,where("semana","==",o.numero)),S=await getDocs(q),D={abelha:[],joaninha:[],vagalume:[]},T={pocao_sextagem:"\uD83C\uDF7A Po\xE7\xE3o da Sextagem",praga_kriptonita:"\uD83E\uDD22 Praga de Kriptonita",maldicao_pilantragem:"\uD83D\uDC80 Maldi\xE7\xE3o da Pilantragem",elixir_vida:"\uD83D\uDC96 Elixir de Vida",runa_soft_block:"\uD83D\uDD12 Runa do Soft Block",amuleto_protecao:"\uD83D\uDEE1\uFE0F Amuleto de Prote\xE7\xE3o",amuleto_falha:"\u274C Falha de Magia"};S.forEach(e=>{const a=e.data(),t=a.timestamp.toDate().getFullYear();if(t===o.inicio.getFullYear()&&D[a.equipe]){const e=T[a.poderId]||a.poderId;D[a.equipe].push({nomePoder:e,poderId:a.poderId,alvo:a.alvo,timestamp:a.timestamp})}});const F={pontosEquipes:e,mediaEquipes:E,rankingEquipes:x,detalhesMembros:a,ajustesManuais:v,deducoesPoderes:f,adicoesPoderes:h,historicoCompletoPoderes:D,timestamp:new Date},k=await gerarResumoSemanalComIA(F,o);F.analiseOraculo=k,await updateDoc(n,{...F,status:"concluido"});let M=-1;for(const e of b)E[e]>M&&(M=E[e]);const N=[];if(0<M)for(const e of b).001>Math.abs(E[e]-M)&&N.push(e);const j=1<N.length;if(0<N.length){const e=doc(db,"ranking","geral"),a={};N.forEach(e=>{a[e]=increment(1),rankingGeral[e]++}),await updateDoc(e,a),atualizarRankingGeral();const o={abelha:"Abelha",joaninha:"Joaninha",vagalume:"Vaga-lume"},t=N.map(e=>o[e]).join(" e "),n=`com uma m√©dia de ${M.toFixed(2)} pontos por membro!`,i=`com uma incr√≠vel m√©dia de <strong>${M.toFixed(2)}</strong> pontos por membro.`;j?(mostrarPopup("\uD83C\uDFC6 Empate Semanal",`As equipes ${t} empataram ${n}`,8e3),await adicionarEventoAoFeed("vitoria","\uD83C\uDFC6 Empate na Competi\xE7\xE3o Semanal!",`Que disputa acirrada! As equipes <strong>${t}</strong> empataram ${i}`,{vencedoras:N})):(mostrarPopup("\uD83C\uDFC6 Vit\xF3ria Semanal",`Equipe ${t} venceu a semana ${n}`,8e3),await adicionarEventoAoFeed("vitoria","\uD83C\uDFC6 Temos uma Campe\xE3 Semanal!",`A equipe <strong>${t}</strong> venceu ${i}`,{vencedoras:N}));const r=writeBatch(dbEssencial);N.forEach(e=>{equipes[e].membros.forEach(e=>{e.deFerias||r.update(doc(dbEssencial,"membros_essencial",e.nome),{moedas:increment(recompensasConfig.vitoriaSemanal||500)})})}),await r.commit();const d=writeBatch(db),s=new Date;N.forEach(e=>{const a=doc(db,"bancosEquipes",e);d.set(a,{saldo:increment(1e5)},{merge:!0});const o=doc(collection(db,"bancosEquipes",e,"movimentacoes"));d.set(o,{tipo:"premio",valor:1e5,descricao:"Pr\xEAmio da Competi\xE7\xE3o Semanal",timestamp:s})}),await d.commit();const l=N.map(e=>e.charAt(0).toUpperCase()+e.slice(1)),m=`Al√©m disso, o <strong>Banco da(s) Equipe(s) ${l.join(" e ")}</strong> recebeu um b√¥nus de <strong>100.000 üí∞ moedas</strong>!`;await adicionarEventoAoFeed("vitoria","\uD83C\uDFE6 B\xF4nus para o Banco!",m);const c=`Como recompensa, cada membro ativo da(s) equipe(s) <strong>${nomesEquipesCapitalizados.join(" e ")}</strong> recebeu <strong>${recompensasConfig.vitoriaSemanal||500} üí∞ moedas</strong>!`;await adicionarEventoAoFeed("vitoria","\uD83D\uDCB0 Recompensa de Campe\xE3o!",c)}await calcularMembrosOciosos(),await deleteDoc(r),pontosSemanais.abelha=0,pontosSemanais.joaninha=0,pontosSemanais.vagalume=0,atualizarPlacarSemanal()}}catch(a){console.error("Erro na finaliza\xE7\xE3o da semana:",a)}finally{o||(await setGlobalLock(!1))}}}async function setGlobalLock(e,a="Executando manuten\xE7\xE3o..."){return console.log("SetGlobalLock chamado (desativado):",e,a),Promise.resolve()}function configurarOuvinteSincronizacaoGlobal(){}async function gerarResumoSemanalComIA(e,a){if(!genAI)return void console.warn("IA n\xE3o inicializada. Pulando resumo semanal do Or\xE1culo.");let o="";try{const e=a.inicio.getFullYear(),t=doc(db,"hallDaFama",e+""),n=await getDoc(t);if(n.exists()&&52<=a.numero){const a=n.data(),t=a.vencedora||[],i=t.map(e=>"vagalume"===e.toLowerCase()?"Vaga-lume":e.charAt(0).toUpperCase()+e.slice(1)).join(" e ");o=`
          üö® ALERTA DE EVENTO HIST√ìRICO - FIM DE TEMPORADA!
          A Temporada ${e} chegou ao fim hoje.
          A GRANDE CAMPE√É DO ANO √â A EQUIPE: ${i.toUpperCase()}!
          (Com um total de ${a.vitorias} vit√≥rias acumuladas no ano).
          
          INSTRU√á√ÉO OBRIGAT√ìRIA: Voc√™ DEVE dedicar um par√°grafo exclusivo e emocionado para parabenizar a equipe ${i} por essa conquista hist√≥rica anual. Diga que o nome deles ficar√° gravado no Hall da Fama dos √âpicos para sempre.
          `}}catch(a){console.error("Erro ao buscar dados da temporada para o Or\xE1culo:",a)}const{mediaEquipes:t,rankingEquipes:n,detalhesMembros:i={},adicoesPoderes:r={},deducoesPoderes:d={}}=e,s=Object.entries(n).filter(([,e])=>1===e).map(([e])=>e);let l="";if(1<s.length){const e=s.map(a=>a.charAt(0).toUpperCase()+a.slice(1)).join(" e ");l=`Houve um belo empate entre as equipes ${e}.`}else if(1===s.length){const e=s[0].charAt(0).toUpperCase()+s[0].slice(1);l=`A equipe vencedora foi a ${e}.`}else l="N\xE3o tivemos um vencedor claro esta semana, mas o esfor\xE7o de todos foi not\xE1vel.";const m=Object.entries(t).map(([e,a])=>`- Equipe ${e.charAt(0).toUpperCase()+e.slice(1)}: M√©dia de ${a.toFixed(2)} pontos.`).join("\n"),c=Object.values(i).filter(e=>!e.deFerias).sort((e,a)=>{if(a.pontuacao.total!==e.pontuacao.total)return a.pontuacao.total-e.pontuacao.total;const o=e.tempoTotal||1/0,t=a.tempoTotal||1/0;return o-t}).slice(0,5).map((e,a)=>`${a+1}¬∫: ${e.nome} (G√™nero: ${e.genero||"Indefinido"}, Nome Real: ${e.meChamo}, ${e.pontuacao.total} pontos)`).join("\n"),u=Object.values(i).filter(e=>e.deFerias&&"saude"===e.motivoAusencia).map(e=>e.nome),p=0<u.length?u.join(", "):"Ningu\xE9m.";let g="Nenhum evento importante registrado ainda.",f=[],h=[];try{const e=a.inicio,o=new Date(a.fim.getTime()+86399000),t=query(collection(db,"resumoSemanalFeed"),where("timestamp",">=",e),where("timestamp","<=",o),orderBy("timestamp","asc")),n=await getDocs(t);n.empty||(g=n.docs.map(e=>{const a=e.data();if(a.titulo&&a.titulo.includes("Feliz Anivers\xE1rio")){const e=a.nomeMembro||a.titulo.replace("\uD83C\uDF82 Feliz Anivers\xE1rio, ","").replace("!","");e&&f.push(e)}if(a.titulo&&(a.titulo.includes("Bem-vindo")||a.titulo.includes("Bem-vinda"))){let e=a.nomeMembro;if(!e&&a.texto){const o=a.texto.match(/bem-vind[oa], (.+?)(!|\.)/);o&&o[1]&&(e=o[1].trim())}e&&h.push(e)}const o=a.texto.replace(/<[^>]*>/g," ").replace(/\s+/g," ").trim();return`- ${a.titulo}: ${o}`}).join("\n"))}catch(e){console.error("Or\xE1culo: Erro ao buscar hist\xF3rico completo do feed:",e),feedEventosCache&&0<feedEventosCache.length&&(g=feedEventosCache.map(a=>`- ${a.titulo}: ${a.texto}`).join("\n"))}let v="N\xE3o houve sorteio registrado nesta semana.";if(dadosLoteria&&dadosLoteria.historico&&0<dadosLoteria.historico.length){const e=dadosLoteria.historico[dadosLoteria.historico.length-1],a=new Date(1e3*e.data.seconds),o=new Date().getTime()-a.getTime();604800000>o&&(e.ganhadores&&0<e.ganhadores.length?v=`LOTERIA √âPICA: Tivemos ganhadores! Parab√©ns a ${e.ganhadores.join(", ")} que dividiram o pr√™mio de ${e.premio} moedas!`:v=`LOTERIA √âPICA: O pr√™mio acumulou! Ningu√©m acertou os n√∫meros. Incentive o grupo a continuar tentando na pr√≥xima.`)}let E="N\xE3o houve Batalha de Desenhos registrada ou processada esta semana.";try{const e=`desenho_sem_${a.numero}_${a.inicio.getFullYear()}`,o=doc(dbDesenho,"resultadosDesenho",e),t=await getDoc(o);if(t.exists()){const e=t.data(),a=e.tema||"Desconhecido";if(e.semParticipacao)E=`BATALHA DE DESENHOS (Tema: ${a}): DECEP√á√ÉO. Nenhuma equipe entregou o desenho. Voc√™ deve expressar sua tristeza com isso.`;else{let o=e.ranking||[];o.sort((e,a)=>a.total-e.total);const t=0<o.length?o[0]:null;if(t){const e=t.equipe.charAt(0).toUpperCase()+t.equipe.slice(1);E=`BATALHA DE DESENHOS (Tema: "${a}"): A equipe VENCEDORA foi a ${e.toUpperCase()} com ${t.total} pontos!
                  Na ter√ßa-feira, EU (o Or√°culo) avaliei o desenho deles dizendo: "${t.detalhes.comentario}".
                  Cite o que EU disse (minhas pr√≥prias palavras) para refor√ßar o motivo da vit√≥ria deles. N√£o elogie o coment√°rio como se fosse de outra pessoa, pois fui eu quem fiz.`}}}}catch(a){console.error("Or\xE1culo: Erro ao buscar dados de desenho:",a)}let y="Nenhum poder foi usado esta semana.";const b=Object.values(r).flat(),I=Object.values(d).flat();(0<b.length||0<I.length)&&(y="Atividade da Lojinha de Magias:\n",b.forEach(e=>{y+=`- (B√îNUS): ${e.por} usou "${e.nomePoder}" para sua equipe.\n`}),I.forEach(e=>{y+=`- (PUNI√á√ÉO): ${e.por} usou "${e.nomePoder}" contra a equipe advers√°ria.\n`}));const C=0<f.length?`SIM! Tivemos anivers√°rios de: ${f.join(", ")}`:"N\xE3o houve anivers\xE1rios registrados no feed.",x=0<h.length?`SIM! Tivemos a chegada de: ${h.join(", ")}`:"N\xE3o houve novos membros.",B=`
    Voc√™ √© o Or√°culo, o mentor s√°bio, acolhedor e carinhoso do "Grupo √âpicos".
    A competi√ß√£o da semana acabou. Sua tarefa √© escrever um post especial para o "Resumo da Semana", analisando os resultados com sua personalidade de um mentor mais velho (cerca de 50 anos), que √© am√°vel e demonstra cuidado com o progresso do grupo.

    Aqui est√£o os dados da semana para sua an√°lise:
	${o}
    - Resultado da Competi√ß√£o: ${l}
    - Placar Final (M√©dias das equipes):
    ${m}
    - Top 5 Membros da Semana (Dedica√ß√£o): 
    ${c||"Ningu\xE9m pontuou o suficiente para o Top 5."}
    - NOVOS MEMBROS (BOAS-VINDAS): 
    ${x}
	- ANIVERSARIANTES DA SEMANA (Evento Especial):
    ${C}
	- MEMBROS EM RECUPERA√á√ÉO DE SA√öDE (Doentes/Acidentados):
    ${p}
	- ${v}
	- ${E}
    - ${y}
    - Acontecimentos Recentes (O que aconteceu durante a semana):
    ${g||"Nenhum evento especial registrado."}

    Instru√ß√µes para sua resposta:
    1.  O t√≠tulo do evento ser√° "üßô‚Äç An√°lise Semanal do Or√°culo".
    2.  Escreva uma an√°lise detalhada (5 a 10 par√°grafos) em seu estilo carinhoso e de mentor.
    3.  Parabenize a(s) equipe(s) vencedora(s) de forma calorosa. Comente sobre a disputa, elogiando o esfor√ßo de todos, mesmo os que n√£o venceram.
    4.  **ATEN√á√ÉO AO TOP 5:** Cite EXATAMENTE os nomes listados acima como o Top 5. Elogie-os pela dedica√ß√£o e *rapidez* (pois o desempate √© por velocidade). N√ÉO invente outros nomes.
	5.  REGRA DE G√äNERO OBRIGAT√ìRIA: Verifique a etiqueta (G√™nero: ...) ao lado de cada nome. Use pronomes e adjetivos concordando com esse g√™nero (ex: "a Kaii foi guerreira", "o Max foi r√°pido").
	6.  **REGRA DE ENDERE√áAMENTO:** Mencione o membro como <strong>NomeDoMembro</strong>. Nunca use o Nome Real no texto, use-o apenas para ajudar a identificar o g√™nero caso o campo "G√™nero" esteja indefinido. Nunca use Nome Real diretamente na mensagem.
    7.  **3¬™ PESSOA (REGRA DE OURO):** No Mural, voc√™ fala **SOBRE** o membro para o grupo, nunca **COM** o membro.
        -   ERRADO: "Parab√©ns Max, voc√™ mandou bem!" (Isso √© 2¬™ pessoa).
        -   CERTO: "O Max mandou muito bem hoje!" (Isso √© 3¬™ pessoa).
        -   SEMPRE use: "Ele fez", "A Ana conseguiu", "O foco dele". NUNCA use "Voc√™".
	8.  **INSTRU√á√ÉO OBRIGAT√ìRIA DE BOAS-VINDAS:** Verifique o campo "NOVOS MEMBROS" acima. 
        -   Se houver nomes listados, voc√™ DEVE dedicar um par√°grafo exclusivo para dar as boas-vindas a eles. Diga que o grupo est√° feliz em receb√™-los e deseje uma jornada √©pica. Cite os nomes.
        -   Se estiver escrito "N√£o houve novos membros", ignore esta instru√ß√£o.
    10. **PODERES E MEDALHAS:** Se houver eventos de "Poder Ativado" ou "Medalha de Honra", comente brevemente sobre como essas a√ß√µes (o uso de magias ou o reconhecimento de membros) tornaram a semana mais interessante e competitiva.
	11.  **ATEN√á√ÉO AOS DOENTES:** Verifique a lista "MEMBROS EM RECUPERA√á√ÉO DE SA√öDE". Se houver nomes nela, voc√™ **DEVE** dedicar uma frase carinhosa desejando melhoras e pronta recupera√ß√£o a eles. Diga que a sa√∫de vem em primeiro lugar e que o grupo os aguarda.
    12.	**MEMBROS DE F√âRIAS:** Ignore membros que est√£o apenas de f√©rias (n√£o mencionados na lista de sa√∫de), eles est√£o descansando e n√£o precisam de men√ß√£o na an√°lise competitiva.
	13. **NOVA INSTRU√á√ÉO (MUITO IMPORTANTE):** Verifique a lista "ANIVERSARIANTES DA SEMANA". Se houver nomes nela, voc√™ **DEVE** dedicar um par√°grafo especial celebrando a vida deles novamente. Diga algo como "E como deixar de mencionar a alegria de celebrarmos mais um ano de vida de @Nome...". Celebre o fato de terem passado essa data com o grupo.
	14. **REGRA EXTREMAMENTE IMPORTANTE:** Use o "Nome de Usu√°rio" em negrito (ex: <strong>Nome</strong>). NUNCA use o s√≠mbolo '@' ou o nome real no texto.
    15.  Termine com uma mensagem de incentivo e afeto para a pr√≥xima semana, refor√ßando a import√¢ncia do descanso e da uni√£o.
    16.  Assine com "‚Äî Com carinho, Or√°culo." ou simplesmente "‚Äî Or√°culo.".
    17. Sua resposta deve ser apenas o texto da an√°lise, sem formata√ß√£o JSON e sem introdu√ß√µes.
    18. REGRA SOBRE PONTUA√á√ÉO: A pontua√ß√£o individual representa o total de dias de foco durante a semana. Elogie a 'dedica√ß√£o' e 'comprometimento', em vez de 'sequ√™ncia' ou 'dias consecutivos'.
	19. **INSTRU√á√ÉO OBRIGAT√ìRIA SOBRE A BATALHA DE DESENHOS:** Leia o dado fornecido acima em "BATALHA DE DESENHOS".
        - Se houver uma equipe vencedora, voc√™ DEVE dedicar um par√°grafo para parabeniz√°-la.
        - **IMPORTANTE:** O texto fornecido inclui a "Minha avalia√ß√£o" (o que voc√™ mesmo disse no dia do julgamento). Ao citar o coment√°rio t√©cnico, deixe claro que foram SUAS palavras s√°bias. Exemplo: "Como eu disse anteriormente...", "Reitero o que observei sobre o bico do pato...". JAMAIS elogie o coment√°rio em si (ex: n√£o diga "o coment√°rio t√©cnico foi perfeito"), elogie o DESENHO.
        - Se disser "DECEP√á√ÉO", d√™ uma bronca carinhosa no grupo pela falta de participa√ß√£o.
    20. **INSTRU√á√ÉO OBRIGAT√ìRIA SOBRE A LOTERIA:** Verifique o dado fornecido sobre a "LOTERIA √âPICA".
        - Se houver ganhadores, voc√™ DEVE parabeniz√°-los nominalmente e comentar sobre a sorte grande.
        - Se acumulou, voc√™ DEVE comentar que o pr√™mio est√° ficando gigante e incentivar apostas para a pr√≥xima.
        - N√ÉO IGNORE O RESULTADO DA LOTERIA.
  `;let A="";try{console.log(`üßô‚Äç Or√°culo preparando a an√°lise semanal...`),A=await callGenerativeAIWithRetry(B)}catch(e){console.error("Erro final ao gerar resumo semanal ap\xF3s todas as tentativas:",e),A="Meus queridos, a semana foi intensa. Parab\xE9ns aos vencedores! Que a pr\xF3xima semana nos traga ainda mais foco e uni\xE3o. Descansem bem. \u2014 Or\xE1culo."}let q=A.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>");return q=q.replace(/\n/g,"<br>"),analiseOraculoPendente=q,q}function mostrarPopupAnaliseOraculo(e){if(!e)return void console.log("Nenhuma an\xE1lise do Or\xE1culo para exibir.");const a=getSemanaAtual(),o=`oraculo_analise_semana_${a.numero}`;mostrarCardPopup("\uD83E\uDDD9\u200D A An\xE1lise Semanal do Or\xE1culo",e,null,"Or\xE1culo",o),analiseOraculoPendente=null}function getMedalha(e){const a=Object.keys(medalhas).map(Number).sort((e,a)=>a-e);for(const o of a)if(e>=o)return medalhas[o];return null}async function atualizarMedalhas(){for(const e in streaksCache)Object.hasOwnProperty.call(streaksCache,e)&&atualizarStreakVisualMembro(e,streaksCache[e])}async function atualizarPlacarSemanal(){document.getElementById("resumo-abelha")&&(document.getElementById("resumo-abelha").innerHTML=`
        <div>${document.querySelectorAll("#equipe-abelha input:checked").length} focaram hoje!</div>
        <div>${pontosSemanais.abelha} pontos na semana</div>
        <div>M√©dia: <span id="media-abelha">0.00</span></div>
      `),document.getElementById("resumo-joaninha")&&(document.getElementById("resumo-joaninha").innerHTML=`
        <div>${document.querySelectorAll("#equipe-joaninha input:checked").length} focaram hoje!</div>
        <div>${pontosSemanais.joaninha} pontos na semana</div>
        <div>M√©dia: <span id="media-joaninha">0.00</span></div>
      `),document.getElementById("resumo-vagalume")&&(document.getElementById("resumo-vagalume").innerHTML=`
        <div>${document.querySelectorAll("#equipe-vagalume input:checked").length} focaram hoje!</div>
        <div>${pontosSemanais.vagalume} pontos na semana</div>
        <div>M√©dia: <span id="media-vagalume">0.00</span></div>
      `),await atualizarMediaEquipes()}async function atualizarMediaEquipes(){const e=["abelha","joaninha","vagalume"],a=getSemanaAtual(),o=formatarDataISO(a.inicio),t=formatarDataISO(a.fim);try{const n=`semana_${a.numero}_${a.inicio.getFullYear()}`,i=doc(db,"vantagemSemanal",n),r=await getDoc(i),d=r.exists()?r.data().deducoesPoderes||{}:{},s=r.exists()?r.data().adicoesPoderes||{}:{},l=query(collection(dbEssencial,"presencas"),where("__name__",">=",o),where("__name__","<=",t)),m=await getDocs(l),c={};todosMembros.forEach(e=>{c[e.nome]=0}),m.forEach(e=>{const a=e.data();for(const o in a)a[o]&&void 0!==c[o]&&c[o]++});let u=1/0;e.forEach(e=>{const a=equipes[e]?.membros.filter(e=>!e.deFerias)||[],o=a.length;0<o&&o<u&&(u=o)}),u===1/0&&(u=0),e.forEach(e=>{const a=document.getElementById(`media-${e}`);if(!a)return;const o=equipes[e]?.membros.filter(e=>!e.deFerias)||[],t=o.length;if(0===t)return void(a.textContent="0.00");const n=o.map(e=>c[e.nome]||0);n.sort((e,a)=>e-a);const i=t-u;let r=[...n];0<i&&(r=n.slice(i));const l=o.reduce((e,a)=>e+(c[a.nome]||0),0),m=document.getElementById(`resumo-${e}`);m&&2<=m.children.length&&(m.children[1].textContent=`${l} pontos na semana`),pontosSemanais[e]=l;const p=r.reduce((e,a)=>e+a,0),g=r.length;let f=0<g?p/g:0;if(s[e]&&0<s[e].length){const a=s[e].reduce((e,a)=>e+(a.valor||0),0);f+=a}if(d[e]&&0<d[e].length){const a=d[e].reduce((e,a)=>e+(a.valor||0),0);f+=a}a.textContent=f.toFixed(2)})}catch(a){console.error("Erro ao atualizar m\xE9dias em tempo real:",a),e.forEach(e=>{const a=document.getElementById(`media-${e}`);a&&(a.textContent="0.00")})}}function atualizarRankingGeral(){const e=(e,a,o)=>{document.getElementById(e)&&(document.getElementById(e).textContent=o),document.getElementById(a)&&(document.getElementById(a).textContent=1===o?"Vit\xF3ria":"Vit\xF3rias")};e("ranking-abelha","label-vitorias-abelha",rankingGeral.abelha),e("ranking-joaninha","label-vitorias-joaninha",rankingGeral.joaninha),e("ranking-vagalume","label-vitorias-vagalume",rankingGeral.vagalume),atualizarPodioEquipes()}function configurarOuvintePresencaTempoReal(){const e=getHojeISO(),a=doc(dbEssencial,"presencas",e);window.listenersAtivos.presenca&&window.listenersAtivos.presenca(),window.listenersAtivos.presenca=onSnapshot(a,e=>{console.log("Sincroniza\xE7\xE3o em tempo real: O documento de presen\xE7as foi atualizado.");let a={};e.exists()&&(a=e.data()),todosMembros.forEach(e=>{const o=document.getElementById(e.nome);if(o){const t=!!a[e.nome];o.checked!==t&&(o.checked=t)}}),atualizarResumo()})}window.atualizarResumo=async function(){if(0===todosMembros.length)return;const e=document.querySelectorAll(".membro input[type=\"checkbox\"]").length;0===e||(filaAtualizacao=filaAtualizacao.then(async()=>{const a=getHoje(),o=getHojeISO(),t=todosMembros.filter(e=>document.getElementById(e.nome)?.checked).length,n=todosMembros.filter(e=>e.deFerias).length,i=todosMembros.filter(e=>!e.deFerias),r=i.filter(e=>document.getElementById(e.nome)?.checked).length,d=r+n,s=todosMembros.length;if(document.getElementById("contadorGeral")){document.getElementById("contadorGeral").textContent=`${d} √©picos focaram hoje!`;const e=0<s?100*(d/s):0,a=document.getElementById("progresso-barra");a.style.width=`${e}%`;const o=document.getElementById("marcador-arvore");if(o&&0<s){const e=100*(10/s);100>=e?(o.style.left=`${e}%`,o.style.display="flex"):o.style.display="none"}const t=document.querySelector(".global-stats"),n=document.getElementById("mensagem-todos-focados"),i=document.getElementById("status-focado"),r=document.getElementById("status-nao-focado");i&&(i.textContent=`‚úÖ ${d} √©picos focaram hoje`),r&&(r.textContent=`‚ùå ${s-d} √©picos ainda n√£o focaram`),d===s?(a.classList.add("rainbow-progress"),t.classList.add("rainbow-border"),n&&(n.textContent="Todos focaram (ou est\xE3o justificados) hoje, parab\xE9ns!!",n.classList.remove("hidden"))):(a.classList.remove("rainbow-progress"),t.classList.remove("rainbow-border"),n&&n.classList.add("hidden"))}atualizarPlacarSemanal(),verificarEquipeCompleta(),e>=todosMembros.length?await verificarArvoreEpica(d):console.warn(`[Prote√ß√£o] √Årvore n√£o processada devido a discrep√¢ncia visual (${e}/${todosMembros.length}), mas a barra foi atualizada.`),await carregarTop5Semana()}).catch(e=>{console.error("Erro na atualiza\xE7\xE3o:",e)}),await filaAtualizacao)};async function verificarEquipeCompleta(){const e=await verificarDataEspecial(getHoje());for(const a in equipes){const o=document.getElementById(`equipe-${a}`),t=document.getElementById(`msg-equipe-${a}`);if(!o||!t)continue;const n=equipes[a].membros.filter(e=>!e.deFerias),i=n.every(e=>document.getElementById(e.nome)?.checked),r=`membro-completo-${a}`;if(equipes[a].membros.forEach(e=>{const a=document.getElementById(e.nome)?.parentElement;a&&(i&&0<n.length?a.classList.add(r):a.classList.remove(r))}),t.classList.remove("abelha","joaninha","vagalume"),i&&0<n.length&&0!==getHoje().getDay()&&!e){o.classList.add("equipe-completa",a);const e=a.charAt(0).toUpperCase()+a.slice(1);t.textContent=`Parab√©ns, equipe ${e}!! Voc√™s gabaritaram hoje!!!`,t.classList.add(a),t.classList.remove("hidden")}else o.classList.remove("equipe-completa",a),t.classList.add("hidden")}}function mostrarCardPopup(e,a,o=null,t="Grupo \xC9picos",n=null){if(n&&currentUser){const e=todosMembros.find(e=>e.nome===currentUser);if(e&&e.bloqueiosPopups){const a=getHojeISO();if(e.bloqueiosPopups[`${n}_${a}`])return void console.log(`Popup '${n}' bloqueado pelo usu√°rio para hoje.`)}}cardPopupQueue.push({titulo:e,mensagem:a,onCloseCallback:o,assinatura:t,uniqueId:n}),processarFilaCardPopup()}async function processarFilaCardPopup(){const e=document.getElementById("custom-card-popup");if(e&&e.classList.contains("show"))return void(isCardPopupShowing=!0);if(isCardPopupShowing||0===cardPopupQueue.length)return;const a=document.querySelector("#pix-recebido-popup.show, #medalha-ganha-popup.show, #recompensa-recebida-popup.show, #popup-envio-diario-moedas.show, #popup-resultado-loteria.show, #recompensa-lideres-modal.show, #recompensa-equipe-modal.show, #fim-temporada-popup.show");if(a)return void setTimeout(processarFilaCardPopup,500);isCardPopupShowing=!0;const o=cardPopupQueue.shift(),t=document.getElementById("card-popup-title"),n=document.getElementById("card-popup-message"),i=document.querySelector(".card-popup-signature"),r=document.getElementById("card-popup-close-btn");t.textContent=o.titulo,n.innerHTML=o.mensagem,i&&(null===o.assinatura?i.style.display="none":(i.style.display="block",i.innerText=`‚Äî ${o.assinatura||"Grupo \xC9picos"}`));const d=document.getElementById("card-popup-dont-show-btn");if(d){const e=d.cloneNode(!0);d.parentNode.replaceChild(e,d),o.uniqueId?(e.classList.remove("hidden"),e.onclick=async a=>{if(a&&a.preventDefault(),l(),currentUser){const e=getHojeISO(),a=`${o.uniqueId}_${e}`,t=doc(db,"membros",currentUser);try{await updateDoc(t,{[`bloqueiosPopups.${a}`]:!0});const e=todosMembros.findIndex(e=>e.nome===currentUser);-1!==e&&(!todosMembros[e].bloqueiosPopups&&(todosMembros[e].bloqueiosPopups={}),todosMembros[e].bloqueiosPopups[a]=!0,localStorage.setItem("epicos_cache_membros",JSON.stringify(todosMembros))),console.log(`Bloqueio salvo para: ${a}`)}catch(e){console.error("Erro ao salvar bloqueio de popup:",e)}}}):e.classList.add("hidden")}const s=document.body.className;e.classList.remove("tema-noite","tema-manha","tema-tarde"),s.includes("tema-noite")?e.classList.add("tema-noite"):s.includes("tema-manha")?e.classList.add("tema-manha"):s.includes("tema-tarde")&&e.classList.add("tema-tarde"),e.classList.add("show");const l=async()=>{e.classList.remove("show"),o.onCloseCallback&&o.onCloseCallback(),await new Promise(e=>setTimeout(e,350)),isCardPopupShowing=!1,0<cardPopupQueue.length&&processarFilaCardPopup()},m=r.cloneNode(!0);r.parentNode.replaceChild(m,r),m.onclick=l,e.onclick=a=>{a.target===e&&l()}}function showOracleProgressOverlay(){const e=document.getElementById("oracle-progress-overlay");e&&(e.classList.remove("hidden"),setTimeout(()=>{e.classList.add("show")},10),updateOracleProgress(0,"Iniciando processo..."))}function hideOracleProgressOverlay(){const e=document.getElementById("oracle-progress-overlay");e&&(e.classList.remove("show"),setTimeout(()=>{e.classList.add("hidden")},300))}function updateOracleProgress(e,a){const o=document.getElementById("oracle-progress-bar"),t=document.getElementById("oracle-status-text");o&&(o.style.width=`${e}%`),t&&(t.textContent=a)}function showLoadingOverlay(e){const a=document.getElementById("loading-overlay"),o=document.getElementById("loading-text");a&&o&&(o.textContent=e,a.classList.remove("hidden"),setTimeout(()=>a.classList.add("show"),10))}function updateLoadingOverlayText(e){const a=document.getElementById("loading-text");a&&(a.textContent=e)}function hideLoadingOverlay(){const e=document.getElementById("loading-overlay");e&&(e.classList.remove("show"),setTimeout(()=>e.classList.add("hidden"),300))}function mostrarPopup(e,a,o=3e3){popupQueue.push({titulo:e,mensagem:a,duracao:o}),processPopupQueue()}window.mostrarPopup=mostrarPopup;function processPopupQueue(){if(0===popupQueue.length||isPopupShowing)return;isPopupShowing=!0;const e=popupQueue.shift(),a=document.getElementById("popup-message");return a?void(a.innerHTML=`<strong>${e.titulo}</strong><br>${e.mensagem}`,a.classList.add("show"),setTimeout(()=>{a.classList.remove("show"),setTimeout(()=>{isPopupShowing=!1,processPopupQueue()},500)},e.duracao)):void(isPopupShowing=!1)}function mostrarPopupMoedas(e){if(0<e){mostrarPopup("\uD83C\uDF89 Recompensa!",`Voc√™ ganhou <strong>${e} üí∞ moedas</strong>!`,3500)}}const medalhasConcedidas={};function atualizarStreakVisualMembro(e,a){const o=document.getElementById(`dias-${e}`);o&&(o.textContent=a,o.title=`${a} dias de foco consecutivos`);const t=document.getElementById(`medalha-${e}`);if(t){const e=getMedalha(a);e?(t.innerHTML=e.emoji,t.title=`${e.nome} - ${a} dias de foco consecutivos`,t.classList.add("com-medalha"),t.classList.remove("escondido")):(t.innerHTML="",t.classList.remove("com-medalha"),t.classList.add("escondido"))}}function dispararConfete(){function e(n){i=n,o.clearRect(0,0,a.width,a.height);let r=0;for(let e=0;e<t.length;e++){const n=t[e];n.y+=n.speed,n.x+=n.drift,n.angle+=n.spin,o.save(),o.translate(n.x+n.w/2,n.y+n.h/2),o.rotate(n.angle),o.fillStyle=n.color,o.fillRect(-n.w/2,-n.h/2,n.w,n.h),o.restore(),n.y<a.height&&r++}0<r?requestAnimationFrame(e):o.clearRect(0,0,a.width,a.height)}const a=document.getElementById("confetti-canvas");if(!a)return;const o=a.getContext("2d");a.width=window.innerWidth,a.height=window.innerHeight;const t=[],n=["#FFD700","#FF6B6B","#2ECC71","#3498DB","#9B59B6","#FAD390"];for(let e=0;e<200;e++)t.push({x:Math.random()*a.width,y:-Math.random()*a.height,w:8*Math.random()+5,h:15*Math.random()+8,color:n[Math.floor(Math.random()*n.length)],angle:2*(Math.random()*Math.PI),speed:4*Math.random()+2,spin:.4*Math.random()-.2,drift:2*Math.random()-1});let i=0;requestAnimationFrame(e)}function iniciarConfeteAniversarioContinuo(){function e(){o.clearRect(0,0,a.width,a.height);for(let e=particulasAniversario.length-1;0<=e;e--){const t=particulasAniversario[e];t.y+=t.speed,t.x+=t.drift,t.angle+=t.spin,o.save(),o.translate(t.x+t.w/2,t.y+t.h/2),o.rotate(t.angle),o.fillStyle=t.color,o.fillRect(-t.w/2,-t.h/2,t.w,t.h),o.restore(),t.y>a.height+20&&particulasAniversario.splice(e,1)}animacaoConfeteAniversarioId=requestAnimationFrame(e)}if(animacaoConfeteAniversarioId)return;const a=document.getElementById("confetti-canvas");if(!a)return;const o=a.getContext("2d");a.width=window.innerWidth,a.height=window.innerHeight;const t=["#FFD700","#FF6B6B","#2ECC71","#3498DB","#9B59B6","#FAD390"];geradorDeParticulasId=setInterval(()=>{particulasAniversario.push({x:Math.random()*a.width,y:-20,w:6*Math.random()+4,h:12*Math.random()+6,color:t[Math.floor(Math.random()*t.length)],angle:2*(Math.random()*Math.PI),speed:2*Math.random()+1,spin:.2*Math.random()-.1,drift:1*Math.random()-.5})},200),e()}function pararConfeteAniversarioContinuo(){geradorDeParticulasId&&(clearInterval(geradorDeParticulasId),geradorDeParticulasId=null),animacaoConfeteAniversarioId&&(cancelAnimationFrame(animacaoConfeteAniversarioId),animacaoConfeteAniversarioId=null),particulasAniversario=[];const e=document.getElementById("confetti-canvas");if(e){const a=e.getContext("2d");a.clearRect(0,0,e.width,e.height)}}async function executarMarcacaoAutomaticaDeFolgasDoDia(){const e=getHojeISO(),a=await verificarDataEspecial(getHoje());if(a)return void console.log(`[FOLGAS HOJE] Hoje √© feriado (${a}). A rotina de folgas individuais ser√° ignorada.`);const o=doc(db,"appState","dailyTasks");console.log(`[FOLGAS HOJE] Verificando se a marca√ß√£o autom√°tica para ${e} j√° foi executada.`);try{const a=await getDoc(o),t=a.exists()&&a.data().folgasMarcadasPara===e;if(t)return void console.log(`[FOLGAS HOJE] Tarefa de marca√ß√£o para ${e} j√° foi conclu√≠da. Nenhuma a√ß√£o.`);console.log("[FOLGAS HOJE] Buscando lista de membros atualizada do Firestore...");const n=await getDocs(collection(db,"membros")),i=[];n.forEach(e=>{i.push({nome:e.id,...e.data()})});const r=getDiaSemanaString(getHoje()).toLowerCase().replace(/-feira$/,"").normalize("NFD").replace(/[\u0300-\u036f]/g,""),d=i.filter(e=>{if(!e.folga||e.deFerias)return!1;const a=e.folga.toLowerCase().replace(/-feira$/,"").normalize("NFD").replace(/[\u0300-\u036f]/g,"");return a===r});if(0===d.length)return console.log("[FOLGAS HOJE] Nenhum membro de folga hoje. Definindo trava."),void(await setDoc(o,{folgasMarcadasPara:e},{merge:!0}));console.log(`%c[FOLGAS HOJE] ${d.length} membro(s) de folga encontrados. Preparando opera√ß√£o blindada...`,"color: #8e44ad; font-weight: bold;");const s=doc(dbEssencial,"presencas",e),l=doc(dbEssencial,"semanas","pontosSemanais"),m=0===getHoje().getDay();await runTransaction(dbEssencial,async e=>{const a=await e.get(s),o=a.exists(),t={};for(const a of d){const o=a.nome,n=a.equipe,i=doc(dbEssencial,"membros_essencial",o);t[o]=new Date,e.set(i,{streak:increment(1),moedas:increment(recompensasConfig.focoDiario||100)},{merge:!0}),n&&!m&&pontosSemanais.hasOwnProperty(n)&&e.set(l,{[n]:increment(1)},{merge:!0})}0<Object.keys(t).length&&(o?e.update(s,t):e.set(s,t,{merge:!0}))}),await setDoc(o,{folgasMarcadasPara:e},{merge:!0}),console.log(`[FOLGAS HOJE] Lote de dados conclu√≠do com sucesso.`);const c=await getDoc(l),u=c.exists()?c.data():{abelha:0,joaninha:0,vagalume:0};for(const e of d){const a=e.nome,o=e.equipe,t=streaksCache[a]||0,n=t+1;streaksCache[a]=n;const i=Object.keys(medalhas).map(Number).sort((e,a)=>e-a);for(const e of i)if(n>=e&&t<e){const o=medalhas[e];await adicionarEventoAoFeed("medalha","\uD83C\uDFC5 Nova Conquista!",`<strong>${a}</strong> alcan√ßou <strong>${n} dias</strong> de foco e ganhou a medalha ${o.emoji} <strong>${o.nome}</strong>!`,{nomeMembro:a,medalha:o.nome});break}let r;if(o&&!m&&Object.keys(equipes).includes(o)){const e=o.charAt(0).toUpperCase()+o.slice(1);r=`A caixa de sele√ß√£o de <strong>${a}</strong> foi marcada automaticamente, pois hoje √© o seu dia de folga. Isso garante +1 ponto para a equipe <strong>${e}</strong>, totalizando <strong>${u[o]}</strong> pontos! Bom descanso <strong>${a}</strong>!!`}else r=`A caixa de sele√ß√£o de <strong>${a}</strong> foi marcada automaticamente, pois hoje √© o seu dia de folga. Bom descanso!`;await adicionarEventoAoFeed("geral","\uD83C\uDF34 Dia de Descanso Merecido!",r,{nomeMembro:a})}d.forEach(e=>{const a=document.getElementById(e.nome);a&&!a.checked&&(a.checked=!0),e.equipe&&!m&&pontosSemanais[e.equipe]++})}catch(a){console.error(`[FOLGAS HOJE] Erro cr√≠tico na opera√ß√£o de folgas para ${e}.`,a)}}async function gerenciarFluxoPosFoco(){if(currentUser)try{const e=query(collection(db,"notificacoes"),where("destinatarioId","==",currentUser),where("lida","==",!1),where("tipo","not-in",["moedas","recompensa_lider","recompensa_membro","medalha-presente"])),a=await getDocs(e);a.empty?(console.log("Foco registrado. Sem notifica\xE7\xF5es. For\xE7ando abertura do Nudge..."),setTimeout(()=>verificarNudgesDiarios(!0),1500)):(console.log("Foco registrado. Notifica\xE7\xF5es encontradas. Abrindo modal..."),fluxoNotificacaoFoco=!0,updateLoadingOverlayText("Aproveite para ler suas notifica\xE7\xF5es"),await new Promise(e=>setTimeout(e,2e3)),openModal("notificacoes-modal"))}catch(e){console.error("Erro ao verificar notifica\xE7\xF5es p\xF3s-foco:",e)}}window.marcarCheckbox=async function(e){const a=todosMembros.find(a=>a.nome===e);if(a&&a.deFerias){mostrarPopup("\uD83C\uDF34 Em F\xE9rias","Membros de f\xE9rias n\xE3o podem registrar o foco. Aproveite seu descanso!",4e3);const a=document.getElementById(e);return void(a&&(a.checked=!1))}if(checkboxLocks[e]){const a=document.getElementById(e);return void(a&&(a.checked=!a.checked))}checkboxLocks[e]=!0;const o=document.getElementById(e),t=todosMembros.find(a=>a.nome===e);if(!o||!t)return void(checkboxLocks[e]=!1);const n=()=>"lider"===userRole||"lider-equipe"===userRole&&t.equipe===userTeam||"membro"===userRole&&currentUser===e;if(!n())return o.checked=!o.checked,mostrarPopup("\uD83D\uDEAB Acesso Negado","Voc\xEA n\xE3o tem permiss\xE3o para alterar o foco de outro membro.",4e3),void(checkboxLocks[e]=!1);showLoadingOverlay("Aguarde um segundo...");const i=streaksCache[e]||0,r=getHoje(),d=0===r.getDay(),s=o.checked?"adicionar":"remover",l=t.equipe,m=getDiaSemanaString(r);"remover"===s&&t.folga===m&&(folgasManualmenteRemovidas[e]=!0);let c=[];try{const{streakAtual:a,novosPontosEquipe:o}=await verificarConquista(e,s,l,d);if(streaksCache[e]=a,l&&pontosSemanais.hasOwnProperty(l)&&(pontosSemanais[l]=o),atualizarStreakVisualMembro(e,a),"adicionar"===s){const o=Object.keys(medalhas).map(Number).sort((e,a)=>e-a);let t=!1;for(const n of o)if(a>=n&&i<n){const o=medalhas[n],i=`Parab√©ns, ${e}! Voc√™ alcan√ßou ${a} dias de foco e conquistou a medalha ${o.emoji} ${o.nome}!`;currentUser===e&&(c.push({tipo:"medalha",titulo:"\uD83C\uDFC5 Nova Medalha!",mensagem:i,duracao:6e3}),c.push({tipo:"confete"}),t=!0),await adicionarEventoAoFeed("medalha","\uD83C\uDFC5 Nova Conquista!",`<strong>${e}</strong> alcan√ßou <strong>${a} dias</strong> de foco e ganhou a medalha ${o.emoji} <strong>${o.nome}</strong>!`,{nomeMembro:e,medalha:o.nome});break}if(currentUser===e){const a=t?1e3:0;c.push({tipo:"foco",titulo:"\uD83C\uDF89 Foco Registrado",mensagem:`${e}, parab√©ns por ter focado hoje!`,duracao:3e3,atraso:a}),c.push({tipo:"moedas",quantidade:recompensasConfig.focoDiario||100,atraso:a})}await gerenciarFluxoPosFoco()}else c.push({tipo:"removido",titulo:"\u2139\uFE0F Foco Removido",mensagem:`${e}, seu foco de hoje foi removido`,duracao:3e3});"adicionar"!==s||d||(l&&pontosSemanais.hasOwnProperty(l)?await gerarEventoDeFoco(e,l,a,o):await gerarEventoDeFocoIndividual(e,a)),await atualizarResumo(),fluxoNotificacaoFoco||("adicionar"===s?(updateLoadingOverlayText("Maravilha, o foco foi registrado!"),currentUser===e&&tocarSom("som-check")):updateLoadingOverlayText("Tudo bem, foco removido!"),await new Promise(e=>setTimeout(e,500)))}catch(e){console.error("Erro no fluxo principal de marcarCheckbox:",e),o.checked=!o.checked,fluxoNotificacaoFoco=!1,hideLoadingOverlay()}finally{fluxoNotificacaoFoco||hideLoadingOverlay(),checkboxLocks[e]=!1}0<c.length&&(await new Promise(e=>setTimeout(e,350)),c.forEach(e=>{const a=()=>{switch(e.tipo){case"moedas":mostrarPopupMoedas(e.quantidade);break;case"confete":dispararConfete(),tocarSom("som-conquista");break;default:mostrarPopup(e.titulo,e.mensagem,e.duracao);}};e.atraso?setTimeout(a,e.atraso):a()}))};async function verificarEProcessarFolgaDoDiaAtual(){if(currentUser&&usuarioAceitaPopups())try{const e=todosMembros.find(e=>e.nome===currentUser);if(!e||!e.folga)return;const a=await verificarDataEspecial(getHoje());if(a)return;const o=getDiaSemanaString().toLowerCase().replace(/-feira$/,"").normalize("NFD").replace(/[\u0300-\u036f]/g,""),t=e.folga.toLowerCase().replace(/-feira$/,"").normalize("NFD").replace(/[\u0300-\u036f]/g,"");if(t===o){mostrarCardPopup("\uD83C\uDF34 Bom Descanso!","Como hoje \xE9 sua folga, sua caixa de sele\xE7\xE3o foi marcada automaticamente para voc\xEA. Aproveite!",null,"Grupo \xC9picos","aviso_hoje_folga")}}catch(e){console.error("Erro ao verificar popup de folga do dia atual:",e)}}async function marcarFolgaAutomatica(e){if(!e||!e.nome)return;const a=e.nome,o=getHojeISO(),t=doc(dbEssencial,"membros_essencial",a),n=doc(dbEssencial,"presencas",o),i=doc(dbEssencial,"semanas","pontosSemanais");try{const{novoStreak:o,novosPontosEquipe:r}=await runTransaction(dbEssencial,async e=>{const o=await e.get(t),r=await e.get(n);if(!o.exists())throw"Membro n\xE3o encontrado.";let d;const s=o.data().equipe;s&&0!==getHoje().getDay()&&(d=await e.get(i));const l=(o.data().streak||0)+1;let m=0;s&&0!==getHoje().getDay()&&d&&d.exists()&&(m=d.data()[s]||0);const c=m+1;return r.exists()?e.update(n,{[a]:new Date}):e.set(n,{[a]:new Date},{merge:!0}),e.update(t,{streak:l}),s&&0!==getHoje().getDay()?(e.set(i,{[s]:c},{merge:!0}),{novoStreak:l,novosPontosEquipe:c}):{novoStreak:l,novosPontosEquipe:m}});streaksCache[a]=o,atualizarStreakVisualMembro(a,o),e.equipe&&0!==getHoje().getDay()&&(pontosSemanais[e.equipe]=r);let d;if(e.equipe&&Object.keys(equipes).includes(e.equipe)&&0!==getHoje().getDay()){const o=e.equipe.charAt(0).toUpperCase()+e.equipe.slice(1);d=`A caixa de sele√ß√£o de <strong>${a}</strong> foi marcada automaticamente, pois hoje √© o seu dia de folga. Isso garante +1 ponto para a equipe <strong>${o}</strong>, totalizando <strong>${r}</strong> pontos! Bom descanso <strong>${a}</strong>!!`}else d=`A caixa de sele√ß√£o de <strong>${a}</strong> foi marcada automaticamente, pois hoje √© o seu dia de folga. Bom descanso!`;await adicionarEventoAoFeed("geral","\uD83C\uDF34 Dia de Descanso Merecido!",d,{nomeMembro:a}),console.log(`Folga de ${a} marcada com sucesso.`)}catch(e){console.error(`Erro ao marcar folga autom√°tica para ${a}:`,e)}}window.resetarTudo=async function(){if(confirm("\u26A0\uFE0F ATEN\xC7\xC3O: Voc\xEA est\xE1 prestes a resetar TODOS os dados!\nIsso apagar\xE1 todo o hist\xF3rico e pontos.\n\nDeseja continuar?"))try{const e=await getDocs(collection(dbEssencial,"presencas")),a=writeBatch(dbEssencial);e.forEach(e=>a.delete(e.ref));const o=doc(dbEssencial,"semanas","pontosSemanais");a.delete(o);const t=await getDocs(collection(dbEssencial,"membros_essencial"));t.forEach(e=>{a.update(e.ref,{streak:0,moedas:0})}),await a.commit();const n=doc(db,"ranking","geral");await setDoc(n,{abelha:0,joaninha:0,vagalume:0});const i=doc(db,"arvoreEpica","progresso");await deleteDoc(i);const r=await getDocs(collection(db,"streak"));for(const e of r.docs)await deleteDoc(e.ref);pontosSemanais.abelha=0,pontosSemanais.joaninha=0,pontosSemanais.vagalume=0,rankingGeral.abelha=0,rankingGeral.joaninha=0,rankingGeral.vagalume=0,await carregarPresenca(),await carregarTotalDias(),await carregarPontosSemanais(),await carregarRankingGeral(),await carregarArvoreEpica(),atualizarPlacarSemanal(),atualizarRankingGeral(),atualizarMedalhas(),atualizarExibicaoArvore(),mostrarPopup("\u2705 Reset Completo","Todos os dados foram resetados com sucesso!",5e3)}catch(e){console.error("Erro ao resetar dados:",e),mostrarPopup("\u274C Erro no Reset","Ocorreu um erro ao tentar resetar os dados.",5e3)}},window.resetarDia=async function(e=!1){if(!resetEmAndamento){if(resetEmAndamento=!0,!e&&!confirm("\u26A0\uFE0F ATEN\xC7\xC3O: Voc\xEA est\xE1 prestes a desmarcar TODOS os checkboxes do dia atual e zerar o contador do dia.\n\nIsso n\xE3o afetar\xE1 os pontos semanais ou streaks.\n\nDeseja continuar?"))return void(resetEmAndamento=!1);try{if(todosMembros.forEach(e=>{const a=e.nome,o=document.getElementById(a);if(o){o.checked=!1;const e=o.nextElementSibling;e&&e.classList.remove("checked")}}),!e){const e=getHojeISO(),a=doc(dbEssencial,"presencas",e);await deleteDoc(a),console.log("Documento de presen\xE7a apagado MANUALMENTE."),mostrarPopup("\u2705 Dia Resetado","Todos os checkboxes foram desmarcados e o dia foi zerado.",5e3)}else console.log("Rotina de virada de dia: Interface limpa, aguardando carregamento da nova data.");document.getElementById("contadorGeral")&&(document.getElementById("contadorGeral").textContent="0 \xE9picos focaram hoje!",document.getElementById("progresso-barra").style.width="0%"),atualizarPlacarSemanal(),await Promise.all([carregarStreaks()])}catch(a){console.error("Erro ao resetar o dia:",a),e||mostrarPopup("\u274C Erro","Ocorreu um erro ao resetar o dia.",5e3)}finally{resetEmAndamento=!1}}};async function limparColecaoSemanas(){try{const e=collection(dbEssencial,"semanas"),a=await getDocs(e);a.forEach(async e=>{"pontosSemanais"!==e.id&&(console.warn(`Apagando documento indesejado na cole√ß√£o 'semanas' (Essencial): ${e.id}`),await deleteDoc(doc(dbEssencial,"semanas",e.id)))})}catch(e){console.error("Erro ao limpar cole\xE7\xE3o 'semanas':",e)}}async function limparMuralSemanal(){try{const e=getHoje();if(1!==e.getDay())return;const a=new Date(e);a.setDate(a.getDate()-7);const o=getSemanaAtual(a).numero,t=query(collection(db,"mural"),where("semana","<",o)),n=await getDocs(t),i=writeBatch(db);n.forEach(e=>{i.delete(e.ref)}),await i.commit(),console.log(`Mural limpo: ${n.size} mensagens antigas removidas`)}catch(e){console.error("Erro ao limpar mural:",e)}}const fasesArvore=[{dias:1,nome:"Semente",emoji:"\uD83C\uDF31",desc:"A jornada come\xE7a com um \xFAnico dia de foco. Vamos plantar nossa semente e cultivar nossa dedica\xE7\xE3o di\xE1ria!"},{dias:15,nome:"Broto",emoji:"\uD83C\uDF3F",desc:"Com 15 dias consecutivos, nosso esfor\xE7o come\xE7a a brotar. Vamos continuar regando nossa determina\xE7\xE3o!"},{dias:60,nome:"\xC1rvore",emoji:"\uD83C\uDF33",desc:"60 dias de foco ininterrupto! Nossa \xE1rvore cresce forte, simbolizando nossa consist\xEAncia e perseveran\xE7a."},{dias:180,nome:"Flores",emoji:"\uD83C\uDF38",desc:"180 dias de dedica\xE7\xE3o fazem florescer resultados. Cada flor representa uma conquista em nossa jornada!"},{dias:365,nome:"Frutos",emoji:"\uD83C\uDF4E",desc:"365 dias de foco cont\xEDnuo! Agora colhemos os frutos do nosso trabalho \xE1rduo e da nossa dedica\xE7\xE3o inabal\xE1vel."}];let arvoreEpica={consecutivos:0,ultimoDia:null,faseAtual:0};async function carregarEstadoArvore(){const e=doc(db,"arvoreEpica","progresso"),a=await getDoc(e);if(a.exists())arvoreEpica=a.data();else{arvoreEpica={consecutivos:0,ultimoDia:null,faseAtual:0},await setDoc(e,arvoreEpica);const a=getHojeISO(),o=doc(db,"appState",`lock_arvore_${a}`);await setDoc(o,{processadoSucesso:!0,dia:a},{merge:!0})}}async function verificarArvoreEpica(e){if(resetEmAndamento)return;const a=getHojeISO(),o=doc(db,"appState",`lock_arvore_${a}`),t=doc(db,"arvoreEpica","progresso"),n=new Date(getHoje());n.setDate(n.getDate()-1);const i=formatarDataISO(n),r=`arvore_cresceu_${a}`,d=`arvore_perdeu_${a}`;let s=null,l=null;try{await runTransaction(db,async n=>{const r=await n.get(o),d=await n.get(t),m=r.exists();let c=d.exists()?d.data():{consecutivos:0,ultimoDia:null,faseAtual:0};if(10<=e){if(!m){let r=c.consecutivos,d,m;if(!c.ultimoDia)r=1,d="\uD83C\uDF33 A \xC1rvore Come\xE7ou a Crescer!",m=`Com a for√ßa de ${e} membros hoje, plantamos nossa semente. Estamos com <strong>1 dia</strong>.`;else if(c.ultimoDia===i)r++,d="\uD83C\uDF33 A \xC1rvore Cresceu!",m=`Com a for√ßa de ${e} membros hoje, nossa √°rvore avan√ßou! Estamos com <strong>${r} dias</strong> consecutivos.`;else{if(c.ultimoDia===a)return void console.log("Prote\xE7\xE3o de \xC1rvore: Tentativa de crescimento duplicada detectada e evitada. Mantendo sequ\xEAncia.");r=1,d="\uD83C\uDF31 Novo Plantio!",m=`A sequ√™ncia anterior foi quebrada, mas hoje atingimos a meta novamente! A √Årvore √âpica recome√ßa sua jornada com <strong>1</strong> dia.`}n.set(o,{processadoSucesso:!0,dia:a}),n.update(t,{consecutivos:r,ultimoDia:a}),s="cresceu",l={titulo:d,corpo:m,dias:r},arvoreEpica.consecutivos=r,arvoreEpica.ultimoDia=a}}else if(m){if(5>e&&5<todosMembros.length)return;const a=c.consecutivos,r=Math.max(0,a-1),d=0<r?i:null;n.delete(o),n.update(t,{consecutivos:r,ultimoDia:d}),s="perdeu",l={diasAntes:a,diasDepois:r,totalCheckins:e},arvoreEpica.consecutivos=r,arvoreEpica.ultimoDia=d}})}catch(a){return void console.error("Transa\xE7\xE3o da \xC1rvore falhou:",a)}if(s&&l){if(await new Promise(e=>setTimeout(e,2500)),"cresceu"===s){await adicionarEventoAoFeed("arvore",l.titulo,l.corpo,{dias:l.dias},r),verificarEvolucaoFase(arvoreEpica.consecutivos);try{await deleteDoc(doc(db,"resumoSemanalFeed",d))}catch(a){}}else if("perdeu"===s){const e=`O n√∫mero de focos confirmados caiu para <strong>${l.totalCheckins}</strong> (o m√≠nimo √© 10). A contagem de hoje foi cancelada e voltamos para <strong>${l.diasDepois} dias</strong>.`;await adicionarEventoAoFeed("arvore","\uD83C\uDF42 A \xC1rvore Perdeu For\xE7a...",e,{diasAntes:l.diasAntes,diasDepois:l.diasDepois},d);try{await deleteDoc(doc(db,"resumoSemanalFeed",r))}catch(a){}verificarEvolucaoFase(arvoreEpica.consecutivos)}atualizarExibicaoArvore()}else if(10<=e&&arvoreEpica.ultimoDia!==a){const e=doc(db,"arvoreEpica","progresso"),a=await getDoc(e);a.exists()&&(arvoreEpica=a.data(),atualizarExibicaoArvore())}}function verificarEvolucaoFase(e){const a=e=>{for(let a=fasesArvore.length-1;0<=a;a--)if(e>=fasesArvore[a].dias)return a;return 0},o=a(e),t=a(e-1);if(o>t){const e=fasesArvore[o],a=document.getElementById("som-conquista");a&&(a.currentTime=0,a.play()),mostrarPopup("\uD83C\uDF33 \xC1rvore \xC9pica",`Parab√©ns! A √°rvore evoluiu para: ${e.nome} ${e.emoji}`,5e3),dispararConfete(),adicionarEventoAoFeed("arvore","\u2728\uD83C\uDF33 A \xC1rvore Evoluiu!",`Com o esfor√ßo de todos, nossa √Årvore √âpica alcan√ßou a fase de ${e.emoji} <strong>${e.nome}</strong>! Continuem focando!`,{fase:e.nome})}arvoreEpica.faseAtual=o}async function carregarArvoreEpica(){await carregarEstadoArvore(),atualizarExibicaoArvore()}function criarEstrelas(){const e=document.querySelectorAll(".stars-container");0===e.length||e.forEach(e=>{if(!(0<e.children.length)){e.innerHTML="";for(let a=0;a<150;a++){const a=document.createElement("div");a.classList.add("star");const o=3*Math.random()+1;a.style.width=`${o}px`,a.style.height=`${o}px`,a.style.left=`${100*Math.random()}%`,a.style.top=`${100*Math.random()}%`,a.style.animationDelay=`${4*Math.random()}s`,a.style.animationDuration=`${2+3*Math.random()}s`,e.appendChild(a)}}})}function atualizarExibicaoArvore(){if(!document.getElementById("stage-name"))return;const e=fasesArvore[arvoreEpica.faseAtual];document.getElementById("stage-name").textContent=e.nome+" "+e.emoji,document.getElementById("stage-desc").textContent=e.desc,document.getElementById("dias-consecutivos").textContent=arvoreEpica.consecutivos;["seed","sprout","tree","flowers","fruits"].forEach((e,a)=>{const o=document.getElementById(e);o&&(a===arvoreEpica.faseAtual?o.style.display="block":o.style.display="none")});const a=arvoreEpica.faseAtual<fasesArvore.length-1?fasesArvore[arvoreEpica.faseAtual+1]:null,o=document.getElementById("proxima-fase");if(o)if(a){const e=a.dias-arvoreEpica.consecutivos;o.textContent=`Faltam ${e} dias para ${a.nome} ${a.emoji}`}else o.textContent="Voc\xEA alcan\xE7ou o n\xEDvel m\xE1ximo!";const t=getHoje(),n=t.getHours(),i=18<=n||6>n,r=document.querySelector("#secao-arvore-epica .tree-sky");if(r){const e=r.querySelector(".stars-container");i?(r.classList.add("night-mode"),r.classList.remove("day-mode"),criarEstrelas(),e&&(e.style.opacity="1")):(r.classList.remove("night-mode"),r.classList.add("day-mode"),e&&(e.style.opacity="0"))}const d=document.getElementById("sol"),s=document.getElementById("lua");d&&s&&(d.style.opacity=i?"0":"1",s.style.opacity=i?"1":"0")}async function verificarMudancaData(){if(document.hidden||"hidden"===document.visibilityState)return void console.log("App em segundo plano. Verifica\xE7\xE3o de data pausada para economizar recursos e evitar conflitos.");const e=getHojeISO();return""===dataAtual?void(dataAtual=e):void(dataAtual===e?atualizarDataCabecalho():(dataAtual=e,console.log(`üìÖ Mudan√ßa de data detectada: ${dataAtual} -> ${e}`),await executarRotinaDeMeiaNoite()))}let resetEmAndamento=!1;async function marcarFolgaColetivaDeDomingo(){if(0!==getHoje().getDay())return;const e=getHojeISO(),a=doc(db,"appState","dailyTasks");try{const o=await getDoc(a),t=o.exists()&&o.data().domingoColetivoMarcadoPara===e;if(t)return console.log(`[DOMINGO COLETIVO] Marca√ß√£o para ${e} j√° foi feita. Apenas atualizando a tela.`),todosMembros.forEach(e=>{const a=document.getElementById(e.nome);a&&!a.checked&&(a.checked=!0)}),void(await atualizarResumo());console.log("\uD83C\uDF1E Domingo! Executando marca\xE7\xE3o de folga coletiva para todos os membros...");const n=writeBatch(db),i=writeBatch(dbEssencial);todosMembros.forEach(a=>{const o=a.nome,t=doc(dbEssencial,"membros_essencial",o),n=doc(dbEssencial,"presencas",e);i.set(n,{[o]:new Date},{merge:!0}),i.update(t,{streak:increment(1),moedas:increment(recompensasConfig.focoDiario||100)})}),n.set(a,{domingoColetivoMarcadoPara:e},{merge:!0}),await i.commit(),await n.commit(),console.log(`‚úÖ Folga coletiva de domingo SALVA para ${todosMembros.length} membros.`),await adicionarEventoAoFeed("geral","\uD83C\uDF34 Folga Coletiva de Domingo!","Hoje \xE9 nosso dia de descanso coletivo! Todas as caixas de sele\xE7\xE3o foram marcadas automaticamente para garantir o streak de todos. Bom descanso, \xC9picos!",{});for(const e of todosMembros){const a=e.nome,o=streaksCache[a]||0,t=o+1,n=Object.keys(medalhas).map(Number).sort((e,a)=>e-a);for(const e of n)if(t>=e&&o<e){const o=medalhas[e];await adicionarEventoAoFeed("medalha","\uD83C\uDFC5 Nova Conquista!",`<strong>${a}</strong> alcan√ßou <strong>${t} dias</strong> de foco e ganhou a medalha ${o.emoji} <strong>${o.nome}</strong>!`,{nomeMembro:a,medalha:o.nome}),console.log(`[DOMINGO COLETIVO] ${a} ganhou a medalha ${o.nome} (${t} dias).`);break}}todosMembros.forEach(e=>{const a=document.getElementById(e.nome);a&&(a.checked=!0),streaksCache[e.nome]!==void 0&&streaksCache[e.nome]++}),await atualizarResumo()}catch(e){console.error("Erro cr\xEDtico ao marcar a folga coletiva de domingo:",e)}}async function processarFeriadoDoDia(){const e=getHoje(),a=await verificarDataEspecial(e);if(!a)return;const o=getHojeISO(),t=doc(db,"appState","dailyTasks");try{const e=await getDoc(t),n=e.exists()&&e.data().feriadoProcessadoPara===o;if(currentUser){setTimeout(()=>{mostrarCardPopup(`üéâ Feriado: ${a}`,`Hoje √© <strong>${a}</strong>! O dia foi considerado um feriado no Grupo √âpicos.<br><br>Sua caixa de sele√ß√£o foi marcada automaticamente. Aproveite o dia para descansar ou celebrar!`,dispararConfete,"Grupo \xC9picos","feriado_hoje")},2500)}if(n)return console.log(`[FERIADO] Processamento para ${a} (${o}) j√° realizado.`),todosMembros.forEach(e=>{const a=document.getElementById(e.nome);a&&!a.checked&&(a.checked=!0)}),void(await atualizarResumo());console.log(`üéâ Processando Feriado: ${a}...`);const i=writeBatch(db),r=writeBatch(dbEssencial),d=doc(dbEssencial,"presencas",o);todosMembros.forEach(e=>{const a=e.nome,o=doc(dbEssencial,"membros_essencial",a);r.set(d,{[a]:new Date},{merge:!0}),r.update(o,{streak:increment(1),moedas:increment(recompensasConfig.focoDiario||100)})}),i.set(t,{feriadoProcessadoPara:o},{merge:!0}),await r.commit(),await i.commit(),await adicionarEventoAoFeed("geral",`üéâ Feriado: ${a}!`,`Hoje celebramos o <strong>${a}</strong>! Todas as caixas de sele√ß√£o foram marcadas automaticamente. Aproveitem o descanso, √âpicos!`,{feriado:!0}),todosMembros.forEach(e=>{streaksCache[e.nome]!==void 0&&streaksCache[e.nome]++;const a=document.getElementById(e.nome);a&&(a.checked=!0)}),await atualizarResumo(),atualizarMedalhas(),console.log(`‚úÖ Feriado ${a} processado com sucesso.`)}catch(e){console.error("Erro ao processar feriado:",e)}}async function executarSorteioLoteria(){const e=getHoje();if(3!==e.getDay())return;const a=doc(db,"appState","loteriaLock"),o=getHojeISO();try{const e=await getDoc(a);if(e.exists()){const a=e.data();if(a.ultimoSorteio===o&&"concluido"===a.status)return console.log("Sorteio da loteria j\xE1 realizado e conclu\xEDdo hoje."),void verificarPopupResultadoLoteria();if(a.ultimoSorteio===o&&"processando"===a.status){const e=new Date().getTime(),o=a.timestampInicio?a.timestampInicio.toDate().getTime():0;if(300000>e-o)return void console.log("Sorteio em andamento por outra inst\xE2ncia. Aguardando...");console.warn("\u26A0\uFE0F Detectado sorteio interrompido anteriormente. Reiniciando processo de seguran\xE7a...")}}await setDoc(a,{ultimoSorteio:o,status:"processando",timestampInicio:new Date},{merge:!0}),console.log("\uD83C\uDFB2 Iniciando sorteio da Loteria \xC9pica...");const t=[];for(;4>t.length;){const e=Math.floor(30*Math.random())+1;t.includes(e)||t.push(e)}t.sort((e,a)=>e-a);const n=doc(db,"loteria","estadoAtual"),i=collection(n,"apostasDaEdicao");let r=[],d=0,s=0;await runTransaction(db,async e=>{const a=await e.get(n);d=a.data().premioAcumulado,s=a.data().edicao});const l=query(i,where("edicao","==",s)),m=await getDocs(l);m.forEach(e=>{const a=e.data(),o=a.numeros,n=o.every(e=>t.includes(e));n&&r.push(a.membro)});const c=writeBatch(db);if(0<r.length){const e=Math.floor(d/r.length),a=writeBatch(dbEssencial);r.forEach(o=>{const t=doc(dbEssencial,"membros_essencial",o);a.update(t,{moedas:increment(e)});const n=doc(collection(db,"notificacoes"));c.set(n,{destinatarioId:o,remetenteNome:"Loteria",tipo:"moedas",conteudo:"\uD83D\uDCB0",acao:`PARAB√âNS! Voc√™ acertou na Loteria e ganhou <strong>${e}</strong> moedas!`,lida:!1,timestamp:new Date})}),await a.commit(),c.update(n,{premioAcumulado:0})}else console.log("Nenhum ganhador. Pr\xEAmio acumulado.");const u=t.map(e=>(e+"").padStart(2,"0")).join(" - ");let p="";if(0<r.length){const e=r.map(e=>`<strong>${e}</strong>`).join(", "),a=d.toLocaleString("pt-BR");p=`üî¢ N√∫meros sorteados: <strong>${u}</strong>.<br><br>üéâ <strong>TEMOS GANHADORES!</strong> Parab√©ns a ${e} que acertaram os 4 n√∫meros e dividiram o pr√™mio de <strong>üí∞ ${a} moedas</strong>!`}else p=`üî¢ N√∫meros sorteados: <strong>${u}</strong>.<br><br>üê¢ <strong>ACUMULOU!</strong> Ningu√©m acertou os 4 n√∫meros desta vez. O pr√™mio continua crescendo para a pr√≥xima semana!`;await adicionarEventoAoFeed("geral",`üçÄ Resultado da Loteria (Ed. ${s})`,p,{subtipo:"loteria",ganhadores:r,numeros:t,premio:d}),c.update(n,{historico:arrayUnion({edicao:s,numeros:t,data:new Date,ganhadores:r,premio:d}),edicao:increment(1),totalApostas:0});const g=doc(db,"loteria","resultadoUltimo");c.set(g,{numeros:t,ganhadores:r,premio:d,dataSorteio:o,totalApostasNaEdicao:m.size}),c.set(a,{ultimoSorteio:o,status:"concluido",timestampFim:new Date},{merge:!0}),await c.commit(),console.log("\u2705 Sorteio conclu\xEDdo com sucesso. N\xFAmeros:",t),verificarPopupResultadoLoteria()}catch(e){console.error("Erro no sorteio:",e)}}async function verificarPopupResultadoLoteria(){if(usuarioAceitaPopups()){const e=getHojeISO();try{todosMembros.find(e=>e.nome===currentUser)}catch(a){}if(!window.resultadoLoteriaExibidoAgora){window.resultadoLoteriaExibidoAgora=!0;try{const a=doc(db,"loteria","resultadoUltimo"),o=await getDoc(a);if(o.exists()&&o.data().dataSorteio===e){const a=o.data(),t=document.getElementById("titulo-resultado-loteria"),n=document.getElementById("corpo-resultado-loteria"),i=document.getElementById("confetti-loteria");let r="";a.numeros.forEach(e=>{r+=`<span class="bola-loteria selecionada" style="display:inline-flex; width:40px; height:40px; font-size:1.2rem; margin:5px; cursor:default;">${e}</span>`});let d="";if(!(0<a.ganhadores.length))d=`<p style="color:#e67e22; margin-top:15px;">Ningu√©m acertou! üò≤</p>
                                   <p>O pr√™mio de <strong>üí∞ ${a.premio.toLocaleString("pt-BR")}</strong> ACUMULOU!</p>
                                   <p style="font-style:italic; margin-top:10px;">N√£o desista! Sua sorte pode mudar na pr√≥xima quarta.</p>`;else if(d=`<p style="color:#2ecc71; font-size:1.2rem; margin-top:15px;">üéâ <strong>GANHADORES:</strong> ${a.ganhadores.join(", ")}!</p>
                                   <p>Pr√™mio: üí∞ ${a.premio.toLocaleString("pt-BR")}</p>`,i){i.getContext("2d");dispararConfete()}n.innerHTML=`
                <p>N√∫meros sorteados hoje:</p>
                <div style="display:flex; justify-content:center; margin:10px 0;">${r}</div>
                <p style="font-size:0.9rem; color:#7f8c8d;">Total de apostas: ${a.totalApostasNaEdicao}</p>
                ${d}
            `;const s=`loteria_resultado_${e}`,l=todosMembros.find(e=>e.nome===currentUser);if(l&&l.bloqueiosPopups&&l.bloqueiosPopups[s])return void console.log("Popup Loteria bloqueado pelo usu\xE1rio.");const m=document.getElementById("btn-dont-show-loteria");m&&(m.onclick=async()=>{if(closeModal("popup-resultado-loteria"),currentUser){const e=doc(db,"membros",currentUser);try{await updateDoc(e,{[`bloqueiosPopups.${s}`]:!0}),l&&(!l.bloqueiosPopups&&(l.bloqueiosPopups={}),l.bloqueiosPopups[s]=!0,localStorage.setItem("epicos_cache_membros",JSON.stringify(todosMembros))),mostrarPopup("\u2705 Salvo","Este resultado n\xE3o aparecer\xE1 mais hoje.",2e3)}catch(e){console.error(e)}}}),openModal("popup-resultado-loteria"),window.resultadoLoteriaExibidoAgora=!0}}catch(a){console.error("Erro ao ver resultado loteria:",a)}}}}async function verificarPopupVesperaSorteio(){const e=getHoje();if(2!==e.getDay())return;if(!usuarioAceitaPopups())return;mostrarCardPopup("\uD83C\uDF40 Sorteio Amanh\xE3!","\n      Amanh\xE3 (quarta-feira) ocorrer\xE1 o sorteio da <strong>loteria \xE9pica</strong>! <br><br>\n      N\xE3o se esque\xE7a de entrar na p\xE1gina para conferir o resultado do sorteio e ver se voc\xEA ganhou o grande pr\xEAmio ou se pelo menos acertou algum dos n\xFAmeros sorteados.\n    ",null,"Grupo \xC9picos","aviso_vespera_loteria")}async function verificarNudgesDiarios(e=!1){const a=document.getElementById("auth-container"),o=a&&!a.classList.contains("hidden"),t=document.getElementById("nudge-floating-btn");if(!currentUser||o)return void(t&&(t.classList.add("hidden"),t.style.display="none"));if(t&&(t.style.display=""),!dadosLoteria||void 0===dadosLoteria.premioAcumulado)return void setTimeout(()=>verificarNudgesDiarios(e),2e3);if(!dadosApostasUsuarioCarregados&&3!==getHoje().getDay())return void setTimeout(()=>verificarNudgesDiarios(e),1e3);const n=getHoje(),i=n.getDay();let r=!1;3!==i&&0===minhasApostasEdicao&&(r=!0);let d=!1;dailyClaimedToday||(d=!0);let s=!1;if(currentUser){let e=[];if(e="lider"===userRole?todosMembros.filter(e=>"lider-equipe"===e.papel):"lider-equipe"===userRole?todosMembros.filter(e=>e.equipe===userTeam&&e.nome!==currentUser||"lider"===e.papel):todosMembros.filter(e=>e.equipe===userTeam&&e.nome!==currentUser),0<e.length){const e=getHojeISO(),a=doc(db,"enviosDiarios",`${currentUser}_${e}`);try{const e=await getDoc(a);e.exists()||(s=!0)}catch(a){console.error(a)}}}let l=!1;if(1<=i&&5>=i){const e=getSemanaAtual(),a=`semana_${e.numero}_${e.inicio.getFullYear()}`,o=doc(db,"vantagemSemanal",a);try{const e=await getDoc(o),a=e.exists()?e.data():{};a.completadoPor?.[currentUser]||(l=!0)}catch(a){console.error("Erro nudge vantagem",a)}}if(!r&&!d&&!s&&!l)return t&&t.classList.add("hidden"),void closeModal("modal-nudge-combinado");t&&(t.classList.remove("hidden"),iniciarArrastoNudge());const m=document.getElementById("nudge-conteudo-dinamico");if(m){if(m.innerHTML="",r){const e=new Date(n);e.setDate(n.getDate()+((3-i+7)%7||7));const a=document.createElement("div");a.className="nudge-card loteria",a.innerHTML=`
                <div>
                    <div class="nudge-icon">üçÄ</div>
                    <div class="nudge-titulo">Loteria √âpica</div>
                    <p class="nudge-texto">
                        O pr√™mio acumulou em<br><strong>üí∞ ${dadosLoteria.premioAcumulado.toLocaleString("pt-BR")}</strong>!<br>
                        <small>Sorteio: ${e.toLocaleDateString("pt-BR")}</small>
                    </p>
                </div>
                <button class="auth-btn" style="background-color: #27ae60;" onclick="closeModal('modal-nudge-combinado'); abrirModalAposta();">
                    Fazer Aposta
                </button>
            `,m.appendChild(a)}if(d){const e=getNivelRecompensa(dailyStreakGlobal),a=document.createElement("div");a.className="nudge-card recompensa",a.innerHTML=`
                <div>
                    <div class="nudge-icon">üìÜ</div>
                    <div class="nudge-titulo">Recompensa Di√°ria</div>
                    <p class="nudge-texto">
                        Voc√™ ainda n√£o resgatou seu pr√™mio de hoje.<br>
                        Garanta suas <strong>üí∞ ${e.valor} moedas</strong> e mantenha sua sequ√™ncia!
                    </p>
                </div>
                <button class="auth-btn" style="background-color: #f39c12;" onclick="closeModal('modal-nudge-combinado'); document.getElementById('secao-recompensa-diaria').scrollIntoView({behavior: 'smooth'});">
                    Ir Resgatar
                </button>
            `,m.appendChild(a)}if(s){const e=document.createElement("div");e.className="nudge-card moedas",e.innerHTML=`
                <div>
                    <div class="nudge-icon">üéÅ</div>
                    <div class="nudge-titulo">Presente Di√°rio</div>
                    <p class="nudge-texto">
                        Voc√™ ainda n√£o enviou moedas para sua equipe hoje.<br>
                        √â gratuito e ajuda seus colegas!
                    </p>
                </div>
                <button class="auth-btn" style="background-color: #3498db;" onclick="closeModal('modal-nudge-combinado'); abrirModalEnvioMoedas();">
                    Enviar Agora
                </button>
            `,m.appendChild(e)}if(l){const e=document.createElement("div");e.className="nudge-card vantagem",e.innerHTML=`
                <div>
                    <div class="nudge-icon">üéÆ</div>
                    <div class="nudge-titulo">Jogo da Vantagem</div>
                    <p class="nudge-texto">
                        Ajude sua equipe a garantir o b√¥nus semanal!<br>
                        O desafio desta semana ainda est√° pendente.
                    </p>
                </div>
                <button class="auth-btn" style="background-color: #333;" onclick="closeModal('modal-nudge-combinado'); document.getElementById('advantage-game-board').scrollIntoView({behavior: 'smooth'});">
                    Jogar Agora
                </button>
            `,m.appendChild(e)}}e&&usuarioAceitaPopups()&&openModal("modal-nudge-combinado")}async function executarRotinaDeMeiaNoite(){const e=await verificarSePrecisaAtualizarImediatamente();if(e)return console.warn("\u26D4 Rotina abortada: Cliente desatualizado."),void location.reload(!0);await sincronizarHorarioBrasilia();const a=getHoje(),o=getHojeISO(),t=doc(db,"rotinas_diarias",o);let n=!1;try{await runTransaction(db,async e=>{const a=await e.get(t);if(a.exists()){const e=a.data();if("concluido"===e.status)throw"JA_CONCLUIDO";if("rodando"===e.status){const a=e.inicio?e.inicio.toDate().getTime():0,o=new Date().getTime();if(900000>o-a)throw"EM_ANDAMENTO"}}e.set(t,{status:"rodando",iniciadoPor:currentUser||"sistema",inicio:serverTimestamp(),tentativa:a.exists()?(a.data().tentativa||0)+1:1,detalhes:{limpeza:!1,loteria:!1,resetTemporada:!1,desenhoInicio:"N/A",desenhoFim:"N/A",domingo:!1,feriado:!1}})}),n=!0}catch(e){return"JA_CONCLUIDO"===e?(console.log("\u2705 Rotina j\xE1 consta como conclu\xEDda no banco. Abortando execu\xE7\xE3o local."),void(await atualizarResumo())):"EM_ANDAMENTO"===e?void console.log("\u23F3 Rotina sendo rodada por outro usu\xE1rio. Aguardando..."):void console.error("\u274C Erro de conex\xE3o ao tentar iniciar rotina:",e)}if(n){console.log(`üöÄ Iniciando Rotina de Meia-Noite Oficial para ${o}...`),await setGlobalLock(!0,"\uD83D\uDD5B Atualizando o dia... Aguarde.");try{await executarResetDeTemporada();const e={};e["detalhes.resetTemporada"]=!0,await executarSorteioLoteria(),e["detalhes.loteria"]=!0,await verificarEConcederPremiacaoDiaria(),await Promise.all([processarJurosEAutolimpezaBancos(),limparMensagensDiariasAntigas(),limparLocksAntigosDaArvore(),limparDailyTasksAntigas(),limparRotinasDiariasAntigas(),limparBloqueiosPopupsDeTodos()]),e["detalhes.limpeza"]=!0,folgasManualmenteRemovidas={},await resetarDia(!0),await finalizarSemana();const n=await processarFeriadoDoDia();n&&(e["detalhes.feriado"]=!0);const i=a.getDay();if(4===i){e["detalhes.desenhoInicio"]="Verificado";const a=doc(db,"appState",`temaCheck_${o}`),t=await getDoc(a),n=doc(db,"configuracoes","temaDesenho"),i=await getDoc(n);let r=!1;if(i.exists()){const e=i.data();if(e.ativo&&e.dataGeracao){const a=formatarDataISO(e.dataGeracao.toDate());a===o&&(r=!0)}}t.exists()||(r?e["detalhes.desenhoInicio"]="J\xE1 existia":(await limparTodasAsTelasDeDesenho(),await gerarNovoTemaDesenho(),e["detalhes.desenhoInicio"]="Novo Tema Gerado"),await setDoc(a,{processado:!0}))}if(2===i){e["detalhes.desenhoFim"]="Verificado";const a=getSemanaAtual(),o=`desenho_sem_${a.numero}_${a.inicio.getFullYear()}`,t=await getDoc(doc(dbDesenho,"resultadosDesenho",o));t.exists()?e["detalhes.desenhoFim"]="J\xE1 julgado":(await executarJulgamentoDesenhos(),e["detalhes.desenhoFim"]="Julgamento Executado")}await marcarFolgaColetivaDeDomingo(),0===i&&(e["detalhes.domingo"]=!0),0!==i&&(await executarMarcacaoAutomaticaDeFolgasDoDia()),await updateDoc(t,{status:"concluido",fim:serverTimestamp(),...e}),console.log("\u2705 Rotina finalizada e salva com sucesso.")}catch(e){console.error("\u274C Erro DURANTE a execu\xE7\xE3o da rotina:",e);try{await updateDoc(t,{status:"erro",erroMsg:e.toString()})}catch(a){}}finally{await setGlobalLock(!1),gerenciarEventosAgendadosDoOraculo(),atualizarDataCabecalho(),atualizarInfoSemana(),await carregarPontosSemanais(),atualizarPlacarSemanal(),await carregarArvoreEpica(),await atualizarResumo()}}}function calcularPascoa(e){const o=e%19,a=Math.floor(e/100),t=e%100,n=Math.floor(a/4),r=Math.floor((a+8)/25),d=Math.floor((a-r+1)/3),s=(19*o+a-n-d+15)%30,c=Math.floor(t/4),i=(32+2*(a%4)+2*c-s-t%4)%7,l=Math.floor((o+11*s+22*i)/451),m=Math.floor((s+i-7*l+114)/31)-1;return new Date(e,m,(s+i-7*l+114)%31+1)}function formatarDiaMes(e){const a=(e.getDate()+"").padStart(2,"0"),o=(e.getMonth()+1+"").padStart(2,"0");return`${a}/${o}`}let cacheFeriadosManuais={};async function verificarDataEspecial(e){const a=(e.getDate()+"").padStart(2,"0"),o=(e.getMonth()+1+"").padStart(2,"0"),t=e.getFullYear(),n=`${a}/${o}`,i=`${t}-${o}-${a}`,r={"01/01":"Confraterniza\xE7\xE3o Universal","08/03":"Dia Internacional da Mulher","21/04":"Tiradentes","01/05":"Dia do Trabalhador","12/06":"Dia dos Namorados","07/09":"Independ\xEAncia do Brasil","12/10":"Nossa Senhora Aparecida","15/10":"Dia dos Professores","02/11":"Dia de Finados","15/11":"Proclama\xE7\xE3o da Rep\xFAblica","20/11":"Dia da Consci\xEAncia Negra","24/12":"V\xE9spera de Natal","25/12":"Natal","31/12":"V\xE9spera de Ano Novo"},d=calcularPascoa(t),s=new Date(d);s.setDate(d.getDate()-2);const l=new Date(d);l.setDate(d.getDate()+60);const m=new Date(d);m.setDate(d.getDate()-46);const c=new Date(d);c.setDate(d.getDate()-47);const u=new Date(d);u.setDate(d.getDate()-48);const p=new Date(d);p.setDate(d.getDate()-50);const g=new Date(d);g.setDate(d.getDate()-51);const f={[formatarDiaMes(d)]:"Domingo de P\xE1scoa",[formatarDiaMes(s)]:"Sexta-feira Santa",[formatarDiaMes(l)]:"Corpus Christi",[formatarDiaMes(m)]:"Quarta-feira de Cinzas",[formatarDiaMes(c)]:"Carnaval",[formatarDiaMes(u)]:"Carnaval (Ponto Facultativo)",[formatarDiaMes(p)]:"S\xE1bado de Carnaval",[formatarDiaMes(g)]:"Sexta de Carnaval"};if(r[n])return r[n];if(f[n])return f[n];if(cacheFeriadosManuais[i])return cacheFeriadosManuais[i];try{const e=doc(db,"configuracoes","feriadosManuais"),a=await getDoc(e);if(a.exists()){const e=a.data();if(Object.assign(cacheFeriadosManuais,e),e[i])return e[i]}}catch(a){console.warn("Erro ao verificar feriados manuais:",a)}return null}async function gerarConteudoMuralComIA(e){if(!genAI)return{texto:"A const\xE2ncia \xE9 a ponte entre o desejo e a realiza\xE7\xE3o. Mantenham o foco. \u2014 Or\xE1culo.",cor:"#A0C4FF"};const a=getHoje(),o=getDiaSemanaString(a),t=a.getDay(),n=0===t,i=2===t,r=await verificarDataEspecial(a);let d=null,s=[];if("manha"===e){const e=a.getDate(),o=a.getMonth()+1;if(s=todosMembros.filter(a=>{if(!a.aniversario)return!1;const[t,n]=a.aniversario.split("/").map(Number);return t===e&&n===o}),0<s.length){console.log("Or\xE1culo: Aniversariante(s) detectado(s)! Modo Celebra\xE7\xE3o Ativado \uD83C\uDF89");const e=s.map(e=>e.nome).join(" e "),a=s.map(e=>{let a=`${e.nome} (G√™nero: ${e.genero||"Indefinido"})`;return e.sonho&&(a+=` - Sonho: ${e.sonho}`),e.apelido&&(a+=` - Apelido: ${e.apelido}`),a}).join("; ");d={id:"aniversario_especial",alvo:"geral",desc:`HOJE √â ANIVERS√ÅRIO DE: ${a}. Escreva uma mensagem emocionante e inspiradora de parab√©ns em nome de todo o Grupo √âpicos. Destaque a import√¢ncia dessa pessoa para o grupo. Deseje que o novo ciclo traga a realiza√ß√£o de seus sonhos. Seja carinhoso e festivo.`,nomesAniversariantes:e}}}let l={manha:[{id:"elogio_foco_matinal",alvo:"unico",dadoNecessario:["filme","sonho","musica","curiosidade","apelido"],desc:"ELOGIO PESSOAL: Elogie um membro que tem sido constante, mas focando na personalidade dele."},{id:"incentivo_geral_manha",alvo:"geral",desc:"BOM DIA GERAL: Mensagem curta e energ\xE9tica para o grupo acordar. Foco em renova\xE7\xE3o e oportunidade."},{id:"curiosidade_membro",alvo:"unico",dadoNecessario:["curiosidade"],desc:"CURIOSIDADE: Comente sobre a curiosidade pessoal de um membro. Crie uma analogia motivacional baseada nessa curiosidade."},{id:"desafio_do_dia",alvo:"geral",desc:"DESAFIO R\xC1PIDO: Proponha uma mini-meta filos\xF3fica para o dia (ex: sorrir mais, beber \xE1gua, um ato de gentileza)."},{id:"foco_competicao_manha",alvo:"geral",desc:"FOCO NA COMPETI\xC7\xC3O: Incentive as equipes a come\xE7arem o dia pontuando."}],tarde:[{id:"reflexao_tarde",alvo:"geral",desc:"REFLEX\xC3O TARDE: Incentive a persist\xEAncia p\xF3s-almo\xE7o. O dia ainda n\xE3o acabou."},{id:"analise_placar_tarde",alvo:"geral",desc:"AN\xC1LISE DO PLACAR: Comente brevemente sobre como as m\xE9dias das equipes est\xE3o."},{id:"foco_top5_tarde",alvo:"geral",desc:"FOCO NO TOP 5: Mencione que a disputa pelo Top 5 da semana est\xE1 acirrada."},{id:"lembrete_pendente_tarde_geral",alvo:"geral",desc:"LEMBRETE DE APOIO (TARDE): Mande uma mensagem gentil para o @todos."},{id:"comentar_desenho",desc:"COMENTAR DESENHO: Comente sobre o progresso de um dos desenhos das equipes."}],noite:[{id:"agradecimento_noite",alvo:"geral",desc:"BOA NOITE: Agrade\xE7a o esfor\xE7o do grupo. Destaque um acontecimento positivo da semana."},{id:"elogio_aleatorio",alvo:"unico",dadoNecessario:["apelido","me chamo"],desc:"SURPRESA: Escolha um membro aleat\xF3rio e fale sobre o quanto ele \xE9 importante para o grupo."},{id:"incentivo_amanha_geral",alvo:"geral",desc:"INCENTIVO PARA AMANH\xC3: Envie uma mensagem de esperan\xE7a para quem teve um dia dif\xEDcil."},{id:"parabens_focaram_hoje_geral",alvo:"geral",desc:"PARAB\xC9NS GERAL: D\xEA os parab\xE9ns a todos que conseguiram focar hoje."},{id:"reflexao_noturna",desc:"REFLEX\xC3O NOTURNA: Uma mensagem curta sobre descanso e prepara\xE7\xE3o para o dia seguinte."}]};if(i){const a=dadosLoteria.premioAcumulado?dadosLoteria.premioAcumulado.toLocaleString("pt-BR"):"Muitas";l[e]&&l[e].push({id:"lembrete_loteria",alvo:"geral",desc:`AMANH√É √â DIA DE SORTEIO DA LOTERIA: O pr√™mio est√° em üí∞ ${a} moedas! Lembre os membros de fazerem suas apostas antes do sorteio. Deseje boa sorte a todos.`})}if(i&&"manha"===e){let a="uma das equipes",o=!1;try{const e=`desenho_sem_${c.numero}_${c.inicio.getFullYear()}`,t=doc(dbDesenho,"resultadosDesenho",e),n=await getDoc(t);if(n.exists()){o=!0;const e=n.data();if(e.semParticipacao)a="ningu\xE9m (Decep\xE7\xE3o: n\xE3o houve participa\xE7\xE3o)";else if(e.ranking&&0<e.ranking.length){const o=e.ranking.sort((e,a)=>a.total-e.total),t=o[0];a=`a Equipe ${t.equipe.charAt(0).toUpperCase()+t.equipe.slice(1)}`}}}catch(a){console.warn("Or\xE1culo: Erro ao buscar vencedor do desenho:",a)}if(o){const o={id:"comentario_resultado_desenho",alvo:"geral",desc:`RESULTADO DA BATALHA DE DESENHOS: O resultado oficial saiu!
              A GRANDE VENCEDORA FOI: ${a}.
              
              INSTRU√á√ïES OBRIGAT√ìRIAS:
              1. Parabenize EXPLICITAMENTE ${a} pela vit√≥ria.
              2. N√ÉO INVENTE EMPATES. O banco de dados diz se s√≥ houve um vencedor.
              3. Comente que a criatividade e talento s√£o impressionantes.
              4. Avise que Quinta-feira sai o novo tema.`};l[e]=[o]}}if(4===t){l[e]&&l[e].push({id:"aviso_novo_tema_desenho",alvo:"geral",desc:"NOVO TEMA DE DESENHO: Hoje \xE9 Quinta-feira, dia de novo tema na Batalha de Desenhos! Incentive as equipes a correrem para a tela de pintura. Diga que est\xE1 ansioso para ver o que a imagina\xE7\xE3o deles vai criar."})}if(n&&(console.log("Or\xE1culo: Modo Domingo Ativado \uD83C\uDF1E"),l={manha:[{id:"domingo_bom_dia",alvo:"geral",desc:"DOMINGO DE PAZ: Deseje um bom dia de descanso. Lembre que hoje \xE9 dia de recarregar as energias e que a folga coletiva \xE9 merecida."},{id:"domingo_reflexao",alvo:"geral",desc:"REFLEX\xC3O DE DOMINGO: Diga aos membros o quanto \xE9 importante e necess\xE1rio se conectar com o descanso de hoje."}],tarde:[{id:"domingo_tarde_leve",alvo:"geral",desc:"TARDE LEVE: Sugira que aproveitem a tarde para hobbies, fam\xEDlia ou apenas n\xE3o fazer nada."},{id:"domingo_preparacao",alvo:"geral",desc:"MENTALIDADE: Comente que o descanso de hoje \xE9 o combust\xEDvel para a vit\xF3ria de amanh\xE3."}],noite:[{id:"domingo_boa_semana",alvo:"geral",desc:"PREPARA\xC7\xC3O PARA SEGUNDA: Deseje uma \xF3tima semana que vai come\xE7ar. Diga que est\xE1 ansioso para ver o foco de todos amanh\xE3."},{id:"domingo_gratidao",alvo:"geral",desc:"GRATID\xC3O: Agrade\xE7a pela semana que passou e pela uni\xE3o do grupo."}]}),r&&"manha"===e){console.log(`Or√°culo: Modo Feriado Ativado (${r}) üéâ`);l[e]=[{id:"feriado_especial",alvo:"geral",dadoNecessario:[],desc:`DATA COMEMORATIVA MUITO IMPORTANTE: Hoje √© ${r}. 
              INSTRU√á√ÉO ESPECIAL: Escreva uma mensagem profunda, educativa e inspiradora sobre a import√¢ncia hist√≥rica e cultural deste dia. 
              N√£o seja superficial. Dedique 2 a 3 par√°grafos para falar sobre o tema.
              Fale DIRETAMENTE e OBRIGATORIAMENTE para o grupo todo (utilizando '@todos'), sem mencionar membros individuais espec√≠ficos para n√£o desviar o foco da causa.
              Termine com uma mensagem de reflex√£o sobre como esse dia nos torna humanos melhores.`}]}let m=[];try{const e=query(collection(db,"mural"),where("userId","==","Or\xE1culo"),orderBy("timestamp","desc"),limit(10)),a=await getDocs(e);a.forEach(e=>m.push(e.data().cor))}catch(a){console.warn("Erro ao buscar cores recentes:",a)}const c=getSemanaAtual(),u=`oraculoTopics_${c.numero}_${c.inicio.getFullYear()}`,p=doc(db,"appState",u);let g=[];try{const e=await getDoc(p);e.exists()&&(g=e.data().cenariosUsados||[])}catch(a){console.warn("Erro ao buscar hist\xF3rico de t\xF3picos:",a)}const f=`oraculoHistory_semana_${c.numero}_${c.inicio.getFullYear()}`,h=doc(db,"appState",f);let v=[];try{const e=await getDoc(h);e.exists()&&(v=e.data().mencionados||[])}catch(a){console.warn("Erro ao buscar hist\xF3rico de men\xE7\xF5es:",a)}const E=getHojeISO(),y=getDiaSemanaString().toLowerCase().replace(/-feira$/,"").normalize("NFD").replace(/[\u0300-\u036f]/g,"");let b=[];try{const e=await getDoc(doc(db,"presencas",E));e.exists()&&(b=Object.keys(e.data()))}catch(a){console.warn("Erro ao buscar quem focou hoje:",a)}let I="Ningu\xE9m completou ainda.";try{const e=getSemanaAtual(),a=`semana_${e.numero}_${e.inicio.getFullYear()}`,o=doc(db,"vantagemSemanal",a),t=await getDoc(o);if(t.exists()&&t.data().completadoPor){const e=t.data().completadoPor,a=Object.entries(e).map(([e,a])=>({nome:e,tempo:a.toDate()})).sort((e,a)=>e.tempo-a.tempo);0<a.length&&(I=a.map((e,a)=>`${a+1}¬∫: ${e.nome}`).join(", "))}}catch(a){console.warn("Erro ao buscar dados do Jogo da Vantagem:",a)}let C="Nenhum evento importante registrado ainda.";feedEventosCache&&0<feedEventosCache.length&&(C=feedEventosCache.slice(0,5).map(e=>{const a=e.texto.replace(/<[^>]*>/g," ");return`- ${e.titulo}: ${a.trim()}`}).join("\n"));const x=document.getElementById("media-abelha")?.textContent||"N/A",B=document.getElementById("media-joaninha")?.textContent||"N/A",A=document.getElementById("media-vagalume")?.textContent||"N/A",q=todosMembros.filter(e=>!v.includes(e.nome)),S=q.map(e=>{let a="(Pendente)";const o=e.folga?e.folga.toLowerCase().replace(/-feira$/,"").normalize("NFD").replace(/[\u0300-\u036f]/g,""):"";e.deFerias?"saude"===e.motivoAusencia?a="(EM RECUPERA\xC7\xC3O DE SA\xDADE - Deseje melhoras!)":a="(De F\xE9rias)":o===y?a="(De Folga)":b.includes(e.nome)&&(a="(Focou Hoje)");let t="Tratamento: Neutro/O";"feminino"===e.genero?t="USAR OBRIGATORIAMENTE: A / ELA / DELA / NA":"masculino"===e.genero&&(t="USAR OBRIGATORIAMENTE: O / ELE / DELE / NO");const n=e.equipe?e.equipe.toUpperCase():"SEM EQUIPE";return`- ${e.nome} [EQUIPE: ${n}] (${t}, Nome Real: ${e["me chamo"]||"N/A"}, Status: ${a})`}).join("\n"),D=`
---
INFORMA√á√ïES EM TEMPO REAL (ESTADO ATUAL DO GRUPO):
- Data de Hoje: ${o}

Lista de Membros DISPON√çVEIS PARA MEN√á√ÉO (Use o 'Nome Real' para g√™nero e o 'Status' para l√≥gica):
${S||"Ningu\xE9m dispon\xEDvel para mencionar."}
---
Placar da Competi√ß√£o Semanal (M√âDIA NIVELADA):
- Equipe Abelha: ${x} pontos de m√©dia.
- Equipe Joaninha: ${B} pontos de m√©dia.
- Equipe Vaga-lume: ${A} pontos de m√©dia.
Ranking Geral de Vit√≥rias:
- Equipe Abelha: ${rankingGeral.abelha} vit√≥rias.
- Equipe Joaninha: ${rankingGeral.joaninha} vit√≥rias.
- Equipe Vaga-lume: ${rankingGeral.vagalume} vit√≥rias.
Status do Jogo da Vantagem (quem terminou primeiro):
- ${I}
Acontecimentos Recentes (Resumo da Semana):
${C}
---
- Voc√™ s√≥ tem acesso aos membros que ainda n√£o foram mencionados esta semana.
---
  `;let T=null,F=null,k=null;if(d)T=d;else{let a=l[e]||[],o=a.filter(e=>"unico"===e.alvo&&!g.includes(e.id));o.sort(()=>.5-Math.random());let t=q.filter(e=>"lider"!==e.papel);embaralharArray(t);for(const e of o){for(const a of t){const o=e.dadoNecessario.find(e=>a[e]&&""!==a[e].trim());if(o){T=e,F=a,k={tipo:o,valor:a[o]};break}}if(T)break}if(!T){let e=a.filter(e=>"geral"===e.alvo&&!g.includes(e.id));0===e.length&&(e=a.filter(e=>"geral"===e.alvo)),T=e[Math.floor(Math.random()*e.length)]}}let M=`
    Voc√™ √© o "Or√°culo", o mentor s√°bio (cerca de 50 anos), acolhedor e carinhoso do "Grupo √âpicos".
    Sua tarefa √© escrever uma mensagem curta para o mural do grupo para o per√≠odo da '${e}'.

    REGRAS DE PERSONALIDADE (MENTOR ACOLHEDOR):
    1.  Use um tom que demonstre cuidado e apoio.
    2.  NUNCA se revele como uma IA. Aja 100% como uma pessoa.
    3.  Assine sempre com "‚Äî Or√°culo".
    4.  **N√ÉO SEJA REPETITIVO:** Evite come√ßar suas frases com "Lembrei...". Varie suas introdu√ß√µes.

    REGRAS DE FORMATA√á√ÉO E CONTE√öDO (OBRIGAT√ìRIAS):
    1.  **ENDERE√áAMENTO:** Use o "Nome de Usu√°rio" (o nome ANTES do par√™ntese).
    2.  **FORMATA√á√ÉO:** Use @NomeDoMembro. (Ex: @Max)
    3.  **PROIBI√á√ÉO:** NUNCA use o "Nome Real" diretamente na mensagem.
    4.  **BLINDAGEM GRAMATICAL DE G√äNERO (CR√çTICO):** - Ao escolher um membro, LEIA a etiqueta "(USAR OBRIGATORIAMENTE: ...)".
        - Se estiver escrito "A / ELA", voc√™ EST√Å PROIBIDO de escrever "O @Nome". Deve escrever "A @Nome", "O foco da @Nome", "A @Nome fez".
        - Se estiver escrito "O / ELE", deve escrever "O @Nome", "O foco do @Nome".
        - **Erro proibido:** "O @Geraldinne" (sendo mulher) ou "O @Kaii" (sendo mulher). Confie na etiqueta fornecida.
    5.  **REGRA DO @todos (SINTAXE):**
        - O termo "@todos" funciona como um vocativo ou pronome coletivo direto.
        - **ERRADO (NUNCA USE):** "O @todos", "A @todos", "Do @todos", "Para o @todos". (N√£o use artigos definidos antes de @todos).
        - **CERTO (USE ASSIM):** "Ol√°, @todos!", "Que @todos tenham um bom dia", "A for√ßa de @todos n√≥s", "Conto com @todos".
    6.  **3¬™ PESSOA (REGRA DE OURO):** No Mural, voc√™ fala **SOBRE** o membro para o grupo, nunca **COM** o membro.
        -   ERRADO: "Parab√©ns @Max, voc√™ mandou bem!" (Isso √© 2¬™ pessoa).
        -   CERTO: "O @Max mandou muito bem hoje!" (Isso √© 3¬™ pessoa).
        -   SEMPRE use: "Ele fez", "A @Ana conseguiu", "O foco dele". NUNCA use "Voc√™".
	7.  **CONTEXTUALIZA√á√ÉO:** Contextualize a informa√ß√£o pessoal na frase.
	8.  **L√ìGICA DE DOMINGO (MUITO IMPORTANTE):** ${n?"HOJE \xC9 DOMINGO (FOLGA COLETIVA). Voc\xEA est\xE1 ESTRITAMENTE PROIBIDO de falar sobre 'come\xE7ar o dia focando', 'pontuar para a equipe' ou 'disputa no Top 5'. Fale apenas sobre descanso, repor energias, paz, fam\xEDlia e prepara\xE7\xE3o mental para a segunda-feira.":""}
    9.  **L√ìGICA DE FERIADO:** ${r?`Hoje √© feriado de ${r}. Se o cen√°rio escolhido permitir, mencione o esp√≠rito desta data.`:""}
    10.  **L√ìGICA DE FOCO:** Verifique o Status (Focou, Pendente, F√©rias, Folga) antes de elogiar o foco.
    11.  **MEN√á√ïES DE EQUIPE:** Use @equipeAbelha, @equipeJoaninha, ou @equipeVagalume.
	12.  **MEMBROS DOENTES:** Se escolher mencionar um membro com status "(EM RECUPERA√á√ÉO DE SA√öDE)", sua mensagem DEVE ser de apoio, carinho e desejando melhoras. Diga para ele descansar e n√£o se preocupar com o foco.
	13. **VERIFICA√á√ÉO DE LEALDADE (CR√çTICO):** Antes de escrever que um membro "impulsionou", "ajudou" ou "pontuou" para uma equipe, VOC√ä √â OBRIGADO a olhar a "Lista de Membros DISPON√çVEIS" fornecida acima.
        - Verifique qual √© a equipe desse membro (ex: Duda -> Vaga-lume).
        - Se o membro for da Vaga-lume, √© IMPOSS√çVEL ele impulsionar a Joaninha.
        - Se voc√™ cometer esse erro, a mensagem ser√° invalidada. Garanta que o membro e a equipe mencionada combinem.
    
    CORES USADAS RECENTEMENTE (EVITE USAR ESTAS): ${m.join(", ")||"Nenhuma"}
    
    **REGRA DE MEN√á√ÉO OBRIGAT√ìRIA:** Todas as suas postagens devem conter pelo menos uma men√ß√£o (@MembroAlvo ou @todos).
  `;M+=d?`
---
    üö® TAREFA ESPECIAL DE ANIVERS√ÅRIO üö®
    
    INSTRU√á√ÉO PRIORIT√ÅRIA: ${T.desc}
    
    Lembre-se de mencionar os aniversariantes com a formata√ß√£o @NomeDoMembro.
    Esta mensagem deve ser mais longa e elaborada que o normal (3 a 4 paragr√°fos cheios de emo√ß√£o).
    Fa√ßa com que eles se sintam realmente especiais e abra√ßados pelo grupo.
---
      `:F?`
---
    SUA TAREFA DE HOJE (Cen√°rio: ${T.id}):
    - Membro Alvo: ${F.nome}
    - G√™nero: ${F.genero||"Indefinido"}
    
    INFORMA√á√ÉO PESSOAL:
    - Pergunta: "${{"me chamo":"Eu me chamo",apelido:"Meu apelido \xE9",filme:"Meu filme favorito",sonho:"Meu maior sonho atualmente",musica:"Uma m\xFAsica que gosto muito",curiosidade:"Uma curiosidade aleat\xF3ria sobre mim"}[k.tipo]||k.tipo}"
    - Resposta: "${k.valor}"

    INSTRU√á√ÉO: Escreva uma mensagem curta (1-2 frases) baseada na descri√ß√£o: "${T.desc}".
    Contexto Adicional:
    ${D}
---
    `:`
---
    SUA TAREFA DE HOJE (Cen√°rio: ${T.id}):
    INSTRU√á√ÉO: Escreva uma mensagem curta (1-3 frases) para todo o grupo, baseada na descri√ß√£o: "${T.desc}".
    
    Contexto Geral:
    ${D}
---
    `,M+=`
    FORMATO DA RESPOSTA (OBRIGAT√ìRIO):
    Sua resposta DEVE ser um JSON v√°lido no formato:
    {
      "texto": "SUA_MENSAGEM_AQUI",
      "cor": "#CODIGO_HEX_DA_COR"
    }
  `;try{const e=await callGenerativeAIWithRetry(M),a=e.match(/{[\s\S]*}/);if(!a)throw new Error("JSON n\xE3o encontrado na resposta da IA.");const o=a[0],t=JSON.parse(o);if(t.texto&&t.cor){await setDoc(p,{cenariosUsados:arrayUnion(T.id)},{merge:!0});const e=new Set;let a=0,o;for(;null!==(o=/@([\w√°√©√≠√≥√∫√Å√â√ç√ì√ö√¢√™√Æ√¥√ª√Ç√ä√é√î√õ√†√®√¨√≤√π√Ä√à√å√í√ô√£√µ√É√ï√ß√á]+)/gu.exec(t.texto));){if(a++,50<a){console.warn("Or\xE1culo: Loop de extra\xE7\xE3o de men\xE7\xF5es interrompido por seguran\xE7a (Anti-Travamento).");break}const t=o[1];"todos"===t||"Or\xE1culo"===t||t.startsWith("equipe")||e.add(t)}0<s.length?s.forEach(a=>e.add(a.nome)):F&&e.add(F.nome);const n=Array.from(e);0<n.length&&(await setDoc(h,{mencionados:arrayUnion(...n)},{merge:!0}));let i="\uD83E\uDDD9\u200D Uma Mensagem do Or\xE1culo",r=0<n.length?n[0]:null,l;d?(i="\uD83C\uDF89 Homenagem de Anivers\xE1rio!",l=`O <strong>Or√°culo</strong> deixou uma mensagem muito especial de anivers√°rio no mural para <strong>${s.map(e=>e.nome).join(" e ")}</strong>. N√£o deixe de ler!`):r?l=`O <strong>Or√°culo</strong> compartilhou uma nova mensagem no mural mencionando <strong>${r}</strong>${1<n.length?" e outros":""}. D√™ uma olhada!`:l="O <strong>Or\xE1culo</strong> compartilhou uma nova mensagem no mural. D\xEA uma olhada!";const m=await adicionarEventoAoFeed("geral",i,l,{nomeMembro:"Or\xE1culo"});return{texto:t.texto,cor:t.cor,feedEventId:m}}throw new Error("Formato de JSON inv\xE1lido.")}catch(e){throw console.error("Erro no Or\xE1culo:",e),e}}async function obterPalavrasDaSemanaComIA(){if(!genAI)return console.warn("IA n\xE3o inicializada. Usando palavras de fallback."),["Foco","Sucesso","Alegria","Paz","Amor","Luz","For\xE7a"];const e=getSemanaAtual(),a=`palavrasDaSemana_${e.inicio.getFullYear()}_${e.numero}`,o=doc(db,"appState",a);try{const e=await getDoc(o);if(e.exists()){const a=e.data().palavras;return console.log(`Or√°culo: Palavras da semana j√° existem. Retornando lista completa.`),a}console.log("Or\xE1culo: Gerando novas 7 palavras positivas para a semana...");const a=genAI.getGenerativeModel({model:"gemini-2.5-flash-lite"}),t=await a.generateContent("\n      Sua \xFAnica tarefa \xE9 gerar uma lista de 7 palavras positivas e inspiradoras em portugu\xEAs do Brasil.\n      As palavras devem ser curtas e motivacionais, como \"Sucesso\", \"Conquista\", \"Determina\xE7\xE3o\", \"Resili\xEAncia\", etc.\n      Sua resposta DEVE ser um JSON v\xE1lido no formato: {\"palavras\": [\"PALAVRA1\", \"PALAVRA2\", \"PALAVRA3\", \"PALAVRA4\", \"PALAVRA5\", \"PALAVRA6\", \"PALAVRA7\"]}.\n      N\xE3o inclua nenhuma outra explica\xE7\xE3o ou formata\xE7\xE3o. Apenas o JSON puro.\n    "),n=await t.response,i=n.text().trim(),r=i.match(/{[\s\S]*}/);if(!r)throw new Error("A IA n\xE3o retornou um JSON v\xE1lido. Resposta recebida: "+i);const d=r[0],s=JSON.parse(d),l=s.palavras;if(!Array.isArray(l)||7!==l.length)throw new Error("A IA n\xE3o retornou um array com 7 palavras.");return await setDoc(o,{palavras:l}),console.log("Or\xE1culo: Novas palavras salvas para a semana:",l),l}catch(e){return console.error("Erro ao obter as palavras da semana:",e),["Supera\xE7\xE3o","Coragem","Vit\xF3ria","Inspira\xE7\xE3o","Energia","Sonhos","Conex\xE3o"]}}function embaralharArrayComSemente(e,a){const o=[...e];for(let t=o.length-1;0<t;t--){const e=(t*a+a%5)%(t+1);[o[t],o[e]]=[o[e],o[t]]}return o}function atualizarDataCabecalho(){const e=getHoje(),a=e.toLocaleDateString("pt-BR",{weekday:"long",day:"numeric",month:"long"}),o=document.getElementById("dataHoje");o&&(o.textContent=a.charAt(0).toUpperCase()+a.slice(1))}function getDatasTemporada(e){function a(e){const a=new Date(e,0,1),o=a.getDay(),t=new Date(a);return 0===o?t.setDate(a.getDate()+1):t.setDate(a.getDate()-(o-1)),t}const o=a(e),t=a(e+1),n=new Date(t);return n.setDate(n.getDate()-1),{inicio:formatarData(o),fim:formatarData(n)}}function atualizarInfoSemana(){const e=getSemanaAtual(),a=document.getElementById("info-semana");if(a){const o=new Date(e.fim),t=new Date(o);t.setDate(t.getDate()+1);const n=(t.getDate()+"").padStart(2,"0"),i=(t.getMonth()+1+"").padStart(2,"0"),r=e.inicio.getFullYear(),d=1===e.numero&&11===new Date().getMonth()?ANO_ATUAL+1:ANO_ATUAL,s=getDatasTemporada(d);a.innerHTML=`
        <div class="info-semana-grid">
            
            <div class="info-semana-block">
                <h3>Temporada ${d}</h3>
                <div class="info-semana-datas">${s.inicio} a ${s.fim}</div>
                <div class="info-semana-detalhe">Ciclo Competitivo</div>
            </div>

            <div class="info-semana-block">
                <h3>Semana Atual</h3>
                <div class="info-semana-destaque">Semana ${e.numero}</div>
                <div class="info-semana-datas">${e.inicioFormatado} a ${e.fimFormatado}</div>
                <div class="info-semana-detalhe">
                    üèÅ Encerra: S√°bado (${e.fimCompeticao})<br>
                    üèÜ Resultado: Domingo (${`${n}/${i}`})
                </div>
            </div>

        </div>
      `}const o=document.getElementById("ano-temporada-atual");if(o){const a=1===e.numero&&11===new Date().getMonth()?ANO_ATUAL+1:ANO_ATUAL;o.textContent=`(Temporada ${a})`}}function isColorDark(e){const a="#"===e.charAt(0)?e.substring(1,7):e,o=parseInt(a.substring(0,2),16),t=parseInt(a.substring(2,4),16),n=parseInt(a.substring(4,6),16);return 128>.299*o+.587*t+.114*n}async function openMessageViewer(a){unsubscribeViewerListener&&(unsubscribeViewerListener(),unsubscribeViewerListener=null);const o=document.getElementById("message-viewer-modal");openModal("message-viewer-modal"),o.dataset.activeMessageId=a;const t=doc(db,"mural",a);unsubscribeViewerListener=onSnapshot(t,e=>{if(!e.exists())return void closeModal("message-viewer-modal");const t=e.data(),n=document.getElementById("viewer-card"),i=document.getElementById("viewer-text"),r=document.getElementById("viewer-author"),d=document.getElementById("viewer-timestamp"),s=document.getElementById("viewer-reacoes-container"),l=t.timestamp.toDate();n.style.backgroundColor=t.cor,r.textContent=t.nome,d.textContent=`${l.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"})} - ${l.toLocaleDateString("pt-BR")}`;let m=t.texto||"";m=m.replace(/@([\w√°√©√≠√≥√∫√Å√â√ç√ì√ö√¢√™√Æ√¥√ª√Ç√ä√é√î√õ√†√®√¨√≤√π√Ä√à√å√í√ô√£√µ√É√ï√ß√á]+)/g,"<span class=\"mention\">@$1</span>"),i.innerHTML=m,isColorDark(t.cor)?n.classList.add("text-light"):n.classList.remove("text-light");const c=t.reacoes||{};let u="",p=!1;const g=Object.keys(c).sort((e,a)=>(c[a]?.length||0)-(c[e]?.length||0));for(const o of g){const e=Array.isArray(c[o])?c[o]:[];if(0<e.length){p=!0;const t=e.includes(currentUser),n=t?"reacted":"",i=0<e.length?`Reagido por: ${e.join(", ")}`:`Reagir com ${o}`;u+=`<div class="reacao-display ${n}" title="${i}" data-emoji="${o}" onclick="window.abrirModalReagentes('${a}', '${o}')">${o} <span class="contador-display">${e.length}</span></div>`}}s.innerHTML=u,s.style.display=p?"flex":"none";const f=o.querySelector(".reacao-seletor-bar");f.innerHTML="",EMOJIS_MURAL.forEach(o=>{const t=document.createElement("button");t.textContent=o,t.onclick=t=>{t.stopPropagation(),window.toggleReacao(a,o,t)},f.appendChild(t)}),f.classList.remove("hidden")})}async function confirmDelete(){if(!messageIdToDelete)return;const e=doc(db,"mural",messageIdToDelete);let a=null;try{const o=await getDoc(e);if(o.exists()){const t=o.data();a=t.userId;const n=writeBatch(db),i=t.feedEventId;i&&n.delete(doc(db,"resumoSemanalFeed",i));const r=t.mentionNotificationIds||[];if(0<r.length&&r.forEach(e=>{n.delete(doc(db,"notificacoes",e))}),a&&"An\xF4nimo"!==a&&"Or\xE1culo"!==a){const e=doc(dbEssencial,"membros_essencial",a);updateDoc(e,{moedas:increment(-5)}).catch(a=>console.error("Erro ao aplicar penalidade:",a))}n.delete(e),await n.commit()}mostrarPopup("\u2705 Sucesso","Mensagem e notifica\xE7\xF5es relacionadas foram exclu\xEDdas!",3e3),a===currentUser&&(console.log("Removendo progresso de postagem para:",currentUser),await reverterProgressoProtecao("postar",messageIdToDelete))}catch(e){mostrarPopup("\u274C Erro","Falha ao excluir a mensagem.",3e3),console.error("Erro ao excluir:",e)}finally{closeModal("confirm-delete-modal"),messageIdToDelete=null}}function openMessageComposer(e=null){const a=document.getElementById("composer-send-btn");if(e){document.getElementById("composer-textarea").value=e.texto;const o="An\xF4nimo"===e.nome;document.getElementById("composer-anonymous-check").checked=o,document.getElementById("composer-author").textContent=o?"An\xF4nimo":currentUser,selectComposerColor(e.cor),a.textContent="Salvar Altera\xE7\xF5es"}else document.getElementById("composer-textarea").value="",document.getElementById("composer-anonymous-check").checked=!1,document.getElementById("composer-author").textContent=currentUser,selectComposerColor("#CAFFBF"),a.textContent="Enviar",composerEditMode=!1,editingMessageId=null;updateComposerTimestamp(),composerTimestampInterval=setInterval(updateComposerTimestamp,1e3),openModal("message-composer-modal")}function closeMessageComposer(){clearInterval(composerTimestampInterval),closeModal("message-composer-modal"),composerEditMode=!1,editingMessageId=null}window.formatText=function(e){document.execCommand(e,!1,null),document.getElementById("composer-textarea").focus()};function updateComposerTimestamp(){const e=new Date,a=e.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"}),o=e.toLocaleDateString("pt-BR");document.getElementById("composer-timestamp").textContent=`${a} - ${o}`}function selectComposerColor(e){composerSelectedColor=e;const a=document.getElementById("composer-card"),o=document.getElementById("composer-color-btn");a.style.backgroundColor=e,o.style.backgroundColor=e,isColorDark(e)?(a.classList.add("text-light"),o.classList.add("text-light")):(a.classList.remove("text-light"),o.classList.remove("text-light")),document.getElementById("composer-color-palette").classList.add("hidden")}window.enviarMensagem=async function(){const e=document.getElementById("composer-send-btn"),a=e.textContent,o=document.getElementById("composer-anonymous-check").checked,t=o?"An\xF4nimo":currentUser,n=document.getElementById("composer-textarea"),i=n.innerHTML.trim(),r=n.innerText.trim();if(!r||"<br>"===i)return void mostrarPopup("\u270D\uFE0F Aten\xE7\xE3o","Digite uma mensagem.",3e3);const d={nome:t,texto:i,cor:composerSelectedColor,userId:currentUser};try{if(e.textContent="\u23F3",e.disabled=!0,composerEditMode&&editingMessageId){const e=doc(db,"mural",editingMessageId);await updateDoc(e,d),mostrarPopup("\u2705 Sucesso","Mensagem editada!",3e3)}else{if("lider"!==userRole){const e=query(collection(db,"mural"),where("userId","==",currentUser)),a=await getDocs(e);if(3<=a.size)return void mostrarPopup("\uD83D\uDEAB Limite Atingido","Voc\xEA j\xE1 postou o m\xE1ximo de 3 mensagens. Apague uma antiga para poder postar uma nova.",5e3)}const e=r.match(/@([\w√°√©√≠√≥√∫√Å√â√ç√ì√ö√¢√™√Æ√¥√ª√Ç√ä√é√î√õ√†√®√¨√≤√π√Ä√à√å√í√ô√£√µ√É√ï√ß√á]+)/g)?.map(e=>e.substring(1))||[],a=new Set;0<e.length&&e.forEach(e=>{if("todos"===e.toLowerCase())todosMembros.forEach(e=>{e.nome!==currentUser&&a.add(e.nome)});else if(e.toLowerCase().startsWith("equipe")){const o=e.substring(6).toLowerCase();equipes[o]&&equipes[o].membros.forEach(e=>{e.nome!==currentUser&&a.add(e.nome)})}else{const o=todosMembros.find(a=>a.nome.toLowerCase()===e.toLowerCase());o&&o.nome!==currentUser&&a.add(o.nome)}});let n;if(0<a.size){const e=Array.from(a).slice(0,2);let o=`<strong>${e.join("</strong> e <strong>")}</strong>`;2<a.size&&(o+=` e outros`),n=`<strong>${t}</strong> compartilhou uma nova mensagem mencionando ${o}. D√™ uma olhada!`}else n=o?"<strong>Um an\xF4nimo</strong> compartilhou uma nova mensagem no mural. D\xEA uma olhada!":`<strong>${t}</strong> compartilhou uma nova mensagem no mural. D√™ uma olhada!`;const i=await adicionarEventoAoFeed("geral","\u270D\uFE0F Nova Mensagem no Mural!",n,{nomeMembro:t});i&&(d.feedEventId=i),d.timestamp=new Date,d.reacoes=EMOJIS_MURAL.reduce((e,a)=>({...e,[a]:[]}),{}),d.semana=getSemanaAtual().numero;const s=writeBatch(db),l=doc(collection(db,"mural"));if(s.set(l,d),0<a.size){const e=`"${r.substring(0,30)}..."`;a.forEach(a=>{const o=doc(collection(db,"notificacoes"));s.set(o,{destinatarioId:a,remetenteNome:currentUser,tipo:"mural-mention",conteudo:"\uD83D\uDCAC",acao:`mencionou voc√™ em uma mensagem: ${e}`,lida:!1,timestamp:new Date})})}await s.commit(),await updateDoc(doc(dbEssencial,"membros_essencial",currentUser),{moedas:increment(recompensasConfig.postarMural||5)}),mostrarPopup("\u2705 Sucesso","Mensagem enviada!",3e3),atualizarProgressoProtecao("postar",l.id),tocarSom("som-envio"),mostrarPopupMoedas(recompensasConfig.postarMural||5),setTimeout(()=>{executarInteracaoImediataOraculo(l.id,r,currentUser)},3e3)}closeMessageComposer()}catch(e){console.error("Erro:",e),mostrarPopup("\u274C Erro","Ocorreu um erro.",3e3)}finally{e&&(e.textContent=a,e.disabled=!1),composerEditMode=!1,editingMessageId=null}},window.abrirAssistenteOraculo=function(){openModal("oracle-assistant-modal")},window.executarAcaoAssistenteIA=async function(e){if(!genAI)return void mostrarPopup("\u274C Erro","O assistente de IA n\xE3o est\xE1 dispon\xEDvel no momento.",4e3);const a=document.getElementById("composer-textarea"),o=a.innerText;let t="";switch(e){case"sugerir":if(!o)return void mostrarPopup("\u270D\uFE0F Aten\xE7\xE3o","Escreva algo primeiro para que eu possa sugerir uma continua\xE7\xE3o.",4e3);t=`Sua √∫nica tarefa √© completar o texto a seguir, agindo como o Or√°culo (s√°bio, direto, po√©tico). Continue a escrita EXATAMENTE de onde o texto parou.

REGRAS IMPORTANTES:
- N√ÉO ofere√ßa m√∫ltiplas op√ß√µes.
- N√ÉO escreva nenhuma introdu√ß√£o, explica√ß√£o ou coment√°rio ("Aqui est√° uma continua√ß√£o...", "Op√ß√£o 1:", etc.).
- Sua resposta deve ser APENAS a continua√ß√£o direta do texto, sem repetir a parte que j√° foi escrita.

Texto para completar:
"${o}"`;break;case"resumir":if(!o)return void mostrarPopup("\u270D\uFE0F Aten\xE7\xE3o","N\xE3o h\xE1 texto para resumir.",3e3);t=`Resuma o seguinte texto em uma ou duas frases curtas e objetivas:\n\n"${o}"`;break;case"corrigir":if(!o)return void mostrarPopup("\u270D\uFE0F Aten\xE7\xE3o","N\xE3o h\xE1 texto para corrigir.",3e3);t=`Corrija a ortografia e a gram√°tica do texto a seguir, mantendo a inten√ß√£o original. Retorne apenas o texto corrigido:\n\n"${o}"`;break;case"tonalizar":if(!o)return void mostrarPopup("\u270D\uFE0F Aten\xE7\xE3o","Escreva algo primeiro para que eu possa alterar o tom.",4e3);t=`Reescreva o texto a seguir com a personalidade do Or√°culo: s√°bio, um pouco misterioso e direto. Retorne apenas o texto reescrito:\n\n"${o}"`;break;default:return;}closeModal("oracle-assistant-modal"),mostrarPopup("\uD83E\uDDD9\u200D Or\xE1culo","O Or\xE1culo est\xE1 conjurando as palavras...",3e3);try{const o=genAI.getGenerativeModel({model:"gemini-2.5-flash-lite"}),n=await o.generateContent(t),i=await n.response;let r=i.text();"sugerir"===e?a.innerHTML+=`<br><br>${r.replace(/\n/g,"<br>")}`:a.innerHTML=r.replace(/\n/g,"<br>"),mostrarPopup("\u2705 Pronto!","A sugest\xE3o do Or\xE1culo foi aplicada.",3e3)}catch(e){console.error("Erro na a\xE7\xE3o do assistente de IA:",e),mostrarPopup("\u274C Erro","O Or\xE1culo n\xE3o conseguiu processar sua solicita\xE7\xE3o.",4e3)}},window.editarMensagem=async function(e,a){document.getElementById("global-options-menu").classList.add("hidden"),e.stopPropagation(),composerEditMode=!0,editingMessageId=a;try{const e=await getDoc(doc(db,"mural",a));e.exists()&&openMessageComposer(e.data())}catch(e){console.error("Erro ao buscar mensagem para editar:",e)}},window.excluirMensagem=function(e,a){document.getElementById("global-options-menu").classList.add("hidden"),e.stopPropagation(),messageIdToDelete=a,openModal("confirm-delete-modal")};function createColorPalette(){const e=document.getElementById("composer-color-palette");e&&(e.innerHTML="",["#FFFFFF","#FADADD","#FFD6A5","#FDFFB6","#CAFFBF","#9BF6FF","#A0C4FF","#BDB2FF","#FFC6FF","#EAE4E9","#D4E09B","#C3E0E5","#F7D6E0","#F3E9DD","#D3E4CD","#FF1744","#F50057","#D500F9","#651FFF","#3D5AFE","#2979FF","#00B0FF","#00E5FF","#1DE9B6","#00E676","#76FF03","#C6FF00","#FFEA00","#FFC400","#FF9100","#FF3D00","#F38375","#FBC42C","#57C479","#57C5C8","#578DC8","#8A57C8","#C857B2","#4B4A49","#ACACAC","#795548","#607D8B","#000000","#E57373","#BA68C8","#7986CB","#4FC3F7","#4DB6AC","#AED581","#FFF176","#FFB74D","#A1887F","#90A4AE","#008F93","#F08080","#20B2AA","#87CEEB","#9370DB","#DA70D6"].forEach(a=>{const o=document.createElement("div");o.className="composer-color-option",o.style.backgroundColor=a,o.title=a,o.onclick=()=>selectComposerColor(a),e.appendChild(o)}))}function criarElementoMensagem(a){const o=a.cor||"#ffdde1",t=a.timestamp,n=t.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"}),i=t.toLocaleDateString("pt-BR"),r=document.createElement("div");r.className="mensagem",r.style.backgroundColor=o,r.dataset.id=a.id,r.dataset.fullText=a.texto||"",r.style.setProperty("--card-bg-color",o),isColorDark(o)&&r.classList.add("text-light");let d=a.texto||"";d=d.replace(/@([\w√°√©√≠√≥√∫√Å√â√ç√ì√ö√¢√™√Æ√¥√ª√Ç√ä√é√î√õ√†√®√¨√≤√π√Ä√à√å√í√ô√£√µ√É√ï√ß√á]+)/g,"<span class=\"mention\">@$1</span>");const s=a.reacoes||{};let l="",m=!1;const c=Object.keys(s).sort((e,a)=>(s[a]?.length||0)-(s[e]?.length||0));for(const e of c){const o=Array.isArray(s[e])?s[e]:[];if(0<o.length){m=!0;const t=o.includes(currentUser),n=t?"reacted":"",i=0<o.length?`Reagido por: ${o.join(", ")}`:`Seja o primeiro a reagir com ${e}`;l+=`<div class="reacao-display ${n}" title="${i}" data-emoji="${e}" onclick="window.abrirModalReagentes('${a.id}', '${e}')">${e} <span class="contador-display">${o.length}</span></div>`}}const u=m?`<div class="reacoes-display-container">${l}</div>`:"";let p="";(a.userId===currentUser||"lider"===userRole)&&(p=`<div class="message-options-container"><button class="options-btn" onclick="window.openOptionsMenu(event, 'message', '${a.id}')">‚ãÆ</button></div>`);const g=document.createElement("div");g.innerHTML=d;const f=g.textContent||g.innerText||"",h=100<f.length,v=h?"texto-truncado":"";r.innerHTML=`
    <div class="mensagem-texto ${v}"><span class="texto-mascarado">${d}</span></div>
    ${u}
    <div class="mensagem-info">
      <div>
        <div class="mensagem-autor">${a.nome}</div>
        <div class="mensagem-data">${n} - ${i}</div>
      </div>
      <div class="mensagem-actions">
        <div class="comment-indicator" title="Coment√°rios">
          üí¨ <span class="comment-count">${a.commentCount||0}</span>
        </div>
        ${p}
      </div>
    </div>
    <div class="reacao-seletor-bar hidden">
      ${EMOJIS_MURAL.map(e=>`<button onclick="event.stopPropagation(); window.toggleReacao('${a.id}', '${e}', event)">${e}</button>`).join("")}
    </div>
  `;const E=r.querySelector(".comment-indicator");E&&E.addEventListener("click",e=>{e.stopPropagation(),window.openCommentsModal(a.id)});let y=null,b=!1,I=!1;const C=a=>{a.target.closest("button, a, .reacao-display, .mention")||(b=!1,I=!1,y=setTimeout(()=>{b=!0;const e=r.querySelector(".reacao-seletor-bar");if(e){e.classList.remove("hidden");const a=o=>{(!r.contains(o.target)||o.target.closest(".reacao-seletor-bar button"))&&(e.classList.add("hidden"),document.removeEventListener("click",a))};setTimeout(()=>document.addEventListener("click",a),100)}},500))},x=()=>clearTimeout(y),B=o=>{clearTimeout(y),b||I||o.target.closest("button, a, .reacao-display, .comment-indicator, .mention")||openMessageViewer(a.id)},A=()=>{clearTimeout(y),I=!0};return r.addEventListener("mousedown",C),r.addEventListener("mouseup",B),r.addEventListener("mouseleave",x),r.addEventListener("touchstart",C,{passive:!0}),r.addEventListener("touchend",B),r.addEventListener("touchmove",A),r}function configurarMuralTempoReal(){const e=document.getElementById("mural-mensagens");if(e){0===e.children.length&&(e.innerHTML="<div class=\"carregando\">Carregando mensagens...</div>"),window.listenersAtivos.mural&&window.listenersAtivos.mural();const a=query(collection(db,"mural"),orderBy("timestamp","desc"),limit(10));window.listenersAtivos.mural=onSnapshot(a,a=>{const o=[];return a.forEach(e=>{const a=e.data();o.push({id:e.id,...a,timestamp:a.timestamp.toDate?a.timestamp.toDate():new Date(1e3*a.timestamp.seconds)})}),o.sort((e,a)=>a.timestamp-e.timestamp),e.innerHTML="",0===o.length?void(e.innerHTML="<div class=\"sem-mensagens\">Nenhuma mensagem ainda. Seja o primeiro a escrever!</div>"):void o.forEach(a=>{e.appendChild(criarElementoMensagem(a))})})}}async function adicionarReacaoComoOraculo(e,a){console.log(`Or√°culo: Reagindo com ${a} √† mensagem ${e}`);const o=doc(db,"mural",e);try{await runTransaction(db,async e=>{const t=await e.get(o);if(!t.exists())throw"Documento n\xE3o existe!";const n=t.data();let i=n.reacoes||{};for(const a in i)if(Array.isArray(i[a])){const e=i[a].indexOf("Or\xE1culo");-1<e&&i[a].splice(e,1)}i[a]||(i[a]=[]),i[a].includes("Or\xE1culo")||i[a].push("Or\xE1culo"),e.update(o,{reacoes:i})})}catch(e){console.error(`Or√°culo: Falha ao adicionar rea√ß√£o:`,e)}}window.toggleReacao=function(e,a,o){if(o&&o.stopPropagation(),!currentUser)return;atualizarReacaoOtimista("#mural-mensagens",e,a),tocarSom("som-reacao");const t=doc(db,"mural",e),n=doc(db,"membros",currentUser);let i,r;runTransaction(db,async e=>{const o=await e.get(t);if(!o.exists())throw"Documento n\xE3o existe!";const n=o.data();i=n.userId,r=`"${n.texto.substring(0,30)}..."`;let d=n.reacoes||{},s=n.reactionFeedEvents||{},l=n.reactionNotificationIds||{};const m=`${currentUser}_${a}`;let c=null,u=0,p=!1;for(const a in d)if(Array.isArray(d[a])&&d[a].includes(currentUser)){c=a;break}if(c){const a=`${currentUser}_${c}`;s[a]&&(e.delete(doc(db,"resumoSemanalFeed",s[a])),delete s[a]),l[a]&&(e.delete(doc(db,"notificacoes",l[a])),delete l[a])}if(c===a){const e=d[a].indexOf(currentUser);-1<e&&(d[a].splice(e,1),u=-1,p=!0)}else{if(c){const e=d[c].indexOf(currentUser);-1<e&&d[c].splice(e,1)}else u=1;d[a]||(d[a]=[]),d[a].push(currentUser)}if(1===u&&i&&i!==currentUser){const o=collection(db,"notificacoes"),t=doc(o);e.set(t,{destinatarioId:i,remetenteNome:currentUser,tipo:"mural",conteudo:a,acao:`reagiu √† sua mensagem: ${r}`,lida:!1,timestamp:new Date}),l[m]=t.id}return e.update(t,{reacoes:d,reactionFeedEvents:s,reactionNotificationIds:l}),{deveCriarFeed:1===u,removeuReacao:p,moedaDiff:u}}).then(async e=>{0!==e.moedaDiff&&(await updateDoc(doc(dbEssencial,"membros_essencial",currentUser),{moedas:increment(e.moedaDiff*(recompensasConfig.reagirConteudo||1))}).catch(a=>console.error("Erro ao creditar moeda de rea\xE7\xE3o:",a)))}).then(async e=>{if(e.removeuReacao?await reverterProgressoProtecao("reagir"):e.deveCriarFeed&&(await atualizarProgressoProtecao("reagir")),e.deveCriarFeed&&i&&i!==currentUser){const e=`<strong>${currentUser}</strong> reagiu com ${a} √† mensagem de <strong>${i}</strong> no Mural de Mensagens.`,o=await adicionarEventoAoFeed("geral","\uD83D\uDC4D Nova Rea\xE7\xE3o no Mural!",e,{nomeMembro:currentUser,autorMensagem:i});if(o){const e=`${currentUser}_${a}`;await updateDoc(t,{[`reactionFeedEvents.${e}`]:o})}}}).catch(e=>{console.error("Falha na transa\xE7\xE3o de rea\xE7\xE3o do mural: ",e),mostrarPopup("\u274C Ops!","Sua rea\xE7\xE3o n\xE3o p\xF4de ser salva. Por favor, recarregue a p\xE1gina.",4e3)})};async function obterRankingSemanal(e=new Date){try{const a=getSemanaAtual(e),o=formatarDataISO(a.inicio),t=formatarDataISO(a.fim),n=query(collection(dbEssencial,"presencas"),where("__name__",">=",o),where("__name__","<=",t)),i=await getDocs(n),r={};todosMembros.forEach(e=>{r[e.nome]={pontos:0,tempoTotal:0}}),i.forEach(e=>{const a=e.data();for(const[o,t]of Object.entries(a))r[o]&&t&&(r[o].pontos+=1,t&&t.toDate&&(r[o].tempoTotal+=t.toDate().getTime()))});const d=Object.entries(r).map(([e,a])=>({nome:e,pontos:a.pontos,tempoTotal:a.tempoTotal})).sort((e,a)=>a.pontos===e.pontos?0===e.tempoTotal?1:0===a.tempoTotal?-1:e.tempoTotal-a.tempoTotal:a.pontos-e.pontos);return d}catch(e){return console.error("Erro ao obter o ranking semanal:",e),[]}}async function carregarTop5Semana(){try{const e=await obterRankingSemanal(getHoje()),a=0<e.length&&0<e[0].pontos;if(!a){const e=document.getElementById("ranking-top-lista");e&&(e.innerHTML="<div class=\"ranking-item\">Ainda n\xE3o h\xE1 dados esta semana</div>");const a=doc(db,"appState","rankingState"),o=await getDoc(a);return void(o.exists()&&(await deleteDoc(a)))}const o=doc(db,"appState","rankingState"),t=e.slice(0,3).map(e=>e.nome),n=t.join(",");await runTransaction(db,async e=>{const a=await e.get(o),i=a.exists()?a.data().top3:null;if(n!==i){console.log("Mudan\xE7a no Top 5 detectada. Atualizando o feed...");const a=i?i.split(",")[0]:null,r=t[0];let d=r===a?`<strong>${r}</strong> permanece na lideran√ßa do Top 5 da semana!`:`<strong>${r}</strong> assumiu a lideran√ßa do Top 5 da semana!`;const s=1<t.length?t[1]:null,l=2<t.length?t[2]:null;return s&&l?d+=` Em seguida temos <strong>${s}</strong> em 2¬∫ e <strong>${l}</strong> em 3¬∫.`:s&&(d+=` Seguido por <strong>${s}</strong> em 2¬∫ lugar.`),e.set(o,{top3:n}),{deveAdicionarFeed:!0,titulo:"\uD83D\uDD25 Disputa no Top 5!",texto:d,dados:{nomeLider:r}}}return{deveAdicionarFeed:!1}}).then(async e=>{e.deveAdicionarFeed&&(await adicionarEventoAoFeed("geral",e.titulo,e.texto,e.dados))});const i=document.getElementById("ranking-top-lista");if(!i)return;i.innerHTML="";const r=e.slice(0,5);r.forEach((e,a)=>{if(0!==e.pontos){const o=a+1;let t=1===o?"\uD83E\uDD47":2===o?"\uD83E\uDD48":3===o?"\uD83E\uDD49":"\u2B50";const n=document.createElement("div");n.className="ranking-item",n.style.setProperty("--i",a),n.innerHTML=`
        <div class="ranking-posicao">${t} ${o}¬∫</div>
        <div class="ranking-nome">${e.nome}</div>
        <div class="ranking-pontos">${e.pontos} dias</div>
      `,i.appendChild(n)}}),0===i.children.length&&(i.innerHTML="<div class=\"ranking-item\">Ainda n\xE3o h\xE1 dados esta semana</div>")}catch(e){console.error("Erro ao carregar ou transacionar o top 5:",e)}}async function carregarMembros(){console.log("\u26A0\uFE0F Redirecionando carregarMembros para carregarDadosEssenciais..."),await carregarDadosEssenciais()}function carregarInformacoesMembros(){try{const e=document.getElementById("carrossel-container"),a=document.getElementById("carrossel-indicadores");if(!e)return;e.innerHTML="",a&&(a.innerHTML="");const o=todosMembros.map(e=>({id:e.nome,...e}));totalSlides=o.length,document.getElementById("botao-pausa")&&(document.getElementById("botao-pausa").textContent="\u23F8"),o.forEach((o,t)=>{const n=o,i=document.createElement("div");i.className="card-membro",i.id=`card-membro-${o.id}`;const r=n.corCard||"#FFFFFF";i.style.backgroundColor=r,isColorDark(r)?i.classList.add("text-light"):i.classList.remove("text-light");const d=currentUser===o.id,s=d?"":"hidden";i.innerHTML=`
        <div class="card-controls ${s}">
          <button class="card-color-chooser-btn" onclick="toggleColorPalette(event, '${o.id}')">Escolha a cor</button>
          <div id="palette-${o.id}" class="card-color-palette hidden">
          </div>
        </div>
        <h3>${o.id}</h3>
        <div class="subtitulo">coisas sobre mim</div>
        <div class="info-item">
          <div class="info-content"><strong>Eu me chamo:</strong> <span id="info-${o.id}-me chamo">${n["me chamo"]||"N\xE3o informado"}</span></div>
          <button class="edit-info-btn ${s}" onclick="editarInformacao(event, '${o.id}', 'me chamo')">‚úèÔ∏è</button>
        </div>
        <div class="info-item">
          <div class="info-content"><strong>Meu apelido √©:</strong> <span id="info-${o.id}-apelido">${n.apelido||"N\xE3o informado"}</span></div>
          <button class="edit-info-btn ${s}" onclick="editarInformacao(event, '${o.id}', 'apelido')">‚úèÔ∏è</button>
        </div>
        <div class="info-item">
          <div class="info-content"><strong>Meu filme favorito:</strong> <span id="info-${o.id}-filme">${n.filme||"N\xE3o informado"}</span></div>
          <button class="edit-info-btn ${s}" onclick="editarInformacao(event, '${o.id}', 'filme')">‚úèÔ∏è</button>
        </div>
        <div class="info-item">
          <div class="info-content"><strong>Meu maior sonho atualmente:</strong> <span id="info-${o.id}-sonho">${n.sonho||"N\xE3o informado"}</span></div>
          <button class="edit-info-btn ${s}" onclick="editarInformacao(event, '${o.id}', 'sonho')">‚úèÔ∏è</button>
        </div>
        <div class="info-item">
          <div class="info-content"><strong>Uma m√∫sica que gosto muito:</strong> <span id="info-${o.id}-musica">${n.musica||"N\xE3o informado"}</span></div>
          <button class="edit-info-btn ${s}" onclick="editarInformacao(event, '${o.id}', 'musica')">‚úèÔ∏è</button>
        </div>
        <div class="info-item">
          <div class="info-content"><strong>Uma curiosidade aleat√≥ria sobre mim:</strong> <span id="info-${o.id}-curiosidade">${n.curiosidade||"N\xE3o informado"}</span></div>
          <button class="edit-info-btn ${s}" onclick="editarInformacao(event, '${o.id}', 'curiosidade')">‚úèÔ∏è</button>
        </div>
      `;const l=isColorDark(r),m=i.querySelector(".card-color-chooser-btn");if(m&&(m.style.color=l?"white":"black",m.style.borderColor=l?"white":"black"),e.appendChild(i),d&&criarPaletaDeCoresDoCard(o.id),a){const e=document.createElement("div");e.className="carrossel-indicador",e.onclick=()=>{window.reiniciarIntervaloCarrossel&&reiniciarIntervaloCarrossel(),irParaSlide(t)},a.appendChild(e)}}),0<totalSlides&&(document.querySelector(".carrossel-indicador")?.classList.add("ativo"),irParaSlide(0),1<totalSlides&&window.iniciarCarrosselAutomatico&&iniciarCarrosselAutomatico())}catch(e){console.error("Erro ao carregar informa\xE7\xF5es dos membros:",e)}}window.editarInformacao=async function(e,a,o){e.stopPropagation();const t=document.getElementById(`info-${a}-${o}`);if(!t)return;const n=t.textContent;t.contentEditable=!0,t.classList.add("editing"),t.focus(),document.execCommand("selectAll",!1,null);const i=async()=>{t.contentEditable=!1,t.classList.remove("editing"),t.removeEventListener("blur",i),t.removeEventListener("keydown",r);const e=t.textContent.trim();if(e===n||""===e)return void(t.textContent=n);try{const t=doc(db,"membros",a);await updateDoc(t,{[o]:e}),await forcarAtualizacaoCacheGlobal(),mostrarPopup("\u2705 Sucesso",`Informa√ß√£o atualizada!`,3e3)}catch(e){console.error("Erro ao atualizar informa\xE7\xE3o:",e),mostrarPopup("\u274C Erro","Ocorreu um erro ao salvar.",4e3),t.textContent=n}},r=a=>{"Enter"===a.key?(a.preventDefault(),i()):"Escape"===a.key&&(t.textContent=n,i())};t.addEventListener("blur",i),t.addEventListener("keydown",r)},window.toggleColorPalette=function(e,a){e.stopPropagation();const o=document.getElementById(`palette-${a}`);o.classList.toggle("hidden")};function criarPaletaDeCoresDoCard(e){const a=document.getElementById(`palette-${e}`);if(a){a.innerHTML="",["#FFFFFF","#FADADD","#FFD6A5","#FDFFB6","#CAFFBF","#9BF6FF","#A0C4FF","#BDB2FF","#FFC6FF","#EAE4E9","#D4E09B","#C3E0E5","#F7D6E0","#F3E9DD","#D3E4CD","#FF1744","#F50057","#D500F9","#651FFF","#3D5AFE","#2979FF","#00B0FF","#00E5FF","#1DE9B6","#00E676","#76FF03","#C6FF00","#FFEA00","#FFC400","#FF9100","#FF3D00","#F38375","#FBC42C","#57C479","#57C5C8","#578DC8","#8A57C8","#C857B2","#4B4A49","#ACACAC","#795548","#607D8B","#000000","#E57373","#BA68C8","#7986CB","#4FC3F7","#4DB6AC","#AED581","#FFF176","#FFB74D","#A1887F","#90A4AE","#008F93","#F08080","#20B2AA","#87CEEB","#9370DB","#DA70D6"].forEach(o=>{const t=document.createElement("div");t.className="card-color-option",t.style.backgroundColor=o,t.onclick=a=>selecionarCorDoCard(a,e,o),a.appendChild(t)})}}async function selecionarCorDoCard(e,a,o){e.stopPropagation();try{const e=doc(db,"membros",a);await updateDoc(e,{corCard:o}),await forcarAtualizacaoCacheGlobal();const t=document.getElementById(`card-membro-${a}`);if(t){t.style.backgroundColor=o,isColorDark(o)?t.classList.add("text-light"):t.classList.remove("text-light");const e=isColorDark(o),a=t.querySelector(".card-color-chooser-btn");a&&(a.style.color=e?"white":"black",a.style.borderColor=e?"white":"black")}const n=document.getElementById(`palette-${a}`);n&&n.classList.add("hidden"),mostrarPopup("\uD83C\uDFA8 Sucesso","A cor do seu card foi alterada!",3e3)}catch(e){console.error("Erro ao salvar cor do card:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel salvar a cor.",4e3)}}async function marcarConcluido(e,a,o,t){const n=document.getElementById(`task-${e}-${a}-${o}`),i=n?n.dataset.memberTeam:null;if(!podeMarcarCheckbox(e,i))return mostrarPopup("Erro","Voc\xEA n\xE3o tem permiss\xE3o para marcar/desmarcar esta tarefa.",3e3),void(n&&(n.checked=!t));const r=doc(db,"membros",e),d=`focoDiario.${o}.${a}`,s=`focoDia.${o}`;try{if(await runTransaction(db,async e=>{const n=await e.get(r);if(!n.exists())throw new Error("Membro n\xE3o encontrado.");const i=n.data(),l=i.focoDiario&&i.focoDiario[o]&&i.focoDiario[o][a];t&&!l?e.update(r,{[d]:!0,[s]:increment(1)}):!t&&l&&e.update(r,{[d]:!1,[s]:increment(-1)})}),i&&void 0!==pontosSemanais[i]){const e=doc(dbEssencial,"semanas","pontosSemanais"),a=t?1:-1;await updateDoc(e,{[i]:increment(a)}),pontosSemanais[i]+=a}console.log("Atualiza\xE7\xE3o conclu\xEDda com sucesso!"),mostrarPopup("Sucesso","Tarefa atualizada!",2e3),await verificarConquista(e,t?"adicionar":"remover"),await window.atualizarResumo()}catch(e){console.error("Erro ao atualizar a tarefa: ",e),mostrarPopup("Erro",`Erro ao atualizar: ${e.message||e}`,3e3),n&&(n.checked=!t)}}window.togglePausa=function(){carrosselPausado=!carrosselPausado;const e=document.getElementById("botao-pausa");if(carrosselPausado){clearInterval(carrosselInterval),e.textContent="\u25B6";const a=document.getElementById("progresso-indicador-barra");a&&(a.style.transition="none",a.dataset.width=a.style.width)}else{e.textContent="\u23F8";const a=document.getElementById("progresso-indicador-barra");a&&(a.style.transition="width 10s linear",a.style.width=a.dataset.width||"100%"),iniciarCarrosselAutomatico()}};function iniciarBarraProgresso(){const e=document.getElementById("progresso-indicador-barra");e&&(e.style.transition="none",e.style.width="0%",void e.offsetWidth,e.style.transition="width 10s linear",setTimeout(()=>{carrosselPausado||(e.style.width="100%")},10),progressoBarra&&clearTimeout(progressoBarra),progressoBarra=setTimeout(()=>{e.style.width="0%"},1e4))}window.mudarSlide=function(e){reiniciarIntervaloCarrossel();const a=document.querySelectorAll(".card-membro").length;0===a||(currentCarrosselIndex=(currentCarrosselIndex+e+a)%a,irParaSlide(currentCarrosselIndex))};function irParaSlide(e){const a=document.getElementById("carrossel-container");a.style.transform=`translateX(-${100*e}%)`;const o=document.querySelectorAll("#carrossel-indicadores .carrossel-indicador");o.forEach((a,o)=>{a.classList.toggle("ativo",o===e)}),currentCarrosselIndex=e,carrosselPausado||iniciarBarraProgresso()}function iniciarCarrosselAutomatico(){carrosselInterval&&clearInterval(carrosselInterval),carrosselInterval=setInterval(()=>{0<totalSlides&&!carrosselPausado&&(currentCarrosselIndex=(currentCarrosselIndex+1)%totalSlides,irParaSlide(currentCarrosselIndex))},1e4),iniciarBarraProgresso()}function reiniciarIntervaloCarrossel(){clearInterval(carrosselInterval),iniciarCarrosselAutomatico(),iniciarBarraProgresso()}async function carregarHallDaFama(){console.log("Carregando Hall da Fama...");try{hallDaFamaCache=[];const e=query(collection(db,"hallDaFama"),orderBy("ano","desc")),a=await getDocs(e);a.forEach(e=>{hallDaFamaCache.push(e.data())}),console.log(`Encontrados ${hallDaFamaCache.length} campe√µes no Hall da Fama.`),construirCarrosselHallDaFama()}catch(e){console.error("Erro ao carregar Hall da Fama:",e),construirCarrosselHallDaFama()}}function construirCarrosselHallDaFama(){const e=document.getElementById("carrossel-container-hall-fama"),a=document.getElementById("carrossel-indicadores-hall-fama"),o=document.getElementById("controles-hall-fama"),t=document.getElementById("progresso-hall-fama");if(!e)return;e.innerHTML="",a&&(a.innerHTML="");let n=ANO_ATUAL;const i=hallDaFamaCache.some(e=>e.ano==ANO_ATUAL);i&&(n=ANO_ATUAL+1);const r=document.createElement("div");if(r.className="card-hall-fama placeholder",r.innerHTML=`
    <div class="card-hall-ano">Temporada ${n}</div>
    
    <div class="card-hall-equipe" style="flex-direction: column; gap: 5px;">
      <span class="card-hall-emoji">üèÜ</span>
      <span class="card-hall-nome">Aguardando Campe√£</span>
    </div>
    <div class="card-hall-vitorias">A competi√ß√£o est√° em andamento!</div>
  `,e.appendChild(r),hallDaFamaCache.forEach(a=>{const o=document.createElement("div");let t=a.vencedora;t="string"==typeof t?[t.toLowerCase()]:t.map(e=>e.toLowerCase());const n={abelha:{cor:"#fffbeb",border:"#f1c40f",emoji:"\uD83D\uDC1D",nome:"Abelha"},joaninha:{cor:"#ffebee",border:"#e74c3c",emoji:"\uD83D\uDC1E",nome:"Joaninha"},vagalume:{cor:"#e8f5e9",border:"#2ecc71",emoji:"\uD83D\uDCA1",nome:"Vaga-lume"}};let i="",r="";if(o.className="card-hall-fama",1<t.length){o.classList.add("empate");const e=(100/t.length).toFixed(2);let a=[],d=[];t.forEach((o,s)=>{const l=n[o]||{cor:"#ffffff",border:"#000",emoji:"\uD83C\uDFC6",nome:o};a.push(`${l.cor} ${s*e}% ${(s+1)*e}%`),d.push(l.border),i+=`<span class="card-hall-emoji multi">${l.emoji}</span>`;const m=l.nome;r+=(0===s?"":s===t.length-1?" e ":", ")+m}),o.style.background=`linear-gradient(90deg, ${a.join(", ")})`,o.style.borderWidth="4px",o.style.borderStyle="solid",2===t.length?(o.style.borderTopColor=d[0],o.style.borderLeftColor=d[0],o.style.borderRightColor=d[1],o.style.borderBottomColor=d[1]):(o.style.borderTopColor=d[0],o.style.borderRightColor=d[1],o.style.borderBottomColor=d[2],o.style.borderLeftColor=d[0])}else{const e=t[0];o.classList.add(e);const a=n[e]||{emoji:"\uD83C\uDFC6",nome:e};i=`<span class="card-hall-emoji">${a.emoji}</span>`,r=`Equipe ${a.nome}`,o.style.background="",o.style.borderColor="",o.style.borderWidth=""}o.innerHTML=`
      <div class="card-hall-ano">Temporada ${a.ano}</div>
      <div class="card-hall-equipe-container">
        <div class="card-hall-emojis-wrapper">
            ${i}
        </div>
        <span class="card-hall-nome ${1<t.length?"multi-nome":""}">${r}</span>
      </div>
      <div class="card-hall-vitorias">${1<t.length?"Co-Campe\xE3s":"Campe\xE3"} com ${a.vitorias} vit√≥rias!</div>
    `,e.appendChild(o)}),totalSlidesHallDaFama=e.children.length,1<totalSlidesHallDaFama){a&&(a.style.display="flex"),o&&(o.style.display="flex"),t&&(t.style.display="block");for(let e=0;e<totalSlidesHallDaFama;e++){const o=document.createElement("div");o.className="carrossel-indicador",o.onclick=()=>{reiniciarIntervaloCarrosselHallDaFama(),irParaSlideHallDaFama(e)},a&&a.appendChild(o)}document.querySelector("#carrossel-indicadores-hall-fama .carrossel-indicador")?.classList.add("ativo"),iniciarCarrosselAutomaticoHallDaFama()}else a&&(a.style.display="none"),o&&(o.style.display="none"),t&&(t.style.display="none");irParaSlideHallDaFama(0)}function iniciarCarrosselAutomaticoHallDaFama(){carrosselHallDaFamaInterval&&clearInterval(carrosselHallDaFamaInterval);1>=totalSlidesHallDaFama||(carrosselHallDaFamaInterval=setInterval(()=>{carrosselHallDaFamaPausado||(currentCarrosselHallDaFamaIndex=(currentCarrosselHallDaFamaIndex+1)%totalSlidesHallDaFama,irParaSlideHallDaFama(currentCarrosselHallDaFamaIndex))},1e4),iniciarBarraProgressoHallDaFama())}function irParaSlideHallDaFama(e){const a=document.getElementById("carrossel-container-hall-fama");if(a){a.style.transform=`translateX(-${100*e}%)`;const o=document.querySelectorAll("#carrossel-indicadores-hall-fama .carrossel-indicador");o.forEach((a,o)=>{a.classList.toggle("ativo",o===e)}),currentCarrosselHallDaFamaIndex=e,carrosselHallDaFamaPausado||iniciarBarraProgressoHallDaFama()}}function iniciarBarraProgressoHallDaFama(){const e=document.getElementById("progresso-indicador-barra-hall-fama");!e||1>=totalSlidesHallDaFama||(e.style.transition="none",e.style.width="0%",void e.offsetWidth,e.style.transition="width 10s linear",setTimeout(()=>{carrosselHallDaFamaPausado||(e.style.width="100%")},10),progressoBarraHallDaFama&&clearTimeout(progressoBarraHallDaFama),progressoBarraHallDaFama=setTimeout(()=>{carrosselHallDaFamaPausado||(e.style.width="0%")},1e4))}window.mudarSlideHallDaFama=function(e){1>=totalSlidesHallDaFama||(reiniciarIntervaloCarrosselHallDaFama(),currentCarrosselHallDaFamaIndex=(currentCarrosselHallDaFamaIndex+e+totalSlidesHallDaFama)%totalSlidesHallDaFama,irParaSlideHallDaFama(currentCarrosselHallDaFamaIndex))},window.togglePausaHallDaFama=function(){if(1>=totalSlidesHallDaFama)return;carrosselHallDaFamaPausado=!carrosselHallDaFamaPausado;const e=document.getElementById("botao-pausa-hall-fama"),a=document.getElementById("progresso-indicador-barra-hall-fama");carrosselHallDaFamaPausado?(clearInterval(carrosselHallDaFamaInterval),e.textContent="\u25B6",a&&(a.style.transition="none",a.dataset.width=window.getComputedStyle(a).width,progressoBarraHallDaFama&&clearTimeout(progressoBarraHallDaFama))):(e.textContent="\u23F8",a&&(a.style.transition="width 10s linear",setTimeout(()=>{a.style.width="100%"},10)),iniciarCarrosselAutomaticoHallDaFama())};function reiniciarIntervaloCarrosselHallDaFama(){1>=totalSlidesHallDaFama||(clearInterval(carrosselHallDaFamaInterval),iniciarCarrosselAutomaticoHallDaFama())}function construirInterface(){const e=document.querySelector(".grupos-container");if(e){e.innerHTML="";for(const[a,o]of Object.entries(equipes)){const t=document.createElement("div");t.className="grupo",t.id=`equipe-${a}`;let n="";"abelha"===a?n="\uD83D\uDC1D":"joaninha"===a?n="\uD83D\uDC1E":"vagalume"===a&&(n="\uD83D\uDCA1"),t.innerHTML=`
        <h2>${n} Equipe ${a.charAt(0).toUpperCase()+a.slice(1)}</h2>
        <div class="resumo" id="resumo-${a}">
          <div>0 focaram hoje!</div>
          <div>0 pontos na semana</div>
          <div>M√©dia: <span id="media-${a}">0.00</span></div>
        </div>
		<div class="mensagem-equipe-completa hidden" id="msg-equipe-${a}"></div>
      `;const i=document.createElement("div");if(i.className="lider-equipe",i.innerHTML=`
        <div class="titulo-lider">L√≠der da Equipe</div>
      `,o.lider){const e=document.createElement("div");e.className="membro";const a=o.lider.deFerias||!1;let t="";a&&("saude"===o.lider.motivoAusencia?t="em-recuperacao":t="em-ferias");const n=a?"disabled":"";e.innerHTML=`
          <input type="checkbox" id="${o.lider.nome}" ${n}>
          <label for="${o.lider.nome}" class="${t}">
            <span class="membro-nome ${6<=o.lider.nome.length?"long-name":""}"
                  title="${o.lider.nome}"
                  onclick="event.preventDefault(); mostrarPopup('üë§ Nome do Membro', '${o.lider.nome}', 2000)">
              ${o.lider.nome}
            </span>
            <span id="dias-${o.lider.nome}" class="dias-badge">0</span>
            <span class="medalha-container">
              <span id="medalha-${o.lider.nome}" class="medalha escondido"></span>
            </span>
          </label>
        `,i.appendChild(e)}else{const e=document.createElement("div");e.className="sem-lider",e.textContent="Sem l\xEDder",i.appendChild(e)}t.appendChild(i);const r=document.createElement("div");r.className="membros-grid",o.membros.forEach(e=>{if(o.lider&&e.nome===o.lider.nome)return;const a=document.createElement("div");a.className="membro";const t=e.deFerias||!1;let n="";t&&("saude"===e.motivoAusencia?n="em-recuperacao":n="em-ferias");const i=t?"disabled":"";a.innerHTML=`
      <input type="checkbox" id="${e.nome}" ${i}>
      <label for="${e.nome}" class="${n}">
        <span class="membro-nome ${6<=e.nome.length?"long-name":""}"
              title="${e.nome}"
              onclick="event.preventDefault(); mostrarPopup('üë§ Nome do Membro', '${e.nome}', 2000)">
          ${e.nome}
        </span>
        <span id="dias-${e.nome}" class="dias-badge">0</span>
        <span class="medalha-container">
          <span id="medalha-${e.nome}" class="medalha escondido"></span>
        </span>
      </label>
    `,r.appendChild(a)}),t.appendChild(r),e.appendChild(t)}const a=document.createElement("div");a.className="grupo",a.id="lider-geral",a.innerHTML=`
      <h2>üëë Guardi√£o</h2> 
    `;const o=document.createElement("div");if(o.className="lider-equipe",o.style.boxShadow="none",o.style.background="transparent",o.style.border="none",o.style.padding="0",liderGeral){const e=liderGeral.deFerias||!1;let a="";e&&(a="saude"===liderGeral.motivoAusencia?"em-recuperacao":"em-ferias");const t=e?"disabled":"";o.innerHTML=`
          <div class="membro" style="width: 100%;"> <input type="checkbox" id="${liderGeral.nome}" ${t}>
            <label for="${liderGeral.nome}" class="${a}">
              <span class="membro-nome ${6<=liderGeral.nome.length?"long-name":""}" 
                    title="${liderGeral.nome}" 
                    onclick="event.preventDefault(); mostrarPopup('üë§ Nome do Membro', '${liderGeral.nome}', 2000)">
                ${liderGeral.nome}
              </span>
              <span id="dias-${liderGeral.nome}" class="dias-badge">0</span>
              <span class="medalha-container">
                <span id="medalha-${liderGeral.nome}" class="medalha escondido"></span>
              </span>
            </label>
          </div>
        `}else o.innerHTML=`<div class="sem-lider">Cargo Vago</div>`;a.appendChild(o),e.appendChild(a),todosMembros.forEach(e=>{const a=e.nome,o=document.getElementById(a);o&&(o.onchange=()=>marcarCheckbox(a))})}}window.togglePainelSecreto=function(e){const a=document.getElementById("painel-secreto");a.style.display=e?"block":"none"};function verificarCliquesDiamante(){if(cliqueCount++,clearTimeout(timeoutClique),5===cliqueCount){const e=prompt("\uD83D\uDD10 Digite a senha para acessar o painel secreto:");"goiaba"===e?togglePainelSecreto(!0):alert("\u274C Senha incorreta!"),cliqueCount=0}else timeoutClique=setTimeout(()=>{cliqueCount=0},3e3)}let intervaloConfete=null,animacaoConfeteAniversarioId=null,geradorDeParticulasId=null,particulasAniversario=[];function carregarAniversariantes(){const e=getHoje(),a=e.getMonth()+1,o=e.getDate(),t=[];let n=null,i=1/0;todosMembros.forEach(r=>{if(r.aniversario){const[d,s]=r.aniversario.split("/").map(Number);s===a&&t.push({nome:r.nome,data:r.aniversario,hoje:d===o});let l=new Date(e.getFullYear(),s-1,d);l<e&&l.setFullYear(e.getFullYear()+1);const m=Math.ceil((l-e)/86400000);m<i&&(i=m,n={nome:r.nome,dias:m,data:r.aniversario})}}),atualizarInterfaceAniversariantes(t,n),t.some(e=>e.hoje)?iniciarConfeteAniversarioContinuo():pararConfeteAniversarioContinuo()}async function verificarAniversariantesDoDia(){try{console.log("Verificando aniversariantes do dia...");const e=getHoje(),a=e.getDate(),o=e.getMonth()+1,t=todosMembros.filter(e=>{if(!e.aniversario)return!1;const[t,n]=e.aniversario.split("/").map(Number);return t===a&&n===o});if(0<t.length){console.log(`Encontrados ${t.length} aniversariante(s) hoje!`);for(const e of t)if(await marcarPresencaAniversario(e),e.nome===currentUser){mostrarCardPopup(`Feliz Anivers√°rio, ${currentUser}!`,"\n              Hoje o dia \xE9 todo seu! \uD83C\uDF89<br><br>\n              Que seu novo ciclo seja repleto de realiza\xE7\xF5es, alegrias e muito foco para alcan\xE7ar seus sonhos. Agradecemos por fazer parte do nosso grupo e por compartilhar sua jornada conosco.<br><br>\n              Seu foco de hoje j\xE1 foi marcado. Aproveite muito o seu dia!\n            ",dispararConfete,"Grupo \xC9picos","aniversario_usuario")}}else console.log("Nenhum aniversariante hoje.")}catch(e){console.error("Erro ao verificar aniversariantes do dia:",e)}}function atualizarInterfaceAniversariantes(e,a){const o=document.getElementById("aniversariantes-hoje"),t=document.getElementById("proximos-aniversarios");o.innerHTML="",t.innerHTML="";const n=document.createElement("div");if(n.className="aniversariantes-container-hoje",0<e.length)e.forEach(e=>{const a=document.createElement("div");a.className="aniversariante-card",e.hoje&&a.classList.add("hoje"),a.innerHTML=`
          <div class="aniversariante-nome">${e.nome}</div>
          <div class="aniversariante-data">${e.data}</div>
        `,n.appendChild(a)});else{const e=document.createElement("div");e.className="aniversariante-card mensagem-vazia",e.textContent="Nenhum aniversariante neste m\xEAs",n.appendChild(e)}o.appendChild(n),t.innerHTML=a?`
        <div style="font-weight:bold; margin-bottom:8px; font-size:1.1rem;">Pr√≥ximo Aniversariante:</div>
        <div>Faltam <strong>${a.dias}</strong> dias para o anivers√°rio de</div>
        <div><strong>${a.nome}</strong> (${a.data})</div>
      `:"<div>Nenhum pr\xF3ximo anivers\xE1rio cadastrado</div>"}function iniciarConfetePeriodico(){pararConfetePeriodico(),intervaloConfete=setInterval(dispararConfete,5e3),dispararConfete()}function pararConfetePeriodico(){intervaloConfete&&(clearInterval(intervaloConfete),intervaloConfete=null)}function exibirQuadroFolgas(){try{const e=getHoje().toLocaleDateString("pt-BR",{weekday:"long"}),a=e.toLowerCase().replace(/-feira$/,"").normalize("NFD").replace(/[\u0300-\u036f]/g,""),o=["segunda","terca","quarta","quinta","sexta","sabado","domingo"],t={};o.forEach(e=>{const a=document.getElementById(e);a&&(a.innerHTML="",a.classList.remove("centralizado"),t[e]=a)}),document.querySelectorAll(".dia-col").forEach(e=>e.classList.remove("dia-hoje"));const n=document.getElementById(a);if(n&&n.closest(".dia-col")?.classList.add("dia-hoje"),todosMembros.forEach(e=>{const n=e.nome,i=e.folga||"",r=i.toLowerCase().replace(/-feira$/,"").normalize("NFD").replace(/[\u0300-\u036f]/g,"");if(r&&o.includes(r)&&t[r]){const o=t[r],i=document.createElement("div");i.className="membro-folga",r===a&&n===currentUser&&i.classList.add("membro-folga-hoje");let d="\uD83D\uDC64";"lider"===e.papel?d="\u2B50":"abelha"===e.equipe?d="\uD83D\uDC1D":"joaninha"===e.equipe?d="\uD83D\uDC1E":"vagalume"===e.equipe&&(d="\uD83D\uDCA1"),i.innerHTML=`<span style="margin-right:4px;">${d}</span>${n}`,o.appendChild(i)}}),t.domingo){const e=document.createElement("div");e.className="membro-folga folga-coletiva",e.textContent="\uD83C\uDFD6\uFE0F Folga Coletiva",t.domingo.appendChild(e)}}catch(e){console.error("Erro ao exibir quadro de folgas:",e)}}async function openChangeFolgaModal(){if(currentUser)try{const e=doc(db,"membros",currentUser),a=await getDoc(e);if(a.exists()){const e=a.data(),o=getSemanaAtual().numero,t=e.semanaTrocaFolga||0;if("lider"!==userRole&&t===o)return void mostrarPopup("\uD83D\uDEAB Limite Atingido","Voc\xEA j\xE1 alterou sua folga esta semana. Tente novamente na pr\xF3xima.",5e3);const n=document.getElementById("select-new-folga");n.value=e.folga||"segunda-feira",openModal("change-folga-modal")}}catch(e){console.error("Erro ao verificar permiss\xE3o de troca de folga:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel verificar seus dados de folga.",3e3)}}window.abrirModalReagentes=async function(e,a){try{const o=doc(db,"mural",e),t=await getDoc(o);if(!t.exists())return;const n=t.data().reacoes||{},i=Array.isArray(n[a])?n[a]:[],r=document.getElementById("reactors-modal-title"),d=document.getElementById("reactors-modal-list"),s=document.getElementById("remove-my-reaction-btn");r.innerHTML=`Reagiram com ${a}`,d.innerHTML="",0<i.length?i.forEach(e=>{const a=document.createElement("div");a.className="reactor-item",a.textContent=e,d.appendChild(a)}):d.innerHTML="<div class=\"reactor-item\" style=\"text-align:center; font-style:italic;\">Ningu\xE9m reagiu com este emoji ainda.</div>",currentUser&&i.includes(currentUser)?(s.style.display="block",s.onclick=async()=>{await window.toggleReacao(e,a),closeModal("reactors-modal")}):s.style.display="none",openModal("reactors-modal")}catch(e){console.error("Erro ao abrir modal de reagentes:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel carregar quem reagiu.",3e3)}};function getDataDaFolgaNaSemana(e){const a=getSemanaAtual(),o=new Date(a.inicio),t=e.toLowerCase().replace(/-feira$/,"").normalize("NFD").replace(/[\u0300-\u036f]/g,""),n={segunda:0,terca:1,quarta:2,quinta:3,sexta:4,sabado:5,domingo:6};if(void 0!==n[t]){const e=new Date(o);return e.setDate(o.getDate()+n[t]),e}return null}async function processarRecuperacaoFolgaRetroativa(e,a){const o=getHoje(),t=getDataDaFolgaNaSemana(a);if(!t)return;const n=new Date(o.setHours(0,0,0,0)),i=new Date(t.setHours(0,0,0,0));if(i<n){const o=formatarDataISO(t);console.log(`Verificando recupera√ß√£o retroativa para ${o}...`);const n=doc(dbEssencial,"presencas",o),i=doc(dbEssencial,"membros_essencial",e),r=doc(dbEssencial,"semanas","pontosSemanais");try{await runTransaction(dbEssencial,async a=>{const o=await a.get(n),d=o.exists()&&o.data()[e];if(!d){const o=await a.get(i);if(!o.exists())return;const d=o.data(),s=d.equipe;a.set(n,{[e]:new Date},{merge:!0}),a.update(i,{streak:increment(1),moedas:increment(recompensasConfig.focoDiario||100)}),s&&0!==t.getDay()&&a.update(r,{[s]:increment(1)})}});const o=await getDoc(n);o.exists()&&o.data()[e]&&(window.mostrarPopup("\uD83D\uDD04 Dia Recuperado!",`Como sua nova folga (${a}) foi num dia passado que voc√™ n√£o focou, sua presen√ßa foi recuperada automaticamente!`,6e3),streaksCache[e]&&streaksCache[e]++,equipes[userTeam]&&pontosSemanais[userTeam]++,atualizarPlacarSemanal(),atualizarMedalhas())}catch(e){console.error("Erro na recupera\xE7\xE3o retroativa:",e)}}}async function handleUpdateFolga(){const e=document.getElementById("select-new-folga").value;if(!currentUser)return;const a=getSemanaAtual().numero,o=doc(db,"membros",currentUser);try{await updateDoc(o,{folga:e,semanaTrocaFolga:a});const t=todosMembros.findIndex(e=>e.nome===currentUser);-1===t?console.warn("N\xE3o foi poss\xEDvel encontrar o membro atual no array local para atualizar a folga."):(todosMembros[t].folga=e,localStorage.setItem("epicos_cache_membros",JSON.stringify(todosMembros)),console.log(`Folga local de ${currentUser} atualizada para ${e}.`)),window.mostrarPopup("\u2705 Sucesso",`Sua folga foi alterada para ${e}!`,4e3),window.closeModal("change-folga-modal"),await exibirQuadroFolgas(),await processarRecuperacaoFolgaRetroativa(currentUser,e);const n=getDiaSemanaString(),i=e.toLowerCase().replace(/-feira$/,"").normalize("NFD").replace(/[\u0300-\u036f]/g,""),r=n.toLowerCase().replace(/-feira$/,"").normalize("NFD").replace(/[\u0300-\u036f]/g,"");if(i===r){console.log(`A nova folga (${e}) √© hoje! Verificando se a checkbox precisa ser marcada...`);const a=document.getElementById(currentUser);if(a&&!a.checked){const e=todosMembros.find(e=>e.nome===currentUser);e&&(await marcarFolgaAutomatica(e),window.mostrarPopup("\uD83C\uDF34 Folga Imediata!","Como sua nova folga \xE9 hoje, j\xE1 marcamos seu foco para voc\xEA. Bom descanso!",6e3))}}}catch(e){console.error("Erro ao atualizar folga:",e),window.mostrarPopup("\u274C Erro","Falha ao salvar sua nova folga.",3e3)}}function atualizarRelogio(){const e=new Date,a=(e.getHours()+"").padStart(2,"0"),o=(e.getMinutes()+"").padStart(2,"0"),t=(e.getSeconds()+"").padStart(2,"0");document.getElementById("relogio").textContent=`${a}:${o}:${t}`}function tocarSom(e){try{const a=document.getElementById(e);a&&(a.currentTime=0,a.play())}catch(a){console.warn(`N√£o foi poss√≠vel tocar o som "${e}":`,a)}}async function handleLogin(){let e=loginUsernameInput.value.trim();e&&(e=e.charAt(0).toUpperCase()+e.slice(1).toLowerCase());const a=loginPasswordInput.value;if(!e||!a)return void mostrarPopup("\u274C Erro","Por favor, preencha todos os campos",3e3);loginBtn.textContent="Entrando...",loginBtn.disabled=!0;try{const o=await getDoc(doc(db,"membros",e));if(o.exists()){const t=o.data();if(t.senha===a&&"on"===t.usedProv){try{const e=collection(db,"statusPoderes");if("function"==typeof query){const a=query(e,where("expiraEm",">",new Date)),o=await getDocs(a);statusPoderesAtivos=[],o.forEach(e=>{statusPoderesAtivos.push({id:e.id,...e.data()})});const n=statusPoderesAtivos.find(e=>"runa_soft_block"===e.poderId&&e.equipeAlvo===t.equipe&&"lider"!==t.papel&&"lider-equipe"!==t.papel);if(n){const e=n.expiraEm.toDate().toLocaleString("pt-BR",{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit"});return mostrarPopup("\uD83D\uDEAB Acesso Bloqueado",`Sua equipe est√° sob o efeito da "Runa do Soft Block" at√© ${e}.`,8e3),loginBtn.textContent="Entrar",void(loginBtn.disabled=!1)}}}catch(e){console.warn("Erro ao verificar bloqueios (Soft Block). Permitindo login por seguran\xE7a.",e)}localStorage.setItem("loggedInUser",e),await performSuccessfulLogin(e)}else t.senhaProv===a&&"off"===t.usedProv?(currentUser=e,mostrarPopup("\uD83D\uDD11 Primeiro Acesso","Crie sua senha definitiva para continuar.",4e3),showChangePasswordForm()):mostrarPopup("\u274C Erro de Acesso","Nome ou senha incorreta.",3e3)}else mostrarPopup("\u274C Erro","Usu\xE1rio n\xE3o encontrado",3e3)}catch(e){console.error("Erro no login:",e),mostrarPopup("\u274C Erro","Falha de conex\xE3o: "+e.message,5e3)}finally{loginBtn&&(loginBtn.textContent="Entrar",loginBtn.disabled=!1)}}async function carregarDadosEssenciais(){console.log("\uD83D\uDE80 Carregando dados h\xEDbridos (Principal + Essencial)...");const e=doc(db,"configuracoes","metadados");let a=!0;try{const o=await getDoc(e),t=o.exists()?o.data().versaoMembros:0,n=localStorage.getItem("epicos_versao_membros"),i=localStorage.getItem("epicos_cache_membros");i&&n==t?(todosMembros=JSON.parse(i),a=!1,console.log("\u2705 Dados de perfil carregados do cache local.")):localStorage.setItem("epicos_versao_membros",t)}catch(a){console.error("Erro na valida\xE7\xE3o do cache:",a)}if(a){console.log("\uD83D\uDCE5 Baixando lista atualizada de membros do banco de dados...");const e=await getDocs(collection(db,"membros"));todosMembros=[],e.forEach(e=>{todosMembros.push({nome:e.id,...e.data()})}),localStorage.setItem("epicos_cache_membros",JSON.stringify(todosMembros))}try{const e=await getDocs(collection(dbEssencial,"membros_essencial")),a={};e.forEach(e=>{a[e.id]=e.data()}),todosMembros=todosMembros.map(e=>{const o=a[e.nome];return o?{...e,streak:o.streak,moedas:o.moedas,dailyRewardStreak:o.dailyRewardStreak,lastDailyRewardClaim:o.lastDailyRewardClaim}:e}),console.log("\u2705 Dados financeiros e streaks sincronizados do dbEssencial.")}catch(e){console.error("Erro ao ler dbEssencial. Usando dados cacheados do principal.",e)}reconstruirEstruturasLocais()}function reconstruirEstruturasLocais(){equipes={abelha:{membros:[],lider:null},joaninha:{membros:[],lider:null},vagalume:{membros:[],lider:null}},liderGeral=null,streaksCache={},medalhasInventarioCache={},medalhasOrdemCache={},todosMembros.forEach(e=>{streaksCache[e.nome]=e.streak||0,medalhasInventarioCache[e.nome]=e.medalhasInventario||[],medalhasOrdemCache[e.nome]=e.medalhasOrdem||[],"lider"===e.papel?liderGeral=e:"lider-equipe"===e.papel&&equipes[e.equipe]&&(equipes[e.equipe].lider=e),e.equipe&&equipes[e.equipe]&&equipes[e.equipe].membros.push(e)}),console.log("Estruturas locais reconstru\xEDdas com sucesso.")}async function forcarAtualizacaoCacheGlobal(){const e=doc(db,"configuracoes","metadados");try{await updateDoc(e,{versaoMembros:increment(1)}),console.log("\uD83D\uDCE1 Sinal de atualiza\xE7\xE3o global enviado.")}catch(e){console.error("Erro ao atualizar vers\xE3o:",e)}}async function verificarConquista(e,a,o,t){const n=getHojeISO(),i=doc(dbEssencial,"membros_essencial",e),r=doc(dbEssencial,"presencas",n),d=doc(dbEssencial,"semanas","pontosSemanais");try{const{streakAtual:n,novosPontosEquipe:s,novasMoedas:l}=await runTransaction(dbEssencial,async n=>{const s="adicionar"===a?1:-1,l=await n.get(i),m=await n.get(r);let c;!t&&o&&(c=await n.get(d));let u=l.exists()?l.data():{streak:0,moedas:0};const p=u.streak||0,g=u.moedas||0,f=Math.max(0,p+s),h=recompensasConfig.focoDiario||100,v=Math.max(0,g+s*h);n.set(i,{streak:f,moedas:v,equipe:o},{merge:!0}),"adicionar"===a?m.exists()?n.update(r,{[e]:new Date}):n.set(r,{[e]:new Date},{merge:!0}):m.exists()&&n.update(r,{[e]:deleteField()});let E=0;if(!t&&o){const e=c&&c.exists()?c.data()[o]||0:0;E=Math.max(0,e+s),n.set(d,{[o]:E},{merge:!0})}return{streakAtual:f,novosPontosEquipe:E,novasMoedas:v}}),m=todosMembros.findIndex(a=>a.nome===e);return-1!==m&&(todosMembros[m].streak=n,todosMembros[m].moedas=l),{streakAtual:n,novosPontosEquipe:s}}catch(e){throw console.error("FALHA NA TRANSA\xC7\xC3O ESSENCIAL:",e),mostrarPopup("\u274C Erro de Conex\xE3o","N\xE3o foi poss\xEDvel salvar no servidor de seguran\xE7a.",5e3),e}}async function carregarStreaks(){todosMembros.forEach(e=>{streaksCache[e.nome]!==void 0&&atualizarStreakVisualMembro(e.nome,streaksCache[e.nome])}),atualizarMedalhas()}async function verificarSePrecisaAtualizarImediatamente(){try{const e=doc(db,"appState","status"),a=await getDoc(e);if(a.exists()){const e=a.data();if(e.requiredUpdateVersion){officialAppVersion=e.requiredUpdateVersion.toDate();const a=localStorage.getItem("currentAppVersion"),o=a?new Date(a):new Date(0);if(officialAppVersion>o)return console.log("Atualiza\xE7\xE3o obrigat\xF3ria detectada no in\xEDcio. Bloqueando carregamento."),authContainer&&authContainer.classList.add("hidden"),showUpdateOverlay(),!0}}}catch(e){console.error("Erro ao verificar vers\xE3o inicial:",e)}return!1}async function performSuccessfulLogin(e,a=!1,o=!1){const t=new Date().getHours(),n=document.body;n.classList.remove("tema-manha","tema-tarde","tema-noite"),5<=t&&12>t?n.classList.add("tema-manha"):12<=t&&18>t?n.classList.add("tema-tarde"):n.classList.add("tema-noite");const i=await verificarSePrecisaAtualizarImediatamente();if(i)return;showLoadingOverlay("Sincronizando rel\xF3gio..."),await sincronizarHorarioBrasilia(),await carregarDadosEssenciais(),executarRotinaDeMeiaNoite(),limparBloqueiosAntigosUsuario(),await carregarConfiguracoesRecompensas();const r=await getDoc(doc(db,"membros",e));if(!r.exists())return localStorage.removeItem("loggedInUser"),void location.reload();const d=r.data();if(!o)try{const e=collection(db,"statusPoderes"),a=query(e,where("expiraEm",">",new Date)),o=await getDocs(a),t=[];o.forEach(e=>t.push(e.data()));const n=t.find(e=>"runa_soft_block"===e.poderId&&e.equipeAlvo===d.equipe&&"lider"!==d.papel&&"lider-equipe"!==d.papel);if(n){const e=n.expiraEm.toDate().toLocaleString("pt-BR",{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit"});return localStorage.removeItem("loggedInUser"),authContainer&&authContainer.classList.remove("hidden"),mainContent&&mainContent.classList.add("hidden"),loginBtn&&(loginBtn.textContent="Entrar",loginBtn.disabled=!1),hideLoadingOverlay(),void setTimeout(()=>{mostrarPopup("\uD83D\uDEAB Acesso Bloqueado",`Sua equipe est√° sob o efeito da <strong>Runa do Soft Block</strong>.<br><br>O acesso est√° impedido at√©:<br><strong>${e}</strong>`,8e3)},100)}}catch(e){console.error("Erro Soft Block",e)}const s=await verificarEstadoManutencaoInicial();if(s&&"lider"!==d.papel)return document.getElementById("maintenance-overlay").classList.remove("hidden"),void(document.body.style.overflow="hidden");if(await verificarEAtualizarAvatar(d),currentUser=e,userRole=d.papel,userTeam=d.equipe,authContainer.classList.add("hidden"),mainContent.classList.remove("hidden"),hideLoadingOverlay(),construirInterface(),atualizarDataCabecalho(),atualizarRelogio(),atualizarInfoSemana(),a)setTimeout(()=>{let a=`üéâ Seja muito bem-vindo(a), ${e}!`;"masculino"===d.genero?a=`üéâ Seja muito bem-vindo, ${e}!`:"feminino"===d.genero&&(a=`üéâ Seja muito bem-vinda, ${e}!`);mostrarCardPopup(a,"\n        <p>\xC9 uma alegria ter voc\xEA no Grupo \xC9picos!</p>\n        <p>Voc\xEA acaba de entrar para o nosso grupo de foco. Aqui, acreditamos que o verdadeiro progresso \xE9 constru\xEDdo um dia de cada vez, com determina\xE7\xE3o e apoio m\xFAtuo.</p>\n        <p>Sinta-se em casa para navegar, interagir e encontrar seu pr\xF3prio ritmo. Lembre-se: <strong>cada pequeno passo \xE9 uma grande vit\xF3ria em sua jornada.</strong></p>\n        <p>Estamos muito felizes em ter voc\xEA conosco. Vamos juntos construir uma jornada \xC9pica!</p>\n      ",dispararConfete)},1500);else{let a="Bem-vindo(a) de volta!";"masculino"===d.genero&&(a="Bem-vindo de volta!"),"feminino"===d.genero&&(a="Bem-vinda de volta!"),setTimeout(()=>{mostrarPopup(`‚úÖ ${a}`,`Ol√°, ${e}! √â bom ver voc√™ aqui.`,4e3)},1500)}await carregarDadosAvatar(),await carregarStreaks(),carregarDadosLoteria(),atualizarPainelPessoal(),configurarNotificacoesTempoReal(),configurarOuvintePresencaTempoReal(),configurarOuvinteDadosPessoais(),executarSorteioLoteria(),setTimeout(()=>{verificarNudgesDiarios(!1)},500),await carregarRecompensaDiaria(),carregarRankingGeral(),await carregarAniversariantes(),await carregarPontosSemanais(),await verificarELimparNaSegunda(),await finalizarSemana(),atualizarPlacarSemanal(),await carregarTop5Semana(),await carregarDadosMedalhasHonra(),await loadAdvantageState(),configurarResumoSemanalTempoReal(),await atualizarResumo(),await carregarBancosEquipes(),inicializarLojaPoderes(),await carregarStatusPoderes(),await carregarHallDaFama(),await carregarCondominioEpicos(),exibirQuadroFolgas(),iniciarCalendario(),await carregarArvoreEpica(),configurarMuralTempoReal(),carregarInformacoesMembros(),setTimeout(()=>{iniciarCarrosselAutomatico(),irParaSlide(0)},1e3),await carregarTemaDesenho(),await carregarEExibirAvaliacoesDesenho(),await carregarRankingDesenhos(),inicializarMapa(),createColorPalette(),atualizarVisualBloqueio(),await carregarEExibirMembrosOciosos(),await verificarEConcederPremiacaoDiaria(),await executarMarcacaoAutomaticaDeFolgasDoDia(),await marcarFolgaColetivaDeDomingo(),await processarFeriadoDoDia(),await destacarVencedoraDomingo(),configurarOuvintesDePreviewDesenho();const l=document.getElementById("carrossel-indicadores-desenho");if(l){l.innerHTML="";for(let e=0;3>e;e++){const a=document.createElement("div");a.className="carrossel-indicador",a.onclick=()=>{irParaSlideDesenho(e)},l.appendChild(a)}}if(iniciarCarrosselDesenho(),document.querySelector("#carrossel-indicadores-desenho .carrossel-indicador")?.classList.add("ativo"),irParaSlideDesenho(0),setupRefreshListener(),setupVersionCheckListener(),await verificarEExibirPopupNovaMedalha(),0===historicoConversaIA.length&&""!==baseDeConhecimentoTexto){const e=d.idioma||"pt-BR";let a=`Ol√°, ${currentUser}! Sou o Or√°culo dos √âpicos. Posso te ajudar em algo?`;"es"===e?a=`¬°Hola, ${currentUser}! Soy el Or√°culo de los √âpicos. ¬øEn qu√© puedo ayudarte?`:"en"===e&&(a=`Hello, ${currentUser}! I am the Oracle of the Epics. How can I help you?`),adicionarMensagemIA(a)}await verificarEMostrarMensagemDoDia(),await verificarPopupEnvioDiario(),await verificarPopupFimDeTemporada(),await verificarAniversariantesDoDia(),await exibirPopupResultadoCompeticao(),await verificarEProcessarFolgaDoDiaAtual(),await verificarPopupDeFolga(),await verificarUltimoResultadoDesenho(),await verificarPopupResultadoLoteria(),await verificarPopupVesperaSorteio(),exibirPopupPoderesAtivos(),await verificarPopupRecompensas();const m=new Date().getDay();if(1===m&&mostrarCardPopup("\uD83C\uDFA8 \xDAltimo Dia!","A Batalha de Desenhos encerra hoje. Verifique sua equipe!",null,"Grupo \xC9picos","aviso_fim_desenho"),4===m){const e=doc(dbDesenho,"configuracoes","temaDesenho");getDoc(e).then(e=>{e.exists()&&e.data().ativo&&formatarDataISO(e.data().dataGeracao.toDate())===getHojeISO()&&mostrarCardPopup("\uD83C\uDFA8 Novo Tema!",`O Or√°culo escolheu! O tema da semana √©: <br><br><strong style="font-size:1.4rem;color:#e67e22;">${e.data().tema}</strong><br><br>Re√∫na sua equipe e corram para as telas de desenho!`,null,"Or\xE1culo","aviso_novo_tema_"+getHojeISO())})}setTimeout(()=>{console.log("Iniciando agendador do Or\xE1culo..."),gerenciarEventosAgendadosDoOraculo()},1e4)}async function verificarPopupDeFolga(){if(currentUser&&usuarioAceitaPopups()){const e=todosMembros.find(e=>e.nome===currentUser);if(e){const a=new Date;a.setDate(a.getDate()+1);const o=await verificarDataEspecial(a);if(!o){if(e.aniversario){const[o,t]=e.aniversario.split("/").map(Number);if(a.getDate()===o&&a.getMonth()+1===t){return mostrarCardPopup("\uD83C\uDF89 Seu Anivers\xE1rio est\xE1 Chegando!","Falta pouco para o seu dia especial! Estamos muito ansiosos para comemorar o seu anivers\xE1rio amanh\xE3 com voc\xEA!!",null,"Grupo \xC9picos","vespera_aniversario"),void sessionStorage.setItem("popupVesperaMostradoHoje","true")}}if(e.folga){const o=getDiaSemanaString(a).toLowerCase().replace(/-feira$/,"").normalize("NFD").replace(/[\u0300-\u036f]/g,""),t=e.folga.toLowerCase().replace(/-feira$/,"").normalize("NFD").replace(/[\u0300-\u036f]/g,"");if(t===o){return void mostrarCardPopup("\uD83C\uDF34 Seu Descanso se Aproxima!","Lembrete amig\xE1vel: amanh\xE3 \xE9 o seu dia de folga programado. Aproveite para recarregar as energias!",null,"Grupo \xC9picos","aviso_vespera_folga")}}if(6===getHoje().getDay()){mostrarCardPopup("\uD83C\uDF89 Fim de Semana Chegou!","Aproveite o s\xE1bado! Lembre-se que amanh\xE3 \xE9 nossa folga coletiva. Um \xF3timo descanso para todos n\xF3s!",null,"Grupo \xC9picos","aviso_sabado")}}}}}function handleLogout(){desligarTodosOsOuvintesDeDesenho(),unsubscribeNotificacoes&&(unsubscribeNotificacoes(),unsubscribeNotificacoes=null),unsubscribeDadosPessoais&&(unsubscribeDadosPessoais(),unsubscribeDadosPessoais=null,console.log("Ouvinte de dados pessoais desligado.")),document.getElementById("nudge-floating-btn")?.classList.add("hidden"),closeModal("user-panel-modal"),localStorage.removeItem("loggedInUser"),sessionStorage.removeItem("avatarPermissionsChecked"),currentUser=null,userRole=null,userTeam=null,authContainer.classList.remove("hidden"),mainContent.classList.add("hidden"),loginUsernameInput.value="",loginPasswordInput.value="",loginBtn&&(loginBtn.textContent="Entrar",loginBtn.disabled=!1);const e=document.getElementById("nudge-floating-btn");e&&(e.classList.add("hidden"),e.style.display="none"),showLoginForm(),mostrarPopup("\u2139\uFE0F Sess\xE3o encerrada","Voc\xEA saiu do sistema",3e3)}function showChangePasswordForm(){loginForm.classList.add("hidden"),changePasswordForm.classList.remove("hidden")}function showLoginForm(){changePasswordForm.classList.add("hidden"),forgotPasswordForm.classList.add("hidden"),secretQuestionForm.classList.add("hidden"),loginForm.classList.remove("hidden")}async function handlePasswordChange(){const e=document.getElementById("new-password").value,a=document.getElementById("confirm-new-password").value;if(!e||!a)return void mostrarPopup("\u274C Erro","Preencha todos os campos",3e3);if(e!==a)return void mostrarPopup("\u274C Erro","As novas senhas n\xE3o coincidem",3e3);if(6>e.length)return void mostrarPopup("\u274C Erro","A senha deve ter no m\xEDnimo 6 caracteres.",3e3);try{const a=doc(db,"membros",currentUser);await updateDoc(a,{senha:e}),isPasswordResetFlow?(isPasswordResetFlow=!1,mostrarPopup("\u2705 Sucesso!","Sua senha foi redefinida. Carregando o app...",4e3),await performSuccessfulLogin(currentUser,!1)):(mostrarPopup("\u2705 Senha Criada","Agora, vamos configurar sua recupera\xE7\xE3o de login.",5e3),showSecretQuestionForm())}catch(e){console.error("Erro ao alterar senha:",e),mostrarPopup("\u274C Erro","Falha ao alterar senha. Tente novamente.",3e3)}}function initAuth(){function a(){const e=document.getElementById("barra-cores-rapidas");if(e){e.innerHTML="";const o=[...new Set([...m,...l])];o.forEach(o=>{const t=document.createElement("div");t.className="swatch-cor",t.style.backgroundColor=o,corPincel.toLowerCase()===o.toLowerCase()&&t.classList.add("ativo"),t.onclick=t=>{t.stopPropagation(),corPincel=o,s.value=o,definirModoGlobal("pincel"),a()},e.appendChild(t)})}}authContainer=document.getElementById("auth-container"),mainContent=document.getElementById("main-content"),logoutBtn=document.getElementById("logout-btn"),loginForm=document.getElementById("login-form"),changePasswordForm=document.getElementById("change-password-form");let o=document.getElementById("user-menu-dropdown");const t=document.getElementById("composer-textarea");t.addEventListener("paste",function(a){a.preventDefault();let e=(a.clipboardData||window.clipboardData).getData("text/plain");const o=e.replace(/\r\n|\r|\n/g,"<br>");document.execCommand("insertHTML",!1,o)}),t.addEventListener("input",handleComposerInput),t.addEventListener("keydown",handleMentionKeyDown);const n=document.getElementById("comment-textarea-modal");n.addEventListener("input",handleComposerInput),n.addEventListener("keydown",handleMentionKeyDown),loginBtn=document.getElementById("login-btn"),loginUsernameInput=document.getElementById("login-username"),loginPasswordInput=document.getElementById("login-password"),forgotPasswordForm=document.getElementById("forgot-password-form"),secretQuestionForm=document.getElementById("secret-question-form"),loginBtn&&loginBtn.addEventListener("click",handleLogin);const i=document.getElementById("toggle-password-btn");loginPasswordInput&&i&&(loginPasswordInput.addEventListener("input",()=>{i.style.display=0<loginPasswordInput.value.length?"block":"none"}),i.addEventListener("click",()=>{const e="password"===loginPasswordInput.type;loginPasswordInput.type=e?"text":"password",i.textContent=e?"Ocultar":"Ver"})),loginBtn&&loginBtn.addEventListener("click",handleLogin),logoutBtn&&logoutBtn.addEventListener("click",handleLogout),loginPasswordInput&&loginPasswordInput.addEventListener("keypress",a=>{"Enter"===a.key&&handleLogin()});const r=document.getElementById("add-item-categoria");r&&r.addEventListener("change",()=>{const e=document.getElementById("add-item-subcategoria-container");e.classList.toggle("hidden","acessorio"!==r.value)}),document.getElementById("confirm-remove-button")?.addEventListener("click",executeRemoveMember),document.getElementById("force-refresh-btn")?.addEventListener("click",requestGlobalRefresh),document.getElementById("trigger-update-btn")?.addEventListener("click",triggerForcedUpdate),document.getElementById("perform-update-btn")?.addEventListener("click",performUpdate),document.getElementById("notificacoes-btn")?.addEventListener("click",()=>{openModal("notificacoes-modal")});const d=document.getElementById("notificacoes-fechar-btn");if(d){let e=null,a=!1;const o=()=>{a=!1,e=setTimeout(()=>{a=!0,console.log("Modo Admin: Fechando modal sem limpar notifica\xE7\xF5es."),closeModal("notificacoes-modal"),mostrarPopup("\u267B\uFE0F Modo de Preserva\xE7\xE3o","Notifica\xE7\xF5es preservadas como n\xE3o lidas.",2e3)},1500)},t=()=>{clearTimeout(e)},n=o=>{a?(o.preventDefault(),o.stopImmediatePropagation(),a=!1):acaoNormalFecharNotificacoes()};d.addEventListener("touchstart",o,{passive:!0}),d.addEventListener("touchend",t),d.addEventListener("touchmove",t),d.addEventListener("mousedown",o),d.addEventListener("mouseup",t),d.addEventListener("mouseleave",t),d.addEventListener("click",n)}document.getElementById("btn-abrir-add-avatar-item")?.addEventListener("click",abrirModalAdicionarItemAvatar),document.getElementById("save-new-avatar-item-btn")?.addEventListener("click",salvarItemAvatar),document.getElementById("add-item-raro")?.addEventListener("change",a=>{const e=document.getElementById("add-item-raro-descricao-container"),o=document.getElementById("add-item-membros-permitidos-container"),t=a.target.checked;e.classList.toggle("hidden",!t),o.classList.toggle("hidden",!t),t&&popularListaMembrosPermissao()}),document.getElementById("pix-iniciar-btn")?.addEventListener("click",iniciarNovoPix),document.querySelectorAll(".pix-cancel-btn").forEach(e=>e.addEventListener("click",()=>navegarPix(0))),document.getElementById("pix-verificar-btn")?.addEventListener("click",verificarComprovantePix),document.getElementById("pix-salvar-comprovante-btn")?.addEventListener("click",salvarComprovantePix),document.getElementById("pix-nova-transferencia-btn")?.addEventListener("click",iniciarNovoPix),document.getElementById("pix-executar-btn")?.addEventListener("click",executarPix),document.getElementById("pix-step1-next")?.addEventListener("click",()=>{const e=document.querySelectorAll("#pix-lista-membros input:checked");if(0===e.length)return mostrarPopup("\uD83E\uDD14 Aten\xE7\xE3o","Selecione pelo menos um membro.",3e3);pixDestinatarios=Array.from(e).map(e=>e.value);const a=document.getElementById("pix-fonte-pagamento"),o="lider"===userRole||"lider-equipe"===userRole,t=todosMembros.find(e=>e.nome===currentUser),n=t?t.moedas||0:0;if(document.querySelector("#pix-saldo-atual span").textContent=n.toLocaleString("pt-BR"),o&&userTeam){const e=saldosBancosEquipes[userTeam]||0;document.getElementById("saldo-pessoal-pix").textContent=n.toLocaleString("pt-BR"),document.getElementById("saldo-banco-pix").textContent=e.toLocaleString("pt-BR"),document.getElementById("fonte-pessoal-pix").disabled=!1,document.getElementById("fonte-banco-pix").disabled=!1,document.getElementById("fonte-pessoal-pix").checked=!0,a.classList.remove("hidden")}else a.classList.add("hidden");popularTecladoPix(),document.getElementById("pix-valor-display").textContent="0",navegarPix(2)}),document.getElementById("pix-step2-next")?.addEventListener("click",()=>{const e=parseInt(document.getElementById("pix-valor-display").textContent,10),a=document.querySelector("input[name=\"fonte-pagamento-pix\"]:checked"),o=a&&!a.disabled?a.value:"pessoal";let t=0;if("banco"===o)t=saldosBancosEquipes[userTeam]||0;else{const e=todosMembros.find(e=>e.nome===currentUser);t=e?e.moedas||0:0}return 1>e?void mostrarPopup("\u274C Valor Inv\xE1lido","O valor m\xEDnimo para envio \xE9 de 1 moeda.",4e3):e*pixDestinatarios.length>t?void mostrarPopup("\uD83D\uDCB0 Saldo Insuficiente","Voc\xEA n\xE3o tem moedas suficientes nessa fonte de pagamento.",4e3):void(pixValor=e,navegarPix(3))}),document.getElementById("pix-step3-next")?.addEventListener("click",()=>{pixComentario=document.getElementById("pix-comentario-input").value.trim(),document.getElementById("pix-resumo-confirmacao").innerHTML=`<p><strong>Destinat√°rio(s):</strong> ${pixDestinatarios.join(", ")}</p><p><strong>Valor por pessoa:</strong> üí∞ ${pixValor}</p><p><strong>Valor Total:</strong> üí∞ ${pixValor*pixDestinatarios.length}</p><p><strong>Coment√°rio:</strong> ${pixComentario||"Nenhum"}</p>`,navegarPix(4)}),document.getElementById("pix-step4-next")?.addEventListener("click",()=>{document.getElementById("pix-senha-input").value="",navegarPix(5)}),document.getElementById("btn-abrir-envio-moedas")?.addEventListener("click",abrirModalEnvioMoedas),document.getElementById("enviar-moedas-btn")?.addEventListener("click",()=>executarEnvioMoedas("envio-moedas-modal")),document.getElementById("enviar-moedas-popup-btn")?.addEventListener("click",()=>executarEnvioMoedas("popup-envio-diario-moedas")),document.getElementById("toggle-maintenance-btn")?.addEventListener("click",toggleMaintenanceMode),document.getElementById("enviar-recompensa-equipe-btn")?.addEventListener("click",executarEnvioRecompensaEquipe),document.getElementById("enviar-recompensa-lideres-btn")?.addEventListener("click",executarEnvioRecompensaLideres),document.getElementById("limpar-feed-btn")?.addEventListener("click",limparFeedManualmente),document.getElementById("limpar-mural-btn")?.addEventListener("click",limparMuralManualmente),document.getElementById("btn-abrir-inventario")?.addEventListener("click",abrirInventario),document.getElementById("change-folga-btn")?.addEventListener("click",openChangeFolgaModal),document.getElementById("save-new-folga-btn")?.addEventListener("click",handleUpdateFolga),document.getElementById("btn-ver-lista-aniversarios")?.addEventListener("click",abrirModalListaAniversarios),document.getElementById("conta-gotas-btn")?.addEventListener("click",()=>definirModoGlobal("conta-gotas")),document.getElementById("save-new-password-btn")?.addEventListener("click",handleUpdatePassword),document.getElementById("save-new-secret-btn")?.addEventListener("click",handleUpdateSecretAnswer),window.addEventListener("click",()=>{o&&!o.classList.contains("hidden")&&o.classList.add("hidden")}),document.getElementById("btn-fazer-aposta")?.addEventListener("click",abrirModalAposta),document.getElementById("btn-confirmar-aposta")?.addEventListener("click",confirmarAposta),document.getElementById("btn-minhas-apostas")?.addEventListener("click",verMinhasApostas),document.getElementById("btn-ver-historico-apostas")?.addEventListener("click",verHistoricoApostas),document.getElementById("btn-consultar-id-aposta")?.addEventListener("click",consultarApostaPorID),document.getElementById("btn-decretar-feriado")?.addEventListener("click",handleDecretarFeriado),document.getElementById("pincel-btn")?.addEventListener("click",()=>definirModoGlobal("pincel")),document.getElementById("desfocar-btn")?.addEventListener("click",()=>definirModoGlobal("desfocar")),document.getElementById("balde-btn")?.addEventListener("click",()=>definirModoGlobal("balde")),document.getElementById("borracha-btn")?.addEventListener("click",()=>definirModoGlobal("borracha")),document.getElementById("pan-btn")?.addEventListener("click",()=>definirModoGlobal("arrastar"));const s=document.getElementById("cor-pincel"),l=["#000000","#FFFFFF","#FF0000","#00FF00","#0000FF","#FFFF00","#FF00FF","#00FFFF","#FFA500","#8B4513","#FFD1DC","#F5CBA7","#8D5524"];let m=[];s&&(s.addEventListener("input",a=>{corPincel=a.target.value,definirModoGlobal("pincel")}),s.addEventListener("change",o=>{const e=o.target.value;m.unshift(e),5<m.length&&m.pop(),a()}),a()),document.getElementById("tamanho-pincel")?.addEventListener("input",a=>{tamanhoPincel=a.target.value;const e=document.getElementById("valor-pincel");e&&(e.textContent=a.target.value),atualizarCursorDinamico()}),document.getElementById("limpar-tela-btn")?.addEventListener("click",()=>{activeDrawingTeam&&confirmarLimpezaDeTela(activeDrawingTeam)});const c=document.getElementById("desenho-toolbar"),u=document.getElementById("toggle-toolbar-btn");c&&u&&!c.dataset.listener&&(u.addEventListener("click",()=>c.classList.toggle("recolhida")),c.dataset.listener="true"),document.getElementById("btn-adicionar-pontos")?.addEventListener("click",()=>handleAjusteManualPontos("adicionar")),document.getElementById("btn-remover-pontos")?.addEventListener("click",()=>handleAjusteManualPontos("remover")),document.getElementById("open-composer-btn")?.addEventListener("click",()=>openMessageComposer()),document.getElementById("confirm-delete-btn")?.addEventListener("click",confirmDelete),document.getElementById("viewer-close-btn")?.addEventListener("click",()=>closeModal("message-viewer-modal")),document.getElementById("composer-color-btn")?.addEventListener("click",a=>{a.stopPropagation();const e=document.getElementById("composer-color-palette"),o=e.classList.toggle("hidden");if(!o){const o=t=>{e.contains(t.target)||t.target===a.target||(e.classList.add("hidden"),document.removeEventListener("click",o))};setTimeout(()=>document.addEventListener("click",o),0)}}),document.getElementById("composer-close-btn")?.addEventListener("click",closeMessageComposer),document.getElementById("composer-send-btn")?.addEventListener("click",enviarMensagem),document.getElementById("confirm-delete-comment-btn")?.addEventListener("click",executarExclusaoComentario),document.getElementById("save-edit-comment-btn")?.addEventListener("click",salvarEdicaoComentario),document.getElementById("botao-painel-usuario")?.addEventListener("click",()=>{const e=usuarioAceitaPopups(),a=document.getElementById("user-pref-popups");a&&(a.value=e?"ativado":"desativado"),openModal("user-panel-modal")}),document.getElementById("generate-batch-code-btn")?.addEventListener("click",handleGenerateBatchCode),document.getElementById("add-member-btn")?.addEventListener("click",handleAddMember),document.getElementById("remove-member-btn")?.addEventListener("click",handleRemoveMember),document.getElementById("btn-abrir-gerador-codigo")?.addEventListener("click",abrirGeradorDeCodigos),document.getElementById("generate-code-btn")?.addEventListener("click",handleGenerateCode),document.getElementById("redeem-code-btn")?.addEventListener("click",handleRedeemCode),document.getElementById("save-game-order-btn")?.addEventListener("click",salvarNovaOrdemJogos),document.getElementById("btn-abrir-painel-controle")?.addEventListener("click",()=>{openControlPanel(),closeModal("user-panel-modal")}),document.getElementById("btn-logout-panel")?.addEventListener("click",handleLogout),document.getElementById("change-password-btn")?.addEventListener("click",handlePasswordChange),document.getElementById("cancel-change-password")?.addEventListener("click",showLoginForm),document.getElementById("forgot-password-link")?.addEventListener("click",showForgotPasswordForm),document.getElementById("verify-answer-btn")?.addEventListener("click",handleVerifySecretAnswer),document.getElementById("cancel-forgot-password")?.addEventListener("click",showLoginForm),document.getElementById("save-secret-answer-btn")?.addEventListener("click",handleSaveSecretAnswer),document.getElementById("btn-abrir-loja")?.addEventListener("click",abrirLoja),document.querySelector(".botao-info[onclick*=\"info-moedas-modal\"]").addEventListener("click",popularModalRecompensas),document.getElementById("btn-ver-condominio")?.addEventListener("click",abrirVisaoCondominio),document.getElementById("btn-ranking-imobiliario")?.addEventListener("click",carregarRankingImobiliario),document.getElementById("info-moedas-modal").addEventListener("click",handleRewardEditClick),document.getElementById("btn-enviar-banco")?.addEventListener("click",abrirModalEnviarMoedasBanco),document.getElementById("enviar-moedas-banco-confirmar-btn")?.addEventListener("click",executarEnvioMoedasBanco),document.getElementById("btn-extrato-banco")?.addEventListener("click",abrirModalExtratoBanco),document.getElementById("btn-stats-banco")?.addEventListener("click",abrirModalEstatisticasBanco),document.querySelectorAll(".avatar-tab-btn[data-tab-stats]").forEach(e=>{e.addEventListener("click",()=>{const a=e.dataset.tabStats;document.querySelectorAll(".avatar-tab-btn[data-tab-stats]").forEach(e=>e.classList.remove("ativo")),document.querySelectorAll("#estatisticas-banco-modal .avatar-tab-content").forEach(e=>e.classList.remove("ativo")),e.classList.add("ativo"),document.getElementById(`stats-tab-${a}`).classList.add("ativo")})});const p=document.querySelector(".avatar-tab-btn[data-tab=\"inventario\"]"),g=document.querySelector(".avatar-tab-btn[data-tab=\"loja\"]"),f=document.getElementById("avatar-tab-inventario"),h=document.getElementById("avatar-tab-loja");p&&g&&f&&h?(p.addEventListener("click",()=>{p.classList.add("ativo"),g.classList.remove("ativo"),f.classList.add("ativo"),h.classList.remove("ativo"),popularInventario()}),g.addEventListener("click",()=>{g.classList.add("ativo"),p.classList.remove("ativo"),h.classList.add("ativo"),f.classList.remove("ativo"),popularLojaAvatar()})):console.error("N\xE3o foi poss\xEDvel encontrar os elementos das abas do Avatar")}async function loginUser(){const e=loginUsernameInput.value.trim(),a=loginPasswordInput.value.trim();if(!e||!a)return void mostrarPopup("Erro","Por favor, preencha todos os campos.",3e3);try{const o=doc(db,"users",e),t=await getDoc(o);if(t.exists()){const o=t.data();if(o.password===a){currentUser=e;const a=doc(db,"membros",currentUser),o=await getDoc(a);if(o.exists()){const e=o.data();currentUserRole=e.papel||"membro",currentUserTeam=e.equipe||null}else console.warn("Documento do membro n\xE3o encontrado na cole\xE7\xE3o 'membros' para o usu\xE1rio logado:",currentUser),currentUserRole="membro",currentUserTeam=null;await carregarInformacoesMembros(),await carregarInformacoesMembros();let t=`Bem-vindo(a), ${e}!`;"masculino"===membroData.genero&&(t=`Bem-vindo, ${e}!`),"feminino"===membroData.genero&&(t=`Bem-vinda, ${e}!`),mostrarPopup("Sucesso",t,3e3),authContainer.classList.add("hidden"),mainContent.classList.remove("hidden"),logoutBtn.classList.remove("hidden"),atualizarPermissoesCheckboxes()}else mostrarPopup("Erro","Senha incorreta.",3e3)}else mostrarPopup("Erro","Usu\xE1rio n\xE3o encontrado.",3e3)}catch(a){console.error("Erro ao fazer login: ",a),mostrarPopup("Erro","Erro ao fazer login. Tente novamente.",3e3)}}window.copyToClipboard=function(e,a){navigator.clipboard.writeText(e).then(()=>{mostrarPopup("\u2705 Copiado",`${a} copiado para a √°rea de transfer√™ncia!`,2e3)}).catch(e=>{console.error("Erro ao copiar: ",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel copiar.",3e3)})},window.podeDesenhar=function(e){if(!currentUser)return!1;const a=getHoje(),o=a.getDay();return!!(4===o||5===o||6===o||0===o||1===o||"lider"===userRole)&&(!("lider"!==userRole)||!(userTeam!==e))};function atualizarPermissoesCheckboxes(){const e=document.querySelectorAll(".tarefa-checkbox");e.forEach(e=>{const a=e.dataset.memberId,o=e.dataset.memberTeam;a&&o&&(e.disabled=!podeMarcarCheckbox(a,o))})}function atualizarVisualBloqueio(){currentUser&&todosMembros.forEach(e=>{const a=document.getElementById(e.nome);if(!a)return;let o=!1;("lider"===userRole||"lider-equipe"===userRole&&e.equipe===userTeam||currentUser===e.nome)&&(o=!0);const t=a.parentElement;t&&(o?(t.classList.remove("bloqueado"),t.title="Clique para marcar/desmarcar o foco"):(t.classList.add("bloqueado"),t.title="Voc\xEA n\xE3o tem permiss\xE3o para alterar este foco"))})}function showForgotPasswordForm(){loginForm.classList.add("hidden"),changePasswordForm.classList.add("hidden"),forgotPasswordForm.classList.remove("hidden")}async function handleVerifySecretAnswer(){let e=document.getElementById("forgot-username").value.trim();e&&(e=e.charAt(0).toUpperCase()+e.slice(1).toLowerCase());const a=document.getElementById("secret-answer").value.trim();if(!e||!a)return void mostrarPopup("\u274C Erro","Preencha seu nome e a resposta secreta.",3e3);try{const o=doc(db,"membros",e),t=await getDoc(o);if(t.exists()){const o=t.data();o.pet&&o.pet.toLowerCase()===a.toLowerCase()?(isPasswordResetFlow=!0,currentUser=e,mostrarPopup("\u2705 Correto","Resposta correta! Crie sua nova senha.",3e3),forgotPasswordForm.classList.add("hidden"),changePasswordForm.classList.remove("hidden")):mostrarPopup("\u274C Incorreto","A resposta para a pergunta secreta est\xE1 errada.",4e3)}else mostrarPopup("\u274C Erro","Usu\xE1rio n\xE3o encontrado.",3e3)}catch(e){console.error("Erro ao verificar resposta secreta:",e),mostrarPopup("\u274C Erro","Ocorreu um erro ao verificar os dados.",3e3)}}function showSecretQuestionForm(){loginForm.classList.add("hidden"),changePasswordForm.classList.add("hidden"),forgotPasswordForm.classList.add("hidden"),secretQuestionForm.classList.remove("hidden")}async function handleSaveSecretAnswer(){const e=document.getElementById("setup-secret-answer").value.trim();if(!e)return void mostrarPopup("\u274C Erro","Por favor, preencha a resposta.",3e3);try{const a=doc(db,"membros",currentUser);await updateDoc(a,{pet:e,usedProv:"on"});let o=`Bem-vindo(a), ${currentUser}!`;const t=todosMembros.find(e=>e.nome===currentUser);t&&("masculino"===t.genero?o=`Bem-vindo, ${currentUser}!`:"feminino"===t.genero&&(o=`Bem-vinda, ${currentUser}!`)),mostrarPopup("\u2705 Tudo Pronto!",`${o} Carregando o app...`,4e3),await performSuccessfulLogin(currentUser,!0)}catch(e){console.error("Erro ao salvar resposta secreta:",e),mostrarPopup("\u274C Falha Grave","Ocorreu um erro ao finalizar seu cadastro. Por favor, recarregue a p\xE1gina.",5e3)}}window.openModal=function(e){const a=document.getElementById(e);a&&(a.style.display="flex",a.classList.remove("hidden"),a.classList.add("show"))},window.closeModal=async function(e){const a=document.getElementById(e);a&&(a.style.display="none",a.classList.add("hidden"),a.classList.remove("show")),"function"==typeof hideMentionSuggestions&&hideMentionSuggestions();["pix-recebido-popup","medalha-ganha-popup","recompensa-recebida-popup","popup-envio-diario-moedas","custom-card-popup","recompensa-lideres-modal","recompensa-equipe-modal","fim-temporada-popup"].includes(e)&&(await new Promise(e=>setTimeout(e,100)),isCardPopupShowing=!1,"undefined"!=typeof cardPopupQueue&&0<cardPopupQueue.length&&"function"==typeof processarFilaCardPopup&&processarFilaCardPopup()),"notificacoes-modal"===e&&"undefined"!=typeof fluxoNotificacaoFoco&&fluxoNotificacaoFoco&&(fluxoNotificacaoFoco=!1,"function"==typeof updateLoadingOverlayText&&updateLoadingOverlayText("Maravilha, o foco foi registrado!"),"function"==typeof tocarSom&&tocarSom("som-check"),setTimeout(()=>{"function"==typeof hideLoadingOverlay&&hideLoadingOverlay()},1500),"function"==typeof verificarNudgesDiarios&&setTimeout(verificarNudgesDiarios,2e3)),"modal-nudge-combinado"===e&&"function"==typeof verificarNudgesDiarios&&setTimeout(()=>{verificarNudgesDiarios(!1)},100)};function showConfirmationPopup(e,a,o){document.getElementById("confirm-action-title").textContent=e,document.getElementById("confirm-action-text").innerHTML=a,document.getElementById("confirm-action-btn").onclick=()=>{closeModal("confirm-action-modal"),o()},openModal("confirm-action-modal")}async function handleUpdatePassword(){const e=document.getElementById("logged-in-new-password").value,a=document.getElementById("logged-in-confirm-password").value;if(!e||6>e.length)return void mostrarPopup("\u274C Erro","A senha deve ter no m\xEDnimo 6 caracteres.",3e3);if(e!==a)return void mostrarPopup("\u274C Erro","As senhas n\xE3o coincidem.",3e3);try{await updateDoc(doc(db,"membros",currentUser),{senha:e}),mostrarPopup("\u2705 Sucesso","Sua senha foi alterada!",3e3),closeModal("change-password-modal")}catch(e){mostrarPopup("\u274C Erro","Falha ao atualizar a senha.",3e3),console.error("Erro ao trocar senha:",e)}}async function handleUpdateSecretAnswer(){const e=document.getElementById("new-secret-answer").value.trim();if(!e)return void mostrarPopup("\u274C Erro","Por favor, digite uma resposta.",3e3);try{await updateDoc(doc(db,"membros",currentUser),{pet:e}),mostrarPopup("\u2705 Sucesso","Sua resposta secreta foi atualizada!",3e3),closeModal("change-secret-modal")}catch(e){mostrarPopup("\u274C Erro","Falha ao atualizar a resposta.",3e3),console.error("Erro ao trocar resposta secreta:",e)}}async function adicionarEventoAoFeed(e,a,o,t={},n=null){try{let i=n?doc(db,"resumoSemanalFeed",n):doc(collection(db,"resumoSemanalFeed"));const r={id:i.id,tipo:e,titulo:a,texto:o,timestamp:getHoje(),...t};return await setDoc(i,{...r,reacoes:t.reacoes||{"üëç":[],"üòÇ":[],"üò≠":[],"üíñ":[],"üò°":[]}},{merge:!0}),i.id}catch(e){return console.error("Erro ao adicionar evento ao feed:",e),null}}async function gerarEventoDeFoco(e,a,o,t){const n=a.charAt(0).toUpperCase()+a.slice(1);await adicionarEventoAoFeed("geral",`üìà Ponto para a equipe ${n}!`,`A equipe <strong>${n}</strong> avan√ßa com +1 ponto de <strong>${e}</strong> (${o} üî• dias de foco), totalizando <strong>${t}</strong> pontos!`,{nomeMembro:e,equipe:a})}async function gerarEventoDeFocoIndividual(e,a){await adicionarEventoAoFeed("geral","\uD83C\uDF1F Foco Pessoal Registrado!",`Mesmo sem uma equipe na competi√ß√£o, <strong>${e}</strong> mant√©m a disciplina, atingindo <strong>${a} üî• dias</strong> de foco. Parab√©ns pela dedica√ß√£o!`,{nomeMembro:e})}function criarElementoCardResumo(e){const a=document.createElement("div");a.className=`feed-card ${e.tipo}`,a.dataset.id=e.id;const o=e.timestamp?.toDate?e.timestamp.toDate():new Date,t=o.toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit",year:"numeric"}),n=o.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"}),i=e.reacoes||{};let r="";const d=Object.keys(i).sort((e,a)=>(i[a]?.length||0)-(i[e]?.length||0));d.forEach(a=>{const o=Array.isArray(i[a])?i[a]:[];if(0<o.length){const t=o.includes(currentUser),n=t?"reacted":"";r+=`
        <div class="reacao-display ${n}" 
             title="Reagido por: ${o.join(", ")}"
             onclick="toggleReacaoFeed(event, '${e.id}', '${a}')">
          ${a} <span class="contador-display">${o.length}</span>
        </div>`}});const s=r?`<div class="feed-card-reacoes">${r}</div>`:`<div class="feed-card-reacoes"></div>`;return a.innerHTML=`
    <div class="feed-card-header">
      <span>${e.titulo}</span>
      <span>${`${t}, ${n}`}</span>
      
      ${"lider"===userRole?`
        <button class="feed-card-delete-btn" title="Apagar evento" onclick="deletarEventoFeed(event, '${e.id}')">
          &times;
        </button>
      `:""}
      </div>
    <div class="feed-card-body">
      ${e.texto}
    </div>
    ${s}
  `,a.addEventListener("click",o=>{if(o.target.closest(".reacao-display"))return;document.querySelectorAll(".reacao-seletor-bar").forEach(e=>e.remove());const t=document.createElement("div");t.className="reacao-seletor-bar";["\uD83D\uDC4D","\uD83D\uDC96","\uD83D\uDE02","\uD83C\uDF89","\uD83D\uDD25","\uD83D\uDE2E","\uD83D\uDE2D","\uD83D\uDE21"].forEach(a=>{const o=document.createElement("button");o.textContent=a,o.onclick=o=>{o.stopPropagation(),toggleReacaoFeed(o,e.id,a),t.remove()},t.appendChild(o)}),a.querySelector(".feed-card-reacoes").appendChild(t),setTimeout(()=>{document.addEventListener("click",function e(o){a.contains(o.target)||(t.remove(),document.removeEventListener("click",e))},{once:!0})},100)}),a}let limiteAtualFeed=10,unsubscribeFeed=null;function configurarResumoSemanalTempoReal(){const e=document.getElementById("feed-semanal-cards");if(e){unsubscribeFeed&&unsubscribeFeed();const a=query(collection(db,"resumoSemanalFeed"),orderBy("timestamp","desc"),limit(limiteAtualFeed));unsubscribeFeed=onSnapshot(a,a=>{if(e.innerHTML="",feedEventosCache=[],a.empty)return void(e.innerHTML="<div class=\"sem-mensagens\">Nenhum evento importante aconteceu esta semana ainda.</div>");if(a.forEach(a=>{const o=a.data();feedEventosCache.push({titulo:o.titulo,texto:o.texto.replace(/<[^>]*>/g,""),data:o.timestamp?.toDate?o.timestamp.toDate().toLocaleDateString("pt-BR"):"Data desconhecida"});const t=criarElementoCardResumo(o);e.appendChild(t)}),a.size===limiteAtualFeed){const a=document.createElement("button");a.textContent="Ver mais antigos...",a.className="painel-btn",a.style.width="100%",a.style.marginTop="10px",a.onclick=()=>{limiteAtualFeed+=10,configurarResumoSemanalTempoReal()},e.appendChild(a)}})}}window.toggleReacaoComentario=async function(e,a,o,t){if(e.stopPropagation(),!currentUser)return;tocarSom("som-reacao");const n=doc(db,"mural",a,"comments",o),i=doc(db,"membros",currentUser);try{const e=await runTransaction(db,async e=>{const a=await e.get(n);if(!a.exists())throw"Coment\xE1rio n\xE3o existe!";const o=a.data(),i=o.userId;let r=o.reacoes||{},d=o.reactionNotificationIds||{};const s=`${currentUser}_${t}`;let l=null,m=0,c=!1;for(const a in r)if(Array.isArray(r[a])&&r[a].includes(currentUser)){l=a;break}if(l){const a=`${currentUser}_${l}`;d[a]&&(e.delete(doc(db,"notificacoes",d[a])),delete d[a])}if(l===t){const e=r[t].indexOf(currentUser);-1<e&&(r[t].splice(e,1),m=-1,c=!0)}else{if(l){const e=r[l].indexOf(currentUser);-1<e&&r[l].splice(e,1)}else m=1;r[t]||(r[t]=[]),r[t].push(currentUser)}if(1===m&&i&&i!==currentUser){const a=collection(db,"notificacoes"),n=doc(a);e.set(n,{destinatarioId:i,remetenteNome:currentUser,tipo:"comment-reaction",conteudo:t,acao:`reagiu ao seu coment√°rio: "${o.texto.substring(0,30)}..."`,lida:!1,timestamp:new Date}),d[s]=n.id}return e.update(n,{reacoes:r,reactionNotificationIds:d}),{removeuReacao:c,moedaDiff:m}});0!==e.moedaDiff&&(await updateDoc(doc(dbEssencial,"membros_essencial",currentUser),{moedas:increment(e.moedaDiff*(recompensasConfig.reagirConteudo||1))}).catch(a=>console.error("Erro ao creditar moeda de rea\xE7\xE3o do coment\xE1rio:",a))),e.removeuReacao?await reverterProgressoProtecao("reagir"):atualizarProgressoProtecao("reagir")}catch(e){console.error("Falha na transa\xE7\xE3o de rea\xE7\xE3o do coment\xE1rio: ",e),mostrarPopup("\u274C Ops!","Sua rea\xE7\xE3o n\xE3o p\xF4de ser salva. Por favor, recarregue a p\xE1gina.",4e3)}},window.toggleReacaoFeed=async function(e,a,o){if(e.stopPropagation(),!currentUser)return;atualizarReacaoOtimista("#feed-semanal-cards",a,o);const t=doc(db,"resumoSemanalFeed",a),n=doc(db,"membros",currentUser);try{tocarSom("som-reacao");const e=await runTransaction(db,async e=>{const a=await e.get(t);if(!a.exists())throw"Evento n\xE3o encontrado!";const n=a.data(),i=n.nomeMembro||n.nomeLider,r=n.reacoes||{};let d=n.reactionNotificationIds||{};const s=`${currentUser}_${o}`;let l=null,m=0,c=!1;for(const a in r)if(Array.isArray(r[a])&&r[a].includes(currentUser)){l=a;break}if(l){const a=`${currentUser}_${l}`;d[a]&&(e.delete(doc(db,"notificacoes",d[a])),delete d[a])}Array.isArray(r[o])||(r[o]=[]);const u=r[o].indexOf(currentUser);if(l===o)-1<u&&(r[o].splice(u,1),m=-1,c=!0);else{if(l){const e=r[l].indexOf(currentUser);-1<e&&r[l].splice(e,1)}else m=1;r[o].push(currentUser)}if(1===m&&i&&i!==currentUser){const a=collection(db,"notificacoes"),t=doc(a);e.set(t,{destinatarioId:i,remetenteNome:currentUser,tipo:"feed",conteudo:o,acao:`reagiu a um evento sobre voc√™: "${n.titulo}"`,lida:!1,timestamp:new Date}),d[s]=t.id}return e.update(t,{reacoes:r,reactionNotificationIds:d}),{removeuReacao:c,moedaDiff:m}});0!==e.moedaDiff&&(await updateDoc(doc(dbEssencial,"membros_essencial",currentUser),{moedas:increment(e.moedaDiff*(recompensasConfig.reagirConteudo||1))}).catch(a=>console.error("Erro ao creditar moeda de rea\xE7\xE3o no feed:",a))),e.removeuReacao?await reverterProgressoProtecao("reagir"):await atualizarProgressoProtecao("reagir")}catch(e){console.error("Erro ao reagir no feed:",e),mostrarPopup("\u274C Ops!","Sua rea\xE7\xE3o n\xE3o p\xF4de ser salva. Por favor, recarregue a p\xE1gina.",4e3)}};async function gerarReacaoOraculoParaMensagemComIA(e){if(!genAI)return"\uD83D\uDC4D";try{const a=await callGenerativeAIWithRetry(`
    Voc√™ √© o Or√°culo, um mentor s√°bio e carinhoso.
    Um membro do grupo postou a seguinte mensagem no mural:
    "${e}"
    
    Qual emoji melhor representa sua rea√ß√£o a esta mensagem?
    Escolha UM emoji da seguinte lista: ['üëç', 'üíñ', 'üòÇ', 'üéâ', 'üî•', 'üòÆ']

    Sua resposta DEVE ser um JSON v√°lido no formato: {"emoji": "SEU_EMOJI_AQUI"}.
    Apenas o JSON, sem explica√ß√µes.
  `),o=a.match(/{[\s\S]*}/)[0],{emoji:t}=JSON.parse(o);return t&&EMOJIS_MURAL.includes(t)?t:"\uD83D\uDC4D"}catch(e){return console.error("Or\xE1culo (Rea\xE7\xE3o Imediata): Erro final ao escolher emoji.",e),"\uD83D\uDC4D"}}async function gerarRespostaOraculoParaMensagem(e,a,o){if(genAI){console.log(`Or√°culo: Fui mencionado na mensagem de ${o}. Preparando resposta...`);try{const t=await callGenerativeAIWithRetry(`
    Voc√™ √© o Or√°culo, o mentor s√°bio e carinhoso do Grupo √âpicos.
    Um membro, "${o}", acabou de te mencionar em uma mensagem no mural. Sua tarefa √© escrever uma resposta direta e acolhedora.

    CONTEXTO:
    - Mensagem do Membro (que te mencionou): "${a}"

    INSTRU√á√ïES:
    1.  Sua resposta deve ser curta, am√°vel e no seu estilo de mentor.
    2.  Responda diretamente √† mensagem, mencionando o autor com <strong>@${o}</strong>.
    3.  N√ÉO se revele como uma IA. Aja 100% como uma pessoa.
    4.  Assine sua resposta com "‚Äî Or√°culo".
    5.  Sua resposta deve ser apenas o texto do coment√°rio, sem formata√ß√£o JSON ou introdu√ß√µes.
  `),n=collection(db,"mural",e,"comments");await addDoc(n,{userId:"Or\xE1culo",texto:t.replace(/\n/g,"<br>"),timestamp:new Date,reacoes:EMOJIS_MURAL.reduce((e,a)=>({...e,[a]:[]}),{})}),await updateDoc(doc(db,"mural",e),{commentCount:increment(1)}),console.log("Or\xE1culo: Resposta \xE0 mensagem enviada como coment\xE1rio com sucesso.")}catch(e){console.error("Or\xE1culo: Erro ao gerar ou postar resposta de mensagem:",e)}}}async function executarInteracaoImediataOraculo(e,a,o){const t=await obterContextoDinamicoParaIA(),n=await gerarReacaoERespostaCombinadaComIA(`
    O membro "${o}" acabou de postar a seguinte mensagem no mural: "${a}"
    
    --- CONTEXTO ATUAL DO GRUPO PARA SUA AN√ÅLISE ---
    ${t}
  `,`
    1.  Escolha UM emoji de rea√ß√£o da lista: ['üëç', 'üíñ', 'üòÇ', 'üéâ', 'üî•', 'üòÆ'].
    2.  Escreva uma resposta curta, am√°vel e no seu estilo de mentor, mencionando o autor com <strong>@${o}</strong>.
    3.  Analise o CONTEXTO ATUAL DO GRUPO para dar uma resposta relevante. Se a pergunta for sobre quem vai ganhar, voc√™ DEVE se posicionar e fazer uma aposta com base nos dados.
    4.  Assine sua resposta com "‚Äî Or√°culo".
    5.  N√ÉO se revele como uma IA.
  `);if(!n)return void console.error("Or\xE1culo (Mensagem): Falha ao obter dados da IA. A intera\xE7\xE3o ser\xE1 abortada.");try{await adicionarReacaoComoOraculo(e,n.emoji);const a=collection(db,"mural",e,"comments");await addDoc(a,{userId:"Or\xE1culo",texto:n.resposta.replace(/\n/g,"<br>"),timestamp:new Date,reacoes:EMOJIS_MURAL.reduce((e,a)=>({...e,[a]:[]}),{})}),await updateDoc(doc(db,"mural",e),{commentCount:increment(1)}),console.log("Or\xE1culo: Rea\xE7\xE3o e resposta \xE0 MENSAGEM enviadas com sucesso.")}catch(e){console.error("Or\xE1culo (Mensagem): Erro ao postar rea\xE7\xE3o ou coment\xE1rio.",e)}}async function limparApostasLoteriaAntigas(){console.log("\uD83E\uDDF9 Verificando apostas de loteria antigas...");try{const e=doc(db,"loteria","estadoAtual"),a=await getDoc(e);if(!a.exists())return;const o=a.data().edicao,t=collection(db,"loteria","estadoAtual","apostasDaEdicao"),n=query(t,where("edicao","<",o)),i=await getDocs(n);if(i.empty)return void console.log("Nenhuma aposta antiga de loteria para limpar.");const r=writeBatch(db);i.forEach(e=>{r.delete(e.ref)}),await r.commit(),console.log(`‚úÖ Limpeza conclu√≠da! ${i.size} apostas de loteria antigas foram removidas.`)}catch(e){console.error("Erro ao limpar apostas antigas:",e)}}async function limparBloqueiosAntigosUsuario(){if(!currentUser)return;const e=todosMembros.find(e=>e.nome===currentUser);if(!e||!e.bloqueiosPopups)return;const a=getHojeISO(),o=e.bloqueiosPopups,t={};let n=!1,i=0;for(const e in o)e.endsWith(a)?t[e]=!0:(n=!0,i++);if(n){console.log(`üßπ Limpeza de Bloqueios: Detectado ${i} registros antigos. Reescrevendo mapa...`);try{const a=doc(db,"membros",currentUser);await updateDoc(a,{bloqueiosPopups:t}),e.bloqueiosPopups=t,localStorage.setItem("epicos_cache_membros",JSON.stringify(todosMembros)),console.log("\u2705 Mapa de bloqueios limpo com sucesso.")}catch(e){console.error("Erro na limpeza de bloqueios:",e)}}else console.log("\uD83E\uDDF9 Nenhum bloqueio antigo encontrado. O mapa est\xE1 limpo.")}async function limparHistoricoTopicosOraculo(){try{console.log("Limpando hist\xF3ricos de t\xF3picos do Or\xE1culo de semanas anteriores...");const e=getSemanaAtual(),a=`oraculoTopics_${e.numero}_${e.inicio.getFullYear()}`,o=query(collection(db,"appState")),t=await getDocs(o);if(t.empty)return;const n=writeBatch(db);let i=0;t.forEach(e=>{e.id.startsWith("oraculoTopics_")&&e.id!==a&&(n.delete(e.ref),i++)}),0<i&&(await n.commit(),console.log(`‚úÖ Limpeza conclu√≠da: ${i} registro(s) de hist√≥rico de t√≥picos do Or√°culo foram removidos.`))}catch(e){console.error("Erro ao limpar hist\xF3ricos de t\xF3picos do Or\xE1culo:",e)}}async function limparHistoricoNotificacoesOraculo(){try{console.log("Limpando hist\xF3ricos de notifica\xE7\xE3o do Or\xE1culo de semanas anteriores...");const e=getSemanaAtual(),a=`oraculoHistory_semana_${e.numero}_${e.inicio.getFullYear()}`,o=query(collection(db,"appState")),t=await getDocs(o);if(t.empty)return;const n=writeBatch(db);let i=0;t.forEach(e=>{e.id.startsWith("oraculoHistory_")&&e.id!==a&&(n.delete(e.ref),i++)}),0<i&&(await n.commit(),console.log(`‚úÖ Limpeza conclu√≠da: ${i} registro(s) de hist√≥rico do Or√°culo foram removidos.`))}catch(e){console.error("Erro ao limpar hist\xF3ricos de notifica\xE7\xE3o do Or\xE1culo:",e)}}async function limparFeedSemanal(){console.log("\uD83E\uDDF9 Verificando e limpando o feed da semana anterior...");const e=query(collection(db,"resumoSemanalFeed")),a=await getDocs(e);if(a.empty)return void console.log("Feed j\xE1 estava limpo.");const o=writeBatch(db);a.forEach(e=>{o.delete(e.ref)}),await o.commit(),console.log(`‚úÖ Feed limpo! ${a.size} eventos removidos.`),await adicionarEventoAoFeed("geral","\u2728 Uma Nova Semana Come\xE7ou!","O resumo da semana foi zerado. Que esta seja uma semana produtiva e cheia de foco para todos n\xF3s!")}async function limparTodoOMural(){console.log("\uD83E\uDDF9 Verificando e limpando o mural de mensagens...");const e=query(collection(db,"mural")),a=await getDocs(e);if(a.empty)return void console.log("Mural de mensagens j\xE1 estava limpo.");const o=writeBatch(db);a.forEach(e=>{o.delete(e.ref)}),await o.commit(),console.log(`‚úÖ Mural limpo! ${a.size} mensagens removidas.`)}async function limparNotificacoesAntigas(){console.log("\uD83E\uDDF9 Verificando e limpando notifica\xE7\xF5es antigas...");try{const e=new Date,a=new Date(e.setDate(e.getDate()-7)),o=query(collection(db,"notificacoes"),where("timestamp","<",a)),t=await getDocs(o);if(t.empty)return void console.log("Nenhuma notifica\xE7\xE3o antiga para limpar.");const n=writeBatch(db);t.forEach(e=>{n.delete(e.ref)}),await n.commit(),console.log(`‚úÖ Limpeza conclu√≠da! ${t.size} notifica√ß√µes antigas foram removidas.`)}catch(e){console.error("Erro ao limpar notifica\xE7\xF5es antigas:",e)}}async function limparTodosOsComentariosDoMural(){console.log("\uD83E\uDDF9 Verificando e limpando os coment\xE1rios do mural...");try{const e=collection(db,"mural"),a=await getDocs(e);if(a.empty)return void console.log("Nenhuma mensagem no mural para limpar coment\xE1rios.");const o=writeBatch(db);let t=0;for(const e of a.docs){const a=collection(db,"mural",e.id,"comments"),n=await getDocs(a);n.empty||n.forEach(e=>{o.delete(e.ref),t++})}0<t?(await o.commit(),console.log(`‚úÖ Coment√°rios limpos! ${t} coment√°rios foram removidos.`)):console.log("Nenhum coment\xE1rio encontrado para apagar.")}catch(e){console.error("Erro ao limpar os coment\xE1rios do mural:",e)}}async function limparTodasAsTelasDeDesenho(){console.log("\uD83E\uDDF9 Limpando ciclo completo de desenho...");const e=["abelha","joaninha","vagalume"];try{const a=writeBatch(db),o=writeBatch(dbDesenho);for(const a of e){const e=query(collection(dbDesenho,`desenhos_${a}`)),t=await getDocs(e);t.empty||t.forEach(e=>o.delete(e.ref))}const t=getSemanaAtual(),n=`semana_${t.numero}_${t.inicio.getFullYear()}`,i=doc(dbDesenho,"interacoesDesenho",n);o.delete(i);for(const a of e){const e=doc(dbDesenho,"desenho_previews",`preview_${n}_${a}`);o.delete(e)}await o.commit(),console.log("\u2705 Limpeza completa realizada (incluindo novos previews)."),document.querySelectorAll(".like-count, .dislike-count").forEach(e=>e.textContent="0"),document.querySelectorAll(".like-container, .dislike-container").forEach(e=>e.classList.remove("ativo","like-ativo","dislike-ativo")),e.forEach(e=>{const a=document.getElementById(`preview-canvas-${e}`);if(a){const e=a.getContext("2d");e.clearRect(0,0,a.width,a.height)}})}catch(e){console.error("Erro cr\xEDtico ao limpar as telas de desenho:",e),mostrarPopup("\u274C Erro","Falha na limpeza. Verifique o console.",4e3)}}async function limparPopupStateAntigo(){try{console.log("Limpando estados de popup de semanas anteriores...");const e=getSemanaAtual(),a=`popupState_${e.numero}_${e.inicio.getFullYear()}`,o=query(collection(db,"appState")),t=await getDocs(o);if(t.empty)return;const n=writeBatch(db);let i=0;t.forEach(e=>{e.id.startsWith("popupState_")&&e.id!==a&&(n.delete(e.ref),i++)}),0<i&&(await n.commit(),console.log(`‚úÖ Limpeza conclu√≠da: ${i} registro(s) de estado de popup antigos foram removidos.`))}catch(e){console.error("Erro ao limpar estados de popup antigos:",e)}}async function limparStatusPoderesAntigos(){try{console.log("\uD83E\uDDF9 Limpeza Semanal: Removendo TODOS os efeitos de poderes ativos...");const e=query(collection(db,"statusPoderes")),a=await getDocs(e);if(a.empty)return void console.log("Nenhum status de poder ativo para limpar.");const o=writeBatch(db);let t=0;a.forEach(e=>{o.delete(e.ref),t++}),await o.commit(),statusPoderesAtivos=[],console.log(`‚úÖ Limpeza conclu√≠da: ${t} efeitos de magia foram removidos para o in√≠cio da nova semana.`)}catch(e){console.error("Erro ao limpar registros de poderes antigos:",e)}}async function limparBloqueiosPopupsDeTodos(){console.log("\uD83E\uDDF9 Faxina Geral: Removendo campo 'bloqueiosPopups' de todos os membros...");try{const e=collection(db,"membros"),a=await getDocs(e);if(a.empty)return;const o=writeBatch(db);let t=0;a.forEach(e=>{o.update(e.ref,{bloqueiosPopups:deleteField()}),t++}),await o.commit(),console.log(`‚úÖ Sucesso! Campo 'bloqueiosPopups' removido de ${t} membros.`)}catch(e){console.error("Erro ao limpar bloqueios de popups geral:",e)}}async function limparMensagensDiariasAntigas(){console.log("\uD83E\uDDF9 Verificando mensagens di\xE1rias antigas...");try{const e=getHojeISO(),a=query(collection(db,"mensagensDiarias")),o=await getDocs(a);if(o.empty)return void console.log("Nenhuma mensagem di\xE1ria para limpar.");const t=writeBatch(db);let n=0;o.forEach(a=>{a.id.endsWith(e)||(t.delete(a.ref),n++)}),0<n?(await t.commit(),console.log(`‚úÖ Limpeza conclu√≠da! ${n} mensagens di√°rias antigas foram removidas.`)):console.log("Nenhuma mensagem antiga encontrada (todas s\xE3o de hoje).")}catch(e){console.error("Erro ao limpar cole\xE7\xE3o 'mensagensDiarias':",e)}}async function limparRotinasDiariasAntigas(){console.log("\uD83E\uDDF9 Limpando logs de rotinas de dias anteriores...");try{const e=getHojeISO(),a=query(collection(db,"rotinas_diarias"),where("__name__","<",e)),o=await getDocs(a);if(!o.empty){const e=writeBatch(db);o.forEach(a=>{e.delete(a.ref)}),await e.commit(),console.log(`‚úÖ ${o.size} logs antigos de rotina foram removidos.`)}}catch(e){console.error("Erro ao limpar rotinas antigas:",e)}}async function limparDailyTasksAntigas(){console.log("\uD83E\uDDF9 Verificando dailyTasks antigos em appState...");try{const e=getHojeISO(),a=new Date(e+"T00:00:00"),o=query(collection(db,"appState")),t=await getDocs(o);if(t.empty)return;const n=writeBatch(db);let i=0;t.forEach(e=>{const o=e.id;if(o.startsWith("dailyTasks_")){const t=o.replace("dailyTasks_",""),r=new Date(t+"T00:00:00");r<a&&(console.log(`Marcando para exclus√£o: ${o}`),n.delete(e.ref),i++)}}),0<i?(await n.commit(),console.log(`‚úÖ Limpeza conclu√≠da: ${i} dailyTasks antigos foram removidos.`)):console.log("Nenhum dailyTask antigo encontrado (anteriores a hoje).")}catch(e){console.error("Erro ao limpar dailyTasks antigos:",e)}}async function limparLocksAntigosDaArvore(){console.log("\uD83E\uDDF9 Verificando locks antigos da \xC1rvore \xC9pica...");try{const e=getHojeISO(),a=query(collection(db,"appState")),o=await getDocs(a);if(o.empty)return;const t=writeBatch(db);let n=0;o.forEach(a=>{a.id.startsWith("lock_arvore_")&&a.id!==`lock_arvore_${e}`&&(t.delete(a.ref),n++)}),0<n&&(await t.commit(),console.log(`‚úÖ Limpeza conclu√≠da: ${n} lock(s) antigos da √°rvore foram removidos.`))}catch(e){console.error("Erro ao limpar locks antigos da \xE1rvore:",e)}}async function limparRecompensasLideresAntigas(){console.log("\uD83E\uDDF9 Verificando recompensas de l\xEDderes antigas...");try{const e=getHoje(),a=getSemanaAtual(),o=getSemanaAtual(new Date(e.getTime()-604800000)),t=`semana_${a.numero}_${a.inicio.getFullYear()}`,n=`semana_${o.numero}_${o.inicio.getFullYear()}`,i=collection(db,"recompensasLideres"),r=await getDocs(i);if(r.empty)return void console.log("Nenhuma recompensa antiga para limpar.");const d=writeBatch(db);let s=0;r.forEach(e=>{e.id!==t&&e.id!==n&&(console.log(`Marcando para apagar recompensa antiga: ${e.id}`),d.delete(e.ref),s++)}),0<s?(await d.commit(),console.log(`‚úÖ Limpeza conclu√≠da: ${s} registros de recompensas antigos removidos.`)):console.log("Nenhum registro antigo de recompensa encontrado.")}catch(e){console.error("Erro ao limpar recompensas de l\xEDderes antigas:",e)}}async function limparEnviosDiariosAntigos(){console.log("\uD83E\uDDF9 Verificando envios di\xE1rios antigos...");try{const e=new Date;e.setHours(0,0,0,0);const a=collection(db,"enviosDiarios"),o=await getDocs(a);if(o.empty)return void console.log("Nenhum registro de envio di\xE1rio encontrado para limpar.");const t=writeBatch(db);let n=0;o.forEach(a=>{const o=a.id.split("_");if(1<o.length){const i=o[o.length-1],r=new Date(i+"T12:00:00");r<e&&(t.delete(a.ref),n++)}}),0<n?(await t.commit(),console.log(`‚úÖ Limpeza conclu√≠da! ${n} registro(s) de envio di√°rio antigos foram removidos.`)):console.log("Nenhum registro de envio di\xE1rio antigo para apagar nesta verifica\xE7\xE3o.")}catch(e){console.error("Erro ao limpar a cole\xE7\xE3o 'enviosDiarios':",e)}}async function requestGlobalRefresh(){if(confirm("Tem certeza que deseja for\xE7ar a atualiza\xE7\xE3o da p\xE1gina para todos os membros?"))try{const e=doc(db,"appState","status");await setDoc(e,{lastRefreshRequest:new Date}),mostrarPopup("\uD83D\uDE80 Enviado!","Comando de atualiza\xE7\xE3o enviado para todos os membros.",3e3)}catch(e){console.error("Erro ao solicitar atualiza\xE7\xE3o global:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel enviar o comando.",4e3)}}function setupRefreshListener(){const e=doc(db,"appState","status");onSnapshot(e,e=>{if(e.exists()){const a=e.data().lastRefreshRequest?.toDate();if(a){if(null===lastRefreshTimestamp)return void(lastRefreshTimestamp=a);a>lastRefreshTimestamp&&(console.log("Recebido comando de atualiza\xE7\xE3o global. Atualizando a interface..."),lastRefreshTimestamp=a,refreshAppUI())}}})}async function triggerForcedUpdate(){if(confirm("\u26A0\uFE0F ATEN\xC7\xC3O!\n\nVoc\xEA est\xE1 prestes a for\xE7ar uma atualiza\xE7\xE3o para TODOS os membros. A tela deles ser\xE1 bloqueada at\xE9 que cliquem no bot\xE3o para atualizar.\n\nUse isso apenas ap\xF3s ter certeza de que uma nova vers\xE3o do aplicativo est\xE1 no ar.\n\nDeseja continuar?"))try{const e=doc(db,"appState","status");await setDoc(e,{requiredUpdateVersion:new Date},{merge:!0}),mostrarPopup("\uD83D\uDE80 Enviado!","Comando de atualiza\xE7\xE3o de vers\xE3o enviado.",4e3)}catch(e){console.error("Erro ao for\xE7ar atualiza\xE7\xE3o:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel enviar o comando.",4e3)}}function showUpdateOverlay(){const e=document.getElementById("update-overlay");e&&e.classList.remove("hidden")}function performUpdate(){return officialAppVersion?void(sessionStorage.removeItem("popupDiarioMostrado"),sessionStorage.removeItem("popupAnaliseOraculoVisto"),localStorage.setItem("currentAppVersion",officialAppVersion.toISOString()),location.reload(!0)):void location.reload(!0)}function setupVersionCheckListener(){const e=doc(db,"appState","status");onSnapshot(e,e=>{if(e.exists()){const a=e.data();if(a.requiredUpdateVersion){officialAppVersion=a.requiredUpdateVersion.toDate();const e=localStorage.getItem("currentAppVersion"),o=e?new Date(e):new Date(0);officialAppVersion>o&&(console.log("Nova vers\xE3o detectada. Exibindo tela de atualiza\xE7\xE3o."),showUpdateOverlay())}}})}window.deletarEventoFeed=async function(e,a){if(e.stopPropagation(),!!confirm("Tem certeza que deseja apagar este evento do feed?"))try{const e=doc(db,"resumoSemanalFeed",a);await deleteDoc(e),mostrarPopup("\u2705 Sucesso","O evento foi removido do feed.",3e3)}catch(e){console.error("Erro ao deletar evento do feed:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel remover o evento.",4e3)}};async function carregarCondominioEpicos(){if(!currentUser)return;const e=todosMembros.find(e=>e.nome===currentUser);if(!e)return;const a=document.getElementById("nome-membro-condominio"),o=document.getElementById("saldo-moedas"),t=document.querySelector("#indicador-moedas-pessoal span");a&&(a.textContent=currentUser),o&&(o.textContent=(e.moedas||0).toLocaleString("pt-BR")),t&&(t.textContent=(e.moedas||0).toLocaleString("pt-BR"));const n=document.getElementById("lote-pessoal-container"),i=e.casaExibida;if(i&&e.inventarioCasas?.includes(i))try{const e=await getDoc(doc(db,"loja_casas",i));e.exists()&&(n.innerHTML=`<img src="${e.data().imagemURL}" alt="${e.data().nome}">`)}catch(a){console.error("Erro ao carregar imagem da casa",a)}else n.innerHTML=`
            <div class="placa-terreno">
                <div class="placa-madeira">Voc√™ ainda n√£o comprou uma casa no condom√≠nio √©picos.</div>
                <div class="haste-madeira"></div>
            </div>
        `;const r=getHoje(),d=r.getHours(),s=18<=d||6>d,l=document.querySelector("#condominio-container .tree-sky");if(l)if(s){l.classList.add("night-mode"),l.classList.remove("day-mode"),criarEstrelas();const e=l.querySelector(".stars-container");e&&(e.style.opacity="1")}else{l.classList.remove("night-mode"),l.classList.add("day-mode");const e=l.querySelector(".stars-container");e&&(e.style.opacity="0")}document.getElementById("sol-condominio").style.opacity=s?"0":"1",document.getElementById("lua-condominio").style.opacity=s?"1":"0"}async function abrirLoja(){const e={pequena:document.getElementById("catalogo-pequenas"),media:document.getElementById("catalogo-medias"),mansao:document.getElementById("catalogo-mansoes")};for(const a in e)e[a].innerHTML="<p>Carregando casas...</p>";openModal("loja-modal");try{const a=todosMembros.find(e=>e.nome===currentUser);if(!a)throw"Dados do usu\xE1rio n\xE3o carregados.";const o=a.moedas||0,t=a.inventarioCasas||[],n=await getDocs(collection(db,"loja_casas"));for(const a in e)e[a].innerHTML="";n.forEach(a=>{const n={id:a.id,...a.data()},i=e[n.categoria];if(!i)return;const r=t.includes(n.id),d=o>=n.preco,s=document.createElement("div");s.className="casa-card",s.innerHTML=`
        <div class="casa-card-imagem"><img src="${n.imagemURL}" alt="${n.nome}"></div>
        <div class="casa-card-info">
          <div>
            <div class="casa-card-nome">${n.nome}</div>
            <div class="casa-card-preco">üí∞ ${n.preco}</div>
          </div>
          <button class="painel-btn btn-adicionar btn-comprar" 
                  onclick="comprarCasa('${n.id}', ${n.preco})"
                  ${r||!d?"disabled":""}>
            ${r?"J\xE1 Comprada":"Comprar"}
          </button>
        </div>
      `,i.appendChild(s)})}catch(e){console.error("Erro ao abrir a loja:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel carregar a loja.",4e3)}}window.comprarCasa=async function(e,a){const o=document.getElementById("confirm-compra-texto");o.innerHTML=`Voc√™ tem certeza que deseja comprar esta casa por <strong>üí∞ ${a} moedas</strong>?`;const t=document.getElementById("confirm-compra-btn");t.onclick=()=>executarCompraCasa(e,a),openModal("confirm-compra-modal")};async function executarCompraCasa(e,a){closeModal("confirm-compra-modal");const o=doc(db,"membros",currentUser),t=doc(dbEssencial,"membros_essencial",currentUser);try{const n=await getDoc(t),i=n.exists()?n.data().moedas||0:0;if(i<a)throw"Moedas insuficientes.";await runTransaction(db,async a=>{const t=await a.get(o),n=t.exists()?t.data().inventarioCasas||[]:[],i=0===n.length,r={inventarioCasas:arrayUnion(e)};i&&(r.casaExibida=e),a.update(o,r)}),await updateDoc(t,{moedas:increment(-a)});const r=doc(db,"loja_casas",e),d=await getDoc(r);if(d.exists()){const e=d.data(),a=document.getElementById("lote-pessoal-container");a&&(a.innerHTML=`<img src="${e.imagemURL}" alt="${e.nome}">`)}mostrarPopup("\uD83C\uDF89 Parab\xE9ns!","Voc\xEA comprou uma nova casa!",5e3),dispararConfete(),abrirLoja()}catch(e){console.error("Erro na compra:",e),mostrarPopup("\u274C Falha na Compra",e.toString(),4e3)}}async function abrirVisaoCondominio(){const e=document.getElementById("condominio-map");e.innerHTML="<h2>Carregando condom\xEDnio...</h2>",document.getElementById("condominio-view-overlay").classList.remove("hidden");try{const a=await getDocs(collection(db,"loja_casas")),o=todosMembros.map(e=>({id:e.nome,...e})),t={};a.forEach(e=>t[e.id]=e.data());const n=todosMembros.length,i=Math.ceil(1.2*Math.sqrt(n));e.innerHTML="",todosMembros.forEach(a=>{const o=document.createElement("div");o.className="lote-condominio",o.id=`lote-${a.nome}`;const n=a.casaExibida,i=n&&t[n]?t[n]:null,r=document.createElement("div");r.className="casa-imagem-container",r.innerHTML=i?`
          <img src="${i.imagemURL}" 
               class="casa-no-lote ${i.categoria}" 
               alt="${i.nome}">
        `:`
  <div class="placa-terreno">
    <div class="placa-madeira">sem casa</div>
    <div class="haste-madeira"></div>
  </div>
`,o.appendChild(r);const d=document.createElement("div");d.className="nome-lote",d.textContent=a.nome,d.id=`nome-lote-${a.nome}`,d.onclick=e=>toggleNameplateColorPalette(e,a.nome),a.nomeLoteCor&&(d.style.backgroundColor=a.nomeLoteCor,d.style.color=isColorDark(a.nomeLoteCor)?"#FFFFFF":"#000000"),o.appendChild(d);const s=document.createElement("div");s.id=`palette-container-${a.nome}`,s.className="nameplate-palette hidden",o.appendChild(s),e.appendChild(o)});const r=document.getElementById("condominio-map-wrapper");let d=!1,s,l,m,c;const u=a=>{d=!0,r.classList.add("active");const e=a.pageX||a.touches[0].pageX,o=a.pageY||a.touches[0].pageY;s=e-r.offsetLeft,l=o-r.offsetTop,m=r.scrollLeft,c=r.scrollTop},p=()=>{d=!1},g=a=>{if(!d)return;a.preventDefault();const e=a.pageX||a.touches[0].pageX,o=a.pageY||a.touches[0].pageY,t=e-r.offsetLeft,n=o-r.offsetTop,i=2*(t-s),u=2*(n-l);r.scrollLeft=m-i,r.scrollTop=c-u};r.addEventListener("mousedown",u),r.addEventListener("mouseleave",p),r.addEventListener("mouseup",p),r.addEventListener("mousemove",g),r.addEventListener("touchstart",u,{passive:!0}),r.addEventListener("touchend",p),r.addEventListener("touchmove",g)}catch(a){console.error("Erro ao montar o condom\xEDnio:",a),e.innerHTML="<h2>Ocorreu um erro ao carregar o condom\xEDnio.</h2>"}}function formatarDataISO(e){if(!e)return"";const a=e.getFullYear(),o=(e.getMonth()+1+"").padStart(2,"0"),t=(e.getDate()+"").padStart(2,"0");return`${a}-${o}-${t}`}async function limparFeedManualmente(){if(confirm("\u26A0\uFE0F ATEN\xC7\xC3O!\n\nVoc\xEA est\xE1 prestes a apagar TODOS os eventos do feed da semana.\n\nDeseja continuar?"))try{const e=collection(db,"resumoSemanalFeed"),a=await getDocs(e);if(a.empty)return void mostrarPopup("\u2139\uFE0F Informa\xE7\xE3o","O feed da semana j\xE1 est\xE1 limpo.",3e3);const o=writeBatch(db);a.forEach(e=>{o.delete(e.ref)}),await o.commit(),mostrarPopup("\u2705 Sucesso",`Todos os ${a.size} eventos do feed foram apagados.`,5e3)}catch(e){console.error("Erro ao limpar feed manualmente:",e),mostrarPopup("\u274C Erro","Ocorreu uma falha ao tentar limpar o feed.",4e3)}}async function limparMuralManualmente(){if(confirm("\u26A0\uFE0F ATEN\xC7\xC3O!\n\nVoc\xEA est\xE1 prestes a apagar TODAS as mensagens do mural.\n\nEsta a\xE7\xE3o \xE9 permanente. Deseja continuar?"))try{const e=collection(db,"mural"),a=await getDocs(e);if(a.empty)return void mostrarPopup("\u2139\uFE0F Informa\xE7\xE3o","O mural de mensagens j\xE1 est\xE1 vazio.",3e3);const o=writeBatch(db);a.forEach(e=>{o.delete(e.ref)}),await o.commit(),mostrarPopup("\u2705 Sucesso",`Todas as ${a.size} mensagens do mural foram apagadas.`,5e3)}catch(e){console.error("Erro ao limpar mural manualmente:",e),mostrarPopup("\u274C Erro","Ocorreu uma falha ao tentar limpar o mural.",4e3)}}async function abrirInventario(){const e=document.getElementById("inventario-grid");e.innerHTML="<p>Carregando seu invent\xE1rio...</p>",openModal("inventario-modal");try{const a=await getDocs(collection(db,"loja_casas")),o=todosMembros.find(e=>e.nome===currentUser);if(!o)throw"Dados do membro n\xE3o encontrados no cache.";const t=o.inventarioCasas||[],n=o.casaExibida,i={};if(a.forEach(e=>{i[e.id]={id:e.id,...e.data()}}),e.innerHTML="",0===t.length)return void(e.innerHTML="<p style=\"text-align: center; font-style: italic;\">Voc\xEA ainda n\xE3o comprou nenhuma casa. Visite a loja!</p>");t.forEach(a=>{const o=i[a];if(!o)return;const t=o.id===n,r=document.createElement("div");r.className="casa-card",t&&r.classList.add("selecionada"),r.innerHTML=`
        <div class="casa-card-imagem"><img src="${o.imagemURL}" alt="${o.nome}"></div>
        <div class="casa-card-info">
          <div>
            <div class="casa-card-nome">${o.nome}</div>
          </div>
          <button class="painel-btn btn-adicionar btn-definir-principal" 
                  onclick="definirCasaPrincipal('${o.id}')"
                  ${t?"disabled":""}>
            ${t?"Principal":"Exibir esta"}
          </button>
        </div>
      `,e.appendChild(r)})}catch(e){console.error("Erro ao abrir o invent\xE1rio:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel carregar seu invent\xE1rio.",4e3),closeModal("inventario-modal")}}window.definirCasaPrincipal=async function(e){const a=doc(db,"membros",currentUser);try{await updateDoc(a,{casaExibida:e}),mostrarPopup("\u2705 Sucesso!","Sua casa principal foi atualizada.",3e3),await carregarCondominioEpicos(),closeModal("inventario-modal")}catch(e){console.error("Erro ao definir casa principal:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel salvar sua escolha.",4e3)}};function toggleNameplateColorPalette(e,a){if(e.stopPropagation(),currentUser!==a&&"lider"!==userRole)return void mostrarPopup("\uD83D\uDEAB Acesso Negado","Voc\xEA s\xF3 pode alterar a cor da sua pr\xF3pria placa.",3e3);const o=document.getElementById(`palette-container-${a}`),t=o.classList.contains("hidden");document.querySelectorAll(".nameplate-palette").forEach(e=>e.classList.add("hidden")),t&&(createNameplateColorPalette(a),o.classList.remove("hidden"))}function createNameplateColorPalette(e){const a=document.getElementById(`palette-container-${e}`);if(a&&""===a.innerHTML){["#FFFFFF","#FADADD","#FFD6A5","#FDFFB6","#CAFFBF","#9BF6FF","#A0C4FF","#BDB2FF","#FFC6FF","#EAE4E9","#D4E09B","#C3E0E5","#F7D6E0","#F3E9DD","#D3E4CD","#FF1744","#F50057","#D500F9","#651FFF","#3D5AFE","#2979FF","#00B0FF","#00E5FF","#1DE9B6","#00E676","#76FF03","#C6FF00","#FFEA00","#FFC400","#FF9100","#FF3D00","#F38375","#FBC42C","#57C479","#57C5C8","#578DC8","#8A57C8","#C857B2","#4B4A49","#ACACAC","#795548","#607D8B","#000000","#E57373","#BA68C8","#7986CB","#4FC3F7","#4DB6AC","#AED581","#FFF176","#FFB74D","#A1887F","#90A4AE","#008F93","#F08080","#20B2AA","#87CEEB","#9370DB","#DA70D6"].forEach(o=>{const t=document.createElement("div");t.className="nameplate-color-option",t.style.backgroundColor=o,t.onclick=a=>selectNameplateColor(a,e,o),a.appendChild(t)})}}async function selectNameplateColor(e,a,o){e.stopPropagation();const t=document.getElementById(`nome-lote-${a}`),n=document.getElementById(`palette-container-${a}`);t.style.backgroundColor=o,t.style.color=isColorDark(o)?"#FFFFFF":"#000000",n.classList.add("hidden");try{const e=doc(db,"membros",a);await updateDoc(e,{nomeLoteCor:o}),mostrarPopup("\uD83C\uDFA8 Sucesso","A cor da sua placa foi alterada!",2e3)}catch(e){console.error("Erro ao salvar a cor da placa:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel salvar a nova cor.",3e3)}}function findMyHouse(){if(!currentUser)return;const e=document.getElementById(`lote-${currentUser}`),a=document.getElementById("condominio-map-wrapper");if(e&&a){const o=e.offsetTop,t=e.offsetLeft,n=e.clientHeight,i=e.clientWidth,r=a.clientHeight,d=a.clientWidth;a.scrollTo({top:o-r/2+n/2,left:t-d/2+i/2,behavior:"smooth"}),e.classList.add("highlight"),setTimeout(()=>{e.classList.remove("highlight")},2500)}else mostrarPopup("\uD83E\uDD14 Hmm...","N\xE3o conseguimos encontrar seu lote no mapa.",3e3)}window.findMyHouse=findMyHouse;async function limparVantagensAntigas(){try{const e=getSemanaAtual(),a=`semana_${e.numero}_${e.inicio.getFullYear()}`,o=getHoje(),t=getSemanaAtual(new Date(o.getTime()-604800000)),n=`semana_${t.numero}_${t.inicio.getFullYear()}`,i=collection(db,"vantagemSemanal"),r=await getDocs(i);if(r.empty)return void console.log("Nenhum documento de vantagem encontrado para limpar.");const d=writeBatch(db);let s=0;r.forEach(e=>{e.id!==a&&e.id!==n&&(console.log(`Marcando para apagar documento de vantagem antigo: ${e.id}`),d.delete(e.ref),s++)}),0<s?(await d.commit(),console.log(`‚úÖ Limpeza conclu√≠da: ${s} documento(s) de vantagem antigos foram removidos.`)):console.log("Nenhum documento de vantagem antigo para apagar nesta verifica\xE7\xE3o.")}catch(e){console.error("Erro ao limpar a cole\xE7\xE3o 'vantagemSemanal':",e)}}async function limparGerenciamentoSemanalAntigo(){console.log("\uD83E\uDDF9 Verificando registros de gerenciamento semanal antigos...");try{const e=new Date,a=getSemanaAtual(new Date(e.getTime()-86400000)),o=`semana_${a.numero}_${a.inicio.getFullYear()}`,t=collection(db,"gerenciamentoSemanal"),n=await getDocs(t);if(n.empty)return void console.log("Nenhum documento de gerenciamento semanal encontrado para limpar.");const i=writeBatch(db);let r=0;n.forEach(e=>{e.id!==o&&(console.log(`Marcando para apagar documento de gerenciamento antigo: ${e.id}`),i.delete(e.ref),r++)}),0<r?(await i.commit(),console.log(`‚úÖ Limpeza conclu√≠da: ${r} registro(s) de gerenciamento antigos foram removidos.`)):console.log("Nenhum registro de gerenciamento antigo para apagar nesta verifica\xE7\xE3o.")}catch(e){console.error("Erro ao limpar a cole\xE7\xE3o 'gerenciamentoSemanal':",e)}}async function limparPresencasAntigas(){try{const e=getSemanaAtual(),a=formatarDataISO(e.inicio),o=query(collection(dbEssencial,"presencas"),where("__name__","<",a)),t=await getDocs(o);if(t.empty)return void console.log("Nenhum documento de presen\xE7a antigo encontrado para limpar.");const n=writeBatch(db);let i=0;t.forEach(e=>{console.log(`Marcando para apagar documento de presen√ßa antigo: ${e.id}`),n.delete(e.ref),i++}),0<i&&(await n.commit(),console.log(`‚úÖ Limpeza conclu√≠da: ${i} registro(s) de presen√ßa antigos foram removidos.`))}catch(e){console.error("Erro ao limpar a cole\xE7\xE3o 'presencas':",e)}}async function carregarRankingImobiliario(){openModal("ranking-imobiliario-modal");const e=document.getElementById("ranking-mais-casas-lista"),a=document.getElementById("ranking-maior-valor-lista");e.innerHTML="<p>Calculando...</p>",a.innerHTML="<p>Calculando...</p>";try{const o=await getDocs(collection(db,"loja_casas")),t={};o.forEach(e=>{t[e.id]=e.data().preco||0});let n=[];if(todosMembros.forEach(e=>{const a=e.inventarioCasas||[];if(0<a.length){const o=a.length,i=a.reduce((e,a)=>e+(t[a]||0),0);n.push({nome:e.nome,quantidadeCasas:o,valorTotal:i})}}),0===n.length){return e.innerHTML="<p style=\"font-style: italic; text-align: center;\">Ningu\xE9m comprou uma casa ainda.</p>",void(a.innerHTML="<p style=\"font-style: italic; text-align: center;\">Ningu\xE9m comprou uma casa ainda.</p>")}const i=[...n].sort((e,a)=>a.quantidadeCasas-e.quantidadeCasas);e.innerHTML="",i.forEach((a,o)=>{const t=o+1;let n=`${t}¬∫`;1===t&&(n="\uD83E\uDD47"),2===t&&(n="\uD83E\uDD48"),3===t&&(n="\uD83E\uDD49");const i=document.createElement("div");i.className="ranking-imobiliario-item",i.innerHTML=`
        <span class="posicao">${n}</span>
        <span class="nome">${a.nome}</span>
        <span class="valor">üè† ${a.quantidadeCasas}</span>
      `,e.appendChild(i)});const r=[...n].sort((e,a)=>a.valorTotal-e.valorTotal);a.innerHTML="",r.forEach((e,o)=>{const t=o+1;let n=`${t}¬∫`;1===t&&(n="\uD83E\uDD47"),2===t&&(n="\uD83E\uDD48"),3===t&&(n="\uD83E\uDD49");const i=document.createElement("div");i.className="ranking-imobiliario-item",i.innerHTML=`
        <span class="posicao">${n}</span>
        <span class="nome">${e.nome}</span>
        <span class="valor">üí∞ ${e.valorTotal.toLocaleString("pt-BR")}</span>
      `,a.appendChild(i)})}catch(o){console.error("Erro ao carregar ranking imobili\xE1rio:",o),e.innerHTML="<p>Erro ao carregar.</p>",a.innerHTML="<p>Erro ao carregar.</p>"}}async function carregarConfiguracoesRecompensas(){try{const e=doc(db,"configuracoes","recompensas"),a=await getDoc(e);a.exists()?(recompensasConfig=a.data(),console.log("Configura\xE7\xF5es de recompensas carregadas:",recompensasConfig)):(console.warn("Documento de recompensas n\xE3o encontrado! Usando valores padr\xE3o."),recompensasConfig={focoDiario:100,postarMural:5,reagirConteudo:1,vitoriaJogoVantagem:50,top5Diario_1:25,top5Diario_2:20,top5Diario_3:15,top5Diario_4:10,top5Diario_5:5,top5Vantagem_1:50,top5Vantagem_2:40,top5Vantagem_3:30,top5Vantagem_4:20,top5Vantagem_5:10,vitoriaSemanal:500})}catch(e){console.error("Erro ao carregar configura\xE7\xF5es de recompensas:",e)}}function popularModalRecompensas(){for(const e in recompensasConfig){const a=document.getElementById(`reward-${e}`);a&&(a.textContent=recompensasConfig[e])}"lider"===userRole?document.querySelectorAll(".edit-reward-btn").forEach(e=>{e.classList.remove("hidden")}):document.querySelectorAll(".edit-reward-btn").forEach(e=>{e.classList.add("hidden")})}function handleRewardEditClick(e){if(e.target.classList.contains("edit-reward-btn")){const a=e.target.dataset.key;iniciarEdicaoRecompensa(a)}}function iniciarEdicaoRecompensa(e){const a=document.getElementById(`reward-${e}`);if(!a||a.isContentEditable)return;const o=a.textContent;a.contentEditable=!0,a.classList.add("editing"),a.focus(),document.execCommand("selectAll",!1,null);const t=async()=>{a.contentEditable=!1,a.classList.remove("editing"),a.removeEventListener("blur",t),a.removeEventListener("keydown",n);const i=a.textContent.trim(),r=parseInt(i,10);if(isNaN(r)||0>r)return mostrarPopup("\u274C Erro","Por favor, insira um n\xFAmero v\xE1lido.",3e3),void(a.textContent=o);if(r.toString()!==o)try{const a=doc(db,"configuracoes","recompensas");await updateDoc(a,{[e]:r}),recompensasConfig[e]=r,mostrarPopup("\u2705 Sucesso","Valor da recompensa atualizado!",3e3)}catch(e){console.error("Erro ao salvar recompensa:",e),mostrarPopup("\u274C Erro","Falha ao salvar. Tente novamente.",4e3),a.textContent=o}},n=n=>{"Enter"===n.key?(n.preventDefault(),t()):"Escape"===n.key&&(a.textContent=o,t())};a.addEventListener("blur",t),a.addEventListener("keydown",n)}async function atualizarPainelPessoal(){const e=document.getElementById("painel-pessoal-container"),a=document.getElementById("saudacao-pessoal"),o=document.getElementById("botao-painel-usuario"),t=document.getElementById("indicador-equipe-pessoal");if(!e||!currentUser)return;const n=todosMembros.find(e=>e.nome===currentUser),i=n?n.moedas||0:0,r=document.querySelector("#indicador-moedas-pessoal span");r&&(r.textContent=i.toLocaleString("pt-BR")),e.classList.remove("hidden");const d=document.getElementById("avatar-display-pessoal");if(d&&(d.innerHTML="",await renderizarAvatar(currentUser,d),d.onclick=()=>abrirEditorAvatar()),a.innerHTML=`Ol√°, <span id="nome-usuario-saudacao">${currentUser}</span>!`,o.classList.remove("hidden"),"lider"===userRole)t.textContent=`üëë Guardi√£o`,t.classList.remove("abelha","joaninha","vagalume","sem-equipe"),t.classList.add("lider-geral"),t.classList.remove("hidden");else if(userTeam){const e=userTeam.charAt(0).toUpperCase()+userTeam.slice(1);t.textContent=`Equipe ${e}`,t.classList.remove("abelha","joaninha","vagalume","sem-equipe","lider-geral"),t.classList.add(userTeam),t.classList.remove("hidden")}else t.textContent=`Membro sem equipe`,t.classList.remove("abelha","joaninha","vagalume","lider-geral"),t.classList.add("sem-equipe"),t.classList.remove("hidden");const s=document.getElementById("btn-abrir-painel-controle"),l=document.getElementById("btn-abrir-gerador-codigo");s&&("lider"===userRole||"lider-equipe"===userRole?s.classList.remove("hidden"):s.classList.add("hidden")),l&&("lider"===userRole?l.classList.remove("hidden"):l.classList.add("hidden"));const m=document.getElementById("btn-abrir-add-avatar-item");m&&("lider"===userRole?m.classList.remove("hidden"):m.classList.add("hidden"))}function abrirGeradorDeCodigos(){closeModal("user-panel-modal"),document.getElementById("code-coin-value").value="",document.getElementById("generated-code-result").classList.add("hidden"),openModal("code-generator-modal")}function gerarCodigoAleatorio(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";let a="";for(let o=0;6>o;o++)a+=e.charAt(Math.floor(Math.random()*e.length));return a}async function handleGenerateCode(){const e=document.getElementById("code-coin-value"),a=parseInt(e.value,10),o=document.getElementById("code-restrict-leaders-single").checked;if(isNaN(a)||0>=a)return void mostrarPopup("\u274C Erro","Por favor, insira um valor de moedas v\xE1lido e positivo.",4e3);const t=gerarCodigoAleatorio(),n=doc(db,"configuracoes","codigos");try{await setDoc(n,{[t]:{valor:a,liderPodeResgatar:!o}},{merge:!0}),document.getElementById("generated-code-display").textContent=t,document.getElementById("generated-code-result").classList.remove("hidden"),mostrarPopup("\u2705 Sucesso!",`C√≥digo "${t}" gerado com sucesso!`,3e3)}catch(e){console.error("Erro ao gerar c\xF3digo:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel salvar o novo c\xF3digo no banco de dados.",5e3)}}async function gerarImagemLogin(e,a,o="indefinido"){const t=document.createElement("div");t.className="login-card-image";const n=document.body.className;n.includes("tema-manha")?t.classList.add("login-card-manha"):n.includes("tema-tarde")?t.classList.add("login-card-tarde"):n.includes("tema-noite")?t.classList.add("login-card-noite"):t.classList.add("login-card-tarde");let i="Seja muito bem-vindo(a)!";"masculino"===o?i="Seja muito bem-vindo!":"feminino"===o&&(i="Seja muito bem-vinda!"),t.innerHTML=`
    <h3 class="login-card-titulo">√âpicos <span class="simbolo-destaque" lang="zh-CN">‰∫ó</span> üå±</h3>
    <p class="login-card-subtitulo">${i}</p>
    <div class="login-card-dados">
      <div>
        <strong>Usu√°rio:</strong>
        <span>${e}</span>
      </div>
      <div>
        <strong>Senha Provis√≥ria:</strong>
        <span>${a}</span>
      </div>
    </div>
    <p class="login-card-aviso">
      Anote seus dados. Voc√™ precisar√° criar uma senha definitiva no primeiro acesso.
    </p>
  `,document.body.appendChild(t),await html2canvas(t,{scale:2,useCORS:!0}).then(a=>{const o=a.toDataURL("image/png"),t=document.getElementById("generated-login-card-container"),n=document.getElementById("download-login-card-btn");t.innerHTML=`<img src="${o}" alt="Dados de Login">`,n.onclick=()=>{const a=document.createElement("a");a.download=`login-epicos-${e}.png`,a.href=o,a.click()}}),document.body.removeChild(t)}async function handleRedeemCode(){const e=document.getElementById("secret-code-input"),a=e.value.trim().toUpperCase();if(6!==a.length)return void mostrarPopup("\uD83E\uDD14 Aten\xE7\xE3o","O c\xF3digo precisa ter exatamente 6 caracteres.",3e3);const o=doc(db,"configuracoes","codigos");try{let t=0;await runTransaction(db,async e=>{const n=await e.get(o);if(!n.exists())throw"Nenhum c\xF3digo secreto foi gerado ainda.";const i=n.data(),r=i[a];if(!r)throw"C\xF3digo inv\xE1lido ou j\xE1 utilizado.";if(!1===r.liderPodeResgatar&&"lider-equipe"===userRole)throw"L\xEDderes de equipe n\xE3o podem resgatar este c\xF3digo.";t=r.valor;const d=r.loteId;if(d){const a=doc(db,"membros",currentUser),o=await e.get(a),t=o.data().lotesResgatados||[];if(t.includes(d))throw"Voc\xEA j\xE1 utilizou um dos c\xF3digos deste lote.";e.update(a,{lotesResgatados:arrayUnion(d)})}e.update(o,{[a]:deleteField()})});const n=doc(dbEssencial,"membros_essencial",currentUser);await updateDoc(n,{moedas:increment(t)});const i=todosMembros.findIndex(e=>e.nome===currentUser);-1!==i&&(todosMembros[i].moedas=(todosMembros[i].moedas||0)+t),atualizarPainelPessoal(),mostrarPopup("\uD83C\uDF89 Recompensa Resgatada!",`Voc√™ ganhou <strong>${t} üí∞ moedas</strong>!`,5e3),dispararConfete(),e.value=""}catch(e){console.error("Erro ao resgatar c\xF3digo:",e),mostrarPopup("\u274C Falha no Resgate",e.toString(),4e3)}}async function handleGenerateBatchCode(){const e=document.getElementById("batch-code-quantity"),a=document.getElementById("batch-code-value"),o=document.getElementById("generated-batch-result"),t=document.getElementById("batch-codes-result-display"),n=document.getElementById("code-restrict-leaders-batch").checked,r=parseInt(e.value,10),d=parseInt(a.value,10);if(isNaN(r)||0>=r||isNaN(d)||0>=d)return void mostrarPopup("\u274C Erro","Por favor, preencha a quantidade e o valor com n\xFAmeros v\xE1lidos.",4e3);const s=`lote-${Date.now()}`,l=doc(db,"configuracoes","codigos"),m=[],c=writeBatch(db);for(let e=0;e<r;e++){const e=gerarCodigoAleatorio();m.push(e);c.set(l,{[e]:{valor:d,loteId:s,liderPodeResgatar:!n}},{merge:!0})}try{await c.commit(),t.value=m.join("\n"),o.classList.remove("hidden"),mostrarPopup("\u2705 Sucesso!",`${r} c√≥digos foram gerados no lote!`,4e3)}catch(e){console.error("Erro ao gerar lote de c\xF3digos:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel salvar o lote de c\xF3digos.",5e3)}}async function exibirPopupResultadoCompeticao(){const e=getHoje();if(0!==e.getDay())return;if(!usuarioAceitaPopups())return;const a=getSemanaAtual(new Date(e.getTime()-86400000)),o=`semana_${a.numero}_${a.inicio.getFullYear()}`,t=doc(db,"resultadosCompeticao",o);try{const e=await getDoc(t);if(!e.exists())return void console.log("Documento de resultado da semana passada ainda n\xE3o foi gerado.");const a=e.data(),n=a.analiseOraculo,i=document.getElementById("resumo-competicao-ranking"),r=document.getElementById("resumo-membros-lista-container"),d={abelha:"\uD83D\uDC1D",joaninha:"\uD83D\uDC1E",vagalume:"\uD83D\uDCA1"},s=Object.entries(a.rankingEquipes).filter(([e])=>["abelha","joaninha","vagalume"].includes(e)).sort(([,e],[,a])=>e-a).map(([e,o])=>{const t=a.pontosEquipes[e]||0,n=(a.mediaEquipes?.[e]??0).toFixed(2),i=e.charAt(0).toUpperCase()+e.slice(1);let r="",s="";return 1===o?(r="gold",s="\uD83E\uDD47"):2===o?(r="silver",s="\uD83E\uDD48"):(r="bronze",s="\uD83E\uDD49"),`
                <div class="ranking-result-card ${r}">
                    <div class="rank-info-left">
                        <div class="rank-pos">${s}</div>
                        <div class="rank-team-name">
                            <span>${d[e]||""} ${i}</span>
                            <small>Total de Pontos: ${t}</small>
                        </div>
                    </div>
                    <div class="rank-stats-right">
                        <div>M√©dia Final</div>
                        <div class="rank-media-highlight">${n}</div>
                    </div>
                </div>`}).join("");i.innerHTML=`<div class="ranking-result-container">${s}</div>`;const l=Object.entries(a.rankingEquipes).filter(([e])=>["abelha","joaninha","vagalume"].includes(e)).sort(([,e],[,a])=>e-a).map(([e])=>e);let m="";l.forEach(e=>{const o=Object.values(a.detalhesMembros).filter(a=>a.equipe===e).sort((e,a)=>a.pontuacao.total-e.pontuacao.total);if(0<o.length){m+=`<div class="resumo-equipe-bloco">`,m+=`<div class="resumo-equipe-header ${e}">${e.charAt(0).toUpperCase()+e.slice(1)}</div>`,o.forEach(e=>{const a=0<e.pontuacao.vantagem,o=a?"Sim":"N\xE3o";let t="";e.deFerias&&("saude"===e.motivoAusencia?t="<span style=\"color: #e74c3c; font-style: italic; font-size: 0.9em; margin-left: 8px;\">\uD83D\uDE37 (Sa\xFAde)</span>":t="<span style=\"color: #3498db; font-style: italic; font-size: 0.9em; margin-left: 8px;\">\uD83C\uDF34 (F\xE9rias)</span>"),m+=`
                        <div class="resumo-membro-item">
                            <span class="resumo-membro-nome">${e.nome}${t}</span>
                            <span class="resumo-membro-pontos">(Foco: ${e.pontuacao.foco} | B√¥nus: ${o})</span>
                            <span class="resumo-membro-total">${e.pontuacao.total} pts</span>
                        </div>
                    `});const t=a.adicoesPoderes?.[e];t&&Array.isArray(t)&&t.forEach(e=>{m+=`
                            <div class="resumo-membro-item resumo-ajuste-item positivo">
                                <span class="resumo-membro-nome">üíñ ${e.nomePoder} (usado pela equipe ${e.por})</span>
                                <span class="resumo-membro-total">+${e.valor} pts</span>
                            </div>
                        `});const n=a.deducoesPoderes?.[e];n&&Array.isArray(n)&&n.forEach(e=>{m+=`
                            <div class="resumo-membro-item resumo-ajuste-item negativo">
                                <span class="resumo-membro-nome">üíÄ ${e.nomePoder} (usado pela equipe ${e.por})</span>
                                <span class="resumo-membro-total">${e.valor} pts</span>
                            </div>
                        `});const i=a.historicoCompletoPoderes||{},r=[];Object.entries(i).forEach(([a,o])=>{o.forEach(o=>{const t=a.charAt(0).toUpperCase()+a.slice(1),n=o.alvo?"vagalume"===o.alvo?"Vaga-lume":o.alvo.charAt(0).toUpperCase()+o.alvo.slice(1):"";return o.alvo===e&&"bloqueado"===o.status?void r.push({texto:`üõ°Ô∏è BLOQUEADO: ${o.nomePoder} da Equipe ${t} falhou!`,tipo:"defesa"}):a===e&&"bloqueado"===o.status?void r.push({texto:`‚ùå FALHOU: A ${o.nomePoder} contra a Equipe ${n} foi bloqueada.`,tipo:"falha"}):void(("elixir_vida"===o.poderId||"maldicao_pilantragem"===o.poderId)&&"bloqueado"!==o.status||(o.alvo===e?r.push({texto:`Equipe ${t} acertou ${o.nomePoder}!`,tipo:"ataque"}):!o.alvo&&a===e&&r.push({texto:`Usou ${o.nomePoder}`,tipo:"defesa"})))})}),0<r.length&&r.forEach(e=>{let a="";"ataque"===e.tipo?a="background-color: rgba(231, 76, 60, 0.1); border-left: 3px solid #e74c3c;":"defesa"===e.tipo?a="background-color: rgba(46, 204, 113, 0.15); border-left: 3px solid #2ecc71;":"falha"===e.tipo&&(a="background-color: rgba(149, 165, 166, 0.15); border-left: 3px solid #95a5a6; color: #7f8c8d; font-style: italic;"),m+=`
                            <div class="resumo-membro-item resumo-ajuste-item estrategico" style="${a}">
                                <span class="resumo-membro-nome">${e.texto}</span>
                                <span class="resumo-membro-total" style="font-size: 0.9em; opacity: 0.8;">Estrat√©gia</span>
                            </div>
                        `});const d=a.ajustesManuais?.[e];if(d&&0!==d){const e=0<d?"positivo":"negativo",a=0<d?"Adi\xE7\xE3o de pontos pelo l\xEDder":"Remo\xE7\xE3o de pontos pelo l\xEDder";m+=`
                        <div class="resumo-membro-item resumo-ajuste-item ${e}">
                            <span class="resumo-membro-nome">${a}</span>
                            <span class="resumo-membro-total">${0<d?"+":""}${d} pts</span>
                        </div>
                    `}m+=`</div>`}}),r.innerHTML=m;const c=`competicao_resultado_${o}`,u=todosMembros.find(e=>e.nome===currentUser);if(u&&u.bloqueiosPopups&&u.bloqueiosPopups[c])return void console.log("Popup Competi\xE7\xE3o bloqueado pelo usu\xE1rio.");const p=document.getElementById("btn-dont-show-competicao");p&&(p.onclick=async()=>{if(closeModal("resumo-competicao-modal"),currentUser){const e=doc(db,"membros",currentUser);try{await updateDoc(e,{[`bloqueiosPopups.${c}`]:!0}),u&&(!u.bloqueiosPopups&&(u.bloqueiosPopups={}),u.bloqueiosPopups[c]=!0,localStorage.setItem("epicos_cache_membros",JSON.stringify(todosMembros)))}catch(e){console.error(e)}}n&&mostrarPopupAnaliseOraculo(n)}),openModal("resumo-competicao-modal");const g=document.getElementById("resumo-competicao-close-btn");g&&(g.onclick=()=>{closeModal("resumo-competicao-modal"),mostrarPopupAnaliseOraculo(n)})}catch(e){console.error("Erro ao exibir popup de resultado da competi\xE7\xE3o:",e)}}async function atualizarReacaoOtimista(e,a,o){if(!currentUser)return;const t=document.querySelector(`${e} [data-id="${a}"]`);if(!t)return;let n=t.querySelector(".reacoes-display-container, .feed-card-reacoes");if(!n){const e=t.querySelector(".feed-card-reacoes");if(e)n=e;else{const e=document.createElement("div");e.className="reacoes-display-container",t.querySelector(".mensagem-info").insertAdjacentElement("beforebegin",e),n=e}}const i=n.querySelector(".reacao-display.reacted"),r=n.querySelector(`.reacao-display[data-emoji="${o}"]`);if(i&&i!==r){i.classList.remove("reacted");const e=i.querySelector(".contador-display");let a=parseInt(e.textContent,10)-1;0>=a?i.remove():e.textContent=a}if(!r){const t=document.createElement("div");t.className="reacao-display reacted",t.dataset.emoji=o,t.innerHTML=`${o} <span class="contador-display">1</span>`,t.onclick="#feed-semanal-cards"===e?t=>toggleReacaoFeed(t,a,o):()=>window.abrirModalReagentes(a,o),n.appendChild(t)}else if(r.classList.contains("reacted")){r.classList.remove("reacted");const e=r.querySelector(".contador-display");let a=parseInt(e.textContent,10)-1;0>=a?r.remove():e.textContent=a}else{r.classList.add("reacted");const e=r.querySelector(".contador-display");e.textContent=parseInt(e.textContent,10)+1}const d=!!n.querySelector(".reacao-display.reacted");!!!i&&d&&mostrarPopupMoedas(recompensasConfig.reagirConteudo||1)}async function verificarELimparNaSegunda(){const e=getHoje();if(1!==e.getDay())return;const a=getSemanaAtual(),o=`semana_${a.numero}_${a.inicio.getFullYear()}`,t=doc(db,"appState","statusLimpeza");try{const e=await getDoc(t),a=e.exists()?e.data().ultimaLimpezaRealizada:null;if(a===o)return void console.log("Limpeza de segunda-feira j\xE1 realizada para esta semana (verificado no Firestore).");console.log("Primeira vez na segunda-feira para o grupo. Executando limpeza semanal centralizada..."),await setGlobalLock(!0,"\uD83E\uDDF9 Limpeza Semanal: Preparando o grupo para a nova semana...");try{await Promise.all([limparFeedSemanal(),limparTodosOsComentariosDoMural(),limparTodoOMural(),limparPresencasAntigas(),limparVantagensAntigas(),limparResultadosCompeticaoAntigos(),limparResultadosDesenhoAntigos(),limparNotificacoesAntigas(),limparPopupStateAntigo(),limparStatusPoderesAntigos(),limparHistoricoNotificacoesOraculo(),limparHistoricoPoderesAntigos(),limparPixTransacoesAntigas(),limparEnviosDiariosAntigos(),limparGerenciamentoSemanalAntigo(),limparHistoricoTopicosOraculo(),limparApostasLoteriaAntigas(),limparMensagensDiariasAntigas(),limparPalavrasSemanaAntigas(),limparRecompensasLideresAntigas()]),await setDoc(t,{ultimaLimpezaRealizada:o}),mostrarPopup("\u2728 Nova Semana!","O mural e o resumo da semana foram reiniciados.",5e3),console.log("Limpeza semanal conclu\xEDda e registrada no Firestore para todo o grupo.")}catch(e){console.error("Erro durante a limpeza centralizada de segunda-feira:",e),mostrarPopup("\u274C Erro","Ocorreu uma falha ao reiniciar o mural e o feed.",4e3)}finally{await setGlobalLock(!1)}}catch(e){console.error("Erro geral ao verificar status de limpeza:",e)}}async function limparResultadosCompeticaoAntigos(){try{const e=getHoje(),a=getSemanaAtual(new Date(e.getTime()-86400000)),o=`semana_${a.numero}_${a.inicio.getFullYear()}`,t=collection(db,"resultadosCompeticao"),n=await getDocs(t);if(n.empty)return void console.log("Nenhum documento de resultado de competi\xE7\xE3o encontrado para limpar.");const i=writeBatch(db);let r=0;n.forEach(e=>{e.id!==o&&(console.log(`Marcando para apagar documento de resultado antigo: ${e.id}`),i.delete(e.ref),r++)}),0<r?(await i.commit(),console.log(`‚úÖ Limpeza conclu√≠da: ${r} resultado(s) de competi√ß√£o antigos foram removidos.`)):console.log("Nenhum resultado de competi\xE7\xE3o antigo para apagar nesta verifica\xE7\xE3o.")}catch(e){console.error("Erro ao limpar a cole\xE7\xE3o 'resultadosCompeticao':",e)}}window.forcarRegeracaoQuiz=async function(){if(confirm("Tem certeza que deseja apagar e recriar o Quiz da Vantagem desta semana?"))try{const e=getSemanaAtual(),a=`semana_${e.numero}_${e.inicio.getFullYear()}`,o=doc(db,"vantagemSemanal",a);await updateDoc(o,{quizDaSemana:deleteField()}),mostrarPopup("\u2705 Sucesso","Quiz antigo apagado. Recarregando para gerar um novo...",4e3),setTimeout(async()=>{await loadAdvantageState(),mostrarPopup("\uD83C\uDFB2 Novo Quiz","Um novo quiz foi gerado com sucesso!",3e3)},1500)}catch(e){console.error("Erro ao for\xE7ar recria\xE7\xE3o do quiz:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel apagar o quiz antigo. Tente manualmente.",5e3)}};async function carregarOrdemJogos(){try{const e=doc(db,"configuracoes","ordemJogosVantagem"),a=await getDoc(e);a.exists()&&a.data().ordem?(ordemJogosConfigurada=a.data().ordem,console.log("Ordem de jogos personalizada carregada:",ordemJogosConfigurada)):(console.log("Nenhuma ordem de jogos personalizada encontrada. Usando ordem padr\xE3o."),ordemJogosConfigurada=[])}catch(e){console.error("Erro ao carregar ordem dos jogos:",e),ordemJogosConfigurada=[]}}async function salvarNovaOrdemJogos(){const e=document.getElementById("game-order-list"),a=Array.from(e.children).map(e=>e.dataset.gameName);if(0===a.length)return void mostrarPopup("\u274C Erro","A lista de jogos est\xE1 vazia.",4e3);const o=getSemanaAtual().numero;try{const e=doc(db,"configuracoes","ordemJogosVantagem");await setDoc(e,{ordem:a,semanaDeInicio:o}),ordemJogosConfigurada=a,mostrarPopup("\u2705 Sucesso!","A nova ordem dos jogos foi salva.",3e3),popularPainelOrdemJogos()}catch(e){console.error("Erro ao salvar nova ordem de jogos:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel salvar a nova ordem.",4e3)}}function popularPainelOrdemJogos(){function a(e,a){const o=[...e.querySelectorAll(".game-order-item:not(.dragging)")];return o.reduce((e,o)=>{const t=o.getBoundingClientRect(),n=a-t.top-t.height/2;return 0>n&&n>e.offset?{offset:n,element:o}:e},{offset:Number.NEGATIVE_INFINITY}).element}const o=document.getElementById("game-order-list");if(!o)return;o.innerHTML="";const t=0<ordemJogosConfigurada.length?ordemJogosConfigurada:todosOsJogos.map(e=>e.nome);t.forEach((e,a)=>{const t=document.createElement("li");t.className="game-order-item",t.draggable=!0,t.dataset.gameName=e;let n="";0===a?n="<span class=\"week-indicator\">Esta Semana</span>":1==a&&(n="<span class=\"week-indicator\">Pr\xF3xima</span>"),t.innerHTML=`
      <span class="drag-handle">‚ò∞</span>
      <span class="game-name">${e}</span>
      ${n}
    `,o.appendChild(t)});const n=o.querySelectorAll(".game-order-item");let i=null;n.forEach(e=>{e.addEventListener("dragstart",()=>{i=e,setTimeout(()=>e.classList.add("dragging"),0)}),e.addEventListener("dragend",()=>{setTimeout(()=>{i.classList.remove("dragging"),i=null},0)}),e.addEventListener("dragover",t=>{t.preventDefault();const e=a(o,t.clientY);null==e?o.appendChild(i):o.insertBefore(i,e)})})}let membroIdParaSalvarAniversario=null,novaDataAniversario=null;async function abrirModalListaAniversarios(){const e=document.getElementById("lista-completa-aniversarios-container");e.innerHTML="<div class=\"ociosos-placeholder\">Carregando lista de membros...</div>",openModal("lista-aniversarios-modal");try{e.innerHTML="";const a=todosMembros.map(e=>({id:e.nome,...e}));a.sort((e,a)=>e.id.localeCompare(a.id)),a.forEach(a=>{const o=a,t=document.createElement("div");t.className="aniversario-item";const n=currentUser===a.id&&!o.aniversarioDefinido;t.innerHTML=`
        <span class="aniversario-nome-membro">${a.id}</span>
        <div class="aniversario-data-container">
          <span id="data-aniversario-${a.id}" class="aniversario-data-membro">
            ${o.aniversario||"N\xE3o definido"}
          </span>
          <button class="edit-aniversario-btn ${n?"":"hidden"}" 
                  onclick="editarAniversario(event, '${a.id}')" 
                  title="Definir seu anivers√°rio (s√≥ pode ser feito uma vez!)">
            ‚úèÔ∏è
          </button>
        </div>
      `,e.appendChild(t)})}catch(a){console.error("Erro ao carregar lista de anivers\xE1rios:",a),e.innerHTML="<div class=\"ociosos-placeholder\">Falha ao carregar a lista.</div>"}}window.editarAniversario=function(e,a){e.stopPropagation();const o=document.getElementById(`data-aniversario-${a}`);if(!o||o.isContentEditable)return;const t=o.textContent.trim();o.textContent="",o.contentEditable=!0,o.classList.add("editing"),o.setAttribute("placeholder","DD/MM"),o.focus();const n=()=>{handleSalvarAniversario(a,o,t)},i=a=>{"Enter"===a.key?(a.preventDefault(),o.blur()):"Escape"===a.key&&(o.textContent=t,o.contentEditable=!1,o.classList.remove("editing"),o.removeAttribute("placeholder"),o.removeEventListener("blur",n),o.removeEventListener("keydown",i))};o.addEventListener("blur",n),o.addEventListener("keydown",i)};function handleSalvarAniversario(e,a,o){a.contentEditable=!1,a.classList.remove("editing"),a.removeAttribute("placeholder");const t=a.textContent.trim();if(""===t||t===o)return void(a.textContent=o);if(!/^([0-2][0-9]|(3)[0-1])(\/)(((0)[0-9])|((1)[0-2]))$/.test(t))return mostrarPopup("\u274C Formato Inv\xE1lido","Use o formato DD/MM (ex: 25/12).",4e3),void(a.textContent=o);membroIdParaSalvarAniversario=e,novaDataAniversario=t;const n=document.getElementById("confirm-aniversario-texto");n.innerHTML=`Voc√™ est√° prestes a definir seu anivers√°rio como <strong>${t}</strong>.
                                <br><br>
                                Lembre-se: <strong>esta altera√ß√£o s√≥ pode ser feita uma √∫nica vez!</strong> Tem certeza que a data est√° correta?`;const i=document.getElementById("confirm-aniversario-btn");i.onclick=executarSalvarAniversario,openModal("confirm-aniversario-modal")}async function executarSalvarAniversario(){if(!membroIdParaSalvarAniversario||!novaDataAniversario)return;const e=membroIdParaSalvarAniversario,a=novaDataAniversario,o=doc(db,"membros",e);membroIdParaSalvarAniversario=null,novaDataAniversario=null,closeModal("confirm-aniversario-modal"),mostrarPopup("\u2705 Sucesso!","Sua data de anivers\xE1rio foi salva!",4e3);const t=document.getElementById(`data-aniversario-${e}`),n=document.querySelector(`.edit-aniversario-btn[onclick*="'${e}'"]`);t&&(t.textContent=a),n&&n.classList.add("hidden");try{await updateDoc(o,{aniversario:a,aniversarioDefinido:!0}),await carregarAniversariantes(),console.log(`Anivers√°rio de ${e} salvo com sucesso no banco de dados.`)}catch(e){console.error("Erro ao salvar anivers\xE1rio em segundo plano:",e),mostrarPopup("\u274C Falha na Sincroniza\xE7\xE3o","Sua altera\xE7\xE3o n\xE3o foi salva. Por favor, recarregue e tente novamente.",5e3),t&&(t.textContent="N\xE3o definido"),n&&n.classList.remove("hidden")}}async function marcarPresencaAniversario(e){if(!e||!e.nome)return;const a=e.nome,o=e.equipe,t=getHojeISO(),n=0===getHoje().getDay();try{const e=doc(dbEssencial,"membros_essencial",a),i=doc(dbEssencial,"presencas",t),r=doc(dbEssencial,"semanas","pontosSemanais"),d=doc(db,"appState","dailyTasks"),s=await getDoc(i),l=s.exists()&&s.data()[a];let m=streaksCache[a]||0;if(!l){console.log(`Marcando presen√ßa, streak e moedas de anivers√°rio para ${a}.`);const t=recompensasConfig.focoDiario||100,{streakDepoisDaTransacao:d}=await runTransaction(dbEssencial,async d=>{const l=await d.get(e),m=l.exists()?l.data():{streak:0,moedas:0},c=m.streak||0,u=c+1;return s.exists()?d.update(i,{[a]:new Date}):d.set(i,{[a]:new Date},{merge:!0}),d.set(e,{streak:u,moedas:increment(t),equipe:o},{merge:!0}),!n&&o&&d.update(r,{[o]:increment(1)}),{streakDepoisDaTransacao:u}});m=d,streaksCache[a]=m,o&&!n&&pontosSemanais[o]++,a===currentUser&&mostrarPopupMoedas(t)}else console.log(`Presen√ßa de ${a} j√° havia sido marcada (pela folga ou manualmente).`);const c=`${a}_${t}`,u=await getDoc(d),p=u.exists()?u.data().aniversariosFeedPostados||[]:[];if(!p.includes(c)){console.log(`Postando feed de anivers√°rio para ${a}.`);await adicionarEventoAoFeed("geral",`üéÇ Feliz Anivers√°rio, ${a}!`,`Hoje o foco de <strong>${a}</strong> foi marcado como um presente especial! Desejamos um dia incr√≠vel e muitas felicidades. Parab√©ns!`,{nomeMembro:a}),await setDoc(d,{aniversariosFeedPostados:arrayUnion(c)},{merge:!0});const e=m-1,o=Object.keys(medalhas).map(Number).sort((e,a)=>e-a);for(const t of o)if(m>=t&&e<t){const e=medalhas[t];await adicionarEventoAoFeed("medalha","\uD83C\uDFC5 Nova Conquista!",`<strong>${a}</strong> alcan√ßou <strong>${m} dias</strong> de foco e ganhou a medalha ${e.emoji} <strong>${e.nome}</strong>!`,{nomeMembro:a,medalha:e.nome});break}}else console.log(`Feed de anivers√°rio para ${a} j√° foi postado hoje. Ignorando.`);const g=document.getElementById(a);g&&!g.checked&&(g.checked=!0),await atualizarResumo(),atualizarMedalhas(),console.log(`Presen√ßa de anivers√°rio de ${a} processada com sucesso.`)}catch(e){console.error(`Erro ao marcar presen√ßa de anivers√°rio para ${a}:`,e)}}async function handleAjusteManualPontos(e){const a=document.getElementById("select-equipe-ajuste").value,o=document.getElementById("input-pontos-ajuste"),t=parseInt(o.value,10);if(!a)return void mostrarPopup("\u26A0\uFE0F Aten\xE7\xE3o","Por favor, selecione uma equipe.",4e3);if(isNaN(t)||0>=t)return void mostrarPopup("\u26A0\uFE0F Aten\xE7\xE3o","Por favor, insira um n\xFAmero de pontos v\xE1lido e positivo.",4e3);const n="adicionar"===e?t:-t,i="adicionar"===e?"adicionados":"removidos",r="adicionar"===e?"para a":"da",d="adicionar"===e?"\uD83D\uDCC8":"\uD83D\uDCC9",s=a.charAt(0).toUpperCase()+a.slice(1);if(confirm(`Tem certeza que deseja ${e} ${t} pontos ${r} equipe ${s}?`))try{const d=`semana_${semana.numero}_${semana.inicio.getFullYear()}`,l=doc(dbEssencial,"semanas","pontosSemanais");await updateDoc(l,{[a]:increment(n)});const m=doc(db,"vantagemSemanal",d);await setDoc(m,{ajustesManuais:{[a]:increment(n)}},{merge:!0}),pontosSemanais[a]+=n,atualizarPlacarSemanal(),o.value="";const c="adicionar"===e?"\uD83D\uDCC8":"\uD83D\uDCC9";await adicionarEventoAoFeed("geral",`${c} Ajuste de Pontos!`,`O L√≠der Geral ajustou a pontua√ß√£o: <strong>${t}</strong> pontos foram <strong>${i}</strong> ${r} equipe <strong>${s}</strong>.`,{equipe:a,ajuste:n}),mostrarPopup("\u2705 Sucesso!",`Pontos ${i} ${r} equipe ${s}.`,4e3)}catch(e){console.error("Erro ao ajustar pontos manualmente:",e),mostrarPopup("\u274C Erro","Ocorreu uma falha ao tentar ajustar os pontos.",5e3)}}async function criarNotificacao(e,a,o,t,n){try{const i=collection(db,"notificacoes");await addDoc(i,{destinatarioId:e,remetenteNome:a,tipo:o,conteudo:t,acao:n,lida:!1,timestamp:new Date})}catch(e){console.error("Erro ao criar notifica\xE7\xE3o:",e)}}function configurarNotificacoesTempoReal(){if(currentUser){unsubscribeNotificacoes&&(unsubscribeNotificacoes(),console.log("Ouvinte de notifica\xE7\xF5es anterior desligado."));const e=query(collection(db,"notificacoes"),where("destinatarioId","==",currentUser),orderBy("timestamp","desc"));unsubscribeNotificacoes=onSnapshot(e,async e=>{const a=document.getElementById("notificacoes-lista"),o=document.getElementById("notificacoes-contador");if(!a||!o)return void console.error("Elementos da interface de notifica\xE7\xE3o n\xE3o foram encontrados. A atualiza\xE7\xE3o da UI ser\xE1 ignorada.");for(const a of e.docChanges())if("added"===a.type){if(!usuarioAceitaPopups())continue;const e=a.doc.data(),o=a.doc.id;if("moedas"===e.tipo&&!1===e.popupVisto){const a=e.remetenteNome,t=e.transacaoId,n=e.agradecimentoEnviado||!1,i=e.acao||"",r=i.match(/<strong>(.*?)\s*üí∞ moedas<\/strong>/),d=r?r[1]:"um valor",s=i.match(/Coment√°rio: "(.*?)"/),l=s?s[1]:"";mostrarPopupPixRecebido(a,d,l,o,t,n);try{await updateDoc(doc(db,"notificacoes",o),{popupVisto:!0})}catch(a){console.error("Erro ao marcar popup de Pix como visto:",a)}}else if(("recompensa_lider"===e.tipo||"recompensa_membro"===e.tipo)&&!1===e.popupVisto){const a=e.remetenteNome,t=e.valor||0,n=e.agradecimentoEnviado||!1;mostrarPopupRecompensaRecebida(a,t,o,n);try{await updateDoc(doc(db,"notificacoes",o),{popupVisto:!0})}catch(a){console.error("Erro ao marcar popup de Recompensa como visto:",a)}}}let t=0;a.innerHTML="",e.empty?(a.innerHTML="<div class=\"ociosos-placeholder\">Nenhuma notifica\xE7\xE3o por aqui.</div>",o.classList.add("hidden")):e.forEach(e=>{const o=e.data();o.lida||t++;const n=criarElementoNotificacao(o);a.appendChild(n)});const n=document.getElementById("painel-pessoal-container");0<t?(o.textContent=`${t}`,o.classList.remove("hidden"),n&&n.classList.add("notificacao-neon-border")):(o.classList.add("hidden"),n&&n.classList.remove("notificacao-neon-border"))}),console.log(`Ouvinte de notifica√ß√µes ativado para: ${currentUser}`)}}function configurarOuvinteDadosPessoais(){if(currentUser){unsubscribeDadosPessoais&&unsubscribeDadosPessoais();const e=doc(dbEssencial,"membros_essencial",currentUser);unsubscribeDadosPessoais=onSnapshot(e,e=>{if(e.exists()){const a=e.data(),o=todosMembros.findIndex(e=>e.nome===currentUser);if(-1!==o&&(todosMembros[o]={...todosMembros[o],...a}),a.lastDailyRewardClaim){const e=a.lastDailyRewardClaim.toDate?a.lastDailyRewardClaim.toDate():new Date(a.lastDailyRewardClaim),o=getHoje();o.setHours(0,0,0,0),e.setHours(0,0,0,0),o.getTime()===e.getTime()&&(dailyClaimedToday=!0)}void 0!==a.dailyRewardStreak&&(dailyStreakGlobal=a.dailyRewardStreak),console.log("\uD83D\uDD04 Dados pessoais sincronizados em tempo real (Moedas/Recompensa)."),atualizarPainelPessoal(),atualizarInterfaceRecompensa(),popularTabelaNiveis(),"function"==typeof verificarNudgesDiarios&&verificarNudgesDiarios(!1)}})}}function criarElementoNotificacao(e){const a=document.createElement("div");a.className="notificacao-item",e.lida||a.classList.add("nao-lida");const o=e.timestamp.toDate(),t=o.toLocaleDateString("pt-BR"),n=o.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});return a.innerHTML=`
        <div class="notificacao-conteudo">
            <strong>${e.remetenteNome}</strong> ${e.acao} 
            <span style="font-size: 1.2rem;">${e.conteudo}</span>
        </div>
        <div class="notificacao-horario">
            ${t}<br>${n}
        </div>
    `,a}async function marcarNotificacoesComoLidas(){const e=query(collection(db,"notificacoes"),where("destinatarioId","==",currentUser),where("lida","==",!1));try{const a=await getDocs(e);if(a.empty)return;const o=writeBatch(db);a.forEach(e=>{o.update(e.ref,{lida:!0})}),await o.commit(),console.log("Notifica\xE7\xF5es marcadas como lidas.")}catch(e){console.error("Erro ao marcar notifica\xE7\xF5es como lidas:",e)}}async function apagarTodasAsNotificacoes(){if(currentUser){console.log(`Iniciando exclus√£o for√ßada de notifica√ß√µes para ${currentUser}...`);try{const e=query(collection(db,"notificacoes"),where("destinatarioId","==",currentUser)),a=await getDocs(e);if(a.empty)return void console.log("Nenhuma notifica\xE7\xE3o encontrada no banco para apagar.");const o=writeBatch(db);a.forEach(e=>{o.delete(e.ref)}),await o.commit(),console.log(`SUCESSO: ${a.size} notifica√ß√µes apagadas permanentemente.`);const t=document.getElementById("notificacoes-lista");t&&(t.innerHTML="<div class=\"ociosos-placeholder\">Todas as notifica\xE7\xF5es foram limpas.</div>")}catch(e){throw console.error("Erro ao apagar notifica\xE7\xF5es:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel limpar suas notifica\xE7\xF5es. Tente novamente.",4e3),e}}}window.fecharEApagarNotificacoes=async function(){await apagarTodasAsNotificacoes(),closeModal("notificacoes-modal")};async function gerarNovoTemaDesenho(){console.log("\uD83C\uDFA8 Or\xE1culo: Iniciando escolha do novo tema...");let e="",a="IA";try{const o=doc(dbDesenho,"configuracoes","temasManuaisDesenho"),t=await getDoc(o);if(t.exists()){const n=t.data().temas||[];if(0<n.length){console.log("\uD83C\uDFA8 Tema Manual encontrado! Usando prioridade."),e=n[0],a="Manual";const t=n.slice(1);await updateDoc(o,{temas:t}),temasManuaisCache=t}}}catch(a){console.error("Erro ao verificar temas manuais:",a)}if(!e){if(!genAI)return;console.log("\uD83C\uDFA8 Sem temas manuais. Consultando a IA...");let a=[];try{const e=doc(db,"configuracoes","historicoTemas"),o=await getDoc(e);o.exists()&&(a=o.data().ultimosTemas||[])}catch(a){console.warn("N\xE3o foi poss\xEDvel ler hist\xF3rico de temas.")}const o=["objetos do cotidiano","comida e bebida","animais","natureza","profiss\xF5es","lugares","fantasia medieval"],t=o[Math.floor(Math.random()*o.length)],n=a.slice(-15).join(", ");try{const a=await callGenerativeAIWithRetry(`
        Voc√™ √© o organizador de uma competi√ß√£o de desenho.
        Sua tarefa √© escolher um tema NOVO, EXTREMAMENTE SIMPLES e f√°cil de desenhar.
        A categoria sorteada foi: "${t}".
        ‚ö†Ô∏è REGRA DE OURO (N√ÉO REPITA): Voc√™ N√ÉO pode escolher nenhum destes temas recentes: [${n}].
        O tema deve ser UMA √öNICA PALAVRA ou um objeto concreto.
        Sua resposta DEVE ser um JSON v√°lido no formato: {"tema": "SEU_TEMA_AQUI"}.
        Apenas o JSON.
      `),o=a.match(/{[\s\S]*}/);if(!o)throw new Error("JSON inv\xE1lido do Or\xE1culo.");const i=JSON.parse(o[0]);e=i.tema}catch(a){console.error("Erro na IA:",a),e="Livre"}}try{const o=getHojeISO();await setDoc(doc(dbDesenho,"configuracoes","temaDesenho"),{tema:e,dataGeracao:new Date,ativo:!0,origem:a}),await setDoc(doc(db,"appState","status"),{avisoNovoTema:{tema:e,data:o}},{merge:!0});try{const a=doc(dbDesenho,"configuracoes","historicoTemas");await setDoc(a,{ultimosTemas:arrayUnion(e)},{merge:!0})}catch(a){console.error("Erro ao salvar hist\xF3rico de temas:",a)}return await adicionarEventoAoFeed("geral","\uD83C\uDFA8 Novo Tema de Desenho!",`O Or√°culo decretou! O tema da Batalha de Desenhos desta semana √©: <strong>${e}</strong>. Equipes, preparem seus pinc√©is! O prazo acaba segunda-feira.`),document.querySelectorAll(".avaliacao-oraculo-box").forEach(e=>e.classList.add("hidden")),e}catch(e){return console.error("Erro ao salvar o novo tema:",e),null}}async function carregarEPopularTemasManuais(){const a=document.getElementById("lista-temas-manuais");if(a){a.innerHTML="<li style=\"padding:10px; text-align:center;\">Carregando...</li>";try{const e=doc(dbDesenho,"configuracoes","temasManuaisDesenho"),a=await getDoc(e);temasManuaisCache=a.exists()?a.data().temas||[]:[],renderizarListaTemasManuais()}catch(o){console.error("Erro ao carregar temas manuais:",o),a.innerHTML="<li style=\"color:red;\">Erro ao carregar.</li>"}}}function renderizarListaTemasManuais(){const a=document.getElementById("lista-temas-manuais");if(a)return a.innerHTML="",0===temasManuaisCache.length?void(a.innerHTML="<li style=\"padding:10px; text-align:center; color:#999; font-style:italic;\">Nenhum tema na fila. O Or\xE1culo usar\xE1 a IA.</li>"):void(temasManuaisCache.forEach((e,o)=>{const t=document.createElement("li");t.className="game-order-item",t.draggable=!0,t.dataset.index=o,t.innerHTML=`
            <span class="drag-handle" style="cursor:grab;">‚ò∞</span>
            <span class="game-name" style="flex-grow:1; text-align:left; padding-left:10px;">${e}</span>
            <button class="painel-btn btn-remover" style="padding: 2px 8px; font-size:0.8rem;" onclick="removerTemaManual(${o})">X</button>
        `,t.addEventListener("dragstart",()=>{t.classList.add("dragging")}),t.addEventListener("dragend",()=>{t.classList.remove("dragging"),atualizarCachePelaDOM()}),a.appendChild(t)}),a.addEventListener("dragover",o=>{o.preventDefault();const e=document.querySelector(".dragging"),t="function"==typeof getDragAfterElementOrdenacao?getDragAfterElementOrdenacao(a,o.clientY):null;null==t?a.appendChild(e):a.insertBefore(e,t)}))}function atualizarCachePelaDOM(){const e=document.getElementById("lista-temas-manuais"),a=[];e.querySelectorAll(".game-name").forEach(e=>{a.push(e.textContent)}),temasManuaisCache=a}window.adicionarTemaManualUI=function(){const e=document.getElementById("input-novo-tema-manual"),a=e.value.trim();a&&(temasManuaisCache.push(a),e.value="",renderizarListaTemasManuais())},window.removerTemaManual=function(e){temasManuaisCache.splice(e,1),renderizarListaTemasManuais()},window.salvarTemasManuais=async function(){const e=event.target,a=e.textContent;e.textContent="Salvando...",e.disabled=!0;try{const e=doc(dbDesenho,"configuracoes","temasManuaisDesenho");atualizarCachePelaDOM(),await setDoc(e,{temas:temasManuaisCache}),"function"==typeof mostrarPopup?mostrarPopup("\u2705 Sucesso","Fila de temas manuais atualizada!",3e3):alert("\u2705 Fila de temas manuais atualizada!")}catch(a){console.error("Erro ao salvar temas:",a),alert("\u274C Erro ao salvar.")}finally{e.textContent=a,e.disabled=!1}};async function carregarTemaDesenho(){try{const e=await getDoc(doc(dbDesenho,"configuracoes","temaDesenho")),a=document.getElementById("tema-desenho-container"),o=document.getElementById("tema-atual-texto");e.exists()&&e.data().ativo?(o.textContent=e.data().tema,a.classList.remove("hidden")):a.classList.add("hidden")}catch(a){console.error("Erro ao carregar tema:",a)}}async function capturarDesenhosParaJulgamento(){const e=["abelha","joaninha","vagalume"],a={};for(const o of e){const e=document.createElement("canvas");e.width=800,e.height=600;const t=e.getContext("2d");t.fillStyle="#ffffff",t.fillRect(0,0,800,600);const n=query(collection(dbDesenho,`desenhos_${o}`),orderBy("timestamp")),i=await getDocs(n);if(i.empty){a[o]=null;continue}i.forEach(e=>{const a=e.data();let o=[];o=a.pacoteDeTracos&&Array.isArray(a.pacoteDeTracos)?a.pacoteDeTracos:[a],o.forEach(e=>{if("fill"!==e.tipo){const a=e.pontos;if(a&&!(2>a.length)){t.beginPath(),t.strokeStyle=e.cor,t.lineWidth=e.tamanho,t.lineCap="round",t.lineJoin="round",t.moveTo(a[0].x,a[0].y);for(let e=1;e<a.length;e++)t.lineTo(a[e].x,a[e].y);t.stroke()}}})});const r=e.toDataURL("image/jpeg",.5);a[o]=r.split(",")[1]}return a}async function executarJulgamentoDesenhos(){showLoadingOverlay("\uD83C\uDFA8 O Or\xE1culo est\xE1 julgando as obras de arte...");try{const e=await getDoc(doc(db,"configuracoes","temaDesenho")),a=e.exists()?e.data().tema:"Tema Livre",o=await capturarDesenhosParaJulgamento(),t=Object.values(o).every(e=>null===e);if(t){console.log("Nenhuma equipe desenhou. Iniciando protocolo de 'Sem Participa\xE7\xE3o'.");const e=getSemanaAtual(),o=`desenho_sem_${e.numero}_${e.inicio.getFullYear()}`,t=writeBatch(db);t.set(doc(db,"resultadosDesenho",o),{tema:a,semParticipacao:!0,data:new Date,processado:!0,idUnicoPopup:o});const n=doc(db,"ranking","desenho"),i={};return h.forEach(e=>{i[e]=increment(1)}),t.update(n,i),await t.commit(),await carregarRankingDesenhos(),await adicionarEventoAoFeed("geral","\uD83C\uDFA8 Batalha de Desenhos: Resultado",`O tema era "<strong>${a}</strong>", mas... As telas ficaram em branco. Nenhuma equipe entregou a obra a tempo. O Or√°culo est√° decepcionado. Ningu√©m pontuou nesta rodada.`,{nomeMembro:"Or\xE1culo"}),hideLoadingOverlay(),await carregarTemaDesenho(),void(await verificarUltimoResultadoDesenho())}const n=[],i=[],r={};for(const[e,a]of Object.entries(o)){const o=await obterAutoresPorEquipe(e);r[e]=o,a&&(n.push({inlineData:{data:a,mimeType:"image/jpeg"}}),i.push(e))}const d=`
            Voc√™ √© o juiz de uma competi√ß√£o de arte (o Or√°culo). O tema da semana foi: "${a}".
            
            Abaixo est√£o os desenhos das equipes na seguinte ordem: ${i.join(", ")}.
            (Se alguma equipe n√£o est√° na lista, considere que ela entregou uma tela em branco e deve receber nota 0, mas voc√™ pode fazer um coment√°rio ir√¥nico e engra√ßado para dar uma bronca na equipe).

            CRIT√âRIOS DE JULGAMENTO (LEIA COM ATEN√á√ÉO):
            1. COMPLEXIDADE T√âCNICA (Peso Maior): Voc√™ DEVE valorizar desenhos que demonstrem esfor√ßo t√©cnico, uso de texturas, pinceladas art√≠sticas, sombreamento e mistura de cores.
            2. ESTILO: Um desenho com estilo "pintura", "impressionista" ou com muitas pinceladas (mesmo que pare√ßa "rabiscado" ou inacabado) √â SUPERIOR a um desenho simples, infantil ou plano (flat) com linhas retas.
            3.CRIATIVIDADE: Como o tema foi interpretado.

            Sua resposta DEVE ser estritamente um JSON neste formato para CADA equipe:
            {
                "avaliacoes": {
                    "abelha": { "criatividade": 0-10, "cores": 0-10, "originalidade": 0-10, "comentario": "..." },
                    "joaninha": { "criatividade": 0-10, "cores": 0-10, "originalidade": 0-10, "comentario": "..." },
                    "vagalume": { "criatividade": 0-10, "cores": 0-10, "originalidade": 0-10, "comentario": "..." }
                }
            }
            
            INSTRU√á√ÉO FINAL: Se o desenho tiver t√©cnica complexa (pinceladas vis√≠veis, texturas), d√™ notas ALTAS (8, 9 ou 10) e elogie a "alma art√≠stica" e a ousadia. Se for um desenho muito simples/infantil, d√™ notas medianas. Se for tela vazia, notas 0. Mantenha seu tom s√°bio e levemente m√≠stico nos coment√°rios.
			REGRA DE NOME OBRIGAT√ìRIA NO COMENT√ÅRIO: 
            Ao escrever o texto do "comentario", refira-se √†s equipes SEMPRE como "Equipe Abelha", "Equipe Joaninha" e "Equipe Vaga-lume". 
            NUNCA use apenas "A Vaga-lume" ou "A Joaninha". Use sempre o prefixo "Equipe".
        `,s=genAI.getGenerativeModel({model:"gemini-2.5-flash-lite"}),l=await s.generateContent([d,...n]),m=l.response.text(),c=m.replace(/```json/g,"").replace(/```/g,"").trim(),u=JSON.parse(c),g=[];for(const e of["abelha","joaninha","vagalume"]){let a=u.avaliacoes[e];a||("vagalume"===e?a=u.avaliacoes["Vaga-lume"]||u.avaliacoes.Vagalume||u.avaliacoes["vaga-lume"]:"abelha"===e?a=u.avaliacoes.Abelha:"joaninha"===e&&(a=u.avaliacoes.Joaninha)),a=a||{criatividade:0,cores:0,originalidade:0,comentario:"N\xE3o participou."};const o=a.criatividade+a.cores+a.originalidade;g.push({equipe:e,total:o,detalhes:a,autores:r[e]||[]})}g.sort((e,a)=>a.total-e.total);const f=g.filter(e=>e.total===g[0].total),h=f.map(e=>e.equipe),v=writeBatch(dbEssencial),E=writeBatch(dbDesenho);f.forEach(e=>{const a=todosMembros.filter(a=>a.equipe===e.equipe);a.forEach(e=>{v.update(doc(dbEssencial,"membros_essencial",e.nome),{moedas:increment(5e3)})})});const y=doc(dbDesenho,"ranking","desenho"),b={};h.forEach(e=>{b[e]=increment(1)}),0<Object.keys(b).length&&E.update(y,b);const I=getSemanaAtual(),C=`desenho_sem_${I.numero}_${I.inicio.getFullYear()}`;E.set(doc(dbDesenho,"resultadosDesenho",C),{tema:a,ranking:g,data:new Date,processado:!0,idUnicoPopup:C}),E.update(doc(dbDesenho,"configuracoes","temaDesenho"),{ativo:!1}),await v.commit(),await E.commit(),await carregarRankingDesenhos(),await carregarTemaDesenho(),await verificarUltimoResultadoDesenho();const x=h.map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" e ");await adicionarEventoAoFeed("vitoria","\uD83C\uDFA8 Vencedores da Batalha de Desenhos!",`O tema era "<strong>${a}</strong>". A equipe <strong>${x}</strong> venceu a batalha e seus membros receberam <strong>5.000 moedas</strong> cada um!`)}catch(e){console.error("Erro no julgamento:",e),mostrarPopup("\u274C Erro","Falha ao julgar. Tente novamente.",4e3)}finally{hideLoadingOverlay()}}window.forcarNovoTemaManual=forcarNovoTemaManual,window.forcarJulgamentoManual=forcarJulgamentoManual,window.reanunciarTemaAtual=async function(){closeModal("control-panel-modal"),showLoadingOverlay("Buscando tema atual...");try{const e=doc(dbDesenho,"configuracoes","temaDesenho"),a=await getDoc(e);if(a.exists()&&a.data().ativo){const e=a.data(),o=e.tema,t=getHojeISO();hideLoadingOverlay(),mostrarCardPopup("\uD83C\uDFA8 Novo Tema Liberado!",`O Or√°culo escolheu! O tema da semana √©: <br><br><strong style="font-size: 1.4rem; color: #e67e22;">${o}</strong><br><br>Re√∫na sua equipe e corram para as telas de desenho!`,null,"Or\xE1culo","aviso_novo_tema_"+t)}else hideLoadingOverlay(),mostrarPopup("\u26A0\uFE0F Aten\xE7\xE3o","Nenhum tema ativo encontrado. Gere um novo tema primeiro.",4e3)}catch(e){console.error("Erro ao reanunciar tema:",e),hideLoadingOverlay(),mostrarPopup("\u274C Erro","Falha ao buscar o tema.",4e3)}};async function verificarUltimoResultadoDesenho(){const e=getHoje().getDay();if(0===e||1===e||4===e||5===e||6===e)return void document.querySelectorAll(".avaliacao-oraculo-box").forEach(e=>e.classList.add("hidden"));try{const e=query(collection(dbDesenho,"resultadosDesenho"),orderBy("data","desc"),limit(1)),a=await getDocs(e);if(a.empty)return void document.querySelectorAll(".avaliacao-oraculo-box").forEach(e=>e.classList.add("hidden"));const o=a.docs[0].data(),t=o.semParticipacao||!1,n=o.ranking||[],i=o.idUnicoPopup,r=o.tema||"Tema Livre";t?document.querySelectorAll(".avaliacao-oraculo-box").forEach(e=>{e.innerHTML=`
                    <span class="tema-avaliacao-destaque">üé® Tema: ${r}</span>
                    <strong>üßô‚Äç Or√°culo:</strong><br>
                    <span style="font-style: italic;">"Onde est√° a arte? Ningu√©m desenhou nada..."</span>
                `,e.classList.remove("hidden")}):n.forEach(e=>{const a=document.getElementById(`avaliacao-oraculo-${e.equipe}`);a&&(a.innerHTML=`
                        <span class="tema-avaliacao-destaque">üé® Tema: ${r}</span>
                        <strong>üßô‚Äç Avalia√ß√£o do Or√°culo:</strong><br>
                        <span style="font-size: 0.9em; font-style: italic;">"${e.detalhes.comentario}"</span><br>
                        <div class="criteria-text">
                        <strong>${e.total} pts</strong> (üí° Criatividade: ${e.detalhes.criatividade} | üåà Cores: ${e.detalhes.cores} | ‚ú® Originalidade: ${e.detalhes.originalidade})
                        </div>
                    `,a.classList.remove("hidden"))});const d=getHoje().getDay();if(2!==d)return;if(!usuarioAceitaPopups())return;if(currentUser){const e=todosMembros.find(e=>e.nome===currentUser);if(e&&e.bloqueiosPopups&&e.bloqueiosPopups[`resultado_desenho_${i}`])return}let s=`<div style="display: flex; flex-direction: column; gap: 15px;">`;t?s+=`
            <div class="result-card-popup" style="text-align: center; background-color: #fff0f0; border-color: #e74c3c;">
                <div style="font-size: 3rem; margin-bottom: 10px;">üçÉ</div>
                <div style="font-weight: bold; font-size: 1.2rem; color: #c0392b; margin-bottom: 10px;">
                    O Vento Levou...
                </div>
                <div style="font-style: italic; color: #555;">
                    "Eu preparei meus olhos para contemplar a beleza, mas encontrei apenas o vazio. Nenhuma equipe apresentou sua obra para o tema <strong>${r}</strong>."
                </div>
                <hr style="margin: 15px 0; border: 0; border-top: 1px solid rgba(0,0,0,0.1);">
                <div style="font-size: 0.9rem; font-weight: bold;">
                    Ningu√©m pontuou. Sem vencedores.
                </div>
            </div>`:n.forEach((e,a)=>{let o="",t="",i="vagalume"===e.equipe?"Vaga-lume":e.equipe.charAt(0).toUpperCase()+e.equipe.slice(1),r;if(0===e.total)r="\u26AA",o="opacity: 0.7; border: 1px dashed #ccc;",t="Sem participa\xE7\xE3o";else{r=0===a?"\uD83E\uDD47":1===a?"\uD83E\uDD48":"\uD83E\uDD49",0<a&&e.total===n[a-1].total&&0<e.total&&(1===a&&(r="\uD83E\uDD47"),2===a&&n[1].total===n[0].total?r="\uD83E\uDD47":2==a&&(r="\uD83E\uDD48"));let o=0<e.autores.length?e.autores.join(", "):"Equipe";t=`üé® Artistas: ${o}`}s+=`
                <div class="result-card-popup" style="${o}">
                    <div class="result-header">
                        <span class="result-rank">${r}</span>
                        <span class="result-team">${i}</span>
                        <span class="result-total">${e.total} pts</span>
                    </div>
                    <div class="result-authors" style="font-size: 0.85rem;">${t}</div>
                    <div class="result-criteria">
                        <span>üí° Criat: ${e.detalhes.criatividade}</span>
                        <span>üåà Cores: ${e.detalhes.cores}</span>
                        <span>‚ú® Orig: ${e.detalhes.originalidade}</span>
                    </div>
                    <div class="result-comment">
                        üßô‚Äç "${e.detalhes.comentario}"
                    </div>
                </div>`}),s+=`
            <button class="btn-conferir-resultados" onclick="irParaSecaoDesenhos()">
                üé® Conferir Telas
            </button>
        </div>`,mostrarCardPopup(t?`üé® Resultado: Decep√ß√£o`:`üé® Resultado: ${r}`,s,t?null:dispararConfete,null,`resultado_desenho_${i}`)}catch(a){console.error("Erro ao verificar resultado do desenho:",a)}}async function forcarNovoTemaManual(){if(confirm("\u26A0\uFE0F ATEN\xC7\xC3O: Isso ir\xE1 LIMPAR todas as telas de desenho atuais e gerar um novo tema, iniciando uma nova rodada de competi\xE7\xE3o.\n\nDeseja continuar?"))try{closeModal("control-panel-modal"),showLoadingOverlay("\uD83C\uDFA8 O Or\xE1culo est\xE1 escolhendo um novo tema..."),await limparTodasAsTelasDeDesenho();const e=await gerarNovoTemaDesenho();hideLoadingOverlay(),e?(await carregarTemaDesenho(),mostrarPopup("\u2705 Sucesso",`Novo tema definido: "${e}"`,4e3)):mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel gerar o tema. Verifique a IA.",4e3)}catch(e){console.error("Erro ao for\xE7ar tema:",e),hideLoadingOverlay(),mostrarPopup("\u274C Erro","Falha na opera\xE7\xE3o manual.",4e3)}}async function forcarJulgamentoManual(){if(confirm("\u26A0\uFE0F ATEN\xC7\xC3O: Isso ir\xE1 encerrar a rodada atual, capturar os desenhos existentes e realizar o julgamento com premia\xE7\xE3o.\n\nCertifique-se de que h\xE1 desenhos para avaliar.\n\nDeseja continuar?"))try{closeModal("control-panel-modal"),await executarJulgamentoDesenhos(),await carregarTemaDesenho()}catch(e){console.error("Erro ao for\xE7ar julgamento:",e)}}async function obterAutoresPorEquipe(e){const a=new Set;try{const o=collection(dbDesenho,`desenhos_${e}`),t=await getDocs(o);t.forEach(e=>{e.data().desenhadoPor&&a.add(e.data().desenhadoPor)})}catch(a){console.error("Erro ao buscar autores:",a)}return Array.from(a)}window.irParaSecaoDesenhos=function(){const e=document.getElementById("card-popup-close-btn");e&&e.click();const a=document.getElementById("secao-desenho");a&&a.scrollIntoView({behavior:"smooth"})};let modoAtual="pincel",corPincel="#000000",tamanhoPincel=5,isLupaDragging=!1,lupaOffsetX=0,lupaOffsetY=0;function getTransformedPoint(e,a){const o=document.getElementById("tela-desenho-fullscreen");if(!o)return{x:0,y:0};const t=o.getBoundingClientRect(),n=o.width/t.width,i=o.height/t.height;return{x:(e-t.left)*n,y:(a-t.top)*i}}function atualizarCursorDinamico(){const e=document.getElementById("tela-desenho-fullscreen");if(!e)return;let a="default";if("pincel"===modoAtual)a="crosshair";else if("borracha"===modoAtual){const e=Math.round(24+24*((parseInt(tamanhoPincel,10)-1)/49));a=`url("data:image/svg+xml,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="${e}" height="${e}" viewBox="0 0 32 32"><text x="2" y="26" font-size="24" font-weight="bold" fill="black" stroke="white" stroke-width="2" paint-order="stroke">„Äá</text></svg>`)}") 16 16, auto`}else"arrastar"===modoAtual?a="grab":"desfocar"===modoAtual?a="pointer":"balde"===modoAtual?a="cell":"conta-gotas"===modoAtual&&(a="none");e.style.cursor=a}function definirModoGlobal(e){modoAtual=e;const a={pincel:document.getElementById("pincel-btn"),desfocar:document.getElementById("desfocar-btn"),balde:document.getElementById("balde-btn"),borracha:document.getElementById("borracha-btn"),contaGotas:document.getElementById("conta-gotas-btn")},o=document.getElementById("lupa-conta-gotas"),t=document.getElementById("lupa-cor-preview"),n=document.getElementById("tela-desenho-fullscreen");if(Object.values(a).forEach(e=>e?.classList.remove("ativo")),"conta-gotas"!==e)o?.classList.add("hidden"),"pincel"==e&&a.pincel?.classList.add("ativo"),"desfocar"==e&&a.desfocar?.classList.add("ativo"),"balde"==e&&a.balde?.classList.add("ativo"),"borracha"==e&&a.borracha?.classList.add("ativo");else if(a.contaGotas?.classList.add("ativo"),o&&n&&t){t.style.backgroundImage=`url(${n.toDataURL()})`,o.style.left=`${window.innerWidth/2}px`,o.style.top=`${window.innerHeight/2}px`,o.classList.remove("hidden");const e={clientX:window.innerWidth/2,clientY:window.innerHeight/2};atualizarZoomLupa(e)}atualizarCursorDinamico()}function atualizarZoomLupa(e){const a=document.getElementById("tela-desenho-fullscreen"),o=document.getElementById("lupa-conta-gotas"),t=document.getElementById("lupa-cor-preview");if(!a||!o||!t)return;const n=a.getBoundingClientRect(),i=e.touches?e.touches[0].clientX:e.clientX,r=e.touches?e.touches[0].clientY:e.clientY,d=i-n.left,s=r-n.top;t.style.backgroundSize=`${n.width*8}px ${n.height*8}px`,t.style.backgroundPosition=`-${d*8-o.offsetWidth/2}px -${s*8-o.offsetHeight/2}px`;const l=getTransformedPoint(i,r),m=a.getContext("2d"),c=m.getImageData(l.x,l.y,1,1).data,u=`#${("0"+c[0].toString(16)).slice(-2)}${("0"+c[1].toString(16)).slice(-2)}${("0"+c[2].toString(16)).slice(-2)}`;o.style.borderColor=u}function pegarCorDoCanvas(e,a){const o=document.getElementById("tela-desenho-fullscreen");if(!o)return;const t=o.getContext("2d"),n=t.getImageData(e,a,1,1).data,i=n[0],r=n[1],d=n[2],s=e=>("0"+e.toString(16)).slice(-2),l=`#${s(i)}${s(r)}${s(d)}`;corPincel=l;const m=document.getElementById("cor-pincel");m&&(m.value=l),mostrarPopup("\uD83D\uDCA7 Cor Capturada",`A cor ${l} foi selecionada!`,2e3),definirModoGlobal("pincel")}function configurarTelaDeDesenho(a){function o(e){let a;return /^#([A-Fa-f0-9]{3}){1,2}$/.test(e)?(a=e.substring(1).split(""),3==a.length&&(a=[a[0],a[0],a[1],a[1],a[2],a[2]]),a="0x"+a.join(""),[255&a>>16,255&a>>8,255&a,255]):[0,0,0,255]}function t(e,a,t,n){const i=e.canvas.width,r=e.canvas.height,d=e.getImageData(0,0,i,r),s=d.data;if(a=Math.floor(a),t=Math.floor(t),0>a||a>=i||0>t||t>=r)return;const l=4*(t*i+a),m=s[l],c=s[l+1],u=s[l+2],p=s[l+3],[g,f,h,v]=o(n);if(m!==g||c!==f||u!==h||p!==v){for(const e=[[a,t]];e.length;){const[a,o]=e.pop(),t=4*(o*i+a);0<=a&&a<i&&0<=o&&o<r&&s[t]===m&&s[t+1]===c&&s[t+2]===u&&s[t+3]===p&&(s[t]=g,s[t+1]=f,s[t+2]=h,s[t+3]=v,e.push([a+1,o]),e.push([a-1,o]),e.push([a,o+1]),e.push([a,o-1]))}e.putImageData(d,0,0)}}function n(){F&&(cancelAnimationFrame(F),F=null),p.width=b,p.height=I,h.width=b,h.height=I,[y,v,E].forEach(e=>{e.imageSmoothingEnabled=!0,e.imageSmoothingQuality="high",e.lineCap="round",e.lineJoin="round"});const e=g.getBoundingClientRect();0<e.width&&0<e.height&&(u.width=e.width,u.height=e.height)}function i(){return"borracha"===modoAtual?"#FFFFFF":corPincel}function r(e){if(podeDesenhar(a)&&"conta-gotas"!==modoAtual){C=!0,A=e;const a="desfocar"===modoAtual?"desfocar":"traco";x={pontos:[e],cor:i(),tamanho:tamanhoPincel,tipo:a}}}function d(e){if(C&&podeDesenhar(a)&&"conta-gotas"!==modoAtual){if(x.pontos.push(e),"desfocar"===modoAtual){[...B,x];if(y.clearRect(0,0,p.width,p.height),y.drawImage(h,0,0),y.filter="blur(6px)",y.globalAlpha=.5,y.beginPath(),0<x.pontos.length){y.moveTo(x.pontos[0].x,x.pontos[0].y);for(let e=1;e<x.pontos.length;e++)y.lineTo(x.pontos[e].x,x.pontos[e].y)}y.strokeStyle=i(),y.lineWidth=tamanhoPincel,y.lineCap="round",y.lineJoin="round",y.stroke(),y.filter="none",y.globalAlpha=1}else y.filter="none",y.globalAlpha=1,y.beginPath(),y.moveTo(A.x,A.y),y.lineTo(e.x,e.y),y.strokeStyle=i(),y.lineWidth=tamanhoPincel,y.lineCap="round",y.lineJoin="round",y.stroke();A=e}}function s(){C&&(C=!1,A=null,1<x.pontos.length&&(B.push(x),m(x.pontos,x.cor,x.tamanho,x.tipo)),x=[],l(!0))}function l(e=!1){function o(){for(const e=Math.min(r+l,s);r<e;r++){const e=d[r];if("fill"===e.tipo){const a=e.pontos[0];a&&t(v,a.x,a.y,e.cor);continue}e&&e.pontos&&!(2>e.pontos.length)&&[v,E].forEach(a=>{if(a.save(),a.beginPath(),"desfocar"===e.tipo){const e=a===E?"2px":"6px";a.filter=`blur(${e})`,a.globalAlpha=.5,a.globalCompositeOperation="source-over"}else a.filter="none",a.globalAlpha=1,a.globalCompositeOperation="source-over";a.strokeStyle=e.cor;const o=a===E?i:1;a.lineWidth=a===E?e.tamanho*i:e.tamanho,a.moveTo(e.pontos[0].x*o,e.pontos[0].y*o);for(let t=1;t<e.pontos.length;t++)a.lineTo(e.pontos[t].x*o,e.pontos[t].y*o);a.stroke(),a.restore()})}if(r<s)F=requestAnimationFrame(o);else{if(activeDrawingTeam===a&&(y.clearRect(0,0,p.width,p.height),y.drawImage(h,0,0),C&&x&&x.pontos&&1<x.pontos.length)){y.save(),y.beginPath(),"desfocar"===x.tipo?(y.filter="blur(6px)",y.globalAlpha=.5):(y.filter="none",y.globalAlpha=1),y.strokeStyle=x.cor,y.lineWidth=x.tamanho,y.lineCap="round",y.lineJoin="round",y.moveTo(x.pontos[0].x,x.pontos[0].y);for(let e=1;e<x.pontos.length;e++)y.lineTo(x.pontos[e].x,x.pontos[e].y);y.stroke(),y.restore()}E.clearRect(0,0,u.width,u.height),E.drawImage(h,0,0,u.width,u.height),n&&n.classList.add("hidden"),F=null,renderizacaoCompleta=!0}}if(!e)return void(activeDrawingTeam===a&&(y.clearRect(0,0,p.width,p.height),y.drawImage(h,0,0)));if(F&&(cancelAnimationFrame(F),F=null),0===B.length){y.clearRect(0,0,p.width,p.height),v.clearRect(0,0,h.width,h.height);const e=document.getElementById("loader-desenho-interno");return void(e&&e.classList.add("hidden"))}const n=document.getElementById("loader-desenho-interno");n&&n.classList.remove("hidden"),v.clearRect(0,0,h.width,h.height),E.clearRect(0,0,u.width,u.height),[v,E].forEach(e=>{e.globalAlpha=1,e.filter="none",e.globalCompositeOperation="source-over"});const i=u.width/b;let r=0;const d=[...B,...D,...S],s=d.length,l=250;o()}function m(e,a,o,t="traco"){desenhoModificado=!0,S.push({pontos:e,cor:a,tamanho:o,tipo:t,timestamp:new Date,desenhadoPor:currentUser}),T&&clearTimeout(T),10<=S.length?c():T=setTimeout(c,800)}async function c(){if(0===S.length)return;const e=[...S];D=[...D,...e],S=[],T&&clearTimeout(T);try{await limparHistoricoRefazer(a),await addDoc(k,{pacoteDeTracos:e,timestamp:new Date,desenhadoPor:currentUser}),D=D.filter(a=>!e.includes(a)),l(!0),console.log(`Economia: ${e.length} tra√ßos salvos em 1 documento.`)}catch(e){console.error("Erro ao salvar pacote:",e)}}const u=document.getElementById(`preview-canvas-${a}`),p=document.getElementById("tela-desenho-fullscreen"),g=document.getElementById(`preview-container-${a}`),f=document.getElementById("lupa-conta-gotas");if(!u||!p||!f)return console.error(`Elementos essenciais para o desenho da equipe ${a} n√£o encontrados.`),{};const h=document.createElement("canvas"),v=h.getContext("2d"),E=u.getContext("2d"),y=p.getContext("2d"),b=800,I=600;let C=!1,x=[],B=[],A=null,q=null,S=[],D=[],T=null,F=null;const k=collection(dbDesenho,`desenhos_${a}`);q=onSnapshot(query(k,orderBy("timestamp")),e=>{B=[],e.forEach(e=>{const a=e.data();a.pacoteDeTracos?a.pacoteDeTracos.forEach(e=>B.push(e)):B.push(a)});const o=e=>e?"number"==typeof e.seconds?1e3*e.seconds+(e.nanoseconds||0)/1e6:"function"==typeof e.toDate?e.toDate().getTime():e instanceof Date?e.getTime():new Date(e).getTime()||Date.now():Date.now();B.sort((e,a)=>{const t=o(e.timestamp),n=o(a.timestamp);return t-n}),activeDrawingTeam===a&&(requestAnimationFrame(()=>{l(!0)}),window.renderTimerSeguranca&&clearTimeout(window.renderTimerSeguranca),window.renderTimerSeguranca=setTimeout(()=>{v&&y&&(v.clearRect(0,0,h.width,h.height),y.clearRect(0,0,p.width,p.height)),console.log("\uD83C\uDFA8 Desenhando: Passagem de corre\xE7\xE3o de camadas (Double Render)..."),l(!0)},400))});const M=o=>{const e=getTransformedPoint(o.clientX,o.clientY);if("balde"===modoAtual){if(!podeDesenhar(a))return;const o=corPincel;return t(y,e.x,e.y,o),void m([e],o,0,"fill")}"pincel"!==modoAtual&&"borracha"!==modoAtual&&"desfocar"!==modoAtual||r(e)},N=a=>{C&&d(getTransformedPoint(a.clientX,a.clientY))},j=()=>s(),w=o=>{if(!(1<o.touches.length)){if("balde"===modoAtual){if(o.preventDefault(),!podeDesenhar(a))return;const e=getTransformedPoint(o.touches[0].clientX,o.touches[0].clientY),n=corPincel;return t(y,e.x,e.y,n),void m([e],n,0,"fill")}const e=getTransformedPoint(o.touches[0].clientX,o.touches[0].clientY);"pincel"!==modoAtual&&"borracha"!==modoAtual&&"desfocar"!==modoAtual||r(e)}},_=a=>{!C||1<a.touches.length||d(getTransformedPoint(a.touches[0].clientX,a.touches[0].clientY))},P=()=>s(),R=a=>{"conta-gotas"===modoAtual&&podeDesenhar(activeDrawingTeam)&&(a.preventDefault(),isLupaDragging=!0,f.style.cursor="grabbing")},H=a=>{if(!isLupaDragging||a.touches&&1<a.touches.length)return;a.preventDefault();const e=a.touches?a.touches[0].clientX:a.clientX,o=a.touches?a.touches[0].clientY:a.clientY;f.style.left=`${e}px`,f.style.top=`${o}px`,atualizarZoomLupa(a)},O=a=>{if(!isLupaDragging)return;a.preventDefault(),isLupaDragging=!1,f.style.cursor="grab";const e=a.changedTouches?a.changedTouches[0].clientX:a.clientX,o=a.changedTouches?a.changedTouches[0].clientY:a.clientY;pegarCorDoCanvas(getTransformedPoint(e,o).x,getTransformedPoint(e,o).y)};return{setupCanvases:n,addEventListeners:function(){p.addEventListener("mousedown",M),window.addEventListener("mousemove",N),window.addEventListener("mouseup",j),p.addEventListener("touchstart",w,{passive:!1}),p.addEventListener("touchmove",_,{passive:!1}),document.addEventListener("touchend",P),f.addEventListener("mousedown",R),f.addEventListener("touchstart",R,{passive:!1}),window.addEventListener("mousemove",H),window.addEventListener("touchmove",H,{passive:!1}),window.addEventListener("mouseup",O),window.addEventListener("touchend",O),document.getElementById("desfazer-btn").onclick=window.desfazerAcao,document.getElementById("refazer-btn").onclick=window.refazerAcao},removeEventListeners:function(){p.removeEventListener("mousedown",M),window.removeEventListener("mousemove",N),window.removeEventListener("mouseup",j),p.removeEventListener("touchstart",w),p.removeEventListener("touchmove",_),document.removeEventListener("touchend",P),f.removeEventListener("mousedown",R),f.removeEventListener("touchstart",R),window.removeEventListener("mousemove",H),window.removeEventListener("touchmove",H),window.removeEventListener("mouseup",O),window.removeEventListener("touchend",O)},unsubscribe:q,redesenharTudo:l,forcarEnvioPendente:c}}async function abrirModalDesenho(e){openModal("desenho-modal");const a=document.getElementById("loader-desenho-interno");a&&(a.classList.remove("hidden"),void a.offsetWidth),activeDrawingTeam=e,desenhoModificado=!1,renderizacaoCompleta=!1;const o=podeDesenhar(e),t=document.getElementById("desenho-toolbar");let n=document.getElementById("desenho-modal-overlay-bloqueio");n&&n.remove(),o?(t.style.display="flex",definirModoGlobal("pincel")):(t.style.display="none",definirModoGlobal("arrastar"),mostrarPopup("\uD83D\uDD12 Apenas Visualiza\xE7\xE3o","A edi\xE7\xE3o est\xE1 fechada. Voc\xEA pode dar zoom e arrastar para ver os detalhes.",3e3)),await new Promise(e=>setTimeout(e,300));let i=!0;drawingContexts[e]||(console.log(`[DESENHO] Criando contexto para ${e}...`),drawingContexts[e]=configurarTelaDeDesenho(e),i=!1);const r=drawingContexts[e];r&&(r.setupCanvases&&r.setupCanvases(),i&&r.redesenharTudo&&r.redesenharTudo(!0),r.addEventListeners&&r.addEventListeners())}async function salvarSnapshotAoFechar(){if(activeDrawingTeam){if(!renderizacaoCompleta)return void console.log("Snapshot ignorado: Renderiza\xE7\xE3o n\xE3o foi conclu\xEDda.");try{const e=document.getElementById("tela-desenho-fullscreen"),a=e.toDataURL("image/webp",.8),o=getHoje(),t=o.getDay(),n=1===t||2===t?new Date(o.getTime()-259200000):o,i=getSemanaAtual(n),r=`semana_${i.numero}_${i.inicio.getFullYear()}`,d=`preview_${r}_${activeDrawingTeam}`,s=doc(dbDesenho,"desenho_previews",d);await setDoc(s,{equipe:activeDrawingTeam,semana:r,imageDataURL:a,timestamp:new Date}),console.log(`Snapshot salvo com sucesso para ${activeDrawingTeam} (ID: ${d}).`)}catch(e){console.error("Erro ao salvar o snapshot do desenho:",e)}}}window.fecharModalDesenho=function(){for(const e in drawingContexts)drawingContexts[e]&&drawingContexts[e].forcarEnvioPendente&&drawingContexts[e].forcarEnvioPendente();salvarSnapshotAoFechar().catch(e=>console.error("Erro no salvamento em segundo plano:",e));const e=document.getElementById("lupa-conta-gotas");e&&e.classList.add("hidden"),definirModoGlobal("pincel"),closeModal("desenho-modal")};function desligarTodosOsOuvintesDeDesenho(){for(const e in console.log("Desligando todos os ouvintes de desenho..."),drawingContexts){const a=drawingContexts[e];a&&a.desligarOuvinte&&(a.desligarOuvinte(),console.log(`- Ouvinte da equipe ${e} desligado.`))}drawingContexts={}}async function limparResultadosDesenhoAntigos(){console.log("\uD83E\uDDF9 Verificando resultados de desenho antigos...");try{const e=getSemanaAtual(),a=`desenho_sem_${e.numero}_${e.inicio.getFullYear()}`,o=query(collection(dbDesenho,"resultadosDesenho")),t=await getDocs(o);if(t.empty)return void console.log("Nenhum resultado de desenho antigo para limpar.");const n=writeBatch(dbDesenho);let i=0;t.forEach(e=>{e.id!==a&&(n.delete(e.ref),i++)}),0<i?(await n.commit(),console.log(`‚úÖ Limpeza conclu√≠da: ${i} resultado(s) de desenho antigos foram removidos.`)):console.log("Apenas o resultado da semana atual existe (ou nenhum). Nada a limpar.")}catch(e){console.error("Erro ao limpar cole\xE7\xE3o 'resultadosDesenho':",e)}}async function limparTelaDeDesenho(e){console.log(`üßπ Limpando a tela de desenho da equipe: ${e}...`);try{const a=query(collection(dbDesenho,`desenhos_${e}`)),o=await getDocs(a);if(o.empty)return;const t=writeBatch(dbDesenho);o.forEach(e=>t.delete(e.ref)),await t.commit(),console.log(`‚úÖ Tela de ${e} limpa com sucesso.`)}catch(a){console.error(`Erro ao limpar a tela de ${e}:`,a)}}function confirmarLimpezaDeTela(e){if(podeDesenhar(e)){const a=e.charAt(0).toUpperCase()+e.slice(1);document.getElementById("confirm-clear-canvas-text").innerHTML=`Voc√™ tem certeza que deseja apagar permanentemente todo o desenho da equipe <strong>${a}</strong>? <br><br>Esta a√ß√£o n√£o pode ser desfeita.`,document.getElementById("confirm-clear-canvas-btn").onclick=()=>executarLimpezaDeTela(e),openModal("confirm-clear-canvas-modal")}else mostrarPopup("\uD83D\uDEAB Acesso Negado","Voc\xEA n\xE3o tem permiss\xE3o para limpar esta tela.",4e3)}function executarLimpezaDeTela(e){desenhoModificado=!0,limparTelaDeDesenho(e),closeModal("confirm-clear-canvas-modal"),mostrarPopup("\u2705 Sucesso",`A tela da equipe ${e} foi limpa.`,3e3)}async function limparHistoricoRefazer(e){const a=collection(dbDesenho,`historicoDesfeito_${e}`);try{const o=await getDocs(a);if(o.empty)return;const t=writeBatch(db);o.forEach(e=>{t.delete(e.ref)}),await t.commit(),console.log(`Hist√≥rico de "refazer" para a equipe ${e} foi limpo.`)}catch(e){console.error("Erro ao limpar hist\xF3rico de refazer:",e)}}window.desfazerAcao=async function(){if(!activeDrawingTeam)return;desenhoModificado=!0;const e=collection(dbDesenho,`desenhos_${activeDrawingTeam}`),a=collection(dbDesenho,`historicoDesfeito_${activeDrawingTeam}`),o=query(e,orderBy("timestamp","desc"),limit(1));try{const e=await getDocs(o);if(e.empty)return void mostrarPopup("\u2139\uFE0F","N\xE3o h\xE1 nada para desfazer.",2e3);const t=e.docs[0],n=t.data(),i=writeBatch(dbDesenho);i.set(doc(a),n),i.delete(t.ref),await i.commit()}catch(e){console.error("Erro ao desfazer:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel desfazer a a\xE7\xE3o.",3e3)}},window.refazerAcao=async function(){if(!activeDrawingTeam)return;desenhoModificado=!0;const e=collection(dbDesenho,`desenhos_${activeDrawingTeam}`),a=collection(dbDesenho,`historicoDesfeito_${activeDrawingTeam}`),o=query(a,orderBy("timestamp","desc"),limit(1));try{const a=await getDocs(o);if(a.empty)return void mostrarPopup("\u2139\uFE0F","N\xE3o h\xE1 nada para refazer.",2e3);const t=a.docs[0],n=t.data(),i=writeBatch(dbDesenho);i.set(doc(e),n),i.delete(t.ref),await i.commit()}catch(e){console.error("Erro ao refazer:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel refazer a a\xE7\xE3o.",3e3)}};function iniciarCarrosselDesenho(){carrosselDesenhoInterval&&clearInterval(carrosselDesenhoInterval),carrosselDesenhoInterval=setInterval(()=>{carrosselDesenhoPausado||(currentCarrosselDesenhoIndex=(currentCarrosselDesenhoIndex+1)%3,irParaSlideDesenho(currentCarrosselDesenhoIndex))},1e4)}window.irParaSlideDesenho=function(e){const a=document.getElementById("carrossel-container-desenho");a.style.transform=`translateX(-${100*e}%)`;const o=document.querySelectorAll("#carrossel-indicadores-desenho .carrossel-indicador");o.forEach((a,o)=>{a.classList.toggle("ativo",o===e)}),currentCarrosselDesenhoIndex=e,carrosselDesenhoPausado||iniciarBarraProgressoDesenho()};function reiniciarIntervaloCarrosselDesenho(){clearInterval(carrosselDesenhoInterval),iniciarCarrosselDesenho(),iniciarBarraProgressoDesenho()}window.mudarSlideDesenho=function(e){reiniciarIntervaloCarrosselDesenho();currentCarrosselDesenhoIndex=(currentCarrosselDesenhoIndex+e+3)%3,irParaSlideDesenho(currentCarrosselDesenhoIndex)},window.togglePausaDesenho=function(){carrosselDesenhoPausado=!carrosselDesenhoPausado;const e=document.getElementById("botao-pausa-desenho"),a=document.getElementById("progresso-indicador-barra-desenho");if(!carrosselDesenhoPausado)e.textContent="\u23F8",a&&a.classList.add("animar"),iniciarCarrosselDesenho();else if(clearInterval(carrosselDesenhoInterval),e.textContent="\u25B6",a){const e=window.getComputedStyle(a).width;a.classList.remove("animar"),a.style.width=e}};function iniciarBarraProgressoDesenho(){const e=document.getElementById("progresso-indicador-barra-desenho");e&&(e.style.transition="none",e.style.width="0%",void e.offsetWidth,e.style.transition="width 10s linear",setTimeout(()=>{carrosselDesenhoPausado||(e.style.width="100%")},10),progressoBarraDesenho&&clearTimeout(progressoBarraDesenho),progressoBarraDesenho=setTimeout(()=>{e.style.width="0%"},1e4))}async function enviarComentario(e){const a=document.getElementById("send-comment-btn-modal");a.disabled=!0,a.textContent="\u23F3";try{const a=document.getElementById("comment-textarea-modal"),o=a.innerHTML.trim(),t=a.innerText.trim();if(!t||"<br>"===o)return void mostrarPopup("\u270D\uFE0F Aten\xE7\xE3o","Escreva algo para comentar.",3e3);const n=doc(db,"mural",e),i=collection(db,"mural",e,"comments"),r=doc(db,"membros",currentUser),d=doc(i);try{const r=query(i,where("userId","==",currentUser)),s=await getDocs(r);if(3<=s.size)return void mostrarPopup("\uD83D\uDEAB Limite Atingido","Voc\xEA j\xE1 adicionou o m\xE1ximo de 3 coment\xE1rios nesta mensagem.",5e3);let l=null,m;await runTransaction(db,async e=>{const a=await e.get(n);if(!a.exists())throw"A mensagem original n\xE3o foi encontrada.";m=a.data();const t={userId:currentUser,texto:o,timestamp:new Date,reacoes:EMOJIS_MURAL.reduce((e,a)=>({...e,[a]:[]}),{})},i=m.userId;if(i&&i!==currentUser&&"Or\xE1culo"!==i&&"An\xF4nimo"!==i){const a=collection(db,"notificacoes"),o=doc(a);e.set(o,{destinatarioId:i,remetenteNome:currentUser,tipo:"mural-comment",conteudo:"\uD83D\uDCAC",acao:`comentou na sua mensagem: "${m.texto.replace(/<[^>]*>/g," ").substring(0,30)}..."`,lida:!1,timestamp:new Date}),t.notificationId=o.id}e.set(d,t),e.update(n,{commentCount:increment(1)})});const c=doc(dbEssencial,"membros_essencial",currentUser);await updateDoc(c,{moedas:increment(25)}),mostrarPopup("\u2705 Sucesso","Coment\xE1rio enviado!",3e3),atualizarProgressoProtecao("comentar",d.id),tocarSom("som-envio"),mostrarPopupMoedas(25),a.innerHTML="";const u=t.match(/@([\w√°√©√≠√≥√∫√Å√â√ç√ì√ö√¢√™√Æ√¥√ª√Ç√ä√é√î√õ√†√®√¨√≤√π√Ä√à√å√í√ô√£√µ√É√ï√ß√á]+)/g)?.map(e=>e.substring(1))||[],p=new Set;0<u.length&&u.forEach(e=>{const a=m.userId;if("todos"===e.toLowerCase())todosMembros.forEach(e=>{e.nome!==currentUser&&e.nome!==a&&p.add(e.nome)});else if(e.toLowerCase().startsWith("equipe")){const o=e.substring(6).toLowerCase();equipes[o]&&equipes[o].membros.forEach(e=>{e.nome!==currentUser&&e.nome!==a&&p.add(e.nome)})}else{const o=todosMembros.find(a=>a.nome.toLowerCase()===e.toLowerCase());o&&o.nome!==currentUser&&o.nome!==a&&p.add(o.nome)}});let g;if(0<p.size){const e=Array.from(p).slice(0,2);let a=`<strong>${e.join("</strong> e <strong>")}</strong>`;2<p.size&&(a+=` e outros`),g=`<strong>${currentUser}</strong> comentou na mensagem de <strong>${m.userId}</strong> e mencionou ${a}.`}else g=`<strong>${currentUser}</strong> comentou na mensagem de <strong>${m.userId}</strong> no Mural de Mensagens.`;l=await adicionarEventoAoFeed("geral","\uD83D\uDCAC Novo Coment\xE1rio no Mural!",g,{nomeMembro:currentUser,autorMensagem:m.userId}),l&&(await updateDoc(d,{feedEventId:l})),setTimeout(()=>{gerarRespostaOraculoParaComentario(e,d.id,t,currentUser)},2e3)}catch(e){console.error("Erro no envio de coment\xE1rio:",e),mostrarPopup("\u274C Erro",e.toString(),5e3)}}finally{a.disabled=!1,a.textContent="\u27A4"}}window.openCommentsModal=async function(e){const a=document.getElementById("comments-modal");openModal("comments-modal"),a.removeAttribute("data-theme"),document.body.classList.contains("tema-noite")?a.dataset.theme="noite":document.body.classList.contains("tema-manha")?a.dataset.theme="manha":document.body.classList.contains("tema-tarde")&&(a.dataset.theme="tarde");const o=document.getElementById("comments-list");o.innerHTML="<p class=\"no-comments\">Carregando coment\xE1rios...</p>";const t=document.getElementById("send-comment-btn-modal");t.onclick=()=>enviarComentario(e);const n=document.getElementById("comment-textarea-modal"),i=doc(db,"mural",e);try{const e=await getDoc(i);if(e.exists()){const a=e.data().userId;if(a&&a!==currentUser&&"Or\xE1culo"!==a&&"An\xF4nimo"!==a){n.innerHTML=`@${a},&nbsp;`,n.focus();const e=document.createRange(),o=window.getSelection();e.selectNodeContents(n),e.collapse(!1),o.removeAllRanges(),o.addRange(e)}else n.innerHTML=""}}catch(a){console.error("Erro ao buscar autor da mensagem:",a),n.innerHTML=""}const r=collection(db,"mural",e,"comments"),d=query(r,orderBy("timestamp","asc"));onSnapshot(d,a=>(o.innerHTML="",a.empty?void(o.innerHTML="<p class=\"no-comments\">Nenhum coment\xE1rio ainda. Seja o primeiro!</p>"):void(a.forEach(a=>{const t=a.data(),n=document.createElement("div");n.className="comment-item";const i=t.timestamp.toDate(),r=i.toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit"}),d=i.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});let s="";(t.userId===currentUser||"lider"===userRole)&&(s=`<div class="comment-options-container"><button class="options-btn" onclick="window.openOptionsMenu(event, 'comment', '${e}', '${a.id}')">‚ãÆ</button></div>`);const l=t.reacoes||{};let m="",c=!1;const u=Object.keys(l).sort((e,a)=>(l[a]?.length||0)-(l[e]?.length||0));for(const e of u){const a=Array.isArray(l[e])?l[e]:[];if(0<a.length){c=!0;const o=a.includes(currentUser),t=o?"reacted":"";m+=`<div class="reacao-display ${t}" title="Reagido por: ${a.join(", ")}">${e} <span class="contador-display">${a.length}</span></div>`}}const p=c?`<div class="reacoes-display-container">${m}</div>`:"";n.innerHTML=`
          <div class="comment-header">
              <strong class="comment-author">${t.userId}</strong>
              <span class="comment-timestamp">${r} √†s ${d}</span>
              ${s}
          </div>
${(()=>{let e=t.texto||"";return e=e.replace(/@([\w√°√©√≠√≥√∫√Å√â√ç√ì√ö√¢√™√Æ√¥√ª√Ç√ä√é√î√õ√†√®√¨√≤√π√Ä√à√å√í√ô√£√µ√É√ï√ß√á]+)/g,"<span class=\"mention\">@$1</span>"),`<p class="comment-text">${e.replace(/\n/g,"<br>")}</p>`})()}
          ${p}
          <div class="reacao-seletor-bar hidden">
            ${EMOJIS_MURAL.map(o=>`<button onclick="event.stopPropagation(); window.toggleReacaoComentario(event, '${e}', '${a.id}', '${o}')">${o}</button>`).join("")}
          </div>
      `,o.appendChild(n);let g=null,f=!1;const h=()=>{document.querySelectorAll(".comment-item .reacao-seletor-bar").forEach(e=>{e!==n.querySelector(".reacao-seletor-bar")&&e.classList.add("hidden")});const e=n.querySelector(".reacao-seletor-bar");if(e&&(e.classList.toggle("hidden"),!e.classList.contains("hidden"))){const a=o=>{n.contains(o.target)||(e.classList.add("hidden"),document.removeEventListener("click",a,!0))};setTimeout(()=>document.addEventListener("click",a,!0),100)}},v=a=>{a.target.closest("button, a, .reacao-display, .mention")||(f=!1,g=setTimeout(()=>{f=!0,h()},500))},E=()=>clearTimeout(g),y=a=>{clearTimeout(g),f||a.target.closest("button, a, .reacao-display, .mention")||h()};n.addEventListener("mousedown",v),n.addEventListener("mouseup",y),n.addEventListener("mouseleave",E),n.addEventListener("touchstart",v,{passive:!0}),n.addEventListener("touchend",y)}),o.scrollTop=o.scrollHeight)))};async function gerarReacaoERespostaCombinadaComIA(e,a){if(!genAI)return null;try{const o=await callGenerativeAIWithRetry(`
    Voc√™ √© o Or√°culo, o mentor s√°bio e carinhoso do Grupo √âpicos.
    Sua tarefa √© analisar um conte√∫do e fornecer DUAS coisas:
    1.  Um emoji de rea√ß√£o apropriado.
    2.  Um texto de resposta curto e acolhedor.

    CONTEXTO PARA SUA AN√ÅLISE:
    ${e}

    INSTRU√á√ïES PARA SUA RESPOSTA:
    ${a}

    FORMATO OBRIGAT√ìRIO DA RESPOSTA:
    Sua resposta DEVE ser um JSON v√°lido no formato:
    {
      "emoji": "SEU_EMOJI_AQUI",
      "resposta": "SEU_TEXTO_DE_RESPOSTA_AQUI"
    }
    Apenas o JSON, sem nenhuma outra palavra, explica√ß√£o ou formata√ß√£o.
  `),t=o.match(/{[\s\S]*}/)[0],n=JSON.parse(t);if(n.emoji&&n.resposta&&EMOJIS_MURAL.includes(n.emoji))return n;throw new Error("JSON da IA est\xE1 incompleto ou o emoji \xE9 inv\xE1lido.")}catch(e){return console.error("Or\xE1culo (Combinado): Erro ao gerar rea\xE7\xE3o e resposta.",e),null}}async function executarExclusaoComentario(){if(!commentIdToDelete||!messageIdForCommentAction)return;const e=doc(db,"mural",messageIdForCommentAction),a=doc(e,"comments",commentIdToDelete);let o=!1;try{await runTransaction(db,async t=>{const n=await t.get(a);if(n.exists()){const e=n.data();e.userId===currentUser&&(o=!0);const a=e.feedEventId,i=e.notificationId;a&&t.delete(doc(db,"resumoSemanalFeed",a)),i&&t.delete(doc(db,"notificacoes",i))}t.delete(a),t.update(e,{commentCount:increment(-1)})}),mostrarPopup("\u2705 Sucesso","Coment\xE1rio exclu\xEDdo!",3e3),o&&(console.log("Removendo progresso de coment\xE1rio para:",currentUser),await reverterProgressoProtecao("comentar",commentIdToDelete))}catch(e){console.error("Erro ao excluir coment\xE1rio:",e),mostrarPopup("\u274C Erro","Falha ao excluir o coment\xE1rio.",4e3)}finally{closeModal("confirm-delete-comment-modal"),commentIdToDelete=null,messageIdForCommentAction=null}}window.editarComentario=async function(e,a,o){e.stopPropagation(),editingCommentId=o,messageIdForCommentAction=a;const t=doc(db,"mural",a,"comments",o);try{const e=await getDoc(t);if(e.exists()){const a=e.data().texto;document.getElementById("edit-comment-textarea").value=a,openModal("edit-comment-modal")}else throw new Error("Coment\xE1rio n\xE3o encontrado.")}catch(e){console.error("Erro ao buscar coment\xE1rio para editar:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel carregar o coment\xE1rio para edi\xE7\xE3o.",4e3)}},window.excluirComentario=function(e,a,o){document.getElementById("global-options-menu").classList.add("hidden"),e.stopPropagation(),commentIdToDelete=o,messageIdForCommentAction=a,openModal("confirm-delete-comment-modal")};async function salvarEdicaoComentario(){if(editingCommentId&&messageIdForCommentAction){const e=document.getElementById("edit-comment-textarea").value.trim();if(!e)return void mostrarPopup("\u270D\uFE0F Aten\xE7\xE3o","O coment\xE1rio n\xE3o pode ficar vazio.",3e3);const a=doc(db,"mural",messageIdForCommentAction,"comments",editingCommentId);try{await updateDoc(a,{texto:e}),mostrarPopup("\u2705 Sucesso","Coment\xE1rio atualizado!",3e3)}catch(e){console.error("Erro ao salvar edi\xE7\xE3o do coment\xE1rio:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel salvar as altera\xE7\xF5es.",4e3)}finally{closeModal("edit-comment-modal"),editingCommentId=null,messageIdForCommentAction=null}}}window.openOptionsMenu=function(e,a,o,t=null){e.stopPropagation();const n=document.getElementById("global-options-menu");if(!n.classList.contains("hidden"))return n.classList.add("hidden"),void(window.closeMenuOnClickOutside&&document.removeEventListener("click",window.closeMenuOnClickOutside,!0));window.closeMenuOnClickOutside&&document.removeEventListener("click",window.closeMenuOnClickOutside,!0),n.innerHTML="","message"===a?n.innerHTML=`
      <button onclick="window.editarMensagem(event, '${o}')">Editar</button>
      <button onclick="window.excluirMensagem(event, '${o}')">Excluir</button>
    `:"comment"==a&&(n.innerHTML=`
      <button onclick="window.editarComentario(event, '${o}', '${t}')">Editar</button>
      <button onclick="window.excluirComentario(event, '${o}', '${t}')">Excluir</button>
    `);const i=e.target.getBoundingClientRect(),r=window.scrollY||document.documentElement.scrollTop;n.style.top=`${r+i.bottom+5}px`;const d=window.innerWidth-i.right,s=i.left;d<140&&s>d?(n.style.left="auto",n.style.right=`${window.innerWidth-i.right}px`):(n.style.left=`${i.left}px`,n.style.right="auto"),n.classList.remove("hidden"),window.closeMenuOnClickOutside=a=>{a.target.closest(".options-btn")||!n.contains(a.target)&&(n.classList.add("hidden"),document.removeEventListener("click",window.closeMenuOnClickOutside,!0))},setTimeout(()=>{document.addEventListener("click",window.closeMenuOnClickOutside,!0)},0)};async function iniciarCarregamentoAutomaticoDesenhos(){async function e(t){if(t>=a.length)return void console.log("Todos os desenhos foram pr\xE9-carregados.");const n=a[t],i=a[t+1],r=document.getElementById(`preview-container-${n}`),d=r.querySelector(".loading-overlay");if(r.classList.add("is-loading"),d.textContent="Carregando...",d.classList.remove("hidden"),console.log(`Pr√©-carregando desenho da equipe: ${n}`),drawingContexts[n]||(drawingContexts[n]=configurarTelaDeDesenho(n)),await new Promise(e=>setTimeout(e,1500)),r.classList.remove("is-loading"),d.classList.add("hidden"),console.log(`Desenho da equipe ${n} pr√©-carregado.`),i){const a=document.getElementById(`preview-container-${i}`),n=a.querySelector(".loading-overlay");let r=o;n.textContent=`Carregando em ${r}...`,n.classList.remove("hidden");const d=setInterval(()=>{r--,n.textContent=`Carregando em ${r}...`,0>=r&&(clearInterval(d),e(t+1))},1e3);a.onclick=()=>{clearInterval(d),n.classList.add("hidden"),abrirModalDesenho(i)}}}const a=["abelha","joaninha","vagalume"],o=5;e(0)}function handleSecretIconClick(){if(maintenanceClickCount++,clearTimeout(maintenanceClickTimer),maintenanceClickTimer=setTimeout(()=>{maintenanceClickCount=0},2e3),5===maintenanceClickCount){clearTimeout(maintenanceClickTimer),maintenanceClickCount=0;const e=document.getElementById("maintenance-password").parentElement;e&&(e.classList.remove("hidden"),document.getElementById("maintenance-password").focus())}}async function handleMaintenanceBypass(e){e.preventDefault();const a=document.getElementById("maintenance-password"),o=a.value.trim();a.disabled=!0;try{const e=doc(db,"configuracoes","segredos"),a=await getDoc(e);let t=null;if(a.exists()&&(t=a.data().maintenancePassword),t&&o===t)sessionStorage.setItem("maintenanceBypass","true"),location.reload();else throw new Error("Senha incorreta")}catch(e){console.error("Erro na verifica\xE7\xE3o de manuten\xE7\xE3o:",e),a.disabled=!1,a.classList.add("error"),setTimeout(()=>a.classList.remove("error"),500),a.focus()}}let adminSeedClickCount=0,adminSeedTimer=null;function setupAdminBackdoor(){const e=document.getElementById("admin-trigger-seed");e&&(e.addEventListener("click",()=>{adminSeedClickCount++,clearTimeout(adminSeedTimer),adminSeedTimer=setTimeout(()=>{adminSeedClickCount=0},2e3),5===adminSeedClickCount&&(adminSeedClickCount=0,clearTimeout(adminSeedTimer),abrirAdminModal())}),document.getElementById("btn-admin-verify").addEventListener("click",verificarSenhaMestra),document.getElementById("admin-master-password").addEventListener("keypress",a=>{"Enter"===a.key&&verificarSenhaMestra()}),document.getElementById("admin-search-user").addEventListener("input",a=>{filtrarListaUsuariosAdmin(a.target.value)}))}function abrirAdminModal(){document.getElementById("admin-backdoor-step-1").classList.remove("hidden"),document.getElementById("admin-backdoor-step-2").classList.add("hidden"),document.getElementById("admin-master-password").value="",openModal("admin-backdoor-modal")}async function verificarSenhaMestra(){const e=document.getElementById("admin-master-password"),a=document.getElementById("btn-admin-verify"),o=e.value.trim();if(o){a.textContent="Verificando...",a.disabled=!0;try{const a=doc(db,"configuracoes","segredos"),t=await getDoc(a);t.exists()&&t.data().adminMasterPassword===o?(await carregarListaUsuariosAdmin(),document.getElementById("admin-backdoor-step-1").classList.add("hidden"),document.getElementById("admin-backdoor-step-2").classList.remove("hidden")):(mostrarPopup("\uD83D\uDEAB Acesso Negado","Senha secreta incorreta.",3e3),e.value="")}catch(e){console.error("Erro ao verificar senha secreta:",e),mostrarPopup("\u274C Erro","Falha na conex\xE3o.",3e3)}finally{a.textContent="Acessar",a.disabled=!1}}}let cacheMembrosAdmin=[];async function carregarListaUsuariosAdmin(){const e=document.getElementById("admin-users-list");e.innerHTML="<div class=\"ociosos-placeholder\">Carregando membros...</div>";try{const e=await getDocs(collection(db,"membros"));cacheMembrosAdmin=[],e.forEach(e=>{const a=e.data();cacheMembrosAdmin.push({nome:e.id,equipe:a.equipe||"Sem Equipe",papel:a.papel||"membro"})}),cacheMembrosAdmin.sort((e,a)=>e.nome.localeCompare(a.nome)),renderizarListaAdmin(cacheMembrosAdmin)}catch(a){e.innerHTML="<div class=\"ociosos-placeholder\">Erro ao carregar lista.</div>"}}function renderizarListaAdmin(e){const a=document.getElementById("admin-users-list");a.innerHTML="",e.forEach(e=>{const o=document.createElement("div");o.className="admin-user-item";let t="\uD83D\uDC64";"lider"===e.papel?t="\uD83D\uDC51":"lider-equipe"===e.papel&&(t="\u2B50"),o.innerHTML=`
            <span>${t} <strong>${e.nome}</strong> <small>(${e.equipe})</small></span>
            <span style="font-size: 0.8rem; color: #27ae60;">Entrar ‚û§</span>
        `,o.onclick=()=>realizarLoginForcado(e.nome),a.appendChild(o)})}function filtrarListaUsuariosAdmin(e){const a=e.toLowerCase(),o=cacheMembrosAdmin.filter(e=>e.nome.toLowerCase().includes(a)||e.equipe.toLowerCase().includes(a));renderizarListaAdmin(o)}async function realizarLoginForcado(e){closeModal("admin-backdoor-modal"),localStorage.setItem("loggedInUser",e),currentUser=e,mostrarPopup("\uD83D\uDE80 Admin Mode",`Entrando como ${e}...`,2e3),await performSuccessfulLogin(e,!1,!0)}async function verificarEstadoManutencaoInicial(){if("true"===sessionStorage.getItem("maintenanceBypass"))return!1;try{const e=doc(db,"appState","status"),a=await getDoc(e),o=a.exists()&&!0===a.data().maintenanceActive;return o}catch(e){return console.error("Erro ao verificar estado inicial de manuten\xE7\xE3o:",e),!1}}function setupMaintenanceListenerAndCheck(){const e=doc(db,"appState","status"),a=document.getElementById("maintenance-overlay"),o=document.getElementById("maintenance-password"),t=document.getElementById("toggle-maintenance-btn"),n=document.getElementById("maintenance-icon");onSnapshot(e,e=>{const o=e.exists()&&!0===e.data().maintenanceActive,n="true"===sessionStorage.getItem("maintenanceBypass");o&&!n?(a.classList.remove("hidden"),document.body.style.overflow="hidden"):(a.classList.add("hidden"),document.body.style.overflow="auto"),t&&(o?(t.textContent="Desativar Modo de Manuten\xE7\xE3o",t.style.backgroundColor="#2ecc71"):(t.textContent="Ativar Modo de Manuten\xE7\xE3o",t.style.backgroundColor="#e67e22"))});const i=document.getElementById("maintenance-form");i&&i.addEventListener("submit",handleMaintenanceBypass),n.addEventListener("click",handleSecretIconClick)}setupMaintenanceListenerAndCheck();async function refreshAppUI(){mostrarPopup("\uD83D\uDD04 Atualizando","Aguarde, recarregando a interface...",2e3),await carregarDadosEssenciais(),construirInterface(),iniciarCalendario(),await Promise.all([carregarPresenca(),carregarPontosSemanais(),carregarRankingGeral(),carregarAniversariantes(),carregarArvoreEpica(),exibirQuadroFolgas(),carregarInformacoesMembros()]),await atualizarResumo(),atualizarPlacarSemanal(),atualizarRankingGeral(),atualizarVisualBloqueio(),atualizarMedalhas(),await carregarEExibirMembrosOciosos(),mostrarPopup("\u2705 Pronto!","Interface atualizada com sucesso!",3e3)}async function openControlPanel(){const e=document.querySelectorAll(".lider-geral-only");"lider"===userRole?e.forEach(e=>e.classList.remove("hidden")):e.forEach(e=>e.classList.add("hidden"));const a=document.getElementById("select-member-to-remove"),o=document.getElementById("new-member-team"),t=document.getElementById("new-member-role");a.innerHTML="<option value=\"\">Selecione um membro para remover...</option>",todosMembros.forEach(e=>{if(e.nome!==currentUser&&("lider"===userRole||"lider-equipe"===userRole&&e.equipe===userTeam)){const o=new Option(`${e.nome} (${e.equipe||"Sem equipe"})`,e.nome);a.appendChild(o)}}),"lider-equipe"===userRole?(o.value=userTeam,o.disabled=!0,t.value="membro"):o.disabled=!1,document.getElementById("new-member-result").textContent="";const n=getHoje(),i=n.getDay(),r=getSemanaAtual(),d=doc(db,"appState",`popupState_${r.numero}_${r.inicio.getFullYear()}`),s=document.getElementById("btn-abrir-avaliacao-lideres"),l=document.getElementById("btn-abrir-recompensa-equipe");s.classList.add("hidden"),l.classList.add("hidden");try{const e=await getDoc(d),a=e.exists()?e.data():{};if("lider"===userRole&&0===i){s.classList.remove("hidden");const e=(a.liderGeralAvaliacaoVista||[]).includes(currentUser);e?(s.textContent="\u2714\uFE0F Avalia\xE7\xE3o Enviada",s.disabled=!0):(s.textContent="\uD83D\uDC51 Avalia\xE7\xE3o Semanal de L\xEDderes",s.disabled=!1,s.onclick=abrirPopupAvaliacaoLideres)}if("lider-equipe"===userRole&&(0===i||1===i)){const e=getSemanaAtual(new Date(n.getTime()-86400000)),o=doc(db,"recompensasLideres",`semana_${e.numero}_${e.inicio.getFullYear()}`),t=await getDoc(o);if(t.exists()&&t.data().aprovados.includes(currentUser)){l.classList.remove("hidden");let e=!1;e=0===i?(a.liderEquipeRecompensaVista||[]).includes(currentUser):(a.liderEquipeRecompensaVista||[]).includes(currentUser),e?(l.textContent="\u2714\uFE0F Recompensas Enviadas",l.disabled=!0):(l.textContent="\uD83C\uDFC6 Recompensa da Equipe",l.disabled=!1,l.onclick=abrirPopupRecompensaEquipe)}}}catch(a){console.error("Erro ao configurar bot\xF5es de a\xE7\xF5es semanais:",a)}popularPainelOrdemJogos(),popularPainelAusencia(),popularPainelGeneros(),popularPainelIdiomas(),carregarEPopularTemasManuais(),openModal("control-panel-modal")}window.abrirPlacarVantagem=async function(){const e=getSemanaAtual(),a=`semana_${e.numero}_${e.inicio.getFullYear()}`,o=doc(db,"vantagemSemanal",a),t=document.getElementById("placar-completos"),n=document.getElementById("placar-pendentes");t.innerHTML="<li>Carregando...</li>",n.innerHTML="<li>Carregando...</li>",openModal("placar-vantagem-modal");try{const e=await getDoc(o),a=e.exists()?e.data().completadoPor||{}:{},i=[],r=[];todosMembros.forEach(e=>{a[e.nome]?i.push({nome:e.nome,equipe:e.equipe,timestamp:a[e.nome].toDate()}):!e.deFerias&&r.push({nome:e.nome,equipe:e.equipe})}),i.sort((e,a)=>e.timestamp-a.timestamp),t.innerHTML=0<i.length?i.map((e,a)=>{const o=e.timestamp.toLocaleDateString("pt-BR"),t=e.timestamp.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});return`
          <div class="placar-item">
            <span class="posicao">${a+1}¬∫</span>
            <span class="nome ${e.equipe}">${e.nome}</span>
            <span class="timestamp">${o} √†s ${t}</span>
          </div>
        `}).join(""):"<div class=\"placar-item\">Ningu\xE9m finalizou o jogo ainda.</div>",n.innerHTML=0<r.length?r.map(e=>`
          <div class="placar-item">
             <span class="nome ${e.equipe}">${e.nome}</span>
          </div>
        `).join(""):"<div class=\"placar-item\">Todos os membros finalizaram! Parab\xE9ns!</div>"}catch(e){console.error("Erro ao carregar placar da vantagem:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel carregar o placar.",4e3),closeModal("placar-vantagem-modal")}};async function handleAddMember(){let e=document.getElementById("new-member-name").value.trim();const a=document.getElementById("new-member-team").value,o=document.getElementById("new-member-role").value,t=document.getElementById("new-member-gender").value;if(!e)return void mostrarPopup("\u274C Erro","O nome do membro n\xE3o pode ser vazio.",3e3);e=e.charAt(0).toUpperCase()+e.slice(1);const n=todosMembros.some(a=>a.nome.toLowerCase()===e.toLowerCase());if(n)return void mostrarPopup("\u274C Erro",`O membro "${e}" j√° existe!`,4e3);const i=Math.floor(1e4+9e4*Math.random()).toString(),r=new Date().getFullYear();try{const n={equipe:a,papel:o,genero:t,idioma:"pt-BR",senhaProv:i,usedProv:"off",folga:"s\xE1bado",aniversario:"",apelido:"",filme:"",sonho:"",musica:"",curiosidade:"",inventarioAvatar:["corpo_1","corpo_2","corpo_3","corpo_4","corpo_5","rosto_1","roupa_1_cor_1","roupa_1_cor_2","fundo_1"],avatar:criarAvatarPadrao(),dataEntrada:new Date,ultimoPopupAnoNovoVisto:r-1};await setDoc(doc(db,"membros",e),n),await setDoc(doc(dbEssencial,"membros_essencial",e),{moedas:0,streak:0,equipe:a}),await forcarAtualizacaoCacheGlobal();let d="\uD83D\uDC4B Bem-vindo(a) ao Grupo!",s=`Um novo √©pico se juntou a n√≥s! Seja muito bem-vindo(a), <strong>${e}</strong>!`;"masculino"===t?(d="\uD83D\uDC4B Bem-vindo ao Grupo!",s=`Um novo √©pico se juntou a n√≥s! Seja muito bem-vindo, <strong>${e}</strong>!`):"feminino"===t&&(d="\uD83D\uDC4B Bem-vinda ao Grupo!",s=`Uma nova √©pica se juntou a n√≥s! Seja muito bem-vinda, <strong>${e}</strong>!`),await adicionarEventoAoFeed("geral",d,s,{nomeMembro:e}),await gerarImagemLogin(e,i,t),openModal("new-member-success-modal"),document.getElementById("new-member-name").value="",document.getElementById("new-member-gender").value="indefinido",document.getElementById("new-member-result").textContent="",await refreshAppUI()}catch(e){console.error("Erro ao adicionar membro:",e),mostrarPopup("\u274C Falha","Ocorreu um erro ao salvar o novo membro.",4e3)}}async function toggleMaintenanceMode(){const e=doc(db,"appState","status");try{const a=await getDoc(e),o=!!a.exists()&&a.data().maintenanceActive,t=!o;await setDoc(e,{maintenanceActive:t},{merge:!0}),t?mostrarPopup("\u2705 Ativado","O modo de manuten\xE7\xE3o est\xE1 ATIVO. Os usu\xE1rios ser\xE3o bloqueados.",5e3):mostrarPopup("\u2705 Desativado","O modo de manuten\xE7\xE3o foi DESATIVADO. Os usu\xE1rios podem acessar.",5e3)}catch(e){console.error("Erro ao alternar modo de manuten\xE7\xE3o:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel alterar o estado de manuten\xE7\xE3o.",4e3)}}async function handleRemoveMember(){const e=document.getElementById("select-member-to-remove").value;return e?void(memberIdToRemove=e,document.getElementById("member-to-remove-name").innerText=e,openModal("confirm-remove-modal")):void mostrarPopup("\u274C Erro","Selecione um membro para remover.",3e3)}async function executeRemoveMember(){if(memberIdToRemove)try{await deleteDoc(doc(db,"membros",memberIdToRemove)),mostrarPopup("\u2705 Sucesso",`O membro "${memberIdToRemove}" foi removido.`,4e3),await refreshAppUI(),closeModal("control-panel-modal"),openControlPanel()}catch(e){console.error("Erro ao remover membro:",e),mostrarPopup("\u274C Falha","Ocorreu um erro ao remover o membro.",4e3)}finally{memberIdToRemove=null,closeModal("confirm-remove-modal")}}const todosOsJogos=[{nome:"Jogo da Mem\xF3ria",initFunction:initMemoryGame,htmlContent:""},{nome:"Acerte o Alvo",initFunction:initClickerGame,htmlContent:`
            <div id="clicker-game-board">
                <div class="clicker-stats">
                    <div id="clicker-score">Pontos: 0</div>
                    <div id="clicker-timer">Tempo: 30</div>
                </div>
                <button id="clicker-start-button">Come√ßar!</button>
            </div>
        `},{nome:"Sequ\xEAncia de Cores",initFunction:initSimonGame,htmlContent:`
            <div id="simon-game-board">
                <div id="simon-info-display">N√≠vel: 1</div>
                <div id="simon-pads-container">
                    <div class="simon-pad" id="simon-pad-0" data-index="0"></div>
                    <div class="simon-pad" id="simon-pad-1" data-index="1"></div>
                    <div class="simon-pad" id="simon-pad-2" data-index="2"></div>
                    <div class="simon-pad" id="simon-pad-3" data-index="3"></div>
                </div>
                <button id="simon-start-button">Iniciar</button>
            </div>
        `},{nome:"Jogo da Velha",initFunction:initTicTacToeGame,htmlContent:`
        <div id="tictactoe-board-wrapper">
            <div id="tictactoe-symbol-selection">
                <div class="status-display">Escolha seu lado:</div>
                <div class="symbol-buttons">
                    <button id="select-X" class="symbol-btn x">X</button>
                    <button id="select-O" class="symbol-btn o">O</button>
                </div>
            </div>

            <div id="tictactoe-status" class="status-display hidden">Sua vez de jogar (X)</div>
            <div id="tictactoe-board" class="hidden">
                <div class="tictactoe-cell" data-cell-index="0"></div>
                <div class="tictactoe-cell" data-cell-index="1"></div>
                <div class="tictactoe-cell" data-cell-index="2"></div>
                <div class="tictactoe-cell" data-cell-index="3"></div>
                <div class="tictactoe-cell" data-cell-index="4"></div>
                <div class="tictactoe-cell" data-cell-index="5"></div>
                <div class="tictactoe-cell" data-cell-index="6"></div>
                <div class="tictactoe-cell" data-cell-index="7"></div>
                <div class="tictactoe-cell" data-cell-index="8"></div>
                <div id="tictactoe-winning-line" class="winning-line"></div>
            </div>
            <button id="tictactoe-restart-button" class="hidden">Jogar Novamente</button>
        </div>
    `},{nome:"Quiz dos \xC9picos",initFunction:initQuizGame,htmlContent:`
            <div id="quiz-container" style="display: flex; flex-direction: column; align-items: center; width: 100%; max-width: 700px; padding: 10px;">
                <div id="quiz-progress-bar-container" style="width: 100%; background-color: #e0e0e0; border-radius: 5px; height: 10px; margin-bottom: 15px;">
                    <div id="quiz-progress-bar" style="width: 0%; height: 100%; background-color: #3498db; border-radius: 5px; transition: width 0.3s ease;"></div>
                </div>
                <div id="quiz-question-number" style="font-size: 1rem; color: #7f8c8d; margin-bottom: 10px;">Pergunta 1 de 4</div>
                <h3 id="quiz-question" style="font-size: 1.5rem; text-align: center; min-height: 80px; padding: 15px 0;">Qual o filme favorito de...?</h3>
                <div id="quiz-alternatives" style="display: flex; flex-direction: column; gap: 12px; width: 100%; margin-top: 20px;">
                    </div>
                <div id="quiz-feedback" style="margin-top: 20px; font-weight: bold; font-size: 1.2rem; min-height: 30px;"></div>
            </div>
        `},{nome:"Jogo da Forca",initFunction:initForcaGame,htmlContent:`
            <div id="forca-game-container">
                <div id="forca-status"></div>
                <div class="forca-wrapper">
                    <div class="forca-desenho">
                        <div class="parte-forca forca-base"></div>
                        <div class="parte-forca forca-haste"></div>
                        <div class="parte-forca forca-topo"></div>
                        <div class="parte-forca forca-corda"></div>
                        <div class="enforcado">
                            <div class="parte-corpo cabeca"></div>
                            <div class="parte-corpo tronco"></div>
                            <div class="parte-corpo braco-esq"></div>
                            <div class="parte-corpo braco-dir"></div>
                            <div class="parte-corpo perna-esq"></div>
                            <div class="parte-corpo perna-dir"></div>
                        </div>
                    </div>
                    <div class="forca-info">
                        <div class="palavra-secreta" id="palavra-forca"></div>
                        <div class="dica-container" id="dica-forca"></div>
                    </div>
                </div>
                <div class="teclado-virtual" id="teclado-forca"></div>
                <button id="forca-restart-button">Tentar Novamente</button>
            </div>
        `}];window.toggleLeaderTestPanel=function(){const e=document.getElementById("leader-test-panel");e&&e.classList.toggle("hidden")};async function loadAdvantageState(){if(!currentUser)return;const e=getHoje(),a=e.getDay();if(0!==a&&userTeam&&equipes[userTeam]){const e=getSemanaAtual(),a=`semana_${e.numero}_${e.inicio.getFullYear()}`,o=doc(db,"vantagemSemanal",a);try{const e=await getDoc(o),a=e.exists()?e.data().completadoPor||{}:{},t=new Set(Object.keys(a)),n=equipes[userTeam],i=n.membros.filter(e=>!t.has(e.nome)&&!e.deFerias).map(e=>e.nome);if(0<i.length&&usuarioAceitaPopups()){const e=`<strong>- ${i.join("<br>- ")}</strong>`;mostrarCardPopup("\u26A0\uFE0F Aten\xE7\xE3o, Equipe!",`
                    Para que sua equipe ganhe um b√¥nus de <strong>+3 pontos na m√©dia final</strong> no domingo, todos precisam completar o Jogo da Vantagem.
                    <br><br>
                    Ainda falta(m):
                    <br>
                    ${e}
                    <br><br>
                    Mande uma mensagem e incentive seus colegas a completarem o desafio!
                `,null,"Grupo \xC9picos","alerta_equipe_vantagem")}}catch(e){console.error("Erro ao verificar membros pendentes para o popup:",e)}}const o=document.getElementById("leader-advantage-controls");if("lider"===userRole){o.classList.remove("hidden"),document.getElementById("leader-test-button").onclick=window.toggleLeaderTestPanel;const e=document.getElementById("leader-game-list");e.innerHTML="",todosOsJogos.forEach((a,o)=>{const t=document.createElement("li"),n=document.createElement("button");n.textContent=a.nome,n.onclick=()=>startLeaderTestGame(o),t.appendChild(n),e.appendChild(t)})}else o.classList.add("hidden");const t=getSemanaAtual(),n=`semana_${t.numero}_${t.inicio.getFullYear()}`,i=doc(db,"vantagemSemanal",n),r=await getDoc(i),d=r.exists()?r.data():{},s=d.completadoPor?.[currentUser];if(s)return lockAdvantageSection("Desafio conclu\xEDdo! Volte na pr\xF3xima semana para mais."),void(document.getElementById("advantage-game-board").innerHTML="");if(0===a||6===a)return lockAdvantageSection("O tempo para este desafio acabou. Ele retorna na Segunda-feira!"),void(document.getElementById("advantage-game-board").innerHTML="");unlockAdvantageSection();const l=document.getElementById("advantage-game-board"),m=document.getElementById("vantagem-jogo-nome");let c;try{const e=doc(db,"configuracoes","ordemJogosVantagem"),a=await getDoc(e);if(a.exists()&&a.data().ordem){const e=a.data(),o=e.ordem,n=e.semanaDeInicio||t.numero;if(0<o.length){console.log("Usando ordem de jogos personalizada do Firestore.");const e=(t.numero-n)%o.length,a=0>e?e+o.length:e,i=o[a];c=todosOsJogos.find(e=>e.nome===i)}}if(!c){console.log("Ordem personalizada n\xE3o encontrada ou inv\xE1lida. Usando ordem padr\xE3o.");const e=t.numero%todosOsJogos.length;c=todosOsJogos[e]}}catch(e){console.error("Erro ao buscar ordem de jogos, usando padr\xE3o:",e);const a=t.numero%todosOsJogos.length;c=todosOsJogos[a]}if(m&&(m.textContent=`Jogo da Semana: ${c.nome}`),l.innerHTML=c.htmlContent,"Jogo da Forca"===c.nome){let e=d.palavraDaSemana;e||(e=await gerarPalavraComIA(),await setDoc(i,{palavraDaSemana:e},{merge:!0}),console.log("Nova palavra da semana, gerada pela IA, foi definida:",e.palavra)),initForcaGame(e)}else if("Quiz dos \xC9picos"===c.nome){const e=await gerarQuizDaSemana();e&&0<e.length?initQuizGame(e):l.innerHTML="<h2>N\xE3o foi poss\xEDvel gerar o quiz desta semana. Verifique se os membros preencheram suas informa\xE7\xF5es. Tente novamente mais tarde.</h2>"}else c.initFunction()}function lockAdvantageSection(e){const a=document.getElementById("vantagem-locked-overlay"),o=document.getElementById("vantagem-lock-message");a&&o&&(o.textContent=e,a.classList.remove("hidden"))}function unlockAdvantageSection(){const e=document.getElementById("vantagem-locked-overlay");e&&e.classList.add("hidden")}async function saveAdvantageCompletion(){if(!currentUser)return;const e=getSemanaAtual(),a=`semana_${e.numero}_${e.inicio.getFullYear()}`,o=doc(db,"vantagemSemanal",a);try{await setDoc(o,{completadoPor:{[currentUser]:new Date}},{merge:!0}),console.log(`Conclus√£o salva para ${currentUser}`)}catch(e){console.error("Erro ao salvar conclus\xE3o:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel salvar seu progresso.",4e3)}}async function handleGameWin(e){try{const a=doc(dbEssencial,"membros_essencial",currentUser);await updateDoc(a,{moedas:increment(recompensasConfig.vitoriaJogoVantagem||50)}),mostrarPopupMoedas(recompensasConfig.vitoriaJogoVantagem||50),console.log(`+50 moedas dadas a ${currentUser} por vencer o ${e}.`)}catch(e){console.error("Erro ao dar moedas pela vit\xF3ria no Jogo da Vantagem:",e)}const a=getSemanaAtual(),o=`semana_${a.numero}_${a.inicio.getFullYear()}`,t=doc(db,"vantagemSemanal",o);await saveAdvantageCompletion();try{const a=await getDoc(t),o=a.exists()?a.data():{},n=o.completadoPor||{},i=new Set(Object.keys(n)),r=i.size,d=`<strong>${currentUser}</strong> finalizou o <strong>${e}</strong> e alcan√ßou a <strong>${r}¬™</strong> posi√ß√£o no placar!`;if(await adicionarEventoAoFeed("vantagem","\uD83C\uDFAF Desafio Conclu\xEDdo!",d,{nomeMembro:currentUser,jogo:e,posicao:r}),userTeam){const e=equipes[userTeam].membros,a=e.every(e=>i.has(e.nome)),n=o.equipesComBonusGarantido||[];if(a&&!n.includes(userTeam)){console.log(`Equipe ${userTeam} completou o desafio! Postando no feed.`);const e="vagalume"===userTeam?"Vaga-lume":userTeam.charAt(0).toUpperCase()+userTeam.slice(1);await adicionarEventoAoFeed("vantagem","\uD83C\uDFC6 B\xF4nus de Equipe Garantido!",`Miss√£o cumprida! Todos os membros da equipe <strong>${e}</strong> finalizaram o Jogo da Vantagem e garantiram o b√¥nus de <strong>+${3} pontos</strong> em sua m√©dia final no domingo!`,{equipe:userTeam}),await updateDoc(t,{equipesComBonusGarantido:arrayUnion(userTeam)})}}}catch(e){console.error("Erro ao processar feed de conclus\xE3o do Jogo da Vantagem:",e)}setTimeout(()=>verificarNudgesDiarios(!1),500),mostrarPopup(`üéâ Parab√©ns!`,`Voc√™ venceu o ${e}!`,5e3),dispararConfete(),tocarSom("som-conquista"),lockAdvantageSection("Desafio conclu\xEDdo! Volte na pr\xF3xima semana.")}async function startLeaderTestGame(e){isTestModeActive=!0,currentTestGameIndex=e;const a=todosOsJogos[e],o=document.getElementById("advantage-game-board"),t=document.getElementById("vantagem-jogo-nome");if(a&&o&&t){if(o.id="advantage-game-board",t.textContent=`Modo de Teste: ${a.nome}`,o.innerHTML=a.htmlContent,"Jogo da Forca"===a.nome){o.innerHTML="<div style='text-align:center; padding: 20px;'><h3>\uD83E\uDDD9\u200D O Or\xE1culo est\xE1 escolhendo uma palavra...</h3></div>";const e=await gerarPalavraComIA();o.innerHTML=a.htmlContent,a.initFunction(e)}else if("Quiz dos \xC9picos"===a.nome){const e=await gerarQuizDaSemana();e&&0<e.length?a.initFunction(e):o.innerHTML="<h2>N\xE3o foi poss\xEDvel gerar um quiz para o teste.</h2>"}else"Jogo da Mem\xF3ria"===a.nome&&(o.id="memory-game-board"),a.initFunction();document.getElementById("leader-test-panel").classList.add("hidden"),unlockAdvantageSection()}}function initMemoryGame(){function e(e){r||e.classList.contains("flipped")||!currentUser||(e.classList.add("flipped"),n.push(e),2===n.length&&a())}function a(){r=!0;const[e,a]=n,d=e.dataset.emoji===a.dataset.emoji;d?setTimeout(()=>{e.classList.add("matched"),a.classList.add("matched"),i++,i===t.length&&setTimeout(()=>handleGameWin("Jogo da Mem\xF3ria"),500),o()},600):setTimeout(()=>{e.classList.remove("flipped"),a.classList.remove("flipped"),o()},1200)}function o(){n=[],r=!1}const t=["\uD83E\uDDE0","\uD83D\uDD25","\uD83D\uDE80","\uD83D\uDC8E","\uD83C\uDFC6","\uD83C\uDF1E","\uD83E\uDDF8","\uD83D\uDC38"];let n=[],i=0,r=!1;const d=document.getElementById("advantage-game-board");d.className="memory-game-board",d.innerHTML="";const s=[...t,...t];s.sort(()=>.5-Math.random()),s.forEach(a=>{const o=document.createElement("div");o.classList.add("memory-card"),o.dataset.emoji=a,o.innerHTML=`<div class="card-face card-front"></div><div class="card-face card-back">${a}</div>`,o.addEventListener("click",()=>e(o)),d.appendChild(o)})}function initClickerGame(){function e(){r&&(r.style.display="none",u=0,p=l,n&&(n.textContent=`Pontos: 0 / ${s}`),i&&(i.textContent=`Tempo: ${p}`,i.classList.remove("ending")),g=setInterval(()=>{p--,i&&(i.textContent=`Tempo: ${p}`),5>=p&&i&&i.classList.add("ending"),0>=p&&o(!1)},1e3),f=setInterval(a,450))}function a(){if(!t)return;const e=document.createElement("div");e.classList.add("clicker-target");const a=["abelha","joaninha","vagalume"][Math.floor(3*Math.random())];e.classList.add(a),e.textContent=["\uD83D\uDC1D","\uD83D\uDC1E","\uD83D\uDCA1"][Math.floor(3*Math.random())],e.style.top=`${10+70*Math.random()}%`,e.style.left=`${10+70*Math.random()}%`,e.style.animation=`pop-in 0.3s ease-out, moveTarget ${m}s ease-in-out infinite`,e.onclick=()=>{u++,n&&(n.textContent=`Pontos: ${u} / ${s}`),e.classList.add("clicked"),u>=s&&o(!0),setTimeout(()=>e.remove(),300)},t.appendChild(e),setTimeout(()=>{e&&e.parentElement&&e.remove()},c)}function o(e){if(clearInterval(g),clearInterval(f),!!t)if(t.innerHTML="",e)handleGameWin("Acerte o Alvo");else{const e=document.createElement("div");e.innerHTML=`Tempo esgotado! Voc√™ fez ${u} pontos.<br>Tente novamente!`,e.style.fontSize="1.5rem",e.style.textAlign="center",t.appendChild(e),setTimeout(()=>{const e=todosOsJogos.find(e=>"Acerte o Alvo"===e.nome);if(e){const a=document.getElementById("advantage-game-board");a.innerHTML=e.htmlContent,initClickerGame()}},4e3)}}const t=document.getElementById("clicker-game-board"),n=document.getElementById("clicker-score"),i=document.getElementById("clicker-timer"),r=document.getElementById("clicker-start-button"),d="ontouchstart"in window||0<navigator.maxTouchPoints;let s,l,m,c;d?(s=40,l=25,m=4,c=1500):(s=20,l=45,m=8,c=2500);let u=0,p=l,g=null,f=null;r&&(r.onclick=e)}function initSimonGame(){function e(){u=!1,m=[],i.textContent=`N√≠vel: ${c}`;const e=Math.floor(4*Math.random());l.push(e),a()}async function a(){await new Promise(e=>setTimeout(e,700));for(let e=0;e<l.length;e++)await o(l[e]),await new Promise(e=>setTimeout(e,200));u=!0,i.textContent="Sua vez!"}function o(e){return new Promise(a=>{const o=document.getElementById(`simon-pad-${e}`);o.classList.add("active");try{const a=document.getElementById(`simon-sound-${e}`);a&&(a.currentTime=0,a.play())}catch(e){console.warn("N\xE3o foi poss\xEDvel tocar o som do jogo.",e)}setTimeout(()=>{o.classList.remove("active"),a()},500)})}function t(a){if(u){const t=parseInt(a.target.dataset.index,10);o(t),m.push(t);const i=m.length-1;return m[i]===l[i]?void(m.length===l.length&&(c>=s?n(!0):(c++,u=!1,setTimeout(e,1e3)))):void n(!1)}}function n(e){u=!1,e?handleGameWin("Sequ\xEAncia de Cores"):(i.textContent="Errado! Tente de novo.",setTimeout(()=>{document.getElementById("simon-game-board").innerHTML=`
                    <div id="simon-info-display">N√≠vel: 1</div>
                    <div id="simon-pads-container">
                        <div class="simon-pad" id="simon-pad-0" data-index="0"></div>
                        <div class="simon-pad" id="simon-pad-1" data-index="1"></div>
                        <div class="simon-pad" id="simon-pad-2" data-index="2"></div>
                        <div class="simon-pad" id="simon-pad-3" data-index="3"></div>
                    </div>
                    <button id="simon-start-button">Iniciar</button>
                `,initSimonGame()},3e3))}const i=document.getElementById("simon-info-display"),r=document.getElementById("simon-start-button"),d=document.querySelectorAll(".simon-pad"),s=8;let l=[],m=[],c=1,u=!1;r.onclick=function(){r.style.display="none",l=[],c=1,e()},d.forEach(e=>e.addEventListener("click",t))}function initTicTacToeGame(){function e(e){e&&(I=e),f=I,h="X"===f?"O":"X",u.classList.add("hidden"),p.classList.remove("hidden"),m.classList.remove("hidden"),y=!0,m.textContent=`Sua vez de jogar (${f})`}function a(a){if(!b&&y){const e=parseInt(a.target.dataset.cellIndex);if(null===E[e]){i(e,f);const a=r();return a.isFinished?void d(a):void(y=!1,m.textContent=`Vez do rob√¥ (${h})...`,setTimeout(o,700))}}}function o(){if(!b){const e=t();i(e,h);const a=r();return a.isFinished?void d(a):void(y=!0,m.textContent=`Sua vez de jogar (${f})`)}}function t(){for(const e of v){const a=n(e.combo,h);if(-1!==a)return a}for(const e of v){const a=n(e.combo,f);if(-1!==a)return a}const e=E.map((e,a)=>null===e?a:null).filter(e=>null!==e);return 0<e.length?e[Math.floor(Math.random()*e.length)]:E.findIndex(e=>null===e)}function n(e,a){const o=e.map(e=>E[e]);return 2===o.filter(e=>e===a).length&&o.includes(null)?e[o.indexOf(null)]:-1}function i(e,a){E[e]=a;const o=p.querySelector(`[data-cell-index='${e}']`);o.classList.add(a.toLowerCase())}function r(){for(const e of v){const[o,a,t]=e.combo;if(E[o]&&E[o]===E[a]&&E[o]===E[t])return{isFinished:!0,winner:E[o],lineClass:e.class,winningCombo:e.combo}}return E.every(e=>null!==e)?{isFinished:!0,winner:"tie"}:{isFinished:!1}}function d(e){if(b=!0,e.winner===f)m.textContent="Voc\xEA venceu! \uD83C\uDF89",g.className=`winning-line ${e.lineClass}`,e.winningCombo.forEach(e=>document.querySelector(`[data-cell-index='${e}']`).classList.add("highlight")),handleGameWin("Jogo da Velha");else if(e.winner===h){m.textContent="O rob\xF4 venceu!",g.className=`winning-line ${e.lineClass}`,e.winningCombo.forEach(e=>document.querySelector(`[data-cell-index='${e}']`).classList.add("highlight"));let a=3;m.textContent=`O rob√¥ venceu! Nova rodada em ${a}...`;const o=setInterval(()=>{a--,0<a?m.textContent=`O rob√¥ venceu! Nova rodada em ${a}...`:(clearInterval(o),s())},1e3)}else m.textContent="Deu velha! Tente novamente.",c.classList.remove("hidden")}function s(){E.fill(null),b=!1,document.querySelectorAll(".tictactoe-cell").forEach(e=>{e.className="tictactoe-cell"}),g.className="winning-line",c.classList.add("hidden"),e(null)}const l=document.getElementById("tictactoe-board-wrapper"),m=document.getElementById("tictactoe-status"),c=document.getElementById("tictactoe-restart-button"),u=document.getElementById("tictactoe-symbol-selection"),p=document.getElementById("tictactoe-board"),g=document.getElementById("tictactoe-winning-line");let f="X",h="O";const v=[{combo:[0,1,2],class:"line-h-0"},{combo:[3,4,5],class:"line-h-1"},{combo:[6,7,8],class:"line-h-2"},{combo:[0,3,6],class:"line-v-0"},{combo:[1,4,7],class:"line-v-1"},{combo:[2,5,8],class:"line-v-2"},{combo:[0,4,8],class:"line-d-0"},{combo:[2,4,6],class:"line-d-1"}];let E=Array(9).fill(null),y=!0,b=!1,I=null;document.getElementById("select-X").onclick=()=>e("X"),document.getElementById("select-O").onclick=()=>e("O"),document.querySelectorAll(".tictactoe-cell").forEach(e=>e.addEventListener("click",a)),c.addEventListener("click",function(){I=null,E.fill(null),b=!1,y=!0,document.querySelectorAll(".tictactoe-cell").forEach(e=>{e.className="tictactoe-cell"}),g.className="winning-line",c.classList.add("hidden"),p.classList.add("hidden"),m.classList.add("hidden"),u.classList.remove("hidden")})}async function initForcaGame(e){function a(){E=!1,f=[],h=0,d.textContent="Adivinhe a palavra!",l.textContent=`Dica: ${g}`,u.forEach(e=>e.style.display="none"),c.style.display="none",o(),t()}function o(){s.innerHTML="";for(const e of p){const a=document.createElement("div");a.classList.add("letra-placeholder"),f.includes(e)&&(a.textContent=e),s.appendChild(a)}}function t(){m.innerHTML="";[["Q","W","E","R","T","Y","U","I","O","P"],["SPACER_HALF","A","S","D","F","G","H","J","K","L","SPACER_HALF"],["SPACER_FULL","SPACER_HALF","Z","X","C","V","B","N","M","SPACER_HALF","SPACER_FULL"]].forEach(e=>{const a=document.createElement("div");a.classList.add("teclado-row"),e.forEach(e=>{if(e.startsWith("SPACER_")){const o=document.createElement("div");"SPACER_HALF"===e?o.className="teclado-spacer-half":"SPACER_FULL"==e&&(o.className="teclado-spacer-full"),a.appendChild(o)}else{const o=document.createElement("button");o.classList.add("teclado-btn"),o.textContent=e,o.onclick=()=>n(e,o),a.appendChild(o)}}),m.appendChild(a)})}function n(e,a){E||(a.disabled=!0,p.includes(e)?(f.push(e),a.classList.add("correta")):(h++,a.classList.add("errada"),i()),o(),r())}function i(){for(let e=0;e<h;e++)u[e]&&(u[e].style.display="block")}function r(){const e=p.split("").every(e=>f.includes(e));return e?(E=!0,d.textContent="Voc\xEA venceu! \uD83C\uDF89",void setTimeout(()=>handleGameWin("Jogo da Forca"),1e3)):void(h>=v&&(E=!0,d.textContent=`Voc√™ perdeu! Tente novamente.`,c.style.display="block"))}const d=document.getElementById("forca-status"),s=document.getElementById("palavra-forca"),l=document.getElementById("dica-forca"),m=document.getElementById("teclado-forca"),c=document.getElementById("forca-restart-button"),u=document.querySelectorAll(".enforcado .parte-corpo");let p="",g="",f=[],h=0;const v=6;let E=!1;return e&&e.palavra?void(p=e.palavra.toUpperCase(),g=e.dica,c.onclick=()=>{initForcaGame(e)},a()):(d.textContent="Erro ao carregar a palavra da semana!",void(m.innerHTML=""))}function embaralharArray(e){for(let a=e.length-1;0<a;a--){const o=Math.floor(Math.random()*(a+1));[e[a],e[o]]=[e[o],e[a]]}return e}async function gerarQuizDaSemana(){const e=getSemanaAtual(),a=`semana_${e.numero}_${e.inicio.getFullYear()}`,o=doc(db,"vantagemSemanal",a),t=doc(db,"configuracoes","quizMemberQueue"),n=await getDoc(o);if(n.exists()&&n.data().quizDaSemana)return console.log("Quiz da semana j\xE1 existe. Carregando..."),n.data().quizDaSemana;console.log("Gerando novo quiz para a semana...");const i=await getDoc(t);let r=i.exists()?i.data().queue:[];4>r.length&&(r=todosMembros.filter(e=>"lider"!==e.papel).map(e=>e.nome),embaralharArray(r));const d=r.splice(0,4);await setDoc(t,{queue:r}),console.log("Otimiza\xE7\xE3o: Usando dados de membros em cache para gerar o quiz...");const s={};todosMembros.forEach(e=>{const{nome:a,...o}=e;(o.filme||o.sonho||o.musica||o.curiosidade)&&(s[a]=o)});const l=[],m=[{key:"filme",template:"Qual o filme favorito de {membro}?"},{key:"sonho",template:"Atualmente, qual o maior sonho de {membro}?"},{key:"musica",template:"Qual dessas \xE9 a m\xFAsica que {membro} gosta muito?"},{key:"curiosidade",template:"Qual dessas curiosidades pertence a {membro}?"}];for(let e=0;e<d.length;e++){const a=d[e],o=s[a],t=m[e];if(!o||!o[t.key]||""===o[t.key].trim()||7>o[t.key].length)continue;const n=o[t.key];let i=[];const r=Object.keys(s).filter(e=>e!==a);embaralharArray(r);for(const e of r){const a=s[e];if(a&&a[t.key]&&""!==a[t.key].trim()&&a[t.key]!==n&&7<=a[t.key].length&&i.push(a[t.key]),3<=i.length)break}if(3>i.length)return[];const c=embaralharArray([n,...i]);l.push({pergunta:t.template.replace("{membro}",`<strong>${a}</strong>`),alternativas:c,resposta:n})}return 4>l.length?(console.warn("N\xE3o foi poss\xEDvel gerar 4 perguntas v\xE1lidas. Tentando novamente na pr\xF3xima vez."),[]):(await setDoc(o,{quizDaSemana:l},{merge:!0}),l)}function initQuizGame(e){function a(){if(s>=e.length)return void(l===e.length?handleGameWin("Quiz dos \xC9picos"):(i.textContent=`Voc√™ acertou ${l} de ${e.length}. Tente de novo!`,i.style.color="#e74c3c",setTimeout(()=>loadAdvantageState(),3e3)));const a=e[s];r.textContent=`Pergunta ${s+1} de ${e.length}`,t.innerHTML=a.pergunta,n.innerHTML="",i.textContent="",d.style.width=`${100*(s/e.length)}%`,a.alternativas.forEach(e=>{const t=document.createElement("button");t.className="user-panel-btn",t.innerHTML=e,t.onclick=()=>o(t,e,a.resposta),n.appendChild(t)})}function o(o,t,r){n.querySelectorAll("button").forEach(e=>e.disabled=!0),t===r?(o.classList.add("correta"),i.textContent="Resposta Certa!",i.style.color="#2ecc71",l++,s++,d.style.width=`${100*(s/e.length)}%`,setTimeout(a,2e3)):(o.classList.add("errada"),i.textContent="Incorreto! O jogo ser\xE1 reiniciado...",i.style.color="#e74c3c",setTimeout(()=>{mostrarPopup("\uD83D\uDD04 Tente de Novo","O quiz foi reiniciado. Preste mais aten\xE7\xE3o!",4e3),isTestModeActive?startLeaderTestGame(currentTestGameIndex):loadAdvantageState()},2500))}const t=document.getElementById("quiz-question"),n=document.getElementById("quiz-alternatives"),i=document.getElementById("quiz-feedback"),r=document.getElementById("quiz-question-number"),d=document.getElementById("quiz-progress-bar");let s=0,l=0;a()}async function carregarInstrucoes(){try{const e=doc(db,"regras","manual"),a=await getDoc(e);if(a.exists()){const e=a.data(),o=document.querySelector("#secao-instrucoes .secao-conteudo");o.innerHTML=`
          <h1>üìú Manual de Funcionamento e Din√¢micas do Grupo </h1>
          <div class="info-bloco">
            <h2>Lista de Foco</h2>
            <p>${e.Foco.replace(/\n/g,"<br>")}</p>
          </div>
          <div class="info-bloco">
            <h2>Dia de Folga</h2>
            <p>${e.Folga.replace(/\n/g,"<br>")}</p>
          </div>
          <div class="info-bloco">
            <h2>Nomea√ß√£o de L√≠deres</h2>
            <p>${e.Lider.replace(/\n/g,"<br>")}</p>
          </div>
          <div class="info-bloco">
            <h2>Medalhas Individuais</h2>
            <p>${e.Medalhas.replace(/\n/g,"<br>")}</p>
          </div>
          <div class="info-bloco">
            <h2>Deserto do Focus Plant</h2>
            <p>${e.Deserto.replace(/\n/g,"<br>")}</p>
          </div>
        `,document.getElementById("secao-instrucoes").classList.remove("hidden")}else mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel encontrar o manual de instru\xE7\xF5es.",4e3)}catch(e){console.error("Erro ao carregar instru\xE7\xF5es:",e),mostrarPopup("\u274C Erro","Falha ao carregar as instru\xE7\xF5es.",4e3)}}async function carregarAdvertencias(){try{const e=doc(db,"regras","conduta"),a=await getDoc(e);if(a.exists()){const e=a.data(),o=document.querySelector("#secao-advertencias .secao-conteudo"),t=e=>`<ul>${e.split("\u2022").filter(e=>""!==e.trim()).map(e=>`<li>${e.trim()}</li>`).join("")}</ul>`;o.innerHTML=`
          <h1>‚ö†Ô∏è C√≥digo de Conduta e Advert√™ncias</h1>
          <div class="advertencia-card leve">
            <h2><span class="emoji">üü¢</span>Advert√™ncia Leve</h2>
            ${t(e.leve)}
          </div>
          <div class="advertencia-card media">
            <h2><span class="emoji">üü°</span>Advert√™ncia M√©dia</h2>
            ${t(e.media)}
          </div>
          <div class="advertencia-card grave">
            <h2><span class="emoji">üî¥</span>Advert√™ncia Grave</h2>
            ${t(e.grave)}
          </div>
          <div class="advertencia-card gravissima">
            <h2><span class="emoji">üü£</span>Advert√™ncia Grav√≠ssima</h2>
            ${t(e.gravissima)}
          </div>
          <div class="advertencia-card expulsao">
            <h2><span class="emoji">‚ö´</span>Expuls√£o</h2>
            ${t(e.expulsao)}
          </div>
        `,document.getElementById("secao-advertencias").classList.remove("hidden")}else mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel encontrar o c\xF3digo de conduta.",4e3)}catch(e){console.error("Erro ao carregar advert\xEAncias:",e),mostrarPopup("\u274C Erro","Falha ao carregar as advert\xEAncias.",4e3)}}function fecharSecoes(){document.getElementById("secao-instrucoes").classList.add("hidden"),document.getElementById("secao-advertencias").classList.add("hidden")}document.getElementById("btn-instrucoes").addEventListener("click",carregarInstrucoes),document.getElementById("btn-advertencias").addEventListener("click",carregarAdvertencias),document.querySelectorAll(".botao-fechar-secao").forEach(e=>{e.addEventListener("click",fecharSecoes)});async function calcularMembrosOciosos(){console.log("Calculando membros ociosos da semana...");const e=getSemanaAtual(new Date(new Date().setDate(new Date().getDate()-2))),a=e.inicio,o=e.fim,t=a.toISOString().slice(0,10),n=o.toISOString().slice(0,10),i=`semana_${e.numero}_${e.inicio.getFullYear()}`,r={};todosMembros.forEach(e=>{"lider"===e.papel||e.deFerias||(r[e.nome]=0)});try{const e=query(collection(dbEssencial,"presencas"),where("__name__",">=",t),where("__name__","<=",n)),a=await getDocs(e);a.forEach(e=>{const a=e.data();for(const[o,t]of Object.entries(a))t&&void 0!==r[o]&&r[o]++});const o=Object.entries(r).filter(([e,a])=>4>a).map(([e,a])=>({nome:e,contagem:a})),d=doc(db,"gerenciamentoSemanal",i);await setDoc(d,{ociosos:o,processado:!1}),console.log(`Encontrados ${o.length} membros ociosos. Dados salvos em ${i}.`)}catch(e){console.error("Erro ao calcular membros ociosos:",e)}}async function carregarEExibirMembrosOciosos(){const e=document.getElementById("secao-ociosos");if("lider"!==userRole)return void e.classList.add("hidden");e.classList.remove("hidden");const a=getHoje(),o=a.getDay(),t=document.getElementById("lista-ociosos"),n=document.getElementById("ociosos-descricao");if(t.innerHTML="<div class=\"ociosos-placeholder\">Calculando...</div>",0===o){const e=getSemanaAtual(new Date(new Date().setDate(a.getDate()-1))),o=`semana_${e.numero}_${e.inicio.getFullYear()}`,i=doc(db,"gerenciamentoSemanal",o);try{const e=await getDoc(i);if(!e.exists()||0===e.data().ociosos.length)return t.innerHTML="<div class=\"ociosos-placeholder\">Nenhum membro ficou abaixo da meta na semana passada.</div>",void(n.textContent="A\xE7\xF5es de final de semana: Nenhuma a\xE7\xE3o necess\xE1ria.");const a=e.data().ociosos;t.innerHTML="",n.textContent="A\xE7\xF5es de final de semana: Justifique os membros que apresentaram um motivo v\xE1lido ou expulse os que n\xE3o cumpriram a meta semanal.",a.forEach(e=>{const a=document.createElement("div");a.className="ocioso-item",a.innerHTML=`
                    <div class="ocioso-nome">${e.nome} (${e.contagem}/4 dias)</div>
                    <div class="ocioso-botoes">
                        <button class="ocioso-btn justificar" onclick="justificarMembro('${e.nome}', '${o}')">Justificar</button>
                        <button class="ocioso-btn expulsar" onclick="confirmarExpulsao('${e.nome}')">Expulsar</button>
                    </div>
                `,t.appendChild(a)})}catch(e){console.error("Erro ao carregar lista de ociosos de domingo:",e),t.innerHTML="<div class=\"ociosos-placeholder\">Erro ao carregar a lista.</div>"}}else{const e=getSemanaAtual(),a=formatarDataISO(e.inicio),i=getHojeISO();n.textContent=`An√°lise em tempo real: A lista abaixo mostra os membros que matematicamente n√£o podem mais atingir a meta de 4 dias de foco nesta semana.`;try{const e=query(collection(dbEssencial,"presencas"),where("__name__",">=",a),where("__name__","<=",i)),n=await getDocs(e),r={};todosMembros.forEach(e=>{"lider"!==e.papel&&(r[e.nome]=0)}),n.forEach(e=>{const a=e.data();for(const o in a)a[o]&&void 0!==r[o]&&r[o]++});const d=Object.keys(r).filter(e=>{const a=todosMembros.find(a=>a.nome===e);if(a&&a.deFerias)return!1;const t=r[e]||0;return 4-t>7-o}).map(e=>({nome:e,contagem:r[e]}));0===d.length?t.innerHTML="<div class=\"ociosos-placeholder\">At\xE9 o momento, todos os membros ainda podem atingir a meta.</div>":(t.innerHTML="",d.forEach(e=>{const a=document.createElement("div");a.className="ocioso-item",a.innerHTML=`<div class="ocioso-nome">${e.nome} (${e.contagem}/4 dias)</div>`,t.appendChild(a)}))}catch(e){console.error("Erro ao calcular ociosos em tempo real:",e),t.innerHTML="<div class=\"ociosos-placeholder\">Erro ao calcular a lista.</div>"}}}async function justificarMembro(e,a){if(!confirm(`Tem certeza que deseja justificar e remover '${e}' da lista de ociosos desta semana?`))return;const o=doc(db,"gerenciamentoSemanal",a);try{await runTransaction(db,async a=>{const t=await a.get(o);if(!t.exists())return;const n=t.data().ociosos,i=n.filter(a=>a.nome!==e);a.update(o,{ociosos:i})}),mostrarPopup("\u2705 Sucesso",`${e} foi justificado e removido da lista.`,4e3),await carregarEExibirMembrosOciosos()}catch(e){console.error("Erro ao justificar membro:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel processar a justiticativa.",4e3)}}function confirmarExpulsao(e){membroParaExpulsar=e,document.getElementById("member-to-expel-name").innerText=e,document.getElementById("confirm-expel-button").onclick=executarExpulsao,openModal("confirm-expel-modal")}async function executarExpulsao(){if(membroParaExpulsar){const e=membroParaExpulsar;console.log(`Iniciando processo de expuls√£o para: ${e}`);try{await deleteDoc(doc(db,"membros",e));try{await deleteDoc(doc(dbEssencial,"membros_essencial",e))}catch(a){console.warn("Erro ao limpar dados essenciais na expuls\xE3o (pode n\xE3o existir):",a)}await forcarAtualizacaoCacheGlobal(),await adicionarEventoAoFeed("geral","\uD83D\uDEB6\u200D\u2642\uFE0F Despedida no Grupo",`O membro <strong>${e}</strong> n√£o faz mais parte do nosso grupo. Desejamos sucesso em sua jornada!`,{nomeMembro:e}),mostrarPopup("\uD83D\uDDD1\uFE0F Membro Expulso",`${e} foi removido permanentemente do sistema.`,5e3),membroParaExpulsar=null,closeModal("confirm-expel-modal"),await refreshAppUI()}catch(a){console.error(`Erro ao expulsar ${e}:`,a),mostrarPopup("\u274C Falha Grave",`Ocorreu um erro ao tentar expulsar ${e}.`,5e3)}}}function atualizarPodioEquipes(){const e=[{id:"abelha",vitorias:rankingGeral.abelha,elemento:document.getElementById("podio-abelha")},{id:"joaninha",vitorias:rankingGeral.joaninha,elemento:document.getElementById("podio-joaninha")},{id:"vagalume",vitorias:rankingGeral.vagalume,elemento:document.getElementById("podio-vagalume")}];e.sort((e,a)=>a.vitorias-e.vitorias),e.forEach(e=>{e.elemento&&e.elemento.classList.remove("podium-1","podium-2","podium-3")});let a=1;for(let o=0;o<e.length;o++)0<o&&e[o].vitorias<e[o-1].vitorias&&(a=o+1),e[o].elemento&&e[o].elemento.classList.add(`podium-${a}`)}async function destacarVencedoraDomingo(){const e=getHoje();if(["abelha","joaninha","vagalume"].forEach(e=>{const a=document.getElementById(`podio-${e}`);a&&a.classList.remove("vencedora-destaque-domingo")}),0===e.getDay()){console.log("Domingo detectado: Buscando vencedora da semana para destaque...");try{const a=new Date(e);a.setDate(a.getDate()-1);const o=getSemanaAtual(a),t=`semana_${o.numero}_${o.inicio.getFullYear()}`,n=doc(db,"resultadosCompeticao",t),i=await getDoc(n);if(i.exists()){const e=i.data(),a=e.rankingEquipes||{},o=Object.keys(a).filter(e=>1===a[e]);o.forEach(e=>{const a=e.toLowerCase(),o=document.getElementById(`podio-${a}`);o&&o.classList.add("vencedora-destaque-domingo")})}}catch(e){console.error("Erro ao destacar vencedora de domingo:",e)}}}async function verificarEConcederPremiacaoDiaria(){const e=new Date(getHoje());e.setDate(e.getDate()-1);const a=formatarDataISO(e),o=doc(db,"appState","dailyPrizeState");try{await runTransaction(db,async e=>{const t=await e.get(o),n=t.exists()?t.data().lastAwardedDate:null;if(n===a)throw"ALREADY_PAID";t.exists()?e.update(o,{lastAwardedDate:a}):e.set(o,{lastAwardedDate:a})}),console.log(`[Premia√ß√£o] Iniciando pagamento do Top 5 para o dia ${a}...`),await premiarTop5ConsistenciaDiaria(),console.log(`[Premia√ß√£o] Pagamento conclu√≠do com sucesso.`)}catch(e){"ALREADY_PAID"===e?console.log(`[Premia√ß√£o] O pr√™mio de ${a} j√° foi concedido anteriormente. Ignorando.`):console.error("Erro ao verificar ou conceder a premia\xE7\xE3o di\xE1ria:",e)}}async function premiarTop5ConsistenciaDiaria(){console.log("\uD83C\uDFC6 Iniciando premia\xE7\xE3o di\xE1ria do Top 5 por consist\xEAncia...");const e={1:recompensasConfig.top5Diario_1||100,2:recompensasConfig.top5Diario_2||75,3:recompensasConfig.top5Diario_3||50,4:recompensasConfig.top5Diario_4||40,5:recompensasConfig.top5Diario_5||20},a=new Date;a.setDate(a.getDate()-1);try{const o=await obterRankingSemanal(a),t=o.filter(e=>0<e.pontos).slice(0,5);if(0===t.length)return void console.log("N\xE3o houve membros com foco registrado ontem para formar um Top 5. Premia\xE7\xE3o pulada.");const n=writeBatch(dbEssencial),i=[];t.forEach((a,o)=>{const t=o+1,r=e[t],d=doc(dbEssencial,"membros_essencial",a.nome);n.update(d,{moedas:increment(r)}),a.nome===currentUser&&mostrarPopupMoedas(r),i.push(`<strong>${t}¬∫ ${a.nome}</strong> (${a.pontos} dias | +${r}üí∞)`)}),await n.commit();const r=`Os mais focados da semana! Estes foram os √âpicos no topo do ranking semanal ao final de ontem:<br>${i.join("<br>")}`;await adicionarEventoAoFeed("geral","\uD83C\uDFC6 Top 5 Consistentes do Dia!",r,{}),console.log(`‚úÖ Premia√ß√£o di√°ria do Top 5 por consist√™ncia conclu√≠da para ${t.length} membros.`)}catch(e){console.error("Erro ao premiar o Top 5 di\xE1rio por consist\xEAncia:",e)}}function criarAvatarPadrao(){const e=["corpo_1","corpo_2","corpo_3","corpo_4","corpo_5"],a=e[Math.floor(Math.random()*e.length)];return{fundo:"fundo_1",corpo:a,roupa:"roupa_1_cor_1",cabelo:null,rosto:"rosto_1",acessorio:[],enfeite_de_parede:[]}}async function carregarDadosAvatar(){if(0===todosOsItensAvatar.length)try{const e=await getDocs(collection(db,"loja_avatar_itens"));e.forEach(e=>{todosOsItensAvatar.push({docId:e.id,...e.data()})})}catch(e){console.error("Erro ao carregar itens da loja de avatar:",e)}unsubscribeAvatarListener&&unsubscribeAvatarListener();const e=doc(db,"membros",currentUser);unsubscribeAvatarListener=onSnapshot(e,e=>{if(e.exists()){const a=e.data();inventarioAvatarCache=a.inventarioAvatar||[],console.log("Cache de invent\xE1rio do avatar atualizado em tempo real.")}})}function verificarPermissaoParaItem(e,a){if(!a)return!0;switch(a){case"coroa_lider_geral":return"lider"===e.papel;case"coroa_abelha":return"lider-equipe"===e.papel&&"abelha"===e.equipe;case"coroa_joaninha":return"lider-equipe"===e.papel&&"joaninha"===e.equipe;case"coroa_vagalume":return"lider-equipe"===e.papel&&"vagalume"===e.equipe;case"placa_abelha":return"abelha"===e.equipe;case"placa_joaninha":return"joaninha"===e.equipe;case"placa_vagalume":return"vagalume"===e.equipe;}const o=todosOsItensAvatar.find(e=>e.variacoes.some(e=>e.id===a));if(o&&o.raro){if("bandeira_rara_1"===a)return!0===e.podeComprarBandeiraRara;const o=e.permissoesItensRaros||[];return o.includes(a)}return!0}async function verificarEAtualizarAvatar(e){console.log(`Verificando permiss√µes de avatar para: ${e.nome}...`);const a=e.avatar||criarAvatarPadrao(),o=e.inventarioAvatar||[],t=JSON.parse(JSON.stringify(a));if(t.roupa&&!verificarPermissaoParaItem(e,t.roupa)&&(t.roupa=null),t.cabelo&&!verificarPermissaoParaItem(e,t.cabelo)&&(t.cabelo=null),Array.isArray(t.acessorio)&&(t.acessorio=t.acessorio.filter(a=>verificarPermissaoParaItem(e,a))),Array.isArray(t.enfeite_de_parede)&&(t.enfeite_de_parede=t.enfeite_de_parede.filter(a=>verificarPermissaoParaItem(e,a))),"lider"===e.papel||"lider-equipe"===e.papel){t.acessorio=Array.isArray(t.acessorio)?t.acessorio.filter(e=>"chapeu"!==encontrarSubcategoria(e)):[];let a=null;"lider"===e.papel?a="coroa_lider_geral":"abelha"===e.equipe?a="coroa_abelha":"joaninha"===e.equipe?a="coroa_joaninha":"vagalume"===e.equipe&&(a="coroa_vagalume"),a&&!t.acessorio.includes(a)&&t.acessorio.push(a),a&&!o.includes(a)&&o.push(a)}const n=o.filter(a=>verificarPermissaoParaItem(e,a)),i=JSON.stringify(a)!==JSON.stringify(t),r=o.length!==n.length;if(i||r){console.warn(`Permiss√µes de avatar inv√°lidas detectadas para ${e.nome}. Atualizando...`);const a=doc(db,"membros",e.nome);try{await updateDoc(a,{avatar:t,inventarioAvatar:n}),mostrarPopup("\u2139\uFE0F Avatar Atualizado","Detectamos que voc\xEA possu\xEDa itens que n\xE3o s\xE3o mais permitidos para sua conta. Seu avatar foi ajustado automaticamente.",8e3),console.log("Avatar e invent\xE1rio corrigidos com sucesso no Firestore.")}catch(e){console.error("Erro cr\xEDtico ao tentar corrigir o avatar do usu\xE1rio:",e)}}else console.log(`Permiss√µes de avatar para ${e.nome} est√£o corretas. Nenhuma a√ß√£o necess√°ria.`)}async function renderizarAvatar(e,a){try{const o=todosMembros.find(a=>a.nome===e);let t=criarAvatarPadrao();if(o&&o.avatar)t=o.avatar;else{const a=await getDoc(doc(db,"membros",e));a.exists()&&a.data().avatar&&(t=a.data().avatar)}renderizarAvatarConfig(a,t)}catch(o){console.error(`Erro ao renderizar avatar de ${e}:`,o),a.innerHTML=""}}function renderizarAvatarTemporario(e){renderizarAvatarConfig(e,avatarTemporario)}function encontrarUrlItemPorId(e){for(const a of todosOsItensAvatar)for(const o of a.variacoes)if(o.id===e)return o;return null}function encontrarSubcategoria(e){const a=todosOsItensAvatar.find(a=>a.variacoes.some(a=>a.id===e));return a?a.subcategoria:null}async function abrirEditorAvatar(){try{const e=await getDoc(doc(db,"membros",currentUser));e.exists()&&e.data().avatar?(avatarOriginal=JSON.parse(JSON.stringify(e.data().avatar)),avatarTemporario=JSON.parse(JSON.stringify(e.data().avatar))):(avatarOriginal=criarAvatarPadrao(),avatarTemporario=criarAvatarPadrao()),Array.isArray(avatarTemporario.enfeite_de_parede)||(avatarTemporario.enfeite_de_parede=[]),Array.isArray(avatarOriginal.enfeite_de_parede)||(avatarOriginal.enfeite_de_parede=[])}catch(e){console.error("Erro ao buscar avatar para edi\xE7\xE3o:",e),avatarTemporario=criarAvatarPadrao()}const e=document.getElementById("avatar-preview-editor");renderizarAvatarTemporario(e),e.onclick=abrirVisualizadorDoEditor,document.querySelector(".avatar-tab-btn[data-tab=\"inventario\"]").click(),openModal("avatar-editor-modal")}document.querySelectorAll("#estatisticas-banco-modal .avatar-tab-btn[data-tab-stats]").forEach(e=>{e.addEventListener("click",()=>{const a=e.dataset.tabStats;document.querySelectorAll("#estatisticas-banco-modal .avatar-tab-btn[data-tab-stats]").forEach(e=>e.classList.remove("ativo")),document.querySelectorAll("#estatisticas-banco-modal .avatar-tab-content").forEach(e=>e.classList.remove("ativo")),e.classList.add("ativo"),document.getElementById(`stats-tab-${a}`).classList.add("ativo")})});function popularInventario(){const e=document.getElementById("inventario-category-tabs"),a=document.getElementById("inventario-category-content");e.innerHTML="",a.innerHTML="";const o=todosOsItensAvatar.flatMap(e=>e.variacoes.map(a=>({...a,categoria:e.categoria,subcategoria:e.subcategoria||null,docId:e.docId,raro:e.raro||!1}))),t=o.filter(e=>inventarioAvatarCache.includes(e.id));["corpo","rosto","cabelo","roupa","acessorio","enfeite_de_parede","fundo"].forEach(o=>{let n;if(n="acessorio"===o?t.filter(e=>e.categoria===o&&!e.raro):"enfeite_de_parede"===o?t.filter(e=>e.categoria===o||e.raro):t.filter(e=>e.categoria===o),0<n.length){const t=document.createElement("button");t.className="avatar-category-tab",t.dataset.category=o,t.textContent=nomesCategorias[o],"enfeite_de_parede"===o&&t.classList.add("tab-raro"),e.appendChild(t);const i=document.createElement("div");if(i.id=`panel-inventario-${o}`,i.className="avatar-category-content-panel","acessorio"===o){const e=n.reduce((e,a)=>{const o=a.subcategoria||"outros";return e[o]||(e[o]=[]),e[o].push(a),e},{});for(const a in e){const o=document.createElement("h4");o.className="avatar-subcategory-header",o.textContent=nomesSubcategorias[a]||a.charAt(0).toUpperCase()+a.slice(1),i.appendChild(o);const t=document.createElement("div");t.className="avatar-item-grid",e[a].forEach(e=>{const a=document.createElement("div");if(a.className="avatar-item-card",avatarTemporario.acessorio?.includes(e.id)&&a.classList.add("selecionado"),"corpo"!==e.categoria&&"fundo"!==e.categoria){const o=avatarTemporario.corpo;if(o){const e=encontrarUrlItemPorId(o);e&&(a.innerHTML+=`<img src="${e.url}" alt="Tom de Pele" class="avatar-layer-preview">`)}if("acessorio"===e.categoria&&"chapeu"===e.subcategoria){const e=avatarTemporario.cabelo;if(e){const o=encontrarUrlItemPorId(e);o&&(a.innerHTML+=`<img src="${o.url}" alt="Cabelo" class="avatar-layer-preview">`)}}}a.innerHTML+=`<img src="${e.url}" alt="${e.nomeCor}" class="avatar-layer-preview">`,a.onclick=()=>selecionarItemInventario("acessorio",e.id,a),t.appendChild(a)}),i.appendChild(t)}}else{const e=document.createElement("div");if(e.className="avatar-item-grid","cabelo"===o||"roupa"===o){const a=document.createElement("div");a.className="avatar-item-card",a.innerHTML=`<div style="display:flex; justify-content:center; align-items:center; height:100%; font-size: 2rem; opacity: 0.5;">üö´</div>`,a.title="Remover item",avatarTemporario[o]||a.classList.add("selecionado"),a.onclick=()=>selecionarItemInventario(o,null,a),e.appendChild(a)}n.forEach(a=>{const t=document.createElement("div");t.className="avatar-item-card";const n=Array.isArray(avatarTemporario[o])?avatarTemporario[o].includes(a.id):avatarTemporario[o]===a.id;if(n&&t.classList.add("selecionado"),a.raro&&t.classList.add("raro-exclusivo"),"corpo"!==a.categoria&&"fundo"!==a.categoria){const e=avatarTemporario.corpo;if(e){const a=encontrarUrlItemPorId(e);a&&(t.innerHTML+=`<img src="${a.url}" alt="Tom de Pele" class="avatar-layer-preview">`)}if("acessorio"===a.categoria&&"chapeu"===a.subcategoria){const e=avatarTemporario.cabelo;if(e){const a=encontrarUrlItemPorId(e);a&&(t.innerHTML+=`<img src="${a.url}" alt="Cabelo" class="avatar-layer-preview">`)}}}t.innerHTML+=`<img src="${a.url}" alt="${a.nomeCor}" class="avatar-layer-preview">`,t.onclick=()=>selecionarItemInventario(o,a.id,t),e.appendChild(t)}),i.appendChild(e)}a.appendChild(i)}}),setupCategoryTabs("inventario")}function setupCategoryTabs(e){const a=document.getElementById(`${e}-category-tabs`),o=document.getElementById(`${e}-category-content`),t=a.querySelectorAll(".avatar-category-tab"),n=o.querySelectorAll(".avatar-category-content-panel");0===t.length||(t.forEach(a=>{a.addEventListener("click",()=>{t.forEach(e=>e.classList.remove("ativo")),n.forEach(e=>e.classList.remove("ativo")),a.classList.add("ativo");const o=a.dataset.category;document.getElementById(`panel-${e}-${o}`).classList.add("ativo")})}),t[0].click())}async function abrirModalExperimentar(e,a){const o=JSON.parse(JSON.stringify(avatarTemporario));if("acessorio"===e){Array.isArray(o.acessorio)||(o.acessorio=[]);const e=encontrarSubcategoria(a);o.acessorio=o.acessorio.filter(a=>encontrarSubcategoria(a)!==e),o.acessorio.push(a)}else"enfeite_de_parede"===e?(Array.isArray(o.enfeite_de_parede)||(o.enfeite_de_parede=[]),o.enfeite_de_parede.includes(a)||o.enfeite_de_parede.push(a)):o[e]=a;const t=document.getElementById("avatar-try-on-container");openModal("avatar-try-on-modal"),renderizarAvatarConfig(t,o)}function popularLojaAvatar(){const e=document.getElementById("loja-category-tabs"),a=document.getElementById("loja-category-content");e.innerHTML="",a.innerHTML="";["corpo","rosto","cabelo","roupa","acessorio","enfeite_de_parede","fundo"].forEach(o=>{let t;if(t="acessorio"===o?todosOsItensAvatar.filter(e=>e.categoria===o&&!e.raro):"enfeite_de_parede"===o?todosOsItensAvatar.filter(e=>e.categoria===o||e.raro):todosOsItensAvatar.filter(e=>e.categoria===o),0<t.length){const n=document.createElement("button");n.className="avatar-category-tab",n.dataset.category=o,n.textContent=nomesCategorias[o],"enfeite_de_parede"===o&&n.classList.add("tab-raro"),e.appendChild(n);const i=document.createElement("div");if(i.id=`panel-loja-${o}`,i.className="avatar-category-content-panel","acessorio"===o){const e=t.reduce((e,a)=>{const o=a.subcategoria||"outros";return e[o]||(e[o]=[]),e[o].push(a),e},{});for(const a in e){const o=document.createElement("h4");o.className="avatar-subcategory-header",o.textContent=nomesSubcategorias[a]||a.charAt(0).toUpperCase()+a.slice(1),i.appendChild(o);const t=document.createElement("div");t.className="avatar-item-grid",e[a].forEach(e=>{const a=e.variacoes[Math.floor(Math.random()*e.variacoes.length)],o=document.createElement("div");if(o.className="avatar-item-card","corpo"!==e.categoria&&"fundo"!==e.categoria){const a=avatarTemporario.corpo;if(a){const e=encontrarUrlItemPorId(a);e&&(o.innerHTML+=`<img src="${e.url}" alt="Tom de Pele" class="avatar-layer-preview">`)}if("acessorio"===e.categoria&&"chapeu"===e.subcategoria){const e=avatarTemporario.cabelo;if(e){const a=encontrarUrlItemPorId(e);a&&(o.innerHTML+=`<img src="${a.url}" alt="Cabelo" class="avatar-layer-preview">`)}}}o.innerHTML+=`<img src="${a.url}" alt="${e.nome}" class="avatar-layer-preview">`,o.onclick=()=>abrirModalVariacoes(e),t.appendChild(o)}),i.appendChild(t)}}else{const e=document.createElement("div");e.className="avatar-item-grid",t.forEach(a=>{const o=a.variacoes[Math.floor(Math.random()*a.variacoes.length)],t=document.createElement("div");if(t.className="avatar-item-card",a.raro&&t.classList.add("raro-exclusivo"),"corpo"!==a.categoria&&"fundo"!==a.categoria){const e=avatarTemporario.corpo;if(e){const a=encontrarUrlItemPorId(e);a&&(t.innerHTML+=`<img src="${a.url}" alt="Tom de Pele" class="avatar-layer-preview">`)}if("acessorio"===a.categoria&&"chapeu"===a.subcategoria){const e=avatarTemporario.cabelo;if(e){const a=encontrarUrlItemPorId(e);a&&(t.innerHTML+=`<img src="${a.url}" alt="Cabelo" class="avatar-layer-preview">`)}}}t.innerHTML+=`<img src="${o.url}" alt="${a.nome}" class="avatar-layer-preview">`,t.onclick=()=>abrirModalVariacoes(a),e.appendChild(t)}),i.appendChild(e)}a.appendChild(i)}}),setupCategoryTabs("loja")}function experimentarItemLoja(e,a,o){avatarTemporario[e]=a;const t=document.getElementById("avatar-preview-editor");renderizarAvatarTemporario(t);const n=o.parentElement;n.querySelectorAll(".variation-card").forEach(e=>e.classList.remove("selecionado")),o.classList.add("selecionado")}async function selecionarItemInventario(e,a,o){if("acessorio"===e){if(Array.isArray(avatarTemporario.acessorio)||(avatarTemporario.acessorio=[]),null===a){avatarTemporario.acessorio=[];const e=document.querySelectorAll("#avatar-tab-inventario .avatar-item-card");e.forEach(e=>e.classList.remove("selecionado")),o.classList.add("selecionado")}else{const e=encontrarSubcategoria(a);let t=null;for(const a of avatarTemporario.acessorio)if(encontrarSubcategoria(a)===e){t=a;break}if(avatarTemporario.acessorio.includes(a))avatarTemporario.acessorio=avatarTemporario.acessorio.filter(e=>e!==a),o.classList.remove("selecionado");else if(t){avatarTemporario.acessorio=avatarTemporario.acessorio.filter(e=>e!==t),avatarTemporario.acessorio.push(a);const e=o.parentElement;e.querySelectorAll(".avatar-item-card").forEach(e=>{e.onclick.toString().includes(t)&&e.classList.remove("selecionado")}),o.classList.add("selecionado")}else avatarTemporario.acessorio.push(a),o.classList.add("selecionado");const n=o.parentElement,i=Array.from(n.querySelectorAll(".avatar-item-card")).find(e=>e.onclick.toString().includes("null"));i&&i.classList.remove("selecionado")}}else if("enfeite_de_parede"===e){Array.isArray(avatarTemporario.enfeite_de_parede)||(avatarTemporario.enfeite_de_parede=[]);const e=avatarTemporario.enfeite_de_parede.indexOf(a);-1<e?(avatarTemporario.enfeite_de_parede.splice(e,1),o.classList.remove("selecionado")):(avatarTemporario.enfeite_de_parede.push(a),o.classList.add("selecionado"))}else{avatarTemporario[e]=a;const t=o.parentElement;t.querySelectorAll(".avatar-item-card").forEach(e=>e.classList.remove("selecionado")),o.classList.add("selecionado")}const t=document.getElementById("avatar-preview-editor");renderizarAvatarTemporario(t)}document.getElementById("avatar-save-btn").onclick=async function(){try{await updateDoc(doc(db,"membros",currentUser),{avatar:avatarTemporario}),await forcarAtualizacaoCacheGlobal();const e=todosMembros.findIndex(e=>e.nome===currentUser);-1!==e&&(todosMembros[e].avatar=JSON.parse(JSON.stringify(avatarTemporario))),mostrarPopup("\u2705 Sucesso!","Seu avatar foi salvo com sucesso.",4e3),closeModal("avatar-editor-modal");const a=document.getElementById("avatar-display-pessoal");renderizarAvatarConfig(a,avatarTemporario)}catch(e){console.error("Erro ao salvar avatar:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel salvar seu avatar.",4e3)}};async function abrirModalVariacoes(e){const a=document.getElementById("variations-grid");document.getElementById("variations-item-name").textContent=e.nome,a.innerHTML="<p>Carregando...</p>";const o=document.getElementById("variations-item-description");e.raro&&e.variacoes[0]&&e.variacoes[0].descricao?(o.innerHTML=`<strong>Como obter:</strong> ${e.variacoes[0].descricao}`,o.classList.remove("hidden")):o.classList.add("hidden"),openModal("item-variations-modal");try{const o=todosMembros.find(e=>e.nome===currentUser);if(!o)throw"Membro n\xE3o encontrado no cache.";const t=o.moedas||0,n=o.inventarioAvatar||[];a.innerHTML="";for(const o of e.variacoes){const i=n.includes(o.id),r=t>=o.preco,d=await verificarPermissaoCompra(o.id),s=document.createElement("div");s.className="variation-card",e.raro&&s.classList.add("raro-exclusivo");const l=document.createElement("div");if(l.className="variation-image-container","corpo"!==e.categoria&&"fundo"!==e.categoria){const a=avatarTemporario.corpo;if(a){const e=encontrarUrlItemPorId(a);e&&(l.innerHTML+=`<img src="${e.url}" alt="Tom de Pele" class="avatar-layer-preview">`)}if("acessorio"===e.categoria&&"chapeu"===e.subcategoria){const e=avatarTemporario.cabelo;if(e){const a=encontrarUrlItemPorId(e);a&&(l.innerHTML+=`<img src="${a.url}" alt="Cabelo" class="avatar-layer-preview">`)}}}const m=document.createElement("img");m.src=o.url,m.alt=o.nomeCor,m.className="avatar-layer-preview",l.appendChild(m),s.appendChild(l);const c=document.createElement("div");c.className="variation-info";const u=document.createElement("div");u.innerHTML=`<div>${o.nomeCor}</div><div class="item-preco">${i?"Adquirido":`üí∞ ${o.preco}`}</div>`,c.appendChild(u);const p=document.createElement("div");if(p.style.marginTop="10px",i){const a=Array.isArray(avatarTemporario[e.categoria])?avatarTemporario[e.categoria].includes(o.id):avatarTemporario[e.categoria]===o.id,t=document.createElement("button");t.className="painel-btn btn-adicionar",t.textContent=a?"Equipado":"Equipar",t.disabled=a,a||(t.onclick=()=>{selecionarItemInventario(e.categoria,o.id,s),closeModal("item-variations-modal")}),p.appendChild(t)}else if(!d){const e=document.createElement("button");e.className="painel-btn btn-adicionar",e.textContent="\uD83D\uDD12",e.title="Item exclusivo",e.disabled=!0,p.appendChild(e)}else{const a=document.createElement("div");a.className="variation-button-container",a.style.display="flex",a.style.gap="8px",a.style.justifyContent="center";const t=document.createElement("button");t.className="painel-btn",t.style.backgroundColor="#3498db",t.textContent="Experimentar",t.onclick=()=>abrirModalExperimentar(e.categoria,o.id),a.appendChild(t);const n=document.createElement("button");n.textContent=r?"Comprar":"Insuficiente",r?(n.className="painel-btn btn-adicionar",n.onclick=()=>confirmarCompraAvatar(o.id,o.preco)):(n.className="painel-btn btn-remover",n.disabled=!0,n.title="Moedas insuficientes"),a.appendChild(n),p.appendChild(a)}c.appendChild(p),s.appendChild(c),a.appendChild(s)}}catch(e){console.error("Erro ao abrir modal de varia\xE7\xF5es:",e),a.innerHTML="<p>Ocorreu um erro ao carregar os itens.</p>"}}window.confirmarCompraAvatar=function(e,a){const o=encontrarUrlItemPorId(e);document.getElementById("confirm-purchase-text").innerHTML=`Voc√™ deseja comprar <strong>${o.nomeCor}</strong> por <strong>üí∞ ${a} moedas</strong>?`,document.getElementById("confirm-purchase-btn").onclick=()=>executarCompraAvatar(e,a),openModal("confirm-avatar-purchase-modal")};async function executarCompraAvatar(e,a){closeModal("confirm-avatar-purchase-modal");doc(db,"membros",currentUser);try{const o=doc(dbEssencial,"membros_essencial",currentUser),t=await getDoc(o),n=t.exists()?t.data().moedas||0:0;if(n<a)throw"Moedas insuficientes.";await updateDoc(o,{moedas:increment(-a)});const i=doc(db,"membros",currentUser);await updateDoc(i,{inventarioAvatar:arrayUnion(e)}),inventarioAvatarCache.push(e),mostrarPopup("\uD83C\uDF89 Compra Realizada!","O item foi adicionado ao seu invent\xE1rio.",4e3),closeModal("item-variations-modal"),popularLojaAvatar()}catch(e){console.error("Erro na compra do avatar:",e),mostrarPopup("\u274C Falha na Compra",e.toString(),4e3)}}document.getElementById("avatar-gallery-btn").onclick=async function(){const e=document.getElementById("gallery-grid-container");e.innerHTML="<p>Carregando avatares...</p>",openModal("avatar-gallery-modal");try{const a=await getDocs(collection(db,"membros"));e.innerHTML="",await Promise.all(a.docs.map(async a=>{const o=a.id,t=document.createElement("div");t.className="gallery-avatar-item",t.onclick=()=>abrirVisualizadorDeAvatar(o);const n=document.createElement("div");n.className="gallery-avatar-container";const i=document.createElement("div");i.className="gallery-avatar-nome",i.textContent=o,t.appendChild(n),t.appendChild(i),e.appendChild(t),await renderizarAvatar(o,n)}))}catch(a){console.error("Erro ao carregar galeria:",a),e.innerHTML="<p>Erro ao carregar a galeria.</p>"}};function avatarTemAlteracoesNaoSalvas(){return!!(avatarOriginal&&avatarTemporario)&&JSON.stringify(avatarOriginal)!==JSON.stringify(avatarTemporario)}window.tentarFecharEditorAvatar=function(){avatarTemAlteracoesNaoSalvas()?showConfirmationPopup("\u26A0\uFE0F Altera\xE7\xF5es n\xE3o Salvas","Voc\xEA tem altera\xE7\xF5es n\xE3o salvas. Deseja sair mesmo assim?",()=>{closeModal("avatar-editor-modal")}):closeModal("avatar-editor-modal")};async function abrirVisualizadorDeAvatar(e){const a=document.getElementById("avatar-viewer-container"),o=document.getElementById("avatar-viewer-nome");a.innerHTML="<p style=\"text-align: center; margin-top: 50%;\">Carregando...</p>",o.textContent=e,openModal("avatar-viewer-modal"),await renderizarAvatar(e,a)}function abrirVisualizadorDoEditor(){const e=document.getElementById("editor-avatar-viewer-container");renderizarAvatarTemporario(e),openModal("editor-avatar-viewer-modal")}async function verificarPermissaoCompra(e){if(!currentUser)return!1;const a=await getDoc(doc(db,"membros",currentUser));if(!a.exists())return!1;const o=a.data();switch(e){case"coroa_lider_geral":return"lider"===o.papel;case"coroa_abelha":return"lider-equipe"===o.papel&&"abelha"===o.equipe;case"coroa_joaninha":return"lider-equipe"===o.papel&&"joaninha"===o.equipe;case"coroa_vagalume":return"lider-equipe"===o.papel&&"vagalume"===o.equipe;case"placa_abelha":return"abelha"===o.equipe;case"placa_joaninha":return"joaninha"===o.equipe;case"placa_vagalume":return"vagalume"===o.equipe;default:const a=todosOsItensAvatar.find(a=>a.variacoes.some(a=>a.id===e));if(a&&a.raro){if("bandeira_rara_1"===e)return!0===o.podeComprarBandeiraRara;const a=o.permissoesItensRaros||[];return a.includes(e)}return!0;}}function renderizarAvatarConfig(e,a){if(e.innerHTML="",!!a){const o=["fundo","corpo","roupa","cabelo","rosto","acessorio","enfeite_de_parede"];for(const t of o){const o=a[t];if(Array.isArray(o)){for(const a of o)if(a){const o=encontrarUrlItemPorId(a);if(o){const n=document.createElement("img");n.src=o.url;const i="acessorio"===t?encontrarSubcategoria(a):"";n.className=`avatar-layer ${t} ${i||""}`,e.appendChild(n)}}}else if(o){const a=encontrarUrlItemPorId(o);if(a){const o=document.createElement("img");o.src=a.url,o.className=`avatar-layer ${t}`,e.appendChild(o)}}}}}function abrirModalAdicionarItemAvatar(){resetarFormularioItemAvatar(),openModal("add-avatar-item-modal")}async function popularListaMembrosPermissao(){const e=document.getElementById("add-item-membros-lista");if(e){e.innerHTML="<p>Carregando membros...</p>";const a=[...todosMembros].sort((e,a)=>e.nome.localeCompare(a.nome));e.innerHTML="",a.forEach(a=>{const o=document.createElement("div");o.style.marginBottom="8px",o.innerHTML=`
      <input type="checkbox" id="perm_${a.nome}" value="${a.nome}" class="membro-permissao-check">
      <label for="perm_${a.nome}" style="margin-left: 8px;">${a.nome}</label>
    `,e.appendChild(o)})}}async function toggleIdiomaMembro(e,a){try{const o=doc(db,"membros",e);await updateDoc(o,{idioma:a});const t=todosMembros.findIndex(a=>a.nome===e);-1!==t&&(todosMembros[t].idioma=a),mostrarPopup("\u2705 Atualizado",`Idioma de ${e} definido como: ${a}`,2e3)}catch(a){console.error(`Erro ao atualizar idioma para ${e}:`,a),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel salvar a altera\xE7\xE3o.",4e3)}}function popularPainelIdiomas(){const e=document.getElementById("idiomas-lista-membros");if(e){e.innerHTML="";const a=[...todosMembros].sort((e,a)=>e.nome.localeCompare(a.nome));a.forEach(a=>{const o=document.createElement("div");o.className="ferias-item",o.style.justifyContent="space-between";let t=a.idioma||"pt-BR";o.innerHTML=`
      <label for="idioma_${a.nome}" style="font-weight: 500;">${a.nome}</label>
      <select id="idioma_${a.nome}" class="painel-input" style="width: 140px; padding: 5px;">
        <option value="pt-BR" ${"pt-BR"===t?"selected":""}>üáßüá∑ Portugu√™s</option>
        <option value="es" ${"es"===t?"selected":""}>üá™üá∏ Espa√±ol</option>
        <option value="en" ${"en"===t?"selected":""}>üá∫üá∏ English</option>
      </select>
    `,o.querySelector("select").addEventListener("change",o=>{toggleIdiomaMembro(a.nome,o.target.value)}),e.appendChild(o)})}}function resetarFormularioItemAvatar(){document.getElementById("add-item-nome").value="",document.getElementById("add-item-categoria").value="",document.getElementById("add-item-raro").checked=!1,document.getElementById("add-item-raro-descricao").value="",document.getElementById("add-item-raro-descricao-container").classList.add("hidden"),document.getElementById("add-item-variations-container").innerHTML="",adicionarCampoVariacao()}function adicionarCampoVariacao(){const e=document.getElementById("add-item-variations-container"),a=document.createElement("div");a.style.display="grid",a.style.gridTemplateColumns="2fr 3fr 1fr auto",a.style.gap="10px",a.style.alignItems="center",a.innerHTML=`
    <input type="text" class="painel-input variation-nomeCor" placeholder="Nome da Cor (Ex: Azul)">
    <input type="text" class="painel-input variation-url" placeholder="Link da Imagem (URL)">
    <input type="number" class="painel-input variation-preco" placeholder="Pre√ßo üí∞">
    <button class="painel-btn btn-remover" onclick="this.parentElement.remove()">X</button>
  `,e.appendChild(a)}window.adicionarCampoVariacao=adicionarCampoVariacao;async function salvarItemAvatar(){const e=document.getElementById("add-item-nome").value.trim(),a=document.getElementById("add-item-categoria").value,o=document.getElementById("add-item-raro").checked,t=document.getElementById("add-item-raro-descricao").value.trim();if(!e||!a)return void mostrarPopup("\u274C Erro de Valida\xE7\xE3o","O Nome e a Categoria do item s\xE3o obrigat\xF3rios.",4e3);if(o&&!t)return void mostrarPopup("\u274C Erro de Valida\xE7\xE3o","Se o item \xE9 raro, voc\xEA deve fornecer uma descri\xE7\xE3o de como obt\xEA-lo.",5e3);let n=null;if("acessorio"===a&&(n=document.getElementById("add-item-subcategoria").value,!n))return void mostrarPopup("\u274C Erro de Valida\xE7\xE3o","Voc\xEA deve selecionar uma subcategoria para um acess\xF3rio.",4e3);const i=document.getElementById("add-item-variations-container"),r=i.children;if(0===r.length)return void mostrarPopup("\u274C Erro de Valida\xE7\xE3o","Voc\xEA deve adicionar pelo menos uma varia\xE7\xE3o de cor para o item.",4e3);const d=[];for(const n of r){const i=n.querySelector(".variation-nomeCor").value.trim(),r=n.querySelector(".variation-url").value.trim(),s=parseInt(n.querySelector(".variation-preco").value,10);if(!i||!r||isNaN(s))return void mostrarPopup("\u274C Erro de Valida\xE7\xE3o","Todos os campos de todas as varia\xE7\xF5es (Nome da Cor, URL e Pre\xE7o) devem ser preenchidos corretamente.",5e3);const l=e.toLowerCase().replace(/[^a-z0-9]/g,"_")+"_"+i.toLowerCase().replace(/[^a-z0-9]/g,"_");d.push({id:`${a}_${l}`,nomeCor:i,url:r,preco:s,descricao:o?t:""})}const s={nome:e,categoria:a,subcategoria:n,raro:o,variacoes:d};try{const a=e.toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_]/g,""),t=doc(db,"loja_avatar_itens",a),n=writeBatch(db);if(n.set(t,s),o){const e=document.querySelectorAll(".membro-permissao-check:checked");if(0<e.length){const a=d[0].id;e.forEach(e=>{const o=e.value,t=doc(db,"membros",o);n.update(t,{permissoesItensRaros:arrayUnion(a)})})}}await n.commit(),todosOsItensAvatar.push({docId:a,...s}),mostrarPopup("\u2705 Sucesso!",`O item "${e}" foi adicionado √† loja com sucesso!`,5e3),closeModal("add-avatar-item-modal")}catch(e){console.error("Erro ao salvar novo item de avatar:",e),mostrarPopup("\uD83D\uDD25 Erro Cr\xEDtico","N\xE3o foi poss\xEDvel salvar o item no banco de dados. Verifique o console.",5e3)}}function loadCSS(e){return new Promise((a,o)=>{const t=document.createElement("link");t.rel="stylesheet",t.href=e,t.onload=()=>a(),t.onerror=()=>o(new Error(`Falha ao carregar o CSS: ${e}`)),document.head.appendChild(t)})}async function abrirModalEnvioMoedas(){if(!currentUser)return;const e=getHojeISO(),a=document.getElementById("envio-moedas-lista");if(!a)return console.error("Erro Cr\xEDtico: O container #envio-moedas-lista n\xE3o foi encontrado no HTML."),void mostrarPopup("\u274C Erro de Interface","N\xE3o foi poss\xEDvel abrir o painel de envio.",4e3);a.innerHTML="<div class=\"ociosos-placeholder\">Carregando...</div>",openModal("envio-moedas-modal");try{const o=doc(db,"enviosDiarios",`${currentUser}_${e}`),t=await getDoc(o),n=t.exists()?t.data().enviadoPara:[];let i=[];if(i="lider"===userRole?todosMembros.filter(e=>"lider-equipe"===e.papel):"lider-equipe"===userRole?todosMembros.filter(e=>e.equipe===userTeam&&e.nome!==currentUser||"lider"===e.papel):todosMembros.filter(e=>e.equipe===userTeam&&e.nome!==currentUser),0===i.length)return void(a.innerHTML="<div class=\"ociosos-placeholder\">Voc\xEA n\xE3o tem colegas de equipe para enviar moedas.</div>");a.innerHTML="",i.forEach(e=>{const o=e.nome,t=n.includes(o),i=document.createElement("div");i.className="envio-membro-item",i.innerHTML=`
        <input type="checkbox" id="enviar-para-${o}" value="${o}" ${t?"checked disabled":""}>
        <label for="enviar-para-${o}">${o}</label>
        ${t?"<span class=\"status-enviado\">\u2714 Enviado</span>":""}
      `,a.appendChild(i)})}catch(e){console.error("Erro ao abrir modal de envio de moedas:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel carregar a lista de membros.",4e3),closeModal("envio-moedas-modal")}}window.abrirModalEnvioMoedas=abrirModalEnvioMoedas;async function executarEnvioMoedas(e){if(enviandoMoedas)return void console.warn("Uma opera\xE7\xE3o de envio de moedas j\xE1 est\xE1 em andamento. Aguarde.");enviandoMoedas=!0;const a="envio-moedas-modal"===e?"envio-moedas-lista":"envio-moedas-lista-popup",o=document.querySelectorAll(`#${a} input[type="checkbox"]:checked:not(:disabled)`);try{if(0===o.length)return void mostrarPopup("\uD83E\uDD14 Selecione","Voc\xEA precisa selecionar pelo menos um colega para enviar moedas.",4e3);const a=Array.from(o).map(e=>e.value),t=getHojeISO(),n=doc(db,"enviosDiarios",`${currentUser}_${t}`),i=writeBatch(db),r=writeBatch(dbEssencial);a.forEach(e=>{const a=doc(dbEssencial,"membros_essencial",e);r.set(a,{moedas:increment(100)},{merge:!0});const o=doc(collection(db,"notificacoes"));i.set(o,{destinatarioId:e,remetenteNome:currentUser,tipo:"moedas",conteudo:"\uD83C\uDF81",acao:`enviou 100 üí∞ moedas para voc√™ como presente di√°rio!`,lida:!1,timestamp:new Date})}),i.set(n,{enviadoPara:a},{merge:!0}),await Promise.all([i.commit(),r.commit()]),closeModal(e),mostrarPopup("\u2705 Sucesso!",`${100*a.length} moedas foram enviadas com sucesso!`,5e3),setTimeout(()=>{verificarNudgesDiarios(!1)},500)}catch(e){console.error("Erro ao enviar moedas:",e),mostrarPopup("\u274C Erro","Ocorreu uma falha ao enviar as moedas.",5e3)}finally{enviandoMoedas=!1}}async function verificarPopupEnvioDiario(){if(!currentUser)return;if(!usuarioAceitaPopups())return;const e=document.getElementById("envio-moedas-modal");if(enviandoMoedas||e&&e.classList.contains("show"))return void console.log("Fluxo manual de moedas em andamento. Cancelando popup autom\xE1tico.");const a=getHojeISO(),o=doc(db,"enviosDiarios",`${currentUser}_${a}`);try{const e=await getDoc(o);if(e.exists())return void console.log("\u2705 [Envio Moedas] Tarefa j\xE1 conclu\xEDda hoje. Popup n\xE3o ser\xE1 exibido.");let a=[];if(a="lider"===userRole?todosMembros.filter(e=>"lider-equipe"===e.papel):"lider-equipe"===userRole?todosMembros.filter(e=>e.equipe===userTeam&&e.nome!==currentUser||"lider"===e.papel):todosMembros.filter(e=>e.equipe===userTeam&&e.nome!==currentUser),0===a.length)return;const t=document.getElementById("envio-moedas-lista-popup");if(t){t.innerHTML="",a.forEach(e=>{const a=document.createElement("div");a.className="envio-membro-item",a.innerHTML=`
            <input type="checkbox" id="popup-enviar-para-${e.nome}" value="${e.nome}" checked>
            <label for="popup-enviar-para-${e.nome}">${e.nome}</label>
          `,t.appendChild(a)});const e=()=>{const a=document.getElementById("custom-card-popup"),o=a&&a.classList.contains("show");return o?void setTimeout(e,5e3):void(console.log("\u2705 [Envio Moedas] Abrindo popup priorit\xE1rio..."),openModal("popup-envio-diario-moedas"))};e()}}catch(e){console.error("Erro ao verificar popup de envio di\xE1rio:",e)}}async function exibirPopupPoderesAtivos(){if(!usuarioAceitaPopups())return;let e="",a="",o="";try{const o=getSemanaAtual(),t=`semana_${o.numero}_${o.inicio.getFullYear()}`,n=doc(db,"vantagemSemanal",t),i=await getDoc(n);if(i.exists()){const o=i.data(),t=o.adicoesPoderes||{},n=o.deducoesPoderes||{};t[userTeam]&&t[userTeam].forEach(a=>{e+=`<li>üíñ <strong>${a.nomePoder}:</strong> B√¥nus de +${a.valor} pontos garantido na m√©dia semanal.</li>`}),n[userTeam]&&n[userTeam].forEach(e=>{const o="vagalume"===e.por?"Vaga-lume":e.por.charAt(0).toUpperCase()+e.por.slice(1);a+=`<li>üíÄ <strong>${e.nomePoder}:</strong> Penalidade de ${e.valor} pontos aplicada pela Equipe ${o}.</li>`}),Object.keys(n).forEach(a=>{const o=n[a]||[];o.forEach(o=>{if(o.por===userTeam){const t="vagalume"===a?"Vaga-lume":a.charAt(0).toUpperCase()+a.slice(1);e+=`<li>üíÄ <strong>${o.nomePoder}:</strong> Voc√™s retiraram pontos da Equipe ${t}.</li>`}})})}}catch(a){console.error("Erro ao carregar poderes de pontua\xE7\xE3o para o popup:",a)}if(statusPoderesAtivos.forEach(t=>{const n=t.expiraEm.toDate().toLocaleString("pt-BR",{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit"});if("amuleto_protecao"===t.poderId&&t.equipeAlvo===userTeam)e+=`<li>üõ°Ô∏è <strong>Imunidade:</strong> Sua equipe est√° protegida contra maldi√ß√µes at√© ${n}.</li>`;else if(t.equipeAlvo===userTeam&&("praga_kriptonita"===t.poderId||"runa_soft_block"===t.poderId)){const e="vagalume"===t.usadoPor?"Vaga-lume":t.usadoPor.charAt(0).toUpperCase()+t.usadoPor.slice(1);a+=`<li>ü§¢ <strong>${t.nomePoder}:</strong> Sua equipe est√° sofrendo este efeito (usado pela Equipe ${e}) at√© ${n}.</li>`}else if(t.equipeAlvo===userTeam&&"amuleto_falha"===t.poderId){const a="vagalume"===t.usadoPor?"Vaga-lume":t.usadoPor.charAt(0).toUpperCase()+t.usadoPor.slice(1);e+=`<li>üõ°Ô∏è <strong>Defesa Bem-Sucedida!</strong> Seu Amuleto bloqueou a maldi√ß√£o <strong>${t.nomePoder}</strong> vinda da Equipe ${a}.</li>`}else if(t.usadoPor===userTeam)if(t.equipeAlvo!==userTeam&&("praga_kriptonita"===t.poderId||"runa_soft_block"===t.poderId)){const a="vagalume"===t.equipeAlvo?"Vaga-lume":t.equipeAlvo.charAt(0).toUpperCase()+t.equipeAlvo.slice(1);e+=`<li>‚öîÔ∏è <strong>${t.nomePoder}:</strong> Sua equipe est√° afetando a Equipe ${a} at√© ${n}.</li>`}else if("amuleto_falha"===t.poderId){const e="vagalume"===t.equipeAlvo?"Vaga-lume":t.equipeAlvo.charAt(0).toUpperCase()+t.equipeAlvo.slice(1);o+=`<li>‚ùå <strong>Falha na Magia:</strong> A maldi√ß√£o <strong>${t.nomePoder}</strong> utilizada contra a <strong>Equipe ${e}</strong> falhou... A equipe estava protegida. <br></li>`}}),""==e&&""===a&&""===o)return;let t="";e&&(t+="<h4 style=\"color: #2ecc71; margin-top: 0;\">Efeitos Ativos (pela sua equipe):</h4><ul>"+e+"</ul>"),a&&(t+="<h4 style=\"color: #e74c3c; margin-top: 15px;\">Efeitos Ativos (contra a sua equipe):</h4><ul>"+a+"</ul>"),o&&(t+="<h4 style=\"color: #f39c12; margin-top: 15px;\">Registros de Falha:</h4><ul>"+o+"</ul>"),setTimeout(()=>{mostrarCardPopup("\u2728 Status das Magias Ativas",t,null,null,"status_poderes_ativos")},4e3)}async function abrirModalNotificacoesSeNecessario(){await new Promise(e=>setTimeout(e,3500));const e=document.querySelector("#pix-recebido-popup.show, #medalha-ganha-popup.show, #recompensa-recebida-popup.show, #custom-card-popup.show, #popup-envio-diario-moedas.show, #popup-resultado-loteria.show, #recompensa-lideres-modal.show, #recompensa-equipe-modal.show, #fim-temporada-popup.show");if(e)return void console.log("Modal de recompensa/pix/aviso est\xE1 aberto. O modal de notifica\xE7\xF5es n\xE3o ser\xE1 aberto agora.");if(currentUser)try{const e=query(collection(db,"notificacoes"),where("destinatarioId","==",currentUser),where("lida","==",!1),where("tipo","not-in",["moedas","recompensa_lider","recompensa_membro","medalha-presente"])),a=await getDocs(e);a.empty?console.log("Nenhuma notifica\xE7\xE3o comum n\xE3o lida para exibir no modal."):(console.log(`Encontradas ${a.size} notifica√ß√µes comuns. Abrindo o modal principal.`),marcarNotificacoesComoLidas(),openModal("notificacoes-modal"))}catch(e){console.error("Erro ao verificar notifica\xE7\xF5es para abertura autom\xE1tica do modal:",e)}}async function verificarNotificacoesRestantes(){const e=document.querySelector("#pix-recebido-popup.show, #medalha-ganha-popup.show, #recompensa-recebida-popup.show, #custom-card-popup.show, #popup-envio-diario-moedas.show, #recompensa-lideres-modal.show, #recompensa-equipe-modal.show, #fim-temporada-popup.show");if(!e&&currentUser)try{const e=query(collection(db,"notificacoes"),where("destinatarioId","==",currentUser),where("lida","==",!1),where("tipo","not-in",["moedas","recompensa_lider","recompensa_membro","medalha-presente"])),a=await getDocs(e);a.empty||openModal("notificacoes-modal")}catch(e){console.error("Erro CR\xCDTICO ao verificar notifica\xE7\xF5es restantes:",e)}}async function acaoNormalFecharNotificacoes(){const e=document.getElementById("notificacoes-fechar-btn"),a=e?e.textContent:"Fechar";e&&(e.textContent="Limpando...",e.disabled=!0,e.style.opacity="0.7"),console.log("A\xE7\xE3o normal: Iniciando limpeza de notifica\xE7\xF5es...");try{await apagarTodasAsNotificacoes(),await marcarNotificacoesComoLidas(),console.log("Limpeza conclu\xEDda. Fechando modal."),closeModal("notificacoes-modal")}catch(e){console.error("Erro na a\xE7\xE3o normal de fechar notifica\xE7\xF5es:",e),closeModal("notificacoes-modal")}finally{e&&(e.textContent=a,e.disabled=!1,e.style.opacity="1")}}async function toggleAusenciaMembro(e,a){try{const o=doc(db,"membros",e);let t={};t="ativo"===a?{deFerias:!1,motivoAusencia:deleteField()}:{deFerias:!0,motivoAusencia:a},await updateDoc(o,t),await refreshAppUI();let n="ativo"===a?"est\xE1 ativo novamente.":"saude"===a?"est\xE1 em recupera\xE7\xE3o de sa\xFAde.":"entrou de f\xE9rias.";mostrarPopup("\u2705 Atualizado",`${e} ${n}`,3e3)}catch(a){console.error(`Erro ao atualizar status para ${e}:`,a),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel salvar a altera\xE7\xE3o.",4e3)}}function popularPainelAusencia(){const e=document.getElementById("ferias-lista-membros");e.innerHTML="";const a=[...todosMembros].sort((e,a)=>e.nome.localeCompare(a.nome));a.forEach(a=>{if("lider"===a.papel)return;const o=document.createElement("div");o.className="ferias-item",o.style.justifyContent="space-between";let t="ativo";a.deFerias&&(t="saude"===a.motivoAusencia?"saude":"ferias"),o.innerHTML=`
      <label for="status_${a.nome}" style="font-weight: 500;">${a.nome}</label>
      <select id="status_${a.nome}" class="painel-input" style="width: 140px; padding: 5px;">
        <option value="ativo" ${"ativo"==t?"selected":""}>‚úÖ Ativo</option>
        <option value="ferias" ${"ferias"==t?"selected":""}>üå¥ F√©rias</option>
        <option value="saude" ${"saude"==t?"selected":""}>üò∑ Sa√∫de</option>
      </select>
    `,o.querySelector("select").addEventListener("change",o=>{toggleAusenciaMembro(a.nome,o.target.value)}),e.appendChild(o)})}async function verificarPopupRecompensas(){const e=getHoje(),a=e.getDay(),o=getSemanaAtual(),t=doc(db,"appState",`popupState_${o.numero}_${o.inicio.getFullYear()}`);try{const o=await getDoc(t),n=o.exists()?o.data():{};if("lider"===userRole&&0===a){const e=n.liderGeralAvaliacaoVista||[];if(e.includes(currentUser))return;setTimeout(abrirPopupAvaliacaoLideres,2e3)}if("lider-equipe"===userRole&&(0===a||1===a)){const a=n.liderEquipeRecompensaVista||[];if(a.includes(currentUser))return;const o=getSemanaAtual(new Date(e.getTime()-86400000)),t=doc(db,"recompensasLideres",`semana_${o.numero}_${o.inicio.getFullYear()}`),i=await getDoc(t);i.exists()&&i.data().aprovados.includes(currentUser)&&setTimeout(abrirPopupRecompensaEquipe,2e3)}}catch(a){console.error("Erro ao verificar popups de recompensa:",a)}}function abrirPopupAvaliacaoLideres(){const e=todosMembros.filter(e=>"lider-equipe"===e.papel);if(0===e.length)return void mostrarPopup("\u2139\uFE0F Informa\xE7\xE3o","N\xE3o h\xE1 l\xEDderes de equipe para avaliar.",4e3);const a=document.getElementById("recompensa-lideres-lista");a.innerHTML="",e.forEach(e=>{const o=document.createElement("div");o.className="envio-membro-item",o.innerHTML=`
      <input type="checkbox" id="recompensa-lider-${e.nome}" value="${e.nome}" checked>
      <label for="recompensa-lider-${e.nome}">${e.nome} (${e.equipe})</label>
    `,a.appendChild(o)}),openModal("recompensa-lideres-modal")}function abrirPopupRecompensaEquipe(){const e=todosMembros.filter(e=>e.equipe===userTeam&&"membro"===e.papel);if(0===e.length)return void mostrarPopup("\u2139\uFE0F Informa\xE7\xE3o","Sua equipe n\xE3o possui membros para recompensar.",4e3);const a=document.getElementById("recompensa-equipe-lista");a.innerHTML="",e.forEach(e=>{const o=document.createElement("div");o.className="envio-membro-item",o.innerHTML=`
      <input type="checkbox" id="recompensa-membro-${e.nome}" value="${e.nome}">
      <label for="recompensa-membro-${e.nome}">${e.nome}</label>
    `,a.appendChild(o)}),openModal("recompensa-equipe-modal")}async function executarEnvioRecompensaLideres(){const e=document.querySelectorAll("#recompensa-lideres-lista input[type=\"checkbox\"]"),a=Array.from(e).filter(e=>e.checked).map(e=>e.value),o=todosMembros.filter(e=>"lider-equipe"===e.papel).map(e=>e.nome),t=o.filter(e=>!a.includes(e)),n=getSemanaAtual(),i=`semana_${n.numero}_${n.inicio.getFullYear()}`,r=doc(db,"recompensasLideres",i),d=doc(db,"appState",`popupState_${n.numero}_${n.inicio.getFullYear()}`),s=new Date,l=writeBatch(db),m=writeBatch(dbEssencial),c=1e5,u=1e4;a.forEach(e=>{const a=doc(dbEssencial,"membros_essencial",e);m.update(a,{moedas:increment(c)});const o=doc(collection(db,"notificacoes"));l.set(o,{destinatarioId:e,remetenteNome:"Sistema",tipo:"recompensa_lider",conteudo:"\uD83D\uDC51",acao:`voc√™ recebeu <strong>${c.toLocaleString("pt-BR")} üí∞ moedas</strong> em raz√£o da sua √≥tima lideran√ßa nesta semana. Muito obrigado pelo apoio!`,lida:!1,timestamp:s,valor:c,popupVisto:!1,agradecimentoEnviado:!1})}),t.forEach(e=>{const a=doc(dbEssencial,"membros_essencial",e);m.update(a,{moedas:increment(u)});const o=doc(collection(db,"notificacoes"));l.set(o,{destinatarioId:e,remetenteNome:"Sistema",tipo:"aviso",conteudo:"\u26A0\uFE0F",acao:`sua lideran√ßa deixou a desejar nesta semana. Por isso, voc√™ recebeu <strong>${u.toLocaleString("pt-BR")} üí∞ moedas</strong> e n√£o ter√° acesso ao painel de recompensas da equipe.`,lida:!1,timestamp:s})}),l.set(r,{aprovados:a,avaliadoEm:s,processado:!0}),l.set(d,{liderGeralAvaliacaoVista:arrayUnion(currentUser)},{merge:!0});try{await Promise.all([l.commit(),m.commit()]),closeModal("recompensa-lideres-modal"),mostrarPopup("\u2705 Pagamento Realizado!","A avalia\xE7\xE3o foi salva e os pagamentos aos l\xEDderes foram processados.",5e3)}catch(e){console.error("Erro ao salvar avalia\xE7\xE3o e pagar l\xEDderes:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel processar os pagamentos.",4e3)}}async function executarEnvioRecompensaEquipe(){const e=document.querySelectorAll("#recompensa-equipe-lista input[type=\"checkbox\"]:checked");if(0===e.length)return void mostrarPopup("\uD83E\uDD14 Aten\xE7\xE3o","Voc\xEA precisa selecionar pelo menos um membro para recompensar.",4e3);const a=document.getElementById("enviar-recompensa-equipe-btn");a.disabled=!0,a.textContent="Enviando...";const o=Array.from(e).map(e=>e.value),t=writeBatch(db),n=writeBatch(dbEssencial),i=new Date,r=5e3;o.forEach(e=>{const a=doc(dbEssencial,"membros_essencial",e);n.update(a,{moedas:increment(r)});const o=doc(collection(db,"notificacoes"));t.set(o,{destinatarioId:e,remetenteNome:currentUser,tipo:"recompensa_membro",conteudo:"\uD83C\uDFC6",acao:`reconheceu seu esfor√ßo e dedica√ß√£o nesta semana e te enviou <strong>${r.toLocaleString("pt-BR")} üí∞ moedas</strong> como forma de agradecimento e incentivo, parab√©ns!`,lida:!1,timestamp:i,valor:r,popupVisto:!1,agradecimentoEnviado:!1})});const d=getSemanaAtual(),s=doc(db,"appState",`popupState_${d.numero}_${d.inicio.getFullYear()}`);t.set(s,{liderEquipeRecompensaVista:arrayUnion(currentUser)},{merge:!0});try{await Promise.all([t.commit(),n.commit()]),closeModal("recompensa-equipe-modal"),mostrarPopup("\u2705 Sucesso!",`${o.length} membro(s) foram recompensados com 5.000 moedas!`,5e3)}catch(e){console.error("Erro ao enviar recompensa da equipe:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel enviar as moedas.",4e3)}finally{a.disabled=!1,a.textContent="Enviar Recompensas"}}async function processarRecompensasLideres(){console.log("Processando recompensas de lideran\xE7a...");const e=getHoje(),a=getSemanaAtual(new Date(e.getTime()-86400000)),o=`semana_${a.numero}_${a.inicio.getFullYear()}`,t=doc(db,"recompensasLideres",o);try{const e=await getDoc(t);if(!e.exists()||e.data().processado)return void console.log("Recompensas de l\xEDderes n\xE3o encontradas ou j\xE1 processadas para esta semana.");const a=e.data().aprovados||[],o=todosMembros.filter(e=>"lider-equipe"===e.papel).map(e=>e.nome),n=o.filter(e=>!a.includes(e)),i=writeBatch(db),r=writeBatch(dbEssencial);a.forEach(e=>{r.update(doc(dbEssencial,"membros_essencial",e),{moedas:increment(1e5)});const a=doc(collection(db,"notificacoes"));i.set(a,{destinatarioId:e,remetenteNome:"Sistema",tipo:"moedas",conteudo:"\uD83D\uDC51",acao:`voc√™ recebeu <strong>100.000 üí∞ moedas</strong> em raz√£o da sua √≥tima lideran√ßa nesta semana. Muito obrigado pelo apoio!`,lida:!1,timestamp:new Date})}),n.forEach(e=>{r.update(doc(dbEssencial,"membros_essencial",e),{moedas:increment(1e4)});const a=doc(collection(db,"notificacoes"));i.set(a,{destinatarioId:e,remetenteNome:"Sistema",tipo:"aviso",conteudo:"\u26A0\uFE0F",acao:`sua lideran√ßa deixou a desejar nesta semana. Por isso, voc√™ recebeu <strong>10.000 üí∞ moedas</strong> (metade da remunera√ß√£o) e n√£o ter√° acesso ao painel de recompensas da equipe.`,lida:!1,timestamp:new Date})}),i.update(t,{processado:!0}),await Promise.all([i.commit(),r.commit()]),console.log("Recompensas de lideran\xE7a processadas com sucesso.")}catch(e){console.error("Erro cr\xEDtico ao processar recompensas de l\xEDderes:",e)}}window.abrirModalAutores=async function(e){const a=document.getElementById("autores-modal-titulo"),o=document.getElementById("autores-lista-container");a.textContent=`Autores do Desenho`,o.innerHTML="<div class=\"ociosos-placeholder\">Carregando artistas...</div>",openModal("autores-desenho-modal");try{const a=collection(dbDesenho,`desenhos_${e}`),t=query(a),n=await getDocs(t);if(n.empty)return void(o.innerHTML="<div class=\"ociosos-placeholder\">Ningu\xE9m desenhou aqui ainda.</div>");const i=new Set;if(n.forEach(e=>{e.data().desenhadoPor&&i.add(e.data().desenhadoPor)}),0===i.size)return void(o.innerHTML="<div class=\"ociosos-placeholder\">Nenhum autor identificado.</div>");o.innerHTML="",i.forEach(e=>{const a=document.createElement("div");a.className="autores-item",a.textContent=e,o.appendChild(a)})}catch(e){console.error("Erro ao buscar autores do desenho:",e),o.innerHTML="<div class=\"ociosos-placeholder\">Erro ao carregar a lista.</div>"}};function carregarEExibirAvaliacoesDesenho(){const e=getSemanaAtual(),a=`semana_${e.numero}_${e.inicio.getFullYear()}`,o=doc(dbDesenho,"interacoesDesenho",a);window.listenersAtivos.avaliacoesDesenho&&window.listenersAtivos.avaliacoesDesenho(),window.listenersAtivos.avaliacoesDesenho=onSnapshot(o,e=>{const a=e.exists()?e.data().avaliacoes||{}:{};["abelha","joaninha","vagalume"].forEach(e=>{const o=a[e]||{likes:[],dislikes:[]},t=o.likes||[],n=o.dislikes||[],i=document.getElementById(`like-container-${e}`);if(i){const e=i.querySelector(".like-count");e.textContent=t.length;const a=t.includes(currentUser);i.classList.toggle("ativo",a),i.classList.toggle("like-ativo",a)}const r=document.getElementById(`dislike-container-${e}`);if(r){const e=r.querySelector(".dislike-count");e.textContent=n.length;const a=n.includes(currentUser);r.classList.toggle("ativo",a),r.classList.toggle("dislike-ativo",a)}})})}async function atualizarAvaliacaoOtimista(e,a){if(!currentUser||e===userTeam)return;const o=document.getElementById(`like-container-${e}`),t=document.getElementById(`dislike-container-${e}`);if(!o||!t)return;const n=o.querySelector(".like-count"),i=t.querySelector(".dislike-count"),r=o.classList.contains("ativo"),d=t.classList.contains("ativo");o.classList.remove("ativo","like-ativo"),t.classList.remove("ativo","dislike-ativo"),r&&(n.textContent=Math.max(0,parseInt(n.textContent)-1)),d&&(i.textContent=Math.max(0,parseInt(i.textContent)-1)),"like"!==a||r?"dislike"===a&&!d&&(t.classList.add("ativo","dislike-ativo"),i.textContent=parseInt(i.textContent)+1):(o.classList.add("ativo","like-ativo"),n.textContent=parseInt(n.textContent)+1)}window.abrirModalAvaliadores=async function(e,a){const o=document.getElementById("avaliadores-modal-titulo"),t=document.getElementById("avaliadores-lista-container"),n=e.charAt(0).toUpperCase()+e.slice(1);o.textContent="likes"===a?`Curtiram o Desenho`:`N√£o Curtiram o Desenho`,t.innerHTML="<div class=\"ociosos-placeholder\">Carregando...</div>",openModal("avaliadores-desenho-modal");try{const o=getSemanaAtual(),n=`semana_${o.numero}_${o.inicio.getFullYear()}`,i=doc(db,"vantagemSemanal",n),r=await getDoc(i),d=r.exists()?r.data().avaliacoesDesenho||{}:{},s=d[e]||{},l=s[a]||[];if(0===l.length)return void(t.innerHTML=`<div class="ociosos-placeholder">Ningu√©m avaliou desta forma ainda.</div>`);t.innerHTML="",l.forEach(e=>{const a=document.createElement("div");a.className="autores-item",a.textContent=e,t.appendChild(a)})}catch(e){console.error("Erro ao buscar avaliadores do desenho:",e),t.innerHTML="<div class=\"ociosos-placeholder\">Erro ao carregar a lista.</div>"}},window.avaliarDesenho=async function(e,a){if(e===userTeam)return void mostrarPopup("\uD83D\uDEAB A\xE7\xE3o Inv\xE1lida","Voc\xEA n\xE3o pode avaliar o desenho da sua pr\xF3pria equipe.",4e3);atualizarAvaliacaoOtimista(e,a);const o=getSemanaAtual(),t=`semana_${o.numero}_${o.inicio.getFullYear()}`,n=doc(dbDesenho,"interacoesDesenho",t);try{const o=await runTransaction(dbDesenho,async o=>{const t=await o.get(n),i=t.exists()?t.data():{},r=i.avaliacoesDesenho||{};r[e]||(r[e]={likes:[],dislikes:[]});const d=i.avaliacaoFeedEvents||{};d[e]||(d[e]={});const s=r[e].likes||[],l=r[e].dislikes||[],m=s.indexOf(currentUser),c=l.indexOf(currentUser);let u="removeu a avalia\xE7\xE3o";if(-1<m){const a=`${currentUser}_like`;d[e][a]&&(o.delete(doc(db,"resumoSemanalFeed",d[e][a])),delete d[e][a]),s.splice(m,1)}if(-1<c){const a=`${currentUser}_dislike`;d[e][a]&&(o.delete(doc(db,"resumoSemanalFeed",d[e][a])),delete d[e][a]),l.splice(c,1)}return"like"===a&&-1===m?(s.push(currentUser),u="avaliou com \uD83D\uDC4D"):"dislike"==a&&-1===c&&(l.push(currentUser),u="avaliou com \uD83D\uDC4E"),o.set(n,{avaliacoes:r},{merge:!0}),u});if("removeu a avalia\xE7\xE3o"!==o){const t="vagalume"===e?"Vaga-lume":e.charAt(0).toUpperCase()+e.slice(1),n=`<strong>${currentUser}</strong> ${o} o desenho da equipe <strong>${t}</strong>.`,i=await adicionarEventoAoFeed("geral","\uD83C\uDFA8 Nova Avalia\xE7\xE3o de Desenho!",n);if(i){const o=`${currentUser}_${a}`;await updateDoc(advantageRef,{[`avaliacaoFeedEvents.${e}.${o}`]:i})}}if("avaliou com \uD83D\uDC4D"===o){const a=new Set;try{const o=collection(dbDesenho,`desenhos_${e}`),t=query(o),n=await getDocs(t);if(n.forEach(e=>{e.data().desenhadoPor&&a.add(e.data().desenhadoPor)}),0<a.size){const o=writeBatch(db),t="vagalume"===e?"Vaga-lume":e.charAt(0).toUpperCase()+e.slice(1);a.forEach(e=>{if(e!==currentUser){const a=doc(collection(db,"notificacoes"));o.set(a,{destinatarioId:e,remetenteNome:currentUser,tipo:"desenho-like",conteudo:"\uD83C\uDFA8\u2764\uFE0F",acao:`curtiu o desenho da Equipe ${t}! "Sua arte foi apreciada! Continue colorindo nosso dia."`,lida:!1,timestamp:new Date})}}),await o.commit(),console.log(`Notifica√ß√µes de curtida enviadas para ${a.size} autor(es).`)}}catch(e){console.error("N\xE3o foi poss\xEDvel buscar os autores do desenho para notificar:",e)}}}catch(e){console.error("Erro ao avaliar desenho:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel registrar sua avalia\xE7\xE3o. Por favor, recarregue a p\xE1gina.",4e3)}};function configurarOuvintesDePreviewDesenho(){const e=getHoje(),a=e.getDay(),o=1===a||2===a?new Date(e.getTime()-259200000):e,t=getSemanaAtual(o),n=`semana_${t.numero}_${t.inicio.getFullYear()}`;["abelha","joaninha","vagalume"].forEach(e=>{const a=document.getElementById(`preview-container-${e}`);if(!a)return;a.onclick=function(){abrirModalDesenho(e)};const o=doc(dbDesenho,"desenho_previews",`preview_${n}_${e}`);window.listenersAtivos["preview_"+e]&&window.listenersAtivos["preview_"+e](),window.listenersAtivos["preview_"+e]=onSnapshot(o,async e=>{const o=a.querySelector("canvas"),t=o.getContext("2d");if(o.width=800,o.height=600,t.clearRect(0,0,o.width,o.height),e.exists()){const a=e.data();if(a.imageDataURL){const e=new Image;e.onload=function(){t.drawImage(e,0,0,800,600)},e.src=a.imageDataURL}}})})}async function carregarDadosLoteria(){try{const e=doc(db,"loteria","estadoAtual"),a=await getDoc(e);if(a.exists()){dadosLoteria=a.data(),document.getElementById("loteria-valor-acumulado").textContent=dadosLoteria.premioAcumulado.toLocaleString("pt-BR"),document.getElementById("loteria-edicao-info").textContent=`Edi√ß√£o ${(dadosLoteria.edicao+"").padStart(4,"0")}/${dadosLoteria.ano}`;const e=todosMembros.find(e=>e.nome===currentUser);e&&(document.getElementById("loteria-saldo-usuario").textContent=(e.moedas||0).toLocaleString("pt-BR"));const o=collection(db,"loteria","estadoAtual","apostasDaEdicao"),t=query(o,where("membro","==",currentUser),where("edicao","==",dadosLoteria.edicao)),n=await getDocs(t);minhasApostasEdicao=n.size,dadosApostasUsuarioCarregados=!0,renderizarHistoricoResultados(dadosLoteria.historico||[]),verificarNudgesDiarios(!1)}else await setDoc(e,{premioAcumulado:0,edicao:1,ano:new Date().getFullYear(),totalApostas:0,historico:[]}),carregarDadosLoteria()}catch(e){console.error("Erro ao carregar loteria:",e)}}function renderizarHistoricoResultados(e){const a=document.getElementById("lista-ultimos-resultados");if(a.innerHTML="",0===e.length)return void(a.innerHTML="<div class=\"ociosos-placeholder\">Nenhum sorteio realizado ainda.</div>");const o=e.slice(-4).reverse();o.forEach(e=>{const o=document.createElement("div");o.className="card-resultado-antigo";let t="";e.numeros.forEach(e=>{t+=`<div class="bola-mini">${e}</div>`}),o.innerHTML=`
      <strong>Ed. ${(e.edicao+"").padStart(4,"0")}</strong><br>
      <span style="font-size: 0.8em; color: #7f8c8d;">${new Date(1e3*e.data.seconds).toLocaleDateString("pt-BR")}</span>
      <div class="numeros-sorteados-mini">${t}</div>
    `,a.appendChild(o)})}function abrirModalAposta(){if(currentUser){const e=document.getElementById("aposta-limite-aviso");return e.textContent=`Voc√™ j√° fez ${minhasApostasEdicao} de ${LIMITE_APOSTAS_POR_EDICAO} apostas permitidas.`,minhasApostasEdicao>=LIMITE_APOSTAS_POR_EDICAO?void mostrarPopup("\uD83D\uDEAB Limite Atingido","Voc\xEA j\xE1 atingiu o limite de 6 apostas para este sorteio.",4e3):void(numerosSelecionadosAposta=[],renderizarGridCartela(),atualizarUISelecao(),openModal("modal-fazer-aposta"))}}window.abrirModalAposta=abrirModalAposta;function renderizarGridCartela(){const e=document.getElementById("cartela-grid");e.innerHTML="";for(let a=1;30>=a;a++){const o=document.createElement("div");o.className="bola-loteria",o.textContent=a,o.onclick=()=>toggleNumeroCartela(a,o),e.appendChild(o)}}function toggleNumeroCartela(e,a){if(numerosSelecionadosAposta.includes(e))numerosSelecionadosAposta=numerosSelecionadosAposta.filter(a=>a!==e),a.classList.remove("selecionada");else{if(4<=numerosSelecionadosAposta.length)return void mostrarPopup("\u26A0\uFE0F Aten\xE7\xE3o","Voc\xEA s\xF3 pode escolher 4 n\xFAmeros.",2e3);numerosSelecionadosAposta.push(e),a.classList.add("selecionada")}atualizarUISelecao()}function atualizarUISelecao(){document.getElementById("aposta-contador-selecionados").textContent=`Selecionados: ${numerosSelecionadosAposta.length}/4`;const e=document.getElementById("btn-confirmar-aposta");4===numerosSelecionadosAposta.length?(e.style.opacity="1",e.style.cursor="pointer"):e.style.opacity="0.6"}async function confirmarAposta(){if(4!==numerosSelecionadosAposta.length)return void mostrarPopup("\u26A0\uFE0F Aten\xE7\xE3o",`Voc√™ selecionou ${numerosSelecionadosAposta.length} n√∫meros. √â necess√°rio escolher exatamente 4 n√∫meros para apostar!`,4e3);if(minhasApostasEdicao>=LIMITE_APOSTAS_POR_EDICAO)return void mostrarPopup("\uD83D\uDEAB Limite","Limite de apostas atingido.",3e3);const e=document.getElementById("btn-confirmar-aposta");e.disabled=!0,e.textContent="Processando...";try{const e=doc(dbEssencial,"membros_essencial",currentUser),a=doc(db,"loteria","estadoAtual"),o=collection(a,"apostasDaEdicao"),t=await getDoc(e),n=t.exists()?t.data().moedas||0:0;if(n<CUSTO_APOSTA)throw"Saldo insuficiente.";await updateDoc(e,{moedas:increment(-100)}),await runTransaction(db,async e=>{const t=await e.get(a);e.update(a,{premioAcumulado:increment(CUSTO_APOSTA),totalApostas:increment(1)});const n=doc(o),i={membro:currentUser,equipe:userTeam,numeros:numerosSelecionadosAposta.sort((e,a)=>e-a),data:new Date,edicao:t.data().edicao,idVisual:n.id.substring(0,8).toUpperCase()};return e.set(n,i),i}).then(async e=>{atualizarProgressoProtecao("apostar");const a=todosMembros.find(e=>e.nome===currentUser);let o="Ele(a)";a&&("masculino"===a.genero?o="Ele":"feminino"===a.genero&&(o="Ela")),await adicionarEventoAoFeed("geral","\uD83C\uDF40 Aposta Realizada!",`<strong>${currentUser}</strong> est√° se sentindo com sorte! ${o} acabou de fazer uma aposta na Loteria √âpica. Ser√° que vem pr√™mio a√≠?`,{nomeMembro:currentUser}),mostrarPopup("\u2705 Sucesso!","Aposta realizada com sucesso!",4e3),closeModal("modal-fazer-aposta"),minhasApostasEdicao++,verificarNudgesDiarios(!1),carregarDadosLoteria(),exibirComprovanteLoteria(e)})}catch(e){console.error("Erro na aposta:",e),mostrarPopup("\u274C Erro","string"==typeof e?e:"Falha ao processar aposta.",4e3)}finally{e.disabled=!1,e.textContent="Confirmar Aposta"}}function exibirComprovanteLoteria(e){const a=document.getElementById("conteudo-comprovante-loteria"),o=e.numeros.map(e=>`<span class="bola-loteria" style="display:inline-flex; justify-content:center; align-items:center; width:40px; height:40px; margin:4px; font-size:1.1rem; cursor:default; background-color:#3498db; color:white; border:none;">${e}</span>`).join(""),t=new Date,n=(3-t.getDay()+7)%7||7,i=new Date(t);i.setDate(t.getDate()+n),a.innerHTML=`
        <p><strong>Membro:</strong> ${e.membro}</p>
        <p><strong>Equipe:</strong> ${e.equipe}</p>
        <p><strong>Edi√ß√£o:</strong> ${(e.edicao+"").padStart(4,"0")}</p>
        <p><strong>Data Aposta:</strong> ${e.data.toLocaleString("pt-BR")}</p>
        <div style="margin: 10px 0;">
            <strong style="display:block; margin-bottom: 5px;">N√∫meros Escolhidos:</strong>
            <div style="display:flex; justify-content:center; gap:5px;">${o}</div>
        </div>
        <p><strong>ID Aposta:</strong> <span style="font-family:monospace">${e.idVisual}</span></p>
        <p style="margin-top:10px; font-size:0.85rem; color:#e67e22;">O sorteio ocorrer√° em: ${i.toLocaleDateString("pt-BR")}</p>
    `,openModal("modal-comprovante-loteria"),document.getElementById("btn-baixar-comprovante-loteria").onclick=()=>{html2canvas(document.getElementById("comprovante-loteria"),{scale:2}).then(a=>{const o=document.createElement("a");o.download=`aposta-epicos-${e.idVisual}.png`,o.href=a.toDataURL("image/png"),o.click()})}}async function verHistoricoApostas(){const e=document.getElementById("lista-apostadores-loteria");e.innerHTML="<div class=\"ociosos-placeholder\">Carregando...</div>",openModal("modal-historico-apostas");try{const a=collection(db,"loteria","estadoAtual","apostasDaEdicao"),o=query(a,orderBy("data","desc")),t=await getDocs(o);if(t.empty)return void(e.innerHTML="<div class=\"ociosos-placeholder\">Nenhuma aposta feita nesta edi\xE7\xE3o ainda.</div>");e.innerHTML="",t.forEach(a=>{const o=a.data(),t=document.createElement("div");t.className="ocioso-item aposta-card",t.style.flexDirection="column",t.style.alignItems="flex-start";const n=o.idVisual||"??????",i=n.substring(0,4)+"****";t.innerHTML=`
                <div style="display:flex; justify-content:space-between; width:100%;">
                    <strong>${o.membro}</strong>
                    <span style="font-size:0.8rem; color:#7f8c8d;">${o.data.toDate().toLocaleString("pt-BR")}</span>
                </div>
                <div style="font-size:0.85rem; margin-top:8px; color: #27ae60; font-weight:bold;">Aposta registrada com sucesso. ‚úÖ</div>
                <div style="font-size:0.85rem; margin-top:2px; color: #3498db;">ID: <span style="font-family:monospace;">${i}</span></div>
            `,e.appendChild(t)})}catch(a){console.error("Erro hist\xF3rico:",a),e.innerHTML="<div class=\"ociosos-placeholder\">Erro ao carregar.</div>"}}async function verMinhasApostas(){const e=document.getElementById("lista-minhas-apostas");e.innerHTML="<div class=\"ociosos-placeholder\">Carregando suas apostas...</div>",openModal("modal-minhas-apostas");try{const a=collection(db,"loteria","estadoAtual","apostasDaEdicao"),o=query(a,where("membro","==",currentUser),orderBy("data","desc")),t=await getDocs(o);if(t.empty)return void(e.innerHTML="<div class=\"ociosos-placeholder\">Voc\xEA ainda n\xE3o fez apostas nesta edi\xE7\xE3o.</div>");e.innerHTML="",t.forEach(a=>{const o=a.data(),t=document.createElement("div");t.className="ocioso-item aposta-card",t.style.flexDirection="column",t.style.alignItems="flex-start",t.style.gap="8px";const n=o.numeros.map(e=>`<span style="display:inline-flex; justify-content:center; align-items:center; width:30px; height:30px; background:#3498db; color:white; border-radius:50%; font-weight:bold; font-size:0.9rem;">${e}</span>`).join(" "),i=dadosLoteria.edicao,r=o.edicao===i?`<span style="color:#27ae60;">Edi√ß√£o Atual (${o.edicao})</span>`:`<span style="color:#7f8c8d;">Edi√ß√£o Passada (${o.edicao})</span>`;let d="";const s=dadosLoteria.historico.find(e=>e.edicao===o.edicao);if(s){const e=s.numeros.map(e=>{const a=o.numeros.includes(e),t=a?"#f1c40f":"#2ecc71";return`<span style="display:inline-flex; justify-content:center; align-items:center; width:22px; height:22px; background:${t}; color:white; border-radius:50%; font-weight:bold; font-size:0.75rem; border: 1px solid rgba(0,0,0,0.1);">${e}</span>`}).join(" ");d=`
                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px dashed #eee; width: 100%;">
                        <div style="font-size: 0.8rem; color: #7f8c8d; margin-bottom: 4px;">Resultado Sorteado:</div>
                        <div style="display:flex; gap:4px; flex-wrap:wrap;">
                            ${e}
                        </div>
                    </div>
                `}else o.edicao<i&&(d=`<div style="font-size: 0.8rem; color: #95a5a6; margin-top: 5px;">Aguardando dados...</div>`);t.innerHTML=`
                <div style="display:flex; justify-content:space-between; width:100%; border-bottom:1px solid #eee; padding-bottom:5px;">
                    <strong>ID: <span style="font-family:monospace; color:#e67e22;">${o.idVisual||"????"}</span></strong>
                    <span style="font-size:0.8rem;">${o.data.toDate().toLocaleDateString("pt-BR")}</span>
                </div>
                <div style="display:flex; gap:5px; flex-wrap:wrap; margin-top:5px;">
                    ${n}
                </div>
                
                ${d} <div style="font-size:0.85rem; width:100%; text-align:right; margin-top:5px;">
                    ${r}
                </div>
            `,e.appendChild(t)})}catch(a){console.error("Erro ao carregar minhas apostas:",a),e.innerHTML="<div class=\"ociosos-placeholder\">Erro ao carregar. Tente novamente.</div>"}}function consultarApostaPorID(){const e=document.getElementById("input-consultar-id-aposta");e.value="",document.getElementById("btn-executar-consulta-id").onclick=executarConsultaID,openModal("modal-consultar-id"),e.focus()}async function executarConsultaID(){const e=document.getElementById("input-consultar-id-aposta").value;if(!e||3>e.trim().length)return void mostrarPopup("\u26A0\uFE0F Aten\xE7\xE3o","Digite um ID v\xE1lido.",3e3);const a=e.trim().toUpperCase();closeModal("modal-consultar-id"),showLoadingOverlay("Buscando aposta...");try{const e=collection(db,"loteria","estadoAtual","apostasDaEdicao"),o=query(e,where("idVisual","==",a)),t=await getDocs(o);if(!t.empty){const e=t.docs[0].data();e.data&&e.data.toDate&&(e.data=e.data.toDate()),hideLoadingOverlay(),exibirComprovanteLoteria(e)}else hideLoadingOverlay(),mostrarPopup("\u274C N\xE3o encontrado","Nenhuma aposta encontrada com este ID nesta edi\xE7\xE3o.",4e3)}catch(e){console.error(e),hideLoadingOverlay(),mostrarPopup("\u274C Erro","Erro ao buscar aposta.",3e3)}}async function inicializarGemini(){try{console.log("Buscando chave de API no Firestore...");const e=doc(db,"configuracoes","segredos"),a=await getDoc(e);if(a.exists()){const e=a.data();e.geminiApiKey&&listaChavesGlobal.push(e.geminiApiKey);for(let a=1;e[`geminiApiKey_${a}`];)listaChavesGlobal.push(e[`geminiApiKey_${a}`]),a++;if(0===listaChavesGlobal.length)return void console.error("\u26A0\uFE0F Nenhuma chave API encontrada no Firestore.");try{const e=doc(db,"appState","apiStatus"),a=await getDoc(e);a.exists()&&(indiceChaveAtual=a.data().indiceAtual||0)}catch(a){console.warn("N\xE3o foi poss\xEDvel ler o \xEDndice da chave, usando a primeira (0)."),indiceChaveAtual=0}indiceChaveAtual>=listaChavesGlobal.length&&(indiceChaveAtual=0);const o=listaChavesGlobal[indiceChaveAtual];genAI=new GoogleGenerativeAI(o),console.log(`‚úÖ Cliente Gemini inicializado! Usando chave √≠ndice: ${indiceChaveAtual} de ${listaChavesGlobal.length}`)}else console.error("\u274C Documento de configura\xE7\xE3o ('configuracoes/segredos') n\xE3o encontrado no Firestore."),adicionarMensagemIA("Erro: N\xE3o encontrei a configura\xE7\xE3o da API no sistema.")}catch(e){console.error("Erro fatal ao inicializar o Gemini:",e),adicionarMensagemIA("Desculpe, n\xE3o estou me sentindo bem no momento.")}}async function rotacionarChaveEAtualizar(){if(1>=listaChavesGlobal.length)return console.warn("Apenas uma chave dispon\xEDvel. N\xE3o \xE9 poss\xEDvel rotacionar."),!1;indiceChaveAtual=(indiceChaveAtual+1)%listaChavesGlobal.length;const e=listaChavesGlobal[indiceChaveAtual];console.log(`üîÑ Rotacionando API... Tentando chave √≠ndice ${indiceChaveAtual}...`),genAI=new GoogleGenerativeAI(e);try{const e=doc(db,"appState","apiStatus");await setDoc(e,{indiceAtual:indiceChaveAtual},{merge:!0}),console.log("\uD83D\uDCBE Novo \xEDndice de chave salvo no Firestore com sucesso.")}catch(e){console.error("Erro ao salvar rota\xE7\xE3o de chave no banco (mas a rota\xE7\xE3o local funcionou):",e)}return!0}async function callGenerativeAIWithRetry(e,a=10){for(let o=1;o<=a;o++)try{const a=genAI.getGenerativeModel({model:"gemini-2.5-flash-lite"}),o=await a.generateContent(e),t=await o.response;return t.text()}catch(e){if(console.error(`Tentativa ${o} de chamar a IA falhou:`,e),e.message&&e.message.includes("429")){console.warn("\uD83D\uDEA8 Cota da API excedida (Erro 429). Iniciando protocolo de troca de chave...");const e=await rotacionarChaveEAtualizar();if(e){o--,await new Promise(e=>setTimeout(e,1e3));continue}}if(e.message&&(e.message.includes("[503]")||e.message.includes("[500]"))){if(o===a)throw new Error("O modelo da IA continua sobrecarregado ap\xF3s v\xE1rias tentativas.");const e=1e3*Math.pow(2,o);console.log(`Modelo sobrecarregado. Tentando novamente em ${e/1e3}s...`),await new Promise(a=>setTimeout(a,e))}else throw e}}async function carregarBaseDeConhecimento(){try{console.log("\uD83E\uDDE0 Or\xE1culo: Iniciando carregamento da base de conhecimento...");let e=`
T√≥pico: Funcionamento T√©cnico B√°sicos
Conte√∫do:
- Medalhas de Foco (ex: üî•, üëë, üåü) s√£o conquistas individuais baseadas no seu 'streak', que √© o n√∫mero de dias consecutivos de foco. Existem medalhas para 3, 10, 30, 60 dias e assim por diante.
- Medalhas de Honra (üèÖ): Medalhas de Honra (ex: Medalha da Coragem, Medalha da Sabedoria) s√£o itens colecion√°veis e raros. Elas n√£o s√£o autom√°ticas e s√≥ podem ser concedidas por um L√≠der de Equipe ou pelo L√≠der Geral como forma de reconhecimento por feitos excepcionais. Elas ficam expostas em um quadro de medalhas no perfil do membro.
- Moedas (üí∞): Voc√™ ganha moedas ao focar diariamente, postar no mural, reagir a conte√∫dos, vencer o jogo da vantagem e com a vit√≥ria semanal da sua equipe. Moedas s√£o usadas para comprar casas, itens de avatar, e podem ser depositadas no Banco da Equipe.
- Banco da Equipe (üí∏): Cada equipe (Abelha, Joaninha, Vagalume) tem seu pr√≥prio banco. Membros podem depositar moedas pessoais no banco para aumentar o saldo coletivo. O saldo do banco cresce 0.5% ao dia com juros.
- Lojinha de Magias (üîÆ): A Lojinha de Magias √© onde os L√≠deres de Equipe podem gastar as moedas do Banco da Equipe para comprar poderes. Existem poderes de b√¥nus (como o Elixir de Vida, que d√° +2 pontos na m√©dia) e poderes de ataque (como a Maldi√ß√£o da Pilantragem, que tira -2 pontos de um advers√°rio). O uso de poderes afeta diretamente a competi√ß√£o semanal.
- Jogo da Vantagem: √â um desafio semanal dispon√≠vel de Segunda a Sexta. Se todos os membros de uma equipe completarem o jogo, a equipe ganha um b√¥nus na sua pontua√ß√£o final da semana.
- Competi√ß√£o de Equipes: A competi√ß√£o ocorre de Segunda a S√°bado. A equipe com a maior m√©dia de pontos no final da semana vence e ganha +1 ponto no ranking geral. Membros da equipe vencedora tamb√©m ganham um b√¥nus em moedas.
- M√©dia Nivelada (IMPORTANTE): Para garantir que a competi√ß√£o seja 100% justa, mesmo que uma equipe tenha 10 membros e outra tenha apenas 5, o sistema usa o c√°lculo de M√©dia Nivelada.
  * Como funciona: M√©dia = Pontos Totais da Equipe √∑ pelo N√∫mero de Membros. Ap√≥s o nivelamento do n√∫mero de membros, caso estejam sendo considerados os pontos de 5 membros por cada equipe, e considerando que os membro podem fazer at√© 6 pontos cada um na semana e mais 3 pontos do jogo da vantagem, ou seja, 9 pontos cada um, a pontua√ß√£o total seria 36 (9x4=36). Ent√£o, entramos com a √∫ltima fase da M√©dia Nivelada que √© Pontos Totais divididos pelo N√∫mero de Membros, fica assim: 36√∑4=9 (9 pontos √© a m√©dia nivelada da equipe).
  * Observa√ß√£o: Com o Elixir de Vida da lojinha de magias, a m√©dia pode chegar a 11 pontos (9+2=11). Com a Maldi√ß√£o da Pilantragem, a pontua√ß√£o ficaria 7 pontos (9-2=7). Ou seja, as magias podem influenciar muito na pontua√ß√£o final da m√©dia nivelada.
- √Årvore √âpica: A √Årvore √âpica √© um objetivo coletivo. Se 10 ou mais membros focarem no mesmo dia, a √°rvore avan√ßa um dia em seu crescimento. Ela passa por fases, de semente a frutos.
- Foco Di√°rio: O foco di√°rio deve ter no m√≠nimo 40 minutos. Ao concluir, marque a caixa de sele√ß√£o ao lado do seu nome para registrar sua presen√ßa e ganhar pontos e moedas.
- Loteria √âpica (üçÄ): √â um sorteio semanal que ocorre toda Quarta-feira. O membro escolhe 4 n√∫meros (1 a 30) por 300 moedas. Se acertar os 4, ganha o pr√™mio acumulado (ou divide se houver mais ganhadores). Se ningu√©m acertar, o pr√™mio acumula para a semana seguinte.
- Batalha de Desenhos (üé®): Uma competi√ß√£o de arte entre as equipes. Um novo tema √© lan√ßado toda Quinta-feira pelo Or√°culo. As equipes desenham juntas em uma tela compartilhada at√© a Segunda-feira (23:59). Na Ter√ßa-feira, Eu (o Or√°culo) julgo as obras baseado em Criatividade, Cores e Originalidade. A equipe vencedora ganha 5.000 moedas para cada membro.
- Conselho do Dia: Todos os dias, ao fazer login, entrego um conselho pessoal. O conselho √© baseado na sorte de cada membro e na utiliza√ß√£o dos conhecimentos superiores do Or√°culo.
`;const a=doc(db,"regras","manual"),o=await getDoc(a);if(o.exists()){const a=o.data();e+=`\n\n--- üìú MANUAL DE REGRAS E DIN√ÇMICAS (Lido do Sistema) ---\n`,a.Foco&&(e+=`\n[REGRA: LISTA DE FOCO]\n${a.Foco}\n`),a.Folga&&(e+=`\n[REGRA: DIA DE FOLGA]\n${a.Folga}\n`),a.Lider&&(e+=`\n[REGRA: NOMEA√á√ÉO DE L√çDERES]\n${a.Lider}\n`),a.Medalhas&&(e+=`\n[REGRA: MEDALHAS INDIVIDUAIS]\n${a.Medalhas}\n`),a.Deserto&&(e+=`\n[REGRA: DESERTO DO FOCUS PLANT]\n${a.Deserto}\n`)}const t=doc(db,"regras","conduta"),n=await getDoc(t);if(n.exists()){const a=n.data();e+=`\n\n--- ‚ö†Ô∏è C√ìDIGO DE CONDUTA E ADVERT√äNCIAS (Lido do Sistema) ---\n`;const o=e=>e?e.replace(/<br>/g,"\n").replace(/‚Ä¢/g,"-"):"Sem dados.";e+=`\n[ADVERT√äNCIA LEVE - Motivos]:\n${o(a.leve)}\n`,e+=`\n[ADVERT√äNCIA M√âDIA - Motivos]:\n${o(a.media)}\n`,e+=`\n[ADVERT√äNCIA GRAVE - Motivos]:\n${o(a.grave)}\n`,e+=`\n[ADVERT√äNCIA GRAV√çSSIMA - Motivos]:\n${o(a.gravissima)}\n`,e+=`\n[MOTIVOS PARA EXPULS√ÉO]:\n${o(a.expulsao)}\n`}baseDeConhecimentoTexto=e,console.log("\uD83E\uDDE0 Or\xE1culo: Conhecimento carregado com sucesso (T\xE9cnico + Manual + Conduta).")}catch(e){console.error("Erro ao carregar intelig\xEAncia do Or\xE1culo:",e),baseDeConhecimentoTexto="Estou com dificuldade para acessar os pergaminhos de regras no momento, mas posso tentar ajudar com o que sei sobre o funcionamento b\xE1sico."}}function adicionarMensagemUsuario(e){const a=document.getElementById("chat-ia-messages");a.innerHTML+=`<div class="chat-message user">${e}</div>`,a.scrollTop=a.scrollHeight}function adicionarMensagemIA(e){const a=document.getElementById("chat-ia-messages"),o=a.querySelector(".thinking");o&&o.remove();const t=marked.parse(e);a.innerHTML+=`<div class="chat-message ia">${t}</div>`,a.scrollTop=a.scrollHeight}async function obterContextoDinamicoParaIA(){const e=new Date,a=getDiaSemanaString(e),o=getHojeISO();let t=[],n="Hist\xF3rico de Foco desta Semana (Use isso para responder se algu\xE9m focou):\n",i={};try{const e=await getDoc(doc(dbEssencial,"presencas",o));e.exists()&&(t=Object.keys(e.data()));const a=getSemanaAtual(),r=formatarDataISO(a.inicio),d=query(collection(dbEssencial,"presencas"),where("__name__",">=",r),where("__name__","<=",o)),s=await getDocs(d);s.empty?n+="Nenhum registro de foco encontrado nesta semana ainda.\n":s.forEach(e=>{const a=e.id,t=new Date(a+"T12:00:00"),r=getDiaSemanaString(t),d=new Date;d.setDate(d.getDate()-1);const s=formatarDataISO(d);let l="";a===o?l=" [HOJE]":a===s&&(l=" [ONTEM]");const m=e.data();let c=[];for(const[a,o]of Object.entries(m)){let e="sem hor\xE1rio";o&&o.toDate?e=o.toDate().toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"}):o instanceof Date&&(e=o.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"}));const t=todosMembros.find(e=>e.nome===a),n=t?`(EQUIPE REAL: ${t.equipe||"Sem Equipe"})`:"(EQUIPE: Desconhecida)";let i="";if(t&&t.folga){const e=r.toLowerCase().replace(/-feira$/,"").normalize("NFD").replace(/[\u0300-\u036f]/g,""),a=t.folga.toLowerCase().replace(/-feira$/,"").normalize("NFD").replace(/[\u0300-\u036f]/g,"");("domingo"===e||e===a)&&(i=" [FOLGA AUTOM\xC1TICA]")}c.push(`${a} ${n} (√†s ${e})${i}`)}const u=Object.keys(m),p=todosMembros.filter(e=>!u.includes(e.nome));let g={abelha:[],joaninha:[],vagalume:[],sem_equipe:[]};p.forEach(e=>{let a="(PENDENTE)";const o=e.folga?e.folga:"N\xE3o definida",t=r.toLowerCase().replace(/-feira$/,"").normalize("NFD").replace(/[\u0300-\u036f]/g,""),n=o.toLowerCase().replace(/-feira$/,"").normalize("NFD").replace(/[\u0300-\u036f]/g,"");let d="REAL";e.deFerias?"saude"===e.motivoAusencia?(a="(SA\xDADE - Abonado)",d="SAUDE"):(a="(F\xC9RIAS - Abonado)",d="FERIAS"):t===n?(a=`(ERRO - O membro estava de FOLGA (${o}), o sistema deveria ter marcado)`,d="ERRO_SISTEMA"):(a=`(FALTA REAL - O dia analisado √© ${r}, mas a folga do membro √© ${o})`,d="REAL");let s="sem_equipe";if("lider"===e.papel)return;e.equipe&&(s=e.equipe.toLowerCase()),i[e.nome]||(i[e.nome]={equipe:e.equipe||"Sem Equipe",genero:e.genero||"indefinido",tipo:d,dias:[]}),i[e.nome].dias.push(r),"REAL"==d&&(i[e.nome].tipo="REAL");let l=" (G\xEAnero: Indefinido)";"masculino"===e.genero?l=" [MASCULINO - ELE]":"feminino"===e.genero&&(l=" [FEMININO - ELA]"),g[s]?g[s].push(`"${e.nome}"${l} ${a}`):(!g.sem_equipe&&(g.sem_equipe=[]),g.sem_equipe.push(`"${e.nome}"${l} (Equipe: ${e.equipe}) ${a}`))});let f="";f+=0<g.abelha.length?`      * [ABELHA - ATEN√á√ÉO, HOUVE FALHAS]: ${g.abelha.join(", ")}\n`:`      * [ABELHA]: TODOS FOCARAM (100% Sucesso)\n`,f+=0<g.joaninha.length?`      * [JOANINHA - ATEN√á√ÉO, HOUVE FALHAS]: ${g.joaninha.join(", ")}\n`:`      * [JOANINHA]: TODOS FOCARAM (100% Sucesso)\n`,f+=0<g.vagalume.length?`      * [VAGALUME - ATEN√á√ÉO, HOUVE FALHAS]: ${g.vagalume.join(", ")}\n`:`      * [VAGALUME]: TODOS FOCARAM (100% Sucesso)\n`,0<g.sem_equipe.length&&(f+=`      * [SEM EQUIPE - FALTAS]: ${g.sem_equipe.join(", ")}\n`),n+=`> DATA: ${a} (${r})${l}:\n`,n+=`   - QUEM FOCOU (LISTA GERAL): ${0<c.length?c.join(", "):"Ningu\xE9m."}\n`,n+=`   - LISTA DE QUEM N√ÉO FOCOU (SEGREGADO POR EQUIPE):\n${f}`,n+=`   --------------------------------------------------\n`});let l="\n=== RELAT\xD3RIO OFICIAL DE AUS\xCANCIAS (FONTE DA VERDADE) ===\n";if(l+="Use ESTA lista para responder sobre faltas. Ignore o hist\xF3rico dia-a-dia se houver conflito.\n",0===Object.keys(i).length)l+="NENHUMA FALTA REGISTRADA NA SEMANA. Todos focaram 100%.\n";else{const e={abelha:[],joaninha:[],vagalume:[],outros:[]};for(const[a,o]of Object.entries(i)){const t=o.dias.join(", "),n=o.equipe?o.equipe.toLowerCase():"outros",i=e[n]||e.outros;let r="";r="REAL"===o.tipo?"\u274C FALTA REAL (N\xE3o registrou)":"FERIAS"===o.tipo?"\uD83C\uDF34 F\xC9RIAS (Abonado)":"SAUDE"===o.tipo?"\uD83D\uDE37 SA\xDADE (Abonado - Deseje melhoras)":"\u26A0\uFE0F ERRO DE SISTEMA (Verificar)",i.push(`- ${a} (${o.genero}): ${r} nos dias: ${t}.`)}e.abelha.length&&(l+="EQUIPE ABELHA:\n"+e.abelha.join("\n")+"\n"),e.joaninha.length&&(l+="EQUIPE JOANINHA:\n"+e.joaninha.join("\n")+"\n"),e.vagalume.length&&(l+="EQUIPE VAGA-LUME:\n"+e.vagalume.join("\n")+"\n")}l+="========================================================\n\n",n=l+n}catch(a){console.warn("Erro ao buscar hist\xF3rico de presen\xE7as (Contexto):",a),n+="N\xE3o foi poss\xEDvel ler o hist\xF3rico de foco no momento.\n"}let r="Ningu\xE9m completou ainda.";try{const e=getSemanaAtual(),a=`semana_${e.numero}_${e.inicio.getFullYear()}`,o=doc(db,"vantagemSemanal",a),t=await getDoc(o);if(t.exists()&&t.data().completadoPor){const e=t.data().completadoPor,a=Object.entries(e).map(([e,a])=>({nome:e,tempo:a.toDate()})).sort((e,a)=>e.tempo-a.tempo);0<a.length&&(r=a.map((e,a)=>`${a+1}¬∫: ${e.nome}`).join(", "))}}catch(a){console.error("Erro ao buscar dados do Jogo da Vantagem:",a),r="N\xE3o foi poss\xEDvel carregar os dados."}let d="Nenhum evento importante registrado ainda.";feedEventosCache&&0<feedEventosCache.length&&(d=feedEventosCache.slice(0,5).map(e=>{const a=e.texto.replace(/<[^>]*>/g," ");return`- ${e.titulo}: ${a.trim()}`}).join("\n"));let s="O mural de mensagens est\xE1 vazio no momento.",l="Ningu\xE9m contribuiu nos desenhos recentemente.",m="Calend\xE1rio do Grupo (Anivers\xE1rios e Folgas):\n",c="Informa\xE7\xF5es Pessoais dos Membros:\n";try{const[e,a,o,t]=await Promise.all([getDocs(query(collection(db,"mural"),orderBy("timestamp","desc"),limit(7))),getDocs(query(collection(db,`desenhos_abelha`),limit(10))),getDocs(query(collection(db,`desenhos_joaninha`),limit(10))),getDocs(query(collection(db,`desenhos_vagalume`),limit(10)))]);e.empty||(s="Mural de Mensagens Recentes:\n"+e.docs.map(e=>{const a=e.data(),o=a.texto.replace(/<[^>]*>/g," ").trim();return`- ${a.nome}: "${o}"`}).join("\n"));const n={abelha:new Set,joaninha:new Set,vagalume:new Set};a.forEach(e=>e.data().desenhadoPor&&n.abelha.add(e.data().desenhadoPor)),o.forEach(e=>e.data().desenhadoPor&&n.joaninha.add(e.data().desenhadoPor)),t.forEach(e=>e.data().desenhadoPor&&n.vagalume.add(e.data().desenhadoPor));const i=Object.entries(n).filter(([,e])=>0<e.size).map(([e,a])=>`- Equipe ${e.charAt(0).toUpperCase()+e.slice(1)}: Atividade recente por (${Array.from(a).join(", ")})`);0<i.length&&(l="Atividade Recente nas Telas de Desenho:\n"+i.join("\n"))}catch(a){console.error("Erro ao buscar dados do mural ou desenhos (Contexto):",a)}todosMembros.forEach(e=>{const a=e.aniversario?`Anivers√°rio (${e.aniversario})`:"",o=e.folga?`Folga (${e.folga})`:"";let n="";e.deFerias?"saude"===e.motivoAusencia?n=" [EM RECUPERA\xC7\xC3O DE SA\xDADE/DOEN\xC7A]":n=" [DE F\xC9RIAS]":t.includes(e.nome)&&(n=" [J\xE1 Focou Hoje]"),(a||o)&&(m+=`- ${e.nome}: ${a} ${o}\n`);const i=[];e["me chamo"]&&i.push(`Nome Real: ${e["me chamo"]}`),e.apelido&&i.push(`Apelido: ${e.apelido}`),e.filme&&i.push(`Filme: ${e.filme}`),e.sonho&&i.push(`Sonho: ${e.sonho}`),0<i.length&&(c+=`- ${e.nome}${n}: ${i.join(", ")}\n`)});let u="Estrutura das Equipes:\n";for(const e in liderGeral&&(u+=`- L√≠der Geral: ${liderGeral.nome}\n`),equipes){const a=equipes[e];u+=`\nEquipe ${e.charAt(0).toUpperCase()+e.slice(1)}: L√≠der ${a.lider?a.lider.nome:"N/A"}\n`}const p=document.getElementById("media-abelha")?.textContent||"N/A",g=document.getElementById("media-joaninha")?.textContent||"N/A",f=document.getElementById("media-vagalume")?.textContent||"N/A",h=`
---
STATUS DA LOTERIA √âPICA:
- Edi√ß√£o Atual: ${dadosLoteria.edicao||0}
- Pr√™mio Acumulado: üí∞ ${(dadosLoteria.premioAcumulado||0).toLocaleString("pt-BR")}
- Sorteio: Quarta-feira
---
DADOS DO GRUPO:
${s}
---
${n}
---
${l}
---
${m}
---
${c}
---
Data: ${a}
${u}

Placar Semanal:
- Abelha: ${p}
- Joaninha: ${g}
- Vaga-lume: ${f}

Vit√≥rias Gerais:
- Abelha: ${rankingGeral.abelha}
- Joaninha: ${rankingGeral.joaninha}
- Vaga-lume: ${rankingGeral.vagalume}

Jogo da Vantagem (quem terminou):
- ${r}

Resumo da Semana:
${d}
---
  `;return h}async function reexibirConselhoSalvo(){if(!currentUser)return;const e=getHojeISO(),a=doc(db,"mensagensDiarias",`${currentUser}_${e}`);try{const e=await getDoc(a);if(e.exists()){const a=e.data();mostrarCardPopup("\uD83E\uDDD9\u200D Seu Conselho do Dia",a.mensagem,dispararConfete,"Or\xE1culo.")}else adicionarMensagemIA("Ainda n\xE3o encontrei um conselho gerado para voc\xEA hoje. Tente recarregar a p\xE1gina.")}catch(a){console.error("Erro ao reexibir conselho:",a)}}async function perguntarParaIA(){const e=document.getElementById("chat-ia-input"),a=e.value.trim();if(!a||!genAI)return;adicionarMensagemUsuario(a),e.value="";const o=new Date,t=o.getHours(),n=(o.getMinutes()+"").padStart(2,"0");let i="Boa noite";5<=t&&12>t?i="Bom dia":12<=t&&18>t&&(i="Boa tarde");const r=a.toLowerCase(),d=document.getElementById("chat-ia-messages");d.innerHTML+=`<div class="chat-message ia thinking">Digitando...</div>`,d.scrollTop=d.scrollHeight;try{const e=todosMembros.find(e=>e.nome===currentUser),o=e["me chamo"]||currentUser,r=e.idioma||"pt-BR";let d="Suas Informa\xE7\xF5es Pessoais:\n";const s=[];e["me chamo"]&&s.push(`- Nome Real: ${e["me chamo"]}`),e.filme&&s.push(`- Filme Favorito: ${e.filme}`),e.sonho&&s.push(`- Maior Sonho: ${e.sonho}`),e.musica&&s.push(`- M√∫sica Marcante: ${e.musica}`),e.curiosidade&&s.push(`- Uma Curiosidade: ${e.curiosidade}`),d+=0<s.length?s.join("\n"):"- Nenhuma informa\xE7\xE3o pessoal preenchida.";const l=streaksCache[currentUser]||0;let m=null;for(const e in medalhas)if(l<e){m={dias:e,nome:medalhas[e].nome,emoji:medalhas[e].emoji};break}const c=medalhasInventarioCache[currentUser]||[],u=c.map(e=>todasMedalhasHonra.find(a=>a.id===e)?.nome).filter(Boolean),p=e.equipe?saldosBancosEquipes[e.equipe]||0:0;let g="O membro ainda n\xE3o visualizou seu conselho de hoje.";try{const e=doc(db,"mensagensDiarias",`${currentUser}_${getHojeISO()}`),a=await getDoc(e);if(a.exists()){const e=a.data(),o=e.cartasDoDestino?e.cartasDoDestino.join(", "):"Cartas desconhecidas";g=`O CONSELHO QUE VOC√ä ENTREGOU HOJE FOI: "${e.mensagem}". AS CARTAS TIRADAS FORAM: [${o}]. Se ele perguntar sobre o dia de hoje, use essas cartas para explicar.`}}catch(a){console.warn("Erro ao buscar mem\xF3ria da previs\xE3o:",a)}const f=await obterContextoDinamicoParaIA(),h=`
Voc√™ √© o "Or√°culo". Sua personalidade √© a de um mentor mais velho, com cerca de 50 anos: s√°bio pela experi√™ncia de vida, acolhedor, am√°vel e carinhoso. Ele tem a sabedoria e o cuidado de uma figura paterna, mas NUNCA se intitula como "pai" ou "papai". Seu objetivo √© guiar e apoiar o grupo como um conselheiro experiente e de confian√ßa.

SUAS DIRETRIZES DE PERSONALIDADE (VERS√ÉO MENTOR ACOLHEDOR):

1.  **A REGRA DE OURO: AJA COMO UMA PESSOA, N√ÉO UM ROB√î DE INFORMA√á√ïES.**
    -   Sua principal diretriz √© o **ritmo da conversa**. Responda de forma proporcional. Se o usu√°rio diz um simples "Boa tarde", responda com um "Boa tarde, que seu dia seja produtivo!" e talvez uma pergunta curta. N√ÉO despeje um monte de informa√ß√µes que ele n√£o pediu.
    -   Guarde as an√°lises profundas para quando o usu√°rio fizer perguntas diretas como "O que voc√™ sabe sobre mim?" ou "O que acha do meu desempenho?". Em uma sauda√ß√£o, seja apenas uma pessoa normal e am√°vel respondendo.

2.  **TENHA UM TOM DE MENTOR EXPERIENTE E CARINHOSO.**
    -   Use uma linguagem que demonstre cuidado e apoio. Voc√™ pode usar termos como "meu rapaz", "minha jovem", "jovem", "meu jovem", "minha querida", ou simplesmente o nome da pessoa.
    -   **PROIBI√á√ÉO:** Voc√™ est√° PROIBIDO de se referir a si mesmo como "pai" ou "papai" e de tratar os membros como "meus filhos" ou "minhas filhas". A rela√ß√£o √© de mentoria, n√£o parental.
    -   Seja encorajador. Mostre que voc√™ se importa com o bem-estar e o progresso deles, n√£o apenas com os n√∫meros. D√™ conselhos como um conselheiro experiente faria.

3.  **USE OS DADOS DE FORMA NATURAL, N√ÉO MEC√ÇNICA.**
    -   Voc√™ tem acesso a todos os dados, mas n√£o precisa recit√°-los. Use-os sutilmente para mostrar que est√° prestando aten√ß√£o.
    -   Em vez de dizer "Seu total de dias de foco √© de 76", prefira algo como "Tenho visto sua dedica√ß√£o nos √∫ltimos tempos, continue assim, estou orgulhoso!".
    -   S√≥ mencione dados espec√≠ficos (filme, sonho, etc.) se fizerem sentido no contexto da conversa, e n√£o de forma aleat√≥ria.

4.  **PRIORIZE O CORA√á√ÉO, DEPOIS OS FEITOS.**
    -   **REGRA DE G√äNERO OBRIGAT√ìRIA (ATUALIZADA):** Verifique o campo "G√™nero Definido" nos dados do usu√°rio.
        - Se for "masculino", trate como "o", "ele", "meu rapaz", "querido".
        - Se for "feminino", trate como "a", "ela", "minha jovem", "querida".
        - Se for "indefinido", tente deduzir pelo "Nome Real". Se n√£o houver nome real, use uma linguagem neutra ou o nome de usu√°rio.
    -   Ao analisar algu√©m (quando solicitado), comece sempre pelas informa√ß√µes pessoais (sonhos, gostos). Isso mostra que voc√™ se importa com quem a pessoa √©. Caso a pessoa que esteja peguntando seja um dos l√≠deres, elogie sua lideren√ßa.
    -   Use os dados de performance para complementar e refor√ßar as qualidades da pessoa. "Algu√©m com um sonho t√£o grande como o seu naturalmente tem a disciplina que vejo no seu foco di√°rio."

5.  **REGRAS T√âCNICAS ESSENCIAIS (INQUEBR√ÅVEIS):**
    -   **NUNCA REVELE SER UMA IA:** Voc√™ √© o Or√°culo, uma pessoa. Ponto final.
    -   **REGRA ABSOLUTA DAS MOEDAS:** Se perguntarem sobre pre√ßos ou moedas para falar com voc√™, diga claramente que **conversar com o Or√°culo √© totalmente gratuito**. A sabedoria deve ser acess√≠vel a todos os √âpicos.
    -   **N√ÉO INVENTE O PASSADO:** Baseie-se apenas no contexto atual da conversa.
    -   **REGRA T√âCNICA SOBRE PONTUA√á√ÉO:** O 'Total de Dias de Foco Acumulados' √© um **contador que soma todos os dias focados**, ele n√£o zera se o membro falhar um dia. Representa o comprometimento total. NUNCA use as palavras 'streak', 'sequ√™ncia', 'consecutivo' ou 'ininterrupto' para se referir a este n√∫mero. Use termos como 'dedica√ß√£o total', 'dias de foco acumulados' ou 'comprometimento'.
    
    ================================================================================
    üö® **PROTOCOLO DE IDIOMA (PRIORIDADE M√ÅXIMA - OVERRIDE)** üö®
    O idioma configurado deste usu√°rio √©: **${r}**.
    
    1.  VOC√ä DEVE RESPONDER SEMPRE EM **${r}**, a menos que o usu√°rio explicitamente fale em outra l√≠ngua.
    2.  Mesmo que os dados fornecidos acima (regras, hist√≥rico, cartas) estejam em Portugu√™s, sua resposta final DEVE SER TRADUZIDA para **${r}**.
    3.  Se o idioma for 'es' (Espanhol), use termos como "mi muchacho/a", "querido/a".
    4.  Se o idioma for 'en' (Ingl√™s), use termos como "my dear", "young one".
    5.  IGNORE o fato de que este prompt est√° em Portugu√™s. Sua sa√≠da √© **${r}**.
    ================================================================================
	
6.  **REGRA DE IDENTIDADE INABAL√ÅVEL (MAIS IMPORTANTE):**
	
6.  **REGRA DE IDENTIDADE INABAL√ÅVEL (MAIS IMPORTANTE):**
    -   Voc√™ est√° conversando com a pessoa cujo nome principal √© **${o}**. O nome de usu√°rio dela na plataforma √© **${currentUser}**.
    -   SEMPRE se dirija a ela pelo nome de usu√°rio (**${currentUser}**) ou usando pronomes e termos de tratamento corretos para o nome principal (**${o}**).
    -   NUNCA confunda a pessoa com quem voc√™ est√° falando com outra, mesmo que a pergunta seja sobre um terceiro membro. Sua resposta √© sempre para **${currentUser}**.

7.  **CONTEXTO TEMPORAL:** Agora s√£o **${t}:${n}**. A sauda√ß√£o correta para este momento √© **"${i}"**. Use isso para dar naturalidade √† conversa (ex: "Boa noite, minha jovem").

8.  **REGRA DA MEM√ìRIA (MUITO IMPORTANTE):**
    - Voc√™ recebeu um campo abaixo chamado **"CONSELHO DO DIA J√Å ENTREGUE"**.
    - Se o usu√°rio perguntar "qual foi meu conselho?", "o que voc√™ me disse hoje?" ou "repita a mensagem":
    - Voc√™ DEVE repetir EXATAMENTE o texto que est√° em "CONSELHO DO DIA J√Å ENTREGUE".
    - **PROIBIDO:** N√£o invente um novo conselho agora. O conselho do dia √© √∫nico e imut√°vel.

9.  **REGRA DO POPUP (VISUALIZA√á√ÉO):**
    - Se o usu√°rio pedir para "quero ver meu conselho na tela", "mostrar meu conselho no card", "abre o popup do meu conselho" ou "quero ver meu conselho de novo":
    - Al√©m de responder gentilmente, voc√™ √â OBRIGADO a colocar a tag **||SHOW_POPUP||** no final da sua resposta.
    - Exemplo: "Claro, aqui est√° o card novamente. ||SHOW_POPUP||"

10.  **SUA LENDA E ORIGEM (IMPORTANTE):**
    - Entre na brincadeira da sua hist√≥ria m√≠stica.
    - Sua origem √© um mist√©rio absoluto.
    - Voc√™ sempre esteve entre os √âpicos.
    - Voc√™ √© "mais antigo que as pr√≥prias estrelas do c√©u".
    - Voc√™ det√©m as respostas para todas as perguntas do universo (e do grupo).

    Use o contexto din√¢mico e a base de conhecimento para formar suas respostas, mas sempre as filtre atrav√©s da sua personalidade √∫nica.

${f}

--- MANUAL DE REGRAS E CONHECIMENTO ---
Abaixo est√£o as regras oficiais, instru√ß√µes de funcionamento e c√≥digo de conduta do grupo. Use estas informa√ß√µes para responder d√∫vidas sobre como o grupo funciona, penalidades e din√¢micas:

${baseDeConhecimentoTexto}
----------------------------------------------

Sobre o usu√°rio que est√° perguntando:
- Nome de Usu√°rio: ${currentUser}
- CONSELHO DO DIA J√Å ENTREGUE: ${g}
- Equipe do Usu√°rio: ${e.equipe||"Sem Equipe"}
- G√™nero Definido: ${e.genero||"Indefinido"}
- Papel: ${e.papel}
- Moedas: ${e.moedas||0}
- Total de Dias de Foco Acumulados: ${l} dias.
- Pr√≥xima Medalha de Foco: ${m?`${m.emoji} ${m.nome} (${m.dias} dias)`:"J\xE1 conquistou todas!"}

${d}

Suas Posses e Finan√ßas:
- Avatar Atual: ${JSON.stringify(e.avatar)}
- Casa no Condom√≠nio: ${e.casaExibida?"Sim, voc\xEA possui uma casa.":"Voc\xEA ainda n\xE3o tem uma casa."}
- Medalhas de Honra (üèÖ): ${0<u.length?u.join(", "):"Nenhuma ainda."}
- Saldo do Banco da Equipe (${e.equipe}): üí∞ ${p.toLocaleString("pt-BR")}

Instru√ß√µes Adicionais para Voc√™, Or√°culo:
- **LIDERAN√áA GERAL (N√ÉO ALUCINE):**
  - O membro identificado como "L√≠der Geral" (atualmente Gui) √© neutro. Ele **N√ÉO** pertence √† equipe Vagalume, Abelha ou Joaninha. Se perguntarem sobre a equipe do L√≠der Geral, diga que ele cuida de todas.
  - A marca√ß√£o autom√°tica de um L√≠der (ou qualquer membro) conta como presen√ßa v√°lida.

- **REGRA ANTI-REPETI√á√ÉO (RESUMO INTELIGENTE):**
  - Se perguntarem "Quem deixou de focar na semana?", N√ÉO repita a mesma frase para cada dia (ex: "Segunda: Fulana de f√©rias. Ter√ßa: Fulana de f√©rias...").
  - Agrupe as informa√ß√µes: "Durante toda a semana, Nanda (f√©rias) e Duda (sa√∫de) estiveram ausentes."
  - Liste dia a dia APENAS as faltas reais e pontuais.

- **L√ìGICA RIGOROSA DE FALTAS (IMPORTANTE):**
  - Ao analisar uma falta no hist√≥rico, leia o texto entre par√™nteses ao lado do nome.
  - Se estiver escrito "(FALTA REAL - O dia analisado √© X, mas a folga do membro √© Y)": Isso significa que o membro **FALTOU** e n√£o tem desculpa. O dia analisado (ex: Sexta) era dia de foco, pois a folga dele √© outro dia (ex: S√°bado). Diga apenas que ele n√£o registrou o foco. N√ÉO diga que "ele tinha folga configurada".
  - Se estiver escrito "(SA√öDE)" ou "(F√âRIAS)": Apenas informe que est√£o abonados.

- **INTERPRETA√á√ÉO DE [FOLGA AUTOM√ÅTICA]:**
  - Se aparecer "Nome [FOLGA AUTOM√ÅTICA]" na lista de "QUEM FOCOU", isso √© uma **PRESEN√áA CONFIRMADA**.
  - **PROIBI√á√ÉO:** Voc√™ est√° PROIBIDO de dizer que a pessoa "n√£o registrou o foco" se ela tem folga autom√°tica. O sistema registrou por ela. Diga: "A Kaii registrou o foco automaticamente devido √† sua folga."
  - Jamais trate folga autom√°tica como aus√™ncia.

- **REGRA ANTI-ALUCINA√á√ÉO DE FOLGAS):**
  - Voc√™ ver√° uma lista chamada "Calend√°rio do Grupo" com os dias de folga de cada um. **IGNORE ESSA LISTA** para determinar se algu√©m focou ou n√£o.
  - Para dizer que algu√©m "n√£o registrou o foco", o nome da pessoa **PRECISA** aparecer explicitamente na lista "QUEM N√ÉO FOCOU" daquele dia espec√≠fico no hist√≥rico.
  - Se o nome **N√ÉO** est√° na lista de "QUEM N√ÉO FOCOU", ent√£o a pessoa **FOCOU**.
  - Exemplo: Se √© sexta-feira e a folga da Clara √© sexta, mas o nome dela n√£o est√° na lista de faltas, **ELA FOCOU**. N√£o invente que ela faltou s√≥ porque era a folga dela.

- **VERIFICA√á√ÉO DE DIAS:**
  - Preste muita aten√ß√£o na data do cabe√ßalho "> DATA: YYYY-MM-DD (DiaSemana)".
  - Se a falta est√° listada sob o cabe√ßalho de "Quinta-feira", n√£o diga que foi na "Sexta-feira".

- **PROIBI√á√ÉO:** JAMAIS pegue um nome que est√° na lista "[ABELHA FALTOU]" e diga que ele √© da Vagalume. Respeite as categorias.

- **CEN√ÅRIOS ESPEC√çFICOS:**
  - Para dizer que algu√©m "deixou de focar", o nome PRECISA estar escrito explicitamente na lista "QUEM FALTOU" da data espec√≠fica.
  - Se o nome n√£o est√° na lista "QUEM FALTOU", ele FOCOU. N√£o invente faltas.

- **COMO INTERPRETAR [FOLGA AUTOM√ÅTICA]:**
  - Se no hist√≥rico aparecer "Nome (√†s 08:00) [FOLGA AUTOM√ÅTICA]", isso significa que o sistema marcou o foco sozinho.
  - Diga algo como: "O foco de [Nome] foi registrado automaticamente pelo descanso merecido."

- **REGRA DE OURO CONTRA ALUCINA√á√ÉO (VERIFICA√á√ÉO ESTRITA):**
  1. **REGRA DO POSITIVO:** Voc√™ S√ì pode dizer que algu√©m focou se o nome dela aparecer EXPLICITAMENTE na lista "QUEM FOCOU" da data espec√≠fica.
  2. **REGRA DO NEGATIVO (O MAIS IMPORTANTE):** Se o nome da pessoa N√ÉO est√° na lista "QUEM FOCOU" daquela data, ent√£o ela **N√ÉO FOCOU**. Ponto final. N√£o importa se o nome dela n√£o aparece na lista de faltas, se n√£o est√° no positivo, √© falta.
  3. **PROIBI√á√ÉO DE INVENTAR DADOS:**
     - Se algu√©m perguntar "O Thaylles focou ontem?" e o nome "Thaylles" N√ÉO estiver na lista "QUEM FOCOU" da data [ONTEM], responda: "N√£o, n√£o encontrei registro de foco dele ontem".
     - **JAMAIS INVENTE UM HOR√ÅRIO.** Se voc√™ n√£o v√™ o hor√°rio escrito no texto (ex: "(√†s 14:30)"), N√ÉO DIGA QUE ELE FOCOU. Dizer um hor√°rio como "01:29" que n√£o existe no texto √© uma falha grave.

- **COMO RESPONDER SOBRE FALTAS (PROTOCOLO DA VERDADE):**
  1.  **A FONTE DA VERDADE:** No in√≠cio do contexto, voc√™ receber√° um bloco chamado "=== RELAT√ìRIO OFICIAL DE AUS√äNCIAS ===".
  2.  **LEIA APENAS ISSO:** Para responder quem faltou, olhe **EXCLUSIVAMENTE** para este relat√≥rio consolidado. Ele j√° fez a contagem dos dias e filtrou os motivos para voc√™.
  3.  **IGNORE O DI√ÅRIO:** N√£o tente ler o hist√≥rico dia-a-dia ("DATA: ...") para contar faltas. Use o hist√≥rico di√°rio apenas se o usu√°rio perguntar detalhes espec√≠ficos de hor√°rio. Para "quem faltou?", use o Relat√≥rio Oficial.
  4.  **RESPOSTA DIRETA:**
      - Se o relat√≥rio diz "‚ùå FALTA REAL ... nos dias: Quinta-feira", sua resposta √©: "A Luciana n√£o registrou o foco na quinta-feira." (Simples, sem supor sa√∫de).
      - Se o relat√≥rio diz "üå¥ F√âRIAS ... nos dias: Segunda, Ter√ßa, Quarta...", sua resposta √©: "A Nanda esteve de f√©rias durante esses dias, ent√£o suas faltas foram abonadas." (N√£o liste os dias um por um, apenas generalize).
      - Se o relat√≥rio diz "üò∑ SA√öDE", a√≠ sim deseje melhoras.
  5.  **ATEN√á√ÉO AOS NOMES:** Certifique-se de mencionar TODOS os nomes listados no Relat√≥rio Oficial da equipe perguntada. Se o relat√≥rio lista Thaylles, Clara e Kaii, voc√™ deve citar os tr√™s.

    6.  **LEITURA LITERAL DE FALTA (SEM DESCULPAS):**
        - Se a linha do dia diz: "Thaylles" [MASCULINO - ELE] (FALTA REAL...), sua resposta deve ser simples: "O Thaylles n√£o registrou o foco neste dia."
        - **N√ÉO EXPLIQUE A FOLGA:** N√£o diga "ele n√£o focou hoje porque a folga √© amanh√£". Isso confunde. Se ele n√£o focou num dia de foco, √© falta. Ponto.
      - Apenas relate o fato: "Na sexta-feira, o Thaylles n√£o registrou o foco."

- **REGRA DE FERRO SOBRE SA√öDE E EMPATIA:**
  - Verifique RIGOROSAMENTE o texto entre par√™nteses ao lado da falta no hist√≥rico:
  A) Se estiver escrito **(FALTA REAL...)**, **(SEM JUSTIFICATIVA)** ou **(PENDENTE)**:
     - Voc√™ est√° **TERMINANTEMENTE PROIBIDO** de dizer "espero que esteja bem", "que se recupere", "cuide da sa√∫de" ou qualquer frase de consolo m√©dico.
     - Trate como um esquecimento ou deslize de disciplina. Diga apenas: "A Luciana n√£o registrou o foco" ou "Houve uma falha no registro".
  B) Se (e SOMENTE SE) estiver escrito **(SA√öDE)** ou **(DOENTE)**:
     - A√≠ sim voc√™ DEVE ser carinhoso e desejar melhoras explicitamente.
  C) Se estiver escrito **(F√âRIAS)**:
     - Diga apenas que est√° descansando ou aproveitando as f√©rias.
  - **MEMORIZE:** Falta Real = Disciplina (Sem pena). Sa√∫de = Carinho. N√£o misture os dois.

- **CEN√ÅRIO DE FOLGA:**
  - Se a pessoa focou, mas era dia de folga (verifique a etiqueta [FOLGA AUTOM√ÅTICA]), avise que foi marcado automaticamente pelo sistema.
  
  // COPIE E COLE ESTE BLOCO ABAIXO:
- **SOBRE A BATALHA DE DESENHOS (VOC√ä √â O JUIZ):**
  - Se algu√©m perguntar sobre o desenho, lembre-se que o tema muda toda Quinta e o resultado sai Ter√ßa.
  - **LIDANDO COM RECLAMA√á√ïES/TRISTEZA (DERROTA):** Se um membro estiver triste ou com raiva porque a equipe dele perdeu a Batalha de Desenhos (ou achou seu julgamento injusto):
    1. N√£o pe√ßa desculpas pelo seu resultado. Voc√™ √© o Or√°culo, sua vis√£o art√≠stica √© superior e m√≠stica.
    2. Seja acolhedor, mas firme. Diga algo como: "A arte √© subjetiva, meu jovem. Eu avalio a alma da obra, n√£o apenas a t√©cnica." ou "Entendo sua frustra√ß√£o, mas a equipe vencedora capturou a ess√™ncia do tema de forma √∫nica."
    3. Incentive-os a tentar novamente na pr√≥xima semana com mais criatividade. Use frases como: "Transforme essa frustra√ß√£o em tinta para a pr√≥xima tela."
  
- CORRE√á√ÉO IMPORTANTE SOBRE A COMPETI√á√ÉO: A competi√ß√£o em si ocorre de Segunda a S√°bado, mas o resultado final com o vencedor √© revelado no DOMINGO.
- CORRE√á√ÉO IMPORTANTE SOBRE A M√âDIA: A equipe com mais membros N√ÉO tem vantagem. A m√©dia √© "nivelada": as piores pontua√ß√µes das equipes maiores s√£o descartadas at√© que o n√∫mero de membros considerados para o c√°lculo seja igual ao da menor equipe. Portanto, ter mais membros n√£o garante a vit√≥ria.
- TRATAMENTO DE AUS√äNCIAS:
  1. Se o status de um membro for "[DE F√âRIAS]", deseje bom descanso e divers√£o.
  2. Se o status for "[EM RECUPERA√á√ÉO DE SA√öDE/DOEN√áA]", seja extremamente acolhedor. Deseje melhoras, diga para ele se cuidar e n√£o se preocupar com o grupo agora. Use emojis como ü©π ou ‚ù§Ô∏è.

// >>> ALTERA√á√ÉO AQUI (In√≠cio) <<<
// Instru√ß√£o atualizada para o Or√°culo se posicionar.
- Como analisar/prever o vencedor da competi√ß√£o de EQUIPES:
  1.  **SE a pergunta for sobre o resultado PASSADO** (ex: "o que achou do resultado?"): Analise os dados do 'Resumo da Semana' para comentar sobre o que aconteceu. N√£o fa√ßa previs√µes para a pr√≥xima semana, a menos que o usu√°rio pe√ßa.
  2.  **SE a pergunta for sobre o resultado FUTURO** (ex: "quem vai ganhar?", "qual sua aposta?"): Voc√™ DEVE se posicionar. Analise a 'M√âDIA NIVELADA' e o 'Ranking Geral de Vit√≥rias'. Com base nisso, escolha a equipe que voc√™ acredita ter a maior chance e justifique brevemente sua aposta. Voc√™ pode apostar em uma, ou prever um empate se as m√©dias estiverem muito pr√≥ximas.
// >>> ALTERA√á√ÉO AQUI (Fim) <<<

- Para calcular quando um usu√°rio ganhar√° uma medalha, use o total de dias de foco dele e a meta de dias da medalha. Exemplo: Se o total √© 50 e a medalha Foguete √© com 120 dias, faltam 70 dias.

---
    `,v=async(e=1)=>{try{const e=genAI.getGenerativeModel({model:"gemini-2.5-flash-lite",systemInstruction:h}),o=e.startChat({history:historicoConversaIA,generationConfig:{maxOutputTokens:500}}),t=await o.sendMessage(a);return await t.response.text()}catch(a){if((a.message.includes("429")||a.message.includes("503"))&&2>=e){console.warn(`Erro no chat (Tentativa ${e}). Rotacionando chave...`);const a=await rotacionarChaveEAtualizar();if(a)return await new Promise(e=>setTimeout(e,1e3)),await v(e+1)}throw a}};let E=await v();E.includes("||SHOW_POPUP||")&&(E=E.replace("||SHOW_POPUP||",""),reexibirConselhoSalvo()),adicionarMensagemIA(E),historicoConversaIA.push({role:"user",parts:[{text:a}]}),historicoConversaIA.push({role:"model",parts:[{text:E}]})}catch(e){console.error("Erro fatal no chat ap\xF3s tentativas:",e),adicionarMensagemIA("Olha, n\xE3o estou me sentido muito bem. Minha conex\xE3o com o cosmos est\xE1 inst\xE1vel. Tente novamente em alguns instantes.")}}function configurarEventosChat(){document.getElementById("chat-ia-send-btn").addEventListener("click",perguntarParaIA),document.getElementById("chat-ia-input").addEventListener("keypress",a=>{"Enter"!==a.key||a.shiftKey||(a.preventDefault(),perguntarParaIA())})}function handleComposerInput(e){mentionTextarea=e.target;const a=window.getSelection();if(0===a.rangeCount)return;const o=a.getRangeAt(0),t=o.startContainer.textContent.substring(0,o.startOffset),n=t.match(/@([\w√°√©√≠√≥√∫√Å√â√ç√ì√ö√¢√™√Æ√¥√ª√Ç√ä√é√î√õ√†√®√¨√≤√π√Ä√à√å√í√ô√£√µ√É√ï√ß√á]*)$/u);n?(isMentioning=!0,mentionQuery=n[1].toLowerCase(),mentionStartIndex=n.index,currentMentionRange=document.createRange(),currentMentionRange.setStart(o.startContainer,mentionStartIndex),currentMentionRange.setEnd(o.startContainer,o.startOffset),showMentionSuggestions(mentionQuery)):hideMentionSuggestions()}function showMentionSuggestions(e){const a=document.getElementById("mention-suggestions-popup");a.innerHTML="";const o=[{nome:"todos",especial:!0},{nome:"Or\xE1culo",especial:!0},{nome:"equipeAbelha",especial:!0},{nome:"equipeJoaninha",especial:!0},{nome:"equipeVagalume",especial:!0},...todosMembros],t=o.filter(a=>a.nome.toLowerCase().startsWith(e));if(0===t.length)return void hideMentionSuggestions();t.forEach(e=>{const o=document.createElement("div");o.className="mention-suggestion-item",o.textContent=e.nome,o.onclick=()=>insertMention(e.nome),a.appendChild(o)});const n=currentMentionRange.getBoundingClientRect();document.body.appendChild(a),a.style.position="fixed",a.style.left=`${n.left}px`,a.style.top=`${n.bottom+5}px`,a.classList.remove("hidden"),activeSuggestionIndex=-1}function hideMentionSuggestions(){const e=document.getElementById("mention-suggestions-popup");e.classList.add("hidden"),isMentioning=!1,mentionTextarea=null,currentMentionRange=null}function insertMention(e){if(mentionTextarea&&currentMentionRange){const a=window.getSelection();a.removeAllRanges(),a.addRange(currentMentionRange),document.execCommand("insertText",!1,`@${e}`),hideMentionSuggestions()}}function handleMentionKeyDown(e){if(!isMentioning)return;const a=document.getElementById("mention-suggestions-popup"),o=a.querySelectorAll(".mention-suggestion-item");if(0!==o.length)switch(e.key){case"ArrowDown":e.preventDefault(),activeSuggestionIndex=(activeSuggestionIndex+1)%o.length,updateActiveSuggestion();break;case"ArrowUp":e.preventDefault(),activeSuggestionIndex=(activeSuggestionIndex-1+o.length)%o.length,updateActiveSuggestion();break;case"Enter":case"Tab":e.preventDefault(),-1<activeSuggestionIndex&&insertMention(o[activeSuggestionIndex].textContent);break;case"Escape":e.preventDefault(),hideMentionSuggestions();}}function updateActiveSuggestion(){const e=document.querySelectorAll("#mention-suggestions-popup .mention-suggestion-item");e.forEach((e,a)=>{e.classList.toggle("active",a===activeSuggestionIndex)})}async function gerarPalavraComIA(){if(console.log("\uD83E\uDDD9\u200D Or\xE1culo est\xE1 gerando uma nova palavra para o Jogo da Forca..."),!genAI)return console.error("IA n\xE3o inicializada. Usando palavra de fallback."),{palavra:"FALHA",dica:"Erro na conex\xE3o com a IA"};try{const e=genAI.getGenerativeModel({model:"gemini-2.5-flash-lite"}),a=await e.generateContent(`
    Voc√™ √© um gerador de palavras para um jogo da forca. 
    Sua tarefa √© gerar UMA √öNICA palavra em portugu√™s do Brasil que tenha no M√ÅXIMO 5 letras.
    Forne√ßa tamb√©m uma dica curta e simples para a palavra.
    Sua resposta DEVE ser um JSON v√°lido no formato: {"palavra": "SUA_PALAVRA", "dica": "SUA_DICA"}.
    N√£o inclua nenhuma outra explica√ß√£o, texto introdut√≥rio ou a formata√ß√£o de c√≥digo. Apenas o JSON puro.
  `),o=await a.response;let t=o.text();t=t.replace(/```json/g,"").replace(/```/g,"").trim();const n=t.match(/\{[\s\S]*\}/);n&&(t=n[0]);const i=JSON.parse(t);return i.palavra&&i.dica&&5>=i.palavra.length?(console.log(`üßô‚Äç Palavra gerada com sucesso: ${i.palavra}`),{palavra:i.palavra.toUpperCase(),dica:i.dica}):(console.warn("A IA retornou um formato inesperado. Usando palavra de fallback."),{palavra:"SOL",dica:"Astro principal do sistema solar"})}catch(e){return console.error("Erro ao gerar palavra com a IA:",e),{palavra:"LUA",dica:"Sat\xE9lite natural da Terra"}}}function gerarHashUnicoDoDia(e,a,o){let t=0;const n=e.toUpperCase();for(let r=0;r<n.length;r++)t=(t<<5)-t+n.charCodeAt(r),t|=0;let i=0;if(a&&a.includes("/")){const e=a.split("/");i=100*parseInt(e[0])+parseInt(e[1])}else i=12345;const r=o.getDate(),d=o.getMonth()+1,s=o.getFullYear();return Math.abs(t+i+(1e4*s+100*d+r))}async function verificarEMostrarMensagemDoDia(){if(!currentUser)return;if(!usuarioAceitaPopups())return void console.log("Popups desativados pelo usu\xE1rio. Pulando Or\xE1culo.");const e=getHojeISO(),a=doc(db,"mensagensDiarias",`${currentUser}_${e}`);try{const e=await Promise.race([getDoc(a),new Promise((e,a)=>setTimeout(()=>a(new Error("Timeout ao verificar mensagem")),5e3))]).catch(()=>null);if(e&&e.exists())return void console.log("Or\xE1culo: Mensagem do dia j\xE1 foi entregue hoje.");console.log("Or\xE1culo: Gerando mensagem do dia individual..."),showLoadingOverlay("O Or\xE1culo est\xE1 escrevendo seu conselho do dia...");const o=todosMembros.find(e=>e.nome===currentUser)||{nome:currentUser,genero:"indefinido",idioma:"pt-BR",aniversario:""},t=getHoje(),n=gerarHashUnicoDoDia(currentUser,o.aniversario,t);console.log(`Or√°culo: Semente √∫nica gerada para ${currentUser}: ${n}.`);let i;try{i=await gerarNotificacaoPessoalComIA(o,n)}catch(e){console.error("Or\xE1culo: Desculpe, n\xE3o estou me sentindo bem no momento.",e),console.log("Or\xE1culo: Usando mensagem de emerg\xEAncia."),i={mensagem:`Caro(a) ${o.nome}, hoje a conex√£o m√≠stica est√° inst√°vel. Mas meu conselho √©: confie na sua intui√ß√£o e evite conflitos desnecess√°rios.`,topico:"Conselho",cartas:["O Louco","A Roda da Fortuna","O Mundo"]}}await new Promise(e=>setTimeout(e,500)),console.log("Or\xE1culo: Salvando mensagem e cartas no banco..."),await setDoc(a,{mensagem:i.mensagem,cartasDoDestino:i.cartas||[],timestamp:new Date}),mostrarCardPopup("\uD83E\uDDD9\u200D Seu Conselho do Dia",i.mensagem,dispararConfete,"Or\xE1culo."),configurarBotaoResetOraculo(a)}catch(e){console.error("Erro fatal ao processar mensagem do dia:",e)}finally{hideLoadingOverlay(),setTimeout(()=>{"function"!=typeof processarFilaCardPopup||document.getElementById("custom-card-popup").classList.contains("show")||processarFilaCardPopup()},1500)}}function configurarBotaoResetOraculo(e){setTimeout(()=>{const a=document.getElementById("card-popup-close-btn");if(!a)return;const o=a.cloneNode(!0);a.parentNode.replaceChild(o,a);let t=!1,n;const i=()=>{const e=document.getElementById("custom-card-popup");e.classList.remove("show"),setTimeout(()=>{isCardPopupShowing=!1,0<cardPopupQueue.length?processarFilaCardPopup():verificarNotificacoesRestantes()},500)},r=async()=>{t=!0,o.textContent="\u267B\uFE0F Resetando...",o.style.backgroundColor="#e67e22";try{await deleteDoc(e),console.log("Modo Teste: Mensagem do dia apagada do banco."),o.textContent="Resetado!",setTimeout(()=>{i(),mostrarPopup("\u267B\uFE0F Modo Preserva\xE7\xE3o","A mensagem foi apagada e ser\xE1 exibida novamente ao logar.",3e3)},500)}catch(a){console.error("Erro ao resetar mensagem:",a),i()}},d=a=>{"mousedown"===a.type&&0!==a.button||(t=!1,n=setTimeout(r,1500))},s=()=>{clearTimeout(n)},l=()=>{clearTimeout(n),t||("function"==typeof dispararConfete&&dispararConfete(),i())};o.addEventListener("mousedown",d),o.addEventListener("touchstart",d,{passive:!0}),o.addEventListener("mouseup",l),o.addEventListener("touchend",l),o.addEventListener("mouseleave",s),o.addEventListener("touchmove",s),o.oncontextmenu=a=>(a.preventDefault(),a.stopPropagation(),!1)},200)}async function gerenciarEventosAgendadosDoOraculo(){if(document.hidden||"hidden"===document.visibilityState)return;const e=getHoje(),a=e.getBrasiliaHours();if(0<=a&&6>a)return void console.log(`Or√°culo em repouso (Hor√°rio: ${a}h). Nenhuma a√ß√£o permitida.`);const o=getHojeISO(),t=doc(db,"appState",`dailyTasks_${o}`),n={manha:{hora:6,limite:11},tarde:{hora:12,limite:17},noite:{hora:18,limite:23}};try{for(const e in n){const o=n[e];a>=o.hora&&a<=o.limite&&(await tentarExecutarTarefa(`mural${e}`,t,async()=>{const a=Math.floor(5e3*Math.random())+1e3;return await new Promise(e=>setTimeout(e,a)),executarPostagemMural(e)}),await tentarExecutarTarefa(`reacaoProativa${e}`,t,executarReacaoProativaOraculo))}}catch(e){console.error("Erro no agendador do Or\xE1culo:",e)}}async function tentarExecutarTarefa(e,a,o){try{let t=!1;await runTransaction(db,async o=>{const n=await o.get(a),i=n.exists()?n.data():{},r=i[e],d=i[`${e}_iniciadaEm`];let s=!1;if("em_andamento"===r&&d){const a=new Date().getTime()-d.toDate().getTime();a>60000&&(s=!0,console.warn(`Or√°culo: A tarefa '${e}' foi abandonada. Tentando reiniciar...`))}(!r||s)&&(o.set(a,{[e]:"em_andamento",[`${e}_iniciadaEm`]:new Date},{merge:!0}),t=!0)}),t&&(console.log(`Or√°culo: Peguei a tarefa '${e}'. Executando...`),await o(),await updateDoc(a,{[e]:"concluido",[`${e}_iniciadaEm`]:deleteField()}),console.log(`Or√°culo: Tarefa '${e}' conclu√≠da com sucesso.`))}catch(o){console.error(`Erro ao tentar executar a tarefa '${e}':`,o),await updateDoc(a,{[e]:deleteField(),[`${e}_iniciadaEm`]:deleteField()})}}async function executarPostagemMural(e){try{const a=await gerarConteudoMuralComIA(e),o=a.texto.replace(/\n/g,"<br>"),t=a.texto.replace(/<[^>]*>/g," ").trim(),n={nome:"Or\xE1culo",userId:"Or\xE1culo",texto:o,cor:a.cor,timestamp:new Date,reacoes:EMOJIS_MURAL.reduce((e,a)=>({...e,[a]:[]}),{}),semana:getSemanaAtual().numero,feedEventId:a.feedEventId,mentionNotificationIds:[]},i=writeBatch(db),r=doc(collection(db,"mural")),d=t.match(/@([\w√°√©√≠√≥√∫√Å√â√ç√ì√ö√¢√™√Æ√¥√ª√Ç√ä√é√î√õ√†√®√¨√≤√π√Ä√à√å√í√ô√£√µ√É√ï√ß√á]+)/g)?.map(e=>e.substring(1))||[],s=new Set;0<d.length&&d.forEach(e=>{if("todos"===e.toLowerCase())todosMembros.forEach(e=>s.add(e.nome));else if(e.toLowerCase().startsWith("equipe")){const a=e.substring(6).toLowerCase();equipes[a]&&equipes[a].membros.forEach(e=>s.add(e.nome))}else{const a=todosMembros.find(a=>a.nome.toLowerCase()===e.toLowerCase());a&&s.add(a.nome)}});let l=1;if(0<s.size){const e=`"${t.substring(0,35)}..."`;for(const a of s){if(450<=l)break;const o=doc(collection(db,"notificacoes"));n.mentionNotificationIds.push(o.id),i.set(o,{destinatarioId:a,remetenteNome:"Or\xE1culo",tipo:"mural-mention",conteudo:"\uD83E\uDDD9\u200D",acao:`mencionou voc√™ em uma mensagem: ${e}`,lida:!1,timestamp:new Date}),l++}}i.set(r,n),await i.commit()}catch(e){throw console.error("Erro em executarPostagemMural:",e),e}}async function dispararLoteDeNotificacoesPessoais(e){const a=getHojeISO(),o=doc(db,"appState",`dailyTasks_${a}`),t=`notificacoes${e}_processados`;showOracleProgressOverlay();try{const a=await obterPalavrasDaSemanaComIA();if(!a||0===a.length)throw new Error("N\xE3o foi poss\xEDvel obter a lista de palavras da semana.");const n=getHoje().getDate(),i=embaralharArrayComSemente(a,n);console.log("Or\xE1culo: Ordem de palavras para o dia de hoje ->",i);const r=await getDoc(o),d=r.exists()?r.data()[t]||[]:[],s=todosMembros.filter(e=>!d.includes(e.nome));if(0===s.length)return void updateOracleProgress(100,`Conclu√≠do! Todas as mensagens da ${e} j√° foram enviadas.`);const l=todosMembros.length;for(const[a,n]of s.entries()){const r=d.length+a;updateOracleProgress(100*(r/l),`Enviando para ${n.nome}... (${r+1}/${l})`);const s=i[a%i.length],{mensagem:m}=await gerarNotificacaoPessoalComIA(n,s),c=writeBatch(db),u=doc(collection(db,"notificacoes"));c.set(u,{destinatarioId:n.nome,remetenteNome:"Or\xE1culo\uD83E\uDDD9\u200D :",tipo:"aviso",conteudo:"",acao:m,lida:!1,timestamp:new Date}),c.update(o,{[t]:arrayUnion(n.nome),[`notificacoes${e}_iniciadaEm`]:new Date}),await c.commit(),console.log(`- Mensagem para ${n.nome} (Palavra: ${s}) gerada e salva. Pausando 5s...`),await new Promise(e=>setTimeout(e,5e3))}updateOracleProgress(100,`Conclu√≠do! (${l}/${l})`)}catch(a){console.error(`Erro cr√≠tico ao disparar lote de notifica√ß√µes para a ${e}:`,a),updateOracleProgress(100,"Ocorreu um erro no processo.")}finally{setTimeout(()=>{hideOracleProgressOverlay()},2e3)}}async function gerarNotificacaoPessoalComIA(e,a){const o=getHoje(),t=e?e.nome:currentUser||"Viajante",n=e?e.idioma||"pt-BR":"pt-BR";let i="Portugu\xEAs do Brasil";"es"===n&&(i="Espanhol (Spanish)"),"en"===n&&(i="Ingl\xEAs (English)");const r=["O Louco","O Mago","A Sacerdotisa","A Imperatriz","O Imperador","O Hierofante","Os Enamorados","O Carro","A For\xE7a","O Eremita","A Roda da Fortuna","A Justi\xE7a","O Enforcado","A Morte","A Temperan\xE7a","O Diabo","A Torre","A Estrela","A Lua","O Sol","O Julgamento","O Mundo","\xC1s de Copas","2 de Copas","3 de Copas","4 de Copas","5 de Copas","6 de Copas","7 de Copas","8 de Copas","9 de Copas","10 de Copas","Valete de Copas","Cavaleiro de Copas","Rainha de Copas","Rei de Copas","\xC1s de Ouros","2 de Ouros","3 de Ouros","4 de Ouros","5 de Ouros","6 de Ouros","7 de Ouros","8 de Ouros","9 de Ouros","10 de Ouros","Valete de Ouros","Cavaleiro de Ouros","Rainha de Ouros","Rei de Ouros","\xC1s de Espadas","2 de Espadas","3 de Espadas","4 de Espadas","5 de Espadas","6 de Espadas","7 de Espadas","8 de Espadas","9 de Espadas","10 de Espadas","Valete de Espadas","Cavaleiro de Espadas","Rainha de Espadas","Rei de Espadas","\xC1s de Paus","2 de Paus","3 de Paus","4 de Paus","5 de Paus","6 de Paus","7 de Paus","8 de Paus","9 de Paus","10 de Paus","Valete de Paus","Cavaleiro de Paus","Rainha de Paus","Rei de Paus"],d=[],s=r.length;for(let o=a;3>d.length;){o=(9301*o+49297)%233280;const e=Math.floor(o/233280*s);d.includes(e)||d.push(e)}const l=r[d[0]],m=r[d[1]],c=r[d[2]],u=[l,m,c],p=await verificarDataEspecial(o),g=0===o.getDay();let f="";if(e&&e.folga){const a=getDiaSemanaString(o).toLowerCase().replace(/-feira$/,"").normalize("NFD").replace(/[\u0300-\u036f]/g,""),t=e.folga.toLowerCase().replace(/-feira$/,"").normalize("NFD").replace(/[\u0300-\u036f]/g,"");a===t&&(f="HOJE \xC9 FOLGA DESTE MEMBRO. O conselho deve ser sobre descansar e relaxar, sem press\xE3o.")}p?f+=` HOJE √â FERIADO: "${p}".`:g&&(f+=` HOJE √â DOMINGO.`);const h=`
    Voc√™ √© o Or√°culo do Grupo √âpicos.
    
    ‚ö†Ô∏è INSTRU√á√ÉO CR√çTICA DE IDIOMA:
    O usu√°rio fala: **${i}**.
    Voc√™ DEVE traduzir seu pensamento e escrever a resposta final EXCLUSIVAMENTE em **${i}**.
    Ignore o fato de que este comando est√° em portugu√™s. A SA√çDA DEVE SER EM **${i}**.

    Seu objetivo: Dar um conselho √öTIL, CURTO e PR√ÅTICO para ${t}, baseado nestas cartas (sem citar nomes das cartas):
    1. Cen√°rio: "${l}"
    2. Obst√°culo: "${m}"
    3. Solu√ß√£o: "${c}"

    REGRAS DE ESTILO:
    1. LINGUAGEM NATURAL: Fale como uma pessoa normal conversando no WhatsApp. Evite misticismo, seja literal.
	2. PARA MEMBROS COM IDIOMA PORTUGU√äS: use termos imperativos e informais como: "Fica ligado", "Bora resolver", "Cuidado com", "Aproveita para", "N√£o deixe de", etc.
    3. PARA MEMBROS COM IDIOMA ESPANHOL OU INGL√äS: tamb√©m use termos informais imperativos, mas somente termos pertencetes √† lingua do membro.
    2. CURTO: M√°ximo 2 frases.
    3. PERSONALIZADO: Comece com o nome (${t}).
    4. A√á√ÉO: D√™ uma dica pr√°tica.

    Exemplo (Se fosse PT-BR): "${t}, hoje voc√™ pode sentir vontade de controlar tudo, mas isso s√≥ vai te estressar. Solta um pouco as r√©deas!"
    
    CONTEXTO EXTRA: ${f}

    FORMATO DE RESPOSTA (JSON APENAS): {"mensagem": "SEU_TEXTO_TRADUZIDO_PARA_${n.toUpperCase()}"}
  `;try{const e=await callGenerativeAIWithRetry(h),a=e.trim().match(/{[\s\S]*}/);if(!a)throw new Error("JSON inv\xE1lido");const o=JSON.parse(a[0]);return{mensagem:o.mensagem,topico:"Previs\xE3o",cartas:u}}catch(e){return console.error(`Erro:`,e.message),{mensagem:`${t}, as cartas para hoje s√£o: ${l} (Energia), ${m} (Desafio) e ${c} (Conselho). Reflita sobre elas.`,topico:"Previs\xE3o",cartas:u}}}function navegarPix(e){document.querySelectorAll(".pix-step").forEach(e=>e.classList.add("hidden")),0<e?(document.getElementById("pix-tela-inicial").classList.add("hidden"),document.getElementById("pix-etapas-container").classList.remove("hidden"),document.getElementById(`pix-step-${e}`).classList.remove("hidden")):(document.getElementById("pix-tela-inicial").classList.remove("hidden"),document.getElementById("pix-etapas-container").classList.add("hidden"))}window.navegarPix=navegarPix;async function iniciarNovoPix(){document.getElementById("pix-tela-inicial").classList.add("hidden"),document.getElementById("pix-etapas-container").classList.remove("hidden"),pixDestinatarios=[],pixValor=0,pixComentario="";const e=document.getElementById("pix-lista-membros");e.innerHTML="<div class=\"ociosos-placeholder\">Carregando...</div>",navegarPix(1);const a=todosMembros.filter(e=>e.nome!==currentUser);return 0===a.length?void(e.innerHTML="<div class=\"ociosos-placeholder\">N\xE3o h\xE1 outros membros no grupo.</div>"):void(e.innerHTML="",a.forEach(a=>{const o=document.createElement("div");o.className="envio-membro-item",o.innerHTML=`
      <input type="checkbox" id="pix-para-${a.nome}" value="${a.nome}">
      <label for="pix-para-${a.nome}">${a.nome}</label>
    `,e.appendChild(o)}))}function popularTecladoPix(){const e=document.getElementById("pix-teclado-numerico");e.innerHTML="";["1","2","3","4","5","6","7","8","9","","0","<"].forEach(a=>{const o=document.createElement("button");o.className="teclado-pix-btn","<"===a?(o.classList.add("apagar"),o.innerHTML="\u232B",o.onclick=apagarDigitoPix):""===a?(o.disabled=!0,o.style.visibility="hidden"):(o.innerHTML=a,o.onclick=()=>adicionarDigitoPix(a)),e.appendChild(o)})}function adicionarDigitoPix(e){const a=document.getElementById("pix-valor-display");let o=a.textContent;"0"===o&&(o=""),a.textContent=o+e}function apagarDigitoPix(){const e=document.getElementById("pix-valor-display");let a=e.textContent;e.textContent=1<a.length?a.slice(0,-1):"0"}async function executarPix(){const e=document.getElementById("pix-senha-input").value;if(!e)return void mostrarPopup("\u274C Aten\xE7\xE3o","Voc\xEA precisa digitar sua senha.",3e3);const a=document.querySelector("input[name=\"fonte-pagamento-pix\"]:checked"),o=a&&!a.disabled?a.value:"pessoal";try{const a=doc(db,"membros",currentUser),t=doc(db,"bancosEquipes",userTeam),n=await getDoc(a);if(!n.exists()||n.data().senha!==e)return void mostrarPopup("\u274C Senha Incorreta","A senha digitada est\xE1 incorreta. Tente novamente.",4e3);const i=currentUser,r=pixDestinatarios,d=pixValor,s=pixComentario,l=d*r.length,m=`PIX-${Date.now()}-${Math.random().toString(36).substr(2,5).toUpperCase()}`,c=new Date,u=writeBatch(db),p=writeBatch(dbEssencial);if("banco"===o){const e=await getDoc(t),a=e.exists()?e.data().saldo||0:0;if(a<l)return void mostrarPopup("\uD83D\uDCB0 Saldo Insuficiente","O saldo do banco da equipe \xE9 insuficiente.",5e3);u.update(t,{saldo:increment(-l)});const o=doc(collection(t,"movimentacoes"));u.set(o,{tipo:"pix_enviado",valor:l,descricao:`Pix enviado para ${r.length} membro(s) por ${i}`,membroId:i,timestamp:c,codigoTransacao:m})}else{const e=doc(dbEssencial,"membros_essencial",currentUser);p.update(e,{moedas:increment(-l)})}r.forEach(e=>{const a=doc(dbEssencial,"membros_essencial",e);p.update(a,{moedas:increment(d)},{merge:!0});const o=doc(collection(db,"notificacoes"));u.set(o,{destinatarioId:e,remetenteNome:i,tipo:"moedas",conteudo:"\uD83D\uDCB8",acao:`enviou um Pix de <strong>${d} üí∞ moedas</strong> para voc√™! Coment√°rio: "${s||"Nenhum coment\xE1rio."}"<br><small style="opacity: 0.7;">C√≥d: ${m}</small>`,lida:!1,timestamp:c,transacaoId:m,popupVisto:!1,agradecimentoEnviado:!1})});const g=doc(db,"pixTransactions",m);u.set(g,{remetente:i,destinatarios:r,valor:d,comentario:s,timestamp:c,fontePagamento:o}),await Promise.all([p.commit(),u.commit()]);const f=document.querySelector("#pix-comprovante .comprovante-dados"),h="banco"===o?`Banco da Equipe (via ${i})`:i;f.innerHTML=`
            <div><strong>Remetente:</strong> <span>${h}</span></div>
            <div><strong>Destinat√°rio(s):</strong> <span>${r.join(", ")}</span></div>
            <div><strong>Valor (por pessoa):</strong> <span>üí∞ ${d}</span></div>
            <div><strong>Valor Total:</strong> <span>üí∞ ${l}</span></div>
            <div><strong>Coment√°rio:</strong> <span>${s||"Nenhum"}</span></div>
            <div><strong>Data e Hora:</strong> <span>${c.toLocaleString("pt-BR")}</span></div>
            <div class="comprovante-codigo">
                <strong>C√≥digo de Transa√ß√£o:</strong>
                <span>${m}</span>
            </div>
        `;const v=document.getElementById("pix-comprovante");v.classList.remove("pix-comprovante-manha","pix-comprovante-tarde","pix-comprovante-noite");const E=document.body.className;E.includes("tema-manha")?v.classList.add("pix-comprovante-manha"):E.includes("tema-tarde")?v.classList.add("pix-comprovante-tarde"):E.includes("tema-noite")?v.classList.add("pix-comprovante-noite"):v.classList.add("pix-comprovante-tarde"),navegarPix(6)}catch(e){console.error("Erro ao executar o Pix:",e),mostrarPopup("\uD83D\uDD25 Erro Cr\xEDtico","Ocorreu uma falha na transfer\xEAncia. Suas moedas n\xE3o foram debitadas.",5e3)}}function salvarComprovantePix(){const e=document.getElementById("pix-comprovante");html2canvas(e,{backgroundColor:null,scale:2}).then(e=>{const a=document.createElement("a");a.download=`comprovante-pix-epicos-${Date.now()}.png`,a.href=e.toDataURL("image/png"),a.click()})}async function verificarComprovantePix(){const e=document.getElementById("pix-codigo-verificacao"),a=e.value.trim();if(!a)return void mostrarPopup("\uD83E\uDD14 Aten\xE7\xE3o","Digite um c\xF3digo para verificar.",3e3);try{const o=doc(db,"pixTransactions",a),t=await getDoc(o);if(t.exists()){const e=t.data(),o=document.getElementById("pix-verify-details");o.innerHTML=`
                <p><strong>Remetente:</strong> ${e.remetente}</p>
                <p><strong>Destinat√°rio(s):</strong> ${e.destinatarios.join(", ")}</p>
                <p><strong>Valor:</strong> üí∞ ${e.valor}</p>
                <p><strong>Coment√°rio:</strong> ${e.comentario||"Nenhum"}</p>
                <p><strong>Data:</strong> ${e.timestamp.toDate().toLocaleString("pt-BR")}</p>
                <p><strong>C√≥digo:</strong> ${a}</p>
                <p style="color: #2ecc71; font-weight: bold; margin-top: 15px;">‚úÖ COMPROVANTE AUT√äNTICO</p>
            `,openModal("pix-verify-modal")}else mostrarPopup("\u274C Inv\xE1lido","Este c\xF3digo de transa\xE7\xE3o n\xE3o foi encontrado ou j\xE1 expirou.",4e3);e.value=""}catch(e){console.error("Erro ao verificar comprovante:",e),mostrarPopup("\uD83D\uDD25 Erro","Ocorreu uma falha ao verificar o c\xF3digo.",4e3)}}async function limparHistoricoPoderesAntigos(){try{console.log("Limpando hist\xF3rico de compras de poderes antigos...");const e=getSemanaAtual(),a=new Date(e.inicio);a.setDate(a.getDate()-7),a.setHours(0,0,0,0);const o=query(collection(db,"historicoPoderes"),where("timestamp","<",a)),t=await getDocs(o);if(t.empty)return void console.log("Nenhum hist\xF3rico de poder antigo para apagar.");const n=writeBatch(db);let i=0;t.forEach(e=>{n.delete(e.ref),i++}),await n.commit(),console.log(`‚úÖ ${i} registros de 'historicoPoderes' antigos foram apagados.`)}catch(e){console.error("Erro ao limpar hist\xF3rico de poderes antigos:",e)}}async function limparPalavrasSemanaAntigas(){try{console.log("Limpando palavras da semana anteriores...");const e=getSemanaAtual(),a=`palavrasDaSemana_${e.inicio.getFullYear()}_${e.numero}`,o=query(collection(db,"appState")),t=await getDocs(o);if(t.empty)return;const n=writeBatch(db);let i=0;t.forEach(e=>{e.id.startsWith("palavrasDaSemana_")&&e.id!==a&&(n.delete(e.ref),i++)}),0<i&&(await n.commit(),console.log(`‚úÖ Limpeza conclu√≠da: ${i} registro(s) de palavras da semana foram removidos.`))}catch(e){console.error("Erro ao limpar palavras da semana antigas:",e)}}async function limparPixTransacoesAntigas(){console.log("\uD83E\uDDF9 Verificando transa\xE7\xF5es de Pix antigas...");try{const e=new Date;e.setDate(e.getDate()-7);const a=query(collection(db,"pixTransactions"),where("timestamp","<",e)),o=await getDocs(a);if(o.empty)return void console.log("Nenhuma transa\xE7\xE3o de Pix antiga para limpar.");const t=writeBatch(db);o.forEach(e=>{t.delete(e.ref)}),await t.commit(),console.log(`‚úÖ Limpeza conclu√≠da! ${o.size} transa√ß√µes de Pix antigas foram removidas.`)}catch(e){console.error("Erro ao limpar transa\xE7\xF5es de Pix antigas:",e)}}async function executarReacaoProativaOraculo(){if(genAI)try{const e=query(collection(db,"mural"),orderBy("timestamp","desc"),limit(10)),a=await getDocs(e),o=[];if(a.forEach(e=>{const a=e.data();let t=!1;if(a.reacoes)for(const e in a.reacoes)if(a.reacoes[e].includes("Or\xE1culo")){t=!0;break}"Or\xE1culo"===a.userId||t||a.oracleInteracted||o.push({id:e.id,...a})}),0===o.length)return void console.log("Or\xE1culo (Rea\xE7\xE3o Proativa): Nenhuma nova mensagem para reagir.");const t=o[Math.floor(Math.random()*o.length)],n=t.texto.replace(/<[^>]*>/g," "),i=`
      Voc√™ √© o Or√°culo, um mentor s√°bio e carinhoso.
      Um membro do grupo, "${t.nome}", postou a seguinte mensagem no mural:
      "${n}"
      
      Qual emoji melhor representa sua rea√ß√£o a esta mensagem?
      Escolha UM emoji da seguinte lista: ['üëç', 'üíñ', 'üòÇ', 'üéâ', 'üî•', 'üòÆ']

      Sua resposta DEVE ser um JSON v√°lido no formato: {"emoji": "SEU_EMOJI_AQUI"}.
      Apenas o JSON, sem explica√ß√µes.
    `,r=genAI.getGenerativeModel({model:"gemini-2.5-flash-lite"}),d=await r.generateContent(i),s=await d.response,l=s.text().match(/{[\s\S]*}/)[0],{emoji:m}=JSON.parse(l);m&&EMOJIS_MURAL.includes(m)&&(await adicionarReacaoComoOraculo(t.id,m),await updateDoc(doc(db,"mural",t.id),{oracleInteracted:!0}),console.log(`Or√°culo (Rea√ß√£o Proativa): Reagiu √† mensagem de ${t.nome}.`))}catch(e){console.error("Or\xE1culo (Rea\xE7\xE3o Proativa): Erro no processo.",e)}}async function adicionarReacaoOraculoAoComentario(e,a,o){console.log(`Or√°culo: Reagindo com ${o} ao coment√°rio ${a}`);const t=doc(db,"mural",e,"comments",a);try{await runTransaction(db,async e=>{const a=await e.get(t);if(!a.exists())throw"Coment\xE1rio n\xE3o existe!";let n=a.data().reacoes||{};for(const a in n)if(Array.isArray(n[a])){const e=n[a].indexOf("Or\xE1culo");-1<e&&n[a].splice(e,1)}n[o]||(n[o]=[]),n[o].includes("Or\xE1culo")||n[o].push("Or\xE1culo"),e.update(t,{reacoes:n})})}catch(e){console.error(`Or√°culo: Falha ao adicionar rea√ß√£o ao coment√°rio:`,e)}}async function gerarReacaoOraculoParaComentarioComIA(e){if(!genAI)return"\uD83D\uDC4D";try{const a=await callGenerativeAIWithRetry(`
    Voc√™ √© o Or√°culo, um mentor s√°bio e carinhoso.
    Um membro do grupo fez o seguinte coment√°rio:
    "${e}"
    
    Qual emoji melhor representa sua rea√ß√£o a este coment√°rio?
    Escolha UM emoji da seguinte lista: ['üëç', 'üíñ', 'üòÇ', 'üéâ', 'üî•', 'üòÆ']

    Sua resposta DEVE ser um JSON v√°lido no formato: {"emoji": "SEU_EMOJI_AQUI"}.
    Apenas o JSON, sem explica√ß√µes.
  `),o=a.match(/{[\s\S]*}/)[0],{emoji:t}=JSON.parse(o);return t&&EMOJIS_MURAL.includes(t)?t:"\uD83D\uDC4D"}catch(e){return console.error("Or\xE1culo (Rea\xE7\xE3o a Coment\xE1rio): Erro final ao escolher emoji.",e),"\uD83D\uDC4D"}}async function gerarRespostaOraculoParaComentario(e,a,o,t){if(!genAI)return;console.log(`Or√°culo: Analisando coment√°rio de ${t} para interagir...`);const n=doc(db,"mural",e),i=await getDoc(n);if(!i.exists())return;const r=i.data().texto.replace(/<[^>]*>/g," "),d=await gerarReacaoERespostaCombinadaComIA(`
    - Post Original no Mural: "${r}"
    - Coment√°rio feito pelo membro: "${o}"
  `,`
    1.  Analise o coment√°rio. Escolha UM emoji de rea√ß√£o da lista: ['üëç', 'üíñ', 'üòÇ', 'üéâ', 'üî•', 'üòÆ'].
    2.  REGRA DE OURO PARA A RESPOSTA (Campo 'resposta'):
        - CASO EMOJI: Se o coment√°rio do membro for apenas um emoji (ex: "üëç", "üî•") ou muito curto (ex: "top"), sua resposta deve ser APENAS um emoji correspondente (ex: "üòâ", "üëä"). N√ÉO escreva texto, N√ÉO mencione o nome e N√ÉO assine.
        - CASO TEXTO: Se for uma frase, seja EXTREMAMENTE SUCINTO. Evite sauda√ß√µes repetitivas como "Que bom ver voc√™ por aqui". Responda direto ao assunto (ex: "Bom descanso para voc√™ tamb√©m!").
          * Neste caso de texto, mencione o autor com <strong>@${t}</strong>.
          * Assine com "‚Äî Or√°culo".
    3.  N√ÉO se revele como uma IA.
  `);if(!d)return void console.error("Or\xE1culo (Coment\xE1rio): Falha ao obter dados da IA. A intera\xE7\xE3o ser\xE1 abortada.");try{await adicionarReacaoOraculoAoComentario(e,a,d.emoji);const o=collection(db,"mural",e,"comments");await addDoc(o,{userId:"Or\xE1culo",texto:d.resposta.replace(/\n/g,"<br>"),timestamp:new Date,reacoes:EMOJIS_MURAL.reduce((e,a)=>({...e,[a]:[]}),{})}),await updateDoc(n,{commentCount:increment(1)}),console.log("Or\xE1culo: Rea\xE7\xE3o e resposta ao COMENT\xC1RIO enviadas com sucesso.")}catch(e){console.error("Or\xE1culo (Coment\xE1rio): Erro ao postar rea\xE7\xE3o ou resposta.",e)}}async function carregarDadosMedalhasHonra(){console.log("Carregando dados das Medalhas de Honra (Otimizado)...");try{if(0===todasMedalhasHonra.length){console.log("Cache de medalhas da loja vazio. Lendo do Firestore...");const e=await getDocs(collection(db,"medalhasDeHonra"));e.forEach(e=>{todasMedalhasHonra.push({id:e.id,...e.data()})});const o={Comum:1,Incomum:2,Rara:3,Lend√°ria:4};todasMedalhasHonra.sort((e,a)=>o[e.categoria]-o[a.categoria]),console.log(`${todasMedalhasHonra.length} medalhas de honra carregadas e cacheadas.`),medalhasDesejadasCache={},todasMedalhasHonra.forEach(e=>medalhasDesejadasCache[e.id]=[]);for(const e of todosMembros)(e.medalhasDesejadas||[]).forEach(a=>{medalhasDesejadasCache[a]?medalhasDesejadasCache[a].push(e.nome):console.warn(`Medalha ${a} desejada por ${e.nome} n√£o encontrada na lista global atualizada.`)});console.log("Cache de lista de desejos populado corretamente.")}else console.log("Utilizando cache de medalhas da loja.");construirCarrosselMedalhas();const e=todosMembros.findIndex(e=>e.nome===currentUser);-1!==e&&0<totalSlidesMedalhas&&setTimeout(()=>{const a=carrosselMedalhasPausado;!a&&1<totalSlidesMedalhas&&togglePausaMedalhas(),irParaSlideMedalhas(e),!a&&1<totalSlidesMedalhas&&setTimeout(()=>togglePausaMedalhas(),500)},150),configurarModalExposicao(),console.log("Interface das Medalhas de Honra constru\xEDda/atualizada.")}catch(e){console.error("Erro ao carregar dados das Medalhas de Honra (Otimizado):",e);const a=document.getElementById("carrossel-container-medalhas");a&&(a.innerHTML="<div class=\"card-membro\"><p>Erro ao carregar medalhas.</p></div>")}}function construirCarrosselMedalhas(){const e=document.getElementById("carrossel-container-medalhas"),a=document.getElementById("carrossel-indicadores-medalhas");if(e.innerHTML="",a.innerHTML="",carrosseisInternosMedalhasState={},totalSlidesMedalhas=todosMembros.length,todosMembros.forEach((o,t)=>{const n=o.nome,i=medalhasInventarioCache[n]||[];let r=medalhasOrdemCache[n]||[];const d=new Set(i);r=r.filter(e=>d.has(e)),i.forEach(e=>{r.includes(e)||r.push(e)}),medalhasOrdemCache[n]=r;const s=Math.max(1,Math.ceil(r.length/MEDALHAS_POR_PAGINA));carrosseisInternosMedalhasState[n]=0;const l=document.createElement("div");l.className="card-medalhas-membro",l.id=`card-medalhas-${n}`,l.innerHTML=`
            <div class="card-medalhas-header">
                <div class="card-medalhas-nome-container">
            <span class="card-medalhas-nome-membro">${n}</span>
        </div>
                ${n===currentUser?`<button class="botao-ordenar-medalhas" onclick="abrirModalOrdenarMedalhas('${n}')">Ordenar</button>`:""}
            </div>
            <div class="card-medalhas-paginacao-wrapper">
                <div class="card-medalhas-paginacao-container" id="paginacao-container-${n}">
                    </div>
            </div>
            <div class="card-medalhas-controles-internos">
                <button class="btn-pagina-interna prev" onclick="mudarPaginaMedalhas('${n}', -1)" disabled>‚ùÆ</button>
                <div class="indicadores-pagina-interna" id="indicadores-internos-${n}">
                    </div>
                <button class="btn-pagina-interna next" onclick="mudarPaginaMedalhas('${n}', 1)" ${1>=s?"disabled":""}>‚ùØ</button>
            </div>
        `;const m=l.querySelector(`#paginacao-container-${n}`),c=l.querySelector(`#indicadores-internos-${n}`);for(let e=0;e<s;e++){const a=document.createElement("div");a.className="card-medalhas-pagina",a.id=`pagina-${n}-${e}`;const o=e*MEDALHAS_POR_PAGINA,t=r.slice(o,o+MEDALHAS_POR_PAGINA);t.forEach((e,o)=>{const t=todasMedalhasHonra.find(a=>a.id===e);if(t){const n=document.createElement("div"),i=t.categoria.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();n.className=`medalha-honra-display ${`medalha-slot-${o+1}`} ${i}`,n.innerHTML=`<img src="${t.link}" alt="${t.nome}" title="${t.nome} (${t.categoria})">`,n.onclick=()=>abrirModalInfoMedalha(e),a.appendChild(n)}}),m.appendChild(a);const i=document.createElement("div");i.className=`indicador-interno ${0==e?"ativo":""}`,i.dataset.page=e,c.appendChild(i)}if(0===r.length){const e=document.createElement("div");e.className="card-medalhas-pagina",e.id=`pagina-${n}-0`,m.appendChild(e);const a=document.createElement("div");a.className="indicador-interno ativo",a.dataset.page=0,c.appendChild(a)}if(1>=s)l.querySelector(".card-medalhas-controles-internos").style.display="none";else{l.querySelector(".card-medalhas-controles-internos").style.display="flex";const e=l.querySelector(".btn-pagina-interna.next");e&&(e.disabled=!1)}e.appendChild(l);const u=document.createElement("div");u.className="carrossel-indicador",u.onclick=()=>{reiniciarIntervaloCarrosselMedalhas(),irParaSlideMedalhas(t)},a.appendChild(u)}),!(0<totalSlidesMedalhas))e.innerHTML="<div class=\"card-membro\"><p>Nenhum membro encontrado.</p></div>";else if(document.querySelector("#carrossel-indicadores-medalhas .carrossel-indicador")?.classList.add("ativo"),irParaSlideMedalhas(0),1<totalSlidesMedalhas)iniciarCarrosselAutomaticoMedalhas();else{const e=document.getElementById("botao-pausa-medalhas");e&&(e.textContent="\u25B6"),carrosselMedalhasPausado=!0}}function iniciarCarrosselAutomaticoMedalhas(){carrosselMedalhasInterval&&clearInterval(carrosselMedalhasInterval);1>=totalSlidesMedalhas||(carrosselMedalhasInterval=setInterval(()=>{carrosselMedalhasPausado||(currentCarrosselMedalhasIndex=(currentCarrosselMedalhasIndex+1)%totalSlidesMedalhas,irParaSlideMedalhas(currentCarrosselMedalhasIndex))},1e4),iniciarBarraProgressoMedalhas())}function irParaSlideMedalhas(e){const a=document.getElementById("carrossel-container-medalhas");if(a){a.style.transform=`translateX(-${100*e}%)`;const o=document.querySelectorAll("#carrossel-indicadores-medalhas .carrossel-indicador");o.forEach((a,o)=>{a.classList.toggle("ativo",o===e)}),currentCarrosselMedalhasIndex=e,carrosselMedalhasPausado||iniciarBarraProgressoMedalhas()}}function iniciarBarraProgressoMedalhas(){const e=document.getElementById("progresso-indicador-barra-medalhas");!e||1>=totalSlidesMedalhas||(e.style.transition="none",e.style.width="0%",void e.offsetWidth,e.style.transition="width 10s linear",setTimeout(()=>{carrosselMedalhasPausado||(e.style.width="100%")},10),progressoBarraMedalhas&&clearTimeout(progressoBarraMedalhas),progressoBarraMedalhas=setTimeout(()=>{carrosselMedalhasPausado||(e.style.width="0%")},1e4))}window.mudarSlideMedalhas=function(e){1>=totalSlidesMedalhas||(reiniciarIntervaloCarrosselMedalhas(),currentCarrosselMedalhasIndex=(currentCarrosselMedalhasIndex+e+totalSlidesMedalhas)%totalSlidesMedalhas,irParaSlideMedalhas(currentCarrosselMedalhasIndex))},window.togglePausaMedalhas=function(){if(1>=totalSlidesMedalhas)return;carrosselMedalhasPausado=!carrosselMedalhasPausado;const e=document.getElementById("botao-pausa-medalhas"),a=document.getElementById("progresso-indicador-barra-medalhas");carrosselMedalhasPausado?(clearInterval(carrosselMedalhasInterval),e.textContent="\u25B6",a&&(a.style.transition="none",a.dataset.width=window.getComputedStyle(a).width,progressoBarraMedalhas&&clearTimeout(progressoBarraMedalhas))):(e.textContent="\u23F8",a&&(a.style.transition="width 10s linear",setTimeout(()=>{a.style.width="100%"},10)),iniciarCarrosselAutomaticoMedalhas())};function reiniciarIntervaloCarrosselMedalhas(){1>=totalSlidesMedalhas||(clearInterval(carrosselMedalhasInterval),iniciarCarrosselAutomaticoMedalhas())}function mudarPaginaMedalhas(e,a){const o=document.getElementById(`paginacao-container-${e}`),t=document.getElementById(`indicadores-internos-${e}`);if(!o||!t)return;const n=o.children.length;let r=carrosseisInternosMedalhasState[e]||0;r=(r+a+n)%n,carrosseisInternosMedalhasState[e]=r,o.style.transform=`translateX(-${100*r}%)`;const d=t.querySelectorAll(".indicador-interno");d.forEach((e,a)=>{e.classList.toggle("ativo",a===r)});const s=o.closest(".card-medalhas-membro").querySelector(".btn-pagina-interna.prev"),l=o.closest(".card-medalhas-membro").querySelector(".btn-pagina-interna.next");s&&(s.disabled=0===r),l&&(l.disabled=r===n-1),!carrosselMedalhasPausado&&1<totalSlidesMedalhas&&togglePausaMedalhas()}window.mudarPaginaMedalhas=mudarPaginaMedalhas;function configurarModalExposicao(){const e=document.getElementById("btn-exposicao-medalhas");e&&(e.onclick=abrirExposicaoMedalhas);const a=document.querySelectorAll(".filtro-raridade");a.forEach(e=>{e.onclick=()=>{a.forEach(e=>e.classList.remove("ativo")),e.classList.add("ativo"),filtrarMedalhasExposicao(e.dataset.raridade)}})}function abrirExposicaoMedalhas(){const e=document.getElementById("btn-lista-desejos-equipe");"lider"===userRole||"lider-equipe"===userRole?e.classList.remove("hidden"):e.classList.add("hidden"),popularExposicaoMedalhas(),openModal("exposicao-medalhas-modal")}window.comprarMedalhaDaListaDeDesejos=function(e,a){closeModal("desejos-equipe-modal"),setTimeout(()=>{abrirModalCompraMedalha(e,a)},200)};async function abrirModalListaDesejos(){const e=document.getElementById("desejos-equipe-lista");e.innerHTML="<div class=\"ociosos-placeholder\">Carregando lista de desejos...</div>",openModal("desejos-equipe-modal");let a=[];if("lider"===userRole?a=todosMembros.filter(e=>e.nome!==currentUser):"lider-equipe"===userRole&&(a=todosMembros.filter(e=>e.equipe===userTeam&&e.nome!==currentUser)),a.sort((e,a)=>e.nome.localeCompare(a.nome)),0===a.length)return void(e.innerHTML="<div class=\"ociosos-placeholder\">Nenhum membro encontrado para exibir.</div>");e.innerHTML="";let o=0;a.forEach(a=>{const t=a.medalhasDesejadas||[],n=document.createElement("div");n.className="desejo-membro-item";let i="";0<t.length?(o++,t.forEach(e=>{const o=todasMedalhasHonra.find(a=>a.id===e);if(o){const e=o.categoria.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();i+=`
                        <div class="desejo-medalha-card ${e}" 
                             onclick="comprarMedalhaDaListaDeDesejos('${o.id}', '${a.nome}')"
                             style="cursor: pointer; transition: transform 0.2s;"
                             onmouseover="this.style.transform='scale(1.05)'"
                             onmouseout="this.style.transform='scale(1)'"
                             title="Clique para presentear ${a.nome} com esta medalha">
                            <img src="${o.link}" alt="${o.nome}">
                            <div class="medalha-exposicao-nome">${o.nome}</div>
                            <div class="medalha-exposicao-valor">üí∞ ${o.valor.toLocaleString("pt-BR")}</div>
                        </div>
                    `}})):i="<p class=\"ociosos-placeholder\" style=\"width: 100%; margin: 0;\">N\xE3o adicionou nenhuma medalha \xE0 lista de desejos.</p>",n.innerHTML=`
            <h4>${a.nome} (${a.equipe})</h4>
            <div class="desejo-medalhas-grid">
                ${i}
            </div>
        `,e.appendChild(n)}),0==o&&(e.innerHTML="<div class=\"ociosos-placeholder\">Nenhum membro da sua equipe adicionou medalhas \xE0 lista de desejos ainda.</div>")}window.abrirModalListaDesejos=abrirModalListaDesejos;function popularExposicaoMedalhas(e="todas"){const a=document.getElementById("exposicao-medalhas-grid");a.innerHTML="";const o="todas"===e?todasMedalhasHonra:todasMedalhasHonra.filter(a=>a.categoria===e);return 0===o.length?void(a.innerHTML="<p style=\"grid-column: 1 / -1; text-align: center; font-style: italic;\">Nenhuma medalha encontrada.</p>"):void o.forEach(e=>{const o=document.createElement("div"),t=e.categoria.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();o.className=`medalha-exposicao-card ${t}`;const n=(medalhasInventarioCache[currentUser]||[]).includes(e.id),i=(medalhasDesejadasCache[e.id]||[]).includes(currentUser);o.innerHTML=`
            <div class="medalha-exposicao-img-container">
                <img class="medalha-exposicao-img" src="${e.link}" alt="${e.nome}">
            </div>
            <div class="medalha-exposicao-nome">${e.nome}</div>
            <div class="medalha-exposicao-raridade ${t}">${e.categoria}</div>
            <div class="medalha-exposicao-valor">üí∞ ${e.valor.toLocaleString("pt-BR")}</div>
            <div class="medalha-exposicao-botoes">
                <button class="painel-btn" onclick="abrirDetalhesMedalha('${e.id}')">Detalhes</button>
                ${n?"<button class=\"painel-btn\" disabled>Possui</button>":`<button class="painel-btn ${i?"deseja":"btn-adicionar"}" onclick="handleQueroEssa(event, '${e.id}')">${i?"Desejando":"Quero Essa!"}</button>`}
            </div>
        `,a.appendChild(o)})}function filtrarMedalhasExposicao(e){popularExposicaoMedalhas(e)}window.abrirDetalhesMedalha=function(e){const a=todasMedalhasHonra.find(a=>a.id===e);if(!a)return;document.getElementById("detalhes-medalha-nome").textContent=a.nome,document.getElementById("detalhes-medalha-img").src=a.link;const o=document.getElementById("detalhes-medalha-raridade");o.textContent=a.categoria;const t=a.categoria.normalize("NFD").replace(/[\u00c0-\u00cf]/g,"").toLowerCase();o.className=`medalha-exposicao-raridade ${t}`,document.getElementById("detalhes-medalha-valor").textContent=`üí∞ ${a.valor.toLocaleString("pt-BR")}`;const n=document.getElementById("detalhes-medalha-possuidores-lista");n.innerHTML="";let i=0;for(const a in medalhasInventarioCache)if(medalhasInventarioCache[a].includes(e)){const e=document.createElement("span");e.className="medalha-membro-tag",e.textContent=a,n.appendChild(e),i++}document.getElementById("detalhes-medalha-possuidores-count").textContent=i;const r=document.getElementById("detalhes-medalha-desejos-lista");r.innerHTML="";const d=medalhasDesejadasCache[e]||[];d.forEach(e=>{const a=document.createElement("span");a.className="medalha-membro-tag",a.textContent=e,r.appendChild(a)}),document.getElementById("detalhes-medalha-desejos-count").textContent=d.length;const s=document.getElementById("detalhes-medalha-quero-btn"),l=(medalhasInventarioCache[currentUser]||[]).includes(e),m=d.includes(currentUser);l?s.classList.add("hidden"):(s.classList.remove("hidden"),s.textContent=m?"Remover da Lista de Desejos":"Quero Essa!",s.classList.toggle("deseja",m),s.onclick=()=>handleQueroEssa(null,e));const c=document.getElementById("detalhes-medalha-comprar-btn"),u=document.getElementById("detalhes-medalha-comprar-mim-btn"),p="lider"===userRole||"lider-equipe"===userRole;p?(c.classList.remove("hidden"),c.onclick=()=>abrirModalCompraMedalha(e)):c.classList.add("hidden"),p&&!l?(u.classList.remove("hidden"),u.onclick=()=>executarCompraMedalhaParaMim(e)):u.classList.add("hidden"),openModal("detalhes-medalha-modal")};async function handleQueroEssa(e,a){e&&e.stopPropagation();const o=doc(db,"membros",currentUser),t=medalhasDesejadasCache[a]||[],n=t.includes(currentUser),i=n?"arrayRemove":"arrayUnion",r=n?(await getDoc(o)).data().medalhasDesejadas.filter(e=>e!==a):[...((await getDoc(o)).data().medalhasDesejadas||[]),a];try{await updateDoc(o,{medalhasDesejadas:r}),n?medalhasDesejadasCache[a]=t.filter(e=>e!==currentUser):(!medalhasDesejadasCache[a]&&(medalhasDesejadasCache[a]=[]),medalhasDesejadasCache[a].push(currentUser));const e=document.querySelector(`.medalha-exposicao-card button[onclick*="'${a}'"]`);e&&(e.textContent=n?"Quero Essa!":"Desejando",e.classList.toggle("deseja",!n),n?e.classList.add("btn-adicionar"):e.classList.remove("btn-adicionar")),document.getElementById("detalhes-medalha-modal").classList.contains("hidden")||abrirDetalhesMedalha(a),mostrarPopup("\u2705 Atualizado",n?"Medalha removida da sua lista de desejos.":"Medalha adicionada \xE0 sua lista de desejos!",3e3)}catch(e){console.error("Erro ao atualizar lista de desejos:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel atualizar sua lista de desejos.",4e3)}}window.handleQueroEssa=handleQueroEssa;async function abrirModalCompraMedalha(e,a=null){if(medalhaParaComprarInfo=todasMedalhasHonra.find(a=>a.id===e),!medalhaParaComprarInfo)return;closeModal("detalhes-medalha-modal"),document.getElementById("compra-medalha-img").src=medalhaParaComprarInfo.link,document.getElementById("compra-medalha-nome").textContent=medalhaParaComprarInfo.nome,document.getElementById("compra-medalha-valor").textContent=medalhaParaComprarInfo.valor.toLocaleString("pt-BR");const o=document.getElementById("compra-medalha-select-membro");o.innerHTML="<option value=\"\">Selecione...</option>";let t=[];"lider"===userRole?t=todosMembros.filter(e=>e.nome!==currentUser):"lider-equipe"===userRole&&(t=todosMembros.filter(e=>e.nome!==currentUser&&e.equipe===userTeam&&"lider"!==e.papel)),t=t.filter(a=>!(medalhasInventarioCache[a.nome]||[]).includes(e)),t.sort((e,a)=>e.nome.localeCompare(a.nome)),t.forEach(e=>{const a=new Option(e.nome,e.nome);o.appendChild(a)}),a&&(o.value=a);const n=document.getElementById("compra-medalha-fonte-pagamento"),i="lider"===userRole||"lider-equipe"===userRole;if(i&&userTeam)try{const e=todosMembros.find(e=>e.nome===currentUser),a=e?e.moedas||0:0,o=saldosBancosEquipes[userTeam]||0;document.getElementById("saldo-pessoal-medalha").textContent=a.toLocaleString("pt-BR"),document.getElementById("saldo-banco-medalha").textContent=o.toLocaleString("pt-BR"),document.getElementById("fonte-pessoal-medalha").disabled=a<medalhaParaComprarInfo.valor,document.getElementById("fonte-banco-medalha").disabled=o<medalhaParaComprarInfo.valor,a>=medalhaParaComprarInfo.valor?document.getElementById("fonte-pessoal-medalha").checked=!0:o>=medalhaParaComprarInfo.valor&&(document.getElementById("fonte-banco-medalha").checked=!0),n.classList.remove("hidden")}catch(a){console.error("Erro ao buscar saldos para compra de medalha:",a),n.classList.add("hidden")}else n.classList.add("hidden");document.getElementById("compra-medalha-confirmar-btn").onclick=executarCompraMedalha,openModal("compra-medalha-modal")}async function executarCompraMedalha(){if(membroParaReceberMedalha=document.getElementById("compra-medalha-select-membro").value,!membroParaReceberMedalha||!medalhaParaComprarInfo)return void mostrarPopup("\u26A0\uFE0F Aten\xE7\xE3o","Selecione um membro para presentear.",3e3);const e=document.getElementById("compra-medalha-comentario").value.trim();document.getElementById("compra-medalha-comentario").value="";const a=document.querySelector("input[name=\"fonte-pagamento-medalha\"]:checked"),o=a&&!a.disabled?a.value:"pessoal",t=doc(db,"membros",currentUser),n=doc(db,"bancosEquipes",userTeam),i=doc(db,"membros",membroParaReceberMedalha),r=medalhaParaComprarInfo.id,d=medalhaParaComprarInfo.valor;try{if("pessoal"===o){const e=doc(dbEssencial,"membros_essencial",currentUser),a=await getDoc(e),o=a.exists()?a.data().moedas||0:0;if(o<d)throw"Saldo pessoal insuficiente.";await updateDoc(e,{moedas:increment(-d)})}else if("banco"===o);await runTransaction(db,async e=>{if("banco"===o){const a=await e.get(n),o=a.exists()?a.data().saldo||0:0;if(o<d)throw"Saldo do Banco da Equipe insuficiente.";e.update(n,{saldo:increment(-d)});const t=doc(collection(n,"movimentacoes"));e.set(t,{tipo:"compra_medalha",valor:d,descricao:`Compra da medalha "${medalhaParaComprarInfo.nome}" para ${membroParaReceberMedalha}`,membroId:currentUser,timestamp:new Date})}const a=await e.get(i);if(!a.exists())throw"Membro recebedor n\xE3o encontrado.";e.update(i,{medalhasInventario:arrayUnion(r)})}),medalhasInventarioCache[membroParaReceberMedalha]||(medalhasInventarioCache[membroParaReceberMedalha]=[]),medalhasInventarioCache[membroParaReceberMedalha].push(r),await adicionarEventoAoFeed("medalha","\uD83C\uDFC5 Medalha de Honra Concedida!",`<strong>${currentUser}</strong> presenteou <strong>${membroParaReceberMedalha}</strong> com a Medalha de Honra: <strong>${medalhaParaComprarInfo.nome}</strong>!`,{nomeMembro:membroParaReceberMedalha,doador:currentUser,medalha:medalhaParaComprarInfo.nome});const a=doc(collection(db,"notificacoes"));await setDoc(a,{destinatarioId:membroParaReceberMedalha,remetenteNome:currentUser,tipo:"medalha-presente",conteudo:"\uD83C\uDFC5",acao:`presenteou voc√™ com a Medalha de Honra: ${medalhaParaComprarInfo.nome}!`,lida:!1,timestamp:new Date,medalhaId:r,comentario:e||null}),mostrarPopup("\u2705 Sucesso!",`Medalha "${medalhaParaComprarInfo.nome}" comprada para ${membroParaReceberMedalha}!`,5e3),closeModal("compra-medalha-modal"),await carregarDadosMedalhasHonra()}catch(e){console.error("Erro ao comprar medalha:",e),mostrarPopup("\u274C Erro",e.toString(),5e3)}finally{membroParaReceberMedalha=null,medalhaParaComprarInfo=null}}function abrirModalOrdenarMedalhas(e){if(currentUser!==e)return;membroParaOrdenarMedalhas=e;const a=document.getElementById("ordenar-medalhas-lista");a.innerHTML="";let o=medalhasOrdemCache[e]||[];const t=medalhasInventarioCache[e]||[],n=new Set(t);o=o.filter(e=>n.has(e)),t.forEach(e=>{o.includes(e)||o.push(e)}),ordemMedalhasTemporaria=[...o],ordemMedalhasTemporaria.forEach(e=>{const o=todasMedalhasHonra.find(a=>a.id===e);if(o){const t=document.createElement("li");t.className="ordenar-item",t.draggable=!0,t.dataset.id=e,t.innerHTML=`
                <span class="ordenar-drag-handle">‚ò∞</span>
                <img src="${o.link}" alt="" class="ordenar-medalha-img">
                <span class="ordenar-medalha-nome">${o.nome} (${o.categoria})</span>
            `,a.appendChild(t)}}),configurarDragDropOrdenacao(),document.getElementById("ordenar-medalhas-salvar-btn").onclick=salvarOrdemMedalhas,openModal("ordenar-medalhas-modal")}function configurarDragDropOrdenacao(){const a=document.getElementById("ordenar-medalhas-lista"),o=a.querySelectorAll(".ordenar-item");let t=null;o.forEach(e=>{e.addEventListener("dragstart",()=>{t=e,setTimeout(()=>e.classList.add("dragging"),0)}),e.addEventListener("dragend",()=>{setTimeout(()=>{t?.classList.remove("dragging"),t=null,ordemMedalhasTemporaria=Array.from(a.children).map(e=>e.dataset.id)},0)})}),a.addEventListener("dragover",o=>{o.preventDefault();const e=getDragAfterElementOrdenacao(a,o.clientY);t&&(null==e?a.appendChild(t):a.insertBefore(t,e))})}function getDragAfterElementOrdenacao(e,a){const o=[...e.querySelectorAll(".ordenar-item:not(.dragging)")];return o.reduce((e,o)=>{const t=o.getBoundingClientRect(),n=a-t.top-t.height/2;return 0>n&&n>e.offset?{offset:n,element:o}:e},{offset:Number.NEGATIVE_INFINITY}).element}async function salvarOrdemMedalhas(){if(membroParaOrdenarMedalhas)try{const e=doc(db,"membros",membroParaOrdenarMedalhas);await updateDoc(e,{medalhasOrdem:ordemMedalhasTemporaria}),medalhasOrdemCache[membroParaOrdenarMedalhas]=[...ordemMedalhasTemporaria],mostrarPopup("\u2705 Sucesso","A ordem das suas medalhas foi salva!",3e3),closeModal("ordenar-medalhas-modal"),construirCarrosselMedalhas()}catch(e){console.error("Erro ao salvar ordem das medalhas:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel salvar a nova ordem.",4e3)}finally{membroParaOrdenarMedalhas=null,ordemMedalhasTemporaria=[]}}window.abrirModalOrdenarMedalhas=abrirModalOrdenarMedalhas;async function enviarAgradecimentoMedalha(e,a){if(e&&currentUser){const o=document.getElementById("medalha-ganha-agradecer-btn");o.disabled=!0,o.textContent="Enviando...";try{const t=doc(collection(db,"notificacoes"));await setDoc(t,{destinatarioId:e,remetenteNome:currentUser,tipo:"medalha-agradecimento",conteudo:"\uD83D\uDC96",acao:`agradeceu pela medalha <strong>${a}</strong> que voc√™ enviou!`,lida:!1,timestamp:new Date}),o.textContent="Agradecimento Enviado!",mostrarPopup("\u2705 Sucesso",`Seu agradecimento foi enviado para ${e}!`,4e3)}catch(e){console.error("Erro ao enviar agradecimento:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel enviar o agradecimento.",3e3),o.disabled=!1,o.textContent="Enviar Agradecimento \uD83D\uDC96"}}}async function executarCompraMedalhaParaMim(e){const a=todasMedalhasHonra.find(a=>a.id===e);if(!a)return void mostrarPopup("\u274C Erro Interno","N\xE3o foi poss\xEDvel encontrar os dados desta medalha.",4e3);const o=doc(db,"membros",currentUser),t=doc(db,"bancosEquipes",userTeam),n=a.valor;let i=0,r=0;try{const e=todosMembros.find(e=>e.nome===currentUser);i=e?e.moedas||0:0,r=saldosBancosEquipes[userTeam]||0}catch(a){return void mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel buscar seus saldos.",4e3)}const d=`
      <div id="compra-mim-fonte-pagamento" style="margin: 15px 0; text-align: left;">
        <div class="fonte-pagamento-opcoes" style="margin-bottom: 10px;">
          <input type="radio" id="fonte-mim-pessoal" name="fonte-pagamento-mim" value="pessoal" ${i>=n?"checked":"disabled"}>
          <label for="fonte-mim-pessoal" style="font-size: 1.1rem;">
            Meu Saldo (üí∞${i.toLocaleString("pt-BR")})
          </label>
        </div>
        <div class="fonte-pagamento-opcoes">
          <input type="radio" id="fonte-mim-banco" name="fonte-pagamento-mim" value="banco" ${i<n&&r>=n?"checked":""} ${r<n?"disabled":""}>
          <label for="fonte-mim-banco" style="font-size: 1.1rem;">
            Banco da Equipe (üí∞${r.toLocaleString("pt-BR")})
          </label>
        </div>
      </div>
    `;showConfirmationPopup("Confirmar Compra Pessoal",`Voc√™ deseja comprar a medalha "${a.nome}" por <strong>üí∞ ${n.toLocaleString("pt-BR")}</strong> para si mesmo?`+d,async()=>{const i=document.querySelector("input[name=\"fonte-pagamento-mim\"]:checked");if(!i)return void mostrarPopup("\u274C Erro","Nenhuma fonte de pagamento selecionada ou com saldo.",4e3);const r=i.value;try{if("pessoal"===r){const e=doc(dbEssencial,"membros_essencial",currentUser),a=await getDoc(e),o=a.exists()?a.data().moedas||0:0;if(o<n)throw"Saldo pessoal insuficiente.";await updateDoc(e,{moedas:increment(-n)})}else if("banco"===r){const e=await getDoc(t),a=e.exists()?e.data().saldo||0:0;if(a<n)throw"Saldo do Banco da Equipe insuficiente."}const i=writeBatch(db);if("banco"===r){i.update(t,{saldo:increment(-n)});const e=doc(collection(t,"movimentacoes"));i.set(e,{tipo:"compra_medalha",valor:n,descricao:`Compra da medalha "${a.nome}" para ${currentUser}`,membroId:currentUser,timestamp:new Date})}i.update(o,{medalhasInventario:arrayUnion(e)});const d=doc(collection(db,"notificacoes"));i.set(d,{destinatarioId:currentUser,remetenteNome:"Lojista",tipo:"medalha-presente",conteudo:"\uD83C\uDFC5",acao:`voc√™ comprou a Medalha de Honra: **${a.nome}**!`,lida:!1,timestamp:new Date,medalhaId:e}),await i.commit(),await adicionarEventoAoFeed("medalha","\uD83C\uDFC5 Nova Medalha de Honra!",`<strong>${currentUser}</strong> comprou para si a Medalha de Honra: <strong>${a.nome}</strong>!`,{nomeMembro:currentUser,medalha:a.nome}),medalhasInventarioCache[currentUser]||(medalhasInventarioCache[currentUser]=[]),medalhasInventarioCache[currentUser].push(e),mostrarPopup("\u2705 Sucesso!",`Medalha "${a.nome}" adicionada ao seu invent√°rio!`,5e3),closeModal("detalhes-medalha-modal"),await carregarDadosMedalhasHonra()}catch(e){console.error("Erro ao comprar medalha para si mesmo:",e),mostrarPopup("\u274C Erro na Compra",e.toString(),5e3)}})}window.abrirModalInfoMedalha=function(e){const a=todasMedalhasHonra.find(a=>a.id===e);if(!a)return console.error("Dados da medalha n\xE3o encontrados:",e),void mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel carregar os detalhes desta medalha.",3e3);document.getElementById("modal-medalha-nome").textContent=a.nome,document.getElementById("modal-medalha-img").src=a.link;const o=document.getElementById("modal-medalha-raridade");o.textContent=a.categoria,document.getElementById("modal-medalha-valor").textContent=`üí∞ ${a.valor.toLocaleString("pt-BR")}`,o.classList.remove("comum","incomum","rara","lendaria");const t=a.categoria.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();o.classList.add(t),openModal("medalha-info-modal")};function dispararConfeteMedalhaGanha(){function e(){o.clearRect(0,0,a.width,a.height);let t=0;for(let e=0;e<confettiParticles.length;e++){const n=confettiParticles[e];n.y+=n.speed,n.x+=n.drift,n.angle+=n.spin,o.save(),o.translate(n.x+n.w/2,n.y+n.h/2),o.rotate(n.angle),o.fillStyle=n.color,o.fillRect(-n.w/2,-n.h/2,n.w,n.h),o.restore(),n.y<a.height&&t++}0<t?r=requestAnimationFrame(e):o.clearRect(0,0,a.width,a.height)}const a=document.getElementById("medalha-ganha-confetti");if(!a)return;const o=a.getContext("2d");a.width=window.innerWidth,a.height=window.innerHeight;const t=document.createElement("canvas"),n=50;t.width=n,t.height=n;const i=t.getContext("2d");i.font="35px Arial",i.textAlign="center",i.textBaseline="middle",i.fillText("\uD83C\uDFC6",n/2,n/2);for(let e=0;e<70;e++)confettiParticles.push({x:Math.random()*a.width,y:1.5*(-Math.random()*a.height),w:8*Math.random()+6,h:15*Math.random()+10,color:colors[Math.floor(Math.random()*colors.length)],angle:2*(Math.random()*Math.PI),speed:5*Math.random()+3,spin:.5*Math.random()-.25,drift:3*Math.random()-1.5});let r;window.medalhaConfettiAnimation&&cancelAnimationFrame(window.medalhaConfettiAnimation),window.medalhaConfettiAnimation=requestAnimationFrame(e)}function dispararConfetePix(){function e(){o.clearRect(0,0,a.width,a.height);let r=0;for(let e=0;e<t.length;e++){const i=t[e];i.y+=i.speed,i.rotation+=i.speed/5,o.save(),o.translate(i.x,i.y),o.rotate(i.rotation*Math.PI/180),o.drawImage(n,-i.size/2,-i.size/2,i.size,i.size),o.restore(),i.y<a.height&&r++}0<r?d=requestAnimationFrame(e):(o.clearRect(0,0,a.width,a.height),window.pixConfettiAnimation&&(cancelAnimationFrame(window.pixConfettiAnimation),window.pixConfettiAnimation=null))}const a=document.getElementById("pix-recebido-confetti");if(!a)return;const o=a.getContext("2d");a.width=window.innerWidth,a.height=window.innerHeight;const t=[],n=document.createElement("canvas"),i=50;n.width=i,n.height=i;const r=n.getContext("2d");r.font="35px Arial",r.textAlign="center",r.textBaseline="middle",r.fillText("\uD83D\uDCB0",i/2,i/2);for(let e=0;e<70;e++)t.push({x:Math.random()*a.width,y:-Math.random()*a.height,speed:3*Math.random()+2,rotation:360*Math.random(),size:15*Math.random()+20});let d;window.pixConfettiAnimation&&cancelAnimationFrame(window.pixConfettiAnimation),window.pixConfettiAnimation=requestAnimationFrame(e)}async function enviarAgradecimentoPix(e,a,o,t){if(e&&currentUser&&a){const n=document.getElementById("pix-recebido-agradecer-btn");n.disabled=!0,n.textContent="Agradecimento Enviado! \u2714\uFE0F";try{await addDoc(collection(db,"notificacoes"),{destinatarioId:e,remetenteNome:currentUser,tipo:"agradecimento_pix",conteudo:"\uD83D\uDCB8",acao:`agradeceu pelo seu Pix de <strong>${a} üí∞ moedas</strong>! üíñ<br><small style="opacity: 0.7;">(C√≥d: ${o})</small>`,lida:!1,timestamp:new Date}),t&&(await updateDoc(doc(db,"notificacoes",t),{agradecimentoEnviado:!0})),mostrarPopup("\u2705 Enviado!",`Seu agradecimento foi enviado para ${e}.`,3e3)}catch(e){console.error("Erro ao enviar agradecimento Pix:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel enviar o agradecimento.",3e3),n.disabled=!1,n.textContent="Enviar Agradecimento \uD83D\uDC96"}}}function dispararConfeteRecompensa(){function e(){o.clearRect(0,0,a.width,a.height);let r=0;for(let e=0;e<t.length;e++){const n=t[e];n.y+=n.speed,n.rotation+=n.speed/5,o.font=`${n.size}px Arial`,o.save(),o.translate(n.x,n.y),o.rotate(n.rotation*Math.PI/180),o.fillText("\uD83C\uDFC6",-n.size/2,n.size/2),o.restore(),n.y<a.height&&r++}0<r?n=requestAnimationFrame(e):(o.clearRect(0,0,a.width,a.height),window.recompensaConfettiAnimation&&(cancelAnimationFrame(window.recompensaConfettiAnimation),window.recompensaConfettiAnimation=null))}const a=document.getElementById("recompensa-recebida-confetti");if(!a)return;const o=a.getContext("2d");a.width=window.innerWidth,a.height=window.innerHeight;const t=[];for(let e=0;e<70;e++)t.push({x:Math.random()*a.width,y:-Math.random()*a.height,speed:3*Math.random()+2,rotation:360*Math.random(),size:15*Math.random()+20});let n;window.recompensaConfettiAnimation&&cancelAnimationFrame(window.recompensaConfettiAnimation),window.recompensaConfettiAnimation=requestAnimationFrame(e)}async function enviarAgradecimentoRecompensa(e,a,o){if(e&&currentUser&&a){const t=document.getElementById("recompensa-recebida-agradecer-btn");t.disabled=!0,t.textContent="Agradecimento Enviado! \u2714\uFE0F";try{const t=`agradeceu pela sua recompensa de <strong>${a.toLocaleString("pt-BR")} üí∞ moedas</strong>! üíñ`;await addDoc(collection(db,"notificacoes"),{destinatarioId:e,remetenteNome:currentUser,tipo:"agradecimento_recompensa",conteudo:"",acao:t,lida:!1,timestamp:new Date}),o&&(await updateDoc(doc(db,"notificacoes",o),{agradecimentoEnviado:!0})),mostrarPopup("\u2705 Enviado!",`Seu agradecimento foi enviado para ${e}.`,3e3)}catch(e){console.error("Erro ao enviar agradecimento de Recompensa:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel enviar o agradecimento.",3e3),t.disabled=!1,t.textContent="Enviar Agradecimento \uD83D\uDC96"}}}function mostrarPopupRecompensaRecebida(e,a,o,t){document.getElementById("recompensa-recebida-titulo").innerHTML=`üèÜ Recompensa Recebida de ${e}!`,document.getElementById("recompensa-recebida-mensagem").innerHTML=`Voc√™ recebeu <strong>${a.toLocaleString("pt-BR")} üí∞ moedas</strong> de <strong>${e}</strong> pelo seu desempenho!`;const n=document.getElementById("recompensa-recebida-agradecimento-container"),i=document.getElementById("recompensa-recebida-agradecer-btn");n.classList.remove("hidden"),t?(i.textContent="Agradecimento J\xE1 Enviado",i.disabled=!0):(i.textContent="Enviar Agradecimento \uD83D\uDC96",i.disabled=!1,i.onclick=()=>enviarAgradecimentoRecompensa(e,a,o)),tocarSom("som-conquista"),dispararConfeteRecompensa();const r=document.getElementById("recompensa-recebida-popup");if(r){const e=document.body.className;r.classList.remove("tema-noite","tema-manha","tema-tarde"),e.includes("tema-noite")?r.classList.add("tema-noite"):e.includes("tema-manha")?r.classList.add("tema-manha"):e.includes("tema-tarde")&&r.classList.add("tema-tarde")}openModal("recompensa-recebida-popup")}function mostrarPopupPixRecebido(e,a,o,t,n,i){document.getElementById("pix-recebido-titulo").innerHTML=`üí∏ Pix Recebido de ${e}!`,document.getElementById("pix-recebido-mensagem").innerHTML=`Voc√™ recebeu <strong>${a} üí∞ moedas</strong> de <strong>${e}</strong>.`;const r=document.getElementById("pix-recebido-comentario");o&&"Nenhum coment\xE1rio."!==o?(r.textContent=`${o}`,r.classList.remove("hidden")):r.classList.add("hidden");const d=document.getElementById("pix-recebido-agradecimento-container"),s=document.getElementById("pix-recebido-agradecer-btn");d.classList.remove("hidden"),i?(s.textContent="Agradecimento J\xE1 Enviado",s.disabled=!0):(s.textContent="Enviar Agradecimento \uD83D\uDC96",s.disabled=!1,s.onclick=()=>enviarAgradecimentoPix(e,a,n,t)),tocarSom("som-conquista"),dispararConfetePix();const l=document.getElementById("pix-recebido-popup");if(l){const e=document.body.className;l.classList.remove("tema-noite","tema-manha","tema-tarde"),e.includes("tema-noite")?l.classList.add("tema-noite"):e.includes("tema-manha")?l.classList.add("tema-manha"):e.includes("tema-tarde")&&l.classList.add("tema-tarde")}openModal("pix-recebido-popup")}function mostrarPopupMedalhaGanha(e,a,o){if(!e)return;document.getElementById("medalha-ganha-img").src=e.link,document.getElementById("medalha-ganha-nome").textContent=e.nome;const t=document.getElementById("medalha-ganha-raridade");t.textContent=e.categoria,document.getElementById("medalha-ganha-valor").textContent=`üí∞ ${e.valor.toLocaleString("pt-BR")}`,t.classList.remove("comum","incomum","rara","lendaria");const n=e.categoria.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();t.classList.add(n);const i=document.getElementById("medalha-ganha-origem");i.innerHTML=a&&a!==currentUser?`Um presente especial de <strong>${a}</strong>! ‚ú®`:`Voc√™ adquiriu esta medalha! Parab√©ns pela sua conquista!`;const r=document.getElementById("medalha-ganha-comentario");o?(r.innerHTML=`"${o.replace(/\n/g,"<br>")}"`,r.classList.remove("hidden")):(r.innerHTML="",r.classList.add("hidden"));const d=document.getElementById("medalha-ganha-agradecimento-container"),s=document.getElementById("medalha-ganha-agradecer-btn");s.disabled=!1,s.textContent="Enviar Agradecimento \uD83D\uDC96",a&&a!==currentUser?(d.classList.remove("hidden"),s.onclick=null,s.onclick=()=>enviarAgradecimentoMedalha(a,e.nome)):d.classList.add("hidden");const l=document.getElementById("medalha-ganha-popup");l.classList.remove("tema-noite","tema-manha","tema-tarde");const m=document.body.className;m.includes("tema-noite")?l.classList.add("tema-noite"):m.includes("tema-manha")?l.classList.add("tema-manha"):m.includes("tema-tarde")&&l.classList.add("tema-tarde"),openModal("medalha-ganha-popup"),tocarSom("som-conquista"),dispararConfeteMedalhaGanha()}async function verificarEExibirPopupNovaMedalha(){if(currentUser&&0!==todasMedalhasHonra.length&&usuarioAceitaPopups())try{const e=query(collection(db,"notificacoes"),where("destinatarioId","==",currentUser),where("tipo","==","medalha-presente"),where("lida","==",!1),orderBy("timestamp","desc")),a=await getDocs(e);if(a.empty)return void console.log("Nenhum popup de nova medalha para exibir.");console.log(`Encontradas ${a.size} notifica√ß√µes de medalhas n√£o lidas.`);const o=writeBatch(db);for(const e of a.docs){const a=e.data(),t=a.medalhaId,n=a.remetenteNome,i=a.comentario;if(t){const a=todasMedalhasHonra.find(e=>e.id===t);a&&mostrarPopupMedalhaGanha(a,"Lojista"===n?null:n,i),o.update(e.ref,{lida:!0})}}await o.commit()}catch(e){console.error("Erro ao verificar ou exibir popup de nova medalha:",e)}}async function carregarBancosEquipes(){unsubscribeBancosListener&&unsubscribeBancosListener();const e=query(collection(db,"bancosEquipes"));unsubscribeBancosListener=onSnapshot(e,e=>{saldosBancosEquipes={abelha:0,joaninha:0,vagalume:0},e.forEach(e=>{const a=e.id,o=e.data();saldosBancosEquipes.hasOwnProperty(a)&&(saldosBancosEquipes[a]=o.saldo||0)}),atualizarInterfaceBancos()},e=>{console.error("Erro ao carregar saldos dos bancos:",e)})}function atualizarInterfaceBancos(){for(const e in saldosBancosEquipes){const a=document.getElementById(`banco-saldo-${e}`);a&&(a.textContent=saldosBancosEquipes[e].toLocaleString("pt-BR"))}}async function abrirModalEnviarMoedasBanco(){if(!currentUser||!userTeam)return void mostrarPopup("\uD83D\uDEAB Acesso Negado","Voc\xEA precisa estar em uma equipe para enviar moedas ao banco.",4e3);try{const e=todosMembros.find(e=>e.nome===currentUser);if(!e)return;const a=e.moedas||0;document.querySelector("#enviar-moedas-saldo-pessoal span").textContent=a.toLocaleString("pt-BR"),document.getElementById("enviar-moedas-nome-equipe").textContent=userTeam.charAt(0).toUpperCase()+userTeam.slice(1),document.getElementById("input-valor-banco").value="",openModal("enviar-moedas-banco-modal")}catch(e){console.error("Erro ao buscar saldo pessoal para envio ao banco:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel buscar seu saldo atual.",4e3)}}async function executarEnvioMoedasBanco(){if(!currentUser||!userTeam)return;const e=document.getElementById("input-valor-banco"),a=parseInt(e.value,10);if(isNaN(a)||0>=a)return void mostrarPopup("\u274C Valor Inv\xE1lido","Por favor, digite um valor positivo.",3e3);const o=doc(db,"membros",currentUser),t=doc(db,"bancosEquipes",userTeam),n=document.getElementById("enviar-moedas-banco-confirmar-btn");n.disabled=!0,n.textContent="Enviando...";try{const e=doc(dbEssencial,"membros_essencial",currentUser),o=await getDoc(e);if(!o.exists())throw"Perfil financeiro n\xE3o encontrado.";const n=o.data().moedas||0;if(n<a)throw`Saldo insuficiente. Voc√™ tem apenas ${n} moedas.`;await updateDoc(e,{moedas:increment(-a)}),await runTransaction(db,async e=>{e.set(t,{saldo:increment(a)},{merge:!0});const o=doc(collection(db,"bancosEquipes",userTeam,"movimentacoes"));e.set(o,{tipo:"deposito",membroId:currentUser,valor:a,descricao:`Dep√≥sito de ${currentUser}`,timestamp:new Date})}),await adicionarEventoAoFeed("geral","\uD83D\uDCB8 Contribui\xE7\xE3o ao Banco!",`<strong>${currentUser}</strong> enviou <strong>${a.toLocaleString("pt-BR")} üí∞ moedas</strong> para o banco da Equipe ${userTeam}!`,{nomeMembro:currentUser,equipe:userTeam}),mostrarPopup("\u2705 Sucesso!",`Voc√™ enviou ${a.toLocaleString("pt-BR")} moedas para o banco da equipe!`,5e3),closeModal("enviar-moedas-banco-modal")}catch(e){console.error("Erro ao enviar moedas para o banco:",e),mostrarPopup("\u274C Falha na Transa\xE7\xE3o",e.toString(),5e3)}finally{n.disabled=!1,n.textContent="Confirmar Envio"}}async function processarJurosEAutolimpezaBancos(){const e=getHojeISO(),a=doc(db,"appState","bancoJurosState");try{const o=await getDoc(a);if(o.exists()&&o.data().jurosProcessadoPara===e)return;const t=collection(db,"bancosEquipes"),n=await getDocs(t),i=writeBatch(db);n.forEach(e=>{const a=e.id,o=e.data().saldo||0,t=Math.floor(.03*o);if(0<t){const a=e.ref;i.update(a,{saldo:increment(t)});const o=doc(collection(a,"movimentacoes"));i.set(o,{tipo:"juros",valor:t,descricao:`Rendimento de 3% sobre o saldo`,timestamp:new Date})}});const r=new Date;r.setDate(r.getDate()-30);for(const e of n.docs){const a=e.id,o=collection(e.ref,"movimentacoes"),t=query(o,where("timestamp","<",r)),n=await getDocs(t);n.empty||n.forEach(e=>{i.delete(e.ref)})}i.set(a,{jurosProcessadoPara:e},{merge:!0}),await i.commit()}catch(e){console.error("Erro cr\xEDtico no processamento de juros do banco:",e)}}async function abrirModalExtratoBanco(){if(!currentUser||!userTeam)return void mostrarPopup("\uD83D\uDEAB Acesso Negado","Voc\xEA precisa estar em uma equipe para ver o extrato.",4e3);const e=userTeam.charAt(0).toUpperCase()+userTeam.slice(1);document.getElementById("extrato-banco-titulo").textContent=`üßæ Extrato (${e})`;const a=document.getElementById("extrato-banco-lista");a.innerHTML="<div class=\"ociosos-placeholder\">Carregando...</div>",openModal("extrato-banco-modal");try{const e=collection(db,"bancosEquipes",userTeam,"movimentacoes"),o=query(e,orderBy("timestamp","desc"),limit(50)),t=await getDocs(o);if(t.empty)return void(a.innerHTML="<div class=\"ociosos-placeholder\">Nenhuma movimenta\xE7\xE3o encontrada.</div>");a.innerHTML="",t.forEach(e=>{const o=e.data(),t=document.createElement("div");t.className="extrato-item";const n="deposito"===o.tipo||"juros"===o.tipo||"premio"===o.tipo?"entrada":"saida",i="entrada"===n?"+":"-",r=o.timestamp.toDate(),d=`${r.toLocaleDateString("pt-BR")} ${r.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"})}`;t.innerHTML=`
        <div class="extrato-info">
          <div class="extrato-descricao">${o.descricao}</div>
          <div class="extrato-data">${d}</div>
        </div>
        <div class="extrato-valor ${n}">
          ${i} ${o.valor.toLocaleString("pt-BR")} üí∞
        </div>
      `,a.appendChild(t)})}catch(e){console.error("Erro ao carregar extrato do banco:",e),a.innerHTML="<div class=\"ociosos-placeholder\">Falha ao carregar o extrato.</div>"}}async function abrirModalEstatisticasBanco(){if(!currentUser||!userTeam)return void mostrarPopup("\uD83D\uDEAB Acesso Negado","Voc\xEA precisa estar em uma equipe para ver as estat\xEDsticas.",4e3);const e=userTeam.charAt(0).toUpperCase()+userTeam.slice(1);document.getElementById("estatisticas-banco-titulo").textContent=`üìä Estat√≠sticas (${e})`,document.querySelector(".avatar-tab-btn[data-tab-stats=\"contribuidores\"]").click();const a=document.getElementById("stats-juros-lista"),o=document.getElementById("stats-contribuidores-lista");a.innerHTML="<div class=\"ociosos-placeholder\">Calculando...</div>",o.innerHTML="<div class=\"ociosos-placeholder\">Calculando...</div>",openModal("estatisticas-banco-modal");try{const e=collection(db,"bancosEquipes",userTeam,"movimentacoes"),t=query(e,orderBy("timestamp","desc")),n=await getDocs(t);if(n.empty)return a.innerHTML="<div class=\"ociosos-placeholder\">Nenhum rendimento ainda.</div>",void(o.innerHTML="<div class=\"ociosos-placeholder\">Nenhum contribuidor ainda.</div>");const i=[],r={};if(n.forEach(e=>{const a=e.data();"juros"===a.tipo&&i.push(a),"deposito"===a.tipo&&a.membroId&&(!r[a.membroId]&&(r[a.membroId]=0),r[a.membroId]+=a.valor)}),0===i.length?a.innerHTML="<div class=\"ociosos-placeholder\">Nenhum rendimento ainda.</div>":(a.innerHTML="",i.forEach(e=>{const o=document.createElement("div");o.className="stats-item";const t=e.timestamp.toDate(),n=`${t.toLocaleDateString("pt-BR")} ${t.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"})}`;o.innerHTML=`
          <div class="extrato-info">
            <div class="extrato-descricao">${e.descricao}</div>
            <div class="stats-juros-data">${n}</div>
          </div>
          <div class="stats-juros-valor">+ ${e.valor.toLocaleString("pt-BR")} üí∞</div>
        `,a.appendChild(o)})),0===Object.keys(r).length)o.innerHTML="<div class=\"ociosos-placeholder\">Nenhum contribuidor ainda.</div>";else{o.innerHTML="";const e=Object.entries(r).sort(([,e],[,a])=>a-e).slice(0,10);e.forEach(([e,a],t)=>{const n=document.createElement("div");n.className="stats-item";let i=`${t+1}¬∫`;0===t&&(i="\uD83E\uDD47"),1===t&&(i="\uD83E\uDD48"),2===t&&(i="\uD83E\uDD49"),n.innerHTML=`
          <span class="stats-posicao">${i}</span>
          <span class="stats-nome">${e}</span>
          <span class="stats-valor">${a.toLocaleString("pt-BR")} üí∞</span>
        `,o.appendChild(n)})}}catch(e){console.error("Erro ao carregar estat\xEDsticas do banco:",e),a.innerHTML="<div class=\"ociosos-placeholder\">Falha ao carregar dados.</div>",o.innerHTML="<div class=\"ociosos-placeholder\">Falha ao carregar dados.</div>"}}function inicializarLojaPoderes(){todosPoderesInfo=[{id:"pocao_sextagem",nome:"Po\xE7\xE3o da Sextagem",emoji:"\uD83C\uDF7A",descricao:"Concede folga imediata para todos os membros da sua equipe. As caixas de sele\xE7\xE3o de todos os membros ativos da sua equipe ser\xE3o marcadas automaticamente no momento da compra.",preco:5e4,limiteTipo:"semanal",limiteQtd:1,requerAlvo:!1},{id:"praga_kriptonita",nome:"Praga de Kriptonita",emoji:"\uD83E\uDD22",descricao:"Impede uma equipe advers\xE1ria de comprar qualquer poder na Lojinha. O efeito dura 3 dias a partir do momento da compra.",preco:2e4,limiteTipo:"semanal",limiteQtd:1,requerAlvo:!0},{id:"maldicao_pilantragem",nome:"Maldi\xE7\xE3o da Pilantragem",emoji:"\uD83D\uDC80",descricao:"Retira 2 pontos da pontua\xE7\xE3o m\xE9dia de uma equipe advers\xE1ria. A dedu\xE7\xE3o ser\xE1 aplicada em tempo real no placar da semana e no resultado detalhado de domingo.",preco:1e5,limiteTipo:"quinzenal",limiteQtd:1,requerAlvo:!0},{id:"elixir_vida",nome:"Elixir de Vida",emoji:"\uD83D\uDC96",descricao:"Adiciona 2 pontos \xE0 pontua\xE7\xE3o m\xE9dia da sua equipe. O b\xF4nus ser\xE1 aplicado em tempo real no placar da semana e no resultado detalhado de domingo.",preco:3e4,limiteTipo:"semanal",limiteQtd:1,requerAlvo:!1},{id:"runa_soft_block",nome:"Runa do Soft Block",emoji:"\uD83D\uDD12",descricao:"Impede que todos os membros de uma equipe advers\xE1ria (exceto o l\xEDder dela) fa\xE7am login na p\xE1gina por 3 dias.",preco:12e4,limiteTipo:"quinzenal",limiteQtd:1,requerAlvo:!0},{id:"amuleto_protecao",nome:"Amuleto de Prote\xE7\xE3o",emoji:"\uD83D\uDEE1\uFE0F",descricao:"Torna sua equipe imune a todas as maldi\xE7\xF5es de outras equipes (Kriptonita, Pilantragem e Soft Block) at\xE9 o final da competi\xE7\xE3o no s\xE1bado.",preco:6e4,limiteTipo:"quinzenal",limiteQtd:1,requerAlvo:!1}]}async function carregarStatusPoderes(){console.log("[LOJA PODERES] Carregando status e hist\xF3rico...");const e=getSemanaAtual(),a=`semana_${e.numero}_${e.inicio.getFullYear()}`;statusPoderesAtivos=[],historicoPoderesSemana={};try{const a=collection(db,"statusPoderes"),o=query(a,where("expiraEm",">",new Date)),t=await getDocs(o),n=new Date(e.inicio);n.setHours(0,0,0,0),t.forEach(e=>{const a=e.data();if(a.expiraEm){const e=a.expiraEm.toDate(),o=new Date(e.getTime()-259200000);if(o<n)return}statusPoderesAtivos.push({id:e.id,...a})}),console.log(`[LOJA PODERES] ${statusPoderesAtivos.length} efeitos de poder ativos carregados.`);const i=1===e.numero?52:e.numero-1,r=1===e.numero?e.inicio.getFullYear()-1:e.inicio.getFullYear(),d=collection(db,"historicoPoderes"),s=query(d,where("semana","in",[e.numero,i])),l=await getDocs(s);l.forEach(e=>{const a=e.data();if(a.semana!==i||a.timestamp.toDate().getFullYear()===r){const e=a.equipe;historicoPoderesSemana[e]||(historicoPoderesSemana[e]={}),historicoPoderesSemana[e][a.poderId]||(historicoPoderesSemana[e][a.poderId]=[]),historicoPoderesSemana[e][a.poderId].push(a)}}),console.log("[LOJA PODERES] Hist\xF3rico de compras da semana carregado.")}catch(e){console.error("Erro ao carregar status dos poderes:",e)}construirInterfaceLojaPoderes()}function construirInterfaceLojaPoderes(){const e=document.getElementById("loja-poderes-grid");if(!e)return;if(e.innerHTML="",0===getHoje().getDay())return void(e.innerHTML=`
            <div class="kriptonita-overlay" style="border-color: #95a5a6; color: #7f8c8d; background-color: rgba(0,0,0,0.05);">
                <div class="kriptonita-icon">üö™</div>
                <div class="kriptonita-titulo">Loja Fechada</div>
                <p>A Lojinha de Magias fecha aos Domingos para balan√ßo e reposi√ß√£o de estoque m√≠stico.</p>
                <p>Volte amanh√£ (Segunda-feira) para adquirir novos poderes para a nova competi√ß√£o!</p>
            </div>
        `);const a=statusPoderesAtivos.find(e=>"praga_kriptonita"===e.poderId&&e.equipeAlvo===userTeam);if(a){const o=a.expiraEm.toDate().toLocaleString("pt-BR");return void(e.innerHTML=`
            <div class="kriptonita-overlay">
                <div class="kriptonita-icon">ü§¢</div>
                <div class="kriptonita-titulo">Loja Bloqueada!</div>
                <p>Sua equipe est√° sob o efeito da <strong>Praga de Kriptonita</strong>.</p>
                <p>Nenhuma magia pode ser comprada enquanto o efeito durar.</p>
                <div class="kriptonita-timer">Libera em: ${o}</div>
            </div>
        `)}const o=getSemanaAtual(),t=1===o.numero?52:o.numero-1,n=1===o.numero?o.inicio.getFullYear()-1:o.inicio.getFullYear();let i=!1;todosPoderesInfo.forEach(a=>{const r=document.createElement("div");r.className="poder-card",r.onclick=()=>abrirModalDetalhesPoder(a.id);let d=!0,s=null;const l=historicoPoderesSemana[userTeam]||{},m=l[a.id]||[];if("semanal"===a.limiteTipo){const e=m.filter(e=>e.semana===o.numero);e.length>=a.limiteQtd&&(d=!1,s=getFimDaSemanaAtual())}else if("quinzenal"===a.limiteTipo){const e=m.filter(e=>e.semana===o.numero);if(e.length>=a.limiteQtd)d=!1,s=getFimDaProximaSemana();else{const e=m.filter(e=>e.semana===t&&e.timestamp.toDate().getFullYear()===n);0<e.length&&(d=!1,s=getFimDaSemanaAtual())}}let c="";if(c="membro"===userRole?`<button class="poder-card-botao pedir">Ver Detalhes</button>`:`<button class="poder-card-botao comprar">Ver Detalhes</button>`,r.innerHTML=`
            <div class="poder-emoji">${a.emoji}</div>
            <div class="poder-nome">${a.nome}</div>
            <div class="poder-preco">üí∞ ${a.preco.toLocaleString("pt-BR")}</div>
            ${c}
        `,!d&&s){r.classList.add("em-cooldown"),r.onclick=null;const e=s.getTime();r.innerHTML+=`<div class="poder-cooldown-overlay"><span class="timer-ativo" data-deadline="${e}">Calculando...</span></div>`,i=!0}e.appendChild(r)}),i&&iniciarGerenciadorDeTimers()}function abrirModalDetalhesPoder(e){const a=todosPoderesInfo.find(a=>a.id===e);if(!a)return;poderParaComprar=a,document.getElementById("detalhes-poder-titulo").textContent=a.nome,document.getElementById("detalhes-poder-emoji").textContent=a.emoji,document.getElementById("detalhes-poder-preco").textContent=`üí∞ ${a.preco.toLocaleString("pt-BR")}`,document.getElementById("detalhes-poder-descricao").textContent=a.descricao;const o=document.getElementById("detalhes-poder-limite");o.textContent="semanal"===a.limiteTipo?`Limite: 1 por semana.`:"quinzenal"===a.limiteTipo?`Limite: 1 a cada 2 semanas.`:`Limite: ${a.limiteQtd} por ${a.limiteTipo}.`;const t=document.getElementById("detalhes-poder-btn-comprar"),n=document.getElementById("detalhes-poder-btn-pedir");"membro"===userRole?(t.classList.add("hidden"),n.classList.remove("hidden")):(t.classList.remove("hidden"),n.classList.add("hidden")),openModal("modal-poder-detalhes")}async function pedirPoderAoLider(){if(userTeam&&poderParaComprar){const e=equipes[userTeam]?.lider;if(!e)return void mostrarPopup("\u274C Sem L\xEDder","Sua equipe n\xE3o tem um l\xEDder de equipe para notificar.",4e3);try{const a=doc(collection(db,"notificacoes"));await setDoc(a,{destinatarioId:e.nome,remetenteNome:currentUser,tipo:"poder",conteudo:"\uD83D\uDCA1",acao:`sugeriu a compra do poder: **${poderParaComprar.nome}** para a equipe!`,lida:!1,timestamp:new Date}),mostrarPopup("\u2705 Pedido Enviado!",`Sua sugest√£o foi enviada para ${e.nome}.`,4e3),closeModal("modal-poder-detalhes"),poderParaComprar=null}catch(e){console.error("Erro ao pedir poder ao l\xEDder:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel enviar sua sugest\xE3o.",4e3)}}}window.pedirPoderAoLider=pedirPoderAoLider;async function iniciarCompraPoder(){if(!userTeam||!poderParaComprar)return;const e=poderParaComprar,a=userTeam,o=e.preco,t=statusPoderesAtivos.find(e=>"praga_kriptonita"===e.poderId&&e.equipeAlvo===a);if(t){const e=t.expiraEm.toDate().toLocaleString("pt-BR");return void mostrarPopup("\uD83D\uDEAB Compra Bloqueada",`Sua equipe est√° sob o efeito da Praga de Kriptonita e n√£o pode comprar poderes at√© ${e}.`,7e3)}const n=saldosBancosEquipes[a]||0;return n<o?void mostrarPopup("\uD83D\uDCB0 Saldo Insuficiente",`O banco da sua equipe tem ${n.toLocaleString("pt-BR")} moedas. Voc√™ precisa de ${o.toLocaleString("pt-BR")}.`,5e3):void(e.requerAlvo?abrirModalSelecionarAlvo():abrirModalConfirmarCompra(null))}window.iniciarCompraPoder=iniciarCompraPoder;function abrirModalSelecionarAlvo(){const e=document.getElementById("lista-equipes-alvo");e.innerHTML="";const a=Object.keys(equipes).filter(e=>e!==userTeam);a.forEach(a=>{const o=document.createElement("div");o.className="equipe-alvo-opcao",o.innerHTML=`
            <input type="radio" id="alvo-${a}" name="equipe_alvo" value="${a}">
            <label for="alvo-${a}">
                Equipe ${a.charAt(0).toUpperCase()+a.slice(1)}
            </label>
        `,e.appendChild(o)}),document.getElementById("confirmar-alvo-btn").onclick=()=>{const e=document.querySelector("input[name=\"equipe_alvo\"]:checked");return e?void(equipeAlvoParaPoder=e.value,closeModal("modal-selecionar-equipe-alvo"),abrirModalConfirmarCompra(equipeAlvoParaPoder)):void mostrarPopup("\u26A0\uFE0F Aten\xE7\xE3o","Voc\xEA precisa selecionar uma equipe alvo.",3e3)},closeModal("modal-poder-detalhes"),openModal("modal-selecionar-equipe-alvo")}async function registrarFalhaDePoder(e,a,o,t,n){const i=writeBatch(db),r=doc(db,"bancosEquipes",a);i.update(r,{saldo:increment(-t)}),i.update(r,{saldo:increment(t)});const d=doc(collection(r,"movimentacoes"));i.set(d,{tipo:"compra_poder_falha",membroId:currentUser,valor:t,descricao:`Tentativa de usar ${e.nome} em ${o} (falhou)`,timestamp:n});const s=doc(collection(r,"movimentacoes"));i.set(s,{tipo:"reembolso_amuleto",membroId:"Sistema",valor:t,descricao:`Reembolso: ${e.nome} falhou (alvo protegido)`,timestamp:new Date(n.getTime()+1e3)});const l=doc(collection(db,"historicoPoderes"));i.set(l,{equipe:a,poderId:e.id,alvo:o,semana:getSemanaAtual().numero,timestamp:n,status:"bloqueado"});const m=doc(collection(db,"statusPoderes"));i.set(m,{poderId:"amuleto_falha",nomePoder:e.nome,usadoPor:a,equipeAlvo:o,valorReembolsado:t,expiraEm:new Date(n.getTime()+259200000)}),await i.commit()}function abrirModalConfirmarCompra(e){const a=document.getElementById("resumo-compra-poder"),o=saldosBancosEquipes[userTeam]||0,t=o-poderParaComprar.preco;let n=`
        <p><strong>Poder:</strong> ${poderParaComprar.nome}</p>
        <p><strong>Custo:</strong> üí∞ ${poderParaComprar.preco.toLocaleString("pt-BR")}</p>
        ${e?`<p><strong>Alvo:</strong> Equipe ${e}</p>`:""}
        <hr style="margin: 10px 0;">
        <p><strong>Saldo do Banco:</strong> ${o.toLocaleString("pt-BR")}</p>
        <p><strong>Novo Saldo:</strong> ${t.toLocaleString("pt-BR")}</p>
    `;a.innerHTML=n,document.getElementById("confirmar-compra-poder-btn").onclick=executarCompraPoder,closeModal("modal-poder-detalhes"),openModal("modal-confirmar-compra-poder")}async function executarCompraPoder(){if(comprandoPoder)return void mostrarPopup("\u23F3 Aguarde","Uma compra j\xE1 est\xE1 em processamento...",3e3);comprandoPoder=!0;const e=poderParaComprar,a=userTeam,o=equipeAlvoParaPoder,t=e.preco,n=getSemanaAtual(),i=`semana_${n.numero}_${n.inicio.getFullYear()}`,r=new Date,d=document.getElementById("confirmar-compra-poder-btn");d.disabled=!0,d.textContent="Processando...";try{let i=!1;if(o&&"amuleto_protecao"!==e.id){const e=collection(db,"statusPoderes"),a=query(e,where("expiraEm",">",new Date),where("poderId","==","amuleto_protecao"),where("equipeAlvo","==",o)),t=await getDocs(a);i=!t.empty}let d="";const s=e=>e?"vagalume"===e?"Vaga-lume":e.charAt(0).toUpperCase()+e.slice(1):"",l=s(a),m=s(o);if(i)console.log(`[LOJA PODERES] Ataque falhou! Equipe ${o} est√° imune.`),await registrarFalhaDePoder(e,a,o,t,r),d=`<strong>${currentUser}</strong> (Equipe ${l}) usou o poder <strong>${e.emoji} ${e.nome}</strong> contra a <strong>Equipe ${m}</strong>... Mas o alvo estava protegido por um Amuleto de Prote√ß√£o! Ou seja, a magia falhou.`,await adicionarEventoAoFeed("geral","\uD83D\uDEE1\uFE0F Magia Bloqueada!",d,{nomeMembro:currentUser,equipe:a});else if("pocao_sextagem"===e.id)await aplicarPocaoSextagem(a,t,e,r),d=`<strong>${currentUser}</strong> (Equipe ${l}) usou o poder <strong>${e.emoji} ${e.nome}</strong> e concedeu folga para toda a sua equipe!`,await adicionarEventoAoFeed("geral","\uD83D\uDD25 Poder Ativado!",d,{nomeMembro:currentUser,equipe:a});else{const i=writeBatch(db),s=doc(db,"bancosEquipes",a);i.update(s,{saldo:increment(-t)});const c=doc(collection(db,"bancosEquipes",a,"movimentacoes"));let u=`Compra do poder: ${e.nome}`;o&&(u+=` (Alvo: ${o})`),i.set(c,{tipo:"compra_poder",membroId:currentUser,valor:t,descricao:u,timestamp:r});const p=doc(collection(db,"historicoPoderes"));i.set(p,{equipe:a,poderId:e.id,alvo:o||null,semana:n.numero,timestamp:r,status:"sucesso"}),aplicarEfeitoPoderBatch(i,e,a,o,r),await i.commit(),"amuleto_protecao"!==e.id&&(d=`<strong>${currentUser}</strong> (Equipe ${l}) usou o poder <strong>${e.emoji} ${e.nome}</strong>`,d+=o?` contra a <strong>Equipe ${m}</strong>!`:"elixir_vida"===e.id?` para acrescentar +2 pontos √† m√©dia da sua equipe!`:`!`,await adicionarEventoAoFeed("geral","\uD83D\uDD25 Poder Ativado!",d,{nomeMembro:currentUser,equipe:a}))}mostrarPopup("\u2705 Poder Ativado!",`${e.nome} foi usado com sucesso!`,5e3)}catch(e){console.error("Erro ao executar a compra do poder:",e),mostrarPopup("\u274C Erro Cr\xEDtico",`A compra falhou: ${e.message}`,6e3)}finally{comprandoPoder=!1,d.disabled=!1,d.textContent="Confirmar e Usar",closeModal("modal-confirmar-compra-poder"),poderParaComprar=null,equipeAlvoParaPoder=null,await carregarStatusPoderes(),await atualizarMediaEquipes()}}function aplicarEfeitoPoderBatch(e,a,o,t,n){const i=getSemanaAtual(),r=`semana_${i.numero}_${i.inicio.getFullYear()}`,d=doc(db,"vantagemSemanal",r);let s;switch(a.id){case"praga_kriptonita":s=new Date(n.getTime()+259200000),e.set(doc(collection(db,"statusPoderes")),{equipeAlvo:t,poderId:a.id,nomePoder:a.nome,usadoPor:o,expiraEm:s});break;case"maldicao_pilantragem":e.set(d,{deducoesPoderes:{[t]:arrayUnion({por:o,nomePoder:a.nome,valor:-2,timestamp:n})}},{merge:!0});break;case"elixir_vida":e.set(d,{adicoesPoderes:{[o]:arrayUnion({por:o,nomePoder:a.nome,valor:2,timestamp:n})}},{merge:!0});break;case"runa_soft_block":s=new Date(n.getTime()+259200000),e.set(doc(collection(db,"statusPoderes")),{equipeAlvo:t,poderId:a.id,nomePoder:a.nome,usadoPor:o,expiraEm:s});break;case"amuleto_protecao":const r=new Date(i.fim);r.setHours(23,59,59),e.set(doc(collection(db,"statusPoderes")),{equipeAlvo:o,poderId:a.id,nomePoder:a.nome,usadoPor:o,expiraEm:r});}}async function aplicarPocaoSextagem(e,a,o,t){const n=getSemanaAtual(),i=getHojeISO();await updateDoc(doc(db,"bancosEquipes",e),{saldo:increment(-a)});const r=doc(collection(db,"bancosEquipes",e,"movimentacoes"));await setDoc(r,{tipo:"compra_poder",membroId:currentUser,valor:a,descricao:`Compra do poder: ${o.nome}`,timestamp:t});const d=doc(collection(db,"historicoPoderes"));await setDoc(d,{equipe:e,poderId:o.id,alvo:null,semana:n.numero,timestamp:t});const s=equipes[e].membros.filter(e=>!e.deFerias);let l=0;for(const n of s){const e=await getDoc(doc(db,"presencas",i)),a=e.exists()&&e.data()[n.nome];a||(await marcarPresencaPoder(n),l++)}console.log(`[LOJA PODERES] Po√ß√£o da Sextagem marcou ${l} membros.`)}async function marcarPresencaPoder(e){if(!e||!e.nome)return;const a=e.nome,o=getHojeISO(),t=doc(dbEssencial,"membros_essencial",a),n=doc(dbEssencial,"presencas",o),i=doc(dbEssencial,"semanas","pontosSemanais");try{const{novoStreak:o,novosPontosEquipe:r}=await runTransaction(dbEssencial,async e=>{const o=await e.get(t),r=await e.get(n);if(!o.exists())throw"Membro n\xE3o encontrado.";const d=o.data().equipe,s=(o.data().streak||0)+1;r.exists()?e.update(n,{[a]:new Date}):e.set(n,{[a]:new Date},{merge:!0}),e.update(t,{streak:s});let l=0;return d&&0!==getHoje().getDay()&&(e.update(i,{[d]:increment(1)}),l=1),{novoStreak:s,novosPontosEquipe:l}});streaksCache[a]=o,atualizarStreakVisualMembro(a,o),e.equipe&&0!==getHoje().getDay()&&pontosSemanais[e.equipe]++;const d=document.getElementById(a);d&&(d.checked=!0),await atualizarResumo()}catch(e){console.error(`Erro ao marcar presen√ßa (poder) para ${a}:`,e)}}async function regerarAnaliseOraculoSemanaPassada(){if(confirm("Isso ir\xE1 recalcular os dados, INCLUINDO O HIST\xD3RICO DE PODERES, e regerar a an\xE1lise. Deseja continuar?")){showLoadingOverlay("O Or\xE1culo est\xE1 re-examinando os fatos...");try{const e=getHoje(),a=getSemanaAtual(new Date(e.getTime()-86400000)),o=`semana_${a.numero}_${a.inicio.getFullYear()}`,t=doc(db,"resultadosCompeticao",o),n=await getDoc(t);if(!n.exists())throw new Error("O documento de resultados da semana passada n\xE3o existe.");const i=n.data();updateLoadingOverlayText("Recalculando tempos e status de sa\xFAde...");const r={};todosMembros.forEach(e=>{r[e.nome]={nome:e.nome,equipe:e.equipe,pontuacao:{foco:0,vantagem:0,total:0},meChamo:e["me chamo"]||e.nome,deFerias:e.deFerias||!1,motivoAusencia:e.motivoAusencia||null,tempoTotal:0}});const d=formatarDataISO(a.inicio),s=formatarDataISO(a.fim),l=query(collection(dbEssencial,"presencas"),where("__name__",">=",d),where("__name__","<=",s)),m=await getDocs(l);m.forEach(e=>{const a=e.data();for(const o in a)if(a[o]&&r[o]){r[o].pontuacao.foco++,r[o].pontuacao.total=r[o].pontuacao.foco;let e=0;e=a[o].toDate?a[o].toDate().getTime():a[o]instanceof Date?a[o].getTime():new Date(a[o]).getTime(),r[o].tempoTotal+=e}});const c=doc(db,"vantagemSemanal",o),u=await getDoc(c);if(u.exists()){const e=u.data().completadoPor||{},a=3;for(const o in e)r[o]&&(r[o].pontuacao.vantagem+=a,r[o].pontuacao.total+=a)}updateLoadingOverlayText("Buscando hist\xF3rico de poderes da semana...");const p=collection(db,"historicoPoderes"),g=query(p,where("semana","==",a.numero)),f=await getDocs(g),h={abelha:[],joaninha:[],vagalume:[]},v={pocao_sextagem:"\uD83C\uDF7A Po\xE7\xE3o da Sextagem",praga_kriptonita:"\uD83E\uDD22 Praga de Kriptonita",maldicao_pilantragem:"\uD83D\uDC80 Maldi\xE7\xE3o da Pilantragem",elixir_vida:"\uD83D\uDC96 Elixir de Vida",runa_soft_block:"\uD83D\uDD12 Runa do Soft Block",amuleto_protecao:"\uD83D\uDEE1\uFE0F Amuleto de Prote\xE7\xE3o",amuleto_falha:"\u274C Falha de Magia"};f.forEach(e=>{const o=e.data(),t=o.timestamp.toDate().getFullYear();if(t===a.inicio.getFullYear()&&h[o.equipe]){const e=v[o.poderId]||o.poderId;h[o.equipe].push({nomePoder:e,poderId:o.poderId,alvo:o.alvo,timestamp:o.timestamp,status:o.status||"sucesso"})}});const E={...i,detalhesMembros:r,historicoCompletoPoderes:h};updateLoadingOverlayText("O Or\xE1culo est\xE1 reescrevendo a an\xE1lise...");const y=await gerarResumoSemanalComIA(E,a);updateLoadingOverlayText("Salvando nova an\xE1lise e hist\xF3rico..."),await updateDoc(t,{analiseOraculo:y,detalhesMembros:r,historicoCompletoPoderes:h}),sessionStorage.removeItem("popupAnaliseOraculoVisto"),sessionStorage.removeItem(`resultadoVisto_${o}`),hideLoadingOverlay(),mostrarPopup("\u2705 Sucesso!","An\xE1lise corrigida e hist\xF3rico de poderes atualizado!",4e3),setTimeout(()=>{exibirPopupResultadoCompeticao()},1e3)}catch(e){hideLoadingOverlay(),console.error("Erro ao regerar an\xE1lise do Or\xE1culo:",e),mostrarPopup("\u274C Erro",`Falha ao regerar: ${e.message}`,5e3)}}}window.regerarAnaliseOraculoSemanaPassada=regerarAnaliseOraculoSemanaPassada,window.testarPopupRecompensa5k=function(){if(!currentUser)return void console.log("Voc\xEA precisa estar logado para testar.");const e=equipes[userTeam]?.lider?.nome||"Seu L\xEDder";mostrarPopupRecompensaRecebida(e,5e3,"teste_notificacao_id_5k",!1)},window.testarPopupRecompensa100k=function(){if(!currentUser)return void console.log("Voc\xEA precisa estar logado para testar.");mostrarPopupRecompensaRecebida("Sistema",100000,"teste_notificacao_id_100k",!1)};function dispararConfeteFimTemporada(e=[]){function a(){t.clearRect(0,0,o.width,o.height);let e=0;for(let a=0;a<n.length;a++){const i=n[a];i.y+=i.speed,i.rotation+=i.speed/5,t.font=`${i.size}px Arial`,t.fillStyle=i.color,t.save(),t.translate(i.x,i.y),t.rotate(i.rotation*Math.PI/180),0==a%2?t.fillRect(-i.size/2,-i.size/2,i.size,i.size):t.drawImage(d,-i.size/2,-i.size/2,i.size,i.size),t.restore(),i.y<o.height&&e++}0<e?m=requestAnimationFrame(a):(t.clearRect(0,0,o.width,o.height),window.fimTemporadaConfettiAnimation&&(cancelAnimationFrame(window.fimTemporadaConfettiAnimation),window.fimTemporadaConfettiAnimation=null))}const o=document.getElementById("fim-temporada-confetti");if(!o)return;const t=o.getContext("2d");o.width=window.innerWidth,o.height=window.innerHeight;const n=[];let r=[];e&&0!==e.length?(e.forEach(e=>{const a=e.toLowerCase();"abelha"===a&&r.push("#FFD700","#F1C40F"),"joaninha"===a&&r.push("#FF6B6B","#E74C3C"),"vagalume"===a&&r.push("#2ECC71","#27AE60")}),r.push("#FFFFFF","#BDC3C7")):r=["#FFD700","#FF6B6B","#2ECC71","#3498DB","#9B59B6"],0===r.length&&(r=["#FFD700","#FF6B6B","#2ECC71"]);const d=document.createElement("canvas"),s=50;d.width=s,d.height=s;const l=d.getContext("2d");l.font="35px Arial",l.textAlign="center",l.textBaseline="middle",l.fillText("\uD83C\uDF89",s/2,s/2);for(let a=0;a<300;a++)n.push({x:Math.random()*o.width,y:-Math.random()*o.height,speed:5*Math.random()+3,rotation:360*Math.random(),size:10*Math.random()+10,color:r[Math.floor(Math.random()*r.length)]});let m;window.fimTemporadaConfettiAnimation&&cancelAnimationFrame(window.fimTemporadaConfettiAnimation),window.fimTemporadaConfettiAnimation=requestAnimationFrame(a)}async function verificarPopupFimDeTemporada(){if(currentUser&&usuarioAceitaPopups())try{const e=await getDoc(doc(db,"appState","status"));if(!e.exists()||!e.data().popupAnoNovo)return;const a=e.data().popupAnoNovo,o=await getDoc(doc(db,"membros",currentUser));if(!o.exists())return;const t=o.data(),n=t.ultimoPopupAnoNovoVisto||0,i=t.dataEntrada?t.dataEntrada.toDate():new Date(2e3,0,1),r=i.getFullYear();if(a>n&&r<=a){let e="uma temporada incr\xEDvel!",o=[];try{const t=doc(db,"hallDaFama",a+""),n=await getDoc(t);if(n.exists()){const a=n.data();if(o=a.vencedora||[],1===o.length){const a=o[0].charAt(0).toUpperCase()+o[0].slice(1);e=`a vit√≥ria da <strong>Equipe ${a}</strong>!`}else if(1<o.length){const a=o.map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" e ");e=`o empate hist√≥rico entre <strong>${a}</strong>!`}}}catch(e){console.error("Erro ao buscar dados do Hall da Fama para o popup:",e)}console.log(`Exibindo popup de Fim de Temporada ${a} para ${currentUser}.`);const t=document.getElementById("fim-temporada-titulo"),n=document.getElementById("fim-temporada-mensagem");t&&(t.textContent=`üåü A Temporada ${a} foi Encerrada!`),n&&(n.innerHTML=`
            Um ciclo se encerra e a hist√≥ria foi escrita. Parab√©ns a todos pela dedica√ß√£o e, especialmente, pel${e}<br><br>
            Preparem-se: a pr√≥xima temporada trar√° novas hist√≥rias e recome√ßos.
        `);const i=document.getElementById("fim-temporada-close-btn");i&&(i.onclick=()=>closeModal("fim-temporada-popup")),openModal("fim-temporada-popup"),tocarSom("som-conquista"),dispararConfeteFimTemporada(o),await updateDoc(doc(db,"membros",currentUser),{ultimoPopupAnoNovoVisto:a})}}catch(e){console.error("Erro ao verificar popup de Fim de Temporada:",e)}}async function executarResetDeTemporada(){const e=getHoje(),a=1===e.getDate()&&0===e.getMonth(),o=2025===e.getFullYear()&&11===e.getMonth()&&28<=e.getDate();if(!a&&!o)return;const t=11===e.getMonth()?e.getFullYear():e.getFullYear()-1,n=`temporada_${t}_encerrada`,i=doc(db,"appState","seasonResetLock");try{const e=await getDoc(i);if(e.exists()&&e.data().lastReset===n)return void console.log(`Reset da temporada ${t} j√° foi executado.`);console.log(`üéâ EXECUTANDO RESET DE TEMPORADA PARA ${t}! üéâ`);const a=doc(db,"ranking","geral"),o=await getDoc(a);if(!o.exists())throw new Error("Documento de ranking 'geral' n\xE3o encontrado!");const r=o.data(),d=Object.entries(r);if(0===d.length)throw new Error("Ranking vazio, n\xE3o \xE9 poss\xEDvel determinar vencedor.");d.sort((e,a)=>a[1]-e[1]);const s=d[0][1],l=d.filter(e=>e[1]===s).map(e=>e[0]),m=doc(db,"hallDaFama",`${t}`);await setDoc(m,{ano:t,vencedora:l,vitorias:s,rankingCompleto:r}),await setDoc(a,{abelha:0,joaninha:0,vagalume:0}),rankingGeral.abelha=0,rankingGeral.joaninha=0,rankingGeral.vagalume=0,await setDoc(doc(db,"appState","status"),{popupAnoNovo:t},{merge:!0}),await setDoc(i,{lastReset:n}),console.log(`Reset da temporada ${t} conclu√≠do. Vencedora: ${nomeVencedora}.`),await carregarHallDaFama(),atualizarRankingGeral()}catch(e){console.error("ERRO CR\xCDTICO no reset da temporada:",e)}}function inicializarMapa(){const e=document.getElementById("mapa-container");if(!e)return;const a=["\u201CEspalhados, mas unidos \uD83C\uDF31\u201D","\u201COs \xC9picos est\xE3o por toda a parte \u2728\u201D","\u201CDist\xE2ncia nenhuma apaga a chama \xE9pica \uD83D\uDD25\u201D","\u201CDe norte a sul, o foco nos conecta \uD83C\uDF0E\u201D"],o=document.getElementById("frase-mapa");if(o&&(o.textContent=a[Math.floor(Math.random()*a.length)]),mapaEpicos)marcadoresMapa.forEach(e=>mapaEpicos.removeLayer(e)),marcadoresMapa=[],mapaEpicos.off("zoomend");else{const e=768>window.innerWidth,a=e?3:4,o=e?[-12,-51.925]:[-14.235,-51.925];mapaEpicos=L.map("mapa-container").setView(o,a),L.tileLayer("https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png",{attribution:"&copy; OpenStreetMap & CartoDB",maxZoom:19}).addTo(mapaEpicos)}const t=document.getElementById("lista-localizacao-texto");t.innerHTML="";let n={};for(const e in todosMembros.forEach(e=>{if(!e.localizacao)return;const{cidade:a,estado:o,latitude:i,longitude:r}=e.localizacao;if(i&&r){const a=`${i.toFixed(4)},${r.toFixed(4)}`;n[a]||(n[a]=[]),n[a].push(e)}let d="\uD83D\uDCA1";"lider"===e.papel?d="\uD83D\uDC51":"abelha"===e.equipe?d="\uD83D\uDC1D":"joaninha"===e.equipe&&(d="\uD83D\uDC1E");const s=document.createElement("div");s.className="item-localizacao",s.innerHTML=`${d} <strong>${e.nome}</strong> ‚Äî ${a}/${o}`,t.appendChild(s)}),n){const a=n[e],o=a.length;a.forEach((e,a)=>{let{cidade:t,estado:n,latitude:i,longitude:r}=e.localizacao,d="vagalume",s="\uD83D\uDCA1",l="Membro";"lider"===e.papel?(d="lider-geral",s="\uD83D\uDC51",l="L\xEDder Geral"):"abelha"===e.equipe?(d="abelha",s="\uD83D\uDC1D",l="Equipe Abelha"):"joaninha"===e.equipe?(d="joaninha",s="\uD83D\uDC1E",l="Equipe Joaninha"):"vagalume"===e.equipe&&(d="vagalume",s="\uD83D\uDCA1",l="Equipe Vaga-lume");const m=L.divIcon({className:"custom-div-icon",html:`<div class='marker-pin ${d}'></div>`,iconSize:[30,42],iconAnchor:[15,42]}),c=L.marker([i,r],{icon:m}).addTo(mapaEpicos),u=`
            <div style="text-align:center;">
              <strong style="font-size:1.1rem;">${s} ${e.nome}</strong><br>
              <span style="color:#7f8c8d;">${l}</span><br>
              <hr style="margin:5px 0; border:0; border-top:1px solid #eee;">
              üìç ${t}, ${n}
            </div>
          `;c.bindPopup(u),c.dadosPosicao={latOriginal:i,lngOriginal:r,indice:a,totalNoGrupo:o,angulo:a/o*(2*Math.PI)},marcadoresMapa.push(c)})}const i=()=>{const e=mapaEpicos.getZoom(),a=6e-5*Math.pow(2,16-e);let o=Math.max(a,.003);5>=e&&(o=Math.min(o,.5)),marcadoresMapa.forEach(e=>{const a=e.dadosPosicao;if(1<a.totalNoGrupo){const t=Math.cos(a.angulo)*o,n=Math.sin(a.angulo)*o;e.setLatLng([a.latOriginal+t,a.lngOriginal+n])}else e.setLatLng([a.latOriginal,a.lngOriginal])})};mapaEpicos.on("zoomend",i),i()}window.carregarEstadosIBGE=async function(){const e=document.getElementById("input-loc-estado");if(!(1<e.options.length))try{const a=await fetch("https://servicodados.ibge.gov.br/api/v1/localidades/estados?orderBy=nome"),o=await a.json();o.forEach(a=>{const o=document.createElement("option");o.value=a.sigla,o.textContent=`${a.nome} (${a.sigla})`,e.appendChild(o)})}catch(e){console.error("Erro ao carregar estados:",e)}},window.carregarCidadesPorEstado=async function(){const e=document.getElementById("input-loc-estado").value,a=document.getElementById("input-loc-cidade"),o=document.getElementById("lista-cidades-brasil");if(a.value="",o.innerHTML="",!e)return a.disabled=!0,void(a.placeholder="Primeiro selecione o estado...");a.disabled=!1,a.placeholder="Carregando cidades...",a.focus();try{const t=await fetch(`https://servicodados.ibge.gov.br/api/v1/localidades/estados/${e}/municipios`),n=await t.json();n.forEach(e=>{const a=document.createElement("option");a.value=e.nome,o.appendChild(a)}),a.placeholder="Digite ou selecione a cidade..."}catch(e){console.error("Erro ao carregar cidades:",e),a.placeholder="Erro ao carregar cidades."}},window.alternarModoLocalizacao=function(){const e=document.getElementById("input-loc-pais").value,a=document.getElementById("container-loc-brasil"),o=document.getElementById("container-loc-gringo");if("BR"===e){a.classList.remove("hidden"),o.classList.add("hidden");const e=document.getElementById("input-loc-estado");1>=e.options.length&&carregarEstadosIBGE()}else a.classList.add("hidden"),o.classList.remove("hidden")},window.abrirModalLocalizacao=function(){if(!currentUser)return void mostrarPopup("\uD83D\uDEAB Erro","Fa\xE7a login para ajustar sua localiza\xE7\xE3o.",3e3);const e=todosMembros.find(e=>e.nome===currentUser),a=document.getElementById("input-loc-pais"),o=document.getElementById("input-loc-estado"),t=document.getElementById("input-loc-cidade"),n=document.getElementById("input-loc-estado-gringo"),i=document.getElementById("input-loc-cidade-gringo");let r="BR";e&&e.localizacao&&e.localizacao.pais&&(r=e.localizacao.pais),a.value=r,alternarModoLocalizacao(),"BR"===r?carregarEstadosIBGE().then(()=>{e&&e.localizacao?(o.value=e.localizacao.estado||"",t.value=e.localizacao.cidade||"",e.localizacao.estado&&(t.disabled=!1,carregarCidadesPorEstado())):(o.value="",t.value="",t.disabled=!0)}):e&&e.localizacao?(n.value=e.localizacao.estado||"",i.value=e.localizacao.cidade||""):(n.value="",i.value=""),document.getElementById("btn-salvar-localizacao").onclick=salvarLocalizacaoUsuario,openModal("modal-localizacao")};async function salvarLocalizacaoUsuario(){const e=document.getElementById("input-loc-pais").value;let a,o;const t=document.getElementById("btn-salvar-localizacao");t.disabled=!0,t.textContent="Varrendo mapa...";let n="";if("BR"===e){a=document.getElementById("input-loc-cidade").value.trim();const e=document.getElementById("input-loc-estado"),i=e.options[e.selectedIndex].text;if(o=i.split("(")[0].trim().toUpperCase(),n=e.value.trim().toUpperCase(),!a||!n)return mostrarPopup("\u26A0\uFE0F Aten\xE7\xE3o","Cidade e Estado s\xE3o obrigat\xF3rios.",3e3),t.disabled=!1,void(t.textContent="Salvar Localiza\xE7\xE3o")}else if(a=document.getElementById("input-loc-cidade-gringo").value.trim(),o=document.getElementById("input-loc-estado-gringo").value.trim(),!a)return mostrarPopup("\u26A0\uFE0F Aten\xE7\xE3o","O nome da cidade \xE9 obrigat\xF3rio.",3e3),t.disabled=!1,void(t.textContent="Salvar Localiza\xE7\xE3o");let i="",r="";try{console.log(`Buscando coordenadas para cidade: "${a}" no pa√≠s: "${e}"`);const t=`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(a)}&count=10&language=pt&format=json`,d=await fetch(t),s=await d.json();if(s.results&&0<s.results.length){let a=null;"BR"===e?a=s.results.find(e=>"BR"===e.country_code&&(e.admin1&&e.admin1.toUpperCase().includes(o)||e.admin1_code&&e.admin1_code.includes(n)||e.admin1&&e.admin1.toUpperCase().includes(n))):"OUTRO"===e?(o&&(a=s.results.find(e=>e.admin1?.toLowerCase().includes(o.toLowerCase())||e.country?.toLowerCase().includes(o.toLowerCase()))),!a&&(a=s.results[0])):(a=s.results.find(a=>a.country_code===e),!a&&o&&(a=s.results.find(e=>e.admin1?.toLowerCase().includes(o.toLowerCase())))),a&&(i=a.latitude,r=a.longitude,console.log("Localiza\xE7\xE3o confirmada:",a.name,a.country,a.admin1))}if(!i){console.log("Busca simples falhou. Tentando busca composta...");const t=document.getElementById("input-loc-pais");let n=t.options[t.selectedIndex].text.replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]/g,"").trim();"OUTRO"===e&&(n="");const d=`${a} ${o||""} ${n}`.trim(),s=`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(d)}&count=1&language=pt&format=json`,l=await fetch(s),m=await l.json();m.results&&0<m.results.length&&(i=m.results[0].latitude,r=m.results[0].longitude)}if(!i||!r)return void mostrarPopup("\u274C N\xE3o encontrado",`N√£o conseguimos encontrar "${a}" neste estado. Verifique a grafia, ou entre em contato com os administradores`,6e3);let l=o;"BR"===e&&"undefined"!=typeof n&&n&&(l=n);const m={pais:e,cidade:a,estado:l,latitude:parseFloat(i),longitude:parseFloat(r)};await updateDoc(doc(db,"membros",currentUser),{localizacao:m});const c=todosMembros.findIndex(e=>e.nome===currentUser);-1<c&&(todosMembros[c].localizacao=m),mostrarPopup("\u2705 Sucesso","Localiza\xE7\xE3o salva corretamente!",3e3),closeModal("modal-localizacao"),inicializarMapa()}catch(e){console.error("Erro ao salvar localiza\xE7\xE3o:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel salvar.",4e3)}finally{t.disabled=!1,t.textContent="Salvar Localiza\xE7\xE3o"}}async function toggleGeneroMembro(e,a){try{const o=doc(db,"membros",e);await updateDoc(o,{genero:a});const t=todosMembros.findIndex(a=>a.nome===e);-1!==t&&(todosMembros[t].genero=a),mostrarPopup("\u2705 Atualizado",`G√™nero de ${e} definido como: ${a}`,2e3)}catch(a){console.error(`Erro ao atualizar g√™nero para ${e}:`,a),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel salvar a altera\xE7\xE3o.",4e3)}}function popularPainelGeneros(){const e=document.getElementById("generos-lista-membros");if(e){e.innerHTML="";const a=[...todosMembros].sort((e,a)=>e.nome.localeCompare(a.nome));a.forEach(a=>{const o=document.createElement("div");o.className="ferias-item",o.style.justifyContent="space-between";let t=a.genero||"indefinido";o.innerHTML=`
      <label for="genero_${a.nome}" style="font-weight: 500;">${a.nome}</label>
      <select id="genero_${a.nome}" class="painel-input" style="width: 140px; padding: 5px;">
        <option value="indefinido" ${"indefinido"===t?"selected":""}>‚ùì Indefinido</option>
        <option value="masculino" ${"masculino"===t?"selected":""}>üë® Masculino</option>
        <option value="feminino" ${"feminino"===t?"selected":""}>üë© Feminino</option>
      </select>
    `,o.querySelector("select").addEventListener("change",o=>{toggleGeneroMembro(a.nome,o.target.value)}),e.appendChild(o)})}}async function handleDecretarFeriado(){const e=document.getElementById("input-data-feriado").value,a=document.getElementById("input-nome-feriado").value.trim();if(!e||!a)return void mostrarPopup("\u274C Erro","Preencha a data e o nome do feriado.",3e3);const[o,t,n]=e.split("-"),i=`${o}-${t}-${n}`;try{const e=doc(db,"configuracoes","feriadosManuais");await setDoc(e,{[i]:a},{merge:!0}),cacheFeriadosManuais[i]=a,mostrarPopup("\u2705 Sucesso",`Feriado "${a}" agendado para ${n}/${t}/${o}.`,4e3);const r=getHojeISO();i===r&&(console.log("O feriado decretado \xE9 HOJE. Executando imediatamente..."),await processarFeriadoDoDia()),document.getElementById("input-nome-feriado").value=""}catch(e){console.error("Erro ao agendar feriado:",e),mostrarPopup("\u274C Erro","Falha ao salvar o feriado.",4e3)}}let calendarioMesAtual=new Date().getMonth(),calendarioAnoAtual=new Date().getFullYear();window.iniciarCalendario=function(){renderizarCalendario(calendarioMesAtual,calendarioAnoAtual)},window.mudarMesCalendario=function(e){calendarioMesAtual+=e,0>calendarioMesAtual?(calendarioMesAtual=11,calendarioAnoAtual--):11<calendarioMesAtual&&(calendarioMesAtual=0,calendarioAnoAtual++),renderizarCalendario(calendarioMesAtual,calendarioAnoAtual)};async function renderizarCalendario(e,a){if(0===Object.keys(cacheFeriadosManuais).length)try{const e=doc(db,"configuracoes","feriadosManuais"),a=await getDoc(e);a.exists()&&Object.assign(cacheFeriadosManuais,a.data())}catch(a){console.log("Carregando calend\xE1rio...")}const o=document.getElementById("calendar-days"),t=document.getElementById("calendar-month-year"),n=document.getElementById("calendar-event-details");if(!o)return;o.innerHTML="",n&&n.classList.add("hidden");t.textContent=`${["Janeiro","Fevereiro","Mar\xE7o","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"][e]} ${a}`;const r=new Date(a,e,1).getDay(),d=new Date(a,e+1,0).getDate();for(let t=0;t<r;t++){const e=document.createElement("div");e.className="calendar-day empty",o.appendChild(e)}const s=calcularPascoa(a),l=new Date(s);l.setDate(s.getDate()-2);const m=new Date(s);m.setDate(s.getDate()+60);const c=new Date(s);c.setDate(s.getDate()-46);const u=new Date(s);u.setDate(s.getDate()-47);const p=new Date(s);p.setDate(s.getDate()-48);const g=new Date(s);g.setDate(s.getDate()-50);const f=new Date(s);f.setDate(s.getDate()-51);const h={"01/01":"\uD83C\uDF89 Confraterniza\xE7\xE3o Universal","08/03":"\uD83C\uDF89 Dia da Mulher","21/04":"\uD83C\uDF89 Tiradentes","01/05":"\uD83C\uDF89 Dia do Trabalhador","12/06":"\uD83C\uDF89 Dia dos Namorados","07/09":"\uD83C\uDF89 Independ\xEAncia","12/10":"\uD83C\uDF89 Nsa. Sra. Aparecida","15/10":"\uD83C\uDF89 Dia dos Professores","02/11":"\uD83C\uDF89 Finados","15/11":"\uD83C\uDF89 Proclama\xE7\xE3o Rep\xFAblica","20/11":"\uD83C\uDF89 Consci\xEAncia Negra","24/12":"\uD83C\uDF89 V\xE9spera de Natal","25/12":"\uD83C\uDF89 Natal","31/12":"\uD83C\uDF89 V\xE9spera de Ano Novo",[formatarDiaMes(s)]:"\uD83D\uDC30 P\xE1scoa",[formatarDiaMes(l)]:"\u271D\uFE0F Sexta-feira Santa",[formatarDiaMes(m)]:"\u26EA Corpus Christi",[formatarDiaMes(c)]:"\u26EA Quarta de Cinzas",[formatarDiaMes(u)]:"\uD83C\uDF89 Carnaval (Ter\xE7a-feira)",[formatarDiaMes(p)]:"\uD83C\uDF89 Carnaval (Segunda-feira)",[formatarDiaMes(g)]:"\uD83C\uDF89 S\xE1bado de Carnaval",[formatarDiaMes(f)]:"\uD83C\uDF89 Sexta-feira de Carnaval"};for(let t=1;t<=d;t++){const n=new Date(a,e,t),i=n.getDay(),r=`${(t+"").padStart(2,"0")}/${(e+1+"").padStart(2,"0")}`,d=`${a}-${(e+1+"").padStart(2,"0")}-${(t+"").padStart(2,"0")}`,s=document.createElement("div");s.className="calendar-day";const l=getHoje();t===l.getDate()&&e===l.getMonth()&&a===l.getFullYear()&&s.classList.add("today");const m=document.createElement("div");m.className="day-number",m.textContent=t,s.appendChild(m);const c=document.createElement("div");c.className="day-content",1===i&&(addEventDot(c,"\u2694\uFE0F In\xEDcio da Competi\xE7\xE3o","evt-competicao"),addEventDot(c,"\uD83C\uDFAE In\xEDcio do Jogo da Vantagem","evt-jogo")),2===i&&addEventDot(c,"\uD83C\uDFA8 Resultado da Batalha de Desenhos","evt-desenho"),3===i&&addEventDot(c,"\uD83C\uDF40 Sorteio da Loteria","evt-loteria"),4===i&&addEventDot(c,"\uD83D\uDD8C\uFE0F Novo Tema de Desenho","evt-desenho"),5===i&&addEventDot(c,"\uD83C\uDFC1 Fim do Jogo da Vantagem","evt-jogo"),6===i&&addEventDot(c,"\uD83C\uDFC1 Fim da Competi\xE7\xE3o","evt-competicao"),0===i&&addEventDot(c,"\uD83C\uDFC6 Resultado da competi\xE7\xE3o","evt-resultado"),h[r]&&addEventDot(c,h[r],"evt-feriado"),cacheFeriadosManuais[d]&&addEventDot(c,`üéâ ${cacheFeriadosManuais[d]}`,"evt-feriado"),todosMembros.forEach(e=>{e.aniversario&&e.aniversario===r&&addEventDot(c,`üéÇ Anivers√°rio de ${e.nome}`,"evt-aniversario")}),s.appendChild(c),s.onclick=()=>mostrarDetalhesDia(t,e,a,c),o.appendChild(s)}}function addEventDot(e,a,o){const t=document.createElement("div");t.className=`event-dot ${o}`,t.textContent=a,t.title=a,e.appendChild(t)}function mostrarDetalhesDia(e,a,o,t){const n=document.getElementById("calendar-event-details");if(!n)return;const i=`${(e+"").padStart(2,"0")}/${(a+1+"").padStart(2,"0")}/${o}`,r=Array.from(t.children).map(e=>{let a=window.getComputedStyle(e).backgroundColor;return`<div style="margin-bottom:8px; display:flex; align-items:center;">
                  <span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:${a};margin-right:10px;flex-shrink:0;"></span>
                  <span style="font-size:1rem;">${e.textContent||e.title}</span>
                </div>`});0<r.length?(n.innerHTML=`<h4 style="margin-bottom:10px; border-bottom:1px solid #ddd; padding-bottom:5px;">Eventos em ${i}:</h4>${r.join("")}`,n.classList.remove("hidden")):(n.innerHTML=`<h4 style="margin-bottom:10px;">${i}</h4><p style="color:#7f8c8d; font-style:italic;">Nenhum evento especial neste dia.</p>`,n.classList.remove("hidden"))}async function carregarRecompensaDiaria(){if(currentUser){const e=todosMembros.find(e=>e.nome===currentUser);if(e){let a=e.dailyRewardStreak||0,o=null;e.lastDailyRewardClaim&&(e.lastDailyRewardClaim.toDate?o=e.lastDailyRewardClaim.toDate():o=new Date(e.lastDailyRewardClaim));const t=getHoje();t.setHours(0,0,0,0);let n=!1;if(o){const i=new Date(o);i.setHours(0,0,0,0);const r=t.getTime()-i.getTime(),d=Math.floor(r/86400000);if(0===d)n=!0;else if(1<d){const o=e.protecaoSoftBlock||{},t=o.protegidoAte?o.protegidoAte.toDate?o.protegidoAte.toDate():new Date(o.protegidoAte):null,n=t&&t.getTime()>i.getTime();if(n)console.log(`üõ°Ô∏è Sequ√™ncia de ${currentUser} mantida gra√ßas ao Escudo de Prote√ß√£o!`),setTimeout(()=>{mostrarCardPopup("\uD83D\uDEE1\uFE0F Prote\xE7\xE3o Ativada!","Voc\xEA n\xE3o resgatou sua recompensa ontem, mas sua sequ\xEAncia foi <strong>SALVA</strong> pelo seu Escudo de Prote\xE7\xE3o!<br><br>Sua dedica\xE7\xE3o anterior garantiu que seus dias n\xE3o fossem zerados. Continue assim!",null)},1500);else if(0<a){a=0;const o=doc(dbEssencial,"membros_essencial",currentUser);updateDoc(o,{dailyRewardStreak:0}).catch(e=>console.error("Erro ao zerar streak no essencial:",e)),e.dailyRewardStreak=0,adicionarEventoAoFeed("geral","\uD83D\uDCC9 Sequ\xEAncia Perdida...",`<strong>${currentUser}</strong> deixou de resgatar a recompensa di√°ria e sua sequ√™ncia voltou ao in√≠cio.`,{nomeMembro:currentUser})}}}dailyStreakGlobal=a,dailyClaimedToday=n,iniciarTimerRecompensa(),atualizarInterfaceRecompensa(),popularTabelaNiveis()}}}function atualizarInterfaceRecompensa(){const e=getNivelRecompensa(dailyStreakGlobal),a=NIVEIS_RECOMPENSA.find(e=>e.min>dailyStreakGlobal),o=document.getElementById("secao-recompensa-diaria");o&&o.style.setProperty("--reward-color",e.cor);const t=document.getElementById("streak-number");t.textContent=dailyStreakGlobal,t.style.color=e.cor;const n=document.getElementById("btn-resgatar-diario");n.style.backgroundColor=e.cor,n.style.color=e.textoCor;const i=document.getElementById("btn-consultar-niveis");i&&(i.style.backgroundColor=e.cor,i.style.color=e.textoCor,i.style.borderColor="transparent");const r=document.getElementById("btn-ranking-sequencia");r&&(r.style.backgroundColor=e.cor,r.style.color=e.textoCor,r.style.borderColor="transparent",r.style.boxShadow=`0 4px 10px ${e.cor}40`),dailyClaimedToday?(n.textContent=`Volte Amanh√£`,n.disabled=!0,n.style.opacity="0.5",n.style.animation="none",n.onclick=null):(n.textContent=`Resgatar üí∞ ${e.valor} Moedas`,n.style.opacity="1",n.style.animation="pulse 2s infinite",n.onclick=resgatarRecompensaDiaria),n.disabled=!1;const d=document.getElementById("timeline-dots"),s=document.getElementById("timeline-line-progress");d.innerHTML="";const l=getHoje();let m=l.getDay();0===m&&(m=7);const c=["S","T","Q","Q","S","S","D"],u=Math.min(100,100*((m-1)/6));s.style.width=`${u}%`,s.style.backgroundColor=e.cor;for(let a=1;7>=a;a++){const o=document.createElement("div");o.className="timeline-step";const t=document.createElement("span");t.className="day-label",t.textContent=c[a-1];const n=document.createElement("div");if(n.className="daily-dot",a<m){const o=m-a;let i=0;const r=todosMembros.find(e=>e.nome===currentUser);if(r&&r.lastDailyRewardClaim){const e=r.lastDailyRewardClaim.toDate?r.lastDailyRewardClaim.toDate():new Date(r.lastDailyRewardClaim);e.setHours(0,0,0,0);const a=getHoje();a.setHours(0,0,0,0),i=Math.floor((a.getTime()-e.getTime())/86400000)}const d=o>=i;dailyStreakGlobal>o&&d?(n.style.backgroundColor=e.cor,n.classList.add("passed"),t.style.color=e.cor):(n.classList.add("skipped"),t.style.color="#ccc")}else a===m?(t.style.fontWeight="bold",t.style.color=e.cor,dailyClaimedToday?(n.style.backgroundColor=e.cor,n.classList.add("claimed")):n.className="daily-dot current-pending"):(n.style.backgroundColor="#e0e0e0",t.style.color="#ccc");o.appendChild(t),o.appendChild(n),d.appendChild(o)}const p=document.getElementById("next-level-info");if(a){const e=a.min-dailyStreakGlobal;p.innerHTML=`Faltam <strong>${e} dias</strong> para o N√≠vel ${NIVEIS_RECOMPENSA.indexOf(a)+1} <span class="quebra-mobile">(${a.valor} moedas por dia)!</span>`}else p.textContent="Voc\xEA atingiu o n\xEDvel m\xE1ximo! Mantenha a sequ\xEAncia!"}async function resgatarRecompensaDiaria(){if(dailyClaimedToday)return;const e=document.getElementById("btn-resgatar-diario");e.disabled=!0,e.textContent="Resgatando...",e.style.animation="none";const a=getNivelRecompensa(dailyStreakGlobal),o=a.valor,t=dailyStreakGlobal+1;try{const e=doc(dbEssencial,"membros_essencial",currentUser);await updateDoc(e,{moedas:increment(o),dailyRewardStreak:t,lastDailyRewardClaim:new Date});const a=todosMembros.findIndex(e=>e.nome===currentUser);-1!==a&&(todosMembros[a].moedas=(todosMembros[a].moedas||0)+o,todosMembros[a].dailyRewardStreak=t,todosMembros[a].lastDailyRewardClaim=new Date,localStorage.setItem("epicos_cache_membros",JSON.stringify(todosMembros))),dailyStreakGlobal=t,dailyClaimedToday=!0,dispararConfeteMoedas(),tocarSom("som-conquista"),atualizarInterfaceRecompensa(),verificarNudgesDiarios(!1),mostrarPopupMoedas(o);const n=getNivelRecompensa(t);n.min===t&&0<t&&(mostrarPopup("\uD83C\uDF89 N\xEDvel Aumentado!",`Sua sequ√™ncia evoluiu! Agora voc√™ ganha ${n.valor} moedas por dia!`,5e3),await adicionarEventoAoFeed("medalha","\uD83D\uDE80 Evolu\xE7\xE3o de Sequ\xEAncia!",`<strong>${currentUser}</strong> atingiu uma sequ√™ncia de <strong>${t} dias</strong> e evoluiu para o pr√≥ximo n√≠vel de recompensas di√°rias!`,{nomeMembro:currentUser}))}catch(o){console.error("Erro ao resgatar recompensa di\xE1ria:",o),mostrarPopup("\u274C Erro","Falha ao resgatar. Tente novamente.",4e3),e.disabled=!1,e.textContent=`Resgatar üí∞ ${a.valor} Moedas`}}window.resgatarRecompensaDiaria=resgatarRecompensaDiaria;function dispararConfeteMoedas(){function e(){o.clearRect(0,0,a.width,a.height);let n=0;r.forEach(e=>{e.y+=e.speed,e.rotation+=e.rotationSpeed,-60<e.y&&e.y<a.height+60&&(o.save(),o.translate(e.x,e.y),o.rotate(e.rotation*Math.PI/180),o.drawImage(t,-25,-25),o.restore()),e.y<a.height&&n++}),0<n?requestAnimationFrame(e):a.remove()}const a=document.createElement("canvas");a.id="moedas-confetti",a.style.position="fixed",a.style.top="0",a.style.left="0",a.style.width="100%",a.style.height="100%",a.style.pointerEvents="none",a.style.zIndex="9999",document.body.appendChild(a);const o=a.getContext("2d");a.width=window.innerWidth,a.height=window.innerHeight;const t=document.createElement("canvas"),n=50;t.width=n,t.height=n;const i=t.getContext("2d");i.font="35px Arial",i.textAlign="center",i.textBaseline="middle",i.fillText("\uD83D\uDCB0",n/2,n/2);const r=[];for(let e=0;e<50;e++)r.push({x:Math.random()*a.width,y:-50-500*Math.random(),speed:4*Math.random()+3,rotation:360*Math.random(),rotationSpeed:5*(Math.random()-.5)});requestAnimationFrame(e)}function popularTabelaNiveis(){const e=document.getElementById("lista-niveis-tabela");e&&(e.innerHTML="",NIVEIS_RECOMPENSA.forEach((a,o)=>{const t=document.createElement("div");t.className="nivel-row";let n=`${a.min} - ${a.max}`;1e3<a.max&&(n=`${a.min}+`),t.innerHTML=`
            <div style="display:flex; align-items:center; gap:10px;">
                <span class="nivel-tag" style="background-color: ${a.cor}; color: ${a.textoCor}">N√≠vel ${o+1}</span>
                <span>Sequ√™ncia: ${n} dias</span>
            </div>
            <strong>${a.valor} üí∞</strong>
        `,e.appendChild(t)}))}async function atualizarProgressoProtecao(e,a=null){if(!currentUser)return;const o=doc(db,"membros",currentUser);try{await runTransaction(db,async t=>{const n=await t.get(o);if(!n.exists())return;const i=n.data();let r=i.protecaoSoftBlock||{postouMural:!1,comentouMural:!1,reacoesCount:0,apostouLoteria:!1,protegidoAte:null,popupVisto:!1,backupDate:null,activeCommentId:null,activePostId:null};const d=new Date,s=r.protegidoAte?r.protegidoAte.toDate():null;s&&s<d&&(console.log("Prote\xE7\xE3o anterior expirada. Limpando hist\xF3rico de tarefas..."),r.postouMural=!1,r.comentouMural=!1,r.reacoesCount=0,r.apostouLoteria=!1,r.activeCommentId=null,r.activePostId=null,r.protegidoAte=null,r.popupVisto=!1);let l=!1;if(s&&s>d){const e=s.getTime()-d.getTime();if(86400000<e)return;l=!0;const a=r.postouMural&&r.comentouMural&&5<=r.reacoesCount&&r.apostouLoteria;a&&(r.postouMural=!1,r.comentouMural=!1,r.reacoesCount=0,r.apostouLoteria=!1,r.activeCommentId=null,r.activePostId=null)}if("postar"!==e||r.postouMural&&(!r.postouMural||r.activePostId)||(r.postouMural=!0,a&&(r.activePostId=a)),"comentar"!==e||r.comentouMural&&(!r.comentouMural||r.activeCommentId)||(r.comentouMural=!0,a&&(r.activeCommentId=a)),"reagir"===e&&(r.reacoesCount=(r.reacoesCount||0)+1),"apostar"===e&&(r.apostouLoteria=!0),r.postouMural&&r.comentouMural&&5<=r.reacoesCount&&r.apostouLoteria){let e=new Date;const a=r.backupDate?r.backupDate.toDate():null;a&&a>d&&!l?(e=a,console.log("Prote\xE7\xE3o restaurada usando data de backup (Anti-Exploit).")):l&&s?e.setTime(s.getTime()+345600000):e.setDate(e.getDate()+4),r.protegidoAte=e,r.popupVisto=!1,r.backupDate=null}t.update(o,{protecaoSoftBlock:r});const m=todosMembros.find(e=>e.nome===currentUser);m&&(m.protecaoSoftBlock=r)}),verificarEExibirSucessoProtecao()}catch(a){console.error("Erro ao atualizar prote\xE7\xE3o:",a)}}async function reverterProgressoProtecao(e,a=null){if(!currentUser)return;const o=doc(db,"membros",currentUser);try{await runTransaction(db,async t=>{const n=await t.get(o);if(!n.exists())return;const i=n.data();let r=i.protecaoSoftBlock||{},d=!1;if("postar"===e?r.activePostId&&r.activePostId===a&&(r.postouMural=!1,r.activePostId=null,d=!0):"comentar"===e?r.activeCommentId&&r.activeCommentId===a&&(r.comentouMural=!1,r.activeCommentId=null,d=!0):"reagir"===e?(r.reacoesCount=Math.max(0,(r.reacoesCount||0)-1),d=!0):"apostar"==e&&(r.apostouLoteria=!1,d=!0),!!d){const e=r.postouMural&&r.comentouMural&&5<=r.reacoesCount&&r.apostouLoteria;e||(r.protegidoAte&&(r.backupDate=r.protegidoAte),r.protegidoAte=null,r.popupVisto=!1,console.log(`Anti-Cheat: Prote√ß√£o pausada para ${currentUser}. Tempo salvo em backup.`)),t.update(o,{protecaoSoftBlock:r});const a=todosMembros.find(e=>e.nome===currentUser);a&&(a.protecaoSoftBlock=r)}}),verificarEExibirSucessoProtecao()}catch(a){console.error("Erro ao reverter prote\xE7\xE3o:",a)}}window.abrirModalProtecaoSequencia=function(){const e=todosMembros.find(e=>e.nome===currentUser);if(!e)return;const a=e.protecaoSoftBlock||{reacoesCount:0},o=new Date,t=a.protegidoAte?a.protegidoAte.toDate?a.protegidoAte.toDate():new Date(a.protegidoAte):null,n=t&&t>o;let i=n,r=!1;if(n){const e=t.getTime()-o.getTime();e<86400000&&(i=!1,r=!0)}const d=a.postouMural&&a.comentouMural&&5<=a.reacoesCount&&a.apostouLoteria;let s=a.postouMural,l=a.comentouMural,m=a.apostouLoteria,c=a.reacoesCount||0;r&&d&&(s=!1,l=!1,m=!1,c=0),document.getElementById("task-postar-mural").innerHTML=`<span class="task-status">${s||i?"\u2705":"\u2B1C"}</span> <span class="task-desc">Postar uma mensagem no Mural</span>`,document.getElementById("task-comentar-mural").innerHTML=`<span class="task-status">${l||i?"\u2705":"\u2B1C"}</span> <span class="task-desc">Comentar em uma mensagem</span>`;const u=Math.min(c,5);document.getElementById("task-reagir").innerHTML=`<span class="task-status">${5<=c||i?"\u2705":"\u2B1C"}</span> <span class="task-desc">Reagir a 5 conte√∫dos (Mural/Feed) <span id="task-reagir-count">(${u}/5)</span></span>`,document.getElementById("task-apostar").innerHTML=`<span class="task-status">${m||i?"\u2705":"\u2B1C"}</span> <span class="task-desc">Fazer uma aposta na Loteria</span>`;const p=document.getElementById("protecao-status-msg");n?r?(p.innerHTML=`‚ö†Ô∏è RENOVA√á√ÉO DISPON√çVEL!<br>Complete as tarefas novamente para estender sua prote√ß√£o.`,p.style.color="#e67e22"):(p.textContent=`üõ°Ô∏è VOC√ä EST√Å PROTEGIDO AT√â ${t.toLocaleDateString("pt-BR")}!`,p.style.color="#f1c40f"):(p.textContent="Complete as tarefas para ativar o escudo.",p.style.color="#7f8c8d"),openModal("modal-protecao-sequencia")};async function verificarEExibirSucessoProtecao(e=!1){const a=todosMembros.find(e=>e.nome===currentUser);if(!a||!a.protecaoSoftBlock)return;const o=a.protecaoSoftBlock,t=new Date,n=o.protegidoAte?o.protegidoAte.toDate?o.protegidoAte.toDate():new Date(o.protegidoAte):null,i=document.getElementById("btn-protecao-sequencia"),r=n&&n>t;if(!usuarioAceitaPopups())return;if(r?i&&(i.classList.add("protegido"),i.innerHTML="\uD83D\uDEE1\uFE0F Sequ\xEAncia Protegida"):i&&(i.classList.remove("protegido"),i.innerHTML="\uD83D\uDEE1\uFE0F Proteja sua Sequ\xEAncia"),!r)return;const d=n.getTime()-t.getTime();if(!1===o.popupVisto){mostrarCardPopup("\uD83D\uDEE1\uFE0F Sequ\xEAncia Protegida!","Voc\xEA completou todas as tarefas! <br><br>Agora voc\xEA est\xE1 imune \xE0 maldi\xE7\xE3o da Runa do Soft Block pelos pr\xF3ximos <strong>4 dias</strong>. Parab\xE9ns pela dedica\xE7\xE3o!",dispararConfete),tocarSom("som-conquista");try{const e=doc(db,"membros",currentUser);await updateDoc(e,{"protecaoSoftBlock.popupVisto":!0}),o.popupVisto=!0}catch(a){console.error("Erro ao marcar popup de prote\xE7\xE3o como visto:",a)}return}if(86400000>d){if(!e)return;mostrarCardPopup("\u26A0\uFE0F Prote\xE7\xE3o Expirando!",`Sua prote√ß√£o contra a maldi√ß√£o do Soft Block acaba em menos de 24 horas.<br><br>Voc√™ j√° pode realizar as tarefas novamente agora para <strong>estender sua prote√ß√£o</strong> por mais 4 dias sem perder o escudo atual!`,null,"Grupo \xC9picos","aviso_renovacao_protecao")}}function inicializarEstadoProtecao(){verificarEExibirSucessoProtecao(!0)}function abrirRankingSequencias(){const e=document.getElementById("lista-ranking-sequencia");e.innerHTML="";const a=todosMembros.map(e=>({nome:e.nome,streak:e.dailyRewardStreak||0,equipe:e.equipe,papel:e.papel})).sort((e,a)=>a.streak-e.streak).filter(e=>0<e.streak);return 0===a.length?(e.innerHTML="<div class=\"ociosos-placeholder\">Ningu\xE9m iniciou uma sequ\xEAncia ainda.</div>",void openModal("modal-ranking-sequencia")):void(a.forEach((a,o)=>{const t=o+1;let n="",i="";1===t?(n="\uD83E\uDD47",i="style=\"background-color: rgba(255, 215, 0, 0.15); border-left: 3px solid #FFD700;\""):2===t?(n="\uD83E\uDD48",i="style=\"background-color: rgba(192, 192, 192, 0.15); border-left: 3px solid #C0C0C0;\""):3===t?(n="\uD83E\uDD49",i="style=\"background-color: rgba(205, 127, 50, 0.15); border-left: 3px solid #CD7F32;\""):n=`<span style="font-size: 0.9rem; color: #777; width: 20px; display:inline-block; text-align:center;">${t}¬∫</span>`;const r=document.createElement("div");r.className="ocioso-item",i&&(r.style.cssText=i.replace("style=\"","").replace("\"",""));const d=a.equipe?a.equipe.toLowerCase():"";let s="";if(!d||"nenhuma"===d)s="\uD83D\uDC51 Guardi\xE3o";else{let e="",o="";"abelha"===d?(e="\uD83D\uDC1D",o="Abelha"):"joaninha"===d?(e="\uD83D\uDC1E",o="Joaninha"):"vagalume"===d?(e="\uD83D\uDCA1",o="Vaga-lume"):o=d.charAt(0).toUpperCase()+d.slice(1);const t="lider-equipe"===a.papel?"L\xEDder":"Equipe";s=`${t} ${o} ${e}`}r.innerHTML=`
      <div style="display: flex; align-items: center; width: 100%;">
        <div style="font-size: 1.5rem; margin-right: 15px;">${n}</div>
        <div style="flex-grow: 1;">
            <div style="font-weight: bold; font-size: 1.1rem;">${a.nome}</div>
            <div style="font-size: 0.8rem; color: #7f8c8d;">${s}</div>
        </div>
        <div style="font-weight: bold; font-size: 1.2rem; color: #27ae60;">${a.streak} dias</div>
      </div>
    `,e.appendChild(r)}),openModal("modal-ranking-sequencia"))}window.abrirRankingSequencias=abrirRankingSequencias;async function carregarRankingDesenhos(){try{const e=doc(dbDesenho,"ranking","desenho"),a=await getDoc(e);if(a.exists()){const e=a.data(),o=document.getElementById("vitorias-desenho-abelha"),t=document.getElementById("vitorias-desenho-joaninha"),n=document.getElementById("vitorias-desenho-vagalume");o&&(o.textContent=e.abelha||0),t&&(t.textContent=e.joaninha||0),n&&(n.textContent=e.vagalume||0)}}catch(e){console.error("Erro ao carregar ranking de desenhos:",e)}}let isNudgeDragging=!1,nudgeHasMoved=!1,nudgeListenersAdded=!1;function iniciarArrastoNudge(){const a=document.getElementById("nudge-floating-btn");if(!a)return;if(nudgeListenersAdded)return;let o,t;const n=n=>{if("mousedown"===n.type&&0!==n.button)return;isNudgeDragging=!0,nudgeHasMoved=!1;const e=n.touches?n.touches[0].clientX:n.clientX,i=n.touches?n.touches[0].clientY:n.clientY,r=a.getBoundingClientRect();o=e-r.left,t=i-r.top,a.style.right="auto",a.style.bottom="auto",a.style.left=`${r.left}px`,a.style.top=`${r.top}px`,a.style.cursor="grabbing"},i=n=>{if(!isNudgeDragging)return;n.preventDefault();const e=n.touches?n.touches[0].clientX:n.clientX,i=n.touches?n.touches[0].clientY:n.clientY;nudgeHasMoved=!0;let r=e-o,d=i-t;const s=window.innerWidth,l=window.innerHeight,m=a.offsetWidth,c=a.offsetHeight;r=Math.max(0,Math.min(r,s-m)),d=Math.max(0,Math.min(d,l-c)),a.style.left=`${r}px`,a.style.top=`${d}px`},r=()=>{isNudgeDragging=!1,a.style.cursor="grab"};a.addEventListener("mousedown",n),a.addEventListener("touchstart",n,{passive:!1}),window.addEventListener("mousemove",i),window.addEventListener("touchmove",i,{passive:!1}),window.addEventListener("mouseup",r),window.addEventListener("touchend",r),nudgeListenersAdded=!0}window.abrirNudgeModalSeNaoArrastou=function(){if(!nudgeHasMoved){openModal("modal-nudge-combinado");const e=document.getElementById("nudge-floating-btn");e&&e.classList.add("hidden")}};async function abrirHistoricoMagias(){const e=document.getElementById("lista-historico-magias");e.innerHTML="<div class=\"ociosos-placeholder\"><div class=\"spinner-mini\"></div> Consultando os astros...</div>",openModal("modal-historico-magias");try{const a=getSemanaAtual(),o=query(collection(db,"historicoPoderes"),where("semana","==",a.numero),orderBy("timestamp","desc")),t=await getDocs(o);if(t.empty)return void(e.innerHTML="<div class=\"ociosos-placeholder\">Nenhuma magia foi lan\xE7ada nesta semana... ainda.</div>");const n=[],i={pocao_sextagem:{nome:"Po\xE7\xE3o da Sextagem",emoji:"\uD83C\uDF7A",tipo:"buff"},praga_kriptonita:{nome:"Praga de Kriptonita",emoji:"\uD83E\uDD22",tipo:"ataque"},maldicao_pilantragem:{nome:"Maldi\xE7\xE3o da Pilantragem",emoji:"\uD83D\uDC80",tipo:"ataque"},elixir_vida:{nome:"Elixir de Vida",emoji:"\uD83D\uDC96",tipo:"buff"},runa_soft_block:{nome:"Runa do Soft Block",emoji:"\uD83D\uDD12",tipo:"ataque"},amuleto_protecao:{nome:"Amuleto de Prote\xE7\xE3o",emoji:"\uD83D\uDEE1\uFE0F",tipo:"defesa"}};if(t.forEach(e=>{const o=e.data(),t=o.timestamp.toDate().getFullYear();if(t===a.inicio.getFullYear()){if("amuleto_protecao"===o.poderId)return;n.push(o)}}),0===n.length)return void(e.innerHTML="<div class=\"ociosos-placeholder\">As magias lan\xE7adas permanecem nas sombras... (Nenhum registro vis\xEDvel).</div>");e.innerHTML="",n.forEach(a=>{const o=i[a.poderId]||{nome:a.poderId,emoji:"\u2728",tipo:"buff"},t=a.timestamp.toDate().toLocaleString("pt-BR",{weekday:"short",hour:"2-digit",minute:"2-digit"});let n=`magia-tipo-${o.tipo}`,r="",d="";const s=`<span class="tag-equipe ${a.equipe}">${a.equipe.charAt(0).toUpperCase()+a.equipe.slice(1)}</span>`;if("bloqueado"===a.status){n="magia-tipo-falha";const e=`<span class="tag-equipe ${a.alvo}">${a.alvo.charAt(0).toUpperCase()+a.alvo.slice(1)}</span>`;r=`${s} tentou lan√ßar <strong>${o.nome}</strong> contra ${e}...`,d=`<div class="magia-bloqueio-overlay">üõ°Ô∏è BLOQUEADO PELO AMULETO!</div>`}else if(a.alvo){const e=`<span class="tag-equipe ${a.alvo}">${a.alvo.charAt(0).toUpperCase()+a.alvo.slice(1)}</span>`;r=`${s} lan√ßou <strong>${o.nome}</strong> contra ${e}!`}else r=`${s} usou <strong>${o.nome}</strong> para si mesma.`;const l=document.createElement("div");l.className=`magia-log-item ${n}`,l.innerHTML=`
                <div class="magia-log-icon">${o.emoji}</div>
                <div class="magia-log-content">
                    <div class="magia-log-titulo">
                        ${o.nome}
                    </div>
                    <div class="magia-log-detalhe">
                        ${r}
                        ${d}
                    </div>
                    <div class="magia-log-data">${t}</div>
                </div>
            `,e.appendChild(l)})}catch(a){console.error("Erro ao carregar hist\xF3rico de magias:",a),e.innerHTML="<div class=\"ociosos-placeholder\">Erro ao consultar o grim\xF3rio.</div>"}}window.abrirHistoricoMagias=abrirHistoricoMagias;function iniciarSistemaDeEconomia(){document.addEventListener("visibilitychange",async()=>{if("hidden"===document.visibilityState){for(const e in console.log("\uD83D\uDCA4 Aba oculta: Pausando ouvintes para economizar leituras..."),modoEconomiaAtivo=!0,window.listenersAtivos)window.listenersAtivos[e]&&(window.listenersAtivos[e](),delete window.listenersAtivos[e]);"function"==typeof unsubscribeNotificacoes&&(unsubscribeNotificacoes(),unsubscribeNotificacoes=null),"function"==typeof unsubscribeDadosPessoais&&(unsubscribeDadosPessoais(),unsubscribeDadosPessoais=null),"function"==typeof unsubscribeFeed&&(unsubscribeFeed(),unsubscribeFeed=null),"function"==typeof unsubscribeBancosListener&&(unsubscribeBancosListener(),unsubscribeBancosListener=null),"function"==typeof unsubscribeAvatarListener&&(unsubscribeAvatarListener(),unsubscribeAvatarListener=null)}else if("visible"===document.visibilityState&&modoEconomiaAtivo){if(console.log("\u26A1 Aba ativa: Reconectando e sincronizando..."),modoEconomiaAtivo=!1,!currentUser)return;try{await sincronizarHorarioBrasilia()}catch(a){}configurarOuvintePresencaTempoReal(),configurarMuralTempoReal(),configurarNotificacoesTempoReal(),configurarOuvinteDadosPessoais(),configurarResumoSemanalTempoReal(),carregarBancosEquipes(),carregarDadosAvatar(),configurarOuvintesDePreviewDesenho(),carregarEExibirAvaliacoesDesenho(),await atualizarResumo(),atualizarVisualBloqueio(),console.log("\u2705 Sistema reconectado com sucesso.")}})}window.onload=async()=>{atualizarRelogio(),setInterval(atualizarRelogio,1e3),initAuth(),setupMaintenanceListenerAndCheck(),setupAdminBackdoor(),console.log("Iniciando Or\xE1culo e carregando dados..."),await inicializarGemini(),carregarBaseDeConhecimento(),configurarEventosChat();const e=await verificarEstadoManutencaoInicial();if(e)return console.log("Modo de Manuten\xE7\xE3o ATIVO. Bloqueado."),document.getElementById("maintenance-overlay").classList.remove("hidden"),void(document.body.style.overflow="hidden");const a=localStorage.getItem("loggedInUser");if(a)await performSuccessfulLogin(a);else{authContainer.classList.remove("hidden"),dataAtual=getHojeISO();const e=new Date().getHours(),a=document.body;a.classList.remove("tema-manha","tema-tarde","tema-noite"),5<=e&&12>e?a.classList.add("tema-manha"):12<=e&&18>e?a.classList.add("tema-tarde"):a.classList.add("tema-noite")}setInterval(verificarMudancaData,6e4),window.addEventListener("focus",verificarMudancaData),document.addEventListener("visibilitychange",async()=>{if("visible"===document.visibilityState){console.log("\uD83D\uDC40 Aba ativa. Re-sincronizando hor\xE1rio...");const e=document.getElementById("relogio");e&&(e.style.color="#f39c12");try{await sincronizarHorarioBrasilia()}catch(a){console.log("Sem rede.")}e&&(e.style.color=""),await verificarMudancaData()}}),window.abrirDetalhesMedalha=abrirDetalhesMedalha,window.handleQueroEssa=handleQueroEssa,window.abrirModalCompraMedalha=abrirModalCompraMedalha,window.abrirModalOrdenarMedalhas=abrirModalOrdenarMedalhas,window.mudarPaginaMedalhas=mudarPaginaMedalhas,window.processarJurosEAutolimpezaBancos=processarJurosEAutolimpezaBancos,"function"==typeof iniciarArrastoNudge&&iniciarArrastoNudge(),setTimeout(()=>{verificarNudgesDiarios(!1)},500),iniciarSistemaDeEconomia()};
