import{initializeApp}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";import{getFirestore,doc,setDoc,getDoc,collection,getDocs,updateDoc,deleteDoc,increment,writeBatch,query,where,onSnapshot,runTransaction,deleteField,orderBy,arrayUnion,addDoc,limit}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";const firebaseConfig={apiKey:"AIzaSyDoncRn8ikIdij8aXC0OUeqdqnLITrhmPc",authDomain:"foco-diario-75630.firebaseapp.com",projectId:"foco-diario-75630",storageBucket:"foco-diario-75630.appspot.com",messagingSenderId:"1040579676771",appId:"1:1040579676771:web:ca12f964d8adb3778e4656"},app=initializeApp(firebaseConfig),db=getFirestore(app);Date.prototype.getBrasiliaHours=function(){const e=this.getTimezoneOffset()+180;return(this.getHours()+Math.floor(e/60))%24};let streaksCache={},todosMembros=[],equipes={abelha:{membros:[],lider:null},joaninha:{membros:[],lider:null},vagalume:{membros:[],lider:null}},liderGeral=null,currentUser=null,userRole=null,userTeam=null,carrosselDesenhoPausado=!1,currentCarrosselDesenhoIndex=0,activeDrawingTeam=null,drawingContexts={},currentCarrosselIndex=0,carrosselPausado=!1,totalSlides=0,membroParaExpulsar=null,recompensasConfig={},isTestModeActive=!1,currentTestGameIndex=null,ordemJogosConfigurada=[],carrosselDesenhoInterval,progressoBarraDesenho,carrosselInterval,progressoBarra;const medalhas={3:{emoji:"\uD83D\uDD25",nome:"Fagulha"},10:{emoji:"\uD83D\uDC51",nome:"Lenda"},30:{emoji:"\uD83C\uDF1F",nome:"Constante"},60:{emoji:"\uD83D\uDC8E",nome:"Diamante"},120:{emoji:"\uD83D\uDE80",nome:"Foguete"},150:{emoji:"\uD83C\uDFC6",nome:"Trof\xE9u"},240:{emoji:"\uD83D\uDD2E",nome:"Bola de cristal"},365:{emoji:"\uD83C\uDF1E",nome:"Solar"},550:{emoji:"\uD83D\uDC09",nome:"M\xEDtico"},730:{emoji:"\uD83C\uDF83",nome:"Horripilante"},900:{emoji:"\uD83D\uDCA3",nome:"Poder Destrutivo"},1100:{emoji:"\uD83D\uDE07",nome:"Angelical"},1460:{emoji:"\uD83D\uDCA0",nome:"Primordial"},1825:{emoji:"\u267E\uFE0F",nome:"Eterno"}},totalDiasMembros={},pontosSemanais={abelha:0,joaninha:0,vagalume:0},rankingGeral={abelha:0,joaninha:0,vagalume:0},historicoAcoes={};let atualizando=!1,dataAtual="",filaAtualizacao=Promise.resolve(),popupQueue=[],isPopupShowing=!1,cliqueCount=0,initialDistance=null,isPinching=!1,composerSelectedColor="#CAFFBF",composerTimestampInterval=null,composerEditMode=!1,editingMessageId=null,messageIdToDelete=null,unsubscribeViewerListener=null,editingCommentId=null,commentIdToDelete=null,messageIdForCommentAction=null,checkboxLocks={},folgasManualmenteRemovidas={},currentUserRole="membro",currentUserTeam=null,memberIdToRemove=null,lastRefreshTimestamp=null,officialAppVersion=null,timeoutClique,authContainer,mainContent,logoutBtn,loginForm,changePasswordForm,forgotPasswordForm,secretQuestionForm,loginBtn,loginUsernameInput,loginPasswordInput;const EMOJIS_MURAL=["\uD83D\uDC4D","\uD83D\uDC96","\uD83D\uDE02","\uD83C\uDF89","\uD83D\uDD25","\uD83C\uDFAF","\uD83D\uDE2D","\uD83D\uDE21"];function getHoje(){return new Date}function getHojeISO(){const e=new Date,a=e.getFullYear(),o=(e.getMonth()+1+"").padStart(2,"0"),t=(e.getDate()+"").padStart(2,"0");return`${a}-${o}-${t}`}function formatarData(e){const a=(e.getDate()+"").padStart(2,"0"),o=(e.getMonth()+1+"").padStart(2,"0"),t=e.getFullYear();return`${a}/${o}/${t}`}function getDiaSemanaString(e=new Date){return["domingo","segunda-feira","ter\xE7a-feira","quarta-feira","quinta-feira","sexta-feira","s\xE1bado"][e.getDay()]}const diaParaIndice={domingo:0,dom:0,segunda:1,seg:1,ter√ßa:2,terca:2,ter:2,quarta:3,qua:3,quinta:4,qui:4,sexta:5,sex:5,s√°bado:6,sabado:6,sab:6};function getSemanaAtual(e=null){const a=e||getHoje(),o=a.getDay();if(0===o){const e=new Date(a);e.setDate(a.getDate()-1);const o=new Date(e);return o.setDate(e.getDate()-6),{inicio:o,fim:e,numero:Math.ceil((o-new Date(o.getFullYear(),0,1))/86400000/7),inicioFormatado:formatarData(o),fimFormatado:formatarData(e),fimCompeticao:formatarData(e).slice(0,5)}}const t=new Date(a);t.setDate(a.getDate()-(o-1));const n=new Date(t);n.setDate(t.getDate()+5);const r=new Date(t.getFullYear(),0,1),i=Math.floor((t-r)/86400000),d=Math.ceil((i+r.getDay()+1)/7);return{inicio:t,fim:n,numero:d,inicioFormatado:formatarData(t),fimFormatado:formatarData(n),fimCompeticao:formatarData(n).slice(0,5)}}async function salvarPresenca(){const e=getHoje(),a=getHojeISO(),o={};todosMembros.forEach(e=>{const a=e.nome,t=document.getElementById(a);t&&t.checked&&(o[a]=new Date)}),await setDoc(doc(db,"presencas",a),o,{merge:!0})}async function carregarPresenca(){const e=getHojeISO(),a=await getDoc(doc(db,"presencas",e));if(a.exists()){const e=a.data();todosMembros.forEach(a=>{const o=a.nome,t=document.getElementById(o);t&&e[o]&&(t.checked=!0)})}}async function carregarPontosSemanais(){const e=getHoje(),a=doc(db,"semanas","pontosSemanais"),o=await getDoc(a);if(o.exists()){const e=o.data();pontosSemanais.abelha=e.abelha||0,pontosSemanais.joaninha=e.joaninha||0,pontosSemanais.vagalume=e.vagalume||0}else 0!==e.getDay()&&(await setDoc(a,{abelha:0,joaninha:0,vagalume:0})),pontosSemanais.abelha=0,pontosSemanais.joaninha=0,pontosSemanais.vagalume=0}async function carregarRankingGeral(){const e=await getDoc(doc(db,"ranking","geral"));if(e.exists()){const a=e.data();rankingGeral.abelha=a.abelha||0,rankingGeral.joaninha=a.joaninha||0,rankingGeral.vagalume=a.vagalume||0}atualizarRankingGeral()}async function finalizarSemana(){const e=getHoje();if(6===e.getDay())try{const e=getSemanaAtual(),a=`semana_${e.numero}_${e.inicio.getFullYear()}`,o=doc(db,"vantagemSemanal",a),t=await getDoc(o);if(t.exists()&&t.data().palavraDaSemana){const e=t.data().palavraDaSemana.id;e&&(console.log(`Deletando a palavra da forca usada na semana: ${e}`),await deleteDoc(doc(db,"jogoDaForca",e)))}}catch(e){console.error("Erro ao deletar palavra da forca da semana:",e)}if(6===e.getDay()){console.log("Hoje \xE9 s\xE1bado. Verificando b\xF4nus do Jogo da Vantagem...");const e=getSemanaAtual(),a=`semana_${e.numero}_${e.inicio.getFullYear()}`,o=doc(db,"vantagemSemanal",a),t=doc(db,"semanas","pontosSemanais");let n=!1;try{if(await runTransaction(db,async e=>{const a=await e.get(o);if(a.exists()&&a.data().bonusAplicado)return void console.log("B\xF4nus da vantagem j\xE1 foi aplicado esta semana.");const r={abelha:0,joaninha:0,vagalume:0};let i=!1;const d=a.exists()?a.data().completadoPor||{}:{};for(const a in d){const e=todosMembros.find(e=>e.nome===a);e&&e.equipe&&(r[e.equipe]+=3,i=!0)}i&&(e.update(t,{abelha:increment(r.abelha),joaninha:increment(r.joaninha),vagalume:increment(r.vagalume)}),e.set(o,{bonusAplicado:!0},{merge:!0}),n=!0)}),n){console.log("Processando premia\xE7\xE3o e feed do Jogo da Vantagem...");const e=await getDoc(o),a=e.data().completadoPor||{},n={1:recompensasConfig.top5Vantagem_1||50,2:recompensasConfig.top5Vantagem_2||40,3:recompensasConfig.top5Vantagem_3||30,4:recompensasConfig.top5Vantagem_4||20,5:recompensasConfig.top5Vantagem_5||10},r=Object.entries(a).map(([e,a])=>({nome:e,tempo:a.toDate().getTime()})).sort((e,a)=>e.tempo-a.tempo).slice(0,5);if(0<r.length){const e=writeBatch(db);r.forEach((a,o)=>{const t=n[o+1];if(t){const o=doc(db,"membros",a.nome);e.update(o,{moedas:increment(t)}),a.nome===currentUser&&mostrarPopupMoedas(t)}}),await e.commit()}const i=await getDoc(t),d=i.data();pontosSemanais.abelha=d.abelha,pontosSemanais.joaninha=d.joaninha,pontosSemanais.vagalume=d.vagalume,mostrarPopup("\u2728 B\xF4nus Aplicado!","Pontos do Jogo da Vantagem foram adicionados!",6e3);await adicionarEventoAoFeed("vantagem","\u2728 B\xF4nus do Jogo da Vantagem!","Os pontos extras do Jogo da Vantagem foram distribu\xEDdos para as equipes que participaram!")}}catch(e){console.error("Erro na finaliza\xE7\xE3o do Jogo da Vantagem:",e)}}if(0===e.getDay()&&0<=e.getBrasiliaHours()){const a=doc(db,"semanas","pontosSemanais"),o=await getDoc(a);if(o.exists()&&0<Object.keys(o.data()).length){const t=o.data(),n=getSemanaAtual(new Date(e.setDate(e.getDate()-1))),r=`semana_${n.numero}_${n.inicio.getFullYear()}`,i=doc(db,"resultadosCompeticao",r),d={};todosMembros.forEach(e=>{d[e.nome]={nome:e.nome,equipe:e.equipe,pontuacao:{foco:0,vantagem:0,total:0}}});const s=formatarDataISO(n.inicio),l=formatarDataISO(n.fim),m=query(collection(db,"presencas"),where("__name__",">=",s),where("__name__","<=",l)),c=await getDocs(m);c.forEach(e=>{const a=e.data();for(const o in a)a[o]&&d[o]&&(d[o].pontuacao.foco++,d[o].pontuacao.total++)});const u=doc(db,"vantagemSemanal",r),g=await getDoc(u);if(g.exists()){const e=g.data().completadoPor||{};for(const a in e)d[a]&&(d[a].pontuacao.vantagem=3,d[a].pontuacao.total+=3)}const p=Object.entries(t).map(([e,a])=>({equipe:e,total:a})).sort((e,a)=>a.total-e.total),f={};let h=1;for(let e=0;e<p.length;e++)0<e&&p[e].total<p[e-1].total&&(h=e+1),f[p[e].equipe]=h;const E=doc(db,"vantagemSemanal",r),v=await getDoc(E),y=v.exists()?v.data().ajustesManuais||{}:{};await setDoc(i,{pontosEquipes:t,rankingEquipes:f,detalhesMembros:d,ajustesManuais:y,timestamp:new Date});let b=-1;const L=[];t.abelha>b&&(b=t.abelha),t.joaninha>b&&(b=t.joaninha),t.vagalume>b&&(b=t.vagalume),t.abelha===b&&L.push("abelha"),t.joaninha===b&&L.push("joaninha"),t.vagalume===b&&L.push("vagalume");const B=1<L.length,C=L.filter(e=>t[e]===b);if(0<C.length&&0<b){const e=doc(db,"ranking","geral"),a={};C.forEach(e=>{a[e]=increment(1),rankingGeral[e]++}),await updateDoc(e,a),atualizarRankingGeral();const o={abelha:"Abelha",joaninha:"Joaninha",vagalume:"Vaga-lume"},t=C.map(e=>o[e]).join(" e ");B?(mostrarPopup("\uD83C\uDFC6 Empate Semanal",`As equipes ${t} empataram com ${b} pontos!`,8e3),await adicionarEventoAoFeed("vitoria","\uD83C\uDFC6 Empate na Competi\xE7\xE3o Semanal!",`Que disputa acirrada! As equipes <strong>${t}</strong> empataram com <strong>${b}</strong> pontos.`,{vencedoras:C})):(mostrarPopup("\uD83C\uDFC6 Vit\xF3ria Semanal",`Equipe ${t} venceu a semana com ${b} pontos!`,8e3),await adicionarEventoAoFeed("vitoria","\uD83C\uDFC6 Temos uma Campe\xE3 Semanal!",`A equipe <strong>${t}</strong> venceu com <strong>${b}</strong> pontos!`,{vencedoras:C}));const n=writeBatch(db);C.forEach(e=>{equipes[e].membros.forEach(e=>{const a=doc(db,"membros",e.nome);n.update(a,{moedas:increment(recompensasConfig.vitoriaSemanal||500)})})}),await n.commit();const r=C.map(e=>e.charAt(0).toUpperCase()+e.slice(1)),i=`Como recompensa, cada membro da(s) equipe(s) <strong>${r.join(" e ")}</strong> recebeu <strong>${recompensasConfig.vitoriaSemanal||500} üí∞ moedas</strong>!`;await adicionarEventoAoFeed("vitoria","\uD83D\uDCB0 Recompensa de Campe\xE3o!",i)}await calcularMembrosOciosos(),await deleteDoc(a),pontosSemanais.abelha=0,pontosSemanais.joaninha=0,pontosSemanais.vagalume=0,atualizarPlacarSemanal()}}}function getMedalha(e){const a=Object.keys(medalhas).map(Number).sort((e,a)=>a-e);for(const o of a)if(e>=o)return medalhas[o];return null}async function atualizarMedalhas(){for(const e in streaksCache)Object.hasOwnProperty.call(streaksCache,e)&&atualizarStreakVisualMembro(e,streaksCache[e])}function atualizarPlacarSemanal(){document.getElementById("resumo-abelha")&&(document.getElementById("resumo-abelha").innerHTML=`
        <div>${document.querySelectorAll("#equipe-abelha input:checked").length} focaram hoje!</div>
        <div>${pontosSemanais.abelha} pontos na semana</div>
      `),document.getElementById("resumo-joaninha")&&(document.getElementById("resumo-joaninha").innerHTML=`
        <div>${document.querySelectorAll("#equipe-joaninha input:checked").length} focaram hoje!</div>
        <div>${pontosSemanais.joaninha} pontos na semana</div>
      `),document.getElementById("resumo-vagalume")&&(document.getElementById("resumo-vagalume").innerHTML=`
        <div>${document.querySelectorAll("#equipe-vagalume input:checked").length} focaram hoje!</div>
        <div>${pontosSemanais.vagalume} pontos na semana</div>
      `)}function atualizarRankingGeral(){document.getElementById("ranking-abelha")&&(document.getElementById("ranking-abelha").textContent=rankingGeral.abelha),document.getElementById("ranking-joaninha")&&(document.getElementById("ranking-joaninha").textContent=rankingGeral.joaninha),document.getElementById("ranking-vagalume")&&(document.getElementById("ranking-vagalume").textContent=rankingGeral.vagalume),atualizarPodioEquipes()}function configurarOuvintePresencaTempoReal(){const e=getHojeISO(),a=doc(db,"presencas",e);onSnapshot(a,e=>{console.log("Sincroniza\xE7\xE3o em tempo real: O documento de presen\xE7as foi atualizado.");let a={};e.exists()&&(a=e.data()),todosMembros.forEach(e=>{const o=document.getElementById(e.nome);if(o){const t=!!a[e.nome];o.checked!==t&&(o.checked=t)}}),atualizarResumo()})}window.atualizarResumo=async function(){0===todosMembros.length||(filaAtualizacao=filaAtualizacao.then(async()=>{const e=getHoje(),a=getHojeISO(),o=todosMembros.filter(e=>document.getElementById(e.nome)?.checked).length,t=todosMembros.length;if(document.getElementById("contadorGeral")){document.getElementById("contadorGeral").textContent=`${o} √©picos focaram hoje!`;const e=0<t?100*(o/t):0,a=document.getElementById("progresso-barra");a.style.width=`${e}%`;const n=document.getElementById("marcador-arvore");if(n&&0<t){const e=100*(10/t);100>=e?(n.style.left=`${e}%`,n.style.display="flex"):n.style.display="none"}const r=document.querySelector(".global-stats"),i=document.getElementById("mensagem-todos-focados");o===t?(a.classList.add("rainbow-progress"),r.classList.add("rainbow-border"),i&&(i.textContent="Todos focaram hoje, estamos de parab\xE9ns!!",i.classList.remove("hidden"))):(a.classList.remove("rainbow-progress"),r.classList.remove("rainbow-border"),i&&i.classList.add("hidden"))}atualizarPlacarSemanal(),verificarEquipeCompleta(),await verificarArvoreEpica(o),await carregarTop5Semana()}).catch(e=>{console.error("Erro na atualiza\xE7\xE3o:",e)}),await filaAtualizacao)};function verificarEquipeCompleta(){for(const e in equipes){const a=document.getElementById(`equipe-${e}`),o=document.getElementById(`msg-equipe-${e}`);if(!a||!o)continue;const t=equipes[e].membros.every(e=>document.getElementById(e.nome)?.checked),n=`membro-completo-${e}`;if(equipes[e].membros.forEach(a=>{const o=document.getElementById(a.nome)?.parentElement;o&&(t&&0<equipes[e].membros.length?o.classList.add(n):o.classList.remove(n))}),o.classList.remove("abelha","joaninha","vagalume"),t&&0<equipes[e].membros.length){a.classList.add("equipe-completa",e);const t=e.charAt(0).toUpperCase()+e.slice(1);o.textContent=`Parab√©ns, equipe ${t}!! Voc√™s gabaritaram hoje!!!`,o.classList.add(e),o.classList.remove("hidden")}else a.classList.remove("equipe-completa",e),o.classList.add("hidden")}}function mostrarCardPopup(e,a,o=null){const t=document.getElementById("custom-card-popup"),n=document.getElementById("card-popup-title"),r=document.getElementById("card-popup-message"),i=document.getElementById("card-popup-close-btn");n.textContent=e,r.innerHTML=a;const d=document.body.className;d.includes("tema-noite")?t.classList.add("tema-noite"):t.classList.remove("tema-noite"),t.classList.add("show");const s=()=>{t.classList.remove("show"),o&&o()};i.onclick=s,t.onclick=e=>{e.target===t&&s()}}window.mostrarPopup=function(e,a,o=4e3){popupQueue.push({titulo:e,mensagem:a,duracao:o}),isPopupShowing||processPopupQueue()};function processPopupQueue(){if(0===popupQueue.length||isPopupShowing)return;isPopupShowing=!0;const e=popupQueue.shift(),a=document.getElementById("popup-message");return a?void(a.innerHTML=`<strong>${e.titulo}</strong><br>${e.mensagem}`,a.classList.add("show"),setTimeout(()=>{a.classList.remove("show"),setTimeout(()=>{isPopupShowing=!1,processPopupQueue()},500)},e.duracao)):void(isPopupShowing=!1)}function mostrarPopupMoedas(e){if(0<e){mostrarPopup("\uD83C\uDF89 Recompensa!",`Voc√™ ganhou <strong>${e} üí∞ moedas</strong>!`,3500)}}const medalhasConcedidas={};function atualizarStreakVisualMembro(e,a){const o=document.getElementById(`dias-${e}`);o&&(o.textContent=a,o.title=`${a} dias de foco consecutivos`);const t=document.getElementById(`medalha-${e}`);if(t){const e=getMedalha(a);e?(t.innerHTML=e.emoji,t.title=`${e.nome} - ${a} dias de foco consecutivos`,t.classList.add("com-medalha"),t.classList.remove("escondido")):(t.innerHTML="",t.classList.remove("com-medalha"),t.classList.add("escondido"))}}function dispararConfete(){function e(n){r=n,o.clearRect(0,0,a.width,a.height);let d=0;for(let e=0;e<t.length;e++){const n=t[e];n.y+=n.speed,n.x+=n.drift,n.angle+=n.spin,o.save(),o.translate(n.x+n.w/2,n.y+n.h/2),o.rotate(n.angle),o.fillStyle=n.color,o.fillRect(-n.w/2,-n.h/2,n.w,n.h),o.restore(),n.y<a.height&&d++}0<d?requestAnimationFrame(e):o.clearRect(0,0,a.width,a.height)}const a=document.getElementById("confetti-canvas");if(!a)return;const o=a.getContext("2d");a.width=window.innerWidth,a.height=window.innerHeight;const t=[],n=["#FFD700","#FF6B6B","#2ECC71","#3498DB","#9B59B6","#FAD390"];for(let e=0;e<200;e++)t.push({x:Math.random()*a.width,y:-Math.random()*a.height,w:8*Math.random()+5,h:15*Math.random()+8,color:n[Math.floor(Math.random()*n.length)],angle:2*(Math.random()*Math.PI),speed:4*Math.random()+2,spin:.4*Math.random()-.2,drift:2*Math.random()-1});let r=0;requestAnimationFrame(e)}function iniciarConfeteAniversarioContinuo(){function e(){o.clearRect(0,0,a.width,a.height);for(let e=particulasAniversario.length-1;0<=e;e--){const t=particulasAniversario[e];t.y+=t.speed,t.x+=t.drift,t.angle+=t.spin,o.save(),o.translate(t.x+t.w/2,t.y+t.h/2),o.rotate(t.angle),o.fillStyle=t.color,o.fillRect(-t.w/2,-t.h/2,t.w,t.h),o.restore(),t.y>a.height+20&&particulasAniversario.splice(e,1)}animacaoConfeteAniversarioId=requestAnimationFrame(e)}if(animacaoConfeteAniversarioId)return;const a=document.getElementById("confetti-canvas");if(!a)return;const o=a.getContext("2d");a.width=window.innerWidth,a.height=window.innerHeight;const t=["#FFD700","#FF6B6B","#2ECC71","#3498DB","#9B59B6","#FAD390"];geradorDeParticulasId=setInterval(()=>{particulasAniversario.push({x:Math.random()*a.width,y:-20,w:6*Math.random()+4,h:12*Math.random()+6,color:t[Math.floor(Math.random()*t.length)],angle:2*(Math.random()*Math.PI),speed:2*Math.random()+1,spin:.2*Math.random()-.1,drift:1*Math.random()-.5})},200),e()}function pararConfeteAniversarioContinuo(){geradorDeParticulasId&&(clearInterval(geradorDeParticulasId),geradorDeParticulasId=null),animacaoConfeteAniversarioId&&(cancelAnimationFrame(animacaoConfeteAniversarioId),animacaoConfeteAniversarioId=null),particulasAniversario=[];const e=document.getElementById("confetti-canvas");if(e){const a=e.getContext("2d");a.clearRect(0,0,e.width,e.height)}}async function verificarEConfirmarFolgas(){console.log("\uD83D\uDD75\uFE0F Vigia de folgas em a\xE7\xE3o...");const e=getHoje(),a=e.getDay(),o=getHojeISO(),t=doc(db,"presencas",o),n=await getDoc(t),r=n.exists()?n.data():{};console.log(`-> Hoje o √≠ndice do dia √© ${a}. Verificando membros...`);for(const e of todosMembros){const o=(e.folga||"").toLowerCase().replace("-feira","").trim(),t=diaParaIndice[o];if(0===a||t===a){0===a?console.log(`-> Hoje √© domingo (folga coletiva). Verificando ${e.nome}.`):console.log(`-> Membro ${e.nome} est√° de folga hoje (√çndice ${t}).`);const o=document.getElementById(e.nome);!o||o.checked||folgasManualmenteRemovidas[e.nome]||r[e.nome]?o&&o.checked?console.log(`-> Checkbox de ${e.nome} j√° est√° marcada.`):r[e.nome]&&console.log(`-> A√ß√£o para ${e.nome} ignorada, pois j√° existe um registro de presen√ßa no DB hoje.`):(console.log(`%cFOLGA CORRIGIDA: A checkbox de ${e.nome} ser√° remarcada (registro no DB n√£o encontrado).`,"color: green; font-weight: bold;"),await marcarFolgaAutomatica(e),o.checked=!0,await atualizarResumo())}}console.log("\uD83D\uDD75\uFE0F Verifica\xE7\xE3o de folgas conclu\xEDda.")}window.marcarCheckbox=async function(e){if(checkboxLocks[e]){const a=document.getElementById(e);return void(a&&(a.checked=!a.checked))}checkboxLocks[e]=!0;const a=document.getElementById(e),o=todosMembros.find(a=>a.nome===e);if(!a||!o)return void(checkboxLocks[e]=!1);const t=()=>"lider"===userRole||"lider-equipe"===userRole&&o.equipe===userTeam||"membro"===userRole&&currentUser===e;if(!t())return a.checked=!a.checked,mostrarPopup("\uD83D\uDEAB Acesso Negado","Voc\xEA n\xE3o tem permiss\xE3o para alterar o foco de outro membro.",4e3),void(checkboxLocks[e]=!1);const n=getHoje(),r=0===n.getDay(),i=a.checked?"adicionar":"remover",d=o.equipe,s=getDiaSemanaString(n);"remover"===i&&o.folga===s&&(folgasManualmenteRemovidas[e]=!0);try{const{streakAtual:a,novosPontosEquipe:o}=await verificarConquista(e,i,d,r);if(streaksCache[e]=a,d&&pontosSemanais.hasOwnProperty(d)&&(pontosSemanais[d]=o),atualizarStreakVisualMembro(e,a),"adicionar"===i?(mostrarPopup("\uD83C\uDF89 Foco Registrado",`${e}, parab√©ns por ter focado hoje!`,3e3),currentUser===e&&mostrarPopupMoedas(recompensasConfig.focoDiario||100)):mostrarPopup("\u2139\uFE0F Foco Removido",`${e}, seu foco de hoje foi removido`,3e3),await carregarTop5Semana(),"adicionar"===i&&!r)if(d&&pontosSemanais.hasOwnProperty(d)){const a=d.charAt(0).toUpperCase()+d.slice(1);await adicionarEventoAoFeed("geral",`üìà Ponto para a ${a}!`,`A equipe <strong>${a}</strong> avan√ßa com +1 ponto de <strong>${e}</strong>, totalizando <strong>${o}</strong> pontos!`,{nomeMembro:e,equipe:d})}else await adicionarEventoAoFeed("geral","\uD83C\uDF1F Foco Pessoal Registrado!",`Mesmo sem uma equipe na competi√ß√£o, <strong>${e}</strong> mant√©m a disciplina e registra seu foco de hoje. Parab√©ns pela dedica√ß√£o!`,{nomeMembro:e})}catch(e){console.error("Erro no fluxo principal de marcarCheckbox:",e),a.checked=!a.checked}finally{checkboxLocks[e]=!1}};async function marcarFolgaAutomatica(e,a=!0){if(!e||!e.nome)return;const o=e.nome,t=getHojeISO();try{const n=doc(db,"membros",o),r=doc(db,"presencas",t);await runTransaction(db,async e=>{e.set(r,{[o]:new Date},{merge:!0}),e.update(n,{streak:increment(1)})});const i=await getDoc(n),d=i.exists()?i.data().streak:0;if(streaksCache[o]=d,atualizarStreakVisualMembro(o,d),e.equipe&&0!==getHoje().getDay()&&pontosSemanais[e.equipe]++,a){let a=`A caixa de sele√ß√£o de <strong>${o}</strong> foi marcada automaticamente, pois hoje √© o seu dia de folga. Bom descanso!`;if(e.equipe&&Object.keys(equipes).includes(e.equipe)&&0!==getHoje().getDay()){const t=e.equipe.charAt(0).toUpperCase()+e.equipe.slice(1),n=pontosSemanais[e.equipe];a=`A caixa de sele√ß√£o de <strong>${o}</strong> foi marcada automaticamente, pois hoje √© o seu dia de folga. Isso garante +1 ponto para a equipe <strong>${t}</strong>, totalizando <strong>${n}</strong> pontos! Bom descanso <strong>${o}</strong>!!`}await adicionarEventoAoFeed("geral","\uD83C\uDF34 Dia de Descanso Merecido!",a,{nomeMembro:o})}console.log(`Folga de ${o} marcada com sucesso (Pontua√ß√£o e Presen√ßa atualizadas no local correto).`)}catch(e){console.error(`Erro ao marcar folga autom√°tica para ${o}:`,e)}}window.resetarTudo=async function(){if(confirm("\u26A0\uFE0F ATEN\xC7\xC3O: Voc\xEA est\xE1 prestes a resetar TODOS os dados!\nIsso apagar\xE1 todo o hist\xF3rico e pontos.\n\nDeseja continuar?"))try{const e=await getDocs(collection(db,"presencas"));for(const a of e.docs)await deleteDoc(a.ref);const a=doc(db,"semanas","pontosSemanais"),o=await getDoc(a);o.exists()&&(await deleteDoc(a));const t=doc(db,"ranking","geral");await setDoc(t,{abelha:0,joaninha:0,vagalume:0});const n=doc(db,"arvoreEpica","progresso");await deleteDoc(n);const r=await getDocs(collection(db,"streak"));for(const e of r.docs)await deleteDoc(e.ref);pontosSemanais.abelha=0,pontosSemanais.joaninha=0,pontosSemanais.vagalume=0,rankingGeral.abelha=0,rankingGeral.joaninha=0,rankingGeral.vagalume=0,await carregarPresenca(),await carregarTotalDias(),await carregarPontosSemanais(),await carregarRankingGeral(),await carregarArvoreEpica(),atualizarPlacarSemanal(),atualizarRankingGeral(),atualizarMedalhas(),atualizarExibicaoArvore(),mostrarPopup("\u2705 Reset Completo","Todos os dados foram resetados com sucesso!",5e3)}catch(e){console.error("Erro ao resetar dados:",e),mostrarPopup("\u274C Erro no Reset","Ocorreu um erro ao tentar resetar os dados.",5e3)}},window.resetarDia=async function(e=!1){if(!resetEmAndamento){if(resetEmAndamento=!0,!e&&!confirm("\u26A0\uFE0F ATEN\xC7\xC3O: Voc\xEA est\xE1 prestes a desmarcar TODOS os checkboxes do dia atual e zerar o contador do dia.\n\nIsso n\xE3o afetar\xE1 os pontos semanais ou streaks.\n\nDeseja continuar?"))return void(resetEmAndamento=!1);try{todosMembros.forEach(e=>{const a=e.nome,o=document.getElementById(a);if(o){o.checked=!1;const e=o.nextElementSibling;e&&e.classList.remove("checked")}});const a=getHojeISO(),o=doc(db,"presencas",a);await deleteDoc(o),document.getElementById("contadorGeral")&&(document.getElementById("contadorGeral").textContent="0 \xE9picos focaram hoje!",document.getElementById("progresso-barra").style.width="0%"),atualizarPlacarSemanal(),await Promise.all([carregarStreaks()]),e||mostrarPopup("\u2705 Dia Resetado","Todos os checkboxes foram desmarcados e o dia foi zerado.",5e3)}catch(e){console.error("Erro ao resetar o dia:",e),mostrarPopup("\u274C Erro","Ocorreu um erro ao resetar o dia.",5e3)}}};async function limparColecaoSemanas(){try{const e=collection(db,"semanas"),a=await getDocs(e);a.forEach(async e=>{"pontosSemanais"!==e.id&&(console.warn(`Apagando documento indesejado na cole√ß√£o 'semanas': ${e.id}`),await deleteDoc(doc(db,"semanas",e.id)))})}catch(e){console.error("Erro ao limpar cole\xE7\xE3o 'semanas':",e)}}async function limparMuralSemanal(){try{const e=getHoje();if(1!==e.getDay())return;const a=new Date(e);a.setDate(a.getDate()-7);const o=getSemanaAtual(a).numero,t=query(collection(db,"mural"),where("semana","<",o)),n=await getDocs(t),r=writeBatch(db);n.forEach(e=>{r.delete(e.ref)}),await r.commit(),console.log(`Mural limpo: ${n.size} mensagens antigas removidas`)}catch(e){console.error("Erro ao limpar mural:",e)}}const fasesArvore=[{dias:1,nome:"Semente",emoji:"\uD83C\uDF31",desc:"A jornada come\xE7a com um \xFAnico dia de foco. Vamos plantar nossa semente e cultivar nossa dedica\xE7\xE3o di\xE1ria!"},{dias:15,nome:"Broto",emoji:"\uD83C\uDF3F",desc:"Com 15 dias consecutivos, nosso esfor\xE7o come\xE7a a brotar. Vamos continuar regando nossa determina\xE7\xE3o!"},{dias:60,nome:"\xC1rvore",emoji:"\uD83C\uDF33",desc:"60 dias de foco ininterrupto! Nossa \xE1rvore cresce forte, simbolizando nossa consist\xEAncia e perseveran\xE7a."},{dias:180,nome:"Flores",emoji:"\uD83C\uDF38",desc:"180 dias de dedica\xE7\xE3o fazem florescer resultados. Cada flor representa uma conquista em nossa jornada!"},{dias:365,nome:"Frutos",emoji:"\uD83C\uDF4E",desc:"365 dias de foco cont\xEDnuo! Agora colhemos os frutos do nosso trabalho \xE1rduo e da nossa dedica\xE7\xE3o inabal\xE1vel."}];let arvoreEpica={consecutivos:0,ultimoDia:null,faseAtual:0};async function carregarEstadoArvore(){const e=doc(db,"arvoreEpica","progresso"),a=await getDoc(e);a.exists()?arvoreEpica=a.data():(arvoreEpica={consecutivos:0,ultimoDia:null,faseAtual:0},await setDoc(e,arvoreEpica))}async function verificarArvoreEpica(e){const a=getHojeISO();await carregarEstadoArvore();const o=getHoje(),t=todosMembros.length,n=document.getElementById("status-focado"),r=document.getElementById("status-nao-focado");n&&(n.textContent=`‚úÖ ${e} √©picos focaram hoje`),r&&(r.textContent=`‚ùå ${t-e} √©picos ainda n√£o focaram`);const i=arvoreEpica.ultimoDia,d=new Date(o);d.setDate(d.getDate()-1);const s=formatarDataISO(d),l=i===a;if(10<=e){if(!l){i?i===s?arvoreEpica.consecutivos++:arvoreEpica.consecutivos=1:arvoreEpica.consecutivos=1,arvoreEpica.ultimoDia=a;let e=0;for(let a=fasesArvore.length-1;0<=a;a--)if(arvoreEpica.consecutivos>=fasesArvore[a].dias){e=a;break}arvoreEpica.faseAtual=e;const o=doc(db,"arvoreEpica","progresso");if(await setDoc(o,arvoreEpica),atualizarExibicaoArvore(),0<e&&arvoreEpica.consecutivos===fasesArvore[e].dias){const a=document.getElementById("som-conquista");a&&(a.currentTime=0,a.play()),mostrarPopup("\uD83C\uDF33 \xC1rvore \xC9pica",`Parab√©ns! A √°rvore evoluiu para: ${fasesArvore[e].nome} ${fasesArvore[e].emoji}`,5e3),dispararConfete(),await adicionarEventoAoFeed("arvore","\uD83C\uDF33 A \xC1rvore Evoluiu!",`Com o esfor√ßo de todos, nossa √Årvore √âpica alcan√ßou a fase de ${fasesArvore[e].emoji} <strong>${fasesArvore[e].nome}</strong>! Continuem focando!`,{fase:fasesArvore[e].nome})}}}else if(l){arvoreEpica.consecutivos=Math.max(0,arvoreEpica.consecutivos-1),arvoreEpica.ultimoDia=0<arvoreEpica.consecutivos?s:null;let e=0;for(let a=fasesArvore.length-1;0<=a;a--)if(arvoreEpica.consecutivos>=fasesArvore[a].dias){e=a;break}arvoreEpica.faseAtual=e;const a=doc(db,"arvoreEpica","progresso");await setDoc(a,arvoreEpica),atualizarExibicaoArvore()}}async function carregarArvoreEpica(){await carregarEstadoArvore(),atualizarExibicaoArvore()}function criarEstrelas(){const e=document.querySelectorAll(".stars-container");0===e.length||e.forEach(e=>{if(!(0<e.children.length)){e.innerHTML="";for(let a=0;a<150;a++){const a=document.createElement("div");a.classList.add("star");const o=3*Math.random()+1;a.style.width=`${o}px`,a.style.height=`${o}px`,a.style.left=`${100*Math.random()}%`,a.style.top=`${100*Math.random()}%`,a.style.animationDelay=`${4*Math.random()}s`,a.style.animationDuration=`${2+3*Math.random()}s`,e.appendChild(a)}}})}function atualizarExibicaoArvore(){if(!document.getElementById("stage-name"))return;const e=fasesArvore[arvoreEpica.faseAtual];document.getElementById("stage-name").textContent=e.nome+" "+e.emoji,document.getElementById("stage-desc").textContent=e.desc,document.getElementById("dias-consecutivos").textContent=arvoreEpica.consecutivos;["seed","sprout","tree","flowers","fruits"].forEach((e,a)=>{const o=document.getElementById(e);o&&(a===arvoreEpica.faseAtual?o.style.display="block":o.style.display="none")});const a=arvoreEpica.faseAtual<fasesArvore.length-1?fasesArvore[arvoreEpica.faseAtual+1]:null,o=document.getElementById("proxima-fase");if(o)if(a){const e=a.dias-arvoreEpica.consecutivos;o.textContent=`Faltam ${e} dias para ${a.nome} ${a.emoji}`}else o.textContent="Voc\xEA alcan\xE7ou o n\xEDvel m\xE1ximo!";const t=getHoje(),n=t.getHours(),r=18<=n||6>n,i=document.querySelector("#secao-arvore-epica .tree-sky");if(i){const e=i.querySelector(".stars-container");r?(i.classList.add("night-mode"),i.classList.remove("day-mode"),criarEstrelas(),e&&(e.style.opacity="1")):(i.classList.remove("night-mode"),i.classList.add("day-mode"),e&&(e.style.opacity="0"))}const d=document.getElementById("sol"),s=document.getElementById("lua");d&&s&&(d.style.opacity=r?"0":"1",s.style.opacity=r?"1":"0")}async function verificarMudancaData(){const e=getHojeISO();dataAtual===e?atualizarDataCabecalho():(dataAtual=e,await executarRotinaDeMeiaNoite())}let resetEmAndamento=!1;async function executarRotinaDeMeiaNoite(){console.log("\uD83D\uDD5B Executando rotina da meia-noite..."),await verificarEConcederPremiacaoDiaria(),folgasManualmenteRemovidas={};const e=getHoje(),a=getDiaSemanaString(e),o=0===e.getDay();1===e.getDay(),await resetarDia(!0),await finalizarSemana(),atualizarDataCabecalho(),atualizarInfoSemana(),await carregarPontosSemanais(),atualizarPlacarSemanal(),await carregarArvoreEpica(),await atualizarResumo(),console.log("\u2705 Rotina da meia-noite conclu\xEDda. A interface foi atualizada.")}function atualizarDataCabecalho(){const e=getHoje(),a=e.toLocaleDateString("pt-BR",{weekday:"long",day:"numeric",month:"long"}),o=document.getElementById("dataHoje");o&&(o.textContent=a.charAt(0).toUpperCase()+a.slice(1))}function atualizarInfoSemana(){const e=getSemanaAtual(),a=document.getElementById("info-semana");a&&(a.innerHTML=`
        <div style="font-weight:bold"><span class="destaque-semana">Semana ${e.numero}</span></div>
        <div>(${e.inicioFormatado} a ${e.fimFormatado})</div>
        <div style="font-size:0.9rem;margin-top:5px;color:#7f8c8d">
          A competi√ß√£o ser√° encerrada s√°bado (${e.fimCompeticao}), √†s 23:59h.
        </div>
      `)}function isColorDark(e){const a="#"===e.charAt(0)?e.substring(1,7):e,o=parseInt(a.substring(0,2),16),t=parseInt(a.substring(2,4),16),n=parseInt(a.substring(4,6),16);return 128>.299*o+.587*t+.114*n}async function openMessageViewer(a){unsubscribeViewerListener&&(unsubscribeViewerListener(),unsubscribeViewerListener=null);const o=document.getElementById("message-viewer-modal");openModal("message-viewer-modal"),o.dataset.activeMessageId=a;const t=doc(db,"mural",a);unsubscribeViewerListener=onSnapshot(t,e=>{if(!e.exists())return void closeModal("message-viewer-modal");const t=e.data(),n=document.getElementById("viewer-card"),r=document.getElementById("viewer-text"),i=document.getElementById("viewer-author"),d=document.getElementById("viewer-timestamp"),s=document.getElementById("viewer-reacoes-container"),l=t.timestamp;n.style.backgroundColor=t.cor,i.textContent=t.nome,d.textContent=`${l.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"})} - ${l.toLocaleDateString("pt-BR")}`,r.innerHTML=(t.texto||"").replace(/\n/g,"<br>"),isColorDark(t.cor)?n.classList.add("text-light"):n.classList.remove("text-light");const m=t.reacoes||{};let c="",u=!1;const g=Object.keys(m).sort((e,a)=>{const o=Array.isArray(m[e])?m[e].length:0,t=Array.isArray(m[a])?m[a].length:0;return t-o});for(const o of g){const e=Array.isArray(m[o])?m[o]:[],t=e.length;if(0<t){u=!0;const n=e.includes(currentUser),r=n?"reacted":"",i=0<e.length?`Reagido por: ${e.join(", ")}`:`Reagir com ${o}`;c+=`
  <div 
    class="reacao-display ${r}" 
    title="${i}"
    data-emoji="${o}" onclick="window.abrirModalReagentes('${a}', '${o}')">
    ${o} <span class="contador-display">${t}</span>
  </div>
`}}s.innerHTML=c,s.style.display=u?"flex":"none";const p=o.querySelector(".reacao-seletor-bar");p.innerHTML="";EMOJIS_MURAL.forEach(o=>{const t=document.createElement("button");t.textContent=o,t.onclick=t=>{t.stopPropagation(),window.toggleReacao(a,o,t)},p.appendChild(t)}),p.style.display="grid"})}async function confirmDelete(){if(messageIdToDelete){const e=doc(db,"mural",messageIdToDelete);try{const a=await getDoc(e);if(a.exists()){const e=a.data().userId;if(e&&"An\xF4nimo"!==e){const a=doc(db,"membros",e);await updateDoc(a,{moedas:increment(-5)}),console.log(`-5 moedas removidas de ${e} pela exclus√£o da mensagem.`)}}await deleteDoc(e),mostrarPopup("\u2705 Sucesso","Mensagem exclu\xEDda!",3e3)}catch(e){mostrarPopup("\u274C Erro","Falha ao excluir a mensagem.",3e3),console.error("Erro ao excluir:",e)}finally{closeModal("confirm-delete-modal"),messageIdToDelete=null}}}function openMessageComposer(e=null){const a=document.getElementById("composer-send-btn");if(e){document.getElementById("composer-textarea").value=e.texto;const o="An\xF4nimo"===e.nome;document.getElementById("composer-anonymous-check").checked=o,document.getElementById("composer-author").textContent=o?"An\xF4nimo":currentUser,selectComposerColor(e.cor),a.textContent="Salvar Altera\xE7\xF5es"}else document.getElementById("composer-textarea").value="",document.getElementById("composer-anonymous-check").checked=!1,document.getElementById("composer-author").textContent=currentUser,selectComposerColor("#CAFFBF"),a.textContent="Enviar",composerEditMode=!1,editingMessageId=null;updateComposerTimestamp(),composerTimestampInterval=setInterval(updateComposerTimestamp,1e3),openModal("message-composer-modal")}function closeMessageComposer(){clearInterval(composerTimestampInterval),closeModal("message-composer-modal"),composerEditMode=!1,editingMessageId=null}function updateComposerTimestamp(){const e=new Date,a=e.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"}),o=e.toLocaleDateString("pt-BR");document.getElementById("composer-timestamp").textContent=`${a} - ${o}`}function selectComposerColor(e){composerSelectedColor=e;const a=document.getElementById("composer-card"),o=document.getElementById("composer-color-btn");a.style.backgroundColor=e,o.style.backgroundColor=e,isColorDark(e)?(a.classList.add("text-light"),o.classList.add("text-light")):(a.classList.remove("text-light"),o.classList.remove("text-light")),document.getElementById("composer-color-palette").classList.add("hidden")}window.enviarMensagem=async function(){const e=document.getElementById("composer-anonymous-check").checked,a=e?"An\xF4nimo":currentUser,o=document.getElementById("composer-textarea").value.trim();if(!o)return void mostrarPopup("\u270D\uFE0F Aten\xE7\xE3o","Digite uma mensagem.",3e3);const t={nome:a,texto:o,cor:composerSelectedColor,userId:currentUser};try{if(composerEditMode&&editingMessageId){const e=doc(db,"mural",editingMessageId);await updateDoc(e,t),mostrarPopup("\u2705 Sucesso","Mensagem editada!",3e3)}else{if(!composerEditMode)try{const e=query(collection(db,"mural"),where("userId","==",currentUser)),a=await getDocs(e),o=a.size;if(3<=o)return void mostrarPopup("\uD83D\uDEAB Limite Atingido","Voc\xEA j\xE1 postou o m\xE1ximo de 3 mensagens. Apague uma antiga para poder postar uma nova.",5e3)}catch(e){return console.error("Erro ao verificar limite de mensagens:",e),void mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel verificar seu limite de mensagens. Tente novamente.",4e3)}t.timestamp=new Date,t.reacoes=EMOJIS_MURAL.reduce((e,a)=>({...e,[a]:[]}),{}),t.semana=getSemanaAtual().numero;const o=doc(collection(db,"mural"));await setDoc(o,t);const n=doc(db,"membros",currentUser);await updateDoc(n,{moedas:increment(recompensasConfig.postarMural||5)}),mostrarPopup("\u2705 Sucesso","Mensagem enviada!",3e3),mostrarPopupMoedas(recompensasConfig.postarMural||5);const r=e?"<strong>Um an\xF4nimo</strong> compartilhou uma nova mensagem no mural. D\xEA uma olhada!":`<strong>${a}</strong> compartilhou uma nova mensagem no mural. D√™ uma olhada!`;await adicionarEventoAoFeed("geral","\u270D\uFE0F Nova Mensagem no Mural!",r,{nomeMembro:a})}closeMessageComposer()}catch(e){console.error("Erro:",e),mostrarPopup("\u274C Erro","Ocorreu um erro.",3e3)}finally{composerEditMode=!1,editingMessageId=null}},window.editarMensagem=async function(e,a){e.stopPropagation(),composerEditMode=!0,editingMessageId=a;try{const e=await getDoc(doc(db,"mural",a));e.exists()&&openMessageComposer(e.data())}catch(e){console.error("Erro ao buscar mensagem para editar:",e)}},window.excluirMensagem=function(e,a){e.stopPropagation(),messageIdToDelete=a,openModal("confirm-delete-modal")};function createColorPalette(){const e=document.getElementById("composer-color-palette");e&&(e.innerHTML="",["#FFFFFF","#FADADD","#FFD6A5","#FDFFB6","#CAFFBF","#9BF6FF","#A0C4FF","#BDB2FF","#FFC6FF","#EAE4E9","#D4E09B","#C3E0E5","#F7D6E0","#F3E9DD","#D3E4CD","#FF1744","#F50057","#D500F9","#651FFF","#3D5AFE","#2979FF","#00B0FF","#00E5FF","#1DE9B6","#00E676","#76FF03","#C6FF00","#FFEA00","#FFC400","#FF9100","#FF3D00","#F38375","#FBC42C","#57C479","#57C5C8","#578DC8","#8A57C8","#C857B2","#4B4A49","#ACACAC","#795548","#607D8B","#000000","#E57373","#BA68C8","#7986CB","#4FC3F7","#4DB6AC","#AED581","#FFF176","#FFB74D","#A1887F","#90A4AE","#008F93","#F08080","#20B2AA","#87CEEB","#9370DB","#DA70D6"].forEach(a=>{const o=document.createElement("div");o.className="composer-color-option",o.style.backgroundColor=a,o.title=a,o.onclick=()=>selectComposerColor(a),e.appendChild(o)}))}function criarElementoMensagem(a){const o=a.cor||"#ffdde1",t=a.timestamp?.toDate?a.timestamp.toDate():new Date,n=t.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"}),r=t.toLocaleDateString("pt-BR"),i=document.createElement("div");i.className="mensagem",i.style.backgroundColor=o,i.dataset.id=a.id,i.dataset.fullText=a.texto||"",isColorDark(o)&&i.classList.add("text-light");const d=a.reacoes||{};let s="",l=!1;const m=Object.keys(d).sort((e,a)=>{const o=Array.isArray(d[e])?d[e].length:0,t=Array.isArray(d[a])?d[a].length:0;return t-o});for(const e of m){const o=Array.isArray(d[e])?d[e]:[],t=o.length;if(0<t){l=!0;const n=o.includes(currentUser),r=n?"reacted":"",i=0<o.length?`Reagido por: ${o.join(", ")}`:`Seja o primeiro a reagir com ${e}`;s+=`
        <div 
          class="reacao-display ${r}" 
          title="${i}"
          data-emoji="${e}"  onclick="window.abrirModalReagentes('${a.id}', '${e}')">
          ${e} <span class="contador-display">${t}</span>
        </div>
      `}}const c=l?`<div class="reacoes-display-container">${s}</div>`:"";let u="";(a.userId===currentUser||"lider"===userRole)&&(u=`
      <div class="message-options-container">
        <button class="options-btn" onclick="window.openOptionsMenu(event, 'message', '${a.id}')">‚ãÆ</button>
      </div>
    `);const g=(a.texto||"").replace(/\n/g,"<br>");i.innerHTML=`
    <div class="mensagem-texto">${g}</div>
    ${c}
    <div class="mensagem-info">
      <div>
        <div class="mensagem-autor">${a.nome}</div>
        <div class="mensagem-data">${n} - ${r}</div>
      </div>
      <div class="mensagem-actions">
        <div class="comment-indicator" title="Coment√°rios">
          üí¨ <span class="comment-count">${a.commentCount||0}</span>
        </div>
        ${u}
      </div>
    </div>
    <div class="reacao-seletor-bar hidden">
      ${EMOJIS_MURAL.map(e=>`
        <button onclick="event.stopPropagation(); window.toggleReacao('${a.id}', '${e}', event)">${e}</button>
      `).join("")}
    </div>
  `;const p=i.querySelector(".comment-indicator");p&&p.addEventListener("click",e=>{e.stopPropagation(),window.openCommentsModal(a.id)});let f=null,h=!1,E=!1;const v=a=>{a.target.closest("button, a, .reacao-display")||(h=!1,E=!1,f=setTimeout(()=>{h=!0;const e=i.querySelector(".reacao-seletor-bar");if(e){e.classList.remove("hidden");const a=o=>{i.contains(o.target)?o.target.closest(".reacao-seletor-bar button")&&(e.classList.add("hidden"),document.removeEventListener("click",a)):(e.classList.add("hidden"),document.removeEventListener("click",a))};setTimeout(()=>{document.addEventListener("click",a)},100)}},500))},y=()=>clearTimeout(f),b=o=>{clearTimeout(f),h||E||o.target.closest("button, a, .reacao-display, .comment-indicator")||openMessageViewer(a.id)},L=()=>{clearTimeout(f),E=!0};return i.addEventListener("mousedown",v),i.addEventListener("mouseup",b),i.addEventListener("mouseleave",y),i.addEventListener("touchstart",v,{passive:!0}),i.addEventListener("touchend",b),i.addEventListener("touchmove",L),i}function configurarMuralTempoReal(){const e=document.getElementById("mural-mensagens");if(e){e.innerHTML="<div class=\"carregando\">Carregando mensagens...</div>";const a=collection(db,"mural");onSnapshot(a,a=>{const o=[];return a.forEach(e=>{const a=e.data();o.push({id:e.id,...a,timestamp:a.timestamp.toDate?a.timestamp.toDate():new Date(1e3*a.timestamp.seconds)})}),o.sort((e,a)=>a.timestamp-e.timestamp),e.innerHTML="",0===o.length?void(e.innerHTML="<div class=\"sem-mensagens\">Nenhuma mensagem ainda. Seja o primeiro a escrever!</div>"):void o.forEach(a=>{e.appendChild(criarElementoMensagem(a))})})}}window.toggleReacao=function(e,a,o){if(o&&o.stopPropagation(),!currentUser)return;atualizarReacaoOtimista("#mural-mensagens",e,a);const t=doc(db,"mural",e),n=doc(db,"membros",currentUser);runTransaction(db,async e=>{const o=await e.get(t);if(!o.exists())throw"Documento n\xE3o existe!";const r=o.data(),i=r.userId;let d=r.reacoes||{},s=null,l=0;for(const a in d)if(Array.isArray(d[a])&&d[a].includes(currentUser)){s=a;break}if(s===a){const e=d[a].indexOf(currentUser);-1<e&&(d[a].splice(e,1),l=-1)}else{if(s){const e=d[s].indexOf(currentUser);-1<e&&d[s].splice(e,1)}else l=1;d[a]||(d[a]=[]),d[a].push(currentUser)}if(e.update(t,{reacoes:d}),0!==l&&e.update(n,{moedas:increment(l*(recompensasConfig.reagirConteudo||1))}),1===l&&i&&i!==currentUser){const e=`"${r.texto.substring(0,30)}..."`;await criarNotificacao(i,currentUser,"mural",a,`reagiu √† sua mensagem: ${e}`)}else console.log("MURAL: Condi\xE7\xE3o para notifica\xE7\xE3o n\xE3o atendida.",{mudancaDeMoedas:l,autorId:i,currentUser})}).catch(e=>{console.error("Falha na transa\xE7\xE3o de rea\xE7\xE3o do mural: ",e),mostrarPopup("\u274C Ops!","Sua rea\xE7\xE3o n\xE3o p\xF4de ser salva. Por favor, recarregue a p\xE1gina.",4e3)})};async function obterRankingSemanal(e=new Date){try{const a=getSemanaAtual(e),o=formatarDataISO(a.inicio),t=formatarDataISO(a.fim),n=query(collection(db,"presencas"),where("__name__",">=",o),where("__name__","<=",t)),r=await getDocs(n),i={};todosMembros.forEach(e=>{i[e.nome]={pontos:0,tempoTotal:0}}),r.forEach(e=>{const a=e.data();for(const[o,t]of Object.entries(a))i[o]&&t&&(i[o].pontos+=1,t&&t.toDate&&(i[o].tempoTotal+=t.toDate().getTime()))});const d=Object.entries(i).map(([e,a])=>({nome:e,pontos:a.pontos,tempoTotal:a.tempoTotal})).sort((e,a)=>a.pontos===e.pontos?0===e.tempoTotal?1:0===a.tempoTotal?-1:e.tempoTotal-a.tempoTotal:a.pontos-e.pontos);return d}catch(e){return console.error("Erro ao obter o ranking semanal:",e),[]}}async function carregarTop5Semana(){try{const e=await obterRankingSemanal(getHoje()),a=doc(db,"appState","rankingState"),o=await getDoc(a),t=o.exists()?o.data().top3:null,n=e.slice(0,3).map(e=>e.nome),r=n.join(","),i=0<e.length&&0<e[0].pontos;if(i&&r!==t){const e=t?t.split(",")[0]:null,o=n[0];let i=o===e?`<strong>${o}</strong> permanece na lideran√ßa do Top 5 da semana!`:`<strong>${o}</strong> assumiu a lideran√ßa do Top 5 da semana!`;const d=1<n.length?n[1]:null,s=2<n.length?n[2]:null;d&&s?i+=` Em seguida temos <strong>${d}</strong> em 2¬∫ e <strong>${s}</strong> em 3¬∫.`:d&&(i+=` Seguido por <strong>${d}</strong> em 2¬∫ lugar.`),await adicionarEventoAoFeed("geral","\uD83D\uDD25 Disputa no Top 5!",i,{nomeLider:o}),await setDoc(a,{top3:r})}const d=document.getElementById("ranking-top-lista");if(!d)return;if(d.innerHTML="",0===e.length||0===e[0].pontos)return d.innerHTML="<div class=\"ranking-item\">Ainda n\xE3o h\xE1 dados esta semana</div>",void(o.exists()&&(await deleteDoc(a)));const s=e.slice(0,5);s.forEach((e,a)=>{if(0===e.pontos)return;const o=a+1;let t="";t=1===o?"\uD83E\uDD47":2===o?"\uD83E\uDD48":3===o?"\uD83E\uDD49":"\u2B50";const n=document.createElement("div");n.className="ranking-item",n.style.setProperty("--i",a),n.innerHTML=`
        <div class="ranking-posicao">${t} ${o}¬∫</div>
        <div class="ranking-nome">${e.nome}</div>
        <div class="ranking-pontos">${e.pontos} dias</div>
      `,d.appendChild(n)}),0===d.children.length&&(d.innerHTML="<div class=\"ranking-item\">Ainda n\xE3o h\xE1 dados esta semana</div>"),setTimeout(()=>{d.scrollLeft=0},100)}catch(e){console.error("Erro ao carregar top 5:",e)}}async function carregarMembros(){const e=await getDocs(collection(db,"membros"));todosMembros=[],equipes={abelha:{membros:[],lider:null},joaninha:{membros:[],lider:null},vagalume:{membros:[],lider:null}},liderGeral=null,e.forEach(e=>{const a=e.data(),o={nome:e.id,equipe:a.equipe,papel:a.papel,folga:a.folga||"",aniversario:a.aniversario||"",senha:a.senha||"",tempPassword:a.tempPassword||!0};todosMembros.push(o),"lider"===o.papel?liderGeral=o:"lider-equipe"===o.papel&&equipes[o.equipe]&&(equipes[o.equipe].lider=o),o.equipe&&equipes[o.equipe]&&equipes[o.equipe].membros.push(o)})}async function carregarInformacoesMembros(){try{const e=await getDocs(collection(db,"membros")),a=document.getElementById("carrossel-container"),o=document.getElementById("carrossel-indicadores");if(!a)return;a.innerHTML="",o&&(o.innerHTML="");const t=[];e.forEach(e=>t.push({id:e.id,...e.data()})),totalSlides=t.length,document.getElementById("botao-pausa")&&(document.getElementById("botao-pausa").textContent="\u23F8"),t.forEach((e,t)=>{const n=e,r=document.createElement("div");r.className="card-membro",r.id=`card-membro-${e.id}`;const i=n.corCard||"#FFFFFF";r.style.backgroundColor=i,isColorDark(i)?r.classList.add("text-light"):r.classList.remove("text-light");const d=currentUser===e.id||"lider"===userRole,s=d?"":"hidden";r.innerHTML=`
        <div class="card-controls ${s}">
          <button class="card-color-chooser-btn" onclick="toggleColorPalette(event, '${e.id}')">Escolha a cor</button>
          <div id="palette-${e.id}" class="card-color-palette hidden">
          </div>
        </div>
        <h3>${e.id}</h3>
        <div class="subtitulo">coisas sobre mim</div>
        <div class="info-item">
          <div class="info-content"><strong>Eu me chamo:</strong> <span id="info-${e.id}-me chamo">${n["me chamo"]||"N\xE3o informado"}</span></div>
          <button class="edit-info-btn ${s}" onclick="editarInformacao(event, '${e.id}', 'me chamo')">‚úèÔ∏è</button>
        </div>
        <div class="info-item">
          <div class="info-content"><strong>Meu apelido √©:</strong> <span id="info-${e.id}-apelido">${n.apelido||"N\xE3o informado"}</span></div>
          <button class="edit-info-btn ${s}" onclick="editarInformacao(event, '${e.id}', 'apelido')">‚úèÔ∏è</button>
        </div>
        <div class="info-item">
          <div class="info-content"><strong>Meu filme favorito:</strong> <span id="info-${e.id}-filme">${n.filme||"N\xE3o informado"}</span></div>
          <button class="edit-info-btn ${s}" onclick="editarInformacao(event, '${e.id}', 'filme')">‚úèÔ∏è</button>
        </div>
        <div class="info-item">
          <div class="info-content"><strong>Meu maior sonho atualmente:</strong> <span id="info-${e.id}-sonho">${n.sonho||"N\xE3o informado"}</span></div>
          <button class="edit-info-btn ${s}" onclick="editarInformacao(event, '${e.id}', 'sonho')">‚úèÔ∏è</button>
        </div>
        <div class="info-item">
          <div class="info-content"><strong>Uma m√∫sica que gosto muito:</strong> <span id="info-${e.id}-musica">${n.musica||"N\xE3o informado"}</span></div>
          <button class="edit-info-btn ${s}" onclick="editarInformacao(event, '${e.id}', 'musica')">‚úèÔ∏è</button>
        </div>
        <div class="info-item">
          <div class="info-content"><strong>Uma curiosidade aleat√≥ria sobre mim:</strong> <span id="info-${e.id}-curiosidade">${n.curiosidade||"N\xE3o informado"}</span></div>
          <button class="edit-info-btn ${s}" onclick="editarInformacao(event, '${e.id}', 'curiosidade')">‚úèÔ∏è</button>
        </div>
      `;const l=isColorDark(i),m=r.querySelector(".card-color-chooser-btn");if(m&&(m.style.color=l?"white":"black",m.style.borderColor=l?"white":"black"),a.appendChild(r),d&&criarPaletaDeCoresDoCard(e.id),o){const e=document.createElement("div");e.className="carrossel-indicador",e.onclick=()=>{window.reiniciarIntervaloCarrossel&&reiniciarIntervaloCarrossel(),irParaSlide(t)},o.appendChild(e)}}),0<totalSlides&&(document.querySelector(".carrossel-indicador")?.classList.add("ativo"),irParaSlide(0),1<totalSlides&&window.iniciarCarrosselAutomatico&&iniciarCarrosselAutomatico())}catch(e){console.error("Erro ao carregar informa\xE7\xF5es dos membros:",e)}}window.editarInformacao=async function(e,a,o){e.stopPropagation();const t=document.getElementById(`info-${a}-${o}`);if(!t)return;const n=t.textContent;t.contentEditable=!0,t.classList.add("editing"),t.focus(),document.execCommand("selectAll",!1,null);const r=async()=>{t.contentEditable=!1,t.classList.remove("editing"),t.removeEventListener("blur",r),t.removeEventListener("keydown",i);const e=t.textContent.trim();if(e===n||""===e)return void(t.textContent=n);try{const t=doc(db,"membros",a);await updateDoc(t,{[o]:e}),mostrarPopup("\u2705 Sucesso",`Informa√ß√£o atualizada!`,3e3)}catch(e){console.error("Erro ao atualizar informa\xE7\xE3o:",e),mostrarPopup("\u274C Erro","Ocorreu um erro ao salvar.",4e3),t.textContent=n}},i=a=>{"Enter"===a.key?(a.preventDefault(),r()):"Escape"===a.key&&(t.textContent=n,r())};t.addEventListener("blur",r),t.addEventListener("keydown",i)},window.toggleColorPalette=function(e,a){e.stopPropagation();const o=document.getElementById(`palette-${a}`);o.classList.toggle("hidden")};function criarPaletaDeCoresDoCard(e){const a=document.getElementById(`palette-${e}`);if(a){a.innerHTML="",["#FFFFFF","#FADADD","#FFD6A5","#FDFFB6","#CAFFBF","#9BF6FF","#A0C4FF","#BDB2FF","#FFC6FF","#EAE4E9","#D4E09B","#C3E0E5","#F7D6E0","#F3E9DD","#D3E4CD","#FF1744","#F50057","#D500F9","#651FFF","#3D5AFE","#2979FF","#00B0FF","#00E5FF","#1DE9B6","#00E676","#76FF03","#C6FF00","#FFEA00","#FFC400","#FF9100","#FF3D00","#F38375","#FBC42C","#57C479","#57C5C8","#578DC8","#8A57C8","#C857B2","#4B4A49","#ACACAC","#795548","#607D8B","#000000","#E57373","#BA68C8","#7986CB","#4FC3F7","#4DB6AC","#AED581","#FFF176","#FFB74D","#A1887F","#90A4AE","#008F93","#F08080","#20B2AA","#87CEEB","#9370DB","#DA70D6"].forEach(o=>{const t=document.createElement("div");t.className="card-color-option",t.style.backgroundColor=o,t.onclick=a=>selecionarCorDoCard(a,e,o),a.appendChild(t)})}}async function selecionarCorDoCard(e,a,o){e.stopPropagation();try{const e=doc(db,"membros",a);await updateDoc(e,{corCard:o});const t=document.getElementById(`card-membro-${a}`);if(t){t.style.backgroundColor=o,isColorDark(o)?t.classList.add("text-light"):t.classList.remove("text-light");const e=isColorDark(o),a=t.querySelector(".card-color-chooser-btn");a&&(a.style.color=e?"white":"black",a.style.borderColor=e?"white":"black")}const n=document.getElementById(`palette-${a}`);n&&n.classList.add("hidden"),mostrarPopup("\uD83C\uDFA8 Sucesso","A cor do seu card foi alterada!",3e3)}catch(e){console.error("Erro ao salvar cor do card:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel salvar a cor.",4e3)}}async function marcarConcluido(e,a,o,t){const n=document.getElementById(`task-${e}-${a}-${o}`),r=n?n.dataset.memberTeam:null;if(!podeMarcarCheckbox(e,r))return mostrarPopup("Erro","Voc\xEA n\xE3o tem permiss\xE3o para marcar/desmarcar esta tarefa.",3e3),void(n&&(n.checked=!t));const i=doc(db,"membros",e),d=`focoDiario.${o}.${a}`,s=`focoDia.${o}`;try{await runTransaction(db,async e=>{const n=await e.get(i);if(!n.exists())throw new Error("Membro n\xE3o encontrado.");const l=n.data();let m=pontosSemanais[r]||0,c=l.focoDia&&l.focoDia[o]||0;const u=l.focoDiario&&l.focoDiario[o]&&l.focoDiario[o][a];if(t?!u&&(e.update(i,{[d]:!0,[s]:increment(1)}),m++):u&&(e.update(i,{[d]:!1,[s]:increment(-1)}),m--),r&&void 0!==pontosSemanais[r]){const a=doc(db,"semanas","pontosSemanais");e.update(a,{[r]:m}),pontosSemanais[r]=m}}),console.log("Atualiza\xE7\xE3o conclu\xEDda com sucesso!"),mostrarPopup("Sucesso","Tarefa atualizada!",2e3),await verificarConquista(e,t?"adicionar":"remover"),await window.atualizarResumo()}catch(e){console.error("Erro ao atualizar o documento: ",e),mostrarPopup("Erro",`Erro ao atualizar a tarefa: ${e.message||e}`,3e3),n&&(n.checked=!t)}}window.togglePausa=function(){carrosselPausado=!carrosselPausado;const e=document.getElementById("botao-pausa");if(carrosselPausado){clearInterval(carrosselInterval),e.textContent="\u25B6";const a=document.getElementById("progresso-indicador-barra");a&&(a.style.transition="none",a.dataset.width=a.style.width)}else{e.textContent="\u23F8";const a=document.getElementById("progresso-indicador-barra");a&&(a.style.transition="width 10s linear",a.style.width=a.dataset.width||"100%"),iniciarCarrosselAutomatico()}};function iniciarBarraProgresso(){const e=document.getElementById("progresso-indicador-barra");e&&(e.style.transition="none",e.style.width="0%",void e.offsetWidth,e.style.transition="width 10s linear",setTimeout(()=>{carrosselPausado||(e.style.width="100%")},10),progressoBarra&&clearTimeout(progressoBarra),progressoBarra=setTimeout(()=>{e.style.width="0%"},1e4))}window.mudarSlide=function(e){reiniciarIntervaloCarrossel();const a=document.querySelectorAll(".card-membro").length;0===a||(currentCarrosselIndex=(currentCarrosselIndex+e+a)%a,irParaSlide(currentCarrosselIndex))};function irParaSlide(e){const a=document.getElementById("carrossel-container");a.style.transform=`translateX(-${100*e}%)`;const o=document.querySelectorAll("#carrossel-indicadores .carrossel-indicador");o.forEach((a,o)=>{a.classList.toggle("ativo",o===e)}),currentCarrosselIndex=e,carrosselPausado||iniciarBarraProgresso()}function iniciarCarrosselAutomatico(){carrosselInterval&&clearInterval(carrosselInterval),carrosselInterval=setInterval(()=>{0<totalSlides&&!carrosselPausado&&(currentCarrosselIndex=(currentCarrosselIndex+1)%totalSlides,irParaSlide(currentCarrosselIndex))},1e4),iniciarBarraProgresso()}function reiniciarIntervaloCarrossel(){clearInterval(carrosselInterval),iniciarCarrosselAutomatico(),iniciarBarraProgresso()}function construirInterface(){const e=document.querySelector(".grupos-container");if(e){e.innerHTML="";const a=document.createElement("div");a.className="grupo",a.id="lider-geral",a.innerHTML=`
      <h2>L√≠der Geral</h2>
      <div class="membros-grid">
        ${liderGeral?`
          <div class="membro">
            <input type="checkbox" id="${liderGeral.nome}">
            <label for="${liderGeral.nome}">
  <span class="membro-nome ${6<=liderGeral.nome.length?"long-name":""}">${liderGeral.nome}</span>
  <span id="dias-${liderGeral.nome}" class="dias-badge">0</span>
              <span class="medalha-container">
                <span id="medalha-${liderGeral.nome}" class="medalha escondido"></span>
              </span>
            </label>
          </div>
        `:""}
      </div>
    `,e.appendChild(a);for(const[a,o]of Object.entries(equipes)){const t=document.createElement("div");t.className="grupo",t.id=`equipe-${a}`;let n="";"abelha"===a?n="\uD83D\uDC1D":"joaninha"===a?n="\uD83D\uDC1E":"vagalume"===a&&(n="\uD83D\uDCA1"),t.innerHTML=`
        <h2>${n} Equipe ${a.charAt(0).toUpperCase()+a.slice(1)}</h2>
        <div class="resumo" id="resumo-${a}">
          <div>0 focaram hoje!</div>
          <div>0 pontos na semana</div>
        </div>
		<div class="mensagem-equipe-completa hidden" id="msg-equipe-${a}"></div>
      `;const r=document.createElement("div");if(r.className="lider-equipe",r.innerHTML=`
        <div class="titulo-lider">L√≠der da Equipe</div>
      `,o.lider){const e=document.createElement("div");e.className="membro",e.innerHTML=`
          <input type="checkbox" id="${o.lider.nome}">
          <label for="${o.lider.nome}">
  <span class="membro-nome ${6<=o.lider.nome.length?"long-name":""}">${o.lider.nome}</span>
  <span id="dias-${o.lider.nome}" class="dias-badge">0</span>
            <span class="medalha-container">
              <span id="medalha-${o.lider.nome}" class="medalha escondido"></span>
            </span>
          </label>
        `,r.appendChild(e)}else{const e=document.createElement("div");e.className="sem-lider",e.textContent="Sem l\xEDder",r.appendChild(e)}t.appendChild(r);const i=document.createElement("div");i.className="membros-grid",o.membros.forEach(e=>{if(!(o.lider&&e.nome===o.lider.nome)){const a=document.createElement("div");a.className="membro",a.innerHTML=`
          <input type="checkbox" id="${e.nome}">
          <label for="${e.nome}">
  <span class="membro-nome ${6<=e.nome.length?"long-name":""}">${e.nome}</span>
  <span id="dias-${e.nome}" class="dias-badge">0</span>
            <span class="medalha-container">
              <span id="medalha-${e.nome}" class="medalha escondido"></span>
            </span>
          </label>
        `,i.appendChild(a)}}),t.appendChild(i),e.appendChild(t)}todosMembros.forEach(e=>{const a=e.nome,o=document.getElementById(a);o&&(o.onchange=()=>marcarCheckbox(a))})}}window.togglePainelSecreto=function(e){const a=document.getElementById("painel-secreto");a.style.display=e?"block":"none"};function verificarCliquesDiamante(){if(cliqueCount++,clearTimeout(timeoutClique),5===cliqueCount){const e=prompt("\uD83D\uDD10 Digite a senha para acessar o painel secreto:");"goiaba"===e?togglePainelSecreto(!0):alert("\u274C Senha incorreta!"),cliqueCount=0}else timeoutClique=setTimeout(()=>{cliqueCount=0},3e3)}let intervaloConfete=null,animacaoConfeteAniversarioId=null,geradorDeParticulasId=null,particulasAniversario=[];async function carregarAniversariantes(){const e=getHoje(),a=e.getMonth()+1,o=e.getDate(),t=await getDocs(collection(db,"membros")),n=[];let r=null,i=1/0;t.forEach(t=>{const d=t.data();if(d.aniversario){const[s,l]=d.aniversario.split("/").map(Number);l===a&&n.push({nome:t.id,data:d.aniversario,hoje:s===o});let m=new Date(e.getFullYear(),l-1,s);m<e&&m.setFullYear(e.getFullYear()+1);const c=Math.ceil((m-e)/86400000);c<i&&(i=c,r={nome:t.id,dias:c,data:d.aniversario})}}),atualizarInterfaceAniversariantes(n,r),n.some(e=>e.hoje)?iniciarConfeteAniversarioContinuo():pararConfeteAniversarioContinuo()}async function verificarAniversariantesDoDia(){try{console.log("Verificando aniversariantes do dia...");const e=getHoje(),a=e.getDate(),o=e.getMonth()+1,t=todosMembros.filter(e=>{if(!e.aniversario)return!1;const[t,n]=e.aniversario.split("/").map(Number);return t===a&&n===o});if(0<t.length){console.log(`Encontrados ${t.length} aniversariante(s) hoje!`);for(const e of t)await marcarPresencaAniversario(e)}else console.log("Nenhum aniversariante hoje.")}catch(e){console.error("Erro ao verificar aniversariantes do dia:",e)}}function atualizarInterfaceAniversariantes(e,a){const o=document.getElementById("aniversariantes-hoje"),t=document.getElementById("proximos-aniversarios");o.innerHTML="",t.innerHTML="";const n=document.createElement("div");if(n.className="aniversariantes-container-hoje",0<e.length)e.forEach(e=>{const a=document.createElement("div");a.className="aniversariante-card",e.hoje&&a.classList.add("hoje"),a.innerHTML=`
          <div class="aniversariante-nome">${e.nome}</div>
          <div class="aniversariante-data">${e.data}</div>
        `,n.appendChild(a)});else{const e=document.createElement("div");e.className="aniversariante-card mensagem-vazia",e.textContent="Nenhum aniversariante neste m\xEAs",n.appendChild(e)}o.appendChild(n),t.innerHTML=a?`
        <div style="font-weight:bold; margin-bottom:8px; font-size:1.1rem;">Pr√≥ximo Aniversariante:</div>
        <div>Faltam <strong>${a.dias}</strong> dias para o anivers√°rio de</div>
        <div><strong>${a.nome}</strong> (${a.data})</div>
      `:"<div>Nenhum pr\xF3ximo anivers\xE1rio cadastrado</div>"}function iniciarConfetePeriodico(){pararConfetePeriodico(),intervaloConfete=setInterval(dispararConfete,5e3),dispararConfete()}function pararConfetePeriodico(){intervaloConfete&&(clearInterval(intervaloConfete),intervaloConfete=null)}async function exibirQuadroFolgas(){try{const e=await getDocs(collection(db,"membros")),a=getHoje().toLocaleDateString("pt-BR",{weekday:"long"}),o=a.toLowerCase().replace(/-feira$/,"").normalize("NFD").replace(/[\u0300-\u036f]/g,""),t=["segunda","terca","quarta","quinta","sexta","sabado","domingo"];t.forEach(e=>{const a=document.getElementById(e);a&&(a.innerHTML="",a.classList.remove("centralizado"))}),document.querySelectorAll(".dia-col").forEach(e=>e.classList.remove("dia-hoje"));const n=document.getElementById(o);n&&n.closest(".dia-col")?.classList.add("dia-hoje");const r={segunda:0,terca:0,quarta:0,quinta:0,sexta:0,sabado:0,domingo:0};e.forEach(e=>{const a=e.id,n=e.data().folga||"",i=n.toLowerCase().replace(/-feira$/,"").normalize("NFD").replace(/[\u0300-\u036f]/g,"");if(i&&t.includes(i)){const e=document.getElementById(i);if(e){const t=document.createElement("div");t.className="membro-folga",i===o&&a===currentUser?(t.classList.add("membro-folga-hoje"),t.textContent=a):t.textContent=a,e.appendChild(t),r[i]++}}}),t.forEach(e=>{const a=document.getElementById(e);if(a&&2>=r[e]&&a.classList.add("centralizado"),a&&0===a.children.length){const o="domingo"===e?"Folga Coletiva":"Ningu\xE9m";a.innerHTML=`<div class="membro-folga">${o}</div>`,a.classList.add("centralizado")}})}catch(e){console.error("Erro ao carregar folgas:",e)}}async function openChangeFolgaModal(){if(currentUser)try{const e=doc(db,"membros",currentUser),a=await getDoc(e);if(a.exists()){const e=a.data(),o=getSemanaAtual().numero,t=e.semanaTrocaFolga||0;if("lider"!==userRole&&t===o)return void mostrarPopup("\uD83D\uDEAB Limite Atingido","Voc\xEA j\xE1 alterou sua folga esta semana. Tente novamente na pr\xF3xima.",5e3);const n=document.getElementById("select-new-folga");n.value=e.folga||"segunda-feira",openModal("change-folga-modal")}}catch(e){console.error("Erro ao verificar permiss\xE3o de troca de folga:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel verificar seus dados de folga.",3e3)}}window.abrirModalReagentes=async function(e,a){try{const o=doc(db,"mural",e),t=await getDoc(o);if(!t.exists())return;const n=t.data().reacoes||{},r=Array.isArray(n[a])?n[a]:[],i=document.getElementById("reactors-modal-title"),d=document.getElementById("reactors-modal-list"),s=document.getElementById("remove-my-reaction-btn");i.innerHTML=`Reagiram com ${a}`,d.innerHTML="",0<r.length?r.forEach(e=>{const a=document.createElement("div");a.className="reactor-item",a.textContent=e,d.appendChild(a)}):d.innerHTML="<div class=\"reactor-item\" style=\"text-align:center; font-style:italic;\">Ningu\xE9m reagiu com este emoji ainda.</div>",currentUser&&r.includes(currentUser)?(s.style.display="block",s.onclick=async()=>{await window.toggleReacao(e,a),closeModal("reactors-modal")}):s.style.display="none",openModal("reactors-modal")}catch(e){console.error("Erro ao abrir modal de reagentes:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel carregar quem reagiu.",3e3)}};async function handleUpdateFolga(){const e=document.getElementById("select-new-folga").value,a=getSemanaAtual().numero,o=doc(db,"membros",currentUser);try{await updateDoc(o,{folga:e,semanaTrocaFolga:a}),mostrarPopup("\u2705 Sucesso",`Sua folga foi alterada para ${e}!`,4e3),closeModal("change-folga-modal"),await exibirQuadroFolgas()}catch(e){console.error("Erro ao atualizar folga:",e),mostrarPopup("\u274C Erro","Falha ao salvar sua nova folga.",3e3)}}function atualizarRelogio(){const e=new Date,a=(e.getHours()+"").padStart(2,"0"),o=(e.getMinutes()+"").padStart(2,"0"),t=(e.getSeconds()+"").padStart(2,"0");document.getElementById("relogio").textContent=`${a}:${o}:${t}`}async function handleLogin(){let e=loginUsernameInput.value.trim();e&&(e=e.charAt(0).toUpperCase()+e.slice(1).toLowerCase());const a=loginPasswordInput.value;if(!e||!a)return void mostrarPopup("\u274C Erro","Por favor, preencha todos os campos",3e3);try{const o=await getDoc(doc(db,"membros",e));if(o.exists()){const t=o.data();t.senha===a&&"on"===t.usedProv?(localStorage.setItem("loggedInUser",e),await performSuccessfulLogin(e)):t.senhaProv===a&&"off"===t.usedProv?(currentUser=e,mostrarPopup("\uD83D\uDD11 Primeiro Acesso","Crie sua senha definitiva para continuar.",4e3),showChangePasswordForm()):mostrarPopup("\u274C Erro de Acesso","Nome ou senha incorreta.",3e3)}else mostrarPopup("\u274C Erro","Usu\xE1rio n\xE3o encontrado",3e3)}catch(e){console.error("Erro no login:",e),mostrarPopup("\u274C Erro","Falha no login: "+e.message,5e3)}}async function carregarDadosEssenciais(){console.log("Otimiza\xE7\xE3o: Carregando todos os dados essenciais de uma s\xF3 vez...");const e=await getDocs(collection(db,"membros"));todosMembros=[],equipes={abelha:{membros:[],lider:null},joaninha:{membros:[],lider:null},vagalume:{membros:[],lider:null}},liderGeral=null,streaksCache={},e.forEach(e=>{const a=e.data(),o={nome:e.id,equipe:a.equipe,papel:a.papel,folga:a.folga||"",aniversario:a.aniversario||"",senha:a.senha||"",tempPassword:a.tempPassword||!0,streak:a.streak||0};todosMembros.push(o),streaksCache[o.nome]=o.streak,"lider"===o.papel?liderGeral=o:"lider-equipe"===o.papel&&equipes[o.equipe]&&(equipes[o.equipe].lider=o),o.equipe&&equipes[o.equipe]&&equipes[o.equipe].membros.push(o)}),console.log(`Dados essenciais de ${todosMembros.length} membros carregados com apenas 1 leitura da cole√ß√£o.`)}async function verificarConquista(e,a,o,t){const n=getHojeISO(),r=doc(db,"membros",e),i=doc(db,"presencas",n),d=doc(db,"semanas","pontosSemanais");try{const{streakAtual:n,novosPontosEquipe:s}=await runTransaction(db,async n=>{const s="adicionar"===a?1:-1,l=await n.get(r);if(!l.exists())throw"Documento do membro n\xE3o encontrado.";let m;!t&&o&&(m=await n.get(d));const c=l.data().streak||0,u=c+s;let g=0;if(!t&&o&&pontosSemanais.hasOwnProperty(o)){const e=m&&m.exists()?m.data()[o]||0:0;g=e+s}return n.update(r,{streak:u}),"adicionar"===a?n.set(i,{[e]:new Date},{merge:!0}):n.update(i,{[e]:deleteField()}),!t&&o&&pontosSemanais.hasOwnProperty(o)&&n.set(d,{[o]:g},{merge:!0}),{streakAtual:u,novosPontosEquipe:g}});return{streakAtual:n,novosPontosEquipe:s}}catch(e){throw console.error("FALHA NA TRANSA\xC7\xC3O AT\xD4MICA:",e),mostrarPopup("\u274C Erro de Sincroniza\xE7\xE3o","Sua a\xE7\xE3o n\xE3o p\xF4de ser salva. Tente novamente.",5e3),e}}async function carregarStreaks(){todosMembros.forEach(e=>{streaksCache[e.nome]!==void 0&&atualizarStreakVisualMembro(e.nome,streaksCache[e.nome])}),atualizarMedalhas()}async function performSuccessfulLogin(e,a=!1){isTestModeActive=!1,dataAtual=getHojeISO();const o=await getDoc(doc(db,"membros",e));if(!o.exists())return localStorage.removeItem("loggedInUser"),void location.reload();const t=o.data();currentUser=e,userRole=t.papel,userTeam=t.equipe,authContainer.classList.add("hidden"),mainContent.classList.remove("hidden");const n=new Date().getHours(),r=document.body;r.classList.remove("tema-manha","tema-tarde","tema-noite"),5<=n&&12>n?r.classList.add("tema-manha"):12<=n&&18>n?r.classList.add("tema-tarde"):r.classList.add("tema-noite"),await carregarDadosEssenciais(),construirInterface(),atualizarPainelPessoal(),await Promise.all([carregarPresenca(),carregarPontosSemanais(),carregarRankingGeral(),carregarArvoreEpica(),loadAdvantageState(),carregarConfiguracoesRecompensas(),carregarStreaks()]);const i=["abelha","joaninha","vagalume"];i.forEach(e=>{drawingContexts[e]=configurarTelaDeDesenho(e);const a=document.getElementById(`preview-container-${e}`);a&&(a.onclick=()=>abrirModalDesenho(e))});const d=document.getElementById("carrossel-indicadores-desenho");if(d){d.innerHTML="";for(let e=0;3>e;e++){const a=document.createElement("div");a.className="carrossel-indicador",a.onclick=()=>{irParaSlideDesenho(e)},d.appendChild(a)}}setTimeout(()=>{i.forEach(e=>{const a=drawingContexts[e];a&&a.setupCanvases&&a.setupCanvases()})},500),iniciarCarrosselDesenho(),document.querySelector("#carrossel-indicadores-desenho .carrossel-indicador")?.classList.add("ativo"),irParaSlideDesenho(0),a?setTimeout(()=>{mostrarCardPopup(`üéâ Seja muito bem-vindo(a), ${e}!`,`<p>√â uma alegria ter voc√™ no Grupo √âpicos!</p>...`,dispararConfete)},2e3):setTimeout(()=>{mostrarPopup(`‚úÖ Ol√° de novo, ${e}!`,"Muito bom ver voc\xEA de volta aqui.",4e3)},1500),await verificarELimparNaSegunda(),atualizarPlacarSemanal(),atualizarRankingGeral(),atualizarDataCabecalho(),atualizarInfoSemana(),configurarMuralTempoReal(),createColorPalette(),configurarResumoSemanalTempoReal(),await finalizarSemana(),await Promise.all([carregarTop5Semana(),exibirQuadroFolgas(),carregarInformacoesMembros(),carregarAniversariantes(),carregarCondominioEpicos()]),atualizarVisualBloqueio(),await carregarEExibirMembrosOciosos(),setTimeout(()=>{iniciarCarrosselAutomatico(),irParaSlide(0)},1e3),setupRefreshListener(),setupVersionCheckListener();const s=getHojeISO(),l=t.ultimaVerificacaoAutomatica;if(l!==s){console.log(`%cPRIMEIRO LOGIN DO DIA (Firestore): Executando verifica√ß√µes para ${e}...`,"color: #2ecc71; font-weight: bold;"),setTimeout(verificarAniversariantesDoDia,2e3),await verificarEConfirmarFolgas(),await verificarPopupDeFolga();try{const a=doc(db,"membros",e);await updateDoc(a,{ultimaVerificacaoAutomatica:s})}catch(e){console.error("Falha ao salvar a data da \xFAltima verifica\xE7\xE3o no Firestore:",e)}}else console.log(`%cVerifica√ß√µes autom√°ticas para ${e} j√° realizadas hoje. Pulando para economizar leituras.`,"color: orange;");configurarNotificacoesTempoReal(),await exibirPopupResultadoCompeticao(),configurarOuvintePresencaTempoReal(),await atualizarResumo()}async function verificarPopupDeFolga(){if(!currentUser)return;const e=todosMembros.find(e=>e.nome===currentUser);if(!e)return;const a=new Date;a.setDate(a.getDate()+1);const o=getDiaSemanaString(a),t=e.folga;if(t&&t===o){return void mostrarCardPopup("\uD83C\uDF34 Seu Descanso se Aproxima!","Lembrete amig\xE1vel: amanh\xE3 \xE9 o seu dia de folga programado. Aproveite para recarregar as energias!")}if(6===getHoje().getDay()){mostrarCardPopup("\uD83C\uDF89 Fim de Semana Chegou!","Aproveite o s\xE1bado! Lembre-se que amanh\xE3 \xE9 nossa folga coletiva. Um \xF3timo descanso para todos n\xF3s!")}}function handleLogout(){desligarTodosOsOuvintesDeDesenho(),closeModal("user-panel-modal"),localStorage.removeItem("loggedInUser"),currentUser=null,userRole=null,userTeam=null,authContainer.classList.remove("hidden"),mainContent.classList.add("hidden"),loginUsernameInput.value="",loginPasswordInput.value="",showLoginForm(),mostrarPopup("\u2139\uFE0F Sess\xE3o encerrada","Voc\xEA saiu do sistema",3e3)}function showChangePasswordForm(){loginForm.classList.add("hidden"),changePasswordForm.classList.remove("hidden")}function showLoginForm(){changePasswordForm.classList.add("hidden"),forgotPasswordForm.classList.add("hidden"),secretQuestionForm.classList.add("hidden"),loginForm.classList.remove("hidden")}async function handlePasswordChange(){const e=document.getElementById("new-password").value,a=document.getElementById("confirm-new-password").value;if(!e||!a)return void mostrarPopup("\u274C Erro","Preencha todos os campos",3e3);if(e!==a)return void mostrarPopup("\u274C Erro","As novas senhas n\xE3o coincidem",3e3);if(6>e.length)return void mostrarPopup("\u274C Erro","A senha deve ter no m\xEDnimo 6 caracteres.",3e3);try{const a=doc(db,"membros",currentUser);await updateDoc(a,{senha:e}),mostrarPopup("\u2705 Senha Criada","Agora, vamos configurar sua recupera\xE7\xE3o de login.",5e3),document.getElementById("new-password").value="",document.getElementById("confirm-new-password").value="",showSecretQuestionForm()}catch(e){console.error("Erro ao alterar senha:",e),mostrarPopup("\u274C Erro","Falha ao alterar senha. Tente novamente.",3e3)}}function initAuth(){authContainer=document.getElementById("auth-container"),mainContent=document.getElementById("main-content"),logoutBtn=document.getElementById("logout-btn"),loginForm=document.getElementById("login-form"),changePasswordForm=document.getElementById("change-password-form");let e=document.getElementById("user-menu-dropdown");loginBtn=document.getElementById("login-btn"),loginUsernameInput=document.getElementById("login-username"),loginPasswordInput=document.getElementById("login-password"),forgotPasswordForm=document.getElementById("forgot-password-form"),secretQuestionForm=document.getElementById("secret-question-form");const a=document.getElementById("toggle-password-btn");loginPasswordInput&&a&&(loginPasswordInput.addEventListener("input",()=>{a.style.display=0<loginPasswordInput.value.length?"block":"none"}),a.addEventListener("click",()=>{const e="password"===loginPasswordInput.type;e?(loginPasswordInput.type="text",a.textContent="Ocultar"):(loginPasswordInput.type="password",a.textContent="Ver")})),loginBtn&&loginBtn.addEventListener("click",handleLogin),logoutBtn&&logoutBtn.addEventListener("click",handleLogout),loginPasswordInput&&loginPasswordInput.addEventListener("keypress",a=>{"Enter"===a.key&&handleLogin()}),document.getElementById("confirm-remove-button")?.addEventListener("click",executeRemoveMember),document.getElementById("force-refresh-btn")?.addEventListener("click",requestGlobalRefresh),document.getElementById("trigger-update-btn")?.addEventListener("click",triggerForcedUpdate),document.getElementById("perform-update-btn")?.addEventListener("click",performUpdate),document.getElementById("notificacoes-btn")?.addEventListener("click",()=>{marcarNotificacoesComoLidas(),openModal("notificacoes-modal")}),document.getElementById("limpar-feed-btn")?.addEventListener("click",limparFeedManualmente),document.getElementById("limpar-mural-btn")?.addEventListener("click",limparMuralManualmente),document.getElementById("btn-abrir-inventario")?.addEventListener("click",abrirInventario),document.getElementById("change-folga-btn")?.addEventListener("click",openChangeFolgaModal),document.getElementById("save-new-folga-btn")?.addEventListener("click",handleUpdateFolga),document.getElementById("btn-ver-lista-aniversarios")?.addEventListener("click",abrirModalListaAniversarios),document.getElementById("save-new-password-btn")?.addEventListener("click",handleUpdatePassword),document.getElementById("save-new-secret-btn")?.addEventListener("click",handleUpdateSecretAnswer),window.addEventListener("click",()=>{e&&!e.classList.contains("hidden")&&e.classList.add("hidden")}),document.getElementById("pincel-btn")?.addEventListener("click",()=>definirModoGlobal("pincel")),document.getElementById("borracha-btn")?.addEventListener("click",()=>definirModoGlobal("borracha")),document.getElementById("pan-btn")?.addEventListener("click",()=>definirModoGlobal("arrastar")),document.getElementById("cor-pincel")?.addEventListener("input",a=>{corPincel=a.target.value,definirModoGlobal("pincel")}),document.getElementById("tamanho-pincel")?.addEventListener("input",a=>{tamanhoPincel=a.target.value;const e=document.getElementById("valor-pincel");e&&(e.textContent=a.target.value),atualizarCursorDinamico()}),document.getElementById("limpar-tela-btn")?.addEventListener("click",()=>{activeDrawingTeam&&confirmarLimpezaDeTela(activeDrawingTeam)});const o=document.getElementById("desenho-toolbar"),t=document.getElementById("toggle-toolbar-btn");o&&t&&!o.dataset.listener&&(t.addEventListener("click",()=>o.classList.toggle("recolhida")),o.dataset.listener="true"),document.getElementById("btn-adicionar-pontos")?.addEventListener("click",()=>handleAjusteManualPontos("adicionar")),document.getElementById("btn-remover-pontos")?.addEventListener("click",()=>handleAjusteManualPontos("remover")),document.getElementById("open-composer-btn")?.addEventListener("click",()=>openMessageComposer()),document.getElementById("confirm-delete-btn")?.addEventListener("click",confirmDelete),document.getElementById("viewer-close-btn")?.addEventListener("click",()=>closeModal("message-viewer-modal")),document.getElementById("composer-color-btn")?.addEventListener("click",a=>{a.stopPropagation(),document.getElementById("composer-color-palette").classList.toggle("hidden")}),document.getElementById("composer-close-btn")?.addEventListener("click",closeMessageComposer),document.getElementById("composer-send-btn")?.addEventListener("click",enviarMensagem),document.getElementById("save-new-password-btn")?.addEventListener("click",handleUpdatePassword),document.getElementById("save-new-secret-btn")?.addEventListener("click",handleUpdateSecretAnswer),document.getElementById("confirm-delete-comment-btn")?.addEventListener("click",executarExclusaoComentario),document.getElementById("save-edit-comment-btn")?.addEventListener("click",salvarEdicaoComentario),document.getElementById("botao-painel-usuario")?.addEventListener("click",()=>openModal("user-panel-modal")),document.getElementById("generate-batch-code-btn")?.addEventListener("click",handleGenerateBatchCode),document.getElementById("add-member-btn")?.addEventListener("click",handleAddMember),document.getElementById("remove-member-btn")?.addEventListener("click",handleRemoveMember),document.getElementById("btn-abrir-gerador-codigo")?.addEventListener("click",abrirGeradorDeCodigos),document.getElementById("generate-code-btn")?.addEventListener("click",handleGenerateCode),document.getElementById("redeem-code-btn")?.addEventListener("click",handleRedeemCode),document.getElementById("save-game-order-btn")?.addEventListener("click",salvarNovaOrdemJogos),document.getElementById("btn-abrir-painel-controle")?.addEventListener("click",()=>{openControlPanel(),closeModal("user-panel-modal")}),document.getElementById("btn-logout-panel")?.addEventListener("click",handleLogout),document.getElementById("change-password-btn")?.addEventListener("click",handlePasswordChange),document.getElementById("cancel-change-password")?.addEventListener("click",showLoginForm),document.getElementById("forgot-password-link")?.addEventListener("click",showForgotPasswordForm),document.getElementById("verify-answer-btn")?.addEventListener("click",handleVerifySecretAnswer),document.getElementById("cancel-forgot-password")?.addEventListener("click",showLoginForm),document.getElementById("save-secret-answer-btn")?.addEventListener("click",handleSaveSecretAnswer),document.getElementById("btn-abrir-loja")?.addEventListener("click",abrirLoja),document.querySelector(".botao-info[onclick*=\"info-moedas-modal\"]").addEventListener("click",popularModalRecompensas),document.getElementById("btn-ver-condominio")?.addEventListener("click",abrirVisaoCondominio),document.getElementById("btn-ranking-imobiliario")?.addEventListener("click",carregarRankingImobiliario),document.getElementById("info-moedas-modal").addEventListener("click",handleRewardEditClick)}async function loginUser(){const e=loginUsernameInput.value.trim(),a=loginPasswordInput.value.trim();if(!e||!a)return void mostrarPopup("Erro","Por favor, preencha todos os campos.",3e3);try{const o=doc(db,"users",e),t=await getDoc(o);if(t.exists()){const o=t.data();if(o.password===a){currentUser=e;const a=doc(db,"membros",currentUser),o=await getDoc(a);if(o.exists()){const e=o.data();currentUserRole=e.papel||"membro",currentUserTeam=e.equipe||null}else console.warn("Documento do membro n\xE3o encontrado na cole\xE7\xE3o 'membros' para o usu\xE1rio logado:",currentUser),currentUserRole="membro",currentUserTeam=null;await carregarInformacoesMembros(),await carregarInformacoesMembros(),mostrarPopup("Sucesso",`Bem-vindo(a), ${e}!`,3e3),authContainer.classList.add("hidden"),mainContent.classList.remove("hidden"),logoutBtn.classList.remove("hidden"),atualizarPermissoesCheckboxes()}else mostrarPopup("Erro","Senha incorreta.",3e3)}else mostrarPopup("Erro","Usu\xE1rio n\xE3o encontrado.",3e3)}catch(a){console.error("Erro ao fazer login: ",a),mostrarPopup("Erro","Erro ao fazer login. Tente novamente.",3e3)}}window.copyToClipboard=function(e,a){navigator.clipboard.writeText(e).then(()=>{mostrarPopup("\u2705 Copiado",`${a} copiado para a √°rea de transfer√™ncia!`,2e3)}).catch(e=>{console.error("Erro ao copiar: ",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel copiar.",3e3)})},window.podeDesenhar=function(e){return!!currentUser&&(!("lider"!==userRole)||!(userTeam!==e))};function atualizarPermissoesCheckboxes(){const e=document.querySelectorAll(".tarefa-checkbox");e.forEach(e=>{const a=e.dataset.memberId,o=e.dataset.memberTeam;a&&o&&(e.disabled=!podeMarcarCheckbox(a,o))})}function atualizarVisualBloqueio(){currentUser&&todosMembros.forEach(e=>{const a=document.getElementById(e.nome);if(!a)return;let o=!1;("lider"===userRole||"lider-equipe"===userRole&&e.equipe===userTeam||currentUser===e.nome)&&(o=!0);const t=a.parentElement;t&&(o?(t.classList.remove("bloqueado"),t.title="Clique para marcar/desmarcar o foco"):(t.classList.add("bloqueado"),t.title="Voc\xEA n\xE3o tem permiss\xE3o para alterar este foco"))})}function showForgotPasswordForm(){loginForm.classList.add("hidden"),changePasswordForm.classList.add("hidden"),forgotPasswordForm.classList.remove("hidden")}async function handleVerifySecretAnswer(){let e=document.getElementById("forgot-username").value.trim();e&&(e=e.charAt(0).toUpperCase()+e.slice(1).toLowerCase());const a=document.getElementById("secret-answer").value.trim();if(!e||!a)return void mostrarPopup("\u274C Erro","Preencha seu nome e a resposta secreta.",3e3);try{const o=doc(db,"membros",e),t=await getDoc(o);if(t.exists()){const o=t.data();o.pet&&o.pet.toLowerCase()===a.toLowerCase()?(currentUser=e,mostrarPopup("\u2705 Correto","Resposta correta! Crie sua nova senha.",3e3),forgotPasswordForm.classList.add("hidden"),changePasswordForm.classList.remove("hidden")):mostrarPopup("\u274C Incorreto","A resposta para a pergunta secreta est\xE1 errada.",4e3)}else mostrarPopup("\u274C Erro","Usu\xE1rio n\xE3o encontrado.",3e3)}catch(e){console.error("Erro ao verificar resposta secreta:",e),mostrarPopup("\u274C Erro","Ocorreu um erro ao verificar os dados.",3e3)}}function showSecretQuestionForm(){loginForm.classList.add("hidden"),changePasswordForm.classList.add("hidden"),forgotPasswordForm.classList.add("hidden"),secretQuestionForm.classList.remove("hidden")}async function handleSaveSecretAnswer(){const e=document.getElementById("setup-secret-answer").value.trim();if(!e)return void mostrarPopup("\u274C Erro","Por favor, preencha a resposta.",3e3);try{const a=doc(db,"membros",currentUser);await updateDoc(a,{pet:e,usedProv:"on"}),mostrarPopup("\u2705 Tudo Pronto!",`Bem-vindo(a), ${currentUser}! Carregando o app...`,4e3),await performSuccessfulLogin(currentUser,!0)}catch(e){console.error("Erro ao salvar resposta secreta:",e),mostrarPopup("\u274C Falha Grave","Ocorreu um erro ao finalizar seu cadastro. Por favor, recarregue a p\xE1gina.",5e3)}}window.openModal=function(e){const a=document.getElementById(e);a&&(a.style.display="flex",a.classList.remove("hidden"))},window.closeModal=function(e){const a=document.getElementById(e);a&&(a.style.display="none",a.classList.add("hidden"))};async function handleUpdatePassword(){const e=document.getElementById("logged-in-new-password").value,a=document.getElementById("logged-in-confirm-password").value;if(!e||6>e.length)return void mostrarPopup("\u274C Erro","A senha deve ter no m\xEDnimo 6 caracteres.",3e3);if(e!==a)return void mostrarPopup("\u274C Erro","As senhas n\xE3o coincidem.",3e3);try{await updateDoc(doc(db,"membros",currentUser),{senha:e}),mostrarPopup("\u2705 Sucesso","Sua senha foi alterada!",3e3),closeModal("change-password-modal")}catch(e){mostrarPopup("\u274C Erro","Falha ao atualizar a senha.",3e3),console.error("Erro ao trocar senha:",e)}}async function handleUpdateSecretAnswer(){const e=document.getElementById("new-secret-answer").value.trim();if(!e)return void mostrarPopup("\u274C Erro","Por favor, digite uma resposta.",3e3);try{await updateDoc(doc(db,"membros",currentUser),{pet:e}),mostrarPopup("\u2705 Sucesso","Sua resposta secreta foi atualizada!",3e3),closeModal("change-secret-modal")}catch(e){mostrarPopup("\u274C Erro","Falha ao atualizar a resposta.",3e3),console.error("Erro ao trocar resposta secreta:",e)}}async function adicionarEventoAoFeed(e,a,o,t={}){try{const n=doc(collection(db,"resumoSemanalFeed")),r={id:n.id,tipo:e,titulo:a,texto:o,timestamp:new Date,reacoes:{"üëç":[],"üòÇ":[],"üò≠":[],"üíñ":[],"üò°":[]},...t};await setDoc(n,r)}catch(e){console.error("Erro ao adicionar evento ao feed:",e)}}function criarElementoCardResumo(e){const a=document.createElement("div");a.className=`feed-card ${e.tipo}`,a.dataset.id=e.id;const o=e.timestamp?.toDate?e.timestamp.toDate():new Date,t=o.toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit",year:"numeric"}),n=o.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"}),r=e.reacoes||{};let i="";const d=Object.keys(r).sort((e,a)=>(r[a]?.length||0)-(r[e]?.length||0));d.forEach(a=>{const o=Array.isArray(r[a])?r[a]:[];if(0<o.length){const t=o.includes(currentUser),n=t?"reacted":"";i+=`
        <div class="reacao-display ${n}" 
             title="Reagido por: ${o.join(", ")}"
             onclick="toggleReacaoFeed(event, '${e.id}', '${a}')">
          ${a} <span class="contador-display">${o.length}</span>
        </div>`}});const s=i?`<div class="feed-card-reacoes">${i}</div>`:`<div class="feed-card-reacoes"></div>`;return a.innerHTML=`
    <div class="feed-card-header">
      <span>${e.titulo}</span>
      <span>${`${t}, ${n}`}</span>
      
      ${"lider"===userRole?`
        <button class="feed-card-delete-btn" title="Apagar evento" onclick="deletarEventoFeed(event, '${e.id}')">
          &times;
        </button>
      `:""}
      </div>
    <div class="feed-card-body">
      ${e.texto}
    </div>
    ${s}
  `,a.addEventListener("click",o=>{if(o.target.closest(".reacao-display"))return;document.querySelectorAll(".reacao-seletor-bar").forEach(e=>e.remove());const t=document.createElement("div");t.className="reacao-seletor-bar";["\uD83D\uDC4D","\uD83D\uDC96","\uD83D\uDE02","\uD83C\uDF89","\uD83D\uDD25","\uD83C\uDFAF","\uD83D\uDE2D","\uD83D\uDE21"].forEach(a=>{const o=document.createElement("button");o.textContent=a,o.onclick=o=>{o.stopPropagation(),toggleReacaoFeed(o,e.id,a),t.remove()},t.appendChild(o)}),a.querySelector(".feed-card-reacoes").appendChild(t),setTimeout(()=>{document.addEventListener("click",function e(o){a.contains(o.target)||(t.remove(),document.removeEventListener("click",e))},{once:!0})},100)}),a}function configurarResumoSemanalTempoReal(){const e=document.getElementById("feed-semanal-cards");if(e){const a=query(collection(db,"resumoSemanalFeed"),orderBy("timestamp","desc"));onSnapshot(a,a=>(e.innerHTML="",a.empty?void(e.innerHTML="<div class=\"sem-mensagens\">Nenhum evento importante aconteceu esta semana ainda.</div>"):void a.forEach(a=>{const o=a.data(),t=criarElementoCardResumo(o);e.appendChild(t)})))}}window.toggleReacaoFeed=async function(e,a,o){if(e.stopPropagation(),!currentUser)return;atualizarReacaoOtimista("#feed-semanal-cards",a,o);const t=doc(db,"resumoSemanalFeed",a),n=doc(db,"membros",currentUser);try{await runTransaction(db,async e=>{const a=await e.get(t);if(!a.exists())throw"Evento n\xE3o encontrado!";const r=a.data(),i=r.nomeMembro||r.nomeLider,d=r.reacoes||{};let s=null,l=0;for(const a in d)if(Array.isArray(d[a])&&d[a].includes(currentUser)){s=a;break}Array.isArray(d[o])||(d[o]=[]);const m=d[o].indexOf(currentUser);if(s===o)-1<m&&(d[o].splice(m,1),l=-1);else{if(s){const e=d[s].indexOf(currentUser);-1<e&&d[s].splice(e,1)}else l=1;d[o].push(currentUser)}e.update(t,{reacoes:d}),0!==l&&e.update(n,{moedas:increment(l*(recompensasConfig.reagirConteudo||1))}),1===l&&i&&i!==currentUser?await criarNotificacao(i,currentUser,"feed",o,`reagiu a um evento sobre voc√™: "${r.titulo}"`):console.log("FEED: Condi\xE7\xE3o para notifica\xE7\xE3o n\xE3o atendida.",{mudancaDeMoedas:l,membroAlvo:i,currentUser})})}catch(e){console.error("Erro ao reagir no feed:",e),mostrarPopup("\u274C Ops!","Sua rea\xE7\xE3o n\xE3o p\xF4de ser salva. Por favor, recarregue a p\xE1gina.",4e3)}};async function limparFeedSemanal(){console.log("\uD83E\uDDF9 Verificando e limpando o feed da semana anterior...");const e=query(collection(db,"resumoSemanalFeed")),a=await getDocs(e);if(a.empty)return void console.log("Feed j\xE1 estava limpo.");const o=writeBatch(db);a.forEach(e=>{o.delete(e.ref)}),await o.commit(),console.log(`‚úÖ Feed limpo! ${a.size} eventos removidos.`),await adicionarEventoAoFeed("geral","\u2728 Uma Nova Semana Come\xE7ou!","O resumo da semana foi zerado. Que esta seja uma semana produtiva e cheia de foco para todos n\xF3s!")}async function limparTodoOMural(){console.log("\uD83E\uDDF9 Verificando e limpando o mural de mensagens...");const e=query(collection(db,"mural")),a=await getDocs(e);if(a.empty)return void console.log("Mural de mensagens j\xE1 estava limpo.");const o=writeBatch(db);a.forEach(e=>{o.delete(e.ref)}),await o.commit(),console.log(`‚úÖ Mural limpo! ${a.size} mensagens removidas.`)}async function limparTodosOsComentariosDoMural(){console.log("\uD83E\uDDF9 Verificando e limpando os coment\xE1rios do mural...");try{const e=collection(db,"mural"),a=await getDocs(e);if(a.empty)return void console.log("Nenhuma mensagem no mural para limpar coment\xE1rios.");const o=writeBatch(db);let t=0;for(const e of a.docs){const a=collection(db,"mural",e.id,"comments"),n=await getDocs(a);n.empty||n.forEach(e=>{o.delete(e.ref),t++})}0<t?(await o.commit(),console.log(`‚úÖ Coment√°rios limpos! ${t} coment√°rios foram removidos.`)):console.log("Nenhum coment\xE1rio encontrado para apagar.")}catch(e){console.error("Erro ao limpar os coment\xE1rios do mural:",e)}}async function requestGlobalRefresh(){if(confirm("Tem certeza que deseja for\xE7ar a atualiza\xE7\xE3o da p\xE1gina para todos os membros?"))try{const e=doc(db,"appState","status");await setDoc(e,{lastRefreshRequest:new Date}),mostrarPopup("\uD83D\uDE80 Enviado!","Comando de atualiza\xE7\xE3o enviado para todos os membros.",3e3)}catch(e){console.error("Erro ao solicitar atualiza\xE7\xE3o global:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel enviar o comando.",4e3)}}function setupRefreshListener(){const e=doc(db,"appState","status");onSnapshot(e,e=>{if(e.exists()){const a=e.data().lastRefreshRequest?.toDate();if(a){if(null===lastRefreshTimestamp)return void(lastRefreshTimestamp=a);a>lastRefreshTimestamp&&(console.log("Recebido comando de atualiza\xE7\xE3o global. Atualizando a interface..."),lastRefreshTimestamp=a,refreshAppUI())}}})}async function triggerForcedUpdate(){if(confirm("\u26A0\uFE0F ATEN\xC7\xC3O!\n\nVoc\xEA est\xE1 prestes a for\xE7ar uma atualiza\xE7\xE3o para TODOS os membros. A tela deles ser\xE1 bloqueada at\xE9 que cliquem no bot\xE3o para atualizar.\n\nUse isso apenas ap\xF3s ter certeza de que uma nova vers\xE3o do aplicativo est\xE1 no ar.\n\nDeseja continuar?"))try{const e=doc(db,"appState","status");await setDoc(e,{requiredUpdateVersion:new Date},{merge:!0}),mostrarPopup("\uD83D\uDE80 Enviado!","Comando de atualiza\xE7\xE3o de vers\xE3o enviado.",4e3)}catch(e){console.error("Erro ao for\xE7ar atualiza\xE7\xE3o:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel enviar o comando.",4e3)}}function showUpdateOverlay(){const e=document.getElementById("update-overlay");e&&e.classList.remove("hidden")}function performUpdate(){return officialAppVersion?void(sessionStorage.removeItem("popupDiarioMostrado"),localStorage.setItem("currentAppVersion",officialAppVersion.toISOString()),location.reload(!0)):void location.reload(!0)}function setupVersionCheckListener(){const e=doc(db,"appState","status");onSnapshot(e,e=>{if(e.exists()){const a=e.data();if(a.requiredUpdateVersion){officialAppVersion=a.requiredUpdateVersion.toDate();const e=localStorage.getItem("currentAppVersion"),o=e?new Date(e):new Date(0);officialAppVersion>o&&(console.log("Nova vers\xE3o detectada. Exibindo tela de atualiza\xE7\xE3o."),showUpdateOverlay())}}})}window.deletarEventoFeed=async function(e,a){if(e.stopPropagation(),!!confirm("Tem certeza que deseja apagar este evento do feed?"))try{const e=doc(db,"resumoSemanalFeed",a);await deleteDoc(e),mostrarPopup("\u2705 Sucesso","O evento foi removido do feed.",3e3)}catch(e){console.error("Erro ao deletar evento do feed:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel remover o evento.",4e3)}};async function carregarCondominioEpicos(){if(!currentUser)return;const e=doc(db,"membros",currentUser);onSnapshot(e,e=>{if(e.exists()){const a=e.data();document.getElementById("nome-membro-condominio").textContent=currentUser,document.getElementById("saldo-moedas").textContent=a.moedas||0,document.querySelector("#indicador-moedas-pessoal span").textContent=a.moedas||0;const o=document.getElementById("lote-pessoal-container"),t=a.casaExibida;t&&a.inventarioCasas?.includes(t)?getDoc(doc(db,"loja_casas",t)).then(e=>{e.exists()&&(o.innerHTML=`<img src="${e.data().imagemURL}" alt="${e.data().nome}">`)}):o.innerHTML=`
                    <div class="placa-terreno">
                        <div class="placa-madeira">Voc√™ ainda n√£o comprou uma casa no condom√≠nio √©picos.</div>
                        <div class="haste-madeira"></div>
                    </div>
                `}});const a=getHoje(),o=a.getHours(),t=18<=o||6>o,n=document.querySelector("#condominio-container .tree-sky");if(n)if(t){n.classList.add("night-mode"),n.classList.remove("day-mode"),criarEstrelas();const e=n.querySelector(".stars-container");e&&(e.style.opacity="1")}else{n.classList.remove("night-mode"),n.classList.add("day-mode");const e=n.querySelector(".stars-container");e&&(e.style.opacity="0")}document.getElementById("sol-condominio").style.opacity=t?"0":"1",document.getElementById("lua-condominio").style.opacity=t?"1":"0"}async function abrirLoja(){const e={pequena:document.getElementById("catalogo-pequenas"),media:document.getElementById("catalogo-medias"),mansao:document.getElementById("catalogo-mansoes")};for(const a in e)e[a].innerHTML="<p>Carregando casas...</p>";openModal("loja-modal");try{const a=await getDoc(doc(db,"membros",currentUser)),o=a.data().moedas||0,t=a.data().inventarioCasas||[],n=await getDocs(collection(db,"loja_casas"));for(const a in e)e[a].innerHTML="";n.forEach(a=>{const n={id:a.id,...a.data()},r=e[n.categoria];if(!r)return;const i=t.includes(n.id),d=o>=n.preco,s=document.createElement("div");s.className="casa-card",s.innerHTML=`
        <div class="casa-card-imagem"><img src="${n.imagemURL}" alt="${n.nome}"></div>
        <div class="casa-card-info">
          <div>
            <div class="casa-card-nome">${n.nome}</div>
            <div class="casa-card-preco">üí∞ ${n.preco}</div>
          </div>
          <button class="painel-btn btn-adicionar btn-comprar" 
                  onclick="comprarCasa('${n.id}', ${n.preco})"
                  ${i||!d?"disabled":""}>
            ${i?"J\xE1 Comprada":"Comprar"}
          </button>
        </div>
      `,r.appendChild(s)})}catch(e){console.error("Erro ao abrir a loja:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel carregar a loja.",4e3)}}window.comprarCasa=async function(e,a){const o=document.getElementById("confirm-compra-texto");o.innerHTML=`Voc√™ tem certeza que deseja comprar esta casa por <strong>üí∞ ${a} moedas</strong>?`;const t=document.getElementById("confirm-compra-btn");t.onclick=()=>executarCompraCasa(e,a),openModal("confirm-compra-modal")};async function executarCompraCasa(e,a){closeModal("confirm-compra-modal");const o=doc(db,"membros",currentUser);try{await runTransaction(db,async t=>{const n=await t.get(o);if(!n.exists())throw"Membro n\xE3o encontrado.";const r=n.data(),i=r.moedas||0;if(i<a)throw"Moedas insuficientes.";const d=r.inventarioCasas||[],s=0===d.length,l={moedas:increment(-a),inventarioCasas:arrayUnion(e)};s&&(l.casaExibida=e),t.update(o,l)});const t=doc(db,"loja_casas",e),n=await getDoc(t);if(n.exists()){const e=n.data(),a=document.getElementById("lote-pessoal-container");a&&(a.innerHTML=`<img src="${e.imagemURL}" alt="${e.nome}">`)}mostrarPopup("\uD83C\uDF89 Parab\xE9ns!","Voc\xEA comprou uma nova casa!",5e3),dispararConfete(),abrirLoja()}catch(e){console.error("Erro na compra:",e),mostrarPopup("\u274C Falha na Compra",e.toString(),4e3)}}async function abrirVisaoCondominio(){const e=document.getElementById("condominio-map");e.innerHTML="<h2>Carregando condom\xEDnio...</h2>",document.getElementById("condominio-view-overlay").classList.remove("hidden");try{const[a,o]=await Promise.all([getDocs(collection(db,"membros")),getDocs(collection(db,"loja_casas"))]),t=[];a.forEach(e=>t.push({id:e.id,...e.data()}));const n={};o.forEach(e=>n[e.id]=e.data());const r=t.length,i=Math.ceil(1.2*Math.sqrt(r));e.innerHTML="",t.forEach(a=>{const o=document.createElement("div");o.className="lote-condominio",o.id=`lote-${a.id}`;const t=a.casaExibida,r=t&&n[t]?n[t]:null,i=document.createElement("div");i.className="casa-imagem-container",i.innerHTML=r?`
          <img src="${r.imagemURL}" 
               class="casa-no-lote ${r.categoria}" 
               alt="${r.nome}">
        `:`
  <div class="placa-terreno">
    <div class="placa-madeira">sem casa</div>
    <div class="haste-madeira"></div>
  </div>
`,o.appendChild(i);const d=document.createElement("div");d.className="nome-lote",d.textContent=a.id,d.id=`nome-lote-${a.id}`,d.onclick=e=>toggleNameplateColorPalette(e,a.id),a.nomeLoteCor&&(d.style.backgroundColor=a.nomeLoteCor,d.style.color=isColorDark(a.nomeLoteCor)?"#FFFFFF":"#000000"),o.appendChild(d);const s=document.createElement("div");s.id=`palette-container-${a.id}`,s.className="nameplate-palette hidden",o.appendChild(s),e.appendChild(o)});const d=document.getElementById("condominio-map-wrapper");let s=!1,l,m,c,u;const g=a=>{s=!0,d.classList.add("active");const e=a.pageX||a.touches[0].pageX,o=a.pageY||a.touches[0].pageY;l=e-d.offsetLeft,m=o-d.offsetTop,c=d.scrollLeft,u=d.scrollTop},p=()=>{s=!1},f=a=>{if(!s)return;a.preventDefault();const e=a.pageX||a.touches[0].pageX,o=a.pageY||a.touches[0].pageY,t=e-d.offsetLeft,n=o-d.offsetTop,r=2*(t-l),i=2*(n-m);d.scrollLeft=c-r,d.scrollTop=u-i};d.addEventListener("mousedown",g),d.addEventListener("mouseleave",p),d.addEventListener("mouseup",p),d.addEventListener("mousemove",f),d.addEventListener("touchstart",g,{passive:!0}),d.addEventListener("touchend",p),d.addEventListener("touchmove",f)}catch(a){console.error("Erro ao montar o condom\xEDnio:",a),e.innerHTML="<h2>Ocorreu um erro ao carregar o condom\xEDnio.</h2>"}}function formatarDataISO(e){if(!e)return"";const a=e.getFullYear(),o=(e.getMonth()+1+"").padStart(2,"0"),t=(e.getDate()+"").padStart(2,"0");return`${a}-${o}-${t}`}async function limparFeedManualmente(){if(confirm("\u26A0\uFE0F ATEN\xC7\xC3O!\n\nVoc\xEA est\xE1 prestes a apagar TODOS os eventos do feed da semana.\n\nDeseja continuar?"))try{const e=collection(db,"resumoSemanalFeed"),a=await getDocs(e);if(a.empty)return void mostrarPopup("\u2139\uFE0F Informa\xE7\xE3o","O feed da semana j\xE1 est\xE1 limpo.",3e3);const o=writeBatch(db);a.forEach(e=>{o.delete(e.ref)}),await o.commit(),mostrarPopup("\u2705 Sucesso",`Todos os ${a.size} eventos do feed foram apagados.`,5e3)}catch(e){console.error("Erro ao limpar feed manualmente:",e),mostrarPopup("\u274C Erro","Ocorreu uma falha ao tentar limpar o feed.",4e3)}}async function limparMuralManualmente(){if(confirm("\u26A0\uFE0F ATEN\xC7\xC3O!\n\nVoc\xEA est\xE1 prestes a apagar TODAS as mensagens do mural.\n\nEsta a\xE7\xE3o \xE9 permanente. Deseja continuar?"))try{const e=collection(db,"mural"),a=await getDocs(e);if(a.empty)return void mostrarPopup("\u2139\uFE0F Informa\xE7\xE3o","O mural de mensagens j\xE1 est\xE1 vazio.",3e3);const o=writeBatch(db);a.forEach(e=>{o.delete(e.ref)}),await o.commit(),mostrarPopup("\u2705 Sucesso",`Todas as ${a.size} mensagens do mural foram apagadas.`,5e3)}catch(e){console.error("Erro ao limpar mural manualmente:",e),mostrarPopup("\u274C Erro","Ocorreu uma falha ao tentar limpar o mural.",4e3)}}async function abrirInventario(){const e=document.getElementById("inventario-grid");e.innerHTML="<p>Carregando seu invent\xE1rio...</p>",openModal("inventario-modal");try{const[a,o]=await Promise.all([getDoc(doc(db,"membros",currentUser)),getDocs(collection(db,"loja_casas"))]);if(!a.exists())throw"Membro n\xE3o encontrado.";const t=a.data(),n=t.inventarioCasas||[],r=t.casaExibida,i={};if(o.forEach(e=>{i[e.id]={id:e.id,...e.data()}}),e.innerHTML="",0===n.length)return void(e.innerHTML="<p style=\"text-align: center; font-style: italic;\">Voc\xEA ainda n\xE3o comprou nenhuma casa. Visite a loja!</p>");n.forEach(a=>{const o=i[a];if(!o)return;const t=o.id===r,n=document.createElement("div");n.className="casa-card",t&&n.classList.add("selecionada"),n.innerHTML=`
        <div class="casa-card-imagem"><img src="${o.imagemURL}" alt="${o.nome}"></div>
        <div class="casa-card-info">
          <div>
            <div class="casa-card-nome">${o.nome}</div>
          </div>
          <button class="painel-btn btn-adicionar btn-definir-principal" 
                  onclick="definirCasaPrincipal('${o.id}')"
                  ${t?"disabled":""}>
            ${t?"Principal":"Exibir esta"}
          </button>
        </div>
      `,e.appendChild(n)})}catch(e){console.error("Erro ao abrir o invent\xE1rio:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel carregar seu invent\xE1rio.",4e3),closeModal("inventario-modal")}}window.definirCasaPrincipal=async function(e){const a=doc(db,"membros",currentUser);try{await updateDoc(a,{casaExibida:e}),mostrarPopup("\u2705 Sucesso!","Sua casa principal foi atualizada.",3e3),await carregarCondominioEpicos(),closeModal("inventario-modal")}catch(e){console.error("Erro ao definir casa principal:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel salvar sua escolha.",4e3)}};function toggleNameplateColorPalette(e,a){if(e.stopPropagation(),currentUser!==a&&"lider"!==userRole)return void mostrarPopup("\uD83D\uDEAB Acesso Negado","Voc\xEA s\xF3 pode alterar a cor da sua pr\xF3pria placa.",3e3);const o=document.getElementById(`palette-container-${a}`),t=o.classList.contains("hidden");document.querySelectorAll(".nameplate-palette").forEach(e=>e.classList.add("hidden")),t&&(createNameplateColorPalette(a),o.classList.remove("hidden"))}function createNameplateColorPalette(e){const a=document.getElementById(`palette-container-${e}`);if(a&&""===a.innerHTML){["#FFFFFF","#FADADD","#FFD6A5","#FDFFB6","#CAFFBF","#9BF6FF","#A0C4FF","#BDB2FF","#FFC6FF","#EAE4E9","#D4E09B","#C3E0E5","#F7D6E0","#F3E9DD","#D3E4CD","#FF1744","#F50057","#D500F9","#651FFF","#3D5AFE","#2979FF","#00B0FF","#00E5FF","#1DE9B6","#00E676","#76FF03","#C6FF00","#FFEA00","#FFC400","#FF9100","#FF3D00","#F38375","#FBC42C","#57C479","#57C5C8","#578DC8","#8A57C8","#C857B2","#4B4A49","#ACACAC","#795548","#607D8B","#000000","#E57373","#BA68C8","#7986CB","#4FC3F7","#4DB6AC","#AED581","#FFF176","#FFB74D","#A1887F","#90A4AE","#008F93","#F08080","#20B2AA","#87CEEB","#9370DB","#DA70D6"].forEach(o=>{const t=document.createElement("div");t.className="nameplate-color-option",t.style.backgroundColor=o,t.onclick=a=>selectNameplateColor(a,e,o),a.appendChild(t)})}}async function selectNameplateColor(e,a,o){e.stopPropagation();const t=document.getElementById(`nome-lote-${a}`),n=document.getElementById(`palette-container-${a}`);t.style.backgroundColor=o,t.style.color=isColorDark(o)?"#FFFFFF":"#000000",n.classList.add("hidden");try{const e=doc(db,"membros",a);await updateDoc(e,{nomeLoteCor:o}),mostrarPopup("\uD83C\uDFA8 Sucesso","A cor da sua placa foi alterada!",2e3)}catch(e){console.error("Erro ao salvar a cor da placa:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel salvar a nova cor.",3e3)}}function findMyHouse(){if(!currentUser)return;const e=document.getElementById(`lote-${currentUser}`),a=document.getElementById("condominio-map-wrapper");if(e&&a){const o=e.offsetTop,t=e.offsetLeft,n=e.clientHeight,r=e.clientWidth,i=a.clientHeight,d=a.clientWidth;a.scrollTo({top:o-i/2+n/2,left:t-d/2+r/2,behavior:"smooth"}),e.classList.add("highlight"),setTimeout(()=>{e.classList.remove("highlight")},2500)}else mostrarPopup("\uD83E\uDD14 Hmm...","N\xE3o conseguimos encontrar seu lote no mapa.",3e3)}window.findMyHouse=findMyHouse;async function limparVantagensAntigas(){try{const e=getSemanaAtual(),a=`semana_${e.numero}_${e.inicio.getFullYear()}`,o=collection(db,"vantagemSemanal"),t=await getDocs(o);if(t.empty)return void console.log("Nenhum documento de vantagem encontrado para limpar.");const n=writeBatch(db);let r=0;t.forEach(e=>{e.id!==a&&(console.log(`Marcando para apagar documento de vantagem antigo: ${e.id}`),n.delete(e.ref),r++)}),0<r?(await n.commit(),console.log(`‚úÖ Limpeza conclu√≠da: ${r} documento(s) de vantagem antigos foram removidos.`)):console.log("Nenhum documento de vantagem antigo para apagar nesta verifica\xE7\xE3o.")}catch(e){console.error("Erro ao limpar a cole\xE7\xE3o 'vantagemSemanal':",e)}}async function limparPresencasAntigas(){try{const e=getSemanaAtual(),a=formatarDataISO(e.inicio),o=query(collection(db,"presencas"),where("__name__","<",a)),t=await getDocs(o);if(t.empty)return void console.log("Nenhum documento de presen\xE7a antigo encontrado para limpar.");const n=writeBatch(db);let r=0;t.forEach(e=>{console.log(`Marcando para apagar documento de presen√ßa antigo: ${e.id}`),n.delete(e.ref),r++}),0<r&&(await n.commit(),console.log(`‚úÖ Limpeza conclu√≠da: ${r} registro(s) de presen√ßa antigos foram removidos.`))}catch(e){console.error("Erro ao limpar a cole\xE7\xE3o 'presencas':",e)}}async function carregarRankingImobiliario(){openModal("ranking-imobiliario-modal");const e=document.getElementById("ranking-mais-casas-lista"),a=document.getElementById("ranking-maior-valor-lista");e.innerHTML="<p>Calculando...</p>",a.innerHTML="<p>Calculando...</p>";try{const[o,t]=await Promise.all([getDocs(collection(db,"membros")),getDocs(collection(db,"loja_casas"))]),n={};t.forEach(e=>{n[e.id]=e.data().preco||0});let r=[];if(o.forEach(e=>{const a=e.data(),o=a.inventarioCasas||[];if(0<o.length){const a=o.length,t=o.reduce((e,a)=>e+(n[a]||0),0);r.push({nome:e.id,quantidadeCasas:a,valorTotal:t})}}),0===r.length){return e.innerHTML="<p style=\"font-style: italic; text-align: center;\">Ningu\xE9m comprou uma casa ainda.</p>",void(a.innerHTML="<p style=\"font-style: italic; text-align: center;\">Ningu\xE9m comprou uma casa ainda.</p>")}const i=[...r].sort((e,a)=>a.quantidadeCasas-e.quantidadeCasas);e.innerHTML="",i.forEach((a,o)=>{const t=o+1;let n=`${t}¬∫`;1===t&&(n="\uD83E\uDD47"),2===t&&(n="\uD83E\uDD48"),3===t&&(n="\uD83E\uDD49");const r=document.createElement("div");r.className="ranking-imobiliario-item",r.innerHTML=`
        <span class="posicao">${n}</span>
        <span class="nome">${a.nome}</span>
        <span class="valor">üè† ${a.quantidadeCasas}</span>
      `,e.appendChild(r)});const d=[...r].sort((e,a)=>a.valorTotal-e.valorTotal);a.innerHTML="",d.forEach((e,o)=>{const t=o+1;let n=`${t}¬∫`;1===t&&(n="\uD83E\uDD47"),2===t&&(n="\uD83E\uDD48"),3===t&&(n="\uD83E\uDD49");const r=document.createElement("div");r.className="ranking-imobiliario-item",r.innerHTML=`
        <span class="posicao">${n}</span>
        <span class="nome">${e.nome}</span>
        <span class="valor">üí∞ ${e.valorTotal.toLocaleString("pt-BR")}</span>
      `,a.appendChild(r)})}catch(o){console.error("Erro ao carregar ranking imobili\xE1rio:",o),e.innerHTML="<p>Erro ao carregar.</p>",a.innerHTML="<p>Erro ao carregar.</p>"}}async function carregarConfiguracoesRecompensas(){try{const e=doc(db,"configuracoes","recompensas"),a=await getDoc(e);a.exists()?(recompensasConfig=a.data(),console.log("Configura\xE7\xF5es de recompensas carregadas:",recompensasConfig)):(console.warn("Documento de recompensas n\xE3o encontrado! Usando valores padr\xE3o."),recompensasConfig={focoDiario:100,postarMural:5,reagirConteudo:1,vitoriaJogoVantagem:50,top5Diario_1:25,top5Diario_2:20,top5Diario_3:15,top5Diario_4:10,top5Diario_5:5,top5Vantagem_1:50,top5Vantagem_2:40,top5Vantagem_3:30,top5Vantagem_4:20,top5Vantagem_5:10,vitoriaSemanal:500})}catch(e){console.error("Erro ao carregar configura\xE7\xF5es de recompensas:",e)}}function popularModalRecompensas(){for(const e in recompensasConfig){const a=document.getElementById(`reward-${e}`);a&&(a.textContent=recompensasConfig[e])}"lider"===userRole?document.querySelectorAll(".edit-reward-btn").forEach(e=>{e.classList.remove("hidden")}):document.querySelectorAll(".edit-reward-btn").forEach(e=>{e.classList.add("hidden")})}function handleRewardEditClick(e){if(e.target.classList.contains("edit-reward-btn")){const a=e.target.dataset.key;iniciarEdicaoRecompensa(a)}}function iniciarEdicaoRecompensa(e){const a=document.getElementById(`reward-${e}`);if(!a||a.isContentEditable)return;const o=a.textContent;a.contentEditable=!0,a.classList.add("editing"),a.focus(),document.execCommand("selectAll",!1,null);const t=async()=>{a.contentEditable=!1,a.classList.remove("editing"),a.removeEventListener("blur",t),a.removeEventListener("keydown",n);const r=a.textContent.trim(),i=parseInt(r,10);if(isNaN(i)||0>i)return mostrarPopup("\u274C Erro","Por favor, insira um n\xFAmero v\xE1lido.",3e3),void(a.textContent=o);if(i.toString()!==o)try{const a=doc(db,"configuracoes","recompensas");await updateDoc(a,{[e]:i}),recompensasConfig[e]=i,mostrarPopup("\u2705 Sucesso","Valor da recompensa atualizado!",3e3)}catch(e){console.error("Erro ao salvar recompensa:",e),mostrarPopup("\u274C Erro","Falha ao salvar. Tente novamente.",4e3),a.textContent=o}},n=n=>{"Enter"===n.key?(n.preventDefault(),t()):"Escape"===n.key&&(a.textContent=o,t())};a.addEventListener("blur",t),a.addEventListener("keydown",n)}function atualizarPainelPessoal(){const e=document.getElementById("painel-pessoal-container"),a=document.getElementById("saudacao-pessoal"),o=document.getElementById("botao-painel-usuario"),t=document.getElementById("indicador-equipe-pessoal");if(!e||!currentUser)return;if(e.classList.remove("hidden"),a.innerHTML=`Ol√°, <span id="nome-usuario-saudacao">${currentUser}</span>!`,o.classList.remove("hidden"),userTeam){const e=userTeam.charAt(0).toUpperCase()+userTeam.slice(1);t.textContent=`Equipe ${e}`,t.classList.remove("abelha","joaninha","vagalume","sem-equipe"),t.classList.add(userTeam),t.classList.remove("hidden")}else t.textContent=`Membro sem equipe`,t.classList.remove("abelha","joaninha","vagalume"),t.classList.add("sem-equipe"),t.classList.remove("hidden");const n=document.getElementById("btn-abrir-painel-controle"),r=document.getElementById("btn-abrir-gerador-codigo");n&&("lider"===userRole||"lider-equipe"===userRole?n.classList.remove("hidden"):n.classList.add("hidden")),r&&("lider"===userRole?r.classList.remove("hidden"):r.classList.add("hidden"))}function abrirGeradorDeCodigos(){closeModal("user-panel-modal"),document.getElementById("code-coin-value").value="",document.getElementById("generated-code-result").classList.add("hidden"),openModal("code-generator-modal")}function gerarCodigoAleatorio(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";let a="";for(let o=0;6>o;o++)a+=e.charAt(Math.floor(Math.random()*e.length));return a}async function handleGenerateCode(){const e=document.getElementById("code-coin-value"),a=parseInt(e.value,10);if(isNaN(a)||0>=a)return void mostrarPopup("\u274C Erro","Por favor, insira um valor de moedas v\xE1lido e positivo.",4e3);const o=gerarCodigoAleatorio(),t=doc(db,"configuracoes","codigos");try{await setDoc(t,{[o]:a},{merge:!0}),document.getElementById("generated-code-display").textContent=o,document.getElementById("generated-code-result").classList.remove("hidden"),mostrarPopup("\u2705 Sucesso!",`C√≥digo "${o}" gerado com sucesso!`,3e3)}catch(e){console.error("Erro ao gerar c\xF3digo:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel salvar o novo c\xF3digo no banco de dados.",5e3)}}async function handleRedeemCode(){const e=document.getElementById("secret-code-input"),a=e.value.trim().toUpperCase();if(6!==a.length)return void mostrarPopup("\uD83E\uDD14 Aten\xE7\xE3o","O c\xF3digo precisa ter exatamente 6 caracteres.",3e3);const o=doc(db,"configuracoes","codigos"),t=doc(db,"membros",currentUser);try{const n=await runTransaction(db,async e=>{const n=await e.get(o);if(!n.exists())throw"Nenhum c\xF3digo secreto foi gerado ainda.";const r=n.data(),i=r[a];if(!i)throw"C\xF3digo inv\xE1lido ou j\xE1 utilizado.";const d=i.valor||i,s=i.loteId;if(s){const a=await e.get(t),o=a.data().lotesResgatados||[];if(o.includes(s))throw"Voc\xEA j\xE1 utilizou um dos c\xF3digos deste lote.";e.update(t,{moedas:increment(d),lotesResgatados:arrayUnion(s)})}else e.update(t,{moedas:increment(d)});return e.update(o,{[a]:deleteField()}),d});mostrarPopup("\uD83C\uDF89 Recompensa Resgatada!",`Voc√™ ganhou <strong>${n} üí∞ moedas</strong>!`,5e3),dispararConfete(),e.value=""}catch(e){console.error("Erro ao resgatar c\xF3digo:",e),mostrarPopup("\u274C Falha no Resgate",e.toString(),4e3)}}async function handleGenerateBatchCode(){const e=document.getElementById("batch-code-quantity"),a=document.getElementById("batch-code-value"),o=document.getElementById("generated-batch-result"),t=document.getElementById("batch-codes-result-display"),n=parseInt(e.value,10),r=parseInt(a.value,10);if(isNaN(n)||0>=n||isNaN(r)||0>=r)return void mostrarPopup("\u274C Erro","Por favor, preencha a quantidade e o valor com n\xFAmeros v\xE1lidos.",4e3);const i=`lote-${Date.now()}`,d=doc(db,"configuracoes","codigos"),s=[],l=writeBatch(db);for(let e=0;e<n;e++){const e=gerarCodigoAleatorio();s.push(e);l.set(d,{[e]:{valor:r,loteId:i}},{merge:!0})}try{await l.commit(),t.value=s.join("\n"),o.classList.remove("hidden"),mostrarPopup("\u2705 Sucesso!",`${n} c√≥digos foram gerados no lote!`,4e3)}catch(e){console.error("Erro ao gerar lote de c\xF3digos:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel salvar o lote de c\xF3digos.",5e3)}}async function exibirPopupResultadoCompeticao(){const e=getHoje();if(0!==e.getDay())return;const a=sessionStorage.getItem("resultadoSemanalVisto");if(a)return;const o=getSemanaAtual(new Date(e.getTime()-86400000)),t=`semana_${o.numero}_${o.inicio.getFullYear()}`,n=doc(db,"resultadosCompeticao",t);try{const e=await getDoc(n);if(!e.exists())return void console.log("Documento de resultado da semana passada ainda n\xE3o foi gerado.");const a=e.data(),o=document.getElementById("resumo-competicao-ranking"),t=document.getElementById("resumo-competicao-body"),r=Object.entries(a.rankingEquipes).filter(([e])=>["abelha","joaninha","vagalume"].includes(e)).sort(([,e],[,a])=>e-a).map(([e,o])=>`${o}¬∫ Lugar: Equipe ${e.charAt(0).toUpperCase()+e.slice(1)} (${a.pontosEquipes[e]} pts)`).join("<br>");o.innerHTML=r;const i=Object.entries(a.rankingEquipes).filter(([e])=>["abelha","joaninha","vagalume"].includes(e)).sort(([,e],[,a])=>e-a).map(([e])=>e);let d="";i.forEach(e=>{const o=Object.values(a.detalhesMembros).filter(a=>a.equipe===e).sort((e,a)=>a.pontuacao.total-e.pontuacao.total);if(0<o.length){d+=`<div class="resumo-equipe-bloco">`,d+=`<div class="resumo-equipe-header ${e}">${e.charAt(0).toUpperCase()+e.slice(1)}</div>`,o.forEach(e=>{d+=`
                        <div class="resumo-membro-item">
                            <span class="resumo-membro-nome">${e.nome}</span>
                            <span class="resumo-membro-pontos">(Foco: ${e.pontuacao.foco}, Vantagem: ${e.pontuacao.vantagem})</span>
                            <span class="resumo-membro-total">${e.pontuacao.total} pts</span>
                        </div>
                    `});const t=a.ajustesManuais?.[e];if(t&&0!==t){const e=0<t?"positivo":"negativo",a=0<t?"Adi\xE7\xE3o de pontos pelo l\xEDder":"Remo\xE7\xE3o de pontos pelo l\xEDder";d+=`
                        <div class="resumo-membro-item resumo-ajuste-item ${e}">
                            <span class="resumo-membro-nome">${a}</span>
                            <span class="resumo-membro-total">${0<t?"+":""}${t} pts</span>
                        </div>
                    `}d+=`</div>`}}),t.innerHTML=d,openModal("resumo-competicao-modal"),sessionStorage.setItem("resultadoSemanalVisto","true")}catch(e){console.error("Erro ao exibir popup de resultado da competi\xE7\xE3o:",e)}}async function atualizarReacaoOtimista(e,a,o){if(!currentUser)return;const t=document.querySelector(`${e} [data-id="${a}"]`);if(!t)return;let n=t.querySelector(".reacoes-display-container, .feed-card-reacoes");if(!n){const e=t.querySelector(".feed-card-reacoes");if(e)n=e;else{const e=document.createElement("div");e.className="reacoes-display-container",t.querySelector(".mensagem-info").insertAdjacentElement("beforebegin",e),n=e}}const r=n.querySelector(".reacao-display.reacted"),i=n.querySelector(`.reacao-display[data-emoji="${o}"]`);if(r&&r!==i){r.classList.remove("reacted");const e=r.querySelector(".contador-display");let a=parseInt(e.textContent,10)-1;0>=a?r.remove():e.textContent=a}if(!i){const t=document.createElement("div");t.className="reacao-display reacted",t.dataset.emoji=o,t.innerHTML=`${o} <span class="contador-display">1</span>`,t.onclick="#feed-semanal-cards"===e?t=>toggleReacaoFeed(t,a,o):()=>window.abrirModalReagentes(a,o),n.appendChild(t)}else if(i.classList.contains("reacted")){i.classList.remove("reacted");const e=i.querySelector(".contador-display");let a=parseInt(e.textContent,10)-1;0>=a?i.remove():e.textContent=a}else{i.classList.add("reacted");const e=i.querySelector(".contador-display");e.textContent=parseInt(e.textContent,10)+1}const d=!!n.querySelector(".reacao-display.reacted");!!!r&&d&&mostrarPopupMoedas(recompensasConfig.reagirConteudo||1)}async function verificarELimparNaSegunda(){const e=getHoje();if(1!==e.getDay())return;const a=getSemanaAtual(),o=`semana_${a.numero}_${a.inicio.getFullYear()}`,t=doc(db,"appState","statusLimpeza");try{const e=await getDoc(t),a=e.exists()?e.data().ultimaLimpezaRealizada:null;if(a===o)return void console.log("Limpeza de segunda-feira j\xE1 realizada para esta semana (verificado no Firestore).");console.log("Primeira vez na segunda-feira para o grupo. Executando limpeza semanal centralizada..."),await Promise.all([limparFeedSemanal(),limparTodosOsComentariosDoMural(),limparTodoOMural(),limparPresencasAntigas(),limparVantagensAntigas(),limparResultadosCompeticaoAntigos(),limparNotificacoesAntigas(),limparTodasAsTelasDeDesenho()]),await setDoc(t,{ultimaLimpezaRealizada:o}),mostrarPopup("\u2728 Nova Semana!","O mural e o resumo da semana foram reiniciados.",5e3),console.log("Limpeza semanal conclu\xEDda e registrada no Firestore para todo o grupo.")}catch(e){console.error("Erro durante a limpeza centralizada de segunda-feira:",e),mostrarPopup("\u274C Erro","Ocorreu uma falha ao reiniciar o mural e o feed.",4e3)}}async function limparResultadosCompeticaoAntigos(){try{const e=getHoje(),a=getSemanaAtual(new Date(e.getTime()-86400000)),o=`semana_${a.numero}_${a.inicio.getFullYear()}`,t=collection(db,"resultadosCompeticao"),n=await getDocs(t);if(n.empty)return void console.log("Nenhum documento de resultado de competi\xE7\xE3o encontrado para limpar.");const r=writeBatch(db);let i=0;n.forEach(e=>{e.id!==o&&(console.log(`Marcando para apagar documento de resultado antigo: ${e.id}`),r.delete(e.ref),i++)}),0<i?(await r.commit(),console.log(`‚úÖ Limpeza conclu√≠da: ${i} resultado(s) de competi√ß√£o antigos foram removidos.`)):console.log("Nenhum resultado de competi\xE7\xE3o antigo para apagar nesta verifica\xE7\xE3o.")}catch(e){console.error("Erro ao limpar a cole\xE7\xE3o 'resultadosCompeticao':",e)}}window.forcarRegeracaoQuiz=async function(){if(confirm("Tem certeza que deseja apagar e recriar o Quiz da Vantagem desta semana?"))try{const e=getSemanaAtual(),a=`semana_${e.numero}_${e.inicio.getFullYear()}`,o=doc(db,"vantagemSemanal",a);await updateDoc(o,{quizDaSemana:deleteField()}),mostrarPopup("\u2705 Sucesso","Quiz antigo apagado. Recarregando para gerar um novo...",4e3),setTimeout(async()=>{await loadAdvantageState(),mostrarPopup("\uD83C\uDFB2 Novo Quiz","Um novo quiz foi gerado com sucesso!",3e3)},1500)}catch(e){console.error("Erro ao for\xE7ar recria\xE7\xE3o do quiz:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel apagar o quiz antigo. Tente manualmente.",5e3)}};async function carregarOrdemJogos(){try{const e=doc(db,"configuracoes","ordemJogosVantagem"),a=await getDoc(e);a.exists()&&a.data().ordem?(ordemJogosConfigurada=a.data().ordem,console.log("Ordem de jogos personalizada carregada:",ordemJogosConfigurada)):(console.log("Nenhuma ordem de jogos personalizada encontrada. Usando ordem padr\xE3o."),ordemJogosConfigurada=[])}catch(e){console.error("Erro ao carregar ordem dos jogos:",e),ordemJogosConfigurada=[]}}async function salvarNovaOrdemJogos(){const e=document.getElementById("game-order-list"),a=Array.from(e.children).map(e=>e.dataset.gameName);if(0===a.length)return void mostrarPopup("\u274C Erro","A lista de jogos est\xE1 vazia.",4e3);const o=getSemanaAtual().numero;try{const e=doc(db,"configuracoes","ordemJogosVantagem");await setDoc(e,{ordem:a,semanaDeInicio:o}),ordemJogosConfigurada=a,mostrarPopup("\u2705 Sucesso!","A nova ordem dos jogos foi salva.",3e3),popularPainelOrdemJogos()}catch(e){console.error("Erro ao salvar nova ordem de jogos:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel salvar a nova ordem.",4e3)}}function popularPainelOrdemJogos(){function a(e,a){const o=[...e.querySelectorAll(".game-order-item:not(.dragging)")];return o.reduce((e,o)=>{const t=o.getBoundingClientRect(),n=a-t.top-t.height/2;return 0>n&&n>e.offset?{offset:n,element:o}:e},{offset:Number.NEGATIVE_INFINITY}).element}const o=document.getElementById("game-order-list");if(!o)return;o.innerHTML="";const t=0<ordemJogosConfigurada.length?ordemJogosConfigurada:todosOsJogos.map(e=>e.nome);t.forEach((e,a)=>{const t=document.createElement("li");t.className="game-order-item",t.draggable=!0,t.dataset.gameName=e;let n="";0===a?n="<span class=\"week-indicator\">Esta Semana</span>":1==a&&(n="<span class=\"week-indicator\">Pr\xF3xima</span>"),t.innerHTML=`
      <span class="drag-handle">‚ò∞</span>
      <span class="game-name">${e}</span>
      ${n}
    `,o.appendChild(t)});const n=o.querySelectorAll(".game-order-item");let r=null;n.forEach(e=>{e.addEventListener("dragstart",()=>{r=e,setTimeout(()=>e.classList.add("dragging"),0)}),e.addEventListener("dragend",()=>{setTimeout(()=>{r.classList.remove("dragging"),r=null},0)}),e.addEventListener("dragover",t=>{t.preventDefault();const e=a(o,t.clientY);null==e?o.appendChild(r):o.insertBefore(r,e)})})}let membroIdParaSalvarAniversario=null,novaDataAniversario=null;async function abrirModalListaAniversarios(){const e=document.getElementById("lista-completa-aniversarios-container");e.innerHTML="<div class=\"ociosos-placeholder\">Carregando lista de membros...</div>",openModal("lista-aniversarios-modal");try{const a=await getDocs(collection(db,"membros"));e.innerHTML="";const o=[];a.forEach(e=>o.push({id:e.id,...e.data()})),o.sort((e,a)=>e.id.localeCompare(a.id)),o.forEach(a=>{const o=a,t=document.createElement("div");t.className="aniversario-item";const n=currentUser===a.id&&!o.aniversarioDefinido;t.innerHTML=`
        <span class="aniversario-nome-membro">${a.id}</span>
        <div class="aniversario-data-container">
          <span id="data-aniversario-${a.id}" class="aniversario-data-membro">
            ${o.aniversario||"N\xE3o definido"}
          </span>
          <button class="edit-aniversario-btn ${n?"":"hidden"}" 
                  onclick="editarAniversario(event, '${a.id}')" 
                  title="Definir seu anivers√°rio (s√≥ pode ser feito uma vez!)">
            ‚úèÔ∏è
          </button>
        </div>
      `,e.appendChild(t)})}catch(a){console.error("Erro ao carregar lista de anivers\xE1rios:",a),e.innerHTML="<div class=\"ociosos-placeholder\">Falha ao carregar a lista.</div>"}}window.editarAniversario=function(e,a){e.stopPropagation();const o=document.getElementById(`data-aniversario-${a}`);if(!o||o.isContentEditable)return;const t=o.textContent.trim();o.textContent="",o.contentEditable=!0,o.classList.add("editing"),o.setAttribute("placeholder","DD/MM"),o.focus();const n=()=>{handleSalvarAniversario(a,o,t)},r=a=>{"Enter"===a.key?(a.preventDefault(),o.blur()):"Escape"===a.key&&(o.textContent=t,o.contentEditable=!1,o.classList.remove("editing"),o.removeAttribute("placeholder"),o.removeEventListener("blur",n),o.removeEventListener("keydown",r))};o.addEventListener("blur",n),o.addEventListener("keydown",r)};function handleSalvarAniversario(e,a,o){a.contentEditable=!1,a.classList.remove("editing"),a.removeAttribute("placeholder");const t=a.textContent.trim();if(""===t||t===o)return void(a.textContent=o);if(!/^([0-2][0-9]|(3)[0-1])(\/)(((0)[0-9])|((1)[0-2]))$/.test(t))return mostrarPopup("\u274C Formato Inv\xE1lido","Use o formato DD/MM (ex: 25/12).",4e3),void(a.textContent=o);membroIdParaSalvarAniversario=e,novaDataAniversario=t;const n=document.getElementById("confirm-aniversario-texto");n.innerHTML=`Voc√™ est√° prestes a definir seu anivers√°rio como <strong>${t}</strong>.
                                <br><br>
                                Lembre-se: <strong>esta altera√ß√£o s√≥ pode ser feita uma √∫nica vez!</strong> Tem certeza que a data est√° correta?`;const r=document.getElementById("confirm-aniversario-btn");r.onclick=executarSalvarAniversario,openModal("confirm-aniversario-modal")}async function executarSalvarAniversario(){if(!membroIdParaSalvarAniversario||!novaDataAniversario)return;const e=membroIdParaSalvarAniversario,a=novaDataAniversario,o=doc(db,"membros",e);membroIdParaSalvarAniversario=null,novaDataAniversario=null,closeModal("confirm-aniversario-modal"),mostrarPopup("\u2705 Sucesso!","Sua data de anivers\xE1rio foi salva!",4e3);const t=document.getElementById(`data-aniversario-${e}`),n=document.querySelector(`.edit-aniversario-btn[onclick*="'${e}'"]`);t&&(t.textContent=a),n&&n.classList.add("hidden");try{await updateDoc(o,{aniversario:a,aniversarioDefinido:!0}),await carregarAniversariantes(),console.log(`Anivers√°rio de ${e} salvo com sucesso no banco de dados.`)}catch(e){console.error("Erro ao salvar anivers\xE1rio em segundo plano:",e),mostrarPopup("\u274C Falha na Sincroniza\xE7\xE3o","Sua altera\xE7\xE3o n\xE3o foi salva. Por favor, recarregue e tente novamente.",5e3),t&&(t.textContent="N\xE3o definido"),n&&n.classList.remove("hidden")}}async function marcarPresencaAniversario(e){if(!e||!e.nome)return;const a=e.nome,o=e.equipe,t=getHojeISO(),n=0===getHoje().getDay();try{const e=doc(db,"membros",a),r=doc(db,"presencas",t),i=doc(db,"semanas","pontosSemanais");await runTransaction(db,async t=>{t.set(r,{[a]:new Date},{merge:!0}),t.update(e,{streak:increment(1)}),!n&&o&&t.update(i,{[o]:increment(1)})});const d=await getDoc(e),s=d.exists()?d.data().streak:0;streaksCache[a]=s,atualizarStreakVisualMembro(a,s),o&&!n&&pontosSemanais[o]++;await adicionarEventoAoFeed("geral",`üéÇ Feliz Anivers√°rio, ${a}!`,`Hoje o foco de <strong>${a}</strong> foi marcado como um presente especial! Desejamos um dia incr√≠vel e muitas felicidades. Parab√©ns!`,{nomeMembro:a}),console.log(`Presen√ßa de anivers√°rio de ${a} marcada com sucesso no local correto.`)}catch(e){console.error(`Erro ao marcar presen√ßa de anivers√°rio para ${a}:`,e)}}async function handleAjusteManualPontos(e){const a=document.getElementById("select-equipe-ajuste").value,o=document.getElementById("input-pontos-ajuste"),t=parseInt(o.value,10);if(!a)return void mostrarPopup("\u26A0\uFE0F Aten\xE7\xE3o","Por favor, selecione uma equipe.",4e3);if(isNaN(t)||0>=t)return void mostrarPopup("\u26A0\uFE0F Aten\xE7\xE3o","Por favor, insira um n\xFAmero de pontos v\xE1lido e positivo.",4e3);const n="adicionar"===e?t:-t,r="adicionar"===e?"adicionados":"removidos",i="adicionar"===e?"para a":"da",d="adicionar"===e?"\uD83D\uDCC8":"\uD83D\uDCC9",s=a.charAt(0).toUpperCase()+a.slice(1);if(confirm(`Tem certeza que deseja ${e} ${t} pontos ${i} equipe ${s}?`))try{const e=getSemanaAtual(),l=`semana_${e.numero}_${e.inicio.getFullYear()}`,m=doc(db,"semanas","pontosSemanais"),c=doc(db,"vantagemSemanal",l),u=writeBatch(db);u.update(m,{[a]:increment(n)}),u.set(c,{ajustesManuais:{[a]:increment(n)}},{merge:!0}),await u.commit(),pontosSemanais[a]+=n,atualizarPlacarSemanal(),o.value="",await adicionarEventoAoFeed("geral",`${d} Ajuste de Pontos!`,`O L√≠der Geral ajustou a pontua√ß√£o: <strong>${t}</strong> pontos foram <strong>${r}</strong> ${i} equipe <strong>${s}</strong>.`,{equipe:a,ajuste:n}),mostrarPopup("\u2705 Sucesso!",`Pontos ${r} ${i} equipe ${s}.`,4e3)}catch(e){console.error("Erro ao ajustar pontos manualmente:",e),mostrarPopup("\u274C Erro","Ocorreu uma falha ao tentar ajustar os pontos.",5e3)}}async function criarNotificacao(e,a,o,t,n){try{const r=collection(db,"notificacoes");await addDoc(r,{destinatarioId:e,remetenteNome:a,tipo:o,conteudo:t,acao:n,lida:!1,timestamp:new Date})}catch(e){console.error("Erro ao criar notifica\xE7\xE3o:",e)}}function configurarNotificacoesTempoReal(){if(currentUser){const e=query(collection(db,"notificacoes"),where("destinatarioId","==",currentUser),orderBy("timestamp","desc"));onSnapshot(e,e=>{const a=document.getElementById("notificacoes-lista"),o=document.getElementById("notificacoes-contador");if(!a||!o)return void console.error("Elementos da interface de notifica\xE7\xE3o (#notificacoes-lista ou #notificacoes-contador) n\xE3o foram encontrados no DOM. A atualiza\xE7\xE3o da UI ser\xE1 ignorada.");let t=0;if(a.innerHTML="",e.empty)return a.innerHTML="<div class=\"ociosos-placeholder\">Nenhuma notifica\xE7\xE3o por aqui.</div>",void o.classList.add("hidden");e.forEach(e=>{const o=e.data();o.lida||t++;const n=criarElementoNotificacao(o);a.appendChild(n)});const n=document.getElementById("painel-pessoal-container");0<t?(o.textContent=`${t}`,o.classList.remove("hidden"),n&&n.classList.add("notificacao-neon-border")):(o.classList.add("hidden"),n&&n.classList.remove("notificacao-neon-border"))})}}function criarElementoNotificacao(e){const a=document.createElement("div");a.className="notificacao-item",e.lida||a.classList.add("nao-lida");const o=e.timestamp.toDate(),t=o.toLocaleDateString("pt-BR"),n=o.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});return a.innerHTML=`
        <div class="notificacao-conteudo">
            <strong>${e.remetenteNome}</strong> ${e.acao} 
            <span style="font-size: 1.2rem;">${e.conteudo}</span>
        </div>
        <div class="notificacao-horario">
            ${t}<br>${n}
        </div>
    `,a}async function marcarNotificacoesComoLidas(){const e=query(collection(db,"notificacoes"),where("destinatarioId","==",currentUser),where("lida","==",!1));try{const a=await getDocs(e);if(a.empty)return;const o=writeBatch(db);a.forEach(e=>{o.update(e.ref,{lida:!0})}),await o.commit(),console.log("Notifica\xE7\xF5es marcadas como lidas.")}catch(e){console.error("Erro ao marcar notifica\xE7\xF5es como lidas:",e)}}async function limparNotificacoesAntigas(){console.log("\uD83E\uDDF9 Verificando e limpando notifica\xE7\xF5es antigas...");try{const e=new Date,a=new Date(e.setDate(e.getDate()-7)),o=query(collection(db,"notificacoes"),where("timestamp","<",a)),t=await getDocs(o);if(t.empty)return void console.log("Nenhuma notifica\xE7\xE3o antiga para limpar.");const n=writeBatch(db);t.forEach(e=>{n.delete(e.ref)}),await n.commit(),console.log(`‚úÖ Limpeza conclu√≠da! ${t.size} notifica√ß√µes antigas foram removidas.`)}catch(e){console.error("Erro ao limpar notifica\xE7\xF5es antigas:",e)}}async function limparTodasAsTelasDeDesenho(){console.log("\uD83E\uDDF9 Limpando todas as telas de desenho...");const e=["abelha","joaninha","vagalume"];try{for(const a of e){const e=query(collection(db,`desenhos_${a}`)),o=await getDocs(e);if(!o.empty){const e=writeBatch(db);o.forEach(a=>e.delete(a.ref)),await e.commit(),console.log(`- Tela da equipe ${a} limpa.`)}}console.log("\u2705 Limpeza das telas de desenho conclu\xEDda.")}catch(e){console.error("Erro ao limpar as telas de desenho:",e)}}async function apagarTodasAsNotificacoes(){if(currentUser){console.log(`Iniciando exclus√£o de notifica√ß√µes para ${currentUser}...`);const e=query(collection(db,"notificacoes"),where("destinatarioId","==",currentUser));try{const a=await getDocs(e);if(a.empty)return void console.log("Nenhuma notifica\xE7\xE3o encontrada para apagar.");const o=writeBatch(db);a.forEach(e=>{o.delete(e.ref)}),await o.commit(),console.log(`${a.size} notifica√ß√µes de ${currentUser} apagadas com sucesso.`)}catch(e){console.error("Erro ao apagar notifica\xE7\xF5es:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel limpar suas notifica\xE7\xF5es.",4e3)}}}window.fecharEApagarNotificacoes=async function(){await apagarTodasAsNotificacoes(),closeModal("notificacoes-modal")};let modoAtual="pincel",corPincel="#000000",tamanhoPincel=5;function atualizarCursorDinamico(){const e=document.getElementById("tela-desenho-fullscreen");if(!e)return;let a="default";if("pincel"===modoAtual)a="crosshair";else if("borracha"===modoAtual){const e=Math.round(24+24*((parseInt(tamanhoPincel,10)-1)/49));a=`url("data:image/svg+xml,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="${e}" height="${e}" viewBox="0 0 32 32"><text x="2" y="26" font-size="24" font-weight="bold" fill="black" stroke="white" stroke-width="2" paint-order="stroke">„Äá</text></svg>`)}") 16 16, auto`}else"arrastar"===modoAtual&&(a="grab");e.style.cursor=a}function definirModoGlobal(e){modoAtual=e;const a=document.getElementById("pincel-btn"),o=document.getElementById("borracha-btn");a&&a.classList.toggle("ativo","pincel"===e),o&&o.classList.toggle("ativo","borracha"===e),atualizarCursorDinamico()}function configurarTelaDeDesenho(a){function o(){c.width=E,c.height=v,g.width=E,g.height=v;const e=u.getBoundingClientRect();m.width=e.width,m.height=e.height,s(!0)}function t(e,a){const o=c.getBoundingClientRect(),t=c.width/o.width,n=c.height/o.height;return{x:(e-o.left)*t,y:(a-o.top)*n}}function n(){return"borracha"===modoAtual?"#FFFFFF":corPincel}function r(e){podeDesenhar(a)&&(y=!0,B=e,b={pontos:[e],cor:n(),tamanho:tamanhoPincel})}function i(e){y&&podeDesenhar(a)&&(b.pontos.push(e),h.beginPath(),h.moveTo(B.x,B.y),h.lineTo(e.x,e.y),h.strokeStyle=n(),h.lineWidth=tamanhoPincel,h.lineCap="round",h.lineJoin="round",h.stroke(),B=e)}function d(){y&&(y=!1,B=null,1<b.pontos.length&&(L.push(b),l(b.pontos,b.cor,b.tamanho)),b=[],s(!0))}function s(e=!1){if(e){p.clearRect(0,0,g.width,g.height),f.clearRect(0,0,m.width,m.height);const e=m.width/E;L.forEach(a=>{if(a&&a.pontos&&!(2>a.pontos.length)){[p,f].forEach(o=>{o.beginPath(),o.strokeStyle=a.cor,o.lineWidth=o===f?a.tamanho*e:a.tamanho,o.lineCap="round",o.lineJoin="round";const t=o===f?e:1;o.moveTo(a.pontos[0].x*t,a.pontos[0].y*t);for(let e=1;e<a.pontos.length;e++)o.lineTo(a.pontos[e].x*t,a.pontos[e].y*t);o.stroke()})}})}activeDrawingTeam===a&&(h.clearRect(0,0,c.width,c.height),h.drawImage(g,0,0))}async function l(e,o,t){try{await limparHistoricoRefazer(a),await addDoc(I,{pontos:e,cor:o,tamanho:t,timestamp:new Date})}catch(e){console.error("Erro ao salvar:",e)}}const m=document.getElementById(`preview-canvas-${a}`),c=document.getElementById("tela-desenho-fullscreen"),u=document.getElementById(`preview-container-${a}`);if(!m||!c)return console.error(`Elementos do canvas para a equipe ${a} n√£o encontrados.`),{};const g=document.createElement("canvas"),p=g.getContext("2d"),f=m.getContext("2d"),h=c.getContext("2d"),E=800,v=600;let y=!1,b=[],L=[],B=null,C=null;const I=collection(db,`desenhos_${a}`);C=onSnapshot(query(I,orderBy("timestamp")),e=>{L=[],e.forEach(e=>L.push(e.data())),s(!0)});const F=o=>{if(activeDrawingTeam===a&&"arrastar"!==modoAtual){const e=t(o.clientX,o.clientY);r(e)}},x=o=>{if(activeDrawingTeam===a&&y){const e=t(o.clientX,o.clientY);i(e)}},k=()=>{activeDrawingTeam!==a||d()},D=o=>{if(!(activeDrawingTeam!==a||"arrastar"===modoAtual||1<o.touches.length)){const e=t(o.touches[0].clientX,o.touches[0].clientY);r(e)}},A=o=>{if(activeDrawingTeam===a&&y&&!(1<o.touches.length)){const e=t(o.touches[0].clientX,o.touches[0].clientY);i(e)}},S=()=>{activeDrawingTeam!==a||d()};return window.addEventListener("resize",()=>{activeDrawingTeam===a&&o()}),{setupCanvases:o,addEventListeners:function(){c.addEventListener("mousedown",F),window.addEventListener("mousemove",x),window.addEventListener("mouseup",k),c.addEventListener("mouseleave",k),c.addEventListener("touchmove",A,{passive:!1}),c.addEventListener("touchstart",D,{passive:!1}),c.addEventListener("touchend",S),document.getElementById("desfazer-btn").onclick=window.desfazerAcao,document.getElementById("refazer-btn").onclick=window.refazerAcao},removeEventListeners:function(){c.removeEventListener("mousedown",F),window.removeEventListener("mousemove",x),window.removeEventListener("mouseup",k),c.removeEventListener("mouseleave",k),c.removeEventListener("touchmove",A),c.removeEventListener("touchstart",D),c.removeEventListener("touchend",S)},unsubscribe:C}}function abrirModalDesenho(e){if(drawingContexts[e]||(console.log(`Contexto de desenho criado sob demanda para a equipe ${e}.`),drawingContexts[e]=configurarTelaDeDesenho(e)),activeDrawingTeam&&drawingContexts[activeDrawingTeam]){const e=drawingContexts[activeDrawingTeam];e.removeEventListeners&&e.removeEventListeners()}activeDrawingTeam=e;const a=podeDesenhar(e),o=document.getElementById("desenho-toolbar"),t=document.getElementById("desenho-modal");let n=document.getElementById("desenho-modal-overlay-bloqueio");n&&n.remove(),a?o.style.display="flex":(o.style.display="none",n=document.createElement("div"),n.id="desenho-modal-overlay-bloqueio",n.textContent="Voc\xEA s\xF3 pode visualizar esta tela.",t.appendChild(n)),openModal("desenho-modal");const r=drawingContexts[e];r&&setTimeout(()=>{r.setupCanvases&&r.setupCanvases(),r.addEventListeners&&r.addEventListeners()},50)}function desligarTodosOsOuvintesDeDesenho(){for(const e in console.log("Desligando todos os ouvintes de desenho..."),drawingContexts){const a=drawingContexts[e];a&&a.desligarOuvinte&&(a.desligarOuvinte(),console.log(`- Ouvinte da equipe ${e} desligado.`))}drawingContexts={}}async function limparTelaDeDesenho(e){console.log(`üßπ Limpando a tela de desenho da equipe: ${e}...`);try{const a=query(collection(db,`desenhos_${e}`)),o=await getDocs(a);if(o.empty)return;const t=writeBatch(db);o.forEach(e=>t.delete(e.ref)),await t.commit(),console.log(`‚úÖ Tela de ${e} limpa com sucesso.`)}catch(a){console.error(`Erro ao limpar a tela de ${e}:`,a)}}function confirmarLimpezaDeTela(e){if(podeDesenhar(e)){const a=e.charAt(0).toUpperCase()+e.slice(1);document.getElementById("confirm-clear-canvas-text").innerHTML=`Voc√™ tem certeza que deseja apagar permanentemente todo o desenho da equipe <strong>${a}</strong>? <br><br>Esta a√ß√£o n√£o pode ser desfeita.`,document.getElementById("confirm-clear-canvas-btn").onclick=()=>executarLimpezaDeTela(e),openModal("confirm-clear-canvas-modal")}else mostrarPopup("\uD83D\uDEAB Acesso Negado","Voc\xEA n\xE3o tem permiss\xE3o para limpar esta tela.",4e3)}function executarLimpezaDeTela(e){limparTelaDeDesenho(e),closeModal("confirm-clear-canvas-modal"),mostrarPopup("\u2705 Sucesso",`A tela da equipe ${e} foi limpa.`,3e3)}async function limparHistoricoRefazer(e){const a=collection(db,`historicoDesfeito_${e}`);try{const o=await getDocs(a);if(o.empty)return;const t=writeBatch(db);o.forEach(e=>{t.delete(e.ref)}),await t.commit(),console.log(`Hist√≥rico de "refazer" para a equipe ${e} foi limpo.`)}catch(e){console.error("Erro ao limpar hist\xF3rico de refazer:",e)}}window.desfazerAcao=async function(){if(!activeDrawingTeam)return;const e=collection(db,`desenhos_${activeDrawingTeam}`),a=collection(db,`historicoDesfeito_${activeDrawingTeam}`),o=query(e,orderBy("timestamp","desc"),limit(1));try{const e=await getDocs(o);if(e.empty)return void mostrarPopup("\u2139\uFE0F","N\xE3o h\xE1 nada para desfazer.",2e3);const t=e.docs[0],n=t.data(),r=writeBatch(db);r.set(doc(a),n),r.delete(t.ref),await r.commit()}catch(e){console.error("Erro ao desfazer:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel desfazer a a\xE7\xE3o.",3e3)}},window.refazerAcao=async function(){if(!activeDrawingTeam)return;const e=collection(db,`desenhos_${activeDrawingTeam}`),a=collection(db,`historicoDesfeito_${activeDrawingTeam}`),o=query(a,orderBy("timestamp","desc"),limit(1));try{const a=await getDocs(o);if(a.empty)return void mostrarPopup("\u2139\uFE0F","N\xE3o h\xE1 nada para refazer.",2e3);const t=a.docs[0],n=t.data(),r=writeBatch(db);r.set(doc(e),n),r.delete(t.ref),await r.commit()}catch(e){console.error("Erro ao refazer:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel refazer a a\xE7\xE3o.",3e3)}};function iniciarCarrosselDesenho(){carrosselDesenhoInterval&&clearInterval(carrosselDesenhoInterval),carrosselDesenhoInterval=setInterval(()=>{carrosselDesenhoPausado||(currentCarrosselDesenhoIndex=(currentCarrosselDesenhoIndex+1)%3,irParaSlideDesenho(currentCarrosselDesenhoIndex))},1e4)}window.irParaSlideDesenho=function(e){const a=document.getElementById("carrossel-container-desenho");a.style.transform=`translateX(-${100*e}%)`;const o=document.querySelectorAll("#carrossel-indicadores-desenho .carrossel-indicador");o.forEach((a,o)=>{a.classList.toggle("ativo",o===e)}),currentCarrosselDesenhoIndex=e,carrosselDesenhoPausado||iniciarBarraProgressoDesenho()};function reiniciarIntervaloCarrosselDesenho(){clearInterval(carrosselDesenhoInterval),iniciarCarrosselDesenho(),iniciarBarraProgressoDesenho()}window.mudarSlideDesenho=function(e){reiniciarIntervaloCarrosselDesenho();currentCarrosselDesenhoIndex=(currentCarrosselDesenhoIndex+e+3)%3,irParaSlideDesenho(currentCarrosselDesenhoIndex)},window.togglePausaDesenho=function(){carrosselDesenhoPausado=!carrosselDesenhoPausado;const e=document.getElementById("botao-pausa-desenho"),a=document.getElementById("progresso-indicador-barra-desenho");if(!carrosselDesenhoPausado)e.textContent="\u23F8",a&&a.classList.add("animar"),iniciarCarrosselDesenho();else if(clearInterval(carrosselDesenhoInterval),e.textContent="\u25B6",a){const e=window.getComputedStyle(a).width;a.classList.remove("animar"),a.style.width=e}};function iniciarBarraProgressoDesenho(){const e=document.getElementById("progresso-indicador-barra-desenho");e&&(e.style.transition="none",e.style.width="0%",void e.offsetWidth,e.style.transition="width 10s linear",setTimeout(()=>{carrosselDesenhoPausado||(e.style.width="100%")},10),progressoBarraDesenho&&clearTimeout(progressoBarraDesenho),progressoBarraDesenho=setTimeout(()=>{e.style.width="0%"},1e4))}async function enviarComentario(e){const a=document.getElementById("comment-textarea-modal"),o=a.value.trim();if(!o)return void mostrarPopup("\u270D\uFE0F Aten\xE7\xE3o","Escreva algo para comentar.",3e3);const t=doc(db,"mural",e),n=collection(t,"comments");try{const e=query(n,where("userId","==",currentUser)),r=await getDocs(e);if(3<=r.size)return void mostrarPopup("\uD83D\uDEAB Limite Atingido","Voc\xEA j\xE1 adicionou o m\xE1ximo de 3 coment\xE1rios nesta mensagem.",5e3);await addDoc(n,{userId:currentUser,texto:o,timestamp:new Date}),await updateDoc(t,{commentCount:increment(1)});const i=doc(db,"membros",currentUser);await updateDoc(i,{moedas:increment(25)}),mostrarPopupMoedas(25);const d=await getDoc(t);if(d.exists()){const e=d.data().userId;e&&e!==currentUser&&(await criarNotificacao(e,currentUser,"mural-comment","\uD83D\uDCAC",`comentou na sua mensagem: "${d.data().texto.substring(0,30)}..."`))}a.value=""}catch(e){console.error("Erro ao enviar coment\xE1rio:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel salvar seu coment\xE1rio.",4e3)}}window.openCommentsModal=async function(e){const a=document.getElementById("comments-modal");openModal("comments-modal"),a.removeAttribute("data-theme"),document.body.classList.contains("tema-noite")?a.dataset.theme="noite":document.body.classList.contains("tema-manha")?a.dataset.theme="manha":document.body.classList.contains("tema-tarde")&&(a.dataset.theme="tarde");const o=document.getElementById("comments-list");o.innerHTML="<p class=\"no-comments\">Carregando coment\xE1rios...</p>";const t=document.getElementById("send-comment-btn-modal");t.onclick=()=>enviarComentario(e);const n=document.getElementById("comment-textarea-modal"),r=doc(db,"mural",e),i=collection(r,"comments"),d=query(i,orderBy("timestamp","asc"));onSnapshot(d,a=>(o.innerHTML="",a.empty?void(o.innerHTML="<p class=\"no-comments\">Nenhum coment\xE1rio ainda. Seja o primeiro!</p>"):void(a.forEach(a=>{const t=a.data(),n=document.createElement("div");n.className="comment-item";const r=t.timestamp.toDate(),i=r.toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit"}),d=r.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});let s="";t.userId===currentUser&&(s=`
    <div class="comment-options-container">
      <button class="options-btn" onclick="window.openOptionsMenu(event, 'comment', '${e}', '${a.id}')">‚ãÆ</button>
    </div>
  `),n.innerHTML=`
        <div class="comment-header">
          <strong class="comment-author">${t.userId}</strong>
          <span class="comment-timestamp">${i} √†s ${d}</span>
          ${s}
        </div>
        <p class="comment-text">${t.texto.replace(/\n/g,"<br>")}</p>
      `,o.appendChild(n)}),o.scrollTop=o.scrollHeight)))},window.excluirComentario=function(e,a,o){e.stopPropagation(),commentIdToDelete=o,messageIdForCommentAction=a,openModal("confirm-delete-comment-modal")};async function executarExclusaoComentario(){if(!commentIdToDelete||!messageIdForCommentAction)return;const e=doc(db,"mural",messageIdForCommentAction),a=doc(e,"comments",commentIdToDelete);try{await runTransaction(db,async o=>{o.delete(a),o.update(e,{commentCount:increment(-1)})}),mostrarPopup("\u2705 Sucesso","Coment\xE1rio exclu\xEDdo!",3e3)}catch(e){console.error("Erro ao excluir coment\xE1rio:",e),mostrarPopup("\u274C Erro","Falha ao excluir o coment\xE1rio.",4e3)}finally{closeModal("confirm-delete-comment-modal"),commentIdToDelete=null,messageIdForCommentAction=null}}window.editarComentario=async function(e,a,o){e.stopPropagation(),editingCommentId=o,messageIdForCommentAction=a;const t=doc(db,"mural",a,"comments",o);try{const e=await getDoc(t);if(e.exists()){const a=e.data().texto;document.getElementById("edit-comment-textarea").value=a,openModal("edit-comment-modal")}else throw new Error("Coment\xE1rio n\xE3o encontrado.")}catch(e){console.error("Erro ao buscar coment\xE1rio para editar:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel carregar o coment\xE1rio para edi\xE7\xE3o.",4e3)}};async function salvarEdicaoComentario(){if(editingCommentId&&messageIdForCommentAction){const e=document.getElementById("edit-comment-textarea").value.trim();if(!e)return void mostrarPopup("\u270D\uFE0F Aten\xE7\xE3o","O coment\xE1rio n\xE3o pode ficar vazio.",3e3);const a=doc(db,"mural",messageIdForCommentAction,"comments",editingCommentId);try{await updateDoc(a,{texto:e}),mostrarPopup("\u2705 Sucesso","Coment\xE1rio atualizado!",3e3)}catch(e){console.error("Erro ao salvar edi\xE7\xE3o do coment\xE1rio:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel salvar as altera\xE7\xF5es.",4e3)}finally{closeModal("edit-comment-modal"),editingCommentId=null,messageIdForCommentAction=null}}}window.openOptionsMenu=function(e,a,o,t=null){e.stopPropagation();const n=document.getElementById("global-options-menu");if(!n.classList.contains("hidden"))return n.classList.add("hidden"),void(window.closeMenuOnClickOutside&&document.removeEventListener("click",window.closeMenuOnClickOutside,!0));window.closeMenuOnClickOutside&&document.removeEventListener("click",window.closeMenuOnClickOutside,!0),n.innerHTML="","message"===a?n.innerHTML=`
      <button onclick="window.editarMensagem(event, '${o}')">Editar</button>
      <button onclick="window.excluirMensagem(event, '${o}')">Excluir</button>
    `:"comment"==a&&(n.innerHTML=`
      <button onclick="window.editarComentario(event, '${o}', '${t}')">Editar</button>
      <button onclick="window.excluirComentario(event, '${o}', '${t}')">Excluir</button>
    `);const r=e.target.getBoundingClientRect(),i=window.scrollY||document.documentElement.scrollTop;n.style.top=`${i+r.bottom+5}px`;const d=window.innerWidth-r.right,s=r.left;d<140&&s>d?(n.style.left="auto",n.style.right=`${window.innerWidth-r.right}px`):(n.style.left=`${r.left}px`,n.style.right="auto"),n.classList.remove("hidden"),window.closeMenuOnClickOutside=a=>{a.target.closest(".options-btn")||!n.contains(a.target)&&(n.classList.add("hidden"),document.removeEventListener("click",window.closeMenuOnClickOutside,!0))},setTimeout(()=>{document.addEventListener("click",window.closeMenuOnClickOutside,!0)},0)};async function iniciarCarregamentoAutomaticoDesenhos(){async function e(t){if(t>=a.length)return void console.log("Todos os desenhos foram pr\xE9-carregados.");const n=a[t],r=a[t+1],i=document.getElementById(`preview-container-${n}`),d=i.querySelector(".loading-overlay");if(i.classList.add("is-loading"),d.textContent="Carregando...",d.classList.remove("hidden"),console.log(`Pr√©-carregando desenho da equipe: ${n}`),drawingContexts[n]||(drawingContexts[n]=configurarTelaDeDesenho(n)),await new Promise(e=>setTimeout(e,1500)),i.classList.remove("is-loading"),d.classList.add("hidden"),console.log(`Desenho da equipe ${n} pr√©-carregado.`),r){const a=document.getElementById(`preview-container-${r}`),n=a.querySelector(".loading-overlay");let i=o;n.textContent=`Carregando em ${i}...`,n.classList.remove("hidden");const d=setInterval(()=>{i--,n.textContent=`Carregando em ${i}...`,0>=i&&(clearInterval(d),e(t+1))},1e3);a.onclick=()=>{clearInterval(d),n.classList.add("hidden"),abrirModalDesenho(r)}}}const a=["abelha","joaninha","vagalume"],o=5;e(0)}window.onload=async()=>{initAuth(),"serviceWorker"in navigator&&navigator.serviceWorker.register("/sw.js").then(e=>{console.log("Service Worker registrado com sucesso:",e)}).catch(e=>{console.log("Falha ao registrar Service Worker:",e)});const e=localStorage.getItem("loggedInUser");if(e){await performSuccessfulLogin(e);const a=document.getElementById("medalha-diamante");a&&a.addEventListener("click",verificarCliquesDiamante)}else{dataAtual=getHojeISO(),await carregarDadosEssenciais(),construirInterface(),setTimeout(()=>{iniciarCarrosselAutomatico(),irParaSlide(0)},1e3),await Promise.all([carregarPresenca(),carregarPontosSemanais(),carregarRankingGeral(),carregarAniversariantes(),carregarArvoreEpica(),carregarStreaks()]),await carregarCondominioEpicos(),0===getHoje().getDay()&&(pontosSemanais.abelha=0,pontosSemanais.joaninha=0,pontosSemanais.vagalume=0);const e=doc(db,"ranking","geral"),a=await getDoc(e);a.exists()||(await setDoc(e,rankingGeral)),atualizarPlacarSemanal(),atualizarRankingGeral(),await finalizarSemana();const o=new Date().getHours(),t=document.body;t.classList.remove("tema-manha","tema-tarde","tema-noite"),5<=o&&12>o?t.classList.add("tema-manha"):12<=o&&18>o?t.classList.add("tema-tarde"):t.classList.add("tema-noite"),atualizarDataCabecalho(),atualizarInfoSemana();const n=document.getElementById("medalha-diamante");n&&n.addEventListener("click",verificarCliquesDiamante),await atualizarResumo(),verificarEquipeCompleta(),configurarMuralTempoReal(),configurarInputMensagem(),await exibirQuadroFolgas(),carregarTop5Semana(),window.addEventListener("beforeunload",()=>{pararConfeteAniversarioContinuo()})}atualizarRelogio(),setInterval(atualizarRelogio,1e3),setInterval(verificarMudancaData,6e4),window.addEventListener("focus",verificarMudancaData)};async function refreshAppUI(){mostrarPopup("\uD83D\uDD04 Atualizando","Aguarde, recarregando a interface...",2e3),await carregarMembros(),construirInterface(),await Promise.all([carregarPresenca(),carregarPontosSemanais(),carregarRankingGeral(),carregarAniversariantes(),carregarArvoreEpica(),carregarStreaks(),exibirQuadroFolgas(),carregarInformacoesMembros()]),await atualizarResumo(),atualizarPlacarSemanal(),atualizarRankingGeral(),atualizarVisualBloqueio(),await carregarEExibirMembrosOciosos(),mostrarPopup("\u2705 Pronto!","Interface atualizada com sucesso!",3e3)}async function openControlPanel(){const e=document.querySelectorAll(".lider-geral-only");"lider"===userRole?e.forEach(e=>e.classList.remove("hidden")):e.forEach(e=>e.classList.add("hidden"));const a=document.getElementById("select-member-to-remove"),o=document.getElementById("new-member-team"),t=document.getElementById("new-member-role");a.innerHTML="<option value=\"\">Selecione um membro para remover...</option>",todosMembros.forEach(e=>{if(e.nome!==currentUser)if("lider"===userRole){const o=new Option(`${e.nome} (${e.equipe})`,e.nome);a.appendChild(o)}else if("lider-equipe"===userRole&&e.equipe===userTeam){const o=new Option(e.nome,e.nome);a.appendChild(o)}}),"lider-equipe"===userRole?(o.value=userTeam,o.disabled=!0,t.value="membro"):o.disabled=!1,document.getElementById("new-member-result").textContent="",popularPainelOrdemJogos(),openModal("control-panel-modal")}window.abrirPlacarVantagem=async function(){const e=getSemanaAtual(),a=`semana_${e.numero}_${e.inicio.getFullYear()}`,o=doc(db,"vantagemSemanal",a),t=document.getElementById("placar-completos"),n=document.getElementById("placar-pendentes");t.innerHTML="<li>Carregando...</li>",n.innerHTML="<li>Carregando...</li>",openModal("placar-vantagem-modal");try{const e=await getDoc(o),a=e.exists()?e.data().completadoPor||{}:{},r=[],i=[];todosMembros.forEach(e=>{a[e.nome]?r.push({nome:e.nome,equipe:e.equipe,timestamp:a[e.nome].toDate()}):i.push({nome:e.nome,equipe:e.equipe})}),r.sort((e,a)=>e.timestamp-a.timestamp),t.innerHTML=0<r.length?r.map((e,a)=>{const o=e.timestamp.toLocaleDateString("pt-BR"),t=e.timestamp.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});return`
          <div class="placar-item">
            <span class="posicao">${a+1}¬∫</span>
            <span class="nome ${e.equipe}">${e.nome}</span>
            <span class="timestamp">${o} √†s ${t}</span>
          </div>
        `}).join(""):"<div class=\"placar-item\">Ningu\xE9m finalizou o jogo ainda.</div>",n.innerHTML=0<i.length?i.map(e=>`
          <div class="placar-item">
             <span class="nome ${e.equipe}">${e.nome}</span>
          </div>
        `).join(""):"<div class=\"placar-item\">Todos os membros finalizaram! Parab\xE9ns!</div>"}catch(e){console.error("Erro ao carregar placar da vantagem:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel carregar o placar.",4e3),closeModal("placar-vantagem-modal")}};async function handleAddMember(){let e=document.getElementById("new-member-name").value.trim();const a=document.getElementById("new-member-team").value,o=document.getElementById("new-member-role").value;if(!e)return void mostrarPopup("\u274C Erro","O nome do membro n\xE3o pode ser vazio.",3e3);e=e.charAt(0).toUpperCase()+e.slice(1);const t=todosMembros.some(a=>a.nome.toLowerCase()===e.toLowerCase());if(t)return void mostrarPopup("\u274C Erro",`O membro "${e}" j√° existe!`,4e3);const n=Math.floor(1e4+9e4*Math.random()).toString();try{await setDoc(doc(db,"membros",e),{equipe:a,papel:o,senhaProv:n,usedProv:"off",folga:"segunda-feira",aniversario:"",apelido:"",filme:"",sonho:"",musica:"",curiosidade:""}),await adicionarEventoAoFeed("geral","\uD83D\uDC4B Bem-vindo(a) ao Grupo!",`Um novo √©pico se juntou a n√≥s! Seja muito bem-vindo(a), <strong>${e}</strong>!`,{nomeMembro:e}),document.getElementById("success-username").innerText=e,document.getElementById("success-password").innerText=n,openModal("new-member-success-modal"),document.getElementById("new-member-name").value="",document.getElementById("new-member-result").textContent="",await refreshAppUI()}catch(e){console.error("Erro ao adicionar membro:",e),mostrarPopup("\u274C Falha","Ocorreu um erro ao salvar o novo membro.",4e3)}}async function handleRemoveMember(){const e=document.getElementById("select-member-to-remove").value;return e?void(memberIdToRemove=e,document.getElementById("member-to-remove-name").innerText=e,openModal("confirm-remove-modal")):void mostrarPopup("\u274C Erro","Selecione um membro para remover.",3e3)}async function executeRemoveMember(){if(memberIdToRemove)try{await deleteDoc(doc(db,"membros",memberIdToRemove)),mostrarPopup("\u2705 Sucesso",`O membro "${memberIdToRemove}" foi removido.`,4e3),await refreshAppUI(),closeModal("control-panel-modal"),openControlPanel()}catch(e){console.error("Erro ao remover membro:",e),mostrarPopup("\u274C Falha","Ocorreu um erro ao remover o membro.",4e3)}finally{memberIdToRemove=null,closeModal("confirm-remove-modal")}}const todosOsJogos=[{nome:"Jogo da Mem\xF3ria",initFunction:initMemoryGame,htmlContent:""},{nome:"Acerte o Alvo",initFunction:initClickerGame,htmlContent:`
            <div id="clicker-game-board">
                <div class="clicker-stats">
                    <div id="clicker-score">Pontos: 0</div>
                    <div id="clicker-timer">Tempo: 30</div>
                </div>
                <button id="clicker-start-button">Come√ßar!</button>
            </div>
        `},{nome:"Sequ\xEAncia de Cores",initFunction:initSimonGame,htmlContent:`
            <div id="simon-game-board">
                <div id="simon-info-display">N√≠vel: 1</div>
                <div id="simon-pads-container">
                    <div class="simon-pad" id="simon-pad-0" data-index="0"></div>
                    <div class="simon-pad" id="simon-pad-1" data-index="1"></div>
                    <div class="simon-pad" id="simon-pad-2" data-index="2"></div>
                    <div class="simon-pad" id="simon-pad-3" data-index="3"></div>
                </div>
                <button id="simon-start-button">Iniciar</button>
            </div>
        `},{nome:"Jogo da Velha",initFunction:initTicTacToeGame,htmlContent:`
        <div id="tictactoe-board-wrapper">
            <div id="tictactoe-symbol-selection">
                <div class="status-display">Escolha seu lado:</div>
                <div class="symbol-buttons">
                    <button id="select-X" class="symbol-btn x">X</button>
                    <button id="select-O" class="symbol-btn o">O</button>
                </div>
            </div>

            <div id="tictactoe-status" class="status-display hidden">Sua vez de jogar (X)</div>
            <div id="tictactoe-board" class="hidden">
                <div class="tictactoe-cell" data-cell-index="0"></div>
                <div class="tictactoe-cell" data-cell-index="1"></div>
                <div class="tictactoe-cell" data-cell-index="2"></div>
                <div class="tictactoe-cell" data-cell-index="3"></div>
                <div class="tictactoe-cell" data-cell-index="4"></div>
                <div class="tictactoe-cell" data-cell-index="5"></div>
                <div class="tictactoe-cell" data-cell-index="6"></div>
                <div class="tictactoe-cell" data-cell-index="7"></div>
                <div class="tictactoe-cell" data-cell-index="8"></div>
                <div id="tictactoe-winning-line" class="winning-line"></div>
            </div>
            <button id="tictactoe-restart-button" class="hidden">Jogar Novamente</button>
        </div>
    `},{nome:"Quiz dos \xC9picos",initFunction:initQuizGame,htmlContent:`
            <div id="quiz-container" style="display: flex; flex-direction: column; align-items: center; width: 100%; max-width: 700px; padding: 10px;">
                <div id="quiz-progress-bar-container" style="width: 100%; background-color: #e0e0e0; border-radius: 5px; height: 10px; margin-bottom: 15px;">
                    <div id="quiz-progress-bar" style="width: 0%; height: 100%; background-color: #3498db; border-radius: 5px; transition: width 0.3s ease;"></div>
                </div>
                <div id="quiz-question-number" style="font-size: 1rem; color: #7f8c8d; margin-bottom: 10px;">Pergunta 1 de 4</div>
                <h3 id="quiz-question" style="font-size: 1.5rem; text-align: center; min-height: 80px; padding: 15px 0;">Qual o filme favorito de...?</h3>
                <div id="quiz-alternatives" style="display: flex; flex-direction: column; gap: 12px; width: 100%; margin-top: 20px;">
                    </div>
                <div id="quiz-feedback" style="margin-top: 20px; font-weight: bold; font-size: 1.2rem; min-height: 30px;"></div>
            </div>
        `},{nome:"Jogo da Forca",initFunction:initForcaGame,htmlContent:`
            <div id="forca-game-container">
                <div id="forca-status"></div>
                <div class="forca-wrapper">
                    <div class="forca-desenho">
                        <div class="parte-forca forca-base"></div>
                        <div class="parte-forca forca-haste"></div>
                        <div class="parte-forca forca-topo"></div>
                        <div class="parte-forca forca-corda"></div>
                        <div class="enforcado">
                            <div class="parte-corpo cabeca"></div>
                            <div class="parte-corpo tronco"></div>
                            <div class="parte-corpo braco-esq"></div>
                            <div class="parte-corpo braco-dir"></div>
                            <div class="parte-corpo perna-esq"></div>
                            <div class="parte-corpo perna-dir"></div>
                        </div>
                    </div>
                    <div class="forca-info">
                        <div class="palavra-secreta" id="palavra-forca"></div>
                        <div class="dica-container" id="dica-forca"></div>
                    </div>
                </div>
                <div class="teclado-virtual" id="teclado-forca"></div>
                <button id="forca-restart-button">Tentar Novamente</button>
            </div>
        `}];async function loadAdvantageState(){if(!currentUser)return;const e=document.getElementById("leader-advantage-controls");"lider"===userRole?(e.classList.remove("hidden"),document.getElementById("leader-test-button").onclick=window.toggleLeaderTestPanel,populateLeaderTestPanel()):e.classList.add("hidden");const a=getHoje(),o=a.getDay(),t=getSemanaAtual(),n=`semana_${t.numero}_${t.inicio.getFullYear()}`,r=doc(db,"vantagemSemanal",n),i=await getDoc(r),d=i.exists()?i.data():{},s=d.completadoPor?.[currentUser];if(s)return lockAdvantageSection("Desafio conclu\xEDdo! Volte na pr\xF3xima semana para mais."),void(document.getElementById("advantage-game-board").innerHTML="");if(0===o||6===o)return lockAdvantageSection("O tempo para este desafio acabou. Ele retorna na Segunda-feira!"),void(document.getElementById("advantage-game-board").innerHTML="");unlockAdvantageSection();const l=document.getElementById("advantage-game-board"),m=document.getElementById("vantagem-jogo-nome");let c;try{const e=doc(db,"configuracoes","ordemJogosVantagem"),a=await getDoc(e);if(a.exists()&&a.data().ordem){const e=a.data(),o=e.ordem,n=e.semanaDeInicio||t.numero;if(0<o.length){console.log("Usando ordem de jogos personalizada do Firestore.");const e=(t.numero-n)%o.length,a=0>e?e+o.length:e,r=o[a];c=todosOsJogos.find(e=>e.nome===r)}}if(!c){console.log("Ordem personalizada n\xE3o encontrada ou inv\xE1lida. Usando ordem padr\xE3o.");const e=t.numero%todosOsJogos.length;c=todosOsJogos[e]}}catch(e){console.error("Erro ao buscar ordem de jogos, usando padr\xE3o:",e);const a=t.numero%todosOsJogos.length;c=todosOsJogos[a]}if(m&&(m.textContent=`Jogo da Semana: ${c.nome}`),l.innerHTML=c.htmlContent,"Jogo da Forca"===c.nome){let e=d.palavraDaSemana;if(!e){const a=await buscarPalavrasDisponiveis();if(0<a.length)e=a[Math.floor(Math.random()*a.length)],await setDoc(r,{palavraDaSemana:e},{merge:!0}),console.log("Nova palavra da semana definida:",e.palavra);else return void(l.innerHTML="<h2>N\xE3o h\xE1 palavras dispon\xEDveis para o jogo da forca esta semana.</h2>")}initForcaGame(e)}else if("Quiz dos \xC9picos"===c.nome){const e=await gerarQuizDaSemana();e&&0<e.length?initQuizGame(e):l.innerHTML="<h2>N\xE3o foi poss\xEDvel gerar o quiz desta semana. Verifique se os membros preencheram suas informa\xE7\xF5es. Tente novamente mais tarde.</h2>"}else c.initFunction()}function lockAdvantageSection(e){const a=document.getElementById("vantagem-locked-overlay"),o=document.getElementById("vantagem-lock-message");a&&o&&(o.textContent=e,a.classList.remove("hidden"))}function unlockAdvantageSection(){const e=document.getElementById("vantagem-locked-overlay");e&&e.classList.add("hidden")}async function saveAdvantageCompletion(){if(!currentUser)return;const e=getSemanaAtual(),a=`semana_${e.numero}_${e.inicio.getFullYear()}`,o=doc(db,"vantagemSemanal",a);try{await setDoc(o,{completadoPor:{[currentUser]:new Date}},{merge:!0}),console.log(`Conclus√£o salva para ${currentUser}`)}catch(e){console.error("Erro ao salvar conclus\xE3o:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel salvar seu progresso.",4e3)}}async function handleGameWin(e){try{const a=doc(db,"membros",currentUser);await updateDoc(a,{moedas:increment(recompensasConfig.vitoriaJogoVantagem||50)}),mostrarPopupMoedas(recompensasConfig.vitoriaJogoVantagem||50),console.log(`+50 moedas dadas a ${currentUser} por vencer o ${e}.`)}catch(e){console.error("Erro ao dar moedas pela vit\xF3ria no Jogo da Vantagem:",e)}const a=getSemanaAtual(),o=`semana_${a.numero}_${a.inicio.getFullYear()}`,t=doc(db,"vantagemSemanal",o);let n=1;try{const e=await getDoc(t);if(e.exists()){const a=e.data().completadoPor||{};n=Object.keys(a).length+1}}catch(e){console.error("Erro ao buscar placar da vantagem para o feed:",e)}let r;r=liderGeral&&currentUser===liderGeral.nome?`O l√≠der geral <strong>${currentUser}</strong> finalizou com maestria o <strong>${e}</strong>, ficando na <strong>${n}¬™</strong> posi√ß√£o do placar!`:`<strong>${currentUser}</strong> finalizou com maestria o <strong>${e}</strong>, ficando na <strong>${n}¬™</strong> posi√ß√£o do placar e garantindo +3 pontos para sua equipe!`,await adicionarEventoAoFeed("vantagem","\uD83C\uDFAF Desafio Conclu\xEDdo!",r,{nomeMembro:currentUser,jogo:e,posicao:n}),mostrarPopup(`üéâ Parab√©ns!`,`Voc√™ venceu o ${e}!`,5e3),dispararConfete(),await saveAdvantageCompletion(),lockAdvantageSection("Desafio conclu\xEDdo! Volte na pr\xF3xima semana.")}window.toggleLeaderTestPanel=function(){const e=document.getElementById("leader-test-panel");e.classList.toggle("hidden")};function populateLeaderTestPanel(){const e=document.getElementById("leader-game-list");e&&(e.innerHTML="",todosOsJogos.forEach((a,o)=>{const t=document.createElement("li"),n=document.createElement("button");n.textContent=a.nome,n.onclick=()=>startLeaderTestGame(o),t.appendChild(n),e.appendChild(t)}))}async function startLeaderTestGame(e){isTestModeActive=!0,currentTestGameIndex=e;const a=todosOsJogos[e],o=document.getElementById("advantage-game-board"),t=document.getElementById("vantagem-jogo-nome");if(a&&o&&t){if(o.id="advantage-game-board",t.textContent=`Modo de Teste: ${a.nome}`,o.innerHTML=a.htmlContent,"Jogo da Forca"===a.nome){const e=await buscarPalavrasDisponiveis();if(0<e.length){const o=e[Math.floor(Math.random()*e.length)];a.initFunction(o)}else o.innerHTML="<h2>N\xE3o h\xE1 palavras dispon\xEDveis para testar a forca.</h2>"}else if("Quiz dos \xC9picos"===a.nome){const e=await gerarQuizDaSemana();e&&0<e.length?a.initFunction(e):o.innerHTML="<h2>N\xE3o foi poss\xEDvel gerar um quiz para o teste.</h2>"}else"Jogo da Mem\xF3ria"===a.nome&&(o.id="memory-game-board"),a.initFunction();document.getElementById("leader-test-panel").classList.add("hidden"),unlockAdvantageSection()}}function initMemoryGame(){function e(e){i||e.classList.contains("flipped")||!currentUser||(e.classList.add("flipped"),n.push(e),2===n.length&&a())}function a(){i=!0;const[e,a]=n,d=e.dataset.emoji===a.dataset.emoji;d?setTimeout(()=>{e.classList.add("matched"),a.classList.add("matched"),r++,r===t.length&&setTimeout(()=>handleGameWin("Jogo da Mem\xF3ria"),500),o()},600):setTimeout(()=>{e.classList.remove("flipped"),a.classList.remove("flipped"),o()},1200)}function o(){n=[],i=!1}const t=["\uD83E\uDDE0","\uD83D\uDD25","\uD83D\uDE80","\uD83D\uDC8E","\uD83C\uDFC6","\uD83C\uDF1E","\uD83E\uDDF8","\uD83D\uDC38"];let n=[],r=0,i=!1;const d=document.getElementById("advantage-game-board");d.className="memory-game-board",d.innerHTML="";const s=[...t,...t];s.sort(()=>.5-Math.random()),s.forEach(a=>{const o=document.createElement("div");o.classList.add("memory-card"),o.dataset.emoji=a,o.innerHTML=`<div class="card-face card-front"></div><div class="card-face card-back">${a}</div>`,o.addEventListener("click",()=>e(o)),d.appendChild(o)})}function initClickerGame(){function e(){i&&(i.style.display="none",s=0,l=25,n&&(n.textContent=`Pontos: 0 / ${d}`),r&&(r.textContent=`Tempo: ${l}`,r.classList.remove("ending")),m=setInterval(()=>{l--,r&&(r.textContent=`Tempo: ${l}`),5>=l&&r&&r.classList.add("ending"),0>=l&&o(!1)},1e3),c=setInterval(a,450))}function a(){if(!t)return;const e=document.createElement("div");e.classList.add("clicker-target");const a=["abelha","joaninha","vagalume"][Math.floor(3*Math.random())];e.classList.add(a),e.textContent=["\uD83D\uDC1D","\uD83D\uDC1E","\uD83D\uDCA1"][Math.floor(3*Math.random())],e.style.top=`${10+70*Math.random()}%`,e.style.left=`${10+70*Math.random()}%`,e.onclick=()=>{s++,n&&(n.textContent=`Pontos: ${s} / ${d}`),e.classList.add("clicked"),s>=d&&o(!0),setTimeout(()=>e.remove(),300)},t.appendChild(e),setTimeout(()=>{e&&e.parentElement&&e.remove()},1500)}function o(e){if(clearInterval(m),clearInterval(c),!!t)if(t.innerHTML="",e)handleGameWin("Acerte o Alvo");else{const e=document.createElement("div");e.innerHTML=`Tempo esgotado! Voc√™ fez ${s} pontos.<br>Tente novamente!`,e.style.fontSize="1.5rem",e.style.textAlign="center",t.appendChild(e),setTimeout(()=>{const e=todosOsJogos.find(e=>"Acerte o Alvo"===e.nome);if(e){const a=document.getElementById("advantage-game-board");a.innerHTML=e.htmlContent,initClickerGame()}},4e3)}}const t=document.getElementById("clicker-game-board"),n=document.getElementById("clicker-score"),r=document.getElementById("clicker-timer"),i=document.getElementById("clicker-start-button"),d=40;let s=0,l=25,m=null,c=null;i&&(i.onclick=e)}function initSimonGame(){function e(){u=!1,m=[],r.textContent=`N√≠vel: ${c}`;const e=Math.floor(4*Math.random());l.push(e),a()}async function a(){await new Promise(e=>setTimeout(e,700));for(let e=0;e<l.length;e++)await o(l[e]),await new Promise(e=>setTimeout(e,200));u=!0,r.textContent="Sua vez!"}function o(e){return new Promise(a=>{const o=document.getElementById(`simon-pad-${e}`);o.classList.add("active"),setTimeout(()=>{o.classList.remove("active"),a()},500)})}function t(a){if(u){const t=parseInt(a.target.dataset.index,10);o(t),m.push(t);const r=m.length-1;return m[r]===l[r]?void(m.length===l.length&&(c>=s?n(!0):(c++,u=!1,setTimeout(e,1e3)))):void n(!1)}}function n(e){u=!1,e?handleGameWin("Sequ\xEAncia de Cores"):(r.textContent="Errado! Tente de novo.",setTimeout(()=>{document.getElementById("simon-game-board").innerHTML=`
                    <div id="simon-info-display">N√≠vel: 1</div>
                    <div id="simon-pads-container">
                        <div class="simon-pad" id="simon-pad-0" data-index="0"></div>
                        <div class="simon-pad" id="simon-pad-1" data-index="1"></div>
                        <div class="simon-pad" id="simon-pad-2" data-index="2"></div>
                        <div class="simon-pad" id="simon-pad-3" data-index="3"></div>
                    </div>
                    <button id="simon-start-button">Iniciar</button>
                `,initSimonGame()},3e3))}const r=document.getElementById("simon-info-display"),i=document.getElementById("simon-start-button"),d=document.querySelectorAll(".simon-pad"),s=8;let l=[],m=[],c=1,u=!1;i.onclick=function(){i.style.display="none",l=[],c=1,e()},d.forEach(e=>e.addEventListener("click",t))}function initTicTacToeGame(){function e(e){e&&(L=e),f=L,h="X"===f?"O":"X",u.classList.add("hidden"),g.classList.remove("hidden"),m.classList.remove("hidden"),y=.5>Math.random(),y?m.textContent=`Sua vez de jogar (${f})`:(m.textContent=`O computador (${h}) come√ßa...`,setTimeout(o,1200))}function a(a){if(!b&&y){const e=parseInt(a.target.dataset.cellIndex);if(null===v[e]){r(e,f);const a=i();return a.isFinished?void d(a):void(y=!1,m.textContent=`Vez do computador (${h})...`,setTimeout(o,700))}}}function o(){if(!b){const e=t();r(e,h);const a=i();return a.isFinished?void d(a):void(y=!0,m.textContent=`Sua vez de jogar (${f})`)}}function t(){for(const e of E){const a=n(e.combo,h);if(-1!==a)return a}for(const e of E){const a=n(e.combo,f);if(-1!==a)return a}if(null===v[4])return 4;const e=[0,2,6,8].filter(e=>null===v[e]);if(0<e.length)return e[Math.floor(Math.random()*e.length)];const a=[1,3,5,7].filter(e=>null===v[e]);return 0<a.length?a[Math.floor(Math.random()*a.length)]:v.findIndex(e=>null===e)}function n(e,a){const o=e.map(e=>v[e]);return 2===o.filter(e=>e===a).length&&o.includes(null)?e[o.indexOf(null)]:-1}function r(e,a){v[e]=a;const o=g.querySelector(`[data-cell-index='${e}']`);o.classList.add(a.toLowerCase())}function i(){for(const e of E){const[o,a,t]=e.combo;if(v[o]&&v[o]===v[a]&&v[o]===v[t])return{isFinished:!0,winner:v[o],lineClass:e.class,winningCombo:e.combo}}return v.every(e=>null!==e)?{isFinished:!0,winner:"tie"}:{isFinished:!1}}function d(e){if(b=!0,e.winner===f)m.textContent="Voc\xEA venceu! \uD83C\uDF89",p.className=`winning-line ${e.lineClass}`,e.winningCombo.forEach(e=>document.querySelector(`[data-cell-index='${e}']`).classList.add("highlight")),handleGameWin("Jogo da Velha");else if(e.winner===h){m.textContent="O computador venceu!",p.className=`winning-line ${e.lineClass}`,e.winningCombo.forEach(e=>document.querySelector(`[data-cell-index='${e}']`).classList.add("highlight"));let a=3;m.textContent=`O computador venceu! Nova rodada em ${a}...`;const o=setInterval(()=>{a--,0<a?m.textContent=`O computador venceu! Nova rodada em ${a}...`:(clearInterval(o),s())},1e3)}else m.textContent="Deu velha! Tente novamente.",c.classList.remove("hidden")}function s(){v.fill(null),b=!1,document.querySelectorAll(".tictactoe-cell").forEach(e=>{e.className="tictactoe-cell"}),p.className="winning-line",c.classList.add("hidden"),e(null)}const l=document.getElementById("tictactoe-board-wrapper"),m=document.getElementById("tictactoe-status"),c=document.getElementById("tictactoe-restart-button"),u=document.getElementById("tictactoe-symbol-selection"),g=document.getElementById("tictactoe-board"),p=document.getElementById("tictactoe-winning-line");let f="X",h="O";const E=[{combo:[0,1,2],class:"line-h-0"},{combo:[3,4,5],class:"line-h-1"},{combo:[6,7,8],class:"line-h-2"},{combo:[0,3,6],class:"line-v-0"},{combo:[1,4,7],class:"line-v-1"},{combo:[2,5,8],class:"line-v-2"},{combo:[0,4,8],class:"line-d-0"},{combo:[2,4,6],class:"line-d-1"}];let v=Array(9).fill(null),y=!0,b=!1,L=null;document.getElementById("select-X").onclick=()=>e("X"),document.getElementById("select-O").onclick=()=>e("O"),document.querySelectorAll(".tictactoe-cell").forEach(e=>e.addEventListener("click",a)),c.addEventListener("click",function(){L=null,v.fill(null),b=!1,y=!0,document.querySelectorAll(".tictactoe-cell").forEach(e=>{e.className="tictactoe-cell"}),p.className="winning-line",c.classList.add("hidden"),g.classList.add("hidden"),m.classList.add("hidden"),u.classList.remove("hidden")})}async function buscarPalavrasDisponiveis(){const e=collection(db,"jogoDaForca");try{const a=await getDocs(e);return a.empty?(console.warn("A cole\xE7\xE3o de palavras da forca est\xE1 vazia!"),[]):a.docs.map(e=>({id:e.id,...e.data()}))}catch(e){return console.error("Erro ao buscar palavras da forca:",e),[]}}async function initForcaGame(e){function a(){v=!1,f=[],h=0,d.textContent="Adivinhe a palavra!",l.textContent=`Dica: ${p}`,u.forEach(e=>e.style.display="none"),c.style.display="none",o(),t()}function o(){s.innerHTML="";for(const e of g){const a=document.createElement("div");a.classList.add("letra-placeholder"),f.includes(e)&&(a.textContent=e),s.appendChild(a)}}function t(){m.innerHTML="";[["Q","W","E","R","T","Y","U","I","O","P"],["SPACER_HALF","A","S","D","F","G","H","J","K","L","SPACER_HALF"],["SPACER_FULL","SPACER_HALF","Z","X","C","V","B","N","M","SPACER_HALF","SPACER_FULL"]].forEach(e=>{const a=document.createElement("div");a.classList.add("teclado-row"),e.forEach(e=>{if(e.startsWith("SPACER_")){const o=document.createElement("div");"SPACER_HALF"===e?o.className="teclado-spacer-half":"SPACER_FULL"==e&&(o.className="teclado-spacer-full"),a.appendChild(o)}else{const o=document.createElement("button");o.classList.add("teclado-btn"),o.textContent=e,o.onclick=()=>n(e,o),a.appendChild(o)}}),m.appendChild(a)})}function n(e,a){v||(a.disabled=!0,g.includes(e)?(f.push(e),a.classList.add("correta")):(h++,a.classList.add("errada"),r()),o(),i())}function r(){for(let e=0;e<h;e++)u[e]&&(u[e].style.display="block")}function i(){const e=g.split("").every(e=>f.includes(e));return e?(v=!0,d.textContent="Voc\xEA venceu! \uD83C\uDF89",void setTimeout(()=>handleGameWin("Jogo da Forca"),1e3)):void(h>=E&&(v=!0,d.textContent=`Voc√™ perdeu! Tente novamente.`,c.style.display="block"))}const d=document.getElementById("forca-status"),s=document.getElementById("palavra-forca"),l=document.getElementById("dica-forca"),m=document.getElementById("teclado-forca"),c=document.getElementById("forca-restart-button"),u=document.querySelectorAll(".enforcado .parte-corpo");let g="",p="",f=[],h=0;const E=6;let v=!1;return e&&e.palavra?void(g=e.palavra.toUpperCase(),p=e.dica,c.onclick=()=>{initForcaGame(e)},a()):(d.textContent="Erro ao carregar a palavra da semana!",void(m.innerHTML=""))}function embaralharArray(e){for(let a=e.length-1;0<a;a--){const o=Math.floor(Math.random()*(a+1));[e[a],e[o]]=[e[o],e[a]]}return e}async function gerarQuizDaSemana(){const e=getSemanaAtual(),a=`semana_${e.numero}_${e.inicio.getFullYear()}`,o=doc(db,"vantagemSemanal",a),t=doc(db,"configuracoes","quizMemberQueue"),n=await getDoc(o);if(n.exists()&&n.data().quizDaSemana)return console.log("Quiz da semana j\xE1 existe. Carregando..."),n.data().quizDaSemana;console.log("Gerando novo quiz para a semana...");const r=await getDoc(t);let i=r.exists()?r.data().queue:[];4>i.length&&(i=todosMembros.filter(e=>"lider"!==e.papel).map(e=>e.nome),embaralharArray(i));const d=i.splice(0,4);await setDoc(t,{queue:i});const s={},l=await getDocs(collection(db,"membros"));l.forEach(e=>{const a=e.data();(a.filme||a.sonho||a.musica||a.curiosidade)&&(s[e.id]=a)});const m=[],c=[{key:"filme",template:"Qual o filme favorito de {membro}?"},{key:"sonho",template:"Atualmente, qual o maior sonho de {membro}?"},{key:"musica",template:"Qual dessas \xE9 a m\xFAsica que {membro} gosta muito?"},{key:"curiosidade",template:"Qual dessas curiosidades pertence a {membro}?"}];for(let e=0;e<d.length;e++){const a=d[e],o=s[a],t=c[e];if(!o||!o[t.key]||""===o[t.key].trim())continue;const n=o[t.key];let r=[];const i=Object.keys(s).filter(e=>e!==a);embaralharArray(i);for(const e of i){const a=s[e];if(a&&a[t.key]&&""!==a[t.key].trim()&&a[t.key]!==n&&r.push(a[t.key]),3<=r.length)break}if(3>r.length)return[];const l=embaralharArray([n,...r]);m.push({pergunta:t.template.replace("{membro}",`<strong>${a}</strong>`),alternativas:l,resposta:n})}return 4>m.length?(console.warn("N\xE3o foi poss\xEDvel gerar 4 perguntas v\xE1lidas. Tentando novamente na pr\xF3xima vez."),[]):(await setDoc(o,{quizDaSemana:m},{merge:!0}),m)}function initQuizGame(e){function a(){if(s>=e.length)return void(l===e.length?handleGameWin("Quiz dos \xC9picos"):(r.textContent=`Voc√™ acertou ${l} de ${e.length}. Tente de novo!`,r.style.color="#e74c3c",setTimeout(()=>loadAdvantageState(),3e3)));const a=e[s];i.textContent=`Pergunta ${s+1} de ${e.length}`,t.innerHTML=a.pergunta,n.innerHTML="",r.textContent="",d.style.width=`${100*(s/e.length)}%`,a.alternativas.forEach(e=>{const t=document.createElement("button");t.className="user-panel-btn",t.innerHTML=e,t.onclick=()=>o(t,e,a.resposta),n.appendChild(t)})}function o(o,t,i){n.querySelectorAll("button").forEach(e=>e.disabled=!0),t===i?(o.classList.add("correta"),r.textContent="Resposta Certa!",r.style.color="#2ecc71",l++,s++,d.style.width=`${100*(s/e.length)}%`,setTimeout(a,2e3)):(o.classList.add("errada"),r.textContent="Incorreto! O jogo ser\xE1 reiniciado...",r.style.color="#e74c3c",setTimeout(()=>{mostrarPopup("\uD83D\uDD04 Tente de Novo","O quiz foi reiniciado. Preste mais aten\xE7\xE3o!",4e3),isTestModeActive?startLeaderTestGame(currentTestGameIndex):loadAdvantageState()},2500))}const t=document.getElementById("quiz-question"),n=document.getElementById("quiz-alternatives"),r=document.getElementById("quiz-feedback"),i=document.getElementById("quiz-question-number"),d=document.getElementById("quiz-progress-bar");let s=0,l=0;a()}async function carregarInstrucoes(){try{const e=doc(db,"regras","manual"),a=await getDoc(e);if(a.exists()){const e=a.data(),o=document.querySelector("#secao-instrucoes .secao-conteudo");o.innerHTML=`
          <h1>üìú Manual de Funcionamento e Din√¢micas do Grupo </h1>
          <div class="info-bloco">
            <h2>Lista de Foco</h2>
            <p>${e.Foco.replace(/\n/g,"<br>")}</p>
          </div>
          <div class="info-bloco">
            <h2>Dia de Folga</h2>
            <p>${e.Folga.replace(/\n/g,"<br>")}</p>
          </div>
          <div class="info-bloco">
            <h2>Nomea√ß√£o de L√≠deres</h2>
            <p>${e.Lider.replace(/\n/g,"<br>")}</p>
          </div>
          <div class="info-bloco">
            <h2>Medalhas Individuais</h2>
            <p>${e.Medalhas.replace(/\n/g,"<br>")}</p>
          </div>
          <div class="info-bloco">
            <h2>√Årvore √âpica</h2>
            <p>${e.√Årvore.replace(/\n/g,"<br>")}</p>
          </div>
        `,document.getElementById("secao-instrucoes").classList.remove("hidden")}else mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel encontrar o manual de instru\xE7\xF5es.",4e3)}catch(e){console.error("Erro ao carregar instru\xE7\xF5es:",e),mostrarPopup("\u274C Erro","Falha ao carregar as instru\xE7\xF5es.",4e3)}}async function carregarAdvertencias(){try{const e=doc(db,"regras","conduta"),a=await getDoc(e);if(a.exists()){const e=a.data(),o=document.querySelector("#secao-advertencias .secao-conteudo"),t=e=>`<ul>${e.split("\u2022").filter(e=>""!==e.trim()).map(e=>`<li>${e.trim()}</li>`).join("")}</ul>`;o.innerHTML=`
          <h1>‚ö†Ô∏è C√≥digo de Conduta e Advert√™ncias</h1>
          <div class="advertencia-card leve">
            <h2><span class="emoji">üü¢</span>Advert√™ncia Leve</h2>
            ${t(e.leve)}
          </div>
          <div class="advertencia-card media">
            <h2><span class="emoji">üü°</span>Advert√™ncia M√©dia</h2>
            ${t(e.media)}
          </div>
          <div class="advertencia-card grave">
            <h2><span class="emoji">üî¥</span>Advert√™ncia Grave</h2>
            ${t(e.grave)}
          </div>
          <div class="advertencia-card gravissima">
            <h2><span class="emoji">üü£</span>Advert√™ncia Grav√≠ssima</h2>
            ${t(e.gravissima)}
          </div>
          <div class="advertencia-card expulsao">
            <h2><span class="emoji">‚ö´</span>Expuls√£o</h2>
            ${t(e.expulsao)}
          </div>
        `,document.getElementById("secao-advertencias").classList.remove("hidden")}else mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel encontrar o c\xF3digo de conduta.",4e3)}catch(e){console.error("Erro ao carregar advert\xEAncias:",e),mostrarPopup("\u274C Erro","Falha ao carregar as advert\xEAncias.",4e3)}}function fecharSecoes(){document.getElementById("secao-instrucoes").classList.add("hidden"),document.getElementById("secao-advertencias").classList.add("hidden")}document.getElementById("btn-instrucoes").addEventListener("click",carregarInstrucoes),document.getElementById("btn-advertencias").addEventListener("click",carregarAdvertencias),document.querySelectorAll(".botao-fechar-secao").forEach(e=>{e.addEventListener("click",fecharSecoes)});async function calcularMembrosOciosos(){console.log("Calculando membros ociosos da semana...");const e=getSemanaAtual(new Date(new Date().setDate(new Date().getDate()-2))),a=e.inicio,o=e.fim,t=a.toISOString().slice(0,10),n=o.toISOString().slice(0,10),r=`semana_${e.numero}_${e.inicio.getFullYear()}`,i={};todosMembros.forEach(e=>{"lider"!==e.papel&&(i[e.nome]=0)});try{const e=query(collection(db,"presencas"),where("__name__",">=",t),where("__name__","<=",n)),a=await getDocs(e);a.forEach(e=>{const a=e.data();for(const[o,t]of Object.entries(a))t&&void 0!==i[o]&&i[o]++});const o=Object.entries(i).filter(([e,a])=>4>a).map(([e,a])=>({nome:e,contagem:a})),d=doc(db,"gerenciamentoSemanal",r);await setDoc(d,{ociosos:o,processado:!1}),console.log(`Encontrados ${o.length} membros ociosos. Dados salvos em ${r}.`)}catch(e){console.error("Erro ao calcular membros ociosos:",e)}}async function carregarEExibirMembrosOciosos(){const e=document.getElementById("secao-ociosos");if("lider"!==userRole)return void e.classList.add("hidden");e.classList.remove("hidden");const a=getHoje(),o=a.getDay(),t=document.getElementById("lista-ociosos"),n=document.getElementById("ociosos-descricao");if(t.innerHTML="<div class=\"ociosos-placeholder\">Calculando...</div>",0===o){const e=getSemanaAtual(new Date(new Date().setDate(a.getDate()-1))),o=`semana_${e.numero}_${e.inicio.getFullYear()}`,r=doc(db,"gerenciamentoSemanal",o);try{const e=await getDoc(r);if(!e.exists()||0===e.data().ociosos.length)return t.innerHTML="<div class=\"ociosos-placeholder\">Nenhum membro ficou abaixo da meta na semana passada.</div>",void(n.textContent="A\xE7\xF5es de final de semana: Nenhuma a\xE7\xE3o necess\xE1ria.");const a=e.data().ociosos;t.innerHTML="",n.textContent="A\xE7\xF5es de final de semana: Justifique os membros que apresentaram um motivo v\xE1lido ou expulse os que n\xE3o cumpriram a meta semanal.",a.forEach(e=>{const a=document.createElement("div");a.className="ocioso-item",a.innerHTML=`
                    <div class="ocioso-nome">${e.nome} (${e.contagem}/4 dias)</div>
                    <div class="ocioso-botoes">
                        <button class="ocioso-btn justificar" onclick="justificarMembro('${e.nome}', '${o}')">Justificar</button>
                        <button class="ocioso-btn expulsar" onclick="confirmarExpulsao('${e.nome}')">Expulsar</button>
                    </div>
                `,t.appendChild(a)})}catch(e){console.error("Erro ao carregar lista de ociosos de domingo:",e),t.innerHTML="<div class=\"ociosos-placeholder\">Erro ao carregar a lista.</div>"}}else{const e=getSemanaAtual(),a=formatarDataISO(e.inicio),r=getHojeISO();n.textContent=`An√°lise em tempo real: A lista abaixo mostra os membros que matematicamente n√£o podem mais atingir a meta de 4 dias de foco nesta semana.`;try{const e=query(collection(db,"presencas"),where("__name__",">=",a),where("__name__","<=",r)),n=await getDocs(e),i={};todosMembros.forEach(e=>{"lider"!==e.papel&&(i[e.nome]=0)}),n.forEach(e=>{const a=e.data();for(const o in a)a[o]&&void 0!==i[o]&&i[o]++});const d=Object.keys(i).filter(e=>{const a=i[e]||0;return 4-a>7-o}).map(e=>({nome:e,contagem:i[e]}));0===d.length?t.innerHTML="<div class=\"ociosos-placeholder\">At\xE9 o momento, todos os membros ainda podem atingir a meta.</div>":(t.innerHTML="",d.forEach(e=>{const a=document.createElement("div");a.className="ocioso-item",a.innerHTML=`<div class="ocioso-nome">${e.nome} (${e.contagem}/4 dias)</div>`,t.appendChild(a)}))}catch(e){console.error("Erro ao calcular ociosos em tempo real:",e),t.innerHTML="<div class=\"ociosos-placeholder\">Erro ao calcular a lista.</div>"}}}async function justificarMembro(e,a){if(!confirm(`Tem certeza que deseja justificar e remover '${e}' da lista de ociosos desta semana?`))return;const o=doc(db,"gerenciamentoSemanal",a);try{await runTransaction(db,async a=>{const t=await a.get(o);if(!t.exists())return;const n=t.data().ociosos,r=n.filter(a=>a.nome!==e);a.update(o,{ociosos:r})}),mostrarPopup("\u2705 Sucesso",`${e} foi justificado e removido da lista.`,4e3),await carregarEExibirMembrosOciosos()}catch(e){console.error("Erro ao justificar membro:",e),mostrarPopup("\u274C Erro","N\xE3o foi poss\xEDvel processar a justiticativa.",4e3)}}function confirmarExpulsao(e){membroParaExpulsar=e,document.getElementById("member-to-expel-name").innerText=e,document.getElementById("confirm-expel-button").onclick=executarExpulsao,openModal("confirm-expel-modal")}async function executarExpulsao(){if(membroParaExpulsar){const e=membroParaExpulsar;console.log(`Iniciando processo de expuls√£o para: ${e}`);try{await deleteDoc(doc(db,"membros",e)),await adicionarEventoAoFeed("geral","\uD83D\uDEB6\u200D\u2642\uFE0F Despedida no Grupo",`O membro <strong>${e}</strong> n√£o faz mais parte do nosso grupo. Desejamos sucesso em sua jornada!`,{nomeMembro:e}),mostrarPopup("\uD83D\uDDD1\uFE0F Membro Expulso",`${e} foi removido permanentemente do sistema.`,5e3),membroParaExpulsar=null,closeModal("confirm-expel-modal"),await refreshAppUI()}catch(a){console.error(`Erro ao expulsar ${e}:`,a),mostrarPopup("\u274C Falha Grave",`Ocorreu um erro ao tentar expulsar ${e}.`,5e3)}}}function atualizarPodioEquipes(){const e=[{id:"abelha",vitorias:rankingGeral.abelha,elemento:document.getElementById("podio-abelha")},{id:"joaninha",vitorias:rankingGeral.joaninha,elemento:document.getElementById("podio-joaninha")},{id:"vagalume",vitorias:rankingGeral.vagalume,elemento:document.getElementById("podio-vagalume")}];e.sort((e,a)=>a.vitorias-e.vitorias),e.forEach(e=>{e.elemento&&e.elemento.classList.remove("podium-1","podium-2","podium-3")});let a=1;for(let o=0;o<e.length;o++)0<o&&e[o].vitorias<e[o-1].vitorias&&(a=o+1),e[o].elemento&&e[o].elemento.classList.add(`podium-${a}`)}async function verificarEConcederPremiacaoDiaria(){console.log("Verificando se a premia\xE7\xE3o di\xE1ria precisa ser concedida...");const e=new Date;e.setDate(e.getDate()-1);const a=formatarDataISO(e),o=doc(db,"appState","dailyPrizeState");try{const e=await getDoc(o),t=e.exists()?e.data().lastAwardedDate:null;t===a?console.log(`Premia√ß√£o para o dia ${a} j√° foi concedida anteriormente. Nenhuma a√ß√£o necess√°ria.`):(console.log(`Premia√ß√£o para o dia ${a} ainda n√£o foi concedida. Iniciando processo...`),await premiarTop5ConsistenciaDiaria(),await setDoc(o,{lastAwardedDate:a}),console.log(`Premia√ß√£o para ${a} conclu√≠da e registrada.`))}catch(e){console.error("Erro ao verificar ou conceder a premia\xE7\xE3o di\xE1ria:",e)}}async function premiarTop5ConsistenciaDiaria(){console.log("\uD83C\uDFC6 Iniciando premia\xE7\xE3o di\xE1ria do Top 5 por consist\xEAncia...");const e={1:recompensasConfig.top5Diario_1||25,2:recompensasConfig.top5Diario_2||20,3:recompensasConfig.top5Diario_3||15,4:recompensasConfig.top5Diario_4||10,5:recompensasConfig.top5Diario_5||5},a=new Date;a.setDate(a.getDate()-1);try{const o=await obterRankingSemanal(a),t=o.filter(e=>0<e.pontos).slice(0,5);if(0===t.length)return void console.log("N\xE3o houve membros com foco registrado ontem para formar um Top 5. Premia\xE7\xE3o pulada.");const n=writeBatch(db),r=[];t.forEach((a,o)=>{const t=o+1,i=e[t],d=doc(db,"membros",a.nome);n.update(d,{moedas:increment(i)}),a.nome===currentUser&&mostrarPopupMoedas(i),r.push(`<strong>${t}¬∫ ${a.nome}</strong> (${a.pontos} dias | +${i}üí∞)`)}),await n.commit();const i=`A consist√™ncia prevaleceu! Estes foram os √âpicos no topo do ranking semanal ao final de ontem:<br>${r.join("<br>")}`;await adicionarEventoAoFeed("geral","\uD83C\uDFC6 Top 5 Consistentes do Dia!",i,{}),console.log(`‚úÖ Premia√ß√£o di√°ria do Top 5 por consist√™ncia conclu√≠da para ${t.length} membros.`)}catch(e){console.error("Erro ao premiar o Top 5 di\xE1rio por consist\xEAncia:",e)}}
